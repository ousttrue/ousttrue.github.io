"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[9371],{2942:function(e,n,t){t.r(n),t.d(n,{default:function(){return s}});var r=t(1151),o=t(7294);function l(e){const n=Object.assign({p:"p",pre:"pre",code:"code",h1:"h1"},(0,r.ah)(),e.components);return o.createElement(o.Fragment,null,o.createElement(n.p,null,"Python じゃなくて VisualStudio 側の問題のようなのだけど、setup.py でネイティブモジュールをビルドするときに顕在化したので。"),"\n",o.createElement(n.p,null,"こういう感じのネイティブモジュールを作った。"),"\n",o.createElement(n.pre,null,o.createElement(n.code,{className:"language-python"},"from distutils.core import setup, Extension\n\n\nimgui_module = Extension('_swig_imgui',\n        sources=[\n            #'imgui_wrap.cxx',\n            'imgui.i',\n            'imgui/imgui.cpp',\n            'imgui/imgui_draw.cpp',\n            'imgui/imgui_demo.cpp',\n            ],\n        swig_opts=[\n            #'-modern',\n            '-c++',\n            '-py3',\n            ]\n        )\n\nsetup (name = 'swig_imgui',\n        version = '0.1',\n        author      = \"ousttrue\",\n        description = \"\"\"imgui wrapper using swig\"\"\",\n        ext_modules = [imgui_module],\n        py_modules = [\"swig_imgui\"],\n        )\n")),"\n",o.createElement(n.pre,null,o.createElement(n.code,null,"> python setup.py build\n")),"\n",o.createElement(n.p,null,"とするとエラーになる。\nWindows10(64bit)上の vs2017 + vcbuildtools の組み合わせの環境である。"),"\n",o.createElement(n.pre,null,o.createElement(n.code,null,"cl.exe /c /nologo /Ox /W3 /GL /DNDEBUG /MD -ID:\\Anaconda3\\include -ID:\\Anaconda3\\include /EHsc /Tpimgui_wrap.cpp /Fobuild\\temp.win-amd64-3.6\\Release\\imgui_wrap.obj\nerror: command 'cl.exe' failed: No such file or directory\n")),"\n",o.createElement(n.p,null,"distutils が cl.exe を探すのに失敗しているようなのである。\nlib/distutils 下を調べてみた。\nどうやら lib/distutils/_msvccompiler.py で vcvarsall.bat から環境変数を得ることに失敗しているらしい。\n実際、C:\\Program Files (x86)\\Microsoft Visual Studio\\Shared\\14.0\\VC\\vcvarsall.bat の呼び出しが失敗していることを突き止めた。"),"\n",o.createElement(n.pre,null,o.createElement(n.code,null,'Error in script usage. The correct usage is:\n"C:\\Program Files (x86)\\Microsoft Visual Studio\\Shared\\14.0\\VC\\vcvarsall.bat" [option]\nor\n"C:\\Program Files (x86)\\Microsoft Visual Studio\\Shared\\14.0\\VC\\vcvarsall.bat" [option] store\nor\n"C:\\Program Files (x86)\\Microsoft Visual Studio\\Shared\\14.0\\VC\\vcvarsall.bat" [option] [version number]\nor\n"C:\\Program Files (x86)\\Microsoft Visual Studio\\Shared\\14.0\\VC\\vcvarsall.bat" [option] store [version number]\nwhere [option] is: x86 | amd64 | arm | x86_amd64 | x86_arm | amd64_x86 | amd64_arm\nwhere [version number] is either the full Windows 10 SDK version number or "8.1" to use the windows 8.1 SDK\n:\nThe store parameter sets environment variables to support\nstore (rather than desktop) development.\n:\nFor example:\n"C:\\Program Files (x86)\\Microsoft Visual Studio\\Shared\\14.0\\VC\\vcvarsall.bat" x86_amd64\n"C:\\Program Files (x86)\\Microsoft Visual Studio\\Shared\\14.0\\VC\\vcvarsall.bat" x86_arm store\n"C:\\Program Files (x86)\\Microsoft Visual Studio\\Shared\\14.0\\VC\\vcvarsall.bat" x86_amd64 10.0.10240.0\n"C:\\Program Files (x86)\\Microsoft Visual Studio\\Shared\\14.0\\VC\\vcvarsall.bat" x86_arm store 10.0.10240.0\n"C:\\Program Files (x86)\\Microsoft Visual Studio\\Shared\\14.0\\VC\\vcvarsall.bat" x64 8.1\n"C:\\Program Files (x86)\\Microsoft Visual Studio\\Shared\\14.0\\VC\\vcvarsall.bat" x64 store 8.1\n')),"\n",o.createElement(n.p,null,"コマンドラインから実行しても失敗していて、vcvarsall.bat に以下のコードがあるのだが、"),"\n",o.createElement(n.pre,null,o.createElement(n.code,null,':setup_buildsku\nif not exist "%~dp0..\\..\\..\\Microsoft Visual C++ Build Tools\\vcbuildtools.bat" goto usage\nset CurrentDir=%CD%\ncall "%~dp0..\\..\\..\\Microsoft Visual C++ Build Tools\\vcbuildtools.bat" %1 %2\ncd /d %CurrentDir%\ngoto :eof\n')),"\n",o.createElement(n.p,null,'C:\\Program Files (x86)\\Microsoft Visual Studio\\Shared\\14.0\\VC\\vcvarsall.bat\nから\nC:\\Program Files (x86)\\Microsoft Visual C++ Build Tools\\vcbuildtools.bat"\nへの相対パスだと一致しないよなーと。\nこれが原因で cl.exe のパスが取れない。\nsetup.py にモンキーパッチを当てて cl.exe を発見できるようにしてみた。\n以下を setup.py の先頭に追加。'),"\n",o.createElement(n.h1,null,"monkey patch for _msvccompiler"),"\n",o.createElement(n.pre,null,o.createElement(n.code,{className:"language-python"},"import distutils.\\_msvccompiler\nimport os\nimport subprocess\ndef \\_get_vc_env(plat_spec):\nif os.getenv(\"DISTUTILS_USE_SDK\"):\nreturn {\nkey.lower(): value\nfor key, value in os.environ.items()\n}\n\n    vcvarsall, vcruntime = distutils._msvccompiler._find_vcvarsall(plat_spec)\n    if not vcvarsall:\n        raise DistutilsPlatformError(\"Unable to find vcvarsall.bat\")\n\n    try:\n        out = subprocess.check_output(\n            'cmd /u /c \"{}\" {} && set'.format(vcvarsall, plat_spec),\n            stderr=subprocess.STDOUT,\n        ).decode('utf-16le', errors='replace')\n        #######################################################################\n        if out.startswith(\"Error in script usage\"):\n            out = subprocess.check_output(\n                'cmd /u /c \"{}\" {} && set'.format(\"C:\\\\Program Files (x86)\\\\Microsoft Visual C++ Build Tools\\\\vcbuildtools.bat\", plat_spec),\n                stderr=subprocess.STDOUT,\n            ).decode('utf-16le', errors='replace')\n        #######################################################################\n    except subprocess.CalledProcessError as exc:\n        log.error(exc.output)\n        raise DistutilsPlatformError(\"Error executing {}\"\n                .format(exc.cmd))\n\n    env = {\n        key.lower(): value\n        for key, _, value in\n        (line.partition('=') for line in out.splitlines())\n        if key and value\n    }\n\n    if vcruntime:\n        env['py_vcruntime_redist'] = vcruntime\n    return env\n")),"\n",o.createElement(n.p,null,o.createElement(n.code,null,"distutils.\\_msvccompiler.\\_get_vc_env=\\_get_vc_env")),"\n",o.createElement(n.p,null,"以前にもこんなことやったことあるような気がする・・・。"))}var i=function(e){void 0===e&&(e={});const{wrapper:n}=Object.assign({},(0,r.ah)(),e.components);return n?o.createElement(n,e,o.createElement(l,e)):l(e)};t(8678);function a(e){let{data:n,children:t}=e;return o.createElement(o.Fragment,null,o.createElement("h1",null,n.mdx.frontmatter.title),o.createElement(r.Zo,null,t))}function s(e){return o.createElement(a,e,o.createElement(i,e))}},8678:function(e,n,t){t(7294)},1151:function(e,n,t){t.d(n,{Zo:function(){return a},ah:function(){return l}});var r=t(7294);const o=r.createContext({});function l(e){const n=r.useContext(o);return r.useMemo((()=>"function"==typeof e?e(n):{...n,...e}),[n,e])}const i={};function a({components:e,children:n,disableParentContext:t}){let a;return a=t?"function"==typeof e?e({}):e||i:l(e),r.createElement(o.Provider,{value:a},n)}}}]);
//# sourceMappingURL=component---src-templates-post-template-js-content-file-path-home-runner-work-ousttrue-github-io-ousttrue-github-io-content-posts-2017-08-distutils-msvccompiler-md-190035cda725e1eae8ef.js.map