"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[5377],{1184:function(n,a,s){s.r(a),s.d(a,{default:function(){return r}});var t=s(1151),e=s(7294);function p(n){const a=Object.assign({p:"p",span:"span",h1:"h1",h2:"h2",ul:"ul",li:"li",h3:"h3",a:"a"},(0,t.ah)(),n.components);return e.createElement(e.Fragment,null,e.createElement(a.p,null,"vscode の lua デバッガーに"),"\n",e.createElement(a.p,null,"https://marketplace.visualstudio.com/items?itemName=tomblind.local-lua-debugger-vscode を使っていたのだが、"),"\n",e.createElement(a.p,null,e.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">launch.json</code>'}})," の ",e.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">args</code>'}})," に ",e.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">\\\\</code>'}})," が入るとエラーで起動できない。\nWindows で作業しているので、稀によくファイルパスの指定に ",e.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">\\\\</code>'}})," が入る。"),"\n",e.createElement(a.h1,null,"DebugAdapter を作っていたら、直し方がわかった"),"\n",e.createElement(a.p,null,"https://github.com/ousttrue/local-lua-debugger-vscode/commit/0f3974b73964b2e34f90a21de9757a57d6746eb4"),"\n",e.createElement(a.h2,null,"PR"),"\n",e.createElement(a.p,null,"https://github.com/tomblind/local-lua-debugger-vscode/pull/37"),"\n",e.createElement(a.p,null,"Linux では動かんかったらしく、別の方法で修正してくれた。"),"\n",e.createElement(a.p,null,"👍 ",e.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">0.2.2</code>'}})," https://github.com/tomblind/local-lua-debugger-vscode/blob/master/CHANGELOG.md"),"\n",e.createElement(a.h1,null,"自前で ",e.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">DebugAdapter</code>'}})," 作ってみることにした。"),"\n",e.createElement(a.p,null,"https://github.com/ousttrue/luada"),"\n",e.createElement(a.p,null,"途中まで実装したのだが、"),"\n",e.createElement(a.ul,null,"\n",e.createElement(a.li,null,"luajit.exe + luada.lua"),"\n"),"\n",e.createElement(a.p,null,"という構成よりは、"),"\n",e.createElement(a.ul,null,"\n",e.createElement(a.li,null,"luada.exe"),"\n"),"\n",e.createElement(a.p,null,"の方が取り回しがよくて、それなら lua 成分をもっと減らして JSON-RPC 制御も ",e.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">c++</code>'}})," なり ",e.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">rust</code>'}})," なりにして\nlua 埋め込み型の exe が作りやすそう。\n元々、 スタンドアロンの lua インタプリタと組み合わせて使う lua スクリプトという方向性で実装していたのだが、\n",e.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">luajit-2.1.0-beta3</code>'}})," 一辺倒になりつつあるので気分が変わってきたのであった。\nこれに関しては、今の構成でできるところまでやってみよう。"),"\n",e.createElement(a.h1,null,"VSCode の Extension を作る"),"\n",e.createElement(a.ul,null,"\n",e.createElement(a.li,null,"https://code.visualstudio.com/api/get-started/your-first-extension"),"\n"),"\n",e.createElement(a.p,null,"手順通りに初期化した。npm は最新版に更新したほうがよいぽい。"),"\n",e.createElement(a.h1,null,"MockDebug"),"\n",e.createElement(a.ul,null,"\n",e.createElement(a.li,null,"https://code.visualstudio.com/api/extension-guides/debugger-extension"),"\n"),"\n",e.createElement(a.p,null,"を読む。"),"\n",e.createElement(a.ul,null,"\n",e.createElement(a.li,null,"https://github.com/microsoft/vscode-mock-debug"),"\n"),"\n",e.createElement(a.p,null,"というサンプルがある。"),"\n",e.createElement(a.p,null,"いくつかの機能をまとめて提供する必要がありそう。"),"\n",e.createElement(a.ul,null,"\n",e.createElement(a.li,null,"launch.json の設定"),"\n",e.createElement(a.li,null,"DebugAdapter 本体"),"\n",e.createElement(a.li,null,"DebugAdapter を起動する"),"\n"),"\n",e.createElement(a.h1,null,"実装してみる"),"\n",e.createElement(a.h2,null,"Extension の activate"),"\n",e.createElement(a.p,null,"適当にイベントを登録して"),"\n",e.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="json"><pre class="language-json"><code class="language-json">    <span class="token comment">// package.json</span>\n    <span class="token property">"activationEvents"</span><span class="token operator">:</span> <span class="token punctuation">[</span>\n        <span class="token string">"onDebug"</span><span class="token punctuation">,</span>\n        <span class="token string">"onDebugInitialConfigurations"</span><span class="token punctuation">,</span>\n        <span class="token string">"onDebugDynamicConfigurations"</span><span class="token punctuation">,</span>\n        <span class="token string">"onDebugResolve:lua"</span><span class="token punctuation">,</span>\n        <span class="token string">"onLanguage:lua"</span>\n    <span class="token punctuation">]</span><span class="token punctuation">,</span></code></pre></div>'}}),"\n",e.createElement(a.p,null,e.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">activate</code>'}})," されることを確認"),"\n",e.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token comment">// src/extension.ts</span>\n<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">activate</span><span class="token punctuation">(</span>context<span class="token operator">:</span> vscode<span class="token punctuation">.</span>ExtensionContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'activate luada\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code></pre></div>'}}),"\n",e.createElement(a.h2,null,"Launch"),"\n",e.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="json"><pre class="language-json"><code class="language-json">    <span class="token property">"contributes"</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n        <span class="token property">"breakpoints"</span><span class="token operator">:</span> <span class="token punctuation">[</span>\n            <span class="token punctuation">{</span>\n                <span class="token property">"language"</span><span class="token operator">:</span> <span class="token string">"lua"</span>\n            <span class="token punctuation">}</span>\n        <span class="token punctuation">]</span><span class="token punctuation">,</span>\n        <span class="token property">"debuggers"</span><span class="token operator">:</span> <span class="token punctuation">[</span>\n            <span class="token punctuation">{</span>\n                <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"luada"</span><span class="token punctuation">,</span>\n                <span class="token property">"label"</span><span class="token operator">:</span> <span class="token string">"LuaDA"</span><span class="token punctuation">,</span>\n                <span class="token property">"languages"</span><span class="token operator">:</span> <span class="token punctuation">[</span>\n                    <span class="token string">"lua"</span>\n                <span class="token punctuation">]</span><span class="token punctuation">,</span>\n                <span class="token comment">// launch.json のテンプレート</span>\n                <span class="token property">"initialConfigurations"</span><span class="token operator">:</span> <span class="token punctuation">[</span>\n                    <span class="token punctuation">{</span>\n                        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"luada"</span><span class="token punctuation">,</span>\n                        <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"launch luada"</span><span class="token punctuation">,</span>\n                        <span class="token property">"request"</span><span class="token operator">:</span> <span class="token string">"launch"</span><span class="token punctuation">,</span>\n                        <span class="token property">"program"</span><span class="token operator">:</span> <span class="token string">"${workspaceFolder}/main.lua"</span><span class="token punctuation">,</span>\n                        <span class="token property">"args"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n                    <span class="token punctuation">}</span>\n                <span class="token punctuation">]</span><span class="token punctuation">,</span>\n                <span class="token comment">// request: launch に対して可能な property の定義</span>\n                <span class="token property">"configurationAttributes"</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n                    <span class="token property">"launch"</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n                        <span class="token property">"properties"</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n                            <span class="token property">"program"</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n                                <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"string"</span><span class="token punctuation">,</span>\n                                <span class="token property">"markdownDescription"</span><span class="token operator">:</span> <span class="token string">"Lua program to debug - set this to the path of the script"</span><span class="token punctuation">,</span>\n                                <span class="token property">"default"</span><span class="token operator">:</span> <span class="token string">"${workspaceFolder}/main.lua"</span>\n                            <span class="token punctuation">}</span><span class="token punctuation">,</span>                            \n                            <span class="token property">"arg"</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n                                <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"array"</span><span class="token punctuation">,</span>\n                                <span class="token property">"markdownDescription"</span><span class="token operator">:</span> <span class="token string">"Command line argument, arg[1] ... arg[n]"</span><span class="token punctuation">,</span>\n                                <span class="token property">"default"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n                            <span class="token punctuation">}</span>                            \n                        <span class="token punctuation">}</span>\n                    <span class="token punctuation">}</span>\n                <span class="token punctuation">}</span>\n            <span class="token punctuation">}</span>\n        <span class="token punctuation">]</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span></code></pre></div>'}}),"\n",e.createElement(a.ul,null,"\n",e.createElement(a.li,null,"activate で DebugAdapterDescriptorFactory を登録"),"\n",e.createElement(a.li,null,"launch で createDebugAdapterDescriptor を実行する"),"\n"),"\n",e.createElement(a.p,null,e.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">src/extensions.ts</code>'}})),"\n",e.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> vscode <span class="token keyword">from</span> <span class="token string">\'vscode\'</span><span class="token punctuation">;</span>\n\n\n<span class="token keyword">function</span> <span class="token function">createDebugAdapterDescriptorFactory</span><span class="token punctuation">(</span>context<span class="token operator">:</span> vscode<span class="token punctuation">.</span>ExtensionContext<span class="token punctuation">)</span><span class="token operator">:</span> vscode<span class="token punctuation">.</span>DebugAdapterDescriptorFactory <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> <span class="token punctuation">{</span>\n        <span class="token function">createDebugAdapterDescriptor</span><span class="token punctuation">(</span>\n            session<span class="token operator">:</span> vscode<span class="token punctuation">.</span>DebugSession<span class="token punctuation">,</span>\n            executable<span class="token operator">:</span> vscode<span class="token punctuation">.</span>DebugAdapterExecutable <span class="token operator">|</span> <span class="token keyword">undefined</span>\n        <span class="token punctuation">)</span><span class="token operator">:</span> vscode<span class="token punctuation">.</span>ProviderResult<span class="token operator">&lt;</span>vscode<span class="token punctuation">.</span>DebugAdapterDescriptor<span class="token operator">></span> <span class="token punctuation">{</span>\n            <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'launch luada\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token keyword">const</span> runtime <span class="token operator">=</span> <span class="token string">"exe"</span><span class="token punctuation">;</span>\n            <span class="token keyword">const</span> runtimeArgs<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n            <span class="token comment">//</span>\n            <span class="token comment">// デバッグアダプターを起動する</span>\n            <span class="token comment">// 起動したアダプターと vscode は、標準入出力で JSON-RPC により DebugAdapterProtocol で通信する。</span>\n            <span class="token comment">//</span>\n            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">vscode</span><span class="token punctuation">.</span><span class="token function">DebugAdapterExecutable</span><span class="token punctuation">(</span>runtime<span class="token punctuation">,</span> runtimeArgs<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">activate</span><span class="token punctuation">(</span>context<span class="token operator">:</span> vscode<span class="token punctuation">.</span>ExtensionContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'activate luada\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    context<span class="token punctuation">.</span>subscriptions<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>vscode<span class="token punctuation">.</span>debug<span class="token punctuation">.</span><span class="token function">registerDebugAdapterDescriptorFactory</span><span class="token punctuation">(</span><span class="token string">\'luada\'</span><span class="token punctuation">,</span> <span class="token function">createDebugAdapterDescriptorFactory</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">deactivate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span></code></pre></div>'}}),"\n",e.createElement(a.h2,null,"Debug Adapter の実装"),"\n",e.createElement(a.p,null,"https://microsoft.github.io/debug-adapter-protocol/specification"),"\n",e.createElement(a.p,null,"を見て粛々と実装する。"),"\n",e.createElement(a.h3,null,e.createElement(a.a,{href:"https://microsoft.github.io/debug-adapter-protocol/specification#Events_Output"},"Output Event")),"\n",e.createElement(a.p,null,"vscode の DebugConsole に出力されるので早期に作ると print debug の助けになる。"),"\n",e.createElement(a.h3,null,"Logger"),"\n",e.createElement(a.ul,null,"\n",e.createElement(a.li,null,"DebugAdapterProtocol のやりとりすべてを記録する機能をアダプター側で作るべし。無いとデバッグ困難に。"),"\n"),"\n",e.createElement(a.p,null,"例"),"\n",e.createElement(a.p,null,"https://github.com/Microsoft/vscode-debugadapter-node/blob/main/adapter/src/loggingDebugSession.ts"),"\n",e.createElement(a.h2,null,"VSIX に出力"),"\n",e.createElement(a.p,null,"https://code.visualstudio.com/api/working-with-extensions/publishing-extension"),"\n",e.createElement(a.p,null,"vsce を使う。"),"\n",e.createElement(a.p,null,"package.json に追加。"),"\n",e.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="json"><pre class="language-json"><code class="language-json">    <span class="token property">"publisher"</span><span class="token operator">:</span> <span class="token string">"ousttrue"</span><span class="token punctuation">,</span>\n    <span class="token property">"repository"</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"git"</span><span class="token punctuation">,</span>\n        <span class="token property">"url"</span><span class="token operator">:</span> <span class="token string">"https://github.com/ousttrue/luada.git"</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span></code></pre></div>'}}),"\n",e.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">$ npx vsce package</code></pre></div>'}}),"\n",e.createElement(a.h1,null,"参考"),"\n",e.createElement(a.h2,null,"https://github.com/actboy168/lua-debug"),"\n",e.createElement(a.ul,null,"\n",e.createElement(a.li,null,"vscode.DebugAdapterExecutable"),"\n"),"\n",e.createElement(a.h2,null,"https://github.com/tomblind/local-lua-debugger-vscode"),"\n",e.createElement(a.ul,null,"\n",e.createElement(a.li,null,"vscode.DebugAdapterServer"),"\n",e.createElement(a.li,null,"TypeScript で vscode.DebugAdapterServer を new"),"\n",e.createElement(a.li,null,"vscode と DebugAdapterServer が DAP で通信"),"\n",e.createElement(a.li,null,"DebugAdapterServer が lua を spawn もしている"),"\n"))}var o=function(n){void 0===n&&(n={});const{wrapper:a}=Object.assign({},(0,t.ah)(),n.components);return a?e.createElement(a,n,e.createElement(p,n)):p(n)},l=(s(8678),s(8838));const c={code:n=>{let{children:a,className:s}=n;return s?e.createElement(l.Z,{className:s},a):e.createElement("code",null,a)}};function u(n){let{data:a,children:s}=n;return e.createElement(e.Fragment,null,e.createElement("h1",null,a.mdx.frontmatter.title),e.createElement(t.Zo,{components:c},s))}function r(n){return e.createElement(u,n,e.createElement(o,n))}}}]);
//# sourceMappingURL=component---src-templates-post-template-js-content-file-path-home-runner-work-ousttrue-github-io-ousttrue-github-io-content-posts-2021-luada-md-b8d3ec6e73478fcfb048.js.map