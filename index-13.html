<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article# " lang="ja">
<head>
<meta charset="utf-8">
<meta name="description" content="作業記録">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>三次元日誌 (過去の記事 13ページ目) | 三次元日誌</title>
<link href="assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<link href="https://fonts.googleapis.com/css?family=Playfair+Display:700,900" rel="stylesheet">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" hreflang="ja" href="rss.xml">
<link rel="canonical" href="https://ousttrue.github.io/index-13.html">
<link rel="prev" href="index-14.html" type="text/html">
<link rel="next" href="index-12.html" type="text/html">
<!--[if lt IE 9]><script src="assets/js/html5.js"></script><![endif]-->
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">本文を読み飛ばす</a>

<!-- Header and menu bar -->
<div class="container">
      <header class="blog-header py-3"><div class="row nbb-header align-items-center">
          <div class="col-md-3 col-xs-2 col-sm-2" style="width: auto;">
            <button class="navbar-toggler navbar-light bg-light nbb-navbar-toggler" type="button" data-toggle="collapse" data-target=".bs-nav-collapsible" aria-controls="bs-navbar" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse bs-nav-collapsible bootblog4-search-form-holder">
                
            </div>
        </div>
          <div class="col-md-6 col-xs-10 col-sm-10 bootblog4-brand" style="width: auto;">
            <a class="navbar-brand blog-header-logo text-dark" href=".">

            <span id="blog-title">三次元日誌</span>
        </a>
          </div>
            <div class="col-md-3 justify-content-end align-items-center bs-nav-collapsible collapse flex-collapse bootblog4-right-nav">
            <nav class="navbar navbar-light bg-white"><ul class="navbar-nav bootblog4-right-nav"></ul></nav>
</div>
    </div>
</header><nav class="navbar navbar-expand-md navbar-light bg-white static-top"><div class="collapse navbar-collapse bs-nav-collapsible" id="bs-navbar">
            <ul class="navbar-nav nav-fill d-flex w-100">
<li class="nav-item">
<a href="books" class="nav-link">MemoBooks</a>
                </li>
<li class="nav-item">
<a href="archive.html" class="nav-link">Archives</a>
                </li>
<li class="nav-item">
<a href="categories/index.html" class="nav-link">Tags</a>
                </li>
<li class="nav-item">
<a href="rss.xml" class="nav-link">RSS feed</a>
                </li>
<li class="nav-item">
<a href="about" class="nav-link">About</a>

                
            </li>
</ul>
</div>
<!-- /.navbar-collapse -->
</nav>
</div>

<div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        
        
        
    
        

    
        
    <div class="postindex">
            <article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/2015/12/07/threejs_04/" class="u-url">Three.jsのJSONモデルフォーマット</a></h1>
                <div class="metadata">
                    <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                        ousttrue
                    </span></p>
            <p class="dateline">
            <a href="posts/2015/12/07/threejs_04/" rel="bookmark">
            <time class="published dt-published" datetime="2015-12-07T00:00:00+09:00" itemprop="datePublished" title="2015-12-07 00:00">2015-12-07 00:00</time></a>
            </p>
                </div>
            </header><div class="e-content entry-content">
                    <div>
<p>source
外部のJSONに記述されたモデルを読み込む機能がある。
External models in Three.js
を見てやってみた。
OnLoad(geometry: THREE.Geometry, materials: THREE.Material[]) {
    // create a mesh with models geometry and material
    var material = new THREE.MeshPhongMaterial(materials[0]);
    var mesh = new THREE.Mesh(
        geometry,
        material
    );</p>
<pre class="code literal-block"><span></span>mesh.rotation.y = -Math.PI / 5;

this.scene.add(mesh);
this.Render();
</pre>

<p>}</p>
<p>OnProgress(event: any) {
    console.log('OnProgress: ', event);
}</p>
<p>OnError(event: any) {
    console.log('OnError: ', event);
}</p>
<p>AddModelFromJson(path: string) {
    var loader = new THREE.JSONLoader(); // init the loader util</p>
<pre class="code literal-block"><span></span>// init loading
loader.load(path, this.OnLoad.bind(this)
    , this.OnProgress.bind(this)
    , this.OnError.bind(this));
</pre>

<p>}</p>
<p>JSONLoaderクラスを初期化してloadをコール、loadは非同期に完了してOnLoadコールバックでMeshを組み立ててシーンに追加するという流れ。
OnLoadにMeshが返ってくればいいと思うのだが・・・
モデルはサンプルファイルを探したのだが見つからなかったので、
Three.js の JSONLoader のメモ
を見てBlenderのThree.js exporterでお猿さんを作ってみました。
一応、茶色いマテリアルをつけたのだけどうまくいかず。
フォーマットはどうなっているのか？
cubeもエクスポートしてみた。
cube.json
{
    "faces": [35,2,0,1,3,0,0,1,2,3,35,3,7,6,2,0,3,4,5,0,35,7,5,4,6,0,4,6,7,5,35,0,4,5,1,0,1,7,6,2,35,0,2,6,4,0,1,0,5,7,35,5,7,3,1,0,6,4,3,2],
    "name": "CubeGeometry.1",
    "metadata": {
        "generator": "io_three",
        "vertices": 8,
        "type": "Geometry",
        "uvs": 0,
        "version": 3,
        "faces": 6,
        "materials": 1,
        "normals": 8
    },
    "vertices": [-1,-1,1,-1,1,1,-1,-1,-1,-1,1,-1,1,-1,1,1,1,1,1,-1,-1,1,1,-1],
    "materials": [{
        "depthWrite": true,
        "colorDiffuse": [0,0.64,0.040691],
        "depthTest": true,
        "specularCoef": 50,
        "blending": "NormalBlending",
        "shading": "phong",
        "colorEmissive": [0,0,0],
        "opacity": 1,
        "transparent": false,
        "DbgIndex": 0,
        "visible": true,
        "wireframe": false,
        "colorSpecular": [0.5,0.5,0.5],
        "colorAmbient": [0,0.64,0.040691],
        "DbgName": "Material",
        "DbgColor": 15658734
    }],
    "uvs": [],
    "normals": [-0.577349,-0.577349,-0.577349,-0.577349,-0.577349,0.577349,-0.577349,0.577349,0.577349,-0.577349,0.577349,-0.577349,0.577349,0.577349,-0.577349,0.577349,-0.577349,-0.577349,0.577349,0.577349,0.577349,0.577349,-0.577349,0.577349]
}</p>
<p>JSON Model format 3 (Soon to be deprecated)
これっぽいですな。
なるほど。なるほど。</p>
</div>
                </div>
            </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/2015/12/06/threejs_02/" class="u-url">Three.jsにマウスによる視点操作を入れる</a></h1>
                <div class="metadata">
                    <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                        ousttrue
                    </span></p>
            <p class="dateline">
            <a href="posts/2015/12/06/threejs_02/" rel="bookmark">
            <time class="published dt-published" datetime="2015-12-06T00:00:00+09:00" itemprop="datePublished" title="2015-12-06 00:00">2015-12-06 00:00</time></a>
            </p>
                </div>
            </header><div class="e-content entry-content">
                    <div>
<p>source
今回は、TrackballControlsを導入します。
TrackballControlsはThree.jsのライブラリ内に含まれるのではなくexamples扱いなので、
直接コードを入手。
使い方は、TrackballControlsのソースを見ると
以下のようにするらしい。
controls = new THREE.TrackballControls( camera );</p>
<p>controls.rotateSpeed = 1.0;
controls.zoomSpeed = 1.2;
controls.panSpeed = 0.8;</p>
<p>controls.noZoom = false;
controls.noPan = false;</p>
<p>controls.staticMoving = true;
controls.dynamicDampingFactor = 0.3;</p>
<p>controls.keys = [ 65, 83, 68 ];</p>
<p>controls.addEventListener( 'change', render );</p>
<p>もうひとつ更新用に以下のコードも必要。
function animate() {
    requestAnimationFrame( animate );
    controls.update();
}</p>
<p>やってみよう。
ベースのレンダリングシーン
シーンに適当にキューブを描画するコード。
前回の記事をほぼ流用だけどいくつか変更点がある。</p>
<p>namespaceでかこって名前衝突から防衛
CreateCameraを独立
キューブがアニメーションする部分をオミット</p>
<p>threejs_02.ts
/// <reference path="../../../../typings/tsd.d.ts"></reference></p>
<p>namespace Renderer02 {</p>
<pre class="code literal-block"><span></span><span class="kr">class</span> <span class="nx">Renderer</span> <span class="p">{</span>
    <span class="nx">$container</span>: <span class="kt">JQuery</span><span class="p">;</span>
    <span class="nx">renderer</span>: <span class="kt">THREE.Renderer</span><span class="p">;</span>

    <span class="nx">scene</span>: <span class="kt">THREE.Scene</span><span class="p">;</span>
    <span class="nx">camera</span>: <span class="kt">THREE.Camera</span><span class="p">;</span>
    <span class="nx">mesh</span>: <span class="kt">THREE.Mesh</span><span class="p">;</span>

    <span class="nx">CreateRenderer</span><span class="p">(</span><span class="nx">$container</span>: <span class="kt">JQuery</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">$container</span> <span class="o">=</span> <span class="nx">$container</span><span class="p">;</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">renderer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">WebGLRenderer</span><span class="p">();</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">renderer</span><span class="p">.</span><span class="nx">setSize</span><span class="p">(</span><span class="nx">$container</span><span class="p">.</span><span class="nx">width</span><span class="p">(),</span> <span class="nx">$container</span><span class="p">.</span><span class="nx">height</span><span class="p">());</span>
        <span class="nx">$container</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">renderer</span><span class="p">.</span><span class="nx">domElement</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nx">CreateCamera() {</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">camera</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">PerspectiveCamera</span><span class="p">(</span><span class="mi">75</span>
            <span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">$container</span><span class="p">.</span><span class="nx">width</span><span class="p">()</span> <span class="o">/</span> <span class="k">this</span><span class="p">.</span><span class="nx">$container</span><span class="p">.</span><span class="nx">height</span><span class="p">()</span>
            <span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mi">1000</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">camera</span><span class="p">.</span><span class="nx">position</span><span class="p">.</span><span class="nx">z</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nx">CreateScene() {</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">scene</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Scene</span><span class="p">();</span>

        <span class="kd">var</span> <span class="nx">geometry</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">BoxGeometry</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">material</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">MeshBasicMaterial</span><span class="p">({</span> <span class="nx">color</span>: <span class="kt">0x00ff00</span> <span class="p">});</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">mesh</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Mesh</span><span class="p">(</span><span class="nx">geometry</span><span class="p">,</span> <span class="nx">material</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">scene</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">mesh</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nx">Render() {</span>
        <span class="c1">// render</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">renderer</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">scene</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">camera</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">renderer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Renderer</span><span class="p">();</span>
<span class="kr">export</span> <span class="kd">function</span> <span class="nx">initialize</span><span class="p">(</span><span class="nx">$container</span>: <span class="kt">JQuery</span><span class="p">)</span> <span class="p">{</span>

    <span class="nx">renderer</span><span class="p">.</span><span class="nx">CreateRenderer</span><span class="p">(</span><span class="nx">$container</span><span class="p">);</span>
    <span class="nx">renderer</span><span class="p">.</span><span class="nx">CreateCamera</span><span class="p">();</span>
    <span class="nx">renderer</span><span class="p">.</span><span class="nx">CreateScene</span><span class="p">();</span>

    <span class="nx">renderer</span><span class="p">.</span><span class="nx">Render</span><span class="p">();</span>
<span class="p">}</span>
</pre>

<p>}</p>
<p>$(() =&gt; {
    var $container = $('div#renderer');
    Renderer02.initialize($container);
});</p>
<p>TypeScript定義を追加する
まず、TrackballControlsの型定義を追加する。
declare module THREE {
    export class TrackballControls
    {
        constructor(camera: THREE.Camera);
        rotateSpeed: number;
        zoomSpeed: number;
        panSpeed: number;
        noZoom: boolean;
        noPan: boolean;
        staticMoving: boolean;
        dynamicDampingFactor: number;
        keys: number[];
        addEventListener(event: string, callback: Function):void;
        update():void;
    }
}</p>
<p>TrackballControlsを初期化
// Rendererのメソッドを修正
    CreateCamera() {
        this.camera = new THREE.PerspectiveCamera(75
            , this.$container.width() / this.$container.height()
            , 0.1, 1000);
        this.camera.position.z = 5;</p>
<pre class="code literal-block"><span></span>    // 以下を追加
    this.controls = new THREE.TrackballControls(this.camera);

    this.controls.rotateSpeed = 1.0;
    this.controls.zoomSpeed = 1.2;
    this.controls.panSpeed = 0.8;

    this.controls.noZoom = false;
    this.controls.noPan = false;

    this.controls.staticMoving = true;
    this.controls.dynamicDampingFactor = 0.3;

    this.controls.keys = [65, 83, 68];

    // trackballに変化があった時だけ描画を呼ぶ
    this.controls.addEventListener('change', this.Render.bind(this));
}
</pre>

<p>// Rendererのメソッドを追加
    Animate() {
        requestAnimationFrame(this.Animate.bind(this));
        this.controls.update();
    }</p>
<p>// Animate呼び出しを追加
    export function initialize($container: JQuery) {</p>
<pre class="code literal-block"><span></span>    renderer.CreateRenderer($container);
    renderer.CreateCamera();
    renderer.CreateScene();

    renderer.Render();
    renderer.Animate(); // 追加
}
</pre>

<p>動いたがWindow全体のマウスイベントが取られていてこれじゃない。
canvasの親になったdivをマウスイベントの対象にしたい。
div#rendererを操作対象にする
TrackballControls.jsを見てたら
THREE.TrackballControls = function ( object, domElement ) {
}</p>
<p>という記述を発見。第２引数にhtmlエレメントを渡せるらしい。
定義を修正。
// 定義
    constructor(camera: THREE.Camera, element?: Element);</p>
<p>// 呼び出し
   this.controls = new THREE.TrackballControls(this.camera, this.$container[0]);</p>
<p>想定した動きになった。
マウスカーソルを変えてみる
cssの話だけれど。</p>
<div id="renderer" style="width:300px;height:200px;cursor:pointer;"></div>

<pre class="code literal-block"><span></span><span class="o">$</span><span class="nt">container</span>
    <span class="p">.</span><span class="nc">mousedown</span><span class="o">(</span><span class="nt">function</span><span class="o">(</span><span class="nt">event</span><span class="o">)</span> <span class="p">{</span>
        <span class="err">switch</span> <span class="err">(event.button)</span> <span class="err">{</span>
            <span class="err">case</span> <span class="err">0:</span>
                <span class="err">$(this).css({</span> <span class="k">cursor</span><span class="p">:</span> <span class="s1">'pointer'</span> <span class="p">}</span><span class="o">);</span>
                <span class="nt">break</span><span class="o">;</span>

            <span class="nt">case</span> <span class="nt">1</span><span class="o">:</span>
                <span class="o">$(</span><span class="nt">this</span><span class="o">)</span><span class="p">.</span><span class="nc">css</span><span class="o">(</span><span class="p">{</span> <span class="k">cursor</span><span class="p">:</span> <span class="s1">'n-resize'</span> <span class="p">}</span><span class="o">);</span>
                <span class="nt">break</span><span class="o">;</span>

            <span class="nt">case</span> <span class="nt">2</span><span class="o">:</span>
                <span class="o">$(</span><span class="nt">this</span><span class="o">)</span><span class="p">.</span><span class="nc">css</span><span class="o">(</span><span class="p">{</span> <span class="k">cursor</span><span class="p">:</span> <span class="s1">'move'</span> <span class="p">}</span><span class="o">);</span>
                <span class="nt">break</span><span class="o">;</span>
        <span class="err">}</span>
    <span class="err">}</span><span class="o">)</span>
    <span class="p">.</span><span class="nc">mouseup</span><span class="o">(</span><span class="nt">function</span><span class="o">(</span><span class="nt">event</span><span class="o">)</span><span class="p">{</span>
        <span class="err">$(this).css({</span><span class="k">cursor</span><span class="p">:</span> <span class="s1">'pointer'</span><span class="p">}</span><span class="o">);</span>
    <span class="err">}</span><span class="o">)</span>
<span class="o">;</span>
</pre>
</div>
                </div>
            </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/2015/12/06/threejs_01/" class="u-url">TypeScriptでThree.jsことはじめ</a></h1>
                <div class="metadata">
                    <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                        ousttrue
                    </span></p>
            <p class="dateline">
            <a href="posts/2015/12/06/threejs_01/" rel="bookmark">
            <time class="published dt-published" datetime="2015-12-06T00:00:00+09:00" itemprop="datePublished" title="2015-12-06 00:00">2015-12-06 00:00</time></a>
            </p>
                </div>
            </header><div class="e-content entry-content">
                    <div>
<p>source
TypeScriptを学び始めた目的のひとつであるThree.jsをようやくはじめた。
「Node.jsとSocket.IOで連結してリアルタイムにシーンをアニメーションするっ」とか
遠大な構想だったのだが小さいところから始めよう。
hello world的な
本家のgetting started
htmlにスクリプトを追加。</p>
<script src="posts/2015/12/06/threejs_01/threejs_01.js"></script><p>threejs_01.js
var scene = new THREE.Scene();
var camera = new THREE.PerspectiveCamera(75
    , window.innerWidth / window.innerHeight
    , 0.1, 1000);</p>
<p>var renderer = new THREE.WebGLRenderer();
renderer.setSize(window.innerWidth, window.innerHeight);
document.body.appendChild(renderer.domElement);</p>
<p>var geometry = new THREE.BoxGeometry(1, 1, 1);
var material = new THREE.MeshBasicMaterial({ color: 0x00ff00 });
var cube = new THREE.Mesh(geometry, material);
scene.add(cube);</p>
<p>camera.position.z = 5;</p>
<p>var render = function() {
    requestAnimationFrame(render);</p>
<pre class="code literal-block"><span></span>cube.rotation.x += 0.1;
cube.rotation.y += 0.1;

renderer.render(scene, camera);
</pre>

<p>};</p>
<p>render();</p>
<p>typescript化する。
gulpにタスクを仕込んだので拡張子をtsにして待つのみ。
error TS2304: Cannot find name 'THREE'</p>
<p>three.jsの型定義が無いので追加。</p>
<blockquote>
<p>tsd query three -rosa install</p>
</blockquote>
<p>tsの先頭にtsdの参照を追加
/// <reference path="../../../../typings/tsd.d.ts"></reference></p>
<p>無事typescript化に成功。
tsconfig.jsonはこんな感じ。
{
    "compilerOptions": {
        "module": "commonjs",
        "target": "es5",
        "noImplicitAny": true,
        "outDir": ".",
        "rootDir": ".",
        "sourceMap": false
    },
    "exclude": [
        "node_modules"
    ]
}</p>
<p>canvasの作成先を変える
renderer.setSize(window.innerWidth, window.innerHeight);
document.body.appendChild(renderer.domElement);</p>
<p>を変えよう。
dom操作等にjqueryを使う意向なのでjquery導入。</p>
<blockquote>
<p>tsd query jquery -rosa install</p>
</blockquote>
<p>htmlにdivを追加して</p>
<div id="renderer" style="width:300px;height:200px;"></div>

<p>レンダラのサイズと親を変える。
var $container=$('div#renderer');
renderer.setSize($container.width(), $container.height());
$container.append(renderer.domElement);</p>
<p>カメラのアスペクト比も変える。
var camera = new THREE.PerspectiveCamera(75
    , $container.width()/$container.height()
    , 0.1, 1000);</p>
<p>TypeScript風に書き換えてみる
せっかくTypeScriptにしているのでフリーダムに書き換えてみる。
/// <reference path="../../../../typings/tsd.d.ts"></reference></p>
<p>class Renderer {
    $container: JQuery;
    renderer: THREE.Renderer;</p>
<pre class="code literal-block"><span></span><span class="n">scene</span><span class="o">:</span> <span class="n">THREE</span><span class="o">.</span><span class="na">Scene</span><span class="o">;</span>
<span class="n">camera</span><span class="o">:</span> <span class="n">THREE</span><span class="o">.</span><span class="na">Camera</span><span class="o">;</span>
<span class="n">mesh</span><span class="o">:</span> <span class="n">THREE</span><span class="o">.</span><span class="na">Mesh</span><span class="o">;</span>

<span class="n">CreateRenderer</span><span class="o">(</span><span class="n">$container</span><span class="o">:</span> <span class="n">JQuery</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">$container</span> <span class="o">=</span> <span class="n">$container</span><span class="o">;</span>

    <span class="k">this</span><span class="o">.</span><span class="na">renderer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">THREE</span><span class="o">.</span><span class="na">WebGLRenderer</span><span class="o">();</span>
    <span class="k">this</span><span class="o">.</span><span class="na">renderer</span><span class="o">.</span><span class="na">setSize</span><span class="o">(</span><span class="n">$container</span><span class="o">.</span><span class="na">width</span><span class="o">(),</span> <span class="n">$container</span><span class="o">.</span><span class="na">height</span><span class="o">());</span>
    <span class="n">$container</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">renderer</span><span class="o">.</span><span class="na">domElement</span><span class="o">);</span>
<span class="o">}</span>

<span class="n">CreateScene</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">scene</span> <span class="o">=</span> <span class="k">new</span> <span class="n">THREE</span><span class="o">.</span><span class="na">Scene</span><span class="o">();</span>

    <span class="n">var</span> <span class="n">geometry</span> <span class="o">=</span> <span class="k">new</span> <span class="n">THREE</span><span class="o">.</span><span class="na">BoxGeometry</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">1</span><span class="o">,</span> <span class="mi">1</span><span class="o">);</span>
    <span class="n">var</span> <span class="n">material</span> <span class="o">=</span> <span class="k">new</span> <span class="n">THREE</span><span class="o">.</span><span class="na">MeshBasicMaterial</span><span class="o">({</span> <span class="n">color</span><span class="o">:</span> <span class="mh">0x00ff00</span> <span class="o">});</span>
    <span class="k">this</span><span class="o">.</span><span class="na">mesh</span> <span class="o">=</span> <span class="k">new</span> <span class="n">THREE</span><span class="o">.</span><span class="na">Mesh</span><span class="o">(</span><span class="n">geometry</span><span class="o">,</span> <span class="n">material</span><span class="o">);</span>
    <span class="k">this</span><span class="o">.</span><span class="na">scene</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">mesh</span><span class="o">);</span>

    <span class="k">this</span><span class="o">.</span><span class="na">camera</span> <span class="o">=</span> <span class="k">new</span> <span class="n">THREE</span><span class="o">.</span><span class="na">PerspectiveCamera</span><span class="o">(</span><span class="mi">75</span>
        <span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">$container</span><span class="o">.</span><span class="na">width</span><span class="o">()</span> <span class="o">/</span> <span class="k">this</span><span class="o">.</span><span class="na">$container</span><span class="o">.</span><span class="na">height</span><span class="o">()</span>
        <span class="o">,</span> <span class="mf">0.1</span><span class="o">,</span> <span class="mi">1000</span><span class="o">);</span>
    <span class="k">this</span><span class="o">.</span><span class="na">camera</span><span class="o">.</span><span class="na">position</span><span class="o">.</span><span class="na">z</span> <span class="o">=</span> <span class="mi">5</span><span class="o">;</span>
<span class="o">}</span>

<span class="n">Render</span><span class="o">(){</span>
    <span class="n">requestAnimationFrame</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">Render</span><span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="k">this</span><span class="o">));</span>

    <span class="c1">// update scene</span>
    <span class="k">this</span><span class="o">.</span><span class="na">mesh</span><span class="o">.</span><span class="na">rotation</span><span class="o">.</span><span class="na">x</span> <span class="o">+=</span> <span class="mf">0.1</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">mesh</span><span class="o">.</span><span class="na">rotation</span><span class="o">.</span><span class="na">y</span> <span class="o">+=</span> <span class="mf">0.1</span><span class="o">;</span>

    <span class="c1">// render</span>
    <span class="k">this</span><span class="o">.</span><span class="na">renderer</span><span class="o">.</span><span class="na">render</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">scene</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">camera</span><span class="o">);</span>
<span class="o">}</span>
</pre>

<p>}
var renderer = new Renderer();</p>
<p>$(() =&gt; {
    var $container = $('div#renderer');
    renderer.CreateRenderer($container);
    renderer.CreateScene();</p>
<pre class="code literal-block"><span></span>renderer.Render();
</pre>

<p>});</p>
</div>
                </div>
            </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/2015/12/06/threejs_03/" class="u-url">グリッドと軸と光源とFPS表示を入れる</a></h1>
                <div class="metadata">
                    <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                        ousttrue
                    </span></p>
            <p class="dateline">
            <a href="posts/2015/12/06/threejs_03/" rel="bookmark">
            <time class="published dt-published" datetime="2015-12-06T00:00:00+09:00" itemprop="datePublished" title="2015-12-06 00:00">2015-12-06 00:00</time></a>
            </p>
                </div>
            </header><div class="e-content entry-content">
                    <div>
<p>source
シーンを強化してみる。
軸
先人が記事を残してくれていたので楽ちん。
Three.js　AxisHelper
//軸の長さ１０００
var axis = new THREE.AxisHelper(1000); <br>
//sceneに追加
this.scene.add(axis);</p>
<p>グリッド
Three.js GridHelper
//GridHelper(大きさ, １マスの大きさ)
var grid = new THREE.GridHelper(100, 10);
//シーンオブジェクトに追加
this.scene.add(grid);</p>
<p>光源
ライトを追加して、マテリアルを光に反応するタイプに付け替える。
// lights
var directionalLight = new THREE.DirectionalLight(0xffffff);
directionalLight.position.set(0, 0.7, 0.7);
this.scene.add(directionalLight);</p>
<p>// materialを交換
//var material = new THREE.MeshBasicMaterial({ color: 0x00ff00 });
var material = new THREE.MeshPhongMaterial({ color: 0xff0000 });</p>
<p>FPS状態表示
WebGLのデモでよく見かけるFPS表示を入れてみる。
https://github.com/mrdoob/stats.js
ライブラリと定義をインストール。</p>
<blockquote>
<p>bower install stats.js --save
tsd query stats -rosa install</p>
</blockquote>
<p>２箇所更新になる。
// add stats
$container.css({ position: 'relative' });
this.stats = new Stats();
this.stats.domElement.style.position = 'absolute';
this.stats.domElement.style.top = '0px';
this.stats.domElement.style.zIndex = '100';
$container.append(this.stats.domElement);</p>
<p>// update stats
Animate() {
    requestAnimationFrame(this.Animate.bind(this));
    this.controls.update();
    this.stats.update();
}</p>
</div>
                </div>
            </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="qiita/typescripthuan-jing-nofen-karinikuitokoro/" class="u-url">TypeScript環境の分かりにくいところ</a></h1>
                <div class="metadata">
                    <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                        ousttrue
                    </span></p>
            <p class="dateline">
            <a href="qiita/typescripthuan-jing-nofen-karinikuitokoro/" rel="bookmark">
            <time class="published dt-published" datetime="2015-11-29T04:37:44+09:00" itemprop="datePublished" title="2015-11-29 04:37">2015-11-29 04:37</time><span class="updated"> (更新日時
                    <time class="dt-updated" datetime="2015-11-29T05:53:41+09:00" itemprop="dateUpdated" title="2015-11-29 05:53">2015-11-29 05:53</time>)</span>
            </a>
            </p>
                </div>
            </header><div class="e-content entry-content">
                    <p><a href="https://qiita.com/ousttrue/items/8bd21094cb7b58d2a016">https://qiita.com/ousttrue/items/8bd21094cb7b58d2a016</a></p>
                </div>
            </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/2015/11/21/mondo_crud/" class="u-url">MongoDBでCRUD</a></h1>
                <div class="metadata">
                    <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                        ousttrue
                    </span></p>
            <p class="dateline">
            <a href="posts/2015/11/21/mondo_crud/" rel="bookmark">
            <time class="published dt-published" datetime="2015-11-21T00:00:00+09:00" itemprop="datePublished" title="2015-11-21 00:00">2015-11-21 00:00</time></a>
            </p>
                </div>
            </header><div class="e-content entry-content">
                    <div>
<p>“シングルページWebアプリケーション”に説明されている
mongodbをバックエンドに、node.js + expressをフロントエンドにする構成のおさらい。
MongoDB &lt;-&gt; node.js Express &lt;-&gt; Browser</p>
<p>グローバルなnpmパッケージ</p>
<blockquote>
<p>npm install -g gulp typescript tsd bower</p>
</blockquote>
<p>Windowsの場合、
%USERPROFILE%\AppData\Roaming\npm</p>
<p>にインストールされるのでパスを通しておく。
Expressの準備
app.js</p>
<blockquote>
<p>mkdir mongocrud
cd mongocrud
mongocrud&gt; npm init -y
mongocrud&gt; npm install express --save</p>
</blockquote>
<p>// app.js
var http=require('http');
var express=require('express');</p>
<p>var port=process.env.port || 3000;
var app=express();
var server=http.createServer(app);</p>
<p>app.get('/', function(request, response){
    response.send('Hello Express');
});</p>
<p>server.listen(port);</p>
<p>起動</p>
<blockquote>
<p>node app.js</p>
</blockquote>
<p>http://localhost:3000
で動作を確認する。
loggerや静的ファイル提供などのミドルウェアを追加
mongocrud&gt; npm install body-parser method-override connect-logger errorhandler serve-static --save</p>
<p>// app.js
// app.getの前
var bodyparser=require('body-parser');
var methodoverride = require('method-override');
var logger = require('connect-logger');
var errorhandler = require('errorhandler');
var servestatic = require('serve-static');
var serve_dir=__dirname + "/client";
console.log("serve %s", serve_dir);
app
.use(bodyparser())
.use(methodoverride())
.use(logger())
.use(errorhandler({
    dumpExceptioons: true,
    showStack: true
}));
.use(servestatic(serve_dir))</p>
<p>gulpで静的なファイルを’./build/client’下にコピーするタスクを定義する</p>
<h2>gulpfile.coffeeにタスクを追加</h2>
<h2></h2>
<h2>client</h2>
<h2></h2>
<p>gulp.task 'client', -&gt;
    gulp.src config.src_client
        .pipe gulp.dest config.dst_client
        .pipe browserSync.stream()</p>
<h2>tasks</h2>
<p>gulp.task 'watch', -&gt;
    gulp.watch config.src_ts, ['ts']
    gulp.watch config.src_client, ['client']</p>
<p>gulpでサーバー起動とブラウザの自動オープンタスクを定義する
いろいろ入用になるのでgulpを準備する。
まずは、nodemonとbrowser-syncを導入して
app.js起動と起動したアプリをブラウザで自動で開くタスクを定義する。
mongocrud&gt; npm install gulp gulp-load-plugins gulp-nodemon browser-sync -D</p>
<p>// gulpfile.js
var gulp = require('gulp');
var $ = require("gulp-load-plugins")();
var browserSync = require("browser-sync").create();
var port = 5000;</p>
<p>gulp.task('serve', function () {
    $.nodemon({
        script: 'app.js',
        exp: 'js',
        ignore: [],
        env: {
            port: port
        }
    })
    .on('restart', function () { browserSync.reload(); });
});</p>
<p>gulp.task('browser-sync', ['serve'], function () {
    browserSync.init({
        proxy: "localhost:" + port
    });
});</p>
<p>gulp.task('default', ['browser-sync']);</p>
<p>BrowserSyncのReloadが動くには出力がhtmlである必要がある(bodyタグの中に細工をするため)。
// app.jsの修正
app.get('/', function(request, response){
    response.setHeader('content-type', 'text/html');
    response.send('</p>Hello html');
});
<p>mongocrud&gt; gulp</p>
<p>でnodemonが起動してブラウザが自動で開始される。
app.jsの内容を変えるとブラウザがリロードされる。
が、リロードが速すぎて内容が更新されないことが判明。
リロードを遅延させる策を講じる。
// app.jsの最後尾に追加
console.log('start %d', port);</p>
<p>app.jsからのコンソール出力を監視する。
// gulpfile.jsの修正</p>
<pre class="code literal-block"><span></span><span class="o">$</span><span class="nf">.nodemon</span><span class="p">({</span>
    <span class="n">script</span><span class="o">:</span> <span class="n">config.app_entry</span><span class="p">,</span>
    <span class="n">exp</span><span class="o">:</span> <span class="s">'js'</span><span class="p">,</span>
    <span class="n">ignore</span><span class="o">:</span> <span class="n">[]</span><span class="p">,</span>
    <span class="n">env</span><span class="o">:</span> <span class="p">{</span>
        <span class="n">port</span><span class="o">:</span> <span class="n">config.app_port</span>
    <span class="p">},</span>
    <span class="n">stdout</span><span class="o">:</span> <span class="n">false</span> <span class="o">//</span> <span class="o">&lt;-</span> 必要
<span class="p">})</span>
<span class="o">//</span><span class="nf">.on</span><span class="p">(</span><span class="s">'restart'</span><span class="p">,</span> <span class="nf">function </span><span class="p">()</span> <span class="p">{</span> <span class="nf">browserSync.reload</span><span class="p">();</span> <span class="p">});</span>
<span class="nf">.on</span><span class="p">(</span><span class="s">'readable'</span><span class="p">,</span> <span class="nf">function</span><span class="p">(){</span>
    <span class="nf">this.stdout.on</span><span class="p">(</span><span class="s">'data'</span><span class="p">,</span> <span class="nf">function</span><span class="p">(</span><span class="n">chunk</span><span class="p">){</span>
        <span class="nf">if </span><span class="p">(</span><span class="o">/</span><span class="n">^start</span> <span class="o">/</span><span class="nf">.test</span><span class="p">(</span><span class="n">chunk</span><span class="p">)){</span>
            <span class="nf">console.log</span><span class="p">(</span><span class="s">'reloading...'</span><span class="p">);</span>
            <span class="nf">browserSync.reload</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="nf">process.stdout.write</span><span class="p">(</span><span class="n">chunk</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">});</span>
</pre>

<p>gulpfile.jsをgulpfile.coffeeにする
gulpcrud&gt; npm install coffee-script -D</p>
<p>gulpfile.jsを書き換える。gulp-3.9.0では既にcoffee script対応が成されているようで、
gulpfile.jsの拡張子を変えてgulpfile.coffeeとリネームして中身を書き換えてから
mongocrud&gt; gulp</p>
<p>としたら特にオプション等を指定することなくgulpはgulpfile.coffeeを見つけてくれて動いた。</p>
<h2>gulpfile.coffee</h2>
<p>gulp = require('gulp');
$ = require("gulp-load-plugins")();
browserSync = require("browser-sync").create();
port = 5000;</p>
<p>gulp.task 'serve', -&gt;
    $.nodemon({
        script: 'app.js',
        exp: 'js',
        ignore: [],
        env: {
            port: port
        }
    })
    .on 'readable', -&gt;
        this.stdout.on 'data', (chunk) -&gt;
            if (/^start /.test(chunk))
                console.log('reloading...')
                browserSync.reload()
            process.stdout.write(chunk);</p>
<p>gulp.task 'browser-sync', ['serve'], -&gt;
    browserSync.init({
        proxy: "localhost:" + port
    })</p>
<p>gulp.task('default', ['browser-sync']);</p>
<p>TypeScriptにする
app.jsをsrc/app.tsに移動する。
// src/app.ts
declare function require(name: string):any;
declare var process;</p>
<p>var http=require('http');
var express=require('express');</p>
<p>var port=process.env.port || 3000;
var app=express();
var server=http.createServer(app);</p>
<p>app.get('/', function(request, response){
    response.setHeader('content-type', 'text/html');
    response.send('</p>Hello');
});
<p>server.listen(port);
console.log('start %d', port);</p>
<p>コンパイルが通るようにアンビエント宣言を追加した。
gulpにコンパイルタスクを定義する。
serveタスクの前にtsタスクを実行し、
tsファイルの更新をwatchしてtsタスクを起動するように調整した。</p>
<h2>gulpfile.coffee</h2>
<p>gulp = require('gulp');
$ = require("gulp-load-plugins")();
browserSync = require("browser-sync").create();</p>
<p>config = {
    src_ts: './src/<strong>/*.ts', <br>
    dst_js_dir: './build/js',
    dst_watch: './build/</strong>/*.js',
    app_entry: './build/js/app.js',
    app_port: 5000
}</p>
<h2></h2>
<h2>compile typescript</h2>
<h2></h2>
<p>gulp.task 'ts', -&gt;
  gulp.src config.src_ts
    .pipe $.typescript({
      target: 'ES6'
      removeComments: true
    }).js
    .pipe gulp.dest config.dst_js_dir</p>
<h2></h2>
<h2>start js app</h2>
<h2></h2>
<p>gulp.task 'serve', ['ts'], -&gt;
    $.nodemon({
        script: config.app_entry,
        exp: 'js',
        ignore: [],
        env: {
            port: config.app_port
        },
        stdout: false
    })
    #.on 'restart', -&gt;
    #    browserSync.reload();
    .on 'readable', -&gt;
        this.stdout.on 'data', (chunk) -&gt;
            if (/^start /.test(chunk))
                console.log('reloading...')
                browserSync.reload()
            process.stdout.write(chunk);</p>
<h2></h2>
<h2>start browser-sync</h2>
<h2></h2>
<p>gulp.task 'browser-sync', ['serve'], -&gt;
    browserSync.init({
        proxy: "http://localhost:" + config.app_port
    })</p>
<h2>tasks</h2>
<p>gulp.task 'watch', -&gt;
    gulp.watch config.src_ts, ['ts']</p>
<p>gulp.task('default', ['watch', 'browser-sync']);</p>
<p>typescriptを型安全にする
コンパイラオプションを定義するtsconfig.jsonを生成する(要tsc-1.6以上)。
mongocrud&gt; tsc --init</p>
<p>手で作ってもよし
tsconfig.json
{
    "compilerOptions": {
        "module": "commonjs",
        "target": "es5",
        "noImplicitAny": true,
        "outDir": "build",
        "rootDir": ".",
        "sourceMap": false
    },
    "filesGlob": [
        "./typings/<strong>/*.d.ts",
        "./src/</strong>/*.ts"
    ]
}</p>
<p>VSCodeの場合、tsconfig.jsonを変えたらVSCodeを再起動するべし。
filesGlobは必要で、無いとインテリセンスが遅くなる(Loading…)。
tsタスクがtsconfig.jsonを使うようにする。</p>
<h2>gulpfile.coffee</h2>
<p>gulp.task 'ts', -&gt;
  tsconfig = require('tsconfig.json')<br>
  gulp.src config.src_ts
    .pipe $.typescript(tsconfig.compilerOptions).js
    .pipe gulp.dest config.dst_js_dir</p>
<p>tsdを初期化して、node.jsとexpressのtypescript定義を取得する。
mongocrud&gt; tsd init
mongocrud&gt; tsd query node express -rosa install</p>
<p>src/app.ts
/// <reference path="../typings/tsd.d.ts"></reference>
import http = require('http');
import express=require('express');</p>
<p>var port=process.env.port || 3000;
var app=express();
var server=http.createServer(app);</p>
<p>app.get('/', (request, response) =&gt; {
    response.setHeader('content-type', 'text/html');
    response.send('</p>Hello ts');
});
<p>server.listen(port);
console.log('start %d', port);</p>
<p>MongoDBのCRUDを定義する
mongodbをインストールする。
Windowsの場合、MongoDBがデフォルトの”Program Files”にインストールされるとパスにスペースが入って
gulpからの起動時にエスケープと戦う必要が生じるので、
C:\MongoDB</p>
<p>にインストールした。
gulpでmongodbを起動する
mongocrud&gt; npm i sprintf-js -D</p>
<h2>gulpfile.coffee</h2>
<p>MONGO_EXE = 'C:/MongoDB/bin/mongod.exe';</p>
<h2></h2>
<h2>Running mongo</h2>
<h2></h2>
<h2>http://stackoverflow.com/a/28048696/46810</h2>
<p>sprintf = require('sprintf-js').sprintf;
fs = require('fs');
exec = require('child_process').exec;
gulp.task 'mongodb:start', (cb)-&gt;
    command=sprintf('%s --dbpath %s'
        , MONGO_EXE, config.mongo_data);
    if(!fs.existsSync(config.mongo_data))
        fs.mkdirSync(config.mongo_data);
    exec command, (err, stdout, stderr) -&gt;
        console.log(stdout);
        console.log(stderr);
    cb();</p>
<p>app.tsからmongodbにアクセスする
mongocrud&gt; npm install mongodb --save
mongocrud&gt; tsd query mongodb -rosa install</p>
<p>src/app.ts
/// <reference path="../typings/tsd.d.ts"></reference></p>
<p>// mongodb
import mongodb = require('mongodb');
let mongoServer = new mongodb.Server(
    'localhost', 27017
);
let dbHandle = new mongodb.Db(
    'crud', mongoServer, {w: 1}
);
dbHandle.open(()=&gt;{
   console.log("connected to mongoDB"); 
});</p>
<p>// http
import http = require('http');
import express = require('express');
let port = process.env.port || 3000;
let app = express();
let server = http.createServer(app);
app.get('/', (request, response) =&gt; {
    response.setHeader('content-type', 'text/html');
    response.send('</p>Hello ts');
});
<p>server.listen(port);
console.log('start %d', port);</p>
<p>CRUDを定義する
Creating a REST API using Node.js, Express, and MongoDB
を参考に実装。
src/app.tsのデータにアクセスする部分をsrc/mongodb.tsに分離した。
src/app.ts
/// <reference path="../typings/tsd.d.ts"></reference>
import mongocrud = require('./mongocrud');</p>
<p>//
// Express
//
import http = require('http');
import express = require('express');</p>
<p>let port = process.env.port || 3000;
let app = express();
let server = http.createServer(app);</p>
<p>let bodyparser=require('body-parser');
let methodoverride = require('method-override');
let logger = require('connect-logger');
let errorhandler = require('errorhandler');
app
.use(bodyparser())
.use(methodoverride())
.use(logger())
.use(errorhandler({
    dumpExceptioons: true,
    showStack: true
}));</p>
<p>app.get('/', (request, response) =&gt; {
    response.setHeader('content-type', 'text/html');
    response.send('</p>Hello ts');
});
server.listen(port);
<p>// restful
app.all('/api/:obj_type/*', (req, res, next)=&gt;{
   res.contentType('json');
   next(); 
});
app.get('/api/:obj_type', mongocrud.findAll);
app.get('/api/:obj_type/:id', mongocrud.findById);
app.post('/api/:obj_type', mongocrud.add);
app.put('/api/:obj_type/:id', mongocrud.update);
app.delete('/api/:obj_type/:id', mongocrud.del);</p>
<p>// launchded
console.log('start %d', port);</p>
<p>src/mongocrud.ts
/// <reference path="../typings/tsd.d.ts"></reference>
//
// MongoDB
//
import mongodb = require('mongodb');
let mongoServer = new mongodb.Server(
    'localhost', 27017
);
let db = new mongodb.Db(
    'crud', mongoServer, { w: 1 }
);
db.open(() =&gt; {
    console.log("connected to mongoDB");
    populateDB();  <br>
});</p>
<p>//
// CRUD
//
import express = require('express');
export var findById = (req: express.Request, res: express.Response) =&gt; {
    let obj_type = req.params.obj_type;
    let id = req.params.id;
    console.log('Retrieving %s: %s', obj_type, id);
    db.collection(obj_type, (err, collection) =&gt; {
        collection.findOne({ '_id': new mongodb.ObjectID(id) }, (err, item) =&gt; {
            res.send(item);
        });
    });
};</p>
<p>export var findAll = (req: express.Request, res: express.Response) =&gt; {
    let obj_type = req.params.obj_type;
    db.collection(obj_type, (err, collection) =&gt; {
        collection.find().toArray((err, items) =&gt; {
            res.send(items);
        });
    });
};</p>
<p>export var add = (req: express.Request, res: express.Response) =&gt; {
    let obj_type = req.params.obj_type;
    let body = req.body;
    console.log('Adding %s: %s', obj_type, JSON.stringify(body));
    db.collection(obj_type, (err, collection) =&gt; {
        collection.insert(body, { safe: true }, (err, result) =&gt; {
            if (err) {
                res.send({ 'error': 'An error has occurred' });
            } else {
                console.log('Success: ' + JSON.stringify(result[0]));
                res.send(result[0]);
            }
        });
    });
}</p>
<p>export var update = (req: express.Request, res: express.Response) =&gt; {
    let obj_type = req.params.obj_type;
    let id = req.params.id;
    let body = req.body;
    console.log('Updating %s: %s', obj_type, id);
    console.log(JSON.stringify(body));
    db.collection('wines', (err, collection) =&gt; {
        collection.update({ '_id': new mongodb.ObjectID(id) },
            body, { safe: true }, (err, result) =&gt; {
                if (err) {
                    console.log('Error updating wine: ' + err);
                    res.send({ 'error': 'An error has occurred' });
                } else {
                    console.log('%s document(s) updated', result);
                    res.send(body);
                }
            });
    });
}</p>
<p>export function del(req: express.Request, res: express.Response){
    let obj_type = req.params.obj_type;
    var id = req.params.id;
    console.log('Deleting %s: %s', obj_type, id);
    db.collection(obj_type, (err, collection) =&gt; {
        collection.remove({ '_id': new mongodb.ObjectID(id) },
            { safe: true }, (err, result) =&gt; {
                if (err) {
                    res.send({ 'error': 'An error has occurred - ' + err });
                } else {
                    console.log('%s document(s) deleted', result);
                    res.send(req.body);
                }
            });
    });
}</p>
<p>// Populate database with sample data -- Only used once: the first time the application is started.
// You'd typically not find this code in a real-life app, since the database would already exist.
function populateDB() {
    console.log('populateDB...');</p>
<pre class="code literal-block"><span></span><span class="nt">var</span> <span class="nt">wines</span> <span class="o">=</span> <span class="cp">[</span>
    <span class="p">{</span>
        <span class="nx">name</span><span class="p">:</span> <span class="s2">"CHATEAU DE SAINT COSME"</span><span class="p">,</span>
        <span class="nx">year</span><span class="p">:</span> <span class="s2">"2009"</span><span class="p">,</span>
        <span class="nx">grapes</span><span class="p">:</span> <span class="s2">"Grenache / Syrah"</span><span class="p">,</span>
        <span class="nx">country</span><span class="p">:</span> <span class="s2">"France"</span><span class="p">,</span>
        <span class="nx">region</span><span class="p">:</span> <span class="s2">"Southern Rhone"</span><span class="p">,</span>
        <span class="nx">description</span><span class="p">:</span> <span class="s2">"The aromas of fruit and spice..."</span><span class="p">,</span>
        <span class="nx">picture</span><span class="p">:</span> <span class="s2">"saint_cosme.jpg"</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="nx">name</span><span class="p">:</span> <span class="s2">"LAN RIOJA CRIANZA"</span><span class="p">,</span>
        <span class="nx">year</span><span class="p">:</span> <span class="s2">"2006"</span><span class="p">,</span>
        <span class="nx">grapes</span><span class="p">:</span> <span class="s2">"Tempranillo"</span><span class="p">,</span>
        <span class="nx">country</span><span class="p">:</span> <span class="s2">"Spain"</span><span class="p">,</span>
        <span class="nx">region</span><span class="p">:</span> <span class="s2">"Rioja"</span><span class="p">,</span>
        <span class="nx">description</span><span class="p">:</span> <span class="s2">"A resurgence of interest in boutique vineyards..."</span><span class="p">,</span>
        <span class="nx">picture</span><span class="p">:</span> <span class="s2">"lan_rioja.jpg"</span>
    <span class="p">}</span><span class="cp">]</span><span class="o">;</span>

<span class="nt">db</span><span class="p">.</span><span class="nc">collection</span><span class="o">(</span><span class="s1">'wines'</span><span class="o">,</span> <span class="o">(</span><span class="nt">err</span><span class="o">,</span> <span class="nt">collection</span><span class="o">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="err">collection.find().toArray((err,</span> <span class="err">items)</span> <span class="err">=&gt;</span> <span class="err">{</span>
        <span class="err">if(items.length==0){</span>
            <span class="err">//</span> <span class="err">if</span> <span class="err">empty</span>
            <span class="err">console.log('insert</span> <span class="n">wines</span><span class="p">:</span> <span class="s1">' + JSON.stringify(wines));</span>
<span class="s1">            db.collection('</span><span class="n">wines</span><span class="err">'</span><span class="p">,</span> <span class="nf">function</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="n">collection</span><span class="p">)</span> <span class="err">{</span>
                <span class="n">collection</span><span class="o">.</span><span class="nf">insert</span><span class="p">(</span><span class="n">wines</span><span class="p">,</span> <span class="err">{</span> <span class="n">safe</span><span class="err">:</span> <span class="n">true</span> <span class="err">}</span><span class="p">,</span> <span class="nf">function</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span> <span class="err">{</span> <span class="err">}</span><span class="p">);</span>
            <span class="p">}</span><span class="o">);</span>
        <span class="err">}</span>
    <span class="err">}</span><span class="o">);</span>
<span class="err">}</span><span class="o">);</span>
</pre>

<p>};</p>
<p>ブラウザ向けのGUIを作る
ざっくりレイアウト</p>

<p>
</p>
    <meta charset="UTF-8">
<title>Document</title>
<link rel="stylesheet" href="posts/2015/11/21/mondo_crud/css/style.css">
<script src="posts/2015/11/21/mondo_crud/js/client.js"></script><div class="header">
    <form action="posts/2015/11/21/mondo_crud/select">
        <span class="label">collection name</span>
        <input type="text"><button>Select</button>
    </form>
</div>
<div class="body">
    <div class="left">
        <div class="list">

        </div>
        <form action="posts/2015/11/21/mondo_crud/add">
            <button>Add</button>
        </form>
    </div>
    <div class="right">
        <form>
            <textarea name="detail"></textarea><button>Load</button>
            <button>Save</button>
        </form>
    </div>
</div>
<div class="footer">
    <ul class="log"></ul>
</div>

<p></p>
<ul>
<li>{
margin: 0;
padding: 0;
}</li>
</ul>
<p>html{
    font-size: 62.5%;
}</p>
<p><em>, </em>::before, *::after {
    box-sizing: border-box;
}</p>
<p>.header{
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 64px;
    background-color: #faa;
}
.body{
    position: absolute;
    top: 64px;
    left: 0;
    right: 0;
    bottom: 128px;
    background-color: #afa;
}
.body .left {
    position: absolute;
    left: 0;
    width: 200px;
    top: 0;
    bottom: 0;
    background-color: #282;
}
.body .right {
    position: absolute;
    left: 200px;
    right: 0;
    top: 0;
    bottom: 0;
    background-color: #828; <br>
}
.footer{
    position: absolute;
    left: 0;
    right: 0;
    bottom: 0;
    height: 128px;
    background-color: #aaf;
}</p>
<p>alert('hello');</p>
<p>jqueryを追加
mongocrud&gt; cd client
mongocrud/client&gt; bower init
mongocrud/client&gt; bower install jquery --save</p>
<p>まとまりが無くなってきた。
別のページに整理しなおそう。
あとから、coffee-scriptやtypescritpを導入すると手順としては冗長になりすぎるな。
最初から、NoDemon, Express, BrowserSyync, gulpfile.coffee, typescript, scssの構成にしよう。</p>
</div>
                </div>
            </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/2015/11/20/starting_jade/" class="u-url">Jadeを入れてみる</a></h1>
                <div class="metadata">
                    <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                        ousttrue
                    </span></p>
            <p class="dateline">
            <a href="posts/2015/11/20/starting_jade/" rel="bookmark">
            <time class="published dt-published" datetime="2015-11-20T00:00:00+09:00" itemprop="datePublished" title="2015-11-20 00:00">2015-11-20 00:00</time></a>
            </p>
                </div>
            </header><div class="e-content entry-content">
                    <div>
<p>練習用に入手してきた”HTML5/CSS3 モダンコーディング”を写経しながらjadeを取り入れてみる。
extendでlayoutを共有したかったのでejsからjadeに取り換えてみた。
sassも取り入れようかと思ったが思いとどまった。
どんどん拡大・拡散していくgulp環境なので控えめにしないと手に負えなくなりそうな感じだ。
gulp向けにjade適用plugin(ejs版の改造)を作ってみた。
既にそういうプラグインも存在していそうであるが、
このくらいなら自作した方が早かったり。
jade-applyer.js
var through = require('through2');
var gutil = require('gulp-util');
var fs = require('fs');
var jade = require('jade');</p>
<p>module.exports = function (options, map) {</p>
<pre class="code literal-block"><span></span>options = options || {};
if (!options.filename) {
    throw new gutil.PluginError('jade-applyer', '`filename` required');
}
options.pretty = true;

map = map || {};

return through.obj(function (file, enc, cb) {

    if (file.isStream()) {
        cb(new gutil.PluginError('jade-applyer', 'Streaming not supported'));
        return;
    }

    try {
        //console.log(file.frontMatter);
        var template = fs.readFileSync(options.filename, 'utf-8');
        var data = JSON.parse(JSON.stringify(file.frontMatter || {}));
        if (!file.isNull()) {
            data.page = file.contents.toString();
        }
        for (var key in map) {
            data[key] = map[key];
        }
        file.contents = new Buffer(jade.compile(template, options)(data));
        file.path = gutil.replaceExtension(file.path, ".html");
        this.push(file);
    } catch (err) {
        this.emit('error', new gutil.PluginError('jade-applyer', err));
    }

    cb();
});
</pre>

<p>}</p>
<p>シンタックスハイライトも適用してある程度体裁が整ってきた。</p>
</div>
                </div>
            </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="qiita/gulpdesutateitsukunasaitowosheng-cheng-surugithub-pagesniburoguwozuo-ruxiang-ding/" class="u-url">gulpでスタティックなサイトを生成する(github-pagesにブログを作る想定)</a></h1>
                <div class="metadata">
                    <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                        ousttrue
                    </span></p>
            <p class="dateline">
            <a href="qiita/gulpdesutateitsukunasaitowosheng-cheng-surugithub-pagesniburoguwozuo-ruxiang-ding/" rel="bookmark">
            <time class="published dt-published" datetime="2015-11-15T04:45:49+09:00" itemprop="datePublished" title="2015-11-15 04:45">2015-11-15 04:45</time><span class="updated"> (更新日時
                    <time class="dt-updated" datetime="2015-11-16T04:36:37+09:00" itemprop="dateUpdated" title="2015-11-16 04:36">2015-11-16 04:36</time>)</span>
            </a>
            </p>
                </div>
            </header><div class="e-content entry-content">
                    <p><a href="https://qiita.com/ousttrue/items/7f19291b8cee110a947a">https://qiita.com/ousttrue/items/7f19291b8cee110a947a</a></p>
                </div>
            </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/2015/11/15/websocket_upgrade/" class="u-url">BrowserSyncのws設定を知らなかったせいでWebSocketのUpgradeがうまくいかなくてはまる</a></h1>
                <div class="metadata">
                    <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                        ousttrue
                    </span></p>
            <p class="dateline">
            <a href="posts/2015/11/15/websocket_upgrade/" rel="bookmark">
            <time class="published dt-published" datetime="2015-11-15T00:00:00+09:00" itemprop="datePublished" title="2015-11-15 00:00">2015-11-15 00:00</time></a>
            </p>
                </div>
            </header><div class="e-content entry-content">
                    <div>
<p>前から写経しながら読んでいる
「シングルページWebアプリケーション」がようやく終盤に差し掛かってきた。
Socket.IOで接続するところがあるのだけど、独自にgulpからbrowserSyncを使っていてWebSocketがupgradeできずにはまる。
Firefoxのconsoleにエラーが出て気になる気になる。
gulpfile.js
gulp.task('server', ['nodemon'], function () {
    browser.init(null, {
        proxy: 'http://localhost:7000',
        port: 3000,
        ws: true // &lt;- これが無いとTransportがpollingからupgradeできない
    });
});</p>
<p>なかなか気付けなかった。
その前に、socket.ioのnamespaceの指定でもはまってたのだが・・・。
しかし、この本は実にいい本だ。自分のWebの知識レベルにちょうどあっていて、昨今の技術をキャッチアップして行く足がかりに
すごく役にたった。
この本が提唱する、
mongodb -&gt; node.js + express + socket.IO -&gt; JQuery
な構成をベースにgulpによる開発環境と、typescript、mithril、bootstrapなんかを盛って行く路線で
寄り道しながら修行中。</p>
</div>
                </div>
            </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/2015/11/14/gulp_static_site/" class="u-url">gulpで静的サイト生成その２</a></h1>
                <div class="metadata">
                    <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                        ousttrue
                    </span></p>
            <p class="dateline">
            <a href="posts/2015/11/14/gulp_static_site/" rel="bookmark">
            <time class="published dt-published" datetime="2015-11-14T00:00:00+09:00" itemprop="datePublished" title="2015-11-14 00:00">2015-11-14 00:00</time></a>
            </p>
                </div>
            </header><div class="e-content entry-content">
                    <div>
<p>gulpで静的サイト生成その２
引き続き、サイト生成作業を続行中。見た目は置いておいて(bootstrap入れたけど)機能を優先して作ろう。
「次へ」と「前へ」のリンクを作れば内部リンクは揃う。
gulpは自由度が高いのでなんとでもなるな。
強まったmakeのようで非常にポテンシャルを感じる。
中期的なも目標としてはローカルもしくはLAN内のnode.jsがホストとなるGUIをさくっと作れるようになるというものがあるのだが、
関連項目が多すぎてひたすら拡がっていくのが危険だ。
特に、インターネットで調べながらだと収束せずにひたすら拡散する傾向がある。
anglar, backboneは避けようと思ったのだがmithrilは気になっているし、electronも気になっている。
あと、typescriptもはやめに使いこなしたい。
だいぶgulpがわかってきた
「前へ」と「次へ」は全部のファイルをリストに投入してソートして隣通しのパスを得る必要がある。
一度リストに投入してから前へと次へを処理した後で、再度リストの中身を一個ずつ後ろに渡せばいいじゃない。
ということでやってみたらあっさりできた。
野良プラグインの作り方が分かるとgulp面白いな。
make-toc.js
var through = require('through2');
var gutil = require('gulp-util');
var path = require('path');</p>
<p>module.exports = function (outputFileName, options) {</p>
<pre class="code literal-block"><span></span><span class="nx">options</span> <span class="o">=</span> <span class="nx">options</span> <span class="o">||</span> <span class="p">{};</span>
<span class="kd">var</span> <span class="nx">dest</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">dest</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">filelist</span> <span class="o">=</span> <span class="p">[];</span>

<span class="kd">function</span> <span class="nx">transform</span><span class="p">(</span><span class="nx">file</span><span class="p">,</span> <span class="nx">encoding</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>

    <span class="c1">// ファイルを集める</span>
    <span class="nx">filelist</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">file</span><span class="p">);</span>

    <span class="c1">// callback()は必ず実行</span>
    <span class="nx">callback</span><span class="p">();</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">flush</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">filelist</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

        <span class="c1">// sortすることで日付順に並ぶ</span>
        <span class="nx">filelist</span><span class="p">.</span><span class="nx">sort</span><span class="p">(</span><span class="kd">function</span> <span class="nx">compareNumbers</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">path</span> <span class="o">&lt;</span> <span class="nx">b</span><span class="p">.</span><span class="nx">path</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">});</span>
        <span class="kd">var</span> <span class="nx">file</span> <span class="o">=</span> <span class="nx">filelist</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

        <span class="c1">// 目次</span>
        <span class="kd">var</span> <span class="nx">output_map</span> <span class="o">=</span> <span class="p">{</span>
            <span class="nx">cwd</span>: <span class="kt">file.cwd</span><span class="p">,</span>
            <span class="nx">base</span>: <span class="kt">file.base</span><span class="p">,</span>
            <span class="nx">path</span>: <span class="kt">file.base</span> <span class="o">+</span> <span class="nx">outputFileName</span><span class="p">,</span>
        <span class="p">};</span>
       <span class="c1">// console.log(output_map);</span>
        <span class="kd">var</span> <span class="nx">output</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">gutil</span><span class="p">.</span><span class="nx">File</span><span class="p">(</span><span class="nx">output_map</span><span class="p">);</span>

        <span class="kd">var</span> <span class="nx">html</span> <span class="o">=</span> <span class="s1">'&lt;ul&gt;\n'</span><span class="p">;</span>
        <span class="c1">//console.log(filelist.length);</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">filelist</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">f</span> <span class="o">=</span> <span class="nx">filelist</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
            <span class="kd">var</span> <span class="nx">rel</span> <span class="o">=</span> <span class="nx">dest</span> <span class="o">+</span> <span class="s2">"/"</span> <span class="o">+</span> <span class="nx">f</span><span class="p">.</span><span class="nx">path</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="nx">f</span><span class="p">.</span><span class="nx">base</span><span class="p">.</span><span class="nx">length</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\\/g</span><span class="p">,</span> <span class="s1">'/'</span><span class="p">);</span>
            <span class="c1">//console.log(rel);              </span>
            <span class="nx">html</span> <span class="o">+=</span> <span class="s1">'&lt;li&gt;&lt;a href="'</span> <span class="o">+</span> <span class="nx">rel</span> <span class="o">+</span> <span class="s1">'"&gt;'</span> <span class="o">+</span> <span class="nx">f</span><span class="p">.</span><span class="nx">frontMatter</span><span class="p">.</span><span class="nx">title</span> <span class="o">+</span> <span class="s1">'&lt;/a&gt;&lt;/li&gt;\n'</span><span class="p">;</span>

            <span class="c1">// 各アイテムのfrontMatterにnextとprevを付ける</span>
            <span class="c1">// 降順に並んでいる</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">i</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="c1">// 先頭</span>
                <span class="nx">f</span><span class="p">.</span><span class="nx">frontMatter</span><span class="p">.</span><span class="nx">next</span> <span class="o">=</span> <span class="s2">""</span><span class="p">;</span>
                <span class="nx">f</span><span class="p">.</span><span class="nx">frontMatter</span><span class="p">.</span><span class="nx">prev</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">relative</span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">dirname</span><span class="p">(</span><span class="nx">f</span><span class="p">.</span><span class="nx">path</span><span class="p">),</span> <span class="nx">filelist</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">].</span><span class="nx">path</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\\/g</span><span class="p">,</span> <span class="s1">'/'</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">i</span> <span class="o">===</span> <span class="nx">filelist</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
                <span class="c1">// 終端</span>
                <span class="nx">f</span><span class="p">.</span><span class="nx">frontMatter</span><span class="p">.</span><span class="nx">next</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">relative</span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">dirname</span><span class="p">(</span><span class="nx">f</span><span class="p">.</span><span class="nx">path</span><span class="p">),</span> <span class="nx">filelist</span><span class="p">[</span><span class="nx">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="nx">path</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\\/g</span><span class="p">,</span> <span class="s1">'/'</span><span class="p">);</span>
                <span class="nx">f</span><span class="p">.</span><span class="nx">frontMatter</span><span class="p">.</span><span class="nx">prev</span> <span class="o">=</span> <span class="s2">""</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="p">{</span>
                <span class="nx">f</span><span class="p">.</span><span class="nx">frontMatter</span><span class="p">.</span><span class="nx">next</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">relative</span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">dirname</span><span class="p">(</span><span class="nx">f</span><span class="p">.</span><span class="nx">path</span><span class="p">),</span> <span class="nx">filelist</span><span class="p">[</span><span class="nx">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="nx">path</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\\/g</span><span class="p">,</span> <span class="s1">'/'</span><span class="p">);</span>
                <span class="nx">f</span><span class="p">.</span><span class="nx">frontMatter</span><span class="p">.</span><span class="nx">prev</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">relative</span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">dirname</span><span class="p">(</span><span class="nx">f</span><span class="p">.</span><span class="nx">path</span><span class="p">),</span> <span class="nx">filelist</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">].</span><span class="nx">path</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\\/g</span><span class="p">,</span> <span class="s1">'/'</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="nx">html</span> <span class="o">+=</span> <span class="s1">'&lt;/ul&gt;\n'</span><span class="p">;</span>
        <span class="nx">output</span><span class="p">.</span><span class="nx">contents</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Buffer</span><span class="p">(</span><span class="nx">html</span><span class="p">);</span>

        <span class="c1">// filelistをoutputにくっつける</span>
        <span class="nx">output</span><span class="p">.</span><span class="nx">filelist</span> <span class="o">=</span> <span class="nx">filelist</span><span class="p">;</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">output</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// callback()は必ず実行</span>
    <span class="nx">callback</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">return</span> <span class="nx">through</span><span class="p">.</span><span class="nx">obj</span><span class="p">(</span><span class="nx">transform</span><span class="p">,</span> <span class="nx">flush</span><span class="p">);</span>
</pre>

<p>};</p>
<p>resplit.js
var through = require('through2');
var gutil = require('gulp-util');
var path = require('path');</p>
<p>module.exports = function () {</p>
<pre class="code literal-block"><span></span><span class="kd">function</span> <span class="nx">transform</span><span class="p">(</span><span class="nx">file</span><span class="p">,</span> <span class="nx">encoding</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>

    <span class="c1">// ファイルがnullの場合</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">file</span><span class="p">.</span><span class="nx">isNull</span><span class="p">())</span> <span class="p">{</span>
        <span class="c1">// 次のプラグインに処理を渡すためにthis.push(file)しておく</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">file</span><span class="p">);</span>
        <span class="c1">// callback()は必ず実行</span>
        <span class="k">return</span> <span class="nx">callback</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="c1">// ファイルがstreamの場合（このサンプルプラグインはstreamに対応しない）</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">file</span><span class="p">.</span><span class="nx">isStream</span><span class="p">())</span> <span class="p">{</span>
        <span class="c1">// emit('error')を使って、プラグイン呼び出し側に'error'イベントを発生させる</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">'error'</span><span class="p">,</span> <span class="k">new</span> <span class="nx">gutil</span><span class="p">.</span><span class="nx">PluginError</span><span class="p">(</span><span class="s1">'gulp-diff'</span><span class="p">,</span> <span class="s1">'Streaming not supported'</span><span class="p">));</span>
        <span class="c1">// callback()は必ず実行</span>
        <span class="k">return</span> <span class="nx">callback</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="c1">// do something</span>
    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">file</span><span class="p">.</span><span class="nx">filelist</span><span class="p">){</span>
        <span class="kd">var</span> <span class="nx">output</span><span class="o">=</span><span class="nx">file</span><span class="p">.</span><span class="nx">filelist</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">output</span><span class="p">);</span>           
    <span class="p">}</span>

    <span class="c1">// callback()は必ず実行</span>
    <span class="nx">callback</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">return</span> <span class="nx">through</span><span class="p">.</span><span class="nx">obj</span><span class="p">(</span><span class="nx">transform</span><span class="p">);</span>
</pre>

<p>};</p>
<p>gulfile.js
gulp.task('posts', function () {
    gulp.src(config.posts)
    // frontMatter処理してhtml化する
        .pipe($.frontMatter({ remove: true }))
        .pipe(myFrontmatter())
        .pipe($.markdown())
    // まとめてsortしてメタ情報を付与して目次を出力する
        .pipe(makeToc('index.html', { dest: 'posts' }))
        .pipe(gulp.dest('build'))
    // 再び分解する
        .pipe(resplit())
    // 以降通常
        .pipe($.debug({ title: 'files:' }))
    // テンプレートを適用して
        .pipe(ejsApplyer({ filename: 'templates/page.ejs' }, { root_path: '../../../../' }))
    // 出力
        .pipe(gulp.dest('build/posts'))
    ;
});</p>
</div>
                </div>
            </article>
</div>
    
        <ul class="pager postindexpager clearfix">
<li class="previous"><a href="index-14.html" rel="prev">新しい記事</a></li>
            <li class="next"><a href="index-12.html" rel="next">過去の記事</a></li>
        </ul>
<!--End of body content--><footer id="footer">
            Contents © 2021         <a href="mailto:ousttrue@gmail.com">ousttrue</a> - Powered by         <a href="https://getnikola.com" rel="nofollow">Nikola</a>         
            
            
        </footer>
</div>
</div>


        <script src="assets/js/all-nocdn.js"></script><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element){var i=element.getElementsByTagName('img')[0];return i===undefined?'':i.alt;}});
    </script>
</body>
</html>
