<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article# " lang="ja">
<head>
<meta charset="utf-8">
<meta name="description" content="作業記録">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>三次元日誌 (過去の記事 23ページ目) | 三次元日誌</title>
<link href="assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<link href="https://fonts.googleapis.com/css?family=Playfair+Display:700,900" rel="stylesheet">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" hreflang="ja" href="rss.xml">
<link rel="canonical" href="https://ousttrue.github.io/index-23.html">
<link rel="prev" href="index-24.html" type="text/html">
<link rel="next" href="index-22.html" type="text/html">
<!--[if lt IE 9]><script src="assets/js/html5.js"></script><![endif]-->
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">本文を読み飛ばす</a>

<!-- Header and menu bar -->
<div class="container">
      <header class="blog-header py-3"><div class="row nbb-header align-items-center">
          <div class="col-md-3 col-xs-2 col-sm-2" style="width: auto;">
            <button class="navbar-toggler navbar-light bg-light nbb-navbar-toggler" type="button" data-toggle="collapse" data-target=".bs-nav-collapsible" aria-controls="bs-navbar" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse bs-nav-collapsible bootblog4-search-form-holder">
                
            </div>
        </div>
          <div class="col-md-6 col-xs-10 col-sm-10 bootblog4-brand" style="width: auto;">
            <a class="navbar-brand blog-header-logo text-dark" href=".">

            <span id="blog-title">三次元日誌</span>
        </a>
          </div>
            <div class="col-md-3 justify-content-end align-items-center bs-nav-collapsible collapse flex-collapse bootblog4-right-nav">
            <nav class="navbar navbar-light bg-white"><ul class="navbar-nav bootblog4-right-nav"></ul></nav>
</div>
    </div>
</header><nav class="navbar navbar-expand-md navbar-light bg-white static-top"><div class="collapse navbar-collapse bs-nav-collapsible" id="bs-navbar">
            <ul class="navbar-nav nav-fill d-flex w-100">
<li class="nav-item">
<a href="books" class="nav-link">MemoBooks</a>
                </li>
<li class="nav-item">
<a href="archive.html" class="nav-link">Archives</a>
                </li>
<li class="nav-item">
<a href="categories/index.html" class="nav-link">Tags</a>
                </li>
<li class="nav-item">
<a href="rss.xml" class="nav-link">RSS feed</a>
                </li>
<li class="nav-item">
<a href="about" class="nav-link">About</a>

                
            </li>
</ul>
</div>
<!-- /.navbar-collapse -->
</nav>
</div>

<div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        
        
        
    
        

    
        
    <div class="postindex">
            <article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="github/swigimgui/" class="u-url">SwigImGui</a></h1>
                <div class="metadata">
                    <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                        ousttrue
                    </span></p>
            <p class="dateline">
            <a href="github/swigimgui/" rel="bookmark">
            <time class="published dt-published" datetime="2017-07-30T04:26:14Z" itemprop="datePublished" title="2017-07-30 04:26">2017-07-30 04:26</time><span class="updated"> (更新日時
                    <time class="dt-updated" datetime="2017-08-06T08:43:21Z" itemprop="dateUpdated" title="2017-08-06 08:43">2017-08-06 08:43</time>)</span>
            </a>
            </p>
                </div>
            </header><div class="e-content entry-content">
                    <div>
<p><a href="https://github.com/ousttrue/SwigImGui">https://github.com/ousttrue/SwigImGui</a></p>
<p>imgui swig wrapper</p>
</div>
                </div>
            </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/2017/07/simpleabcviewer/" class="u-url">SimpleAbcViewerをビルドしてみる</a></h1>
                <div class="metadata">
                    <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                        ousttrue
                    </span></p>
            <p class="dateline">
            <a href="posts/2017/07/simpleabcviewer/" rel="bookmark">
            <time class="published dt-published" datetime="2017-07-28T00:00:00+09:00" itemprop="datePublished" title="2017-07-28 00:00">2017-07-28 00:00</time></a>
            </p>
                </div>
            </header><div class="e-content entry-content">
                    <div>
<p>alembic-1.7.1に無かったので、alembic-1.5.8から発掘してビルドしてみた。</p>
<ul>
<li>https://github.com/ousttrue/SimpleAbcViewer</li>
</ul>
<p>CMakeLists.txtを再構成して、ビルド・動作を確認できた。
SimpleAbcViewerが消えたのは、SimpleじゃないAbcViewができて分離したからぽい。</p>
<ul>
<li>https://github.com/alembic/abcview</li>
</ul>
<p>こっちはQt4を使っていてWindowsではシンプルじゃなかったので、ビルドを断念したのであった・・・。
SimpleAbcViewerのAbcOpenGLを読めばAlembicのAPI(読む方)が分かりそう。
書く方は、mmdbridgeを読むのがよさげ。
タコのサンプルを表示。</p>
<ul>
<li>https://code.google.com/archive/p/alembic/downloads?page=2</li>
</ul>
</div>
                </div>
            </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="github/simpleabcviewer/" class="u-url">SimpleAbcViewer</a></h1>
                <div class="metadata">
                    <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                        ousttrue
                    </span></p>
            <p class="dateline">
            <a href="github/simpleabcviewer/" rel="bookmark">
            <time class="published dt-published" datetime="2017-07-27T01:35:55Z" itemprop="datePublished" title="2017-07-27 01:35">2017-07-27 01:35</time><span class="updated"> (更新日時
                    <time class="dt-updated" datetime="2017-07-27T01:36:57Z" itemprop="dateUpdated" title="2017-07-27 01:36">2017-07-27 01:36</time>)</span>
            </a>
            </p>
                </div>
            </header><div class="e-content entry-content">
                    <div>
<p><a href="https://github.com/ousttrue/SimpleAbcViewer">https://github.com/ousttrue/SimpleAbcViewer</a></p>
<p>build SimpleAbcViewer of alembic-1.5.8</p>
</div>
                </div>
            </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/2017/07/cmake_find_package/" class="u-url">cmakeのfind_package</a></h1>
                <div class="metadata">
                    <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                        ousttrue
                    </span></p>
            <p class="dateline">
            <a href="posts/2017/07/cmake_find_package/" rel="bookmark">
            <time class="published dt-published" datetime="2017-07-20T00:00:00+09:00" itemprop="datePublished" title="2017-07-20 00:00">2017-07-20 00:00</time></a>
            </p>
                </div>
            </header><div class="e-content entry-content">
                    <div>
<p>cmakeのFIND_PACKAGEわかりずらいよ。もやもやするものがある。</p>
<p>GLUTの例
検証用に小さい例を作ってみた。</p>
<p>https://stackoverflow.com/questions/9460242/how-to-compile-glut-opengl-project-with-cmake-and-kdevelop-in-linux</p>
<p>これを参考にしたのだけどちょっと手直しした。</p>
<p>ADD_EXECUTABLEの前にINCLUDE_DIRECTORIESする必要がある
OPENGL_INCLUDE_DIRSじゃなくてOPENGL_INCLUDE_DIR
GLUT_INCLUDE_DIRSじゃなくてGLUT_INCLUDE_DIR</p>
<p>Linuxとかだとdistributionがcmakeファイルを管理してたりするかもしれん。
main.cpp</p>
<h2>include <gl></gl>
</h2>
<p>void display(void)
{
}</p>
<p>int main(int argc, char *argv[])
{
    glutInit(&amp;argc, argv);
    glutCreateWindow(argv[0]);
    glutDisplayFunc(display);
    glutMainLoop();
    return 0;
}</p>
<p>CMakeLists.txt
CMAKE_MINIMUM_REQUIRED(VERSION 2.8)
PROJECT(hello)</p>
<p>FIND_PACKAGE(OpenGL REQUIRED)
MESSAGE(STATUS ${OPENGL_LIBRARIES})
MESSAGE(STATUS ${OPENGL_INCLUDE_DIR})</p>
<p>FIND_PACKAGE(GLUT REQUIRED)
MESSAGE(STATUS ${GLUT_LIBRARY})
MESSAGE(STATUS ${GLUT_INCLUDE_DIR})</p>
<p>INCLUDE_DIRECTORIES(
    ${OPENGL_INCLUDE_DIR}
    ${GLUT_INCLUDE_DIR}
    )
ADD_DEFINITIONS(
    -DFREEGLUT_LIB_PRAGMAS=0 # avoid pragma
    )
ADD_EXECUTABLE(hello 
    main.cpp
    )
TARGET_LINK_LIBRARIES(hello
    ${OPENGL_LIBRARIES}
    ${GLUT_LIBRARY}
    )</p>
<p>実行時のメッセージ
-- glu32opengl32
--
-- D:/vcpkg/installed/x64-windows/lib/freeglut.lib
-- D:/vcpkg/installed/x64-windows/include
-- Configuring done
-- Generating done</p>
<p>なぜかvcpkgのfreeglutを発見してくれた。
vcpkgがcmakeの探索パスを追加しているぽい。レジストリとかか？
まず、第1に
FIND_PACKAGEの結果として如何なる変数が増えるのかが分からん。</p>
<p>https://cmake.org/Wiki/CMake:How_To_Find_Libraries#How_package_finding_works</p>
<p>慣例では、下記のようになっている。</p>
<p>_FOUND
_INCLUDE_DIRS or _INCLUDES
_LIBRARIES or _LIBRARIES or _LIBS
_DEFINITIONS</p>
<p>強制じゃなくて規約なので各種表記ブレの余地が危険を醸し出している。
大文字小文字(find_package(glut)に対して${GLUT_FOUND})、複数単数(DIR, DIRS)、短縮(LIBRARIES, LIBS)とか一貫性が。はまりそうだー。
とりあえあず、標準のパッケージに関してはコマンドから問い合わせることができる。</p>
<blockquote>
<p>cmake --help-module OpenGL
FindOpenGL</p>
</blockquote>
<hr>
<p>FindModule for OpenGL and GLU.</p>
<p>IMPORTED Targets
^^^^^^^^^^^^^^^^</p>
<p>This module defines the <code>IMPORTED</code> targets:</p>
<p><code>OpenGL::GL</code>
 Defined if the system has OpenGL.
<code>OpenGL::GLU</code>
 Defined if the system has GLU.</p>
<p>Result Variables
^^^^^^^^^^^^^^^^</p>
<p>This module sets the following variables:</p>
<p><code>OPENGL_FOUND</code>
 True, if the system has OpenGL.
<code>OPENGL_XMESA_FOUND</code>
 True, if the system has XMESA.
<code>OPENGL_GLU_FOUND</code>
 True, if the system has GLU.
<code>OPENGL_INCLUDE_DIR</code>
 Path to the OpenGL include directory.
<code>OPENGL_LIBRARIES</code>
 Paths to the OpenGL and GLU libraries.</p>
<p>If you want to use just GL you can use these values:</p>
<p><code>OPENGL_gl_LIBRARY</code>
 Path to the OpenGL library.
<code>OPENGL_glu_LIBRARY</code>
 Path to the GLU library.</p>
<p>OSX Specific
^^^^^^^^^^^^</p>
<p>On OSX default to using the framework version of OpenGL. People will
have to change the cache values of OPENGL_glu_LIBRARY and
OPENGL_gl_LIBRARY to use OpenGL with X11 on OSX.</p>
<blockquote>
<p>cmake --help-module GLUT
FindGLUT</p>
</blockquote>
<hr>
<p>try to find glut library and include files.</p>
<p>IMPORTED Targets
^^^^^^^^^^^^^^^^</p>
<p>This module defines the <code>IMPORTED</code> targets:</p>
<p><code>GLUT::GLUT</code>
 Defined if the system has GLUT.</p>
<p>Result Variables
^^^^^^^^^^^^^^^^</p>
<p>This module sets the following variables:</p>
<p>::</p>
<p>GLUT_INCLUDE_DIR, where to find GL/glut.h, etc.
 GLUT_LIBRARIES, the libraries to link against
 GLUT_FOUND, If false, do not try to use GLUT.</p>
<p>Also defined, but not for general use are:</p>
<p>::</p>
<p>GLUT_glut_LIBRARY = the full path to the glut library.
 GLUT_Xmu_LIBRARY  = the full path to the Xmu library.
 GLUT_Xi_LIBRARY   = the full path to the Xi Library.</p>
<p>という感じでcmakeに最初から入っているタイプのモジュールはわかる。
ちなみにFIND_PACKAGEの引数は大文字小文字を区別しないが、結果はただの変数なので区別することに注意。
${OPENGL_GL_LIBRARY}とかだめですから。
不安があるときはMESSAGEでプリントデバッグするのが手堅い。
MESSAGE(STATUS ${OPENGL_gl_LIBRARY})</p>
<p>VisualStudioなのでリンクをDebug, Releaseで振り分けたいんだけど
lib/freeglut.libとdebug/lib/freeglutd.libとか。
上の例は問答無用でRelease版にリンクされる(glutの場合は、別にfreeglutのデバッグはしないのでそれはそれでよかったりもするが・・・)。プラグマでリンクすればいいやんとなるのだが、link_directoriesにはDebug, Releaseの振り分けはない。Release決め打ちの方がましである。
TARGET_LINK_LIBRARIESには振り分け機能が実装されている。
TARGET_LINK_LIBRARIES(hello
    debug path_to_freeglutd.lib
    optimized path_to_freeglut.lib
    )</p>
<p>という風に記述できる。で、これを如何にしてFIND_PACKAGEと連携させるのか。
例としてfreeglut.libとfreeglutd.lib。
FIND_PACKAGE(OpenGL REQUIRED)
MESSAGE(STATUS ${OPENGL_LIBRARIES})
FIND_PACKAGE(GLUT)
MESSAGE(STATUS ${GLUT_LIBRARY})
STRING(REPLACE lib/freeglut.lib debug/lib/freeglutd.lib GLUT_LIBRARY_DEBUG ${GLUT_LIBRARY})
SET(OPENGL_LIBS 
    general ${OPENGL_LIBRARIES} 
    optimized ${GLUT_LIBRARY} 
    debug ${GLUT_LIBRARY_DEBUG}
    )
TARGET_LINK_LIBRARIES(hello
    ${OPENGL_LIBS}
    )</p>
<p>インストールしたパッケージがFindされないんだけど
alembicなどvcpkgでインストールしたパッケージをVCPKG_DIR/installed/x64-windowsから探索して欲しいのだが方法がよくわからない。</p>
<p>CMakeを使ってみた (7) find_packageとpkg_check_modulesによるライブラリ探索</p>
<p>あとで</p>
</div>
                </div>
            </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/2017/07/vcpkg_alembic/" class="u-url">vcpkgのAlembicパッケージ(USE_HDF5)を作ってみる</a></h1>
                <div class="metadata">
                    <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                        ousttrue
                    </span></p>
            <p class="dateline">
            <a href="posts/2017/07/vcpkg_alembic/" rel="bookmark">
            <time class="published dt-published" datetime="2017-07-18T00:00:00+09:00" itemprop="datePublished" title="2017-07-18 00:00">2017-07-18 00:00</time></a>
            </p>
                </div>
            </header><div class="e-content entry-content">
                    <div>
<p>mmdbridgeのvcpkgを使ったビルド手順を作ったついでにAlembicのvcpkg向けパッケージを作ってみる。</p>
<p>情報収集</p>
<ul>
<li>https://github.com/Microsoft/vcpkg/blob/master/docs/examples/packaging-zlib.md</li>
</ul>
<p>読んだ。</p>
<p><code>vcpkg create url</code> で雛形が作れる。</p>
<p>実験</p>
<pre class="code literal-block"><span></span>.<span class="se">\v</span>cpkg.exe create alembic https://github.com/alembic/alembic/archive/1.7.1.tar.gz
CMake Error at scripts/ports.cmake:101 <span class="o">(</span>message<span class="o">)</span>:
  Portfile already exists: <span class="s1">'D:\vcpkg\ports\alembic\portfile.cmake'</span>
</pre>

<p>すでにあるだと！？
最近できたらしい。</p>
<ul>
<li>https://github.com/Microsoft/vcpkg/tree/master/ports/alembic</li>
</ul>
<p>しかし、hdf非対応みたいなので作ってみる。</p>
<pre class="code literal-block"><span></span>.<span class="se">\v</span>cpkg.exe create alembic-hdf https://github.com/alembic/alembic/archive/1.7.1.tar.gz

VCPKG_DIR
    ports
        alembic-hdf
            CONTROL
            portfile.cmake
</pre>

<p>ができた。
簡単なCONTROLから。
こっちはパッケージ情報を決めるだけなのでさくっと。</p>
<pre class="code literal-block"><span></span>Source: alembic-hdf
Version: <span class="m">1</span>.7.1
Description: alembic with hdf5
Build-Depends: hdf5
</pre>

<p>本題のportfile.cmake。
そのままだとエラーになるの。最低限以下が必要なようだ。
アーカイブを展開パスの指定。</p>
<pre class="code literal-block"><span></span><span class="nb">set</span><span class="p">(</span><span class="s">SOURCE_PATH</span> <span class="o">${</span><span class="nv">CURRENT_BUILDTREES_DIR</span><span class="o">}</span><span class="s">/src/1.7.1</span><span class="p">)</span>

<span class="c"># ↓ 修正する</span>

<span class="nb">set</span><span class="p">(</span><span class="s">SOURCE_PATH</span> <span class="o">${</span><span class="nv">CURRENT_BUILDTREES_DIR</span><span class="o">}</span><span class="s">/src/alembic-1.7.1</span><span class="p">)</span>
</pre>

<p>実行してみる。</p>
<pre class="code literal-block"><span></span>&gt; ./vcpkg install alembic-hdf:x64-windows
The following packages will be built and installed:
    alembic-hdf:x64-windows
Building package alembic-hdf:x64-windows...
-- <span class="nv">CURRENT_INSTALLED_DIR</span><span class="o">=</span>D:/vcpkg/installed/x64-windows
-- <span class="nv">DOWNLOADS</span><span class="o">=</span>D:/vcpkg/downloads
-- <span class="nv">CURRENT_PACKAGES_DIR</span><span class="o">=</span>D:/vcpkg/packages/alembic-hdf_x64-windows
-- <span class="nv">CURRENT_BUILDTREES_DIR</span><span class="o">=</span>D:/vcpkg/buildtrees/alembic-hdf
-- <span class="nv">CURRENT_PORT_DIR</span><span class="o">=</span>D:/vcpkg/ports/alembic-hdf/.
-- Using cached D:/vcpkg/downloads/1.7.1.tar.gz
-- Testing integrity of cached file...
-- Testing integrity of cached file... OK
-- Extracting <span class="k">done</span>
-- Configuring x64-windows-rel
-- Configuring x64-windows-rel <span class="k">done</span>
-- Configuring x64-windows-dbg
PS D:<span class="se">\v</span>cpkg&gt; .<span class="se">\v</span>cpkg.exe install alembic-hdf:x64-windows
The following packages will be built and installed:
    alembic-hdf:x64-windows
Building package alembic-hdf:x64-windows...
-- <span class="nv">CURRENT_INSTALLED_DIR</span><span class="o">=</span>D:/vcpkg/installed/x64-windows
-- <span class="nv">DOWNLOADS</span><span class="o">=</span>D:/vcpkg/downloads
-- <span class="nv">CURRENT_PACKAGES_DIR</span><span class="o">=</span>D:/vcpkg/packages/alembic-hdf_x64-windows
-- <span class="nv">CURRENT_BUILDTREES_DIR</span><span class="o">=</span>D:/vcpkg/buildtrees/alembic-hdf
-- <span class="nv">CURRENT_PORT_DIR</span><span class="o">=</span>D:/vcpkg/ports/alembic-hdf/.
-- Using cached D:/vcpkg/downloads/1.7.1.tar.gz
-- Testing integrity of cached file...
-- Testing integrity of cached file... OK
-- Extracting <span class="k">done</span>
-- Configuring x64-windows-rel
-- Configuring x64-windows-rel <span class="k">done</span>
-- Configuring x64-windows-dbg
-- Configuring x64-windows-dbg <span class="k">done</span>
-- Package x64-windows-rel
-- Package x64-windows-rel <span class="k">done</span>
-- Package x64-windows-dbg
-- Package x64-windows-dbg <span class="k">done</span>
-- Performing post-build validation
Include files should not be duplicated into the /debug/include directory. If this cannot be disabled in the project cmake, use
    file<span class="o">(</span>REMOVE_RECURSE <span class="si">${</span><span class="nv">CURRENT_PACKAGES_DIR</span><span class="si">}</span>/debug/include<span class="o">)</span>
The /lib/cmake folder should be merged with /debug/lib/cmake and moved to /share/alembic-hdf/cmake.
The following cmake files were found outside /share/alembic-hdf. Please place cmake files in /share/alembic-hdf.

    D:/vcpkg/packages/alembic-hdf_x64-windows/lib/cmake/Alembic/AlembicConfig.cmake
    D:/vcpkg/packages/alembic-hdf_x64-windows/lib/cmake/Alembic/AlembicConfigVersion.cmake
    D:/vcpkg/packages/alembic-hdf_x64-windows/lib/cmake/Alembic/AlembicTargets-release.cmake
    D:/vcpkg/packages/alembic-hdf_x64-windows/lib/cmake/Alembic/AlembicTargets.cmake
    D:/vcpkg/packages/alembic-hdf_x64-windows/debug/lib/cmake/Alembic/AlembicConfig.cmake
    D:/vcpkg/packages/alembic-hdf_x64-windows/debug/lib/cmake/Alembic/AlembicConfigVersion.cmake
    D:/vcpkg/packages/alembic-hdf_x64-windows/debug/lib/cmake/Alembic/AlembicTargets-debug.cmake
    D:/vcpkg/packages/alembic-hdf_x64-windows/debug/lib/cmake/Alembic/AlembicTargets.cmake

The /debug/lib/cmake folder should be merged with /lib/cmake into /share/alembic-hdf

The following dlls were found in /lib or /debug/lib. Please move them to /bin or /debug/bin, respectively.

    D:/vcpkg/packages/alembic-hdf_x64-windows/lib/Alembic.dll


The following dlls were found in /lib or /debug/lib. Please move them to /bin or /debug/bin, respectively.

    D:/vcpkg/packages/alembic-hdf_x64-windows/debug/lib/Alembic.dll

The software license must be available at <span class="si">${</span><span class="nv">CURRENT_PACKAGES_DIR</span><span class="si">}</span>/share/alembic-hdf/copyright

    file<span class="o">(</span>COPY <span class="si">${</span><span class="nv">CURRENT_BUILDTREES_DIR</span><span class="si">}</span>/src/alembic-1.7.1/LICENSE.txt DESTINATION <span class="si">${</span><span class="nv">CURRENT_PACKAGES_DIR</span><span class="si">}</span>/share/alembic-hdf<span class="o">)</span>
    file<span class="o">(</span>RENAME <span class="si">${</span><span class="nv">CURRENT_PACKAGES_DIR</span><span class="si">}</span>/share/alembic-hdf/LICENSE.txt <span class="si">${</span><span class="nv">CURRENT_PACKAGES_DIR</span><span class="si">}</span>/share/alembic-hdf/copyright<span class="o">)</span>
The following EXEs were found in /bin or /debug/bin. EXEs are not valid distribution targets.

    D:/vcpkg/packages/alembic-hdf_x64-windows/bin/abcdiff.exe
    D:/vcpkg/packages/alembic-hdf_x64-windows/bin/abcecho.exe
    D:/vcpkg/packages/alembic-hdf_x64-windows/bin/abcechobounds.exe
    D:/vcpkg/packages/alembic-hdf_x64-windows/bin/abcls.exe
    D:/vcpkg/packages/alembic-hdf_x64-windows/bin/abcstitcher.exe
    D:/vcpkg/packages/alembic-hdf_x64-windows/bin/abctree.exe

The following EXEs were found in /bin or /debug/bin. EXEs are not valid distribution targets.

    D:/vcpkg/packages/alembic-hdf_x64-windows/debug/bin/abcdiff.exe
    D:/vcpkg/packages/alembic-hdf_x64-windows/debug/bin/abcecho.exe
    D:/vcpkg/packages/alembic-hdf_x64-windows/debug/bin/abcechobounds.exe
    D:/vcpkg/packages/alembic-hdf_x64-windows/debug/bin/abcls.exe
    D:/vcpkg/packages/alembic-hdf_x64-windows/debug/bin/abcstitcher.exe
    D:/vcpkg/packages/alembic-hdf_x64-windows/debug/bin/abctree.exe

Found <span class="m">9</span> error<span class="o">(</span>s<span class="o">)</span>. Please correct the portfile:
    D:<span class="se">\v</span>cpkg<span class="se">\p</span>orts<span class="se">\a</span>lembic-hdf<span class="se">\p</span>ortfile.cmake
-- Performing post-build validation <span class="k">done</span>
Error: Building package alembic-hdf:x64-windows failed with: POST_BUILD_CHECKS_FAILED
Please ensure you<span class="err">'</span>re using the latest portfiles with <span class="sb">`</span>.<span class="se">\v</span>cpkg update<span class="sb">`</span>, <span class="k">then</span>
submit an issue at https://github.com/Microsoft/vcpkg/issues including:
  Package: alembic-hdf:x64-windows
  Vcpkg version: <span class="m">0</span>.0.81-144d3718c4197b101c7d61ee6a258200371fb1ab

Additionally, attach any relevant sections from the log files above.
</pre>

<p>という感じになった。
エラーメッセージがすごく親切。
あと、NINJAビルド速い。
エラーにはなるがビルド結果は以下のように出力された。</p>
<pre class="code literal-block"><span></span>VCPKG_DIR/packages/alembic-hdf_x64-windows
│  BUILD_INFO
│
├─bin
│      abcdiff.exe
│      abcecho.exe
│      abcechobounds.exe
│      abcls.exe
│      abcstitcher.exe
│      abctree.exe
│
├─debug
│  ├─bin
│  │      abcdiff.exe
│  │      abcecho.exe
│  │      abcechobounds.exe
│  │      abcls.exe
│  │      abcstitcher.exe
│  │      abctree.exe
│  │
│  ├─include
│  │  └─Alembic
│  │      ├─Abc
│  │      │      *.h
│  │      │
│  │      ├─AbcCollection
│  │      │      *.h
│  │      │
│  │      ├─AbcCoreAbstract
│  │      │      *.h
│  │      │
│  │      ├─AbcCoreFactory
│  │      │      *.h
│  │      │
│  │      ├─AbcCoreLayer
│  │      │      *.h
│  │      │
│  │      ├─AbcCoreOgawa
│  │      │      *.h
│  │      │
│  │      ├─AbcGeom
│  │      │      *.h
│  │      │
│  │      ├─AbcMaterial
│  │      │      *.h
│  │      │
│  │      └─Util
│  │              *.h
│  │
│  └─lib
│      │  Alembic.dll
│      │  Alembic.lib
│      │
│      └─cmake
│          └─Alembic
│                  AlembicConfig.cmake
│                  AlembicConfigVersion.cmake
│                  AlembicTargets-debug.cmake
│                  AlembicTargets.cmake
│
├─include
│  └─Alembic
│      ├─Abc
│      │      *.h
│      │
│      ├─AbcCollection
│      │      *.h
│      │
│      ├─AbcCoreAbstract
│      │      *.h
│      │
│      ├─AbcCoreFactory
│      │      *.h
│      │
│      ├─AbcCoreLayer
│      │      *.h
│      │
│      ├─AbcCoreOgawa
│      │      *.h
│      │
│      ├─AbcGeom
│      │      *.h
│      │
│      ├─AbcMaterial
│      │      *.h
│      │
│      └─Util
│              *.h
│
└─lib
    │  Alembic.dll
    │  Alembic.lib
    │
    └─cmake
        └─Alembic
                AlembicConfig.cmake
                AlembicConfigVersion.cmake
                AlembicTargets-release.cmake
                AlembicTargets.cmake
</pre>

<p>ここから不要なものを削除したり、場所の違うものを移動したりすることで完成できそう。
エラーメッセージに沿って修正してみる</p>
<p><code>debug/include</code> 不要</p>
<p>エラーメッセージに含まれるとおりに。</p>
<pre class="code literal-block"><span></span><span class="nb">file</span><span class="p">(</span><span class="s">REMOVE_RECURSE</span> <span class="o">${</span><span class="nv">CURRENT_PACKAGES_DIR</span><span class="o">}</span><span class="s">/debug/include</span><span class="p">)</span>

<span class="err">lib/cmake/Alembic/*.cmakeをshare/alembic-hdfに移動するべし</span>
<span class="err">debug/lib/cmake/Alembicを統合するべし。</span>
<span class="nb">vcpkg_fixup_cmake_targets</span><span class="p">(</span><span class="s">CONFIG_PATH</span> <span class="s2">"lib/cmake/Alembic"</span><span class="p">)</span>
</pre>

<p>ぽい。 <code>alembic/portfile.cmake</code> を参考にした</p>
<pre class="code literal-block"><span></span><span class="err">lib/Alembic.dllをbin/Alembic.dllに移動せよ</span>
<span class="err">debug/lib/Alembic.dllも。</span>
<span class="nb">file</span><span class="p">(</span><span class="s">RENAME</span> <span class="o">${</span><span class="nv">CURRENT_PACKAGES_DIR</span><span class="o">}</span><span class="s">/lib/Alembic.dll</span> <span class="o">${</span><span class="nv">CURRENT_PACKAGES_DIR</span><span class="o">}</span><span class="s">/bin/Alembic.dll</span><span class="p">)</span>
<span class="nb">file</span><span class="p">(</span><span class="s">RENAME</span> <span class="o">${</span><span class="nv">CURRENT_PACKAGES_DIR</span><span class="o">}</span><span class="s">/debug/lib/Alembic.dll</span> <span class="o">${</span><span class="nv">CURRENT_PACKAGES_DIR</span><span class="o">}</span><span class="s">/debug/bin/Alembic.dll</span><span class="p">)</span>
</pre>

<p><code>alembic/portfile.cmake</code> を参考にした</p>
<p>ライセンスファイルをコピーせよ
エラーメッセージに含まれるとおりに。</p>
<pre class="code literal-block"><span></span><span class="nb">file</span><span class="p">(</span><span class="s">COPY</span> <span class="o">${</span><span class="nv">CURRENT_BUILDTREES_DIR</span><span class="o">}</span><span class="s">/src/alembic-1.7.1/LICENSE.txt</span> <span class="s">DESTINATION</span> <span class="o">${</span><span class="nv">CURRENT_PACKAGES_DIR</span><span class="o">}</span><span class="s">/share/alembic-hdf</span><span class="p">)</span>
<span class="nb">file</span><span class="p">(</span><span class="s">RENAME</span> <span class="o">${</span><span class="nv">CURRENT_PACKAGES_DIR</span><span class="o">}</span><span class="s">/share/alembic-hdf/LICENSE.txt</span> <span class="o">${</span><span class="nv">CURRENT_PACKAGES_DIR</span><span class="o">}</span><span class="s">/share/alembic-hdf/copyright</span><span class="p">)</span>
</pre>

<p>exeを削除せよ</p>
<pre class="code literal-block"><span></span><span class="nb">file</span><span class="p">(</span><span class="s">GLOB</span> <span class="s">EXE</span> <span class="o">${</span><span class="nv">CURRENT_PACKAGES_DIR</span><span class="o">}</span><span class="s">/bin/*.exe</span><span class="p">)</span>
<span class="nb">file</span><span class="p">(</span><span class="s">GLOB</span> <span class="s">DEBUG_EXE</span> <span class="o">${</span><span class="nv">CURRENT_PACKAGES_DIR</span><span class="o">}</span><span class="s">/debug/bin/*.exe</span><span class="p">)</span>
<span class="nb">file</span><span class="p">(</span><span class="s">REMOVE</span> <span class="o">${</span><span class="nv">EXE</span><span class="o">}</span><span class="p">)</span>
<span class="nb">file</span><span class="p">(</span><span class="s">REMOVE</span> <span class="o">${</span><span class="nv">DEBUG_EXE</span><span class="o">}</span><span class="p">)</span>
</pre>

<p>alembic/portfile.cmakeを参考にした
おまけ: debug用にpdbをコピー
alembic/portfile.cmakeを参考にした
vcpkg_copy_pdbs()</p>
<p>vcpkg_install_cmakeより下を抜粋。</p>
<pre class="code literal-block"><span></span><span class="nb">vcpkg_install_cmake</span><span class="p">()</span>

<span class="c"># Remove debug/include</span>
<span class="nb">file</span><span class="p">(</span><span class="s">REMOVE_RECURSE</span> <span class="o">${</span><span class="nv">CURRENT_PACKAGES_DIR</span><span class="o">}</span><span class="s">/debug/include</span><span class="p">)</span>
<span class="c"># fix *.cmake</span>
<span class="nb">vcpkg_fixup_cmake_targets</span><span class="p">(</span><span class="s">CONFIG_PATH</span> <span class="s2">"lib/cmake/Alembic"</span><span class="p">)</span>
<span class="c"># Rename dll</span>
<span class="nb">file</span><span class="p">(</span><span class="s">RENAME</span> <span class="o">${</span><span class="nv">CURRENT_PACKAGES_DIR</span><span class="o">}</span><span class="s">/lib/Alembic.dll</span> <span class="o">${</span><span class="nv">CURRENT_PACKAGES_DIR</span><span class="o">}</span><span class="s">/bin/Alembic.dll</span><span class="p">)</span>
<span class="nb">file</span><span class="p">(</span><span class="s">RENAME</span> <span class="o">${</span><span class="nv">CURRENT_PACKAGES_DIR</span><span class="o">}</span><span class="s">/debug/lib/Alembic.dll</span> <span class="o">${</span><span class="nv">CURRENT_PACKAGES_DIR</span><span class="o">}</span><span class="s">/debug/bin/Alembic.dll</span><span class="p">)</span>
<span class="c"># Handle copyright</span>
<span class="nb">file</span><span class="p">(</span><span class="s">COPY</span> <span class="o">${</span><span class="nv">CURRENT_BUILDTREES_DIR</span><span class="o">}</span><span class="s">/src/alembic-1.7.1/LICENSE.txt</span> <span class="s">DESTINATION</span> <span class="o">${</span><span class="nv">CURRENT_PACKAGES_DIR</span><span class="o">}</span><span class="s">/share/alembic-hdf</span><span class="p">)</span>
<span class="nb">file</span><span class="p">(</span><span class="s">RENAME</span> <span class="o">${</span><span class="nv">CURRENT_PACKAGES_DIR</span><span class="o">}</span><span class="s">/share/alembic-hdf/LICENSE.txt</span> <span class="o">${</span><span class="nv">CURRENT_PACKAGES_DIR</span><span class="o">}</span><span class="s">/share/alembic-hdf/copyright</span><span class="p">)</span>
<span class="c"># Remove exe files</span>
<span class="nb">file</span><span class="p">(</span><span class="s">GLOB</span> <span class="s">EXE</span> <span class="o">${</span><span class="nv">CURRENT_PACKAGES_DIR</span><span class="o">}</span><span class="s">/bin/*.exe</span><span class="p">)</span>
<span class="nb">file</span><span class="p">(</span><span class="s">GLOB</span> <span class="s">DEBUG_EXE</span> <span class="o">${</span><span class="nv">CURRENT_PACKAGES_DIR</span><span class="o">}</span><span class="s">/debug/bin/*.exe</span><span class="p">)</span>
<span class="nb">file</span><span class="p">(</span><span class="s">REMOVE</span> <span class="o">${</span><span class="nv">EXE</span><span class="o">}</span><span class="p">)</span>
<span class="nb">file</span><span class="p">(</span><span class="s">REMOVE</span> <span class="o">${</span><span class="nv">DEBUG_EXE</span><span class="o">}</span><span class="p">)</span>
<span class="c"># Copy pdb</span>
<span class="nb">vcpkg_copy_pdbs</span><span class="p">()</span>
</pre>

<p>再度ビルド。</p>
<p><code>&gt; vcpkg install alembic-hdf:x64-windows</code></p>
<p>うまくいった。
USE_HDF5を有効にする
portfileの修正
CONTROLに依存追加。
Build-Depends: ilmbase, hdf5</p>
<p>USE_HDF5を有効に。</p>
<pre class="code literal-block"><span></span><span class="nb">vcpkg_configure_cmake</span><span class="p">(</span>
    <span class="s">SOURCE_PATH</span> <span class="o">${</span><span class="nv">SOURCE_PATH</span><span class="o">}</span>
    <span class="s">PREFER_NINJA</span> <span class="c"># Disable this option if project cannot be built with Ninja</span>
    <span class="s">OPTIONS</span> <span class="s">-DUSE_HDF5=ON</span>
    <span class="c"># OPTIONS_RELEASE -DOPTIMIZE=1</span>
    <span class="c"># OPTIONS_DEBUG -DDEBUGGABLE=1</span>
<span class="p">)</span>
</pre>

<p>ビルドあんどエラー
ビルドしてみるがエラーになる。</p>
<p><code>VCPKG_DIR\buildtrees\alembic-hdf\package-x64-windows-rel-out.log</code> を見て原因を探る。</p>
<p>hdf5に対するlinkが無くて、hdf5関連のシンボルが見つからん。
パッチ
alembic-1.7.1/lib/Alembic/CMakeLists.txtを修正したいのでやり方を調べる。
パッチの当て方</p>
<p>portfile.cmakeに記述する。</p>
<pre class="code literal-block"><span></span><span class="err">vcpkg_extract_source_archiveよりあと、vcpkg_install_cmakeより前。</span>
<span class="nb">vcpkg_apply_patches</span><span class="p">(</span>
    <span class="s">SOURCE_PATH</span> <span class="o">${</span><span class="nv">SOURCE_PATH</span><span class="o">}</span>
    <span class="s">PATCHES</span> <span class="o">${</span><span class="nv">CMAKE_CURRENT_LIST_DIR</span><span class="o">}</span><span class="s">/fix-hdf5link.patch</span>
<span class="p">)</span>
</pre>

<p>パッチの作り方</p>
<p>https://github.com/Microsoft/vcpkg/blob/master/docs/examples/patching-libpng.md#patching-the-code-to-improve-compatibility</p>
<p>なるほど。
gitを準備して・・・</p>
<pre class="code literal-block"><span></span>vcpkg&gt; <span class="nb">cd</span> ./buildtrees/alembic-hdf/src/alembic-1.7.1/
vcpkg/buildtrees/alembic-hdf/src/alembic-1.7.1&gt; git init
vcpkg/buildtrees/alembic-hdf/src/alembic-1.7.1&gt; git add .
vcpkg/buildtrees/alembic-hdf/src/alembic-1.7.1&gt; git commit -m <span class="s2">"temp"</span>
</pre>

<p>修正
alembic-1.7.1/lib/Alembic/CMakeLists.txtを修正。</p>
<pre class="code literal-block"><span></span>&gt; git diff
<span class="gd">--git a/lib/Alembic/CMakeLists.txt b/lib/Alembic/CMakeLists.txt</span>
<span class="gh">index 5028c91..1f81d50 100644</span>
<span class="gd">--- a/lib/Alembic/CMakeLists.txt</span>
<span class="gi">+++ b/lib/Alembic/CMakeLists.txt</span>
<span class="gu">@@ -49,6 +49,12 @@ ADD_SUBDIRECTORY(AbcMaterial)</span>
 ADD_SUBDIRECTORY(Ogawa)

 ADD_LIBRARY(Alembic ${LIB_TYPE} ${CXX_FILES})
<span class="gi">+IF (USE_HDF5)</span>
<span class="gi">+    TARGET_LINK_LIBRARIES(Alembic</span>
<span class="gi">+        ${HDF5_LIBRARIES}</span>
<span class="gi">+        )</span>
<span class="gi">+    ADD_DEFINITIONS(-DH5_BUILT_AS_DYNAMIC_LIB)</span>
<span class="gi">+ENDIF()</span>

 TARGET_INCLUDE_DIRECTORIES(Alembic
     PUBLIC
</pre>

<p>gitでpatchを作成</p>
<p><code>&gt; git diff | out-file -enc ascii ..\..\..\..\ports\alembic-hdf\fix-hdf5link.patch</code></p>
<p>ビルド</p>
<pre class="code literal-block"><span></span>&gt; .<span class="se">\v</span>cpkg.exe install alembic-hdf:x64-windows
Installing package alembic-hdf:x64-windows... <span class="k">done</span>
</pre>

<p>VCPKG_DIR/installed/x64-windows/bin/Alembic.dllをdependencywalkerで見てみるとばっちりhdf5.dllへのリンクが含まれている。作業完了。
はじめてで調べながらでもわりとさくさく作業が進んだ。エラーメッセージの出し方とか、フォルダの構成とかvcpkgなかなかレベルが高いな。</p>
<pre class="code literal-block"><span></span>ports
ports/alembic-hdf/CONTROL
Source: alembic-hdf
Version: <span class="m">1</span>.7.1
Description: alembic with hdf5
Build-Depends: ilmbase, hdf5
</pre>

<p>```ports/alembic-hdf/portfile.cmake</p>
<h2>Common Ambient Variables:</h2>
<h2>CURRENT_BUILDTREES_DIR    = ${VCPKG_ROOT_DIR}\buildtrees\${PORT}</h2>
<h2>CURRENT_PACKAGES_DIR      = ${VCPKG_ROOT_DIR}\packages\${PORT}_${TARGET_TRIPLET}</h2>
<h2>CURRENT_PORT_DIR          = ${VCPKG_ROOT_DIR}\ports\${PORT}</h2>
<h2>PORT                      = current port name (zlib, etc)</h2>
<h2>TARGET_TRIPLET            = current triplet (x86-windows, x64-windows-static, etc)</h2>
<h2>VCPKG_CRT_LINKAGE         = C runtime linkage type (static, dynamic)</h2>
<h2>VCPKG_LIBRARY_LINKAGE     = target library linkage type (static, dynamic)</h2>
<h2>VCPKG_ROOT_DIR            = <c:></c:>
</h2>
<h2>VCPKG_TARGET_ARCHITECTURE = target architecture (x64, x86, arm)</h2>
<h2></h2>
<p>include(vcpkg_common_functions)
set(SOURCE_PATH ${CURRENT_BUILDTREES_DIR}/src/alembic-1.7.1)
vcpkg_download_distfile(ARCHIVE
    URLS "https://github.com/alembic/alembic/archive/1.7.1.tar.gz"
    FILENAME "1.7.1.tar.gz"
    SHA512 89e30b681a76eaf79b20ebeff62c495971b0eb64b28f249a14bbcf3bdb40df7eda93b0ede299dd5511bd4587a2cc2d4ebd851fb89bf999fdccc31fee3cffbba2
)
vcpkg_extract_source_archive(${ARCHIVE})</p>
<p>vcpkg_apply_patches(
    SOURCE_PATH ${SOURCE_PATH}
    PATCHES ${CMAKE_CURRENT_LIST_DIR}/fix-hdf5link.patch
)</p>
<p>vcpkg_configure_cmake(
    SOURCE_PATH ${SOURCE_PATH}
    PREFER_NINJA # Disable this option if project cannot be built with Ninja
    OPTIONS -DUSE_HDF5=ON
    # OPTIONS_RELEASE -DOPTIMIZE=1
    # OPTIONS_DEBUG -DDEBUGGABLE=1
)</p>
<p>vcpkg_install_cmake()</p>
<h2>Remove debug/include</h2>
<p>file(REMOVE_RECURSE ${CURRENT_PACKAGES_DIR}/debug/include)</p>
<h2>fix *.cmake</h2>
<p>vcpkg_fixup_cmake_targets(CONFIG_PATH "lib/cmake/Alembic")</p>
<h2>Rename dll</h2>
<p>file(RENAME ${CURRENT_PACKAGES_DIR}/lib/Alembic.dll ${CURRENT_PACKAGES_DIR}/bin/Alembic.dll)
file(RENAME ${CURRENT_PACKAGES_DIR}/debug/lib/Alembic.dll ${CURRENT_PACKAGES_DIR}/debug/bin/Alembic.dll)</p>
<h2>Handle copyright</h2>
<p>file(COPY ${CURRENT_BUILDTREES_DIR}/src/alembic-1.7.1/LICENSE.txt DESTINATION ${CURRENT_PACKAGES_DIR}/share/alembic-hdf)
file(RENAME ${CURRENT_PACKAGES_DIR}/share/alembic-hdf/LICENSE.txt ${CURRENT_PACKAGES_DIR}/share/alembic-hdf/copyright)</p>
<h2>Remove exe files</h2>
<p>file(GLOB EXE ${CURRENT_PACKAGES_DIR}/bin/<em>.exe)
file(GLOB DEBUG_EXE ${CURRENT_PACKAGES_DIR}/debug/bin/</em>.exe)
file(REMOVE ${EXE})
file(REMOVE ${DEBUG_EXE})</p>
<h2>Copy pdb</h2>
<p>vcpkg_copy_pdbs()</p>
<pre class="code literal-block"><span></span>```ports/alembic-hdf/fix-hdf5link.patch
diff --git a/lib/Alembic/CMakeLists.txt b/lib/Alembic/CMakeLists.txt
index 5028c91..1f81d50 100644
--- a/lib/Alembic/CMakeLists.txt
+++ b/lib/Alembic/CMakeLists.txt
@@ -49,6 +49,12 @@ ADD_SUBDIRECTORY(AbcMaterial)
 ADD_SUBDIRECTORY(Ogawa)

 ADD_LIBRARY(Alembic <span class="cp">${</span><span class="n">LIB_TYPE</span><span class="cp">}</span> <span class="cp">${</span><span class="n">CXX_FILES</span><span class="cp">}</span>)
+IF (USE_HDF5)
+    TARGET_LINK_LIBRARIES(Alembic 
+        <span class="cp">${</span><span class="n">HDF5_LIBRARIES</span><span class="cp">}</span>
+        )
+    ADD_DEFINITIONS(-DH5_BUILT_AS_DYNAMIC_LIB)
+ENDIF()

 TARGET_INCLUDE_DIRECTORIES(Alembic
     PUBLIC
</pre>

<p>vcpkgにPR送った
採用されたので上記の作業は必要なくなったのが、cmake-3.9.0の更新でFindHDF5が壊れるという事態が発生したので対応中…。</p>
</div>
                </div>
            </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="github/thinrenderer/" class="u-url">ThinRenderer</a></h1>
                <div class="metadata">
                    <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                        ousttrue
                    </span></p>
            <p class="dateline">
            <a href="github/thinrenderer/" rel="bookmark">
            <time class="published dt-published" datetime="2017-07-11T02:12:16Z" itemprop="datePublished" title="2017-07-11 02:12">2017-07-11 02:12</time><span class="updated"> (更新日時
                    <time class="dt-updated" datetime="2017-07-11T02:12:40Z" itemprop="dateUpdated" title="2017-07-11 02:12">2017-07-11 02:12</time>)</span>
            </a>
            </p>
                </div>
            </header><div class="e-content entry-content">
                    <div>
<p><a href="https://github.com/ousttrue/ThinRenderer">https://github.com/ousttrue/ThinRenderer</a></p>
<p>simple d3d11 renderer</p>
</div>
                </div>
            </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/2017/07/hololens_cpp/" class="u-url">c++でHololens</a></h1>
                <div class="metadata">
                    <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                        ousttrue
                    </span></p>
            <p class="dateline">
            <a href="posts/2017/07/hololens_cpp/" rel="bookmark">
            <time class="published dt-published" datetime="2017-07-09T00:00:00+09:00" itemprop="datePublished" title="2017-07-09 00:00">2017-07-09 00:00</time></a>
            </p>
                </div>
            </header><div class="e-content entry-content">
                    <div>
<p>SharpDXでHololensが頓挫したので、C++でまいりましょう。</p>
<p>VisualStudio2015update3しかUnivsersal cpp HolographicApp templateが含まれないので githubにコピーしておいた。</p>
<p>https://github.com/ousttrue/HolographicApp</p>
<p>エミュレーターで描画が乱れる件</p>
<blockquote>
<blockquote>
<p>(tools)から</p>
</blockquote>
</blockquote>
<p>checkを外したらなおった。
実機
問題ない。
Hololens特有の部分
通常のDirectXとHolographicAppの違いを調べていたのだけれど、
両目レンダリングを効率よくするために、複数のレンダーターゲットに対して
まとめてパイプラインを実行する関連のようだ。
VPAndRTArrayIndexFromAnyShaderFeedingRasterizer
VPAndRTArrayIndexFromAnyShaderFeedingRasterizerないとき(エミュレーター)
// A constant buffer that stores the model transform.
cbuffer ModelConstantBuffer : register(b0)
{
    float4x4 model;
};</p>
<p>// A constant buffer that stores each set of view and projection matrices in column-major format.
cbuffer ViewProjectionConstantBuffer : register(b1)
{
    float4x4 viewProjection[2];
};</p>
<p>// Per-vertex data used as input to the vertex shader.
struct VertexShaderInput
{
    min16float3 pos     : POSITION;
    min16float3 color   : COLOR0;
    uint        instId  : SV_InstanceID;
};</p>
<p>// Per-vertex data passed to the geometry shader.
// Note that the render target array index will be set by the geometry shader
// using the value of viewId.
struct VertexShaderOutput
{
    min16float4 pos     : SV_POSITION;
    min16float3 color   : COLOR0;
    uint        viewId  : TEXCOORD0;  // SV_InstanceID % 2
};</p>
<p>// Simple shader to do vertex processing on the GPU.
VertexShaderOutput main(VertexShaderInput input)
{
    VertexShaderOutput output;
    float4 pos = float4(input.pos, 1.0f);</p>
<pre class="code literal-block"><span></span>// Note which view this vertex has been sent to. Used for matrix lookup.
// Taking the modulo of the instance ID allows geometry instancing to be used
// along with stereo instanced drawing; in that case, two copies of each 
// instance would be drawn, one for left and one for right.
int idx = input.instId % 2;

// Transform the vertex position into world space.
pos = mul(pos, model);

// Correct for perspective and project the vertex position onto the screen.
pos = mul(pos, viewProjection[idx]);
output.pos = (min16float4)pos;

// Pass the color through without modification.
output.color = input.color;

// Set the instance ID. The pass-through geometry shader will set the
// render target array index to whatever value is set here.
output.viewId = idx;

return output;
</pre>

<p>}</p>
<p>// Per-vertex data from the vertex shader.
struct GeometryShaderInput
{
    min16float4 pos     : SV_POSITION;
    min16float3 color   : COLOR0;
    uint        instId  : TEXCOORD0;
};</p>
<p>// Per-vertex data passed to the rasterizer.
struct GeometryShaderOutput
{
    min16float4 pos     : SV_POSITION;
    min16float3 color   : COLOR0;
    uint        rtvId   : SV_RenderTargetArrayIndex; // &lt;- RTVテクスチャアレイのindex
};</p>
<p>// This geometry shader is a pass-through that leaves the geometry unmodified 
// and sets the render target array index.
[maxvertexcount(3)]
void main(triangle GeometryShaderInput input[3], inout TriangleStream<geometryshaderoutput> outStream)
{
    GeometryShaderOutput output;
    [unroll(3)]
    for (int i = 0; i &lt; 3; ++i)
    {
        output.pos   = input[i].pos;
        output.color = input[i].color;
        output.rtvId = input[i].instId;
        outStream.Append(output);
    }
}</geometryshaderoutput></p>
<p>VPAndRTArrayIndexFromAnyShaderFeedingRasterizerあるとき
// A constant buffer that stores the model transform.
cbuffer ModelConstantBuffer : register(b0)
{
    float4x4 model;
};</p>
<p>// A constant buffer that stores each set of view and projection matrices in column-major format.
cbuffer ViewProjectionConstantBuffer : register(b1)
{
    float4x4 viewProjection[2];
};</p>
<p>// Per-vertex data used as input to the vertex shader.
struct VertexShaderInput
{
    min16float3 pos     : POSITION;
    min16float3 color   : COLOR0;
    uint        instId  : SV_InstanceID;
};</p>
<p>// Per-vertex data passed to the geometry shader.
// Note that the render target array index is set here in the vertex shader.
struct VertexShaderOutput
{
    min16float4 pos     : SV_POSITION;
    min16float3 color   : COLOR0;
    uint        rtvId   : SV_RenderTargetArrayIndex; // SV_InstanceID % 2 // &lt;- RTVテクスチャアレイのindex
};</p>
<p>// Simple shader to do vertex processing on the GPU.
VertexShaderOutput main(VertexShaderInput input)
{
    VertexShaderOutput output;
    float4 pos = float4(input.pos, 1.0f);</p>
<pre class="code literal-block"><span></span>// Note which view this vertex has been sent to. Used for matrix lookup.
// Taking the modulo of the instance ID allows geometry instancing to be used
// along with stereo instanced drawing; in that case, two copies of each 
// instance would be drawn, one for left and one for right.
int idx = input.instId % 2;

// Transform the vertex position into world space.
pos = mul(pos, model);

// Correct for perspective and project the vertex position onto the screen.
pos = mul(pos, viewProjection[idx]);
output.pos = (min16float4)pos;

// Pass the color through without modification.
output.color = input.color;

// Set the render target array index.
output.rtvId = idx;

return output;
</pre>

<p>}</p>
<p>どう違うのか
見比べてみたところ、
VPAndRTArrayIndexFromAnyShaderFeedingRasterizer=trueの場合
VertexShaderでSV_RenderTargetArrayIndexを使うことが可能で、
そうでない場合はVertexShaderで使うことができないがGeometryShaderでSV_RenderTargetArrayIndexを使うことが可能ということらしい。
デバッガで確認したところ、実機・エミュレーター共に
backbufferはD3D11_TEXTURE2D_DESC.ArraySize=2となっていた。</p>
<p>https://developer.microsoft.com/en-us/windows/mixed-reality/rendering_in_directx#important_note_about_rendering_on_non-hololens_devices</p>
<p>実機ではVPAndRTArrayIndexFromAnyShaderFeedingRasterizer=true、エミュレーターでfalseでgometryshader版になることがわかった。
SV_RenderTargetArrayIndex</p>
<p>VRのためのステレオレンダリングを高速化するアイデア</p>
<p>なんとなくわかってきた。</p>
<p>ジオメトリシェーダを使用した複数画面描画</p>
<p>SV_ViewportArrayIndexというのもあるらしい。
なるほどー。</p>
<p>セマンティクス (DirectX HLSL)</p>
<p>まとめ
D3D11専用のレンダラを作ってみる。
HololensとUWP兼用のプロジェクトにできそうな気がする。
Hololensの初期化に失敗したら通常のUWPにフォールバックすればよいのではないか。
HoloApp
    Backbuffer
    CameraUpdate
    Input
        |
        v
    +----------+
    |SceneGraph|
    |Renderer  |
    +----------+
        ^
        |
    Input
    CameraUpdate
    Backbuffer
UwpApp</p>
<p>こんな感じのプロジェクトを模索してみよう。</p>
</div>
                </div>
            </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="github/rigidtransformutils/" class="u-url">RigidTransformUtils</a></h1>
                <div class="metadata">
                    <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                        ousttrue
                    </span></p>
            <p class="dateline">
            <a href="github/rigidtransformutils/" rel="bookmark">
            <time class="published dt-published" datetime="2017-07-06T15:43:22Z" itemprop="datePublished" title="2017-07-06 15:43">2017-07-06 15:43</time><span class="updated"> (更新日時
                    <time class="dt-updated" datetime="2017-07-06T16:18:07Z" itemprop="dateUpdated" title="2017-07-06 16:18">2017-07-06 16:18</time>)</span>
            </a>
            </p>
                </div>
            </header><div class="e-content entry-content">
                    <div>
<p><a href="https://github.com/ousttrue/RigidTransformUtils">https://github.com/ousttrue/RigidTransformUtils</a></p>
<p>Helper library of rigid transformation for unity</p>
</div>
                </div>
            </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="github/holographicapp/" class="u-url">HolographicApp</a></h1>
                <div class="metadata">
                    <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                        ousttrue
                    </span></p>
            <p class="dateline">
            <a href="github/holographicapp/" rel="bookmark">
            <time class="published dt-published" datetime="2017-07-04T15:13:14Z" itemprop="datePublished" title="2017-07-04 15:13">2017-07-04 15:13</time><span class="updated"> (更新日時
                    <time class="dt-updated" datetime="2017-07-04T15:16:10Z" itemprop="dateUpdated" title="2017-07-04 15:16">2017-07-04 15:16</time>)</span>
            </a>
            </p>
                </div>
            </header><div class="e-content entry-content">
                    <div>
<p><a href="https://github.com/ousttrue/HolographicApp">https://github.com/ousttrue/HolographicApp</a></p>
<p>visual studio 2015 HolographicApp template as it is</p>
</div>
                </div>
            </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/2017/07/hololens_sharpdx/" class="u-url">SharpDXでHololens</a></h1>
                <div class="metadata">
                    <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                        ousttrue
                    </span></p>
            <p class="dateline">
            <a href="posts/2017/07/hololens_sharpdx/" rel="bookmark">
            <time class="published dt-published" datetime="2017-07-05T00:00:00+09:00" itemprop="datePublished" title="2017-07-05 00:00">2017-07-05 00:00</time></a>
            </p>
                </div>
            </header><div class="e-content entry-content">
                    <div>
<p>SharpDXでHololensできないかやってみる。</p>
<p>頓挫した。
VisualStudioのHolographicAppテンプレートをSharpDXに移植できないかやってみる。
C# Universal 空白のテンプレートで始める
以前書いたUWPでSharpDXを見てSharpDXの最低限を作成。
C++ Universal D3D11のテンプレートを移植する
とりあえず練習に素の”uwp directx11 template”を移植してみた。
これは、D2DのFPSテキストが何も描画されないことを除いて動いた。
C++ HolographicApp DirectXのテンプレートを移植する
途中まで移植したのだが以下の部分でクラッシュして、 エラーコード0xc0000409が解決できなくなってしまった。
// Starts the holographic frame and updates the content.
public Windows.Graphics.Holographic.HolographicFrame Update()
{
    // Before doing the timer update, there is some work to do per-frame
    // to maintain holographic rendering. First, we will get information
    // about the current frame.</p>
<pre class="code literal-block"><span></span>// The HolographicFrame has information that the app needs in order
// to update and render the current frame. The app begins each new
// frame by calling CreateNextFrame.
var holographicFrame = m_holographicSpace.CreateNextFrame(); // &lt;-- クラッシュする

// 省略
</pre>

<p>}</p>
<p>作業は頓挫した。</p>
</div>
                </div>
            </article>
</div>
    
        <ul class="pager postindexpager clearfix">
<li class="previous"><a href="index-24.html" rel="prev">新しい記事</a></li>
            <li class="next"><a href="index-22.html" rel="next">過去の記事</a></li>
        </ul>
<!--End of body content--><footer id="footer">
            Contents © 2021         <a href="mailto:ousttrue@gmail.com">ousttrue</a> - Powered by         <a href="https://getnikola.com" rel="nofollow">Nikola</a>         
            
            
        </footer>
</div>
</div>


        <script src="assets/js/all-nocdn.js"></script><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element){var i=element.getElementsByTagName('img')[0];return i===undefined?'':i.alt;}});
    </script>
</body>
</html>
