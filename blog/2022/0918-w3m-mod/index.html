<!DOCTYPE html>
<html lang="en" class="astro-BVZIHDZO">
	<head>
		<!-- Use Google Fonts, if you don't wanna prefer a self-hosted version --><!-- <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@300;400;500;600;700&display=swap" rel="stylesheet"> --><meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>w3m改造に再突入</title>
<meta name="title" content="w3m改造に再突入">


<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="shortcut icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">

<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="msapplication-config" content="/browserconfig.xml">
<meta name="theme-color" content="#ffffff">

<!-- Open Graph Tags (Facebook) -->
<meta property="og:type" content="website">
<meta property="og:title" content="w3m改造に再突入">




<!-- Twitter -->
<meta property="twitter:card" content="summary_large_image">
<meta property="twitter:title" content="w3m改造に再突入">





<script>
  const theme = (() => {
    if (typeof localStorage !== "undefined" && localStorage.getItem("theme")) {
      return localStorage.getItem("theme");
    }
    if (window.matchMedia("(prefers-color-scheme: dark)").matches) {
      return "dark";
    }
    return "light";
  })();

  if (theme === "light") {
    document.documentElement.classList.remove("dark");
  } else {
    document.documentElement.classList.add("dark");
  }
</script>
		
	<link rel="stylesheet" href="/_astro/about.6111bb3a.css" />
<link rel="stylesheet" href="/_astro/about.657f8f57.css" />
<link rel="stylesheet" href="/_astro/about.ee60a110.css" />
<link rel="stylesheet" href="/_astro/about.dcb84f3d.css" /><script type="module" src="/_astro/hoisted.e6960f2c.js"></script></head>

	<body class="astro-BVZIHDZO">
		<header class="header astro-3EF6KSR2">
    <div class="header__logo astro-3EF6KSR2">
        <a href="/" class="avatar astro-3EF6KSR2">
            <img class="header__logo-img astro-3EF6KSR2" src="/assets/logo.svg" alt="Astro logo">
        </a>
    </div>
    <div class="header__meta flex-1 astro-3EF6KSR2">
        <h3 class="header__title dark:text-theme-dark-secondary astro-3EF6KSR2">
            <a href="" class="astro-3EF6KSR2">三次元日誌(astro)</a>
        </h3>
        <div class="header__meta-more flex astro-3EF6KSR2">
            <p class="header__desc astro-3EF6KSR2">
                Crisp, minimal, personal blog theme for Astro
            </p>
            <nav class="header__nav flex astro-3EF6KSR2">
                <ul class="header__ref-list astro-3EF6KSR2">
                    <li class="astro-3EF6KSR2">
                        <style>astro-island,astro-slot,astro-static-slot{display:contents}</style><script>(()=>{var r=(i,c,n)=>{let s=async()=>{await(await i())()},t=new IntersectionObserver(e=>{for(let o of e)if(o.isIntersecting){t.disconnect(),s();break}});for(let e of n.children)t.observe(e)};(self.Astro||(self.Astro={})).visible=r;window.dispatchEvent(new Event("astro:visible"));})();;(()=>{var d;{let p={0:t=>u(t),1:t=>l(t),2:t=>new RegExp(t),3:t=>new Date(t),4:t=>new Map(l(t)),5:t=>new Set(l(t)),6:t=>BigInt(t),7:t=>new URL(t),8:t=>new Uint8Array(t),9:t=>new Uint16Array(t),10:t=>new Uint32Array(t)},h=t=>{let[e,n]=t;return e in p?p[e](n):void 0},l=t=>t.map(h),u=t=>typeof t!="object"||t===null?t:Object.fromEntries(Object.entries(t).map(([e,n])=>[e,h(n)]));customElements.get("astro-island")||customElements.define("astro-island",(d=class extends HTMLElement{constructor(){super(...arguments);this.hydrate=async()=>{var i;if(!this.hydrator||!this.isConnected)return;let e=(i=this.parentElement)==null?void 0:i.closest("astro-island[ssr]");if(e){e.addEventListener("astro:hydrate",this.hydrate,{once:!0});return}let n=this.querySelectorAll("astro-slot"),o={},a=this.querySelectorAll("template[data-astro-template]");for(let r of a){let s=r.closest(this.tagName);s!=null&&s.isSameNode(this)&&(o[r.getAttribute("data-astro-template")||"default"]=r.innerHTML,r.remove())}for(let r of n){let s=r.closest(this.tagName);s!=null&&s.isSameNode(this)&&(o[r.getAttribute("name")||"default"]=r.innerHTML)}let c;try{c=this.hasAttribute("props")?u(JSON.parse(this.getAttribute("props"))):{}}catch(r){let s=this.getAttribute("component-url")||"<unknown>",y=this.getAttribute("component-export");throw y&&(s+=` (export ${y})`),console.error(`[hydrate] Error parsing props for component ${s}`,this.getAttribute("props"),r),r}await this.hydrator(this)(this.Component,c,o,{client:this.getAttribute("client")}),this.removeAttribute("ssr"),this.dispatchEvent(new CustomEvent("astro:hydrate"))}}connectedCallback(){!this.hasAttribute("await-children")||this.firstChild?this.childrenConnectedCallback():new MutationObserver((e,n)=>{n.disconnect(),setTimeout(()=>this.childrenConnectedCallback(),0)}).observe(this,{childList:!0})}async childrenConnectedCallback(){let e=this.getAttribute("before-hydration-url");e&&await import(e),this.start()}start(){let e=JSON.parse(this.getAttribute("opts")),n=this.getAttribute("client");if(Astro[n]===void 0){window.addEventListener(`astro:${n}`,()=>this.start(),{once:!0});return}Astro[n](async()=>{let o=this.getAttribute("renderer-url"),[a,{default:c}]=await Promise.all([import(this.getAttribute("component-url")),o?import(o):()=>()=>{}]),i=this.getAttribute("component-export")||"default";if(!i.includes("."))this.Component=a[i];else{this.Component=a;for(let r of i.split("."))this.Component=this.Component[r]}return this.hydrator=c,this.hydrate},e,this)}attributeChangedCallback(){this.hydrate()}},d.observedAttributes=["props"],d))}})();</script><astro-island uid="2iKzVC" component-url="/_astro/SearchBtn.984510f3.js" component-export="default" renderer-url="/_astro/client.cb726945.js" props="{&quot;class&quot;:[0,&quot;astro-3EF6KSR2&quot;]}" ssr="" client="visible" opts="{&quot;name&quot;:&quot;SearchBtn&quot;,&quot;value&quot;:true}" await-children=""><button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"> <path fill-rule="evenodd" clip-rule="evenodd" d="M16.2071 4.89344C19.0923 7.77862 19.3131 12.3193 16.8693 15.4578C16.8846 15.4713 16.8996 15.4854 16.9143 15.5L21.1569 19.7427C21.5474 20.1332 21.5474 20.7664 21.1569 21.1569C20.7664 21.5474 20.1332 21.5474 19.7427 21.1569L15.5 16.9143C15.4854 16.8996 15.4713 16.8846 15.4578 16.8693C12.3193 19.3131 7.77862 19.0923 4.89344 16.2071C1.76924 13.083 1.76924 8.01763 4.89344 4.89344C8.01763 1.76924 13.083 1.76924 16.2071 4.89344ZM14.7929 14.7929C17.1361 12.4498 17.1361 8.6508 14.7929 6.30765C12.4498 3.96451 8.6508 3.96451 6.30765 6.30765C3.96451 8.6508 3.96451 12.4498 6.30765 14.7929C8.6508 17.1361 12.4498 17.1361 14.7929 14.7929Z" fill="currentColor"></path></svg></button></astro-island>
                    </li>
                    <li class="astro-3EF6KSR2">
                        <a href="https://github.com/one-aalam/astro-ink" title="三次元日誌(astro)'s Github URL'" class="astro-3EF6KSR2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    
                                <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22" class="astro-3EF6KSR2"></path>
                            
</svg>
                        </a>
                    </li>
                    <li class="astro-3EF6KSR2">
                        <a href="/rss.xml" title="RSS" class="astro-3EF6KSR2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    
                                <path d="M4 11a9 9 0 0 1 9 9" class="astro-3EF6KSR2"></path>
                                <path d="M4 4a16 16 0 0 1 16 16" class="astro-3EF6KSR2"></path>
                                <circle cx="5" cy="19" r="1" class="astro-3EF6KSR2"></circle>
                            
</svg>
                        </a>
                    </li>
                    <li class="astro-3EF6KSR2">
                        <astro-island uid="h8S6z" component-url="/_astro/ModeSwitcherBtn.0ddc5d6d.js" component-export="default" renderer-url="/_astro/client.cb726945.js" props="{&quot;class&quot;:[0,&quot;astro-3EF6KSR2&quot;]}" ssr="" client="visible" opts="{&quot;name&quot;:&quot;ModeSwitcherBtn&quot;,&quot;value&quot;:true}" await-children=""><button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle> <line x1="12" y1="1" x2="12" y2="3"></line> <line x1="12" y1="21" x2="12" y2="23"></line> <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line> <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line> <line x1="1" y1="12" x2="3" y2="12"></line> <line x1="21" y1="12" x2="23" y2="12"></line> <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line> <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg></button></astro-island>
                    </li>
                </ul>
            </nav>
        </div>
    </div>
</header>
		<main class="astro-BVZIHDZO">
			<article class="astro-BVZIHDZO">
				<div class="hero-image astro-BVZIHDZO">
					
				</div>
				<div class="prose astro-BVZIHDZO">
					<div class="title astro-BVZIHDZO">
						<div class="date astro-BVZIHDZO">
							<time datetime="2022-09-18T00:00:00.000Z">
	Sep 18, 2022
</time>
							
						</div>
						<h1 class="astro-BVZIHDZO">w3m改造に再突入</h1>
						<hr class="astro-BVZIHDZO">
					</div>
					
	<h1 id="w3m改造に再突入">w3m改造に再突入</h1>
<p>なんとなく最初からやり直し。</p>
<h2 id="マクロカッター">マクロカッター</h2>
<p>今回は、 <code>python</code> でマクロカッターを作って前処理してみた。</p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #e1e4e8">#ifdef USE_UNICODE</span></span>
<span class="line"><span style="color: #e1e4e8">// hogehoge</span></span>
<span class="line"><span style="color: #e1e4e8">#endif</span></span></code></pre>
<p>みたいな <code>#ifdef</code> 事前に解決しえカットしていくツールである。
めんどくさいので <code>if defined(HOGE)</code> などは実装していない。
<code>true</code>, <code>false</code>, <code>none</code> の3値で判断。
true であれば <code>#if</code> を削除。
false であれば <code>#if</code> ブロックをコードごと削除し。
<code>none</code> であれば保持するというロジック。
わりとうまくいって、コードがかなり簡単になった。</p>
<h2 id="いつも通り-c-化">いつも通り C++ 化</h2>
<p>C++ 化しないとCの暗黙の型変換が緩すぎてコンパイルエラー追うのが難しくなるので、
次の一手はこれ。</p>
<p><code>c++</code> できたら、 <code>typdef struct Some {} Some;</code> を <code>struct Some;</code> に書き換える。
これでストレスをかなり低減できる。</p>
<p>局所性の高い関数をメンバー関数にする。
なるべくメンバーを private にして、名前も <code>_</code> などの prefix を付ける。
大きい struct は分割する。
コンストラクタ、デストラクタ、コピーコンストラクタは避ける。<code>GC</code> や <code>setmem(0)</code> で死ぬ。
同様に、 std::vector, std::string は慎重に導入する。</p>
<h2 id="macro-減らす">macro 減らす</h2>
<p>macro 関数を<code>inline 関数</code> に置き換えたり、
macro 定数を <code>enum</code> に置き換える。int, char などを enum に置き換える。
使えれば <code>bitfield</code> とかも駆使。</p>
<h2 id="fmh-protoh-filec-の分配">fm.h, proto.h, file.c の分配</h2>
<ul>
<li><code>.c</code> と <code>.h</code> をペアにして関数を一致させる</li>
<li><code>struct</code> 毎にヘッダを分ける。</li>
<li><code>global</code> 変数を散らす</li>
<li><code>const char*</code> との戦い。順次</li>
</ul>
<p>膨大な global 変数があるので、使わないもの思い切って削除する。</p>
<h3 id="filec">file.c</h3>
<p><code>file.c</code> が 7000 行とかあってすごい。</p>
<ul>
<li>html のロードが 4500 くらい。 <code>table.c</code>, <code>frame.c</code> も関連？</li>
<li>http を操作が 500 くらい</li>
</ul>
<p>http アクセスや、html パース、ローカルCGI とか Buffer 操作が色々入っている。</p>
<h2 id="libuv">libuv</h2>
<h3 id="mainloop">mainloop</h3>
<p>あっさりできてしまった。</p>
<p><code>tty input</code>, <code>resize signal</code> で <code>idle</code> のときに描画などという方針でよさそう。
raw モード切り替えなども <code>libuv</code> 移行できそう。</p>
<h3 id="入力ストリーム">入力ストリーム</h3>
<p>tcp, fd, FILE*, Str と圧縮 decoder のランタイム polymorphism.
c++ の継承に置き換えて、 <code>void*</code> の cast より、型チェックの聞く状態にできる。</p>
<p>TODO: libuv を使う</p>
<h3 id="linein--readline">linein / readline</h3>
<h3 id="出力">出力</h3>
<h3 id="signal">signal</h3>
<p>読み込みを <code>ctrl-c</code> で中断するなど。</p>
<h2 id="使わない機能を削る">使わない機能を削る</h2>
<ul>
<li>backend, dump など</li>
<li>pager 系の機能</li>
<li>news, gopher など使わないプロトコル</li>
<li>mouse 系の機能</li>
<li>search_header 系の機能</li>
</ul>
<h2 id="wtf-8-とは">wtf-8 とは？</h2>
<p>謎の文字コード <code>wtf-8</code> について、再調査。</p>
<p><a href="https://badsector.pullup.net/?p=70">https://badsector.pullup.net/?p=70</a></p>
<p>👇</p>
<p><a href="https://simonsapin.github.io/wtf-8/">https://simonsapin.github.io/wtf-8/</a></p>
<h2 id="vt100-分離">vt100 分離</h2>
<p><code>Buffer = Screen => tty_out</code> という流れに統一する。
各所からローレベルの描画機能を呼ばない。</p>
<p>メッセージ表示も抽象化して、text を push するだけに。</p>
<ul>
<li>カーソル移動</li>
<li>out</li>
<li>flush</li>
<li>カーソル復帰</li>
</ul>
<p>とかしない。</p>
<h2 id="todo-logger-導入">TODO: logger 導入</h2>
<h2 id="uiとデータ構造の分離">UIとデータ構造の分離</h2>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #e1e4e8">+----+</span></span>
<span class="line"><span style="color: #e1e4e8">|DATA| TabBuffer, Buffer, Anchor, Form, Image...</span></span>
<span class="line"><span style="color: #e1e4e8">+----+</span></span>
<span class="line"><span style="color: #e1e4e8">  A</span></span>
<span class="line"><span style="color: #e1e4e8">  |</span></span>
<span class="line"><span style="color: #e1e4e8">+----+</span></span>
<span class="line"><span style="color: #e1e4e8">| UI | mainloop... tty, key dispatch</span></span>
<span class="line"><span style="color: #e1e4e8">+----+</span></span></code></pre>
<p><code>TabBuffer, Buffer, Anchor, FormList</code> と <code>mainloop keydispatch</code> あたりを分離する。
片方向の参照。</p>
<p>バッファーローダーからグローバル変数を除去して、再入可能にする。
tab を平行動作可能にする。</p>
<h3 id="todo-lua-導入">TODO: lua 導入</h3>
<p>DEFUN を lua で記述したい。
rc も？</p>
<h2 id="todo-libgc-減らす止める">TODO: libgc 減らす。止める</h2>
<h2 id="todo-zig-に移植">TODO: zig に移植</h2>
<p><code>zig cc</code> でビルドはできた。
じゃなくて、ソースを <code>zig</code> にしたい。</p>
<h2 id="todo">TODO</h2>
<p>Windows ネイティブで動くようにしたい。
<code>libuv</code> + <code>conpty</code> できそうな気がするのだけど、まだまだ。</p>

				</div>
			</article>
		</main>
		<footer class="footer astro-SZ7XMLTE">
    <nav class="nav astro-SZ7XMLTE">
        <div class="astro-SZ7XMLTE">2021  &copy; Copyright notice |  <a href="https://github.com/one-aalam/astro-ink" title="三次元日誌(astro)'s Github URL'" class="astro-SZ7XMLTE">三次元日誌(astro)</a>
        <script>(()=>{var e=async t=>{await(await t())()};(self.Astro||(self.Astro={})).load=e;window.dispatchEvent(new Event("astro:load"));})();</script><astro-island uid="1QEdto" component-url="/_astro/ModeLabel.e3ff75e7.js" component-export="default" renderer-url="/_astro/client.cb726945.js" props="{&quot;class&quot;:[0,&quot;astro-SZ7XMLTE&quot;]}" ssr="" client="load" opts="{&quot;name&quot;:&quot;ModeLabel&quot;,&quot;value&quot;:true}" await-children=""><span slot="dark" data-svelte-h="svelte-14ov3lc">(dark)</span></astro-island> theme on <a href="https://astro.build/" class="astro-SZ7XMLTE">Astro</a></div>
        <astro-island uid="1I86to" component-url="/_astro/NetlifyIdentity.94b8edb0.js" component-export="default" renderer-url="/_astro/client.cb726945.js" props="{&quot;class&quot;:[0,&quot;astro-SZ7XMLTE&quot;]}" ssr="" client="load" opts="{&quot;name&quot;:&quot;NetlifyIdentity&quot;,&quot;value&quot;:true}"></astro-island>
    </nav>
</footer>
	</body></html>