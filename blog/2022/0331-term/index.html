<!DOCTYPE html>
<html lang="en" class="astro-BVZIHDZO">
	<head>
		<!-- Use Google Fonts, if you don't wanna prefer a self-hosted version --><!-- <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@300;400;500;600;700&display=swap" rel="stylesheet"> --><meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>term周りの更新</title>
<meta name="title" content="term周りの更新">


<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="shortcut icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">

<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="msapplication-config" content="/browserconfig.xml">
<meta name="theme-color" content="#ffffff">

<!-- Open Graph Tags (Facebook) -->
<meta property="og:type" content="website">
<meta property="og:title" content="term周りの更新">




<!-- Twitter -->
<meta property="twitter:card" content="summary_large_image">
<meta property="twitter:title" content="term周りの更新">





<script>
  const theme = (() => {
    if (typeof localStorage !== "undefined" && localStorage.getItem("theme")) {
      return localStorage.getItem("theme");
    }
    if (window.matchMedia("(prefers-color-scheme: dark)").matches) {
      return "dark";
    }
    return "light";
  })();

  if (theme === "light") {
    document.documentElement.classList.remove("dark");
  } else {
    document.documentElement.classList.add("dark");
  }
</script>
		
	<link rel="stylesheet" href="/_astro/about.6111bb3a.css" />
<link rel="stylesheet" href="/_astro/about.657f8f57.css" />
<link rel="stylesheet" href="/_astro/about.ee60a110.css" />
<link rel="stylesheet" href="/_astro/about.dcb84f3d.css" /><script type="module" src="/_astro/hoisted.e6960f2c.js"></script></head>

	<body class="astro-BVZIHDZO">
		<header class="header astro-3EF6KSR2">
    <div class="header__logo astro-3EF6KSR2">
        <a href="/" class="avatar astro-3EF6KSR2">
            <img class="header__logo-img astro-3EF6KSR2" src="/assets/logo.svg" alt="Astro logo">
        </a>
    </div>
    <div class="header__meta flex-1 astro-3EF6KSR2">
        <h3 class="header__title dark:text-theme-dark-secondary astro-3EF6KSR2">
            <a href="" class="astro-3EF6KSR2">三次元日誌(astro)</a>
        </h3>
        <div class="header__meta-more flex astro-3EF6KSR2">
            <p class="header__desc astro-3EF6KSR2">
                Crisp, minimal, personal blog theme for Astro
            </p>
            <nav class="header__nav flex astro-3EF6KSR2">
                <ul class="header__ref-list astro-3EF6KSR2">
                    <li class="astro-3EF6KSR2">
                        <style>astro-island,astro-slot,astro-static-slot{display:contents}</style><script>(()=>{var r=(i,c,n)=>{let s=async()=>{await(await i())()},t=new IntersectionObserver(e=>{for(let o of e)if(o.isIntersecting){t.disconnect(),s();break}});for(let e of n.children)t.observe(e)};(self.Astro||(self.Astro={})).visible=r;window.dispatchEvent(new Event("astro:visible"));})();;(()=>{var d;{let p={0:t=>u(t),1:t=>l(t),2:t=>new RegExp(t),3:t=>new Date(t),4:t=>new Map(l(t)),5:t=>new Set(l(t)),6:t=>BigInt(t),7:t=>new URL(t),8:t=>new Uint8Array(t),9:t=>new Uint16Array(t),10:t=>new Uint32Array(t)},h=t=>{let[e,n]=t;return e in p?p[e](n):void 0},l=t=>t.map(h),u=t=>typeof t!="object"||t===null?t:Object.fromEntries(Object.entries(t).map(([e,n])=>[e,h(n)]));customElements.get("astro-island")||customElements.define("astro-island",(d=class extends HTMLElement{constructor(){super(...arguments);this.hydrate=async()=>{var i;if(!this.hydrator||!this.isConnected)return;let e=(i=this.parentElement)==null?void 0:i.closest("astro-island[ssr]");if(e){e.addEventListener("astro:hydrate",this.hydrate,{once:!0});return}let n=this.querySelectorAll("astro-slot"),o={},a=this.querySelectorAll("template[data-astro-template]");for(let r of a){let s=r.closest(this.tagName);s!=null&&s.isSameNode(this)&&(o[r.getAttribute("data-astro-template")||"default"]=r.innerHTML,r.remove())}for(let r of n){let s=r.closest(this.tagName);s!=null&&s.isSameNode(this)&&(o[r.getAttribute("name")||"default"]=r.innerHTML)}let c;try{c=this.hasAttribute("props")?u(JSON.parse(this.getAttribute("props"))):{}}catch(r){let s=this.getAttribute("component-url")||"<unknown>",y=this.getAttribute("component-export");throw y&&(s+=` (export ${y})`),console.error(`[hydrate] Error parsing props for component ${s}`,this.getAttribute("props"),r),r}await this.hydrator(this)(this.Component,c,o,{client:this.getAttribute("client")}),this.removeAttribute("ssr"),this.dispatchEvent(new CustomEvent("astro:hydrate"))}}connectedCallback(){!this.hasAttribute("await-children")||this.firstChild?this.childrenConnectedCallback():new MutationObserver((e,n)=>{n.disconnect(),setTimeout(()=>this.childrenConnectedCallback(),0)}).observe(this,{childList:!0})}async childrenConnectedCallback(){let e=this.getAttribute("before-hydration-url");e&&await import(e),this.start()}start(){let e=JSON.parse(this.getAttribute("opts")),n=this.getAttribute("client");if(Astro[n]===void 0){window.addEventListener(`astro:${n}`,()=>this.start(),{once:!0});return}Astro[n](async()=>{let o=this.getAttribute("renderer-url"),[a,{default:c}]=await Promise.all([import(this.getAttribute("component-url")),o?import(o):()=>()=>{}]),i=this.getAttribute("component-export")||"default";if(!i.includes("."))this.Component=a[i];else{this.Component=a;for(let r of i.split("."))this.Component=this.Component[r]}return this.hydrator=c,this.hydrate},e,this)}attributeChangedCallback(){this.hydrate()}},d.observedAttributes=["props"],d))}})();</script><astro-island uid="2iKzVC" component-url="/_astro/SearchBtn.984510f3.js" component-export="default" renderer-url="/_astro/client.cb726945.js" props="{&quot;class&quot;:[0,&quot;astro-3EF6KSR2&quot;]}" ssr="" client="visible" opts="{&quot;name&quot;:&quot;SearchBtn&quot;,&quot;value&quot;:true}" await-children=""><button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"> <path fill-rule="evenodd" clip-rule="evenodd" d="M16.2071 4.89344C19.0923 7.77862 19.3131 12.3193 16.8693 15.4578C16.8846 15.4713 16.8996 15.4854 16.9143 15.5L21.1569 19.7427C21.5474 20.1332 21.5474 20.7664 21.1569 21.1569C20.7664 21.5474 20.1332 21.5474 19.7427 21.1569L15.5 16.9143C15.4854 16.8996 15.4713 16.8846 15.4578 16.8693C12.3193 19.3131 7.77862 19.0923 4.89344 16.2071C1.76924 13.083 1.76924 8.01763 4.89344 4.89344C8.01763 1.76924 13.083 1.76924 16.2071 4.89344ZM14.7929 14.7929C17.1361 12.4498 17.1361 8.6508 14.7929 6.30765C12.4498 3.96451 8.6508 3.96451 6.30765 6.30765C3.96451 8.6508 3.96451 12.4498 6.30765 14.7929C8.6508 17.1361 12.4498 17.1361 14.7929 14.7929Z" fill="currentColor"></path></svg></button></astro-island>
                    </li>
                    <li class="astro-3EF6KSR2">
                        <a href="https://github.com/one-aalam/astro-ink" title="三次元日誌(astro)'s Github URL'" class="astro-3EF6KSR2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    
                                <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22" class="astro-3EF6KSR2"></path>
                            
</svg>
                        </a>
                    </li>
                    <li class="astro-3EF6KSR2">
                        <a href="/rss.xml" title="RSS" class="astro-3EF6KSR2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    
                                <path d="M4 11a9 9 0 0 1 9 9" class="astro-3EF6KSR2"></path>
                                <path d="M4 4a16 16 0 0 1 16 16" class="astro-3EF6KSR2"></path>
                                <circle cx="5" cy="19" r="1" class="astro-3EF6KSR2"></circle>
                            
</svg>
                        </a>
                    </li>
                    <li class="astro-3EF6KSR2">
                        <astro-island uid="h8S6z" component-url="/_astro/ModeSwitcherBtn.0ddc5d6d.js" component-export="default" renderer-url="/_astro/client.cb726945.js" props="{&quot;class&quot;:[0,&quot;astro-3EF6KSR2&quot;]}" ssr="" client="visible" opts="{&quot;name&quot;:&quot;ModeSwitcherBtn&quot;,&quot;value&quot;:true}" await-children=""><button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle> <line x1="12" y1="1" x2="12" y2="3"></line> <line x1="12" y1="21" x2="12" y2="23"></line> <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line> <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line> <line x1="1" y1="12" x2="3" y2="12"></line> <line x1="21" y1="12" x2="23" y2="12"></line> <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line> <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg></button></astro-island>
                    </li>
                </ul>
            </nav>
        </div>
    </div>
</header>
		<main class="astro-BVZIHDZO">
			<article class="astro-BVZIHDZO">
				<div class="hero-image astro-BVZIHDZO">
					
				</div>
				<div class="prose astro-BVZIHDZO">
					<div class="title astro-BVZIHDZO">
						<div class="date astro-BVZIHDZO">
							<time datetime="2022-03-31T00:00:00.000Z">
	Mar 31, 2022
</time>
							
						</div>
						<h1 class="astro-BVZIHDZO">term周りの更新</h1>
						<hr class="astro-BVZIHDZO">
					</div>
					
	<h1 id="term周りの更新">term周りの更新</h1>
<h2 id="terminal-emulator-を選定">terminal emulator を選定・・・</h2>
<p>主に3つの動作環境、<code>Windows</code>, <code>Windows wsl</code>, <code>Ubuntu-20.04</code> があってtoolや設定をある程度共通にしたいということで試行錯誤していた。
他に <code>ssh経由</code>, <code>Windows wslg</code> もあるよ。</p>
<h3 id="wezterm">wezterm</h3>
<p><code>wezterm</code> が有望であることがわかった</p>













































<table><thead><tr><th></th><th>font fallback</th><th>multiplexer</th><th>emoji</th><th>nerdfnt</th><th>graphics escape</th></tr></thead><tbody><tr><td>wezterm windows</td><td>✅</td><td>✅</td><td>color</td><td>✅</td><td>conpty issue</td></tr><tr><td>wezterm wsl</td><td>✅</td><td>✅</td><td>color</td><td>✅</td><td>conpty issue</td></tr><tr><td>wezterm ssh</td><td>✅</td><td>✅</td><td>color</td><td>✅</td><td>sixel, kitty, iterm2</td></tr><tr><td>wezterm linux</td><td>✅</td><td>✅</td><td>color</td><td>✅</td><td>sixel, kitty, iterm2</td></tr></tbody></table>
<p>conpty を通すときに escape sequence が加工されるとかで、<code>sixel</code>, <code>kitty</code>, <code>iterm2</code> いずれのプロトコルもうまくうごかなかった。<code>iterm2</code> は絵はでるのだけど場所がずれるという惜しい挙動・・・。</p>
<p><a href="https://github.com/wez/wezterm/issues/1236">https://github.com/wez/wezterm/issues/1236</a></p>
<p>SSH 経由で WSL することで対処する。</p>
<h3 id="wslgxtermなど">wslg(xtermなど)</h3>
<p><code>xterm</code> は軽快できれいに表示できるので良かった。フォントのフォールバックができないぽいのが弱点。
<code>urxvt</code> は、<code>NerdFonts</code> がうまくでなかった。
<code>st</code> (simple term) もフォントまわりでつまづきだったかな。</p>





























<table><thead><tr><th></th><th>font fallback</th><th>multiplexer</th><th>emoji</th><th>nerdfnt</th><th>graphics escape</th></tr></thead><tbody><tr><td>xterm wslg</td><td></td><td></td><td>mono</td><td>✅</td><td>sixel</td></tr><tr><td>mlterm wslg</td><td>✅</td><td>mlterm-con</td><td>color</td><td>✅</td><td>sixel</td></tr></tbody></table>
<p>mlterm はフォント周りの設定が強力でよかった。
文字セットごとにフォントを個別に指定できるので、フォントを合成せずともばらのままでよい。</p>
<p><code>mlterm-con</code> という multiplexer があり sixel support があるらしい。
自前ビルドが必要そう(apt には含まれていないぽい)。</p>
<p>wslgは、頻繁にキーボードが押しっぱなしになったり不安定なような・・・
<a href="https://github.com/microsoft/wslg/issues/207">https://github.com/microsoft/wslg/issues/207</a>
なおっているけ、リリースに時間がかかりそう？</p>
<h3 id="libvte">libvte</h3>
<p><code>libvte</code> 系のterm。
<code>gnome-terminal</code>, <code>xfce4-term</code> など。</p>
<h3 id="gpu-rendering">gpu rendering</h3>
<p>GPUレンダリングで <code>araclitty</code>, <code>kitty</code> そして <code>wezterm</code> がある。
<code>wezterm</code> が <code>Windows</code> をサポートしていて、フォントのレンダリング、タブのサポートと総合的に良い。</p>
<h3 id="その他">その他</h3>
<ul>
<li>tabby</li>
<li>RLogin</li>
<li>ConEmu</li>
</ul>
<p>など。</p>
<h2 id="要件">要件</h2>
<h3 id="日本語中文絵文字-nerdfonts-を同時にいい感じに表示したい">日本語、中文、絵文字, NerdFonts を同時にいい感じに表示したい</h3>
<p>となるとすべてを含むひとつのフォントより、主になるフォントを設定してそれにグリフが含まれなかったら、他のフォントにフォールバックする挙動をしてもらう方が便利。
いくつかのフォントを試してみたのだけど、 <code>HackGenNerd Console</code> が良かった。
で、中文の足りない漢字を <code>更紗ゴシックフォント</code> にフォールバックするという組み合わせ。
がんばって完璧な合成フォントを自作すればいいのだけど、よくわからないので、 複数フォントのフォールバック機能が必要。</p>
<p>かつて w3m で表示が乱れることで苦労した <code>ambigous width</code> 問題はあまり気にならなくなっていた。
なんか、表示は２カラム使うが、データ上は1カラムと見なすような扱いになっていて、
<code>X</code> につづいて <code> </code> で隙間を開けることで正しく表示できるようだ。
NerdFonts や 絵文字 はそのようになっている？</p>
<h3 id="エスケープシーケンスで画像を表示したい">エスケープシーケンスで画像を表示したい</h3>
<p><code>sixel</code> とか <code>kitty</code> とか <code>iterm2</code> による画像表示。</p>

























<table><thead><tr><th></th><th>graphics</th></tr></thead><tbody><tr><td>Windows Native(conpty)</td><td></td></tr><tr><td>wsltty</td><td>sixel</td></tr><tr><td>xterm wslg</td><td>sixel</td></tr><tr><td>wezterm linux</td><td>sixel, kityt ,iterm2</td></tr></tbody></table>
<p>という感じになった。<code>wsltty</code> は <code>conpty</code> ではなくて <code>winpty</code> なので例外的に <code>sixel</code> が通過できるらしい。
動く環境でも <code>tmux</code> を挟むと動かなくなる。
代わりに terminal emulator の方で multiplexer(タブ機能) する必要が発生。</p>
<h2 id="まとめ">まとめ</h2>
<p>総合力で wezterm が強い。</p>
<ul>
<li>あまり頑張らなくてもフォントがうまく設定できる(cjk, NerdFonts, 絵文字)</li>
<li>multiplexer 機能あり</li>
<li>sixel, kitty, iterm2 プロトコルで画像を表示できる</li>
<li>Windows でも動く</li>
</ul>
<h2 id="参考">参考</h2>
<ul>
<li><a href="https://zenn.dev/yutakatay/articles/wezterm-intro">alacritty+tmuxもいいけど、weztermがすごい件</a></li>
<li><a href="https://wezfurlong.org/wezterm/">wezterm</a></li>
<li><a href="https://sw.kovidgoyal.net/kitty/graphics-protocol/">https://sw.kovidgoyal.net/kitty/graphics-protocol/</a></li>
<li>OSC1337 <a href="https://iterm2.com/documentation-images.html">https://iterm2.com/documentation-images.html</a></li>
<li><a href="https://unrealman.hatenablog.com/entry/tty-mintty-winpty">【Git for Windows】tty/mintty/winptyとは何なのか？【Gitbash】</a></li>
</ul>

				</div>
			</article>
		</main>
		<footer class="footer astro-SZ7XMLTE">
    <nav class="nav astro-SZ7XMLTE">
        <div class="astro-SZ7XMLTE">2021  &copy; Copyright notice |  <a href="https://github.com/one-aalam/astro-ink" title="三次元日誌(astro)'s Github URL'" class="astro-SZ7XMLTE">三次元日誌(astro)</a>
        <script>(()=>{var e=async t=>{await(await t())()};(self.Astro||(self.Astro={})).load=e;window.dispatchEvent(new Event("astro:load"));})();</script><astro-island uid="1QEdto" component-url="/_astro/ModeLabel.e3ff75e7.js" component-export="default" renderer-url="/_astro/client.cb726945.js" props="{&quot;class&quot;:[0,&quot;astro-SZ7XMLTE&quot;]}" ssr="" client="load" opts="{&quot;name&quot;:&quot;ModeLabel&quot;,&quot;value&quot;:true}" await-children=""><span slot="dark" data-svelte-h="svelte-14ov3lc">(dark)</span></astro-island> theme on <a href="https://astro.build/" class="astro-SZ7XMLTE">Astro</a></div>
        <astro-island uid="1I86to" component-url="/_astro/NetlifyIdentity.94b8edb0.js" component-export="default" renderer-url="/_astro/client.cb726945.js" props="{&quot;class&quot;:[0,&quot;astro-SZ7XMLTE&quot;]}" ssr="" client="load" opts="{&quot;name&quot;:&quot;NetlifyIdentity&quot;,&quot;value&quot;:true}"></astro-island>
    </nav>
</footer>
	</body></html>