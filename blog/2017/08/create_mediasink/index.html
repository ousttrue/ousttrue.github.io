<!DOCTYPE html>
<html lang="en" class="astro-BVZIHDZO">
	<head>
		<!-- Use Google Fonts, if you don't wanna prefer a self-hosted version --><!-- <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@300;400;500;600;700&display=swap" rel="stylesheet"> --><meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>MediaSinkを実装する</title>
<meta name="title" content="MediaSinkを実装する">


<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="shortcut icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">

<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="msapplication-config" content="/browserconfig.xml">
<meta name="theme-color" content="#ffffff">

<!-- Open Graph Tags (Facebook) -->
<meta property="og:type" content="website">
<meta property="og:title" content="MediaSinkを実装する">




<!-- Twitter -->
<meta property="twitter:card" content="summary_large_image">
<meta property="twitter:title" content="MediaSinkを実装する">





<script>
  const theme = (() => {
    if (typeof localStorage !== "undefined" && localStorage.getItem("theme")) {
      return localStorage.getItem("theme");
    }
    if (window.matchMedia("(prefers-color-scheme: dark)").matches) {
      return "dark";
    }
    return "light";
  })();

  if (theme === "light") {
    document.documentElement.classList.remove("dark");
  } else {
    document.documentElement.classList.add("dark");
  }
</script>
		
	<link rel="stylesheet" href="/_astro/about.6111bb3a.css" />
<link rel="stylesheet" href="/_astro/about.657f8f57.css" />
<link rel="stylesheet" href="/_astro/about.ee60a110.css" />
<link rel="stylesheet" href="/_astro/about.dcb84f3d.css" /><script type="module" src="/_astro/hoisted.e6960f2c.js"></script></head>

	<body class="astro-BVZIHDZO">
		<header class="header astro-3EF6KSR2">
    <div class="header__logo astro-3EF6KSR2">
        <a href="/" class="avatar astro-3EF6KSR2">
            <img class="header__logo-img astro-3EF6KSR2" src="/assets/logo.svg" alt="Astro logo">
        </a>
    </div>
    <div class="header__meta flex-1 astro-3EF6KSR2">
        <h3 class="header__title dark:text-theme-dark-secondary astro-3EF6KSR2">
            <a href="" class="astro-3EF6KSR2">三次元日誌(astro)</a>
        </h3>
        <div class="header__meta-more flex astro-3EF6KSR2">
            <p class="header__desc astro-3EF6KSR2">
                Crisp, minimal, personal blog theme for Astro
            </p>
            <nav class="header__nav flex astro-3EF6KSR2">
                <ul class="header__ref-list astro-3EF6KSR2">
                    <li class="astro-3EF6KSR2">
                        <style>astro-island,astro-slot,astro-static-slot{display:contents}</style><script>(()=>{var r=(i,c,n)=>{let s=async()=>{await(await i())()},t=new IntersectionObserver(e=>{for(let o of e)if(o.isIntersecting){t.disconnect(),s();break}});for(let e of n.children)t.observe(e)};(self.Astro||(self.Astro={})).visible=r;window.dispatchEvent(new Event("astro:visible"));})();;(()=>{var d;{let p={0:t=>u(t),1:t=>l(t),2:t=>new RegExp(t),3:t=>new Date(t),4:t=>new Map(l(t)),5:t=>new Set(l(t)),6:t=>BigInt(t),7:t=>new URL(t),8:t=>new Uint8Array(t),9:t=>new Uint16Array(t),10:t=>new Uint32Array(t)},h=t=>{let[e,n]=t;return e in p?p[e](n):void 0},l=t=>t.map(h),u=t=>typeof t!="object"||t===null?t:Object.fromEntries(Object.entries(t).map(([e,n])=>[e,h(n)]));customElements.get("astro-island")||customElements.define("astro-island",(d=class extends HTMLElement{constructor(){super(...arguments);this.hydrate=async()=>{var i;if(!this.hydrator||!this.isConnected)return;let e=(i=this.parentElement)==null?void 0:i.closest("astro-island[ssr]");if(e){e.addEventListener("astro:hydrate",this.hydrate,{once:!0});return}let n=this.querySelectorAll("astro-slot"),o={},a=this.querySelectorAll("template[data-astro-template]");for(let r of a){let s=r.closest(this.tagName);s!=null&&s.isSameNode(this)&&(o[r.getAttribute("data-astro-template")||"default"]=r.innerHTML,r.remove())}for(let r of n){let s=r.closest(this.tagName);s!=null&&s.isSameNode(this)&&(o[r.getAttribute("name")||"default"]=r.innerHTML)}let c;try{c=this.hasAttribute("props")?u(JSON.parse(this.getAttribute("props"))):{}}catch(r){let s=this.getAttribute("component-url")||"<unknown>",y=this.getAttribute("component-export");throw y&&(s+=` (export ${y})`),console.error(`[hydrate] Error parsing props for component ${s}`,this.getAttribute("props"),r),r}await this.hydrator(this)(this.Component,c,o,{client:this.getAttribute("client")}),this.removeAttribute("ssr"),this.dispatchEvent(new CustomEvent("astro:hydrate"))}}connectedCallback(){!this.hasAttribute("await-children")||this.firstChild?this.childrenConnectedCallback():new MutationObserver((e,n)=>{n.disconnect(),setTimeout(()=>this.childrenConnectedCallback(),0)}).observe(this,{childList:!0})}async childrenConnectedCallback(){let e=this.getAttribute("before-hydration-url");e&&await import(e),this.start()}start(){let e=JSON.parse(this.getAttribute("opts")),n=this.getAttribute("client");if(Astro[n]===void 0){window.addEventListener(`astro:${n}`,()=>this.start(),{once:!0});return}Astro[n](async()=>{let o=this.getAttribute("renderer-url"),[a,{default:c}]=await Promise.all([import(this.getAttribute("component-url")),o?import(o):()=>()=>{}]),i=this.getAttribute("component-export")||"default";if(!i.includes("."))this.Component=a[i];else{this.Component=a;for(let r of i.split("."))this.Component=this.Component[r]}return this.hydrator=c,this.hydrate},e,this)}attributeChangedCallback(){this.hydrate()}},d.observedAttributes=["props"],d))}})();</script><astro-island uid="2iKzVC" component-url="/_astro/SearchBtn.984510f3.js" component-export="default" renderer-url="/_astro/client.cb726945.js" props="{&quot;class&quot;:[0,&quot;astro-3EF6KSR2&quot;]}" ssr="" client="visible" opts="{&quot;name&quot;:&quot;SearchBtn&quot;,&quot;value&quot;:true}" await-children=""><button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"> <path fill-rule="evenodd" clip-rule="evenodd" d="M16.2071 4.89344C19.0923 7.77862 19.3131 12.3193 16.8693 15.4578C16.8846 15.4713 16.8996 15.4854 16.9143 15.5L21.1569 19.7427C21.5474 20.1332 21.5474 20.7664 21.1569 21.1569C20.7664 21.5474 20.1332 21.5474 19.7427 21.1569L15.5 16.9143C15.4854 16.8996 15.4713 16.8846 15.4578 16.8693C12.3193 19.3131 7.77862 19.0923 4.89344 16.2071C1.76924 13.083 1.76924 8.01763 4.89344 4.89344C8.01763 1.76924 13.083 1.76924 16.2071 4.89344ZM14.7929 14.7929C17.1361 12.4498 17.1361 8.6508 14.7929 6.30765C12.4498 3.96451 8.6508 3.96451 6.30765 6.30765C3.96451 8.6508 3.96451 12.4498 6.30765 14.7929C8.6508 17.1361 12.4498 17.1361 14.7929 14.7929Z" fill="currentColor"></path></svg></button></astro-island>
                    </li>
                    <li class="astro-3EF6KSR2">
                        <a href="https://github.com/one-aalam/astro-ink" title="三次元日誌(astro)'s Github URL'" class="astro-3EF6KSR2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    
                                <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22" class="astro-3EF6KSR2"></path>
                            
</svg>
                        </a>
                    </li>
                    <li class="astro-3EF6KSR2">
                        <a href="/rss.xml" title="RSS" class="astro-3EF6KSR2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    
                                <path d="M4 11a9 9 0 0 1 9 9" class="astro-3EF6KSR2"></path>
                                <path d="M4 4a16 16 0 0 1 16 16" class="astro-3EF6KSR2"></path>
                                <circle cx="5" cy="19" r="1" class="astro-3EF6KSR2"></circle>
                            
</svg>
                        </a>
                    </li>
                    <li class="astro-3EF6KSR2">
                        <astro-island uid="h8S6z" component-url="/_astro/ModeSwitcherBtn.0ddc5d6d.js" component-export="default" renderer-url="/_astro/client.cb726945.js" props="{&quot;class&quot;:[0,&quot;astro-3EF6KSR2&quot;]}" ssr="" client="visible" opts="{&quot;name&quot;:&quot;ModeSwitcherBtn&quot;,&quot;value&quot;:true}" await-children=""><button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle> <line x1="12" y1="1" x2="12" y2="3"></line> <line x1="12" y1="21" x2="12" y2="23"></line> <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line> <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line> <line x1="1" y1="12" x2="3" y2="12"></line> <line x1="21" y1="12" x2="23" y2="12"></line> <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line> <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg></button></astro-island>
                    </li>
                </ul>
            </nav>
        </div>
    </div>
</header>
		<main class="astro-BVZIHDZO">
			<article class="astro-BVZIHDZO">
				<div class="hero-image astro-BVZIHDZO">
					
				</div>
				<div class="prose astro-BVZIHDZO">
					<div class="title astro-BVZIHDZO">
						<div class="date astro-BVZIHDZO">
							<time datetime="2017-08-27T00:00:00.000Z">
	Aug 27, 2017
</time>
							
						</div>
						<h1 class="astro-BVZIHDZO">MediaSinkを実装する</h1>
						<hr class="astro-BVZIHDZO">
					</div>
					
	<p>DX11VideoRenderer を解読して、VideoRenderer 要件を探る。</p>
<p>Microsoft のサンプルがあり参考になる。</p>
<p><a href="https://github.com/Microsoft/Windows-classic-samples/tree/master/Samples/DX11VideoRenderer">https://github.com/Microsoft/Windows-classic-samples/tree/master/Samples/DX11VideoRenderer</a></p>
<p>これは結構がっつり作ってあるので、削って最低限必要な要素を探る。
IMFMediaSink を作る
手抜きして IMFActivate 抜きで。
<a href="https://github.com/Microsoft/Windows-classic-samples/blob/master/Samples/DX11VideoRenderer/c++/DX11VideoRenderer.h">https://github.com/Microsoft/Windows-classic-samples/blob/master/Samples/DX11VideoRenderer/c++/DX11VideoRenderer.h</a>
を参考に最低限を実装してみる。
guidgen.exe で guid を決めた。
CustomVideoRenderer.h</p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #F97583">#pragma</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">once</span></span>
<span class="line"><span style="color: #F97583">#include</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">&#x3C;windows.h></span></span>
<span class="line"></span>
<span class="line"><span style="color: #6A737D">// {8C5C51AD-F400-4B2A-BD36-4990D07420B4}</span></span>
<span class="line"><span style="color: #B392F0">DEFINE_GUID</span><span style="color: #E1E4E8">(CLSID_CustomVideoRenderer,</span></span>
<span class="line"><span style="color: #F97583">0x</span><span style="color: #79B8FF">8c5c51ad</span><span style="color: #E1E4E8">, </span><span style="color: #F97583">0x</span><span style="color: #79B8FF">f400</span><span style="color: #E1E4E8">, </span><span style="color: #F97583">0x</span><span style="color: #79B8FF">4b2a</span><span style="color: #E1E4E8">, </span><span style="color: #F97583">0x</span><span style="color: #79B8FF">bd</span><span style="color: #E1E4E8">, </span><span style="color: #F97583">0x</span><span style="color: #79B8FF">36</span><span style="color: #E1E4E8">, </span><span style="color: #F97583">0x</span><span style="color: #79B8FF">49</span><span style="color: #E1E4E8">, </span><span style="color: #F97583">0x</span><span style="color: #79B8FF">90</span><span style="color: #E1E4E8">, </span><span style="color: #F97583">0x</span><span style="color: #79B8FF">d0</span><span style="color: #E1E4E8">, </span><span style="color: #F97583">0x</span><span style="color: #79B8FF">74</span><span style="color: #E1E4E8">, </span><span style="color: #F97583">0x</span><span style="color: #79B8FF">20</span><span style="color: #E1E4E8">, </span><span style="color: #F97583">0x</span><span style="color: #79B8FF">b4</span><span style="color: #E1E4E8">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #B392F0">STDAPI</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">CreateCustomVideoRenderer</span><span style="color: #E1E4E8">(</span><span style="color: #B392F0">REFIID</span><span style="color: #E1E4E8"> </span><span style="color: #FFAB70">riid</span><span style="color: #E1E4E8">, </span><span style="color: #F97583">void</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">**</span><span style="color: #FFAB70">ppvObject</span><span style="color: #E1E4E8">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">DX11VideoRendererから必要な部分をコピペしてくるだけである。</span></span>
<span class="line"><span style="color: #E1E4E8">CustomVideoRenderer.c</span><span style="color: #F97583">++</span></span>
<span class="line"><span style="color: #F97583">#include</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">"CustomVideoRenderer.h"</span></span>
<span class="line"><span style="color: #F97583">#include</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">&#x3C;mfidl.h></span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color: #F97583">class</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">CustomVideoRenderer</span><span style="color: #E1E4E8">: </span><span style="color: #F97583">public</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">IMFMediaSink</span></span>
<span class="line"><span style="color: #E1E4E8">{</span></span>
<span class="line"><span style="color: #E1E4E8">    ULONG m_nRefCount </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">1</span><span style="color: #E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #F97583">public:</span></span>
<span class="line"><span style="color: #6A737D">    // IUnknown</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #B392F0">STDMETHODIMP_</span><span style="color: #E1E4E8">(</span><span style="color: #B392F0">ULONG</span><span style="color: #E1E4E8">) </span><span style="color: #B392F0">AddRef</span><span style="color: #E1E4E8">(</span><span style="color: #F97583">void</span><span style="color: #E1E4E8">)</span><span style="color: #F97583">override</span></span>
<span class="line"><span style="color: #E1E4E8">    {</span></span>
<span class="line"><span style="color: #E1E4E8">        </span><span style="color: #F97583">return</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">InterlockedIncrement</span><span style="color: #E1E4E8">(</span><span style="color: #F97583">&#x26;</span><span style="color: #E1E4E8">m_nRefCount);</span></span>
<span class="line"><span style="color: #E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #B392F0">STDMETHODIMP</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">QueryInterface</span><span style="color: #E1E4E8">(</span><span style="color: #B392F0">REFIID</span><span style="color: #E1E4E8"> </span><span style="color: #FFAB70">iid</span><span style="color: #E1E4E8">, </span><span style="color: #B392F0">__RPC__deref_out</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">_Result_nullonfailure_</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">void**</span><span style="color: #E1E4E8"> </span><span style="color: #FFAB70">ppv</span><span style="color: #E1E4E8">)</span><span style="color: #F97583">override</span></span>
<span class="line"><span style="color: #E1E4E8">    {</span></span>
<span class="line"><span style="color: #E1E4E8">        </span><span style="color: #F97583">if</span><span style="color: #E1E4E8"> (</span><span style="color: #F97583">!</span><span style="color: #E1E4E8">ppv)</span></span>
<span class="line"><span style="color: #E1E4E8">        {</span></span>
<span class="line"><span style="color: #E1E4E8">            </span><span style="color: #F97583">return</span><span style="color: #E1E4E8"> E_POINTER;</span></span>
<span class="line"><span style="color: #E1E4E8">        }</span></span>
<span class="line"><span style="color: #E1E4E8">        </span><span style="color: #F97583">if</span><span style="color: #E1E4E8"> (iid </span><span style="color: #F97583">==</span><span style="color: #E1E4E8"> IID_IUnknown)</span></span>
<span class="line"><span style="color: #E1E4E8">        {</span></span>
<span class="line"><span style="color: #E1E4E8">            </span><span style="color: #F97583">*</span><span style="color: #E1E4E8">ppv </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">static_cast&#x3C;</span><span style="color: #E1E4E8">IUnknown</span><span style="color: #F97583">*></span><span style="color: #E1E4E8">(</span><span style="color: #F97583">static_cast&#x3C;</span><span style="color: #E1E4E8">IMFMediaSink</span><span style="color: #F97583">*></span><span style="color: #E1E4E8">(</span><span style="color: #79B8FF">this</span><span style="color: #E1E4E8">));</span></span>
<span class="line"><span style="color: #E1E4E8">        }</span></span>
<span class="line"><span style="color: #E1E4E8">        </span><span style="color: #F97583">else</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">if</span><span style="color: #E1E4E8"> (iid </span><span style="color: #F97583">==</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">__uuidof</span><span style="color: #E1E4E8">(IMFMediaSink))</span></span>
<span class="line"><span style="color: #E1E4E8">        {</span></span>
<span class="line"><span style="color: #E1E4E8">            </span><span style="color: #F97583">*</span><span style="color: #E1E4E8">ppv </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">static_cast&#x3C;</span><span style="color: #E1E4E8">IMFMediaSink</span><span style="color: #F97583">*></span><span style="color: #E1E4E8">(</span><span style="color: #79B8FF">this</span><span style="color: #E1E4E8">);</span></span>
<span class="line"><span style="color: #E1E4E8">        }</span></span>
<span class="line"><span style="color: #E1E4E8">        </span><span style="color: #F97583">else</span></span>
<span class="line"><span style="color: #E1E4E8">        {</span></span>
<span class="line"><span style="color: #E1E4E8">            </span><span style="color: #F97583">*</span><span style="color: #E1E4E8">ppv </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">NULL</span><span style="color: #E1E4E8">;</span></span>
<span class="line"><span style="color: #E1E4E8">            </span><span style="color: #F97583">return</span><span style="color: #E1E4E8"> E_NOINTERFACE;</span></span>
<span class="line"><span style="color: #E1E4E8">        }</span></span>
<span class="line"><span style="color: #E1E4E8">        </span><span style="color: #B392F0">AddRef</span><span style="color: #E1E4E8">();</span></span>
<span class="line"><span style="color: #E1E4E8">        </span><span style="color: #F97583">return</span><span style="color: #E1E4E8"> S_OK;</span></span>
<span class="line"><span style="color: #E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #B392F0">STDMETHODIMP_</span><span style="color: #E1E4E8">(</span><span style="color: #B392F0">ULONG</span><span style="color: #E1E4E8">) </span><span style="color: #B392F0">Release</span><span style="color: #E1E4E8">(</span><span style="color: #F97583">void</span><span style="color: #E1E4E8">)</span><span style="color: #F97583">override</span></span>
<span class="line"><span style="color: #E1E4E8">    {</span></span>
<span class="line"><span style="color: #E1E4E8">        ULONG uCount </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">InterlockedDecrement</span><span style="color: #E1E4E8">(</span><span style="color: #F97583">&#x26;</span><span style="color: #E1E4E8">m_nRefCount);</span></span>
<span class="line"><span style="color: #E1E4E8">        </span><span style="color: #F97583">if</span><span style="color: #E1E4E8"> (uCount </span><span style="color: #F97583">==</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">0</span><span style="color: #E1E4E8">)</span></span>
<span class="line"><span style="color: #E1E4E8">        {</span></span>
<span class="line"><span style="color: #E1E4E8">            </span><span style="color: #F97583">delete</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">this</span><span style="color: #E1E4E8">;</span></span>
<span class="line"><span style="color: #E1E4E8">        }</span></span>
<span class="line"><span style="color: #6A737D">        // For thread safety, return a temporary variable.</span></span>
<span class="line"><span style="color: #E1E4E8">        </span><span style="color: #F97583">return</span><span style="color: #E1E4E8"> uCount;</span></span>
<span class="line"><span style="color: #E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #6A737D">    // IMFMediaSink methods</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #B392F0">STDMETHODIMP</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">AddStreamSink</span><span style="color: #E1E4E8">(</span><span style="color: #B392F0">DWORD</span><span style="color: #E1E4E8"> </span><span style="color: #FFAB70">dwStreamSinkIdentifier</span><span style="color: #E1E4E8">, </span><span style="color: #B392F0">__RPC__in_opt</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">IMFMediaType</span><span style="color: #F97583">*</span><span style="color: #E1E4E8"> </span><span style="color: #FFAB70">pMediaType</span><span style="color: #E1E4E8">, </span><span style="color: #B392F0">__RPC__deref_out_opt</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">IMFStreamSink</span><span style="color: #F97583">**</span><span style="color: #E1E4E8"> </span><span style="color: #FFAB70">ppStreamSink</span><span style="color: #E1E4E8">)</span><span style="color: #F97583">override</span><span style="color: #E1E4E8">;</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #B392F0">STDMETHODIMP</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">GetCharacteristics</span><span style="color: #E1E4E8">(</span><span style="color: #B392F0">__RPC__out</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">DWORD</span><span style="color: #F97583">*</span><span style="color: #E1E4E8"> </span><span style="color: #FFAB70">pdwCharacteristics</span><span style="color: #E1E4E8">)</span><span style="color: #F97583">override</span><span style="color: #E1E4E8">;</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #B392F0">STDMETHODIMP</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">GetPresentationClock</span><span style="color: #E1E4E8">(</span><span style="color: #B392F0">__RPC__deref_out_opt</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">IMFPresentationClock</span><span style="color: #F97583">**</span><span style="color: #E1E4E8"> </span><span style="color: #FFAB70">ppPresentationClock</span><span style="color: #E1E4E8">)</span><span style="color: #F97583">override</span><span style="color: #E1E4E8">;</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #B392F0">STDMETHODIMP</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">GetStreamSinkById</span><span style="color: #E1E4E8">(</span><span style="color: #B392F0">DWORD</span><span style="color: #E1E4E8"> </span><span style="color: #FFAB70">dwIdentifier</span><span style="color: #E1E4E8">, </span><span style="color: #B392F0">__RPC__deref_out_opt</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">IMFStreamSink</span><span style="color: #F97583">**</span><span style="color: #E1E4E8"> </span><span style="color: #FFAB70">ppStreamSink</span><span style="color: #E1E4E8">)</span><span style="color: #F97583">override</span><span style="color: #E1E4E8">;</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #B392F0">STDMETHODIMP</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">GetStreamSinkByIndex</span><span style="color: #E1E4E8">(</span><span style="color: #B392F0">DWORD</span><span style="color: #E1E4E8"> </span><span style="color: #FFAB70">dwIndex</span><span style="color: #E1E4E8">, </span><span style="color: #B392F0">__RPC__deref_out_opt</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">IMFStreamSink</span><span style="color: #F97583">**</span><span style="color: #E1E4E8"> </span><span style="color: #FFAB70">ppStreamSink</span><span style="color: #E1E4E8">)</span><span style="color: #F97583">override</span><span style="color: #E1E4E8">;</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #B392F0">STDMETHODIMP</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">GetStreamSinkCount</span><span style="color: #E1E4E8">(</span><span style="color: #B392F0">__RPC__out</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">DWORD</span><span style="color: #F97583">*</span><span style="color: #E1E4E8"> </span><span style="color: #FFAB70">pcStreamSinkCount</span><span style="color: #E1E4E8">)</span><span style="color: #F97583">override</span><span style="color: #E1E4E8">;</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #B392F0">STDMETHODIMP</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">RemoveStreamSink</span><span style="color: #E1E4E8">(</span><span style="color: #B392F0">DWORD</span><span style="color: #E1E4E8"> </span><span style="color: #FFAB70">dwStreamSinkIdentifier</span><span style="color: #E1E4E8">)</span><span style="color: #F97583">override</span><span style="color: #E1E4E8">;</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #B392F0">STDMETHODIMP</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">SetPresentationClock</span><span style="color: #E1E4E8">(</span><span style="color: #B392F0">__RPC__in_opt</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">IMFPresentationClock</span><span style="color: #F97583">*</span><span style="color: #E1E4E8"> </span><span style="color: #FFAB70">pPresentationClock</span><span style="color: #E1E4E8">)</span><span style="color: #F97583">override</span><span style="color: #E1E4E8">;</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #B392F0">STDMETHODIMP</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">Shutdown</span><span style="color: #E1E4E8">(</span><span style="color: #F97583">void</span><span style="color: #E1E4E8">)</span><span style="color: #F97583">override</span><span style="color: #E1E4E8">;</span></span>
<span class="line"><span style="color: #E1E4E8">};</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color: #B392F0">STDAPI</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">CreateCustomVideoRenderer</span><span style="color: #E1E4E8">(</span><span style="color: #B392F0">REFIID</span><span style="color: #E1E4E8"> </span><span style="color: #FFAB70">riid</span><span style="color: #E1E4E8">, </span><span style="color: #F97583">void</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">**</span><span style="color: #FFAB70">ppvObject</span><span style="color: #E1E4E8">)</span></span>
<span class="line"><span style="color: #E1E4E8">{</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #F97583">if</span><span style="color: #E1E4E8">(</span><span style="color: #F97583">!</span><span style="color: #E1E4E8">ppvObject){</span></span>
<span class="line"><span style="color: #E1E4E8">        </span><span style="color: #F97583">return</span><span style="color: #E1E4E8"> E_FAIL;</span></span>
<span class="line"><span style="color: #E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #F97583">auto</span><span style="color: #E1E4E8"> sink</span><span style="color: #F97583">=new</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">CustomVideoRenderer</span><span style="color: #E1E4E8">();</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #F97583">*</span><span style="color: #E1E4E8">ppvObject</span><span style="color: #F97583">=</span><span style="color: #E1E4E8">sink;</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #F97583">return</span><span style="color: #E1E4E8"> S_OK;</span></span>
<span class="line"><span style="color: #E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">使う</span></span>
<span class="line"><span style="color: #E1E4E8">IMFStreamSinkからIMFTopologyNodeを作る。</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">Creating Output Nodes</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #B392F0">Microsoft</span><span style="color: #E1E4E8">::</span><span style="color: #B392F0">WRL</span><span style="color: #E1E4E8">::ComPtr</span><span style="color: #F97583">&#x3C;</span><span style="color: #E1E4E8">IMFTopologyNode</span><span style="color: #F97583">></span><span style="color: #E1E4E8"> pOutputNode;</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #F97583">if</span><span style="color: #E1E4E8">(</span><span style="color: #B392F0">FAILED</span><span style="color: #E1E4E8">(hr </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">MFCreateTopologyNode</span><span style="color: #E1E4E8">(MF_TOPOLOGY_OUTPUT_NODE, </span><span style="color: #F97583">&#x26;</span><span style="color: #E1E4E8">pOutputNode)))</span></span>
<span class="line"><span style="color: #E1E4E8">    {</span></span>
<span class="line"><span style="color: #E1E4E8">        </span><span style="color: #F97583">return</span><span style="color: #E1E4E8"> hr;</span></span>
<span class="line"><span style="color: #E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #B392F0">Microsoft</span><span style="color: #E1E4E8">::</span><span style="color: #B392F0">WRL</span><span style="color: #E1E4E8">::ComPtr</span><span style="color: #F97583">&#x3C;</span><span style="color: #E1E4E8">IMFMediaSink</span><span style="color: #F97583">></span><span style="color: #E1E4E8"> pSink;</span></span>
<span class="line"><span style="color: #6A737D">    // 自前のIMFMediaSinkを作る</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #F97583">if</span><span style="color: #E1E4E8">(</span><span style="color: #B392F0">FAILED</span><span style="color: #E1E4E8">(hr</span><span style="color: #F97583">=</span><span style="color: #B392F0">CreateCustomVideoRenderer</span><span style="color: #E1E4E8">(</span><span style="color: #B392F0">IID_PPV_ARGS</span><span style="color: #E1E4E8">(</span><span style="color: #F97583">&#x26;</span><span style="color: #E1E4E8">pSink)))){</span></span>
<span class="line"><span style="color: #E1E4E8">        </span><span style="color: #F97583">return</span><span style="color: #E1E4E8"> hr;</span></span>
<span class="line"><span style="color: #E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #B392F0">Microsoft</span><span style="color: #E1E4E8">::</span><span style="color: #B392F0">WRL</span><span style="color: #E1E4E8">::ComPtr</span><span style="color: #F97583">&#x3C;</span><span style="color: #E1E4E8">IMFStreamSink</span><span style="color: #F97583">></span><span style="color: #E1E4E8"> pSSink;</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #F97583">if</span><span style="color: #E1E4E8">(</span><span style="color: #B392F0">FAILED</span><span style="color: #E1E4E8">(hr</span><span style="color: #F97583">=</span><span style="color: #E1E4E8">pSink-></span><span style="color: #B392F0">GetStreamSinkByIndex</span><span style="color: #E1E4E8">(</span><span style="color: #79B8FF">0</span><span style="color: #E1E4E8">, </span><span style="color: #F97583">&#x26;</span><span style="color: #E1E4E8">pSSink))){</span></span>
<span class="line"><span style="color: #6A737D">        // まだ作っていないのでここでエラーになる</span></span>
<span class="line"><span style="color: #E1E4E8">        </span><span style="color: #F97583">return</span><span style="color: #E1E4E8"> hr;</span></span>
<span class="line"><span style="color: #E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #F97583">if</span><span style="color: #E1E4E8"> (</span><span style="color: #B392F0">FAILED</span><span style="color: #E1E4E8">(hr </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> pOutputNode-></span><span style="color: #B392F0">SetObject</span><span style="color: #E1E4E8">(pSSink.</span><span style="color: #B392F0">Get</span><span style="color: #E1E4E8">())))</span></span>
<span class="line"><span style="color: #E1E4E8">    {</span></span>
<span class="line"><span style="color: #E1E4E8">        </span><span style="color: #F97583">return</span><span style="color: #E1E4E8"> hr;</span></span>
<span class="line"><span style="color: #E1E4E8">    }</span></span></code></pre>
<p>IMFStreamSink がひとつは必要
作る。</p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #F97583">class</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">CustomVideoStreamSink</span><span style="color: #E1E4E8">: </span><span style="color: #F97583">public</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">IMFStreamSink</span></span>
<span class="line"><span style="color: #E1E4E8">{</span></span>
<span class="line"><span style="color: #E1E4E8">    ULONG m_nRefCount </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">1</span><span style="color: #E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #F97583">const</span><span style="color: #E1E4E8"> DWORD                 STREAM_ID;</span></span>
<span class="line"><span style="color: #E1E4E8">    CCritSec</span><span style="color: #F97583">&#x26;</span><span style="color: #E1E4E8">                   m_critSec;</span><span style="color: #6A737D">                      // critical section for thread safety</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #B392F0">Microsoft</span><span style="color: #E1E4E8">::</span><span style="color: #B392F0">WRL</span><span style="color: #E1E4E8">::ComPtr</span><span style="color: #F97583">&#x3C;</span><span style="color: #E1E4E8">IMFMediaSink</span><span style="color: #F97583">></span><span style="color: #E1E4E8">               m_pSink;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #F97583">public:</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #B392F0">CustomVideoStreamSink</span><span style="color: #E1E4E8">(</span><span style="color: #B392F0">DWORD</span><span style="color: #E1E4E8"> </span><span style="color: #FFAB70">dwStreamId</span><span style="color: #E1E4E8">, </span><span style="color: #B392F0">CCritSec</span><span style="color: #F97583">&#x26;</span><span style="color: #E1E4E8"> </span><span style="color: #FFAB70">critSec</span></span>
<span class="line"><span style="color: #E1E4E8">            , </span><span style="color: #B392F0">IMFMediaSink</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">*</span><span style="color: #FFAB70">parent</span><span style="color: #E1E4E8">)</span></span>
<span class="line"><span style="color: #E1E4E8">        : </span><span style="color: #B392F0">STREAM_ID</span><span style="color: #E1E4E8">(dwStreamId)</span></span>
<span class="line"><span style="color: #E1E4E8">          , </span><span style="color: #B392F0">m_critSec</span><span style="color: #E1E4E8">(critSec)</span></span>
<span class="line"><span style="color: #E1E4E8">          , </span><span style="color: #B392F0">m_pSink</span><span style="color: #E1E4E8">(parent)</span></span>
<span class="line"><span style="color: #E1E4E8">    {</span></span>
<span class="line"><span style="color: #E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #6A737D">    // IUnknown</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #B392F0">STDMETHODIMP_</span><span style="color: #E1E4E8">(</span><span style="color: #B392F0">ULONG</span><span style="color: #E1E4E8">) </span><span style="color: #B392F0">AddRef</span><span style="color: #E1E4E8">(</span><span style="color: #F97583">void</span><span style="color: #E1E4E8">)</span><span style="color: #F97583">override</span><span style="color: #E1E4E8">;</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #B392F0">STDMETHODIMP</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">QueryInterface</span><span style="color: #E1E4E8">(</span><span style="color: #B392F0">REFIID</span><span style="color: #E1E4E8"> </span><span style="color: #FFAB70">iid</span><span style="color: #E1E4E8">, </span><span style="color: #B392F0">__RPC__deref_out</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">_Result_nullonfailure_</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">void**</span><span style="color: #E1E4E8"> </span><span style="color: #FFAB70">ppv</span><span style="color: #E1E4E8">)</span><span style="color: #F97583">override</span><span style="color: #E1E4E8">;</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #B392F0">STDMETHODIMP_</span><span style="color: #E1E4E8">(</span><span style="color: #B392F0">ULONG</span><span style="color: #E1E4E8">) </span><span style="color: #B392F0">Release</span><span style="color: #E1E4E8">(</span><span style="color: #F97583">void</span><span style="color: #E1E4E8">)</span><span style="color: #F97583">override</span><span style="color: #E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #6A737D">    // IMFStreamSink</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #B392F0">STDMETHODIMP</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">Flush</span><span style="color: #E1E4E8">(</span><span style="color: #F97583">void</span><span style="color: #E1E4E8">)</span><span style="color: #F97583">override</span><span style="color: #E1E4E8">;</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #B392F0">STDMETHODIMP</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">GetIdentifier</span><span style="color: #E1E4E8">(</span><span style="color: #B392F0">__RPC__out</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">DWORD</span><span style="color: #F97583">*</span><span style="color: #E1E4E8"> </span><span style="color: #FFAB70">pdwIdentifier</span><span style="color: #E1E4E8">)</span><span style="color: #F97583">override</span><span style="color: #E1E4E8">;</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #B392F0">STDMETHODIMP</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">GetMediaSink</span><span style="color: #E1E4E8">(</span><span style="color: #B392F0">__RPC__deref_out_opt</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">IMFMediaSink</span><span style="color: #F97583">**</span><span style="color: #E1E4E8"> </span><span style="color: #FFAB70">ppMediaSink</span><span style="color: #E1E4E8">)</span><span style="color: #F97583">override</span><span style="color: #E1E4E8">;</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #B392F0">STDMETHODIMP</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">GetMediaTypeHandler</span><span style="color: #E1E4E8">(</span><span style="color: #B392F0">__RPC__deref_out_opt</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">IMFMediaTypeHandler</span><span style="color: #F97583">**</span><span style="color: #E1E4E8"> </span><span style="color: #FFAB70">ppHandler</span><span style="color: #E1E4E8">)</span><span style="color: #F97583">override</span><span style="color: #E1E4E8">;</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #B392F0">STDMETHODIMP</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">PlaceMarker</span><span style="color: #E1E4E8">(</span><span style="color: #B392F0">MFSTREAMSINK_MARKER_TYPE</span><span style="color: #E1E4E8"> </span><span style="color: #FFAB70">eMarkerType</span><span style="color: #E1E4E8">, </span><span style="color: #B392F0">__RPC__in</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">const</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">PROPVARIANT</span><span style="color: #F97583">*</span><span style="color: #E1E4E8"> </span><span style="color: #FFAB70">pvarMarkerValue</span><span style="color: #E1E4E8">, </span><span style="color: #B392F0">__RPC__in</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">const</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">PROPVARIANT</span><span style="color: #F97583">*</span><span style="color: #E1E4E8"> </span><span style="color: #FFAB70">pvarContextValue</span><span style="color: #E1E4E8">)</span><span style="color: #F97583">override</span><span style="color: #E1E4E8">;</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #B392F0">STDMETHODIMP</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">ProcessSample</span><span style="color: #E1E4E8">(</span><span style="color: #B392F0">__RPC__in_opt</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">IMFSample</span><span style="color: #F97583">*</span><span style="color: #E1E4E8"> </span><span style="color: #FFAB70">pSample</span><span style="color: #E1E4E8">)</span><span style="color: #F97583">override</span><span style="color: #E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #6A737D">    // IMFMediaEventGenerator (from IMFStreamSink)</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #B392F0">STDMETHODIMP</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">BeginGetEvent</span><span style="color: #E1E4E8">(</span><span style="color: #B392F0">IMFAsyncCallback</span><span style="color: #F97583">*</span><span style="color: #E1E4E8"> </span><span style="color: #FFAB70">pCallback</span><span style="color: #E1E4E8">,</span><span style="color: #B392F0">IUnknown</span><span style="color: #F97583">*</span><span style="color: #E1E4E8"> </span><span style="color: #FFAB70">punkState</span><span style="color: #E1E4E8">)</span><span style="color: #F97583">override</span><span style="color: #E1E4E8">;</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #B392F0">STDMETHODIMP</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">EndGetEvent</span><span style="color: #E1E4E8">(</span><span style="color: #B392F0">IMFAsyncResult</span><span style="color: #F97583">*</span><span style="color: #E1E4E8"> </span><span style="color: #FFAB70">pResult</span><span style="color: #E1E4E8">, </span><span style="color: #B392F0">_Out_</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">IMFMediaEvent</span><span style="color: #F97583">**</span><span style="color: #E1E4E8"> </span><span style="color: #FFAB70">ppEvent</span><span style="color: #E1E4E8">)</span><span style="color: #F97583">override</span><span style="color: #E1E4E8">;</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #B392F0">STDMETHODIMP</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">GetEvent</span><span style="color: #E1E4E8">(</span><span style="color: #B392F0">DWORD</span><span style="color: #E1E4E8"> </span><span style="color: #FFAB70">dwFlags</span><span style="color: #E1E4E8">, </span><span style="color: #B392F0">__RPC__deref_out_opt</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">IMFMediaEvent</span><span style="color: #F97583">**</span><span style="color: #E1E4E8"> </span><span style="color: #FFAB70">ppEvent</span><span style="color: #E1E4E8">)</span><span style="color: #F97583">override</span><span style="color: #E1E4E8">;</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #B392F0">STDMETHODIMP</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">QueueEvent</span><span style="color: #E1E4E8">(</span><span style="color: #B392F0">MediaEventType</span><span style="color: #E1E4E8"> </span><span style="color: #FFAB70">met</span><span style="color: #E1E4E8">, </span><span style="color: #B392F0">__RPC__in</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">REFGUID</span><span style="color: #E1E4E8"> </span><span style="color: #FFAB70">guidExtendedType</span><span style="color: #E1E4E8">, </span><span style="color: #B392F0">HRESULT</span><span style="color: #E1E4E8"> </span><span style="color: #FFAB70">hrStatus</span><span style="color: #E1E4E8">, </span><span style="color: #B392F0">__RPC__in_opt</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">const</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">PROPVARIANT</span><span style="color: #F97583">*</span><span style="color: #E1E4E8"> </span><span style="color: #FFAB70">pvValue</span><span style="color: #E1E4E8">)</span><span style="color: #F97583">override</span><span style="color: #E1E4E8">;</span></span>
<span class="line"><span style="color: #E1E4E8">};</span></span></code></pre>
<p>メソッドの中身は</p>
<p><code>return E_FAIL;</code></p>
<p>でお茶を濁した。</p>
<p>IMFMediaSink::AddStreamSink 実装
IMFMediaSink::GetStreamSinkById 実装
IMFMediaSink::GetStreamSinkByIndex 実装
IMFMediaSink::GetStreamSinkCount 実装
IMFMediaSink::RemoveStreamSink 実装
実行してみる。</p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #6A737D">// Handler for Media Session events.</span></span>
<span class="line"><span style="color: #F97583">void</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">OnPlayerEvent</span><span style="color: #E1E4E8">(</span><span style="color: #B392F0">HWND</span><span style="color: #E1E4E8"> </span><span style="color: #FFAB70">hwnd</span><span style="color: #E1E4E8">, </span><span style="color: #B392F0">WPARAM</span><span style="color: #E1E4E8"> </span><span style="color: #FFAB70">pUnkPtr</span><span style="color: #E1E4E8">)</span></span>
<span class="line"><span style="color: #E1E4E8">{</span></span>
<span class="line"><span style="color: #E1E4E8">    HRESULT hr </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> g_pPlayer-></span><span style="color: #B392F0">HandleEvent</span><span style="color: #E1E4E8">(pUnkPtr);</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #F97583">if</span><span style="color: #E1E4E8"> (</span><span style="color: #B392F0">FAILED</span><span style="color: #E1E4E8">(hr))</span></span>
<span class="line"><span style="color: #E1E4E8">    {</span></span>
<span class="line"><span style="color: #6A737D">        // ここに来る</span></span>
<span class="line"><span style="color: #E1E4E8">        </span><span style="color: #B392F0">NotifyError</span><span style="color: #E1E4E8">(hwnd, </span><span style="color: #9ECBFF">L"An error occurred."</span><span style="color: #E1E4E8">, hr);</span></span>
<span class="line"><span style="color: #E1E4E8">    }</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #B392F0">UpdateUI</span><span style="color: #E1E4E8">(hwnd, g_pPlayer-></span><span style="color: #B392F0">GetState</span><span style="color: #E1E4E8">());</span></span>
<span class="line"><span style="color: #E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #6A737D">    // Get the event status. If the operation that triggered the event</span></span>
<span class="line"><span style="color: #6A737D">    // did not succeed, the status is a failure code.</span></span>
<span class="line"><span style="color: #E1E4E8">    HRESULT hrStatus </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> S_OK;</span></span>
<span class="line"><span style="color: #E1E4E8">    hr </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> pEvent-></span><span style="color: #B392F0">GetStatus</span><span style="color: #E1E4E8">(</span><span style="color: #F97583">&#x26;</span><span style="color: #E1E4E8">hrStatus);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #6A737D">    // Check if the async operation succeeded.</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #F97583">if</span><span style="color: #E1E4E8"> (</span><span style="color: #B392F0">SUCCEEDED</span><span style="color: #E1E4E8">(hr) </span><span style="color: #F97583">&#x26;&#x26;</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">FAILED</span><span style="color: #E1E4E8">(hrStatus))</span></span>
<span class="line"><span style="color: #E1E4E8">    {</span></span>
<span class="line"><span style="color: #6A737D">        // ここに来る</span></span>
<span class="line"><span style="color: #E1E4E8">        hr</span><span style="color: #F97583">=</span><span style="color: #E1E4E8">hrStatus;</span></span>
<span class="line"><span style="color: #E1E4E8">    }</span></span></code></pre>
<p>デバッガで調べたら IMFStreamSink::GetMediaSink の直後にエラーになることがわかった。
IMFStreamSink::GetMediaSink 実装
たんたんとエラーを直していく。
IMFStreamSink::GetMediaTypeHandler 実装</p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #B392F0">HRESULT</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">DX11VideoRenderer</span><span style="color: #E1E4E8">::</span><span style="color: #B392F0">CStreamSink</span><span style="color: #E1E4E8">::</span><span style="color: #B392F0">GetMediaTypeHandler</span><span style="color: #E1E4E8">(</span><span style="color: #B392F0">__RPC__deref_out_opt</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">IMFMediaTypeHandler</span><span style="color: #F97583">**</span><span style="color: #E1E4E8"> </span><span style="color: #FFAB70">ppHandler</span><span style="color: #E1E4E8">)</span></span>
<span class="line"><span style="color: #E1E4E8">{</span></span>
<span class="line"><span style="color: #E1E4E8">    CAutoLock </span><span style="color: #B392F0">lock</span><span style="color: #E1E4E8">(</span><span style="color: #F97583">&#x26;</span><span style="color: #E1E4E8">m_critSec);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #F97583">if</span><span style="color: #E1E4E8"> (ppHandler </span><span style="color: #F97583">==</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">NULL</span><span style="color: #E1E4E8">)</span></span>
<span class="line"><span style="color: #E1E4E8">    {</span></span>
<span class="line"><span style="color: #E1E4E8">        </span><span style="color: #F97583">return</span><span style="color: #E1E4E8"> E_POINTER;</span></span>
<span class="line"><span style="color: #E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">    HRESULT hr </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">CheckShutdown</span><span style="color: #E1E4E8">();</span></span>
<span class="line"></span>
<span class="line"><span style="color: #6A737D">    // This stream object acts as its own type handler, so we QI ourselves.</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #F97583">if</span><span style="color: #E1E4E8"> (</span><span style="color: #B392F0">SUCCEEDED</span><span style="color: #E1E4E8">(hr))</span></span>
<span class="line"><span style="color: #E1E4E8">    {</span></span>
<span class="line"><span style="color: #E1E4E8">        hr </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">this</span><span style="color: #E1E4E8">-></span><span style="color: #B392F0">QueryInterface</span><span style="color: #E1E4E8">(IID_IMFMediaTypeHandler, (</span><span style="color: #F97583">void**</span><span style="color: #E1E4E8">)ppHandler);</span></span>
<span class="line"><span style="color: #E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #F97583">return</span><span style="color: #E1E4E8"> hr;</span></span>
<span class="line"><span style="color: #E1E4E8">}</span></span></code></pre>
<p>IMFMediaTypeHandler が必要。
StreamSink に IMFMediaTypeHandler を実装
このインタフェースは StreamSink が処理できる MediaType を示すので必要。
サポートするフォーマットを決める。</p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #6A737D">// IMFMediaTypeHandler</span></span>
<span class="line"><span style="color: #B392F0">STDMETHODIMP</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">GetCurrentMediaType</span><span style="color: #E1E4E8">(</span><span style="color: #B392F0">_Outptr_</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">IMFMediaType</span><span style="color: #F97583">**</span><span style="color: #E1E4E8"> </span><span style="color: #FFAB70">ppMediaType</span><span style="color: #E1E4E8">);</span></span>
<span class="line"><span style="color: #B392F0">STDMETHODIMP</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">GetMajorType</span><span style="color: #E1E4E8">(</span><span style="color: #B392F0">__RPC__out</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">GUID</span><span style="color: #F97583">*</span><span style="color: #E1E4E8"> </span><span style="color: #FFAB70">pguidMajorType</span><span style="color: #E1E4E8">);</span></span>
<span class="line"><span style="color: #B392F0">STDMETHODIMP</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">GetMediaTypeByIndex</span><span style="color: #E1E4E8">(</span><span style="color: #B392F0">DWORD</span><span style="color: #E1E4E8"> </span><span style="color: #FFAB70">dwIndex</span><span style="color: #E1E4E8">, </span><span style="color: #B392F0">_Outptr_</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">IMFMediaType</span><span style="color: #F97583">**</span><span style="color: #E1E4E8"> </span><span style="color: #FFAB70">ppType</span><span style="color: #E1E4E8">);</span></span>
<span class="line"><span style="color: #B392F0">STDMETHODIMP</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">GetMediaTypeCount</span><span style="color: #E1E4E8">(</span><span style="color: #B392F0">__RPC__out</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">DWORD</span><span style="color: #F97583">*</span><span style="color: #E1E4E8"> </span><span style="color: #FFAB70">pdwTypeCount</span><span style="color: #E1E4E8">);</span></span>
<span class="line"><span style="color: #B392F0">STDMETHODIMP</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">IsMediaTypeSupported</span><span style="color: #E1E4E8">(</span><span style="color: #B392F0">IMFMediaType</span><span style="color: #F97583">*</span><span style="color: #E1E4E8"> </span><span style="color: #FFAB70">pMediaType</span><span style="color: #E1E4E8">, </span><span style="color: #B392F0">_Outptr_opt_result_maybenull_</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">IMFMediaType</span><span style="color: #F97583">**</span><span style="color: #E1E4E8"> </span><span style="color: #FFAB70">ppMediaType</span><span style="color: #E1E4E8">);</span></span>
<span class="line"><span style="color: #B392F0">STDMETHODIMP</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">SetCurrentMediaType</span><span style="color: #E1E4E8">(</span><span style="color: #B392F0">IMFMediaType</span><span style="color: #F97583">*</span><span style="color: #E1E4E8"> </span><span style="color: #FFAB70">pMediaType</span><span style="color: #E1E4E8">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">PresentationClockが必要</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">Presentation Clock</span></span>
<span class="line"></span>
<span class="line"><span style="color: #B392F0">IMFMediaSink</span><span style="color: #E1E4E8">::GetPresentationClock実装</span></span>
<span class="line"><span style="color: #B392F0">IMFMediaSink</span><span style="color: #E1E4E8">::SetPresentationClock実装</span></span>
<span class="line"><span style="color: #E1E4E8">MediaSinkにIMFClockStateSinkを実装</span></span>
<span class="line"><span style="color: #6A737D">// IMFClockStateSink methods</span></span>
<span class="line"><span style="color: #B392F0">STDMETHODIMP</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">OnClockPause</span><span style="color: #E1E4E8">(</span><span style="color: #B392F0">MFTIME</span><span style="color: #E1E4E8"> </span><span style="color: #FFAB70">hnsSystemTime</span><span style="color: #E1E4E8">);</span></span>
<span class="line"><span style="color: #B392F0">STDMETHODIMP</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">OnClockRestart</span><span style="color: #E1E4E8">(</span><span style="color: #B392F0">MFTIME</span><span style="color: #E1E4E8"> </span><span style="color: #FFAB70">hnsSystemTime</span><span style="color: #E1E4E8">);</span></span>
<span class="line"><span style="color: #B392F0">STDMETHODIMP</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">OnClockSetRate</span><span style="color: #E1E4E8">(</span><span style="color: #B392F0">MFTIME</span><span style="color: #E1E4E8"> </span><span style="color: #FFAB70">hnsSystemTime</span><span style="color: #E1E4E8">, </span><span style="color: #F97583">float</span><span style="color: #E1E4E8"> </span><span style="color: #FFAB70">flRate</span><span style="color: #E1E4E8">);</span></span>
<span class="line"><span style="color: #B392F0">STDMETHODIMP</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">OnClockStart</span><span style="color: #E1E4E8">(</span><span style="color: #B392F0">MFTIME</span><span style="color: #E1E4E8"> </span><span style="color: #FFAB70">hnsSystemTime</span><span style="color: #E1E4E8">, </span><span style="color: #B392F0">LONGLONG</span><span style="color: #E1E4E8"> </span><span style="color: #FFAB70">llClockStartOffset</span><span style="color: #E1E4E8">);</span></span>
<span class="line"><span style="color: #B392F0">STDMETHODIMP</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">OnClockStop</span><span style="color: #E1E4E8">(</span><span style="color: #B392F0">MFTIME</span><span style="color: #E1E4E8"> </span><span style="color: #FFAB70">hnsSystemTime</span><span style="color: #E1E4E8">);</span></span></code></pre>
<p>Data Flow
ここまでの実装で IMFSession::Start の呼び出しに応じて IMFClockStateSink::OnClockStart が呼ばれるようになった。
Data Flow</p>
<p>Media sinks use a pull model</p>
<p>MesiaSink 側からサンプルを取りに行かないといけない。</p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #e1e4e8">[1] The client sets the media types and the presentation clock. The media sink registers itself with the presentation clock to receive notifications about clock state changes.</span></span>
<span class="line"><span style="color: #e1e4e8">[2][3][4] はPreroll。ミニマムを目指す今回は省略。</span></span>
<span class="line"><span style="color: #e1e4e8">[5] The client calls IMFPresentationClock::Start to start the presentation clock.</span></span>
<span class="line"><span style="color: #e1e4e8">[6] The presentation clock notifies the media sink that the clock is starting, by calling IMFClockStateSink::OnClockStart.</span></span>
<span class="line"><span style="color: #e1e4e8">[7] To get more data, each stream sink sends MEStreamSinkRequestSample events. In response to each of these events, the client gets the next sample and calls ProcessSample. This step is repeated until the presentation ends.</span></span></code></pre>
<p>State Changes
IMFClockStateSink の実装について。</p>
<p>In addition, stream sinks must send the following events when they have completed the state transitions:</p>
<p>OnClockStart, OnClockRestart: MEStreamSinkStarted event
OnClockPause: MEStreamSinkPaused event
OnClockStop: MEStreamSinkStopped event</p>
<p>なるほど。</p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #B392F0">STDMETHODIMP</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">OnClockStart</span><span style="color: #E1E4E8">(</span><span style="color: #B392F0">MFTIME</span><span style="color: #E1E4E8"> </span><span style="color: #FFAB70">hnsSystemTime</span><span style="color: #E1E4E8">, </span><span style="color: #B392F0">LONGLONG</span><span style="color: #E1E4E8"> </span><span style="color: #FFAB70">llClockStartOffset</span><span style="color: #E1E4E8">)</span><span style="color: #F97583">override</span></span>
<span class="line"><span style="color: #E1E4E8">{</span></span>
<span class="line"><span style="color: #E1E4E8">    CAutoLock </span><span style="color: #B392F0">lock</span><span style="color: #E1E4E8">(</span><span style="color: #F97583">&#x26;</span><span style="color: #E1E4E8">m_csMediaSink);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">    HRESULT hr </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">CheckShutdown</span><span style="color: #E1E4E8">();</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #F97583">if</span><span style="color: #E1E4E8"> (</span><span style="color: #B392F0">SUCCEEDED</span><span style="color: #E1E4E8">(hr))</span></span>
<span class="line"><span style="color: #E1E4E8">    {</span></span>
<span class="line"><span style="color: #6A737D">        //</span></span>
<span class="line"><span style="color: #6A737D">        // これが必要。このあとMEStreamSinkRequestSampleを受け付ける</span></span>
<span class="line"><span style="color: #6A737D">        //</span></span>
<span class="line"><span style="color: #E1E4E8">        hr </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> m_pStream-></span><span style="color: #B392F0">QueueEvent</span><span style="color: #E1E4E8">(MEStreamSinkStarted, GUID_NULL, hr, </span><span style="color: #79B8FF">NULL</span><span style="color: #E1E4E8">);</span></span>
<span class="line"><span style="color: #E1E4E8">    }</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #F97583">if</span><span style="color: #E1E4E8"> (</span><span style="color: #B392F0">SUCCEEDED</span><span style="color: #E1E4E8">(hr))</span></span>
<span class="line"><span style="color: #E1E4E8">    {</span></span>
<span class="line"><span style="color: #E1E4E8">        hr </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> m_pStream-></span><span style="color: #B392F0">QueueEvent</span><span style="color: #E1E4E8">(MEStreamSinkRequestSample, GUID_NULL, hr, </span><span style="color: #79B8FF">NULL</span><span style="color: #E1E4E8">);</span></span>
<span class="line"><span style="color: #E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #F97583">return</span><span style="color: #E1E4E8"> hr;</span></span>
<span class="line"><span style="color: #E1E4E8">}</span></span></code></pre>
<p>ついに IMFStreamSink::ProcessSample がコールされた。
試しに下記のような実装にしてみたがこれでは Clock 無視で最速でフレームを消化してしまうのでだめ。</p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #F97583">int</span><span style="color: #E1E4E8"> m_count </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">0</span><span style="color: #E1E4E8">;</span></span>
<span class="line"><span style="color: #B392F0">STDMETHODIMP</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">ProcessSample</span><span style="color: #E1E4E8">(</span><span style="color: #F97583">**</span><span style="color: #B392F0">RPC</span><span style="color: #F97583">**</span><span style="color: #B392F0">in_opt</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">IMFSample</span><span style="color: #E1E4E8">\</span><span style="color: #F97583">*</span><span style="color: #E1E4E8"> </span><span style="color: #FFAB70">pSample</span><span style="color: #E1E4E8">)</span><span style="color: #F97583">override</span></span>
<span class="line"><span style="color: #E1E4E8">{</span></span>
<span class="line"><span style="color: #F97583">++</span><span style="color: #E1E4E8">m_count;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #F97583">auto</span><span style="color: #E1E4E8"> hr </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> S_OK;</span></span>
<span class="line"><span style="color: #E1E4E8">    hr </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">QueueEvent</span><span style="color: #E1E4E8">(MEStreamSinkRequestSample, GUID_NULL, hr, </span><span style="color: #79B8FF">NULL</span><span style="color: #E1E4E8">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #F97583">return</span><span style="color: #E1E4E8"> hr;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">}</span></span></code></pre>
<p>MEStreamSinkRequestSample をスケジューリングする</p>
<p>Scheduled Work Items</p>
<p>これを使ってみる。</p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #B392F0">BOOL</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">NeedMoreSamples</span><span style="color: #E1E4E8">(</span><span style="color: #F97583">void</span><span style="color: #E1E4E8">)</span></span>
<span class="line"><span style="color: #E1E4E8">{</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #F97583">const</span><span style="color: #E1E4E8"> DWORD cSamplesInFlight </span><span style="color: #F97583">=</span><span style="color: #6A737D"> /*m_SamplesToProcess.GetCount() +*/</span><span style="color: #E1E4E8"> m_cOutstandingSampleRequests;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #F97583">return</span><span style="color: #E1E4E8"> cSamplesInFlight </span><span style="color: #F97583">&#x3C;</span><span style="color: #E1E4E8"> SAMPLE_QUEUE_HIWATER_THRESHOLD;</span></span>
<span class="line"><span style="color: #E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #B392F0">HRESULT</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">RequestSamples</span><span style="color: #E1E4E8">(</span><span style="color: #B392F0">IMFAsyncResult</span><span style="color: #F97583">*</span><span style="color: #E1E4E8"> </span><span style="color: #FFAB70">pAsyncResult</span><span style="color: #E1E4E8">)</span></span>
<span class="line"><span style="color: #E1E4E8">{</span></span>
<span class="line"><span style="color: #E1E4E8">    HRESULT hr </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> S_OK;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #F97583">while</span><span style="color: #E1E4E8"> (</span><span style="color: #B392F0">NeedMoreSamples</span><span style="color: #E1E4E8">())</span></span>
<span class="line"><span style="color: #E1E4E8">    {</span></span>
<span class="line"><span style="color: #E1E4E8">        hr </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">CheckShutdown</span><span style="color: #E1E4E8">();</span></span>
<span class="line"><span style="color: #E1E4E8">        </span><span style="color: #F97583">if</span><span style="color: #E1E4E8"> (</span><span style="color: #B392F0">FAILED</span><span style="color: #E1E4E8">(hr))</span></span>
<span class="line"><span style="color: #E1E4E8">        {</span></span>
<span class="line"><span style="color: #E1E4E8">            </span><span style="color: #F97583">break</span><span style="color: #E1E4E8">;</span></span>
<span class="line"><span style="color: #E1E4E8">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">        m_cOutstandingSampleRequests</span><span style="color: #F97583">++</span><span style="color: #E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">        hr </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">QueueEvent</span><span style="color: #E1E4E8">(MEStreamSinkRequestSample, GUID_NULL, S_OK, </span><span style="color: #79B8FF">NULL</span><span style="color: #E1E4E8">);</span></span>
<span class="line"><span style="color: #E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #6A737D">    // 再突入</span></span>
<span class="line"><span style="color: #E1E4E8">    hr</span><span style="color: #F97583">=</span><span style="color: #B392F0">QueueRequest</span><span style="color: #E1E4E8">();</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #F97583">return</span><span style="color: #E1E4E8"> hr;</span></span>
<span class="line"><span style="color: #E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #6A737D">// 正しいRateにする必要がある</span></span>
<span class="line"><span style="color: #F97583">const</span><span style="color: #E1E4E8"> INT64 interval </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">1000</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">/</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">30</span><span style="color: #E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #B392F0">HRESULT</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">QueueRequest</span><span style="color: #E1E4E8">()</span></span>
<span class="line"><span style="color: #E1E4E8">{</span></span>
<span class="line"><span style="color: #E1E4E8">    HRESULT hr </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> S_OK;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #F97583">if</span><span style="color: #E1E4E8"> (</span><span style="color: #B392F0">SUCCEEDED</span><span style="color: #E1E4E8">(hr))</span></span>
<span class="line"><span style="color: #E1E4E8">    {</span></span>
<span class="line"><span style="color: #6A737D">        // Enqueue</span></span>
<span class="line"><span style="color: #E1E4E8">        MFWORKITEM_KEY cancelKey;</span></span>
<span class="line"><span style="color: #E1E4E8">        hr </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">MFScheduleWorkItem</span><span style="color: #E1E4E8">(</span><span style="color: #F97583">&#x26;</span><span style="color: #E1E4E8">m_WorkQueueCB, </span><span style="color: #79B8FF">nullptr</span><span style="color: #E1E4E8">, </span><span style="color: #F97583">-</span><span style="color: #E1E4E8">interval, </span><span style="color: #F97583">&#x26;</span><span style="color: #E1E4E8">cancelKey);</span></span>
<span class="line"><span style="color: #E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #F97583">return</span><span style="color: #E1E4E8"> hr;</span></span>
<span class="line"><span style="color: #E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #F97583">int</span><span style="color: #E1E4E8"> m_count </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">0</span><span style="color: #E1E4E8">;</span></span>
<span class="line"><span style="color: #B392F0">STDMETHODIMP</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">ProcessSample</span><span style="color: #E1E4E8">(</span><span style="color: #B392F0">__RPC__in_opt</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">IMFSample</span><span style="color: #F97583">*</span><span style="color: #E1E4E8"> </span><span style="color: #FFAB70">pSample</span><span style="color: #E1E4E8">)</span><span style="color: #F97583">override</span></span>
<span class="line"><span style="color: #E1E4E8">{</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #F97583">++</span><span style="color: #E1E4E8">m_count;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">    m_cOutstandingSampleRequests</span><span style="color: #F97583">--</span><span style="color: #E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #6A737D">    // do something</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #F97583">return</span><span style="color: #E1E4E8">  S_OK;</span></span>
<span class="line"><span style="color: #E1E4E8">}</span></span></code></pre>
<p>DX11VideoRenderer::CScheduler を使えばよいと思う。
だいたい仕組みがわかった。
DX11VideoRenderer から引き算して最小限の構成にする(ProcessSample が何もしない)場合、
以下の部品を残す必要がありそう。</p>
<p>Scheduler
StreamSink: IMFStreamSink, IMFMediaTypeHandler
MesiaSink: IMFMediaSink, IMFClockStateSink</p>

				</div>
			</article>
		</main>
		<footer class="footer astro-SZ7XMLTE">
    <nav class="nav astro-SZ7XMLTE">
        <div class="astro-SZ7XMLTE">2021  &copy; Copyright notice |  <a href="https://github.com/one-aalam/astro-ink" title="三次元日誌(astro)'s Github URL'" class="astro-SZ7XMLTE">三次元日誌(astro)</a>
        <script>(()=>{var e=async t=>{await(await t())()};(self.Astro||(self.Astro={})).load=e;window.dispatchEvent(new Event("astro:load"));})();</script><astro-island uid="1QEdto" component-url="/_astro/ModeLabel.e3ff75e7.js" component-export="default" renderer-url="/_astro/client.cb726945.js" props="{&quot;class&quot;:[0,&quot;astro-SZ7XMLTE&quot;]}" ssr="" client="load" opts="{&quot;name&quot;:&quot;ModeLabel&quot;,&quot;value&quot;:true}" await-children=""><span slot="dark" data-svelte-h="svelte-14ov3lc">(dark)</span></astro-island> theme on <a href="https://astro.build/" class="astro-SZ7XMLTE">Astro</a></div>
        <astro-island uid="1I86to" component-url="/_astro/NetlifyIdentity.94b8edb0.js" component-export="default" renderer-url="/_astro/client.cb726945.js" props="{&quot;class&quot;:[0,&quot;astro-SZ7XMLTE&quot;]}" ssr="" client="load" opts="{&quot;name&quot;:&quot;NetlifyIdentity&quot;,&quot;value&quot;:true}"></astro-island>
    </nav>
</footer>
	</body></html>