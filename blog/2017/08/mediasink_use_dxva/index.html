<!DOCTYPE html>
<html lang="en" class="astro-BVZIHDZO">
	<head>
		<!-- Use Google Fonts, if you don't wanna prefer a self-hosted version --><!-- <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@300;400;500;600;700&display=swap" rel="stylesheet"> --><meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>MediaSinkでDXVA</title>
<meta name="title" content="MediaSinkでDXVA">


<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="shortcut icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">

<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="msapplication-config" content="/browserconfig.xml">
<meta name="theme-color" content="#ffffff">

<!-- Open Graph Tags (Facebook) -->
<meta property="og:type" content="website">
<meta property="og:title" content="MediaSinkでDXVA">




<!-- Twitter -->
<meta property="twitter:card" content="summary_large_image">
<meta property="twitter:title" content="MediaSinkでDXVA">





<script>
  const theme = (() => {
    if (typeof localStorage !== "undefined" && localStorage.getItem("theme")) {
      return localStorage.getItem("theme");
    }
    if (window.matchMedia("(prefers-color-scheme: dark)").matches) {
      return "dark";
    }
    return "light";
  })();

  if (theme === "light") {
    document.documentElement.classList.remove("dark");
  } else {
    document.documentElement.classList.add("dark");
  }
</script>
		
	<link rel="stylesheet" href="/_astro/about.6111bb3a.css" />
<link rel="stylesheet" href="/_astro/about.657f8f57.css" />
<link rel="stylesheet" href="/_astro/about.ee60a110.css" />
<link rel="stylesheet" href="/_astro/about.dcb84f3d.css" /><script type="module" src="/_astro/hoisted.e6960f2c.js"></script></head>

	<body class="astro-BVZIHDZO">
		<header class="header astro-3EF6KSR2">
    <div class="header__logo astro-3EF6KSR2">
        <a href="/" class="avatar astro-3EF6KSR2">
            <img class="header__logo-img astro-3EF6KSR2" src="/assets/logo.svg" alt="Astro logo">
        </a>
    </div>
    <div class="header__meta flex-1 astro-3EF6KSR2">
        <h3 class="header__title dark:text-theme-dark-secondary astro-3EF6KSR2">
            <a href="" class="astro-3EF6KSR2">三次元日誌(astro)</a>
        </h3>
        <div class="header__meta-more flex astro-3EF6KSR2">
            <p class="header__desc astro-3EF6KSR2">
                Crisp, minimal, personal blog theme for Astro
            </p>
            <nav class="header__nav flex astro-3EF6KSR2">
                <ul class="header__ref-list astro-3EF6KSR2">
                    <li class="astro-3EF6KSR2">
                        <style>astro-island,astro-slot,astro-static-slot{display:contents}</style><script>(()=>{var r=(i,c,n)=>{let s=async()=>{await(await i())()},t=new IntersectionObserver(e=>{for(let o of e)if(o.isIntersecting){t.disconnect(),s();break}});for(let e of n.children)t.observe(e)};(self.Astro||(self.Astro={})).visible=r;window.dispatchEvent(new Event("astro:visible"));})();;(()=>{var d;{let p={0:t=>u(t),1:t=>l(t),2:t=>new RegExp(t),3:t=>new Date(t),4:t=>new Map(l(t)),5:t=>new Set(l(t)),6:t=>BigInt(t),7:t=>new URL(t),8:t=>new Uint8Array(t),9:t=>new Uint16Array(t),10:t=>new Uint32Array(t)},h=t=>{let[e,n]=t;return e in p?p[e](n):void 0},l=t=>t.map(h),u=t=>typeof t!="object"||t===null?t:Object.fromEntries(Object.entries(t).map(([e,n])=>[e,h(n)]));customElements.get("astro-island")||customElements.define("astro-island",(d=class extends HTMLElement{constructor(){super(...arguments);this.hydrate=async()=>{var i;if(!this.hydrator||!this.isConnected)return;let e=(i=this.parentElement)==null?void 0:i.closest("astro-island[ssr]");if(e){e.addEventListener("astro:hydrate",this.hydrate,{once:!0});return}let n=this.querySelectorAll("astro-slot"),o={},a=this.querySelectorAll("template[data-astro-template]");for(let r of a){let s=r.closest(this.tagName);s!=null&&s.isSameNode(this)&&(o[r.getAttribute("data-astro-template")||"default"]=r.innerHTML,r.remove())}for(let r of n){let s=r.closest(this.tagName);s!=null&&s.isSameNode(this)&&(o[r.getAttribute("name")||"default"]=r.innerHTML)}let c;try{c=this.hasAttribute("props")?u(JSON.parse(this.getAttribute("props"))):{}}catch(r){let s=this.getAttribute("component-url")||"<unknown>",y=this.getAttribute("component-export");throw y&&(s+=` (export ${y})`),console.error(`[hydrate] Error parsing props for component ${s}`,this.getAttribute("props"),r),r}await this.hydrator(this)(this.Component,c,o,{client:this.getAttribute("client")}),this.removeAttribute("ssr"),this.dispatchEvent(new CustomEvent("astro:hydrate"))}}connectedCallback(){!this.hasAttribute("await-children")||this.firstChild?this.childrenConnectedCallback():new MutationObserver((e,n)=>{n.disconnect(),setTimeout(()=>this.childrenConnectedCallback(),0)}).observe(this,{childList:!0})}async childrenConnectedCallback(){let e=this.getAttribute("before-hydration-url");e&&await import(e),this.start()}start(){let e=JSON.parse(this.getAttribute("opts")),n=this.getAttribute("client");if(Astro[n]===void 0){window.addEventListener(`astro:${n}`,()=>this.start(),{once:!0});return}Astro[n](async()=>{let o=this.getAttribute("renderer-url"),[a,{default:c}]=await Promise.all([import(this.getAttribute("component-url")),o?import(o):()=>()=>{}]),i=this.getAttribute("component-export")||"default";if(!i.includes("."))this.Component=a[i];else{this.Component=a;for(let r of i.split("."))this.Component=this.Component[r]}return this.hydrator=c,this.hydrate},e,this)}attributeChangedCallback(){this.hydrate()}},d.observedAttributes=["props"],d))}})();</script><astro-island uid="2iKzVC" component-url="/_astro/SearchBtn.984510f3.js" component-export="default" renderer-url="/_astro/client.cb726945.js" props="{&quot;class&quot;:[0,&quot;astro-3EF6KSR2&quot;]}" ssr="" client="visible" opts="{&quot;name&quot;:&quot;SearchBtn&quot;,&quot;value&quot;:true}" await-children=""><button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"> <path fill-rule="evenodd" clip-rule="evenodd" d="M16.2071 4.89344C19.0923 7.77862 19.3131 12.3193 16.8693 15.4578C16.8846 15.4713 16.8996 15.4854 16.9143 15.5L21.1569 19.7427C21.5474 20.1332 21.5474 20.7664 21.1569 21.1569C20.7664 21.5474 20.1332 21.5474 19.7427 21.1569L15.5 16.9143C15.4854 16.8996 15.4713 16.8846 15.4578 16.8693C12.3193 19.3131 7.77862 19.0923 4.89344 16.2071C1.76924 13.083 1.76924 8.01763 4.89344 4.89344C8.01763 1.76924 13.083 1.76924 16.2071 4.89344ZM14.7929 14.7929C17.1361 12.4498 17.1361 8.6508 14.7929 6.30765C12.4498 3.96451 8.6508 3.96451 6.30765 6.30765C3.96451 8.6508 3.96451 12.4498 6.30765 14.7929C8.6508 17.1361 12.4498 17.1361 14.7929 14.7929Z" fill="currentColor"></path></svg></button></astro-island>
                    </li>
                    <li class="astro-3EF6KSR2">
                        <a href="https://github.com/one-aalam/astro-ink" title="三次元日誌(astro)'s Github URL'" class="astro-3EF6KSR2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    
                                <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22" class="astro-3EF6KSR2"></path>
                            
</svg>
                        </a>
                    </li>
                    <li class="astro-3EF6KSR2">
                        <a href="/rss.xml" title="RSS" class="astro-3EF6KSR2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    
                                <path d="M4 11a9 9 0 0 1 9 9" class="astro-3EF6KSR2"></path>
                                <path d="M4 4a16 16 0 0 1 16 16" class="astro-3EF6KSR2"></path>
                                <circle cx="5" cy="19" r="1" class="astro-3EF6KSR2"></circle>
                            
</svg>
                        </a>
                    </li>
                    <li class="astro-3EF6KSR2">
                        <astro-island uid="h8S6z" component-url="/_astro/ModeSwitcherBtn.0ddc5d6d.js" component-export="default" renderer-url="/_astro/client.cb726945.js" props="{&quot;class&quot;:[0,&quot;astro-3EF6KSR2&quot;]}" ssr="" client="visible" opts="{&quot;name&quot;:&quot;ModeSwitcherBtn&quot;,&quot;value&quot;:true}" await-children=""><button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle> <line x1="12" y1="1" x2="12" y2="3"></line> <line x1="12" y1="21" x2="12" y2="23"></line> <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line> <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line> <line x1="1" y1="12" x2="3" y2="12"></line> <line x1="21" y1="12" x2="23" y2="12"></line> <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line> <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg></button></astro-island>
                    </li>
                </ul>
            </nav>
        </div>
    </div>
</header>
		<main class="astro-BVZIHDZO">
			<article class="astro-BVZIHDZO">
				<div class="hero-image astro-BVZIHDZO">
					
				</div>
				<div class="prose astro-BVZIHDZO">
					<div class="title astro-BVZIHDZO">
						<div class="date astro-BVZIHDZO">
							<time datetime="2017-08-28T00:00:00.000Z">
	Aug 28, 2017
</time>
							
						</div>
						<h1 class="astro-BVZIHDZO">MediaSinkでDXVA</h1>
						<hr class="astro-BVZIHDZO">
					</div>
					
	<p>MediaSink で DXVA を使うには。</p>
<p><a href="https://github.com/Microsoft/Windows-classic-samples/tree/master/Samples/DX11VideoRenderer">https://github.com/Microsoft/Windows-classic-samples/tree/master/Samples/DX11VideoRenderer</a></p>
<p>解読の後半。
DXVA が何かということについてはぼんやりとしているのだけれど、VideoSample のバッファーに D3D のテクスチャを使うということぽい。</p>
<p>DirectX Surface Buffer</p>
<p>ということは Pipeline のどこかのタイミングで CPU 上の bitmap を CreateTexture して GPU に移動するのだけど、Decoder なり Renderer なりのなるべく上流で GPU に上げた方がうれしいという話。
ID3D11Device を MediaSession に供給する
Pipeline でテクスチャをやりとりするのだからデバイスを共有しましょうと。MediaSession の場合は、レンダラがデバイスを作成して IMFDXGIDeviceManager を公開する。
公開するのは IMFGetService を通してぽい。
この辺。</p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #B392F0">HRESULT</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">DX11VideoRenderer</span><span style="color: #E1E4E8">::</span><span style="color: #B392F0">CMediaSink</span><span style="color: #E1E4E8">::</span><span style="color: #B392F0">GetService</span><span style="color: #E1E4E8">(</span><span style="color: #B392F0">__RPC__in</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">REFGUID</span><span style="color: #E1E4E8"> </span><span style="color: #FFAB70">guidService</span><span style="color: #E1E4E8">, </span><span style="color: #B392F0">__RPC__in</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">REFIID</span><span style="color: #E1E4E8"> </span><span style="color: #FFAB70">riid</span><span style="color: #E1E4E8">, </span><span style="color: #B392F0">__RPC__deref_out_opt</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">LPVOID</span><span style="color: #F97583">*</span><span style="color: #E1E4E8"> </span><span style="color: #FFAB70">ppvObject</span><span style="color: #E1E4E8">)</span></span>
<span class="line"><span style="color: #E1E4E8">{</span></span>
<span class="line"><span style="color: #E1E4E8">    HRESULT hr </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> S_OK;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #F97583">if</span><span style="color: #E1E4E8"> (guidService </span><span style="color: #F97583">==</span><span style="color: #E1E4E8"> MF_RATE_CONTROL_SERVICE)</span></span>
<span class="line"><span style="color: #E1E4E8">    {</span></span>
<span class="line"><span style="color: #E1E4E8">        hr </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">QueryInterface</span><span style="color: #E1E4E8">(riid, ppvObject);</span></span>
<span class="line"><span style="color: #E1E4E8">    }</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #F97583">else</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">if</span><span style="color: #E1E4E8"> (guidService </span><span style="color: #F97583">==</span><span style="color: #E1E4E8"> MR_VIDEO_RENDER_SERVICE)</span></span>
<span class="line"><span style="color: #E1E4E8">    {</span></span>
<span class="line"><span style="color: #E1E4E8">        hr </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> m_pPresenter-></span><span style="color: #B392F0">QueryInterface</span><span style="color: #E1E4E8">(riid, ppvObject);</span></span>
<span class="line"><span style="color: #E1E4E8">    }</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #F97583">else</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">if</span><span style="color: #E1E4E8"> (guidService </span><span style="color: #F97583">==</span><span style="color: #E1E4E8"> MR_VIDEO_ACCELERATION_SERVICE)</span></span>
<span class="line"><span style="color: #E1E4E8">    {</span></span>
<span class="line"><span style="color: #6A737D">        // ここからIMFDXGIDeviceManagerを得る</span></span>
<span class="line"><span style="color: #E1E4E8">        hr </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> m_pPresenter-></span><span style="color: #B392F0">GetService</span><span style="color: #E1E4E8">(guidService, riid, ppvObject);</span></span>
<span class="line"><span style="color: #E1E4E8">    }</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #F97583">else</span></span>
<span class="line"><span style="color: #E1E4E8">    {</span></span>
<span class="line"><span style="color: #E1E4E8">        hr </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> MF_E_UNSUPPORTED_SERVICE;</span></span>
<span class="line"><span style="color: #E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #F97583">return</span><span style="color: #E1E4E8"> hr;</span></span>
<span class="line"><span style="color: #E1E4E8">}</span></span></code></pre>
<p>実験
まだ IMFGetService を実装していない VideoRenderer で、
ProcessSample に入ってくる IMFSample から IMFDXGIBuffer が取得できるか試してみよう。</p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #E1E4E8">DWORD cBuffers </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">0</span><span style="color: #E1E4E8">;</span></span>
<span class="line"><span style="color: #F97583">auto</span><span style="color: #E1E4E8"> hr </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> pSample-></span><span style="color: #B392F0">GetBufferCount</span><span style="color: #E1E4E8">(</span><span style="color: #F97583">&#x26;</span><span style="color: #E1E4E8">cBuffers);</span></span>
<span class="line"><span style="color: #F97583">if</span><span style="color: #E1E4E8"> (</span><span style="color: #B392F0">FAILED</span><span style="color: #E1E4E8">(hr))</span></span>
<span class="line"><span style="color: #E1E4E8">{</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #F97583">return</span><span style="color: #E1E4E8"> hr;</span></span>
<span class="line"><span style="color: #E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #B392F0">Microsoft</span><span style="color: #E1E4E8">::</span><span style="color: #B392F0">WRL</span><span style="color: #E1E4E8">::ComPtr</span><span style="color: #F97583">&#x3C;</span><span style="color: #E1E4E8">IMFMediaBuffer</span><span style="color: #F97583">></span><span style="color: #E1E4E8"> pBuffer;</span></span>
<span class="line"><span style="color: #F97583">if</span><span style="color: #E1E4E8"> (</span><span style="color: #79B8FF">1</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">==</span><span style="color: #E1E4E8"> cBuffers)</span></span>
<span class="line"><span style="color: #E1E4E8">{</span></span>
<span class="line"><span style="color: #E1E4E8">    hr </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> pSample-></span><span style="color: #B392F0">GetBufferByIndex</span><span style="color: #E1E4E8">(</span><span style="color: #79B8FF">0</span><span style="color: #E1E4E8">, </span><span style="color: #F97583">&#x26;</span><span style="color: #E1E4E8">pBuffer);</span></span>
<span class="line"><span style="color: #E1E4E8">}</span></span>
<span class="line"><span style="color: #F97583">else</span></span>
<span class="line"><span style="color: #E1E4E8">{</span></span>
<span class="line"><span style="color: #E1E4E8">    hr </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> pSample-></span><span style="color: #B392F0">ConvertToContiguousBuffer</span><span style="color: #E1E4E8">(</span><span style="color: #F97583">&#x26;</span><span style="color: #E1E4E8">pBuffer);</span></span>
<span class="line"><span style="color: #E1E4E8">}</span></span>
<span class="line"><span style="color: #F97583">if</span><span style="color: #E1E4E8"> (</span><span style="color: #B392F0">FAILED</span><span style="color: #E1E4E8">(hr))</span></span>
<span class="line"><span style="color: #E1E4E8">{</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #F97583">return</span><span style="color: #E1E4E8"> hr;</span></span>
<span class="line"><span style="color: #E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #B392F0">Microsoft</span><span style="color: #E1E4E8">::</span><span style="color: #B392F0">WRL</span><span style="color: #E1E4E8">::ComPtr</span><span style="color: #F97583">&#x3C;</span><span style="color: #E1E4E8">IMFDXGIBuffer</span><span style="color: #F97583">></span><span style="color: #E1E4E8"> pDXGIBuffer;</span></span>
<span class="line"><span style="color: #E1E4E8">hr </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> pBuffer.</span><span style="color: #B392F0">As</span><span style="color: #E1E4E8">(</span><span style="color: #F97583">&#x26;</span><span style="color: #E1E4E8">pDXGIBuffer);</span></span>
<span class="line"><span style="color: #F97583">if</span><span style="color: #E1E4E8"> (</span><span style="color: #B392F0">FAILED</span><span style="color: #E1E4E8">(hr))</span></span>
<span class="line"><span style="color: #E1E4E8">{</span></span>
<span class="line"><span style="color: #6A737D">    // ここに来た</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #F97583">return</span><span style="color: #E1E4E8"> hr;</span></span>
<span class="line"><span style="color: #E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #B392F0">Microsoft</span><span style="color: #E1E4E8">::</span><span style="color: #B392F0">WRL</span><span style="color: #E1E4E8">::ComPtr</span><span style="color: #F97583">&#x3C;</span><span style="color: #E1E4E8">ID3D11Texture2D</span><span style="color: #F97583">></span><span style="color: #E1E4E8"> pTexture2D;</span></span>
<span class="line"><span style="color: #E1E4E8">hr </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> pDXGIBuffer-></span><span style="color: #B392F0">GetResource</span><span style="color: #E1E4E8">(</span><span style="color: #B392F0">IID_PPV_ARGS</span><span style="color: #E1E4E8">(</span><span style="color: #F97583">&#x26;</span><span style="color: #E1E4E8">pTexture2D));</span></span>
<span class="line"><span style="color: #F97583">if</span><span style="color: #E1E4E8"> (</span><span style="color: #B392F0">FAILED</span><span style="color: #E1E4E8">(hr))</span></span>
<span class="line"><span style="color: #E1E4E8">{</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #F97583">return</span><span style="color: #E1E4E8"> hr;</span></span>
<span class="line"><span style="color: #E1E4E8">}</span></span></code></pre>
<p>実験２
StreamSink に IMFGetService を実装した。</p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #6A737D">// IMFGetService</span></span>
<span class="line"><span style="color: #B392F0">STDMETHODIMP</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">GetService</span><span style="color: #E1E4E8">(</span><span style="color: #B392F0">__RPC__in</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">REFGUID</span><span style="color: #E1E4E8"> </span><span style="color: #FFAB70">guidService</span><span style="color: #E1E4E8">, </span><span style="color: #B392F0">__RPC__in</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">REFIID</span><span style="color: #E1E4E8"> </span><span style="color: #FFAB70">riid</span><span style="color: #E1E4E8">, </span><span style="color: #B392F0">__RPC__deref_out_opt</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">LPVOID</span><span style="color: #F97583">*</span><span style="color: #E1E4E8"> </span><span style="color: #FFAB70">ppvObject</span><span style="color: #E1E4E8">)</span><span style="color: #F97583">override</span></span>
<span class="line"><span style="color: #E1E4E8">{</span></span>
<span class="line"><span style="color: #E1E4E8">    HRESULT hr </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> S_OK;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #F97583">if</span><span style="color: #E1E4E8"> (guidService </span><span style="color: #F97583">==</span><span style="color: #E1E4E8"> MR_VIDEO_ACCELERATION_SERVICE)</span></span>
<span class="line"><span style="color: #E1E4E8">    {</span></span>
<span class="line"><span style="color: #E1E4E8">        </span><span style="color: #F97583">if</span><span style="color: #E1E4E8"> (riid </span><span style="color: #F97583">==</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">__uuidof</span><span style="color: #E1E4E8">(IMFDXGIDeviceManager))</span></span>
<span class="line"><span style="color: #E1E4E8">        {</span></span>
<span class="line"><span style="color: #E1E4E8">            </span><span style="color: #F97583">if</span><span style="color: #E1E4E8"> (</span><span style="color: #79B8FF">NULL</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">!=</span><span style="color: #E1E4E8"> m_pDXGIManager)</span></span>
<span class="line"><span style="color: #E1E4E8">            {</span></span>
<span class="line"><span style="color: #E1E4E8">                </span><span style="color: #F97583">*</span><span style="color: #E1E4E8">ppvObject </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> (</span><span style="color: #F97583">void*</span><span style="color: #E1E4E8">) </span><span style="color: #F97583">static_cast&#x3C;</span><span style="color: #E1E4E8">IUnknown</span><span style="color: #F97583">*></span><span style="color: #E1E4E8">(m_pDXGIManager);</span></span>
<span class="line"><span style="color: #E1E4E8">                ((IUnknown</span><span style="color: #F97583">*</span><span style="color: #E1E4E8">)</span><span style="color: #F97583">*</span><span style="color: #E1E4E8">ppvObject)-></span><span style="color: #B392F0">AddRef</span><span style="color: #E1E4E8">();</span></span>
<span class="line"><span style="color: #E1E4E8">            }</span></span>
<span class="line"><span style="color: #E1E4E8">            </span><span style="color: #F97583">else</span></span>
<span class="line"><span style="color: #E1E4E8">            {</span></span>
<span class="line"><span style="color: #E1E4E8">                hr </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> E_NOINTERFACE;</span></span>
<span class="line"><span style="color: #E1E4E8">            }</span></span>
<span class="line"><span style="color: #E1E4E8">        }</span></span>
<span class="line"><span style="color: #E1E4E8">        </span><span style="color: #F97583">else</span></span>
<span class="line"><span style="color: #E1E4E8">        {</span></span>
<span class="line"><span style="color: #E1E4E8">            hr </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> E_NOINTERFACE;</span></span>
<span class="line"><span style="color: #E1E4E8">        }</span></span>
<span class="line"><span style="color: #E1E4E8">    }</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #F97583">else</span></span>
<span class="line"><span style="color: #E1E4E8">    {</span></span>
<span class="line"><span style="color: #E1E4E8">        hr </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> MF_E_UNSUPPORTED_SERVICE;</span></span>
<span class="line"><span style="color: #E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #F97583">return</span><span style="color: #E1E4E8"> hr;</span></span>
<span class="line"><span style="color: #E1E4E8">}</span></span></code></pre>
<p>IMFSample から ID3D11Texture2D を取得できた。
上流が、DXVA 化されて Sample のバッファがテクスチャになった。
どんなテクスチャなのか
ArraySize = 13
Format = DXGI_FORMAT_NV12</p>
<p>中身がよくわからぬ。
Decode された yuv フレームを Swapchain にコピーする</p>
<p>deinterlace
YUV To RGB
サイズ調整</p>
<p>等をしてデコード済みのフレームを RGB 画像にする工程。
２種類の実装がある。</p>
<p><a href="https://github.com/Microsoft/Windows-classic-samples/blob/master/Samples/DX11VideoRenderer/cpp/Presenter.cpp">https://github.com/Microsoft/Windows-classic-samples/blob/master/Samples/DX11VideoRenderer/cpp/Presenter.cpp</a></p>
<p>の以下の部分。</p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #F97583">if</span><span style="color: #E1E4E8"> (m_useXVP)</span></span>
<span class="line"><span style="color: #E1E4E8">{</span></span>
<span class="line"><span style="color: #E1E4E8">    BOOL bInputFrameUsed </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> FALSE;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">    hr </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">ProcessFrameUsingXVP</span><span style="color: #E1E4E8">( pCurrentType, pSample, pTexture2D, rcDest, ppOutputSample, </span><span style="color: #F97583">&#x26;</span><span style="color: #E1E4E8">bInputFrameUsed );</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #F97583">if</span><span style="color: #E1E4E8"> (</span><span style="color: #B392F0">SUCCEEDED</span><span style="color: #E1E4E8">(hr) </span><span style="color: #F97583">&#x26;&#x26;</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">!</span><span style="color: #E1E4E8">bInputFrameUsed)</span></span>
<span class="line"><span style="color: #E1E4E8">    {</span></span>
<span class="line"><span style="color: #E1E4E8">        </span><span style="color: #F97583">*</span><span style="color: #E1E4E8">pbProcessAgain </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> TRUE;</span></span>
<span class="line"><span style="color: #E1E4E8">    }</span></span>
<span class="line"><span style="color: #E1E4E8">}</span></span>
<span class="line"><span style="color: #F97583">else</span></span>
<span class="line"><span style="color: #E1E4E8">{</span></span>
<span class="line"><span style="color: #E1E4E8">    hr </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">ProcessFrameUsingD3D11</span><span style="color: #E1E4E8">( pTexture2D, pEVTexture2D, dwViewIndex, dwEVViewIndex, rcDest, </span><span style="color: #F97583">*</span><span style="color: #E1E4E8">punInterlaceMode, ppOutputSample );</span></span>
<span class="line"></span>
<span class="line"><span style="color: #6A737D">    // 省略</span></span>
<span class="line"><span style="color: #E1E4E8">}</span></span></code></pre>
<p>どちらでもだいたい同じ動きになると思う。
ProcessFrameUsingXVP</p>
<p>Video Processor MFT</p>
<p>初期化時に IDXGIDeviceManager を直接渡して DXVA を有効にしている。</p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #E1E4E8">hr </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">CoCreateInstance</span><span style="color: #E1E4E8">(CLSID_VideoProcessorMFT, </span><span style="color: #79B8FF">nullptr</span><span style="color: #E1E4E8">, CLSCTX_INPROC_SERVER, IID_IMFTransform, (</span><span style="color: #F97583">void**</span><span style="color: #E1E4E8">)</span><span style="color: #F97583">&#x26;</span><span style="color: #E1E4E8">m_pXVP);</span></span>
<span class="line"><span style="color: #F97583">if</span><span style="color: #E1E4E8"> (</span><span style="color: #B392F0">FAILED</span><span style="color: #E1E4E8">(hr))</span></span>
<span class="line"><span style="color: #E1E4E8">{</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #F97583">break</span><span style="color: #E1E4E8">;</span></span>
<span class="line"><span style="color: #E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #6A737D">// MFTにDirectXを渡す</span></span>
<span class="line"><span style="color: #E1E4E8">hr </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> m_pXVP-></span><span style="color: #B392F0">ProcessMessage</span><span style="color: #E1E4E8">(MFT_MESSAGE_SET_D3D_MANAGER, </span><span style="color: #B392F0">ULONG_PTR</span><span style="color: #E1E4E8">(m_pDXGIManager));</span></span>
<span class="line"><span style="color: #F97583">if</span><span style="color: #E1E4E8"> (</span><span style="color: #B392F0">FAILED</span><span style="color: #E1E4E8">(hr))</span></span>
<span class="line"><span style="color: #E1E4E8">{</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #F97583">break</span><span style="color: #E1E4E8">;</span></span>
<span class="line"><span style="color: #E1E4E8">}</span></span></code></pre>
<p>Texture の入ったサンプルを処理して、Texture の入ったサンプルに出力できる。
ProcessFrameUsingD3D11
D3D11VideoDevice を使う。
こっちの方が手順が長くて大変。
おそらく、VideoProcessorMFT は D3D11VideoDevice を使って実装していてこちらの方がローレベルなのであろう。
Decode
API の説明としてはこれ。</p>
<p>Supporting Direct3D 11 Video Decoding in Media Foundation</p>
<p>DX11VideoRenderer サンプルでは、直接使っていない。
Video Processing
DX11VideoRenderer サンプルでは、D3D11VideoDevice を最後の色変換等で使っている。</p>
<p>DXVA Video Processing</p>
<p>Video Process Blit</p>
<p>DXVA2.0+D3D9 のドキュメントぽい。
D3D11 ではこの関数。</p>
<p><code>D3D11VideoContext::VideoProcessorBlt</code></p>

				</div>
			</article>
		</main>
		<footer class="footer astro-SZ7XMLTE">
    <nav class="nav astro-SZ7XMLTE">
        <div class="astro-SZ7XMLTE">2021  &copy; Copyright notice |  <a href="https://github.com/one-aalam/astro-ink" title="三次元日誌(astro)'s Github URL'" class="astro-SZ7XMLTE">三次元日誌(astro)</a>
        <script>(()=>{var e=async t=>{await(await t())()};(self.Astro||(self.Astro={})).load=e;window.dispatchEvent(new Event("astro:load"));})();</script><astro-island uid="1QEdto" component-url="/_astro/ModeLabel.e3ff75e7.js" component-export="default" renderer-url="/_astro/client.cb726945.js" props="{&quot;class&quot;:[0,&quot;astro-SZ7XMLTE&quot;]}" ssr="" client="load" opts="{&quot;name&quot;:&quot;ModeLabel&quot;,&quot;value&quot;:true}" await-children=""><span slot="dark" data-svelte-h="svelte-14ov3lc">(dark)</span></astro-island> theme on <a href="https://astro.build/" class="astro-SZ7XMLTE">Astro</a></div>
        <astro-island uid="1I86to" component-url="/_astro/NetlifyIdentity.94b8edb0.js" component-export="default" renderer-url="/_astro/client.cb726945.js" props="{&quot;class&quot;:[0,&quot;astro-SZ7XMLTE&quot;]}" ssr="" client="load" opts="{&quot;name&quot;:&quot;NetlifyIdentity&quot;,&quot;value&quot;:true}"></astro-island>
    </nav>
</footer>
	</body></html>