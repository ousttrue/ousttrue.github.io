<!DOCTYPE html>
<html lang="en" class="astro-BVZIHDZO">
	<head>
		<!-- Use Google Fonts, if you don't wanna prefer a self-hosted version --><!-- <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@300;400;500;600;700&display=swap" rel="stylesheet"> --><meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>PythonでImGuiする</title>
<meta name="title" content="PythonでImGuiする">


<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="shortcut icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">

<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="msapplication-config" content="/browserconfig.xml">
<meta name="theme-color" content="#ffffff">

<!-- Open Graph Tags (Facebook) -->
<meta property="og:type" content="website">
<meta property="og:title" content="PythonでImGuiする">




<!-- Twitter -->
<meta property="twitter:card" content="summary_large_image">
<meta property="twitter:title" content="PythonでImGuiする">





<script>
  const theme = (() => {
    if (typeof localStorage !== "undefined" && localStorage.getItem("theme")) {
      return localStorage.getItem("theme");
    }
    if (window.matchMedia("(prefers-color-scheme: dark)").matches) {
      return "dark";
    }
    return "light";
  })();

  if (theme === "light") {
    document.documentElement.classList.remove("dark");
  } else {
    document.documentElement.classList.add("dark");
  }
</script>
		
	<link rel="stylesheet" href="/_astro/about.6111bb3a.css" />
<link rel="stylesheet" href="/_astro/about.657f8f57.css" />
<link rel="stylesheet" href="/_astro/about.ee60a110.css" />
<link rel="stylesheet" href="/_astro/about.dcb84f3d.css" /><script type="module" src="/_astro/hoisted.e6960f2c.js"></script></head>

	<body class="astro-BVZIHDZO">
		<header class="header astro-3EF6KSR2">
    <div class="header__logo astro-3EF6KSR2">
        <a href="/" class="avatar astro-3EF6KSR2">
            <img class="header__logo-img astro-3EF6KSR2" src="/assets/logo.svg" alt="Astro logo">
        </a>
    </div>
    <div class="header__meta flex-1 astro-3EF6KSR2">
        <h3 class="header__title dark:text-theme-dark-secondary astro-3EF6KSR2">
            <a href="" class="astro-3EF6KSR2">三次元日誌(astro)</a>
        </h3>
        <div class="header__meta-more flex astro-3EF6KSR2">
            <p class="header__desc astro-3EF6KSR2">
                Crisp, minimal, personal blog theme for Astro
            </p>
            <nav class="header__nav flex astro-3EF6KSR2">
                <ul class="header__ref-list astro-3EF6KSR2">
                    <li class="astro-3EF6KSR2">
                        <style>astro-island,astro-slot,astro-static-slot{display:contents}</style><script>(()=>{var r=(i,c,n)=>{let s=async()=>{await(await i())()},t=new IntersectionObserver(e=>{for(let o of e)if(o.isIntersecting){t.disconnect(),s();break}});for(let e of n.children)t.observe(e)};(self.Astro||(self.Astro={})).visible=r;window.dispatchEvent(new Event("astro:visible"));})();;(()=>{var d;{let p={0:t=>u(t),1:t=>l(t),2:t=>new RegExp(t),3:t=>new Date(t),4:t=>new Map(l(t)),5:t=>new Set(l(t)),6:t=>BigInt(t),7:t=>new URL(t),8:t=>new Uint8Array(t),9:t=>new Uint16Array(t),10:t=>new Uint32Array(t)},h=t=>{let[e,n]=t;return e in p?p[e](n):void 0},l=t=>t.map(h),u=t=>typeof t!="object"||t===null?t:Object.fromEntries(Object.entries(t).map(([e,n])=>[e,h(n)]));customElements.get("astro-island")||customElements.define("astro-island",(d=class extends HTMLElement{constructor(){super(...arguments);this.hydrate=async()=>{var i;if(!this.hydrator||!this.isConnected)return;let e=(i=this.parentElement)==null?void 0:i.closest("astro-island[ssr]");if(e){e.addEventListener("astro:hydrate",this.hydrate,{once:!0});return}let n=this.querySelectorAll("astro-slot"),o={},a=this.querySelectorAll("template[data-astro-template]");for(let r of a){let s=r.closest(this.tagName);s!=null&&s.isSameNode(this)&&(o[r.getAttribute("data-astro-template")||"default"]=r.innerHTML,r.remove())}for(let r of n){let s=r.closest(this.tagName);s!=null&&s.isSameNode(this)&&(o[r.getAttribute("name")||"default"]=r.innerHTML)}let c;try{c=this.hasAttribute("props")?u(JSON.parse(this.getAttribute("props"))):{}}catch(r){let s=this.getAttribute("component-url")||"<unknown>",y=this.getAttribute("component-export");throw y&&(s+=` (export ${y})`),console.error(`[hydrate] Error parsing props for component ${s}`,this.getAttribute("props"),r),r}await this.hydrator(this)(this.Component,c,o,{client:this.getAttribute("client")}),this.removeAttribute("ssr"),this.dispatchEvent(new CustomEvent("astro:hydrate"))}}connectedCallback(){!this.hasAttribute("await-children")||this.firstChild?this.childrenConnectedCallback():new MutationObserver((e,n)=>{n.disconnect(),setTimeout(()=>this.childrenConnectedCallback(),0)}).observe(this,{childList:!0})}async childrenConnectedCallback(){let e=this.getAttribute("before-hydration-url");e&&await import(e),this.start()}start(){let e=JSON.parse(this.getAttribute("opts")),n=this.getAttribute("client");if(Astro[n]===void 0){window.addEventListener(`astro:${n}`,()=>this.start(),{once:!0});return}Astro[n](async()=>{let o=this.getAttribute("renderer-url"),[a,{default:c}]=await Promise.all([import(this.getAttribute("component-url")),o?import(o):()=>()=>{}]),i=this.getAttribute("component-export")||"default";if(!i.includes("."))this.Component=a[i];else{this.Component=a;for(let r of i.split("."))this.Component=this.Component[r]}return this.hydrator=c,this.hydrate},e,this)}attributeChangedCallback(){this.hydrate()}},d.observedAttributes=["props"],d))}})();</script><astro-island uid="2iKzVC" component-url="/_astro/SearchBtn.984510f3.js" component-export="default" renderer-url="/_astro/client.cb726945.js" props="{&quot;class&quot;:[0,&quot;astro-3EF6KSR2&quot;]}" ssr="" client="visible" opts="{&quot;name&quot;:&quot;SearchBtn&quot;,&quot;value&quot;:true}" await-children=""><button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"> <path fill-rule="evenodd" clip-rule="evenodd" d="M16.2071 4.89344C19.0923 7.77862 19.3131 12.3193 16.8693 15.4578C16.8846 15.4713 16.8996 15.4854 16.9143 15.5L21.1569 19.7427C21.5474 20.1332 21.5474 20.7664 21.1569 21.1569C20.7664 21.5474 20.1332 21.5474 19.7427 21.1569L15.5 16.9143C15.4854 16.8996 15.4713 16.8846 15.4578 16.8693C12.3193 19.3131 7.77862 19.0923 4.89344 16.2071C1.76924 13.083 1.76924 8.01763 4.89344 4.89344C8.01763 1.76924 13.083 1.76924 16.2071 4.89344ZM14.7929 14.7929C17.1361 12.4498 17.1361 8.6508 14.7929 6.30765C12.4498 3.96451 8.6508 3.96451 6.30765 6.30765C3.96451 8.6508 3.96451 12.4498 6.30765 14.7929C8.6508 17.1361 12.4498 17.1361 14.7929 14.7929Z" fill="currentColor"></path></svg></button></astro-island>
                    </li>
                    <li class="astro-3EF6KSR2">
                        <a href="https://github.com/one-aalam/astro-ink" title="三次元日誌(astro)'s Github URL'" class="astro-3EF6KSR2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    
                                <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22" class="astro-3EF6KSR2"></path>
                            
</svg>
                        </a>
                    </li>
                    <li class="astro-3EF6KSR2">
                        <a href="/rss.xml" title="RSS" class="astro-3EF6KSR2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    
                                <path d="M4 11a9 9 0 0 1 9 9" class="astro-3EF6KSR2"></path>
                                <path d="M4 4a16 16 0 0 1 16 16" class="astro-3EF6KSR2"></path>
                                <circle cx="5" cy="19" r="1" class="astro-3EF6KSR2"></circle>
                            
</svg>
                        </a>
                    </li>
                    <li class="astro-3EF6KSR2">
                        <astro-island uid="h8S6z" component-url="/_astro/ModeSwitcherBtn.0ddc5d6d.js" component-export="default" renderer-url="/_astro/client.cb726945.js" props="{&quot;class&quot;:[0,&quot;astro-3EF6KSR2&quot;]}" ssr="" client="visible" opts="{&quot;name&quot;:&quot;ModeSwitcherBtn&quot;,&quot;value&quot;:true}" await-children=""><button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle> <line x1="12" y1="1" x2="12" y2="3"></line> <line x1="12" y1="21" x2="12" y2="23"></line> <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line> <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line> <line x1="1" y1="12" x2="3" y2="12"></line> <line x1="21" y1="12" x2="23" y2="12"></line> <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line> <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg></button></astro-island>
                    </li>
                </ul>
            </nav>
        </div>
    </div>
</header>
		<main class="astro-BVZIHDZO">
			<article class="astro-BVZIHDZO">
				<div class="hero-image astro-BVZIHDZO">
					
				</div>
				<div class="prose astro-BVZIHDZO">
					<div class="title astro-BVZIHDZO">
						<div class="date astro-BVZIHDZO">
							<time datetime="2017-07-31T00:00:00.000Z">
	Jul 31, 2017
</time>
							
						</div>
						<h1 class="astro-BVZIHDZO">PythonでImGuiする</h1>
						<hr class="astro-BVZIHDZO">
					</div>
					
	<p>Python で ImGui するのがよさげな気がしたのでやってみた。</p>
<p>ImGui は c ではなく c++のライブラリなので Python の ctypes は使えぬ。
本家の Bindings の項に２つの python binding が紹介されている。</p>
<p><a href="https://github.com/chromy/cyimgui">https://github.com/chromy/cyimgui</a>
<a href="https://github.com/swistakm/pyimgui">https://github.com/swistakm/pyimgui</a></p>
<p>なんかうまくいかなった。
ならば swig で自前でラップすればええやんということで、やってみる。</p>
<p><a href="https://github.com/ousttrue/SwigImGui">https://github.com/ousttrue/SwigImGui</a></p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #e1e4e8">Swig</span></span>
<span class="line"><span style="color: #e1e4e8">%module swig_imgui</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">%{</span></span>
<span class="line"><span style="color: #e1e4e8">/* Includes the header in the wrapper code */</span></span>
<span class="line"><span style="color: #e1e4e8">#include "imgui/imgui.h"</span></span>
<span class="line"><span style="color: #e1e4e8">%}</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">/* Parse the header file to generate wrappers */</span></span>
<span class="line"><span style="color: #e1e4e8">%include "imgui/imgui.h"</span></span></code></pre>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #e1e4e8">> swig -python -c++ imgui.i</span></span></code></pre>
<p>imgui_wrap.cxx と”swig_imgui.py”を生成した。
imgui_wrap.cxx から_swig_imgui.pyd をビルドする。
ビルドしてみる
python の NativeModule をビルドするので setup.py を書いてみる。</p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #F97583">from</span><span style="color: #E1E4E8"> distutils.core </span><span style="color: #F97583">import</span><span style="color: #E1E4E8"> setup, Extension</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">imgui_module </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> Extension(</span><span style="color: #9ECBFF">'_swig_imgui'</span><span style="color: #E1E4E8">,</span></span>
<span class="line"><span style="color: #E1E4E8">        </span><span style="color: #FFAB70">sources</span><span style="color: #F97583">=</span><span style="color: #E1E4E8">[</span></span>
<span class="line"><span style="color: #E1E4E8">            </span><span style="color: #9ECBFF">'imgui_wrap.cxx'</span><span style="color: #E1E4E8">,</span></span>
<span class="line"><span style="color: #E1E4E8">            </span><span style="color: #9ECBFF">'imgui/imgui.cpp'</span><span style="color: #E1E4E8">,</span></span>
<span class="line"><span style="color: #E1E4E8">            </span><span style="color: #9ECBFF">'imgui/imgui_draw.cpp'</span><span style="color: #E1E4E8">,</span></span>
<span class="line"><span style="color: #E1E4E8">            </span><span style="color: #9ECBFF">'imgui/imgui_demo.cpp'</span><span style="color: #E1E4E8">,</span></span>
<span class="line"><span style="color: #E1E4E8">            ],</span></span>
<span class="line"><span style="color: #E1E4E8">        )</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">setup (</span><span style="color: #FFAB70">name</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">'swig_imgeui'</span><span style="color: #E1E4E8">,</span></span>
<span class="line"><span style="color: #E1E4E8">        </span><span style="color: #FFAB70">version</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">'0.1'</span><span style="color: #E1E4E8">,</span></span>
<span class="line"><span style="color: #E1E4E8">        </span><span style="color: #FFAB70">author</span><span style="color: #E1E4E8">      </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">"ousttrue"</span><span style="color: #E1E4E8">,</span></span>
<span class="line"><span style="color: #E1E4E8">        </span><span style="color: #FFAB70">description</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">"""imgui wrapper using swig"""</span><span style="color: #E1E4E8">,</span></span>
<span class="line"><span style="color: #E1E4E8">        </span><span style="color: #FFAB70">ext_modules</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> [imgui_module],</span></span>
<span class="line"><span style="color: #E1E4E8">        </span><span style="color: #FFAB70">py_modules</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> [</span><span style="color: #9ECBFF">"imgui"</span><span style="color: #E1E4E8">],</span></span>
<span class="line"><span style="color: #E1E4E8">        )</span></span></code></pre>
<p>ビルド。</p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #e1e4e8">> C:\python36\python.exe setup.py build</span></span></code></pre>
<p>ビルドしてみるとエラー。</p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #e1e4e8">swigimgui\imgui_wrap.cxx(26285): error C2668: 'ImGui::TreePush': オーバーロード関数の呼び出しを解決することができません。(新機能 ; ヘルプを参照)</span></span>
<span class="line"><span style="color: #e1e4e8">swigimgui\imgui\imgui.h(338): note: 'void ImGui::TreePush(const void *)' の可能性があります</span></span>
<span class="line"><span style="color: #e1e4e8">swigimgui\imgui\imgui.h(337): note: または 'void ImGui::TreePush(const char *)'</span></span>
<span class="line"><span style="color: #e1e4e8">swigimgui\imgui_wrap.cxx(26285): note: 引数リスト '()' を一致させようとしているとき</span></span></code></pre>
<p>ImGui::TreePush();が TreePush(const char* str_id = NULL)と TreePush(const void* ptr_id = NULL)でどちらなのか解決できない。
修正。</p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #e1e4e8">%module swig_imgui</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">%{</span></span>
<span class="line"><span style="color: #e1e4e8">/* Includes the header in the wrapper code */</span></span>
<span class="line"><span style="color: #e1e4e8">#include "imgui/imgui.h"</span></span>
<span class="line"><span style="color: #e1e4e8">%}</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">%ignore ImGui::TreePush();</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">/* Parse the header file to generate wrappers */</span></span>
<span class="line"><span style="color: #e1e4e8">%include "imgui/imgui.h"</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">%include "imgui/imgui.h"の前に%ignoreを記述することで、</span></span></code></pre>
<p>引数無しの TreePush を作らないようにした。
これでコンパイルは通った。
python36_d.lib にリンクしない
python36_d.lib ではなあく python36.lib にリンクする。
imgui.i の上の方に以下の記述を追加する。</p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #e1e4e8">%begin %{</span></span>
<span class="line"><span style="color: #e1e4e8">#ifdef \_MSC_VER</span></span>
<span class="line"><span style="color: #e1e4e8">#define SWIG_PYTHON_INTERPRETER_NO_DEBUG</span></span>
<span class="line"><span style="color: #e1e4e8">#endif</span></span>
<span class="line"><span style="color: #e1e4e8">%}</span></span></code></pre>
<p>実行してみよう</p>
<p><a href="https://github.com/ocornut/imgui/tree/master/examples/sdl_opengl3_example">https://github.com/ocornut/imgui/tree/master/examples/sdl_opengl3_example</a></p>
<p>をまるっと python に移植してみる。
ここからが長くなるで。</p>
<h1 id="imgui---standalone-example-application-for-sdl2--opengl">ImGui - standalone example application for SDL2 + OpenGL</h1>
<h1 id="if-you-are-new-to-imgui-see-examplesreadmetxt-and-documentation-at-the-top-of-imguicpp">If you are new to ImGui, see examples/README.txt and documentation at the top of imgui.cpp.</h1>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #F97583">import</span><span style="color: #E1E4E8"> os</span></span>
<span class="line"><span style="color: #F97583">import</span><span style="color: #E1E4E8"> sys</span></span>
<span class="line"></span>
<span class="line"><span style="color: #F97583">if</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">not</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">'PYSDL2_DLL_PATH'</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">in</span><span style="color: #E1E4E8"> os.environ:</span></span>
<span class="line"><span style="color: #E1E4E8">os.environ[</span><span style="color: #9ECBFF">'PYSDL2_DLL_PATH'</span><span style="color: #E1E4E8">]</span><span style="color: #F97583">=</span><span style="color: #E1E4E8">os.environ[</span><span style="color: #9ECBFF">'VCPKG_DIR'</span><span style="color: #E1E4E8">] </span><span style="color: #F97583">+</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">'/installed/x64-windows/bin'</span></span>
<span class="line"><span style="color: #F97583">from</span><span style="color: #E1E4E8"> sdl2 </span><span style="color: #F97583">import</span><span style="color: #E1E4E8"> \</span><span style="color: #FDAEB7; font-style: italic">*</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">python_dir</span><span style="color: #F97583">=</span><span style="color: #E1E4E8">os.path.dirname(sys.executable)</span></span>
<span class="line"><span style="color: #E1E4E8">os.environ[</span><span style="color: #9ECBFF">'PATH'</span><span style="color: #E1E4E8">]</span><span style="color: #F97583">+=</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">';'</span><span style="color: #F97583">+</span><span style="color: #E1E4E8">python_dir)</span></span>
<span class="line"><span style="color: #F97583">import</span><span style="color: #E1E4E8"> swig_imgui </span><span style="color: #F97583">as</span><span style="color: #E1E4E8"> imgui</span></span>
<span class="line"></span>
<span class="line"><span style="color: #F97583">import</span><span style="color: #E1E4E8"> ImplSdlGL3</span></span>
<span class="line"></span>
<span class="line"><span style="color: #F97583">def</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">main</span><span style="color: #E1E4E8">():</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #6A737D"># Setup SDL</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #F97583">if</span><span style="color: #E1E4E8"> (SDL_Init(</span><span style="color: #79B8FF">SDL_INIT_VIDEO</span><span style="color: #F97583">|</span><span style="color: #79B8FF">SDL_INIT_TIMER</span><span style="color: #E1E4E8">) </span><span style="color: #F97583">!=</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">0</span><span style="color: #E1E4E8">):</span></span>
<span class="line"><span style="color: #E1E4E8">        </span><span style="color: #79B8FF">print</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">"Error: </span><span style="color: #79B8FF">%s\n</span><span style="color: #9ECBFF">"</span><span style="color: #E1E4E8">, SDL_GetError())</span><span style="color: #FDAEB7; font-style: italic">;</span></span>
<span class="line"><span style="color: #E1E4E8">        </span><span style="color: #F97583">return</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">-</span><span style="color: #79B8FF">1</span><span style="color: #FDAEB7; font-style: italic">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #6A737D"># Setup window</span></span>
<span class="line"><span style="color: #E1E4E8">    SDL_GL_SetAttribute(</span><span style="color: #79B8FF">SDL_GL_CONTEXT_FLAGS</span><span style="color: #E1E4E8">, </span><span style="color: #79B8FF">SDL_GL_CONTEXT_FORWARD_COMPATIBLE_FLAG</span><span style="color: #E1E4E8">)</span><span style="color: #FDAEB7; font-style: italic">;</span></span>
<span class="line"><span style="color: #E1E4E8">    SDL_GL_SetAttribute(</span><span style="color: #79B8FF">SDL_GL_CONTEXT_PROFILE_MASK</span><span style="color: #E1E4E8">, </span><span style="color: #79B8FF">SDL_GL_CONTEXT_PROFILE_CORE</span><span style="color: #E1E4E8">)</span><span style="color: #FDAEB7; font-style: italic">;</span></span>
<span class="line"><span style="color: #E1E4E8">    SDL_GL_SetAttribute(</span><span style="color: #79B8FF">SDL_GL_DOUBLEBUFFER</span><span style="color: #E1E4E8">, </span><span style="color: #79B8FF">1</span><span style="color: #E1E4E8">)</span><span style="color: #FDAEB7; font-style: italic">;</span></span>
<span class="line"><span style="color: #E1E4E8">    SDL_GL_SetAttribute(</span><span style="color: #79B8FF">SDL_GL_DEPTH_SIZE</span><span style="color: #E1E4E8">, </span><span style="color: #79B8FF">24</span><span style="color: #E1E4E8">)</span><span style="color: #FDAEB7; font-style: italic">;</span></span>
<span class="line"><span style="color: #E1E4E8">    SDL_GL_SetAttribute(</span><span style="color: #79B8FF">SDL_GL_STENCIL_SIZE</span><span style="color: #E1E4E8">, </span><span style="color: #79B8FF">8</span><span style="color: #E1E4E8">)</span><span style="color: #FDAEB7; font-style: italic">;</span></span>
<span class="line"><span style="color: #E1E4E8">    SDL_GL_SetAttribute(</span><span style="color: #79B8FF">SDL_GL_CONTEXT_MAJOR_VERSION</span><span style="color: #E1E4E8">, </span><span style="color: #79B8FF">3</span><span style="color: #E1E4E8">)</span><span style="color: #FDAEB7; font-style: italic">;</span></span>
<span class="line"><span style="color: #E1E4E8">    SDL_GL_SetAttribute(</span><span style="color: #79B8FF">SDL_GL_CONTEXT_MINOR_VERSION</span><span style="color: #E1E4E8">, </span><span style="color: #79B8FF">2</span><span style="color: #E1E4E8">)</span><span style="color: #FDAEB7; font-style: italic">;</span></span>
<span class="line"><span style="color: #E1E4E8">    current</span><span style="color: #F97583">=</span><span style="color: #E1E4E8">SDL_DisplayMode()</span><span style="color: #FDAEB7; font-style: italic">;</span></span>
<span class="line"><span style="color: #E1E4E8">    SDL_GetCurrentDisplayMode(</span><span style="color: #79B8FF">0</span><span style="color: #E1E4E8">, current)</span><span style="color: #FDAEB7; font-style: italic">;</span></span>
<span class="line"><span style="color: #E1E4E8">    window </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> SDL_CreateWindow(</span><span style="color: #F97583">b</span><span style="color: #9ECBFF">"ImGui SDL2+OpenGL3 example"</span><span style="color: #E1E4E8">, </span><span style="color: #79B8FF">SDL_WINDOWPOS_CENTERED</span><span style="color: #E1E4E8">, </span><span style="color: #79B8FF">SDL_WINDOWPOS_CENTERED</span><span style="color: #E1E4E8">, </span><span style="color: #79B8FF">1280</span><span style="color: #E1E4E8">, </span><span style="color: #79B8FF">720</span><span style="color: #E1E4E8">, </span><span style="color: #79B8FF">SDL_WINDOW_OPENGL</span><span style="color: #F97583">|</span><span style="color: #79B8FF">SDL_WINDOW_RESIZABLE</span><span style="color: #E1E4E8">)</span><span style="color: #FDAEB7; font-style: italic">;</span></span>
<span class="line"><span style="color: #E1E4E8">    glcontext </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> SDL_GL_CreateContext(window)</span><span style="color: #FDAEB7; font-style: italic">;</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #6A737D">#gl3wInit();</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #6A737D"># Setup ImGui binding</span></span>
<span class="line"><span style="color: #E1E4E8">    ImplSdlGL3.Init(window)</span><span style="color: #FDAEB7; font-style: italic">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #6A737D"># Load Fonts</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #6A737D"># (there is a default font, this is only if you want to change it. see extra_fonts/README.txt for more details)</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #6A737D">#ImGuiIO&#x26; io = imgui.GetIO();</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #6A737D">#io.Fonts->AddFontDefault();</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #6A737D">#io.Fonts->AddFontFromFileTTF("../../extra_fonts/Cousine-Regular.ttf", 15.0f);</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #6A737D">#io.Fonts->AddFontFromFileTTF("../../extra_fonts/DroidSans.ttf", 16.0f);</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #6A737D">#io.Fonts->AddFontFromFileTTF("../../extra_fonts/ProggyClean.ttf", 13.0f);</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #6A737D">#io.Fonts->AddFontFromFileTTF("../../extra_fonts/ProggyTiny.ttf", 10.0f);</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #6A737D">#io.Fonts->AddFontFromFileTTF("c:\\Windows\\Fonts\\ArialUni.ttf", 18.0f, NULL, io.Fonts->GetGlyphRangesJapanese());</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">    show_test_window </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">True</span><span style="color: #FDAEB7; font-style: italic">;</span></span>
<span class="line"><span style="color: #E1E4E8">    show_another_window </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">False</span><span style="color: #FDAEB7; font-style: italic">;</span></span>
<span class="line"><span style="color: #E1E4E8">    clear_color </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> [</span><span style="color: #79B8FF">114</span><span style="color: #F97583">/</span><span style="color: #79B8FF">255.0</span><span style="color: #E1E4E8">, </span><span style="color: #79B8FF">144</span><span style="color: #F97583">/</span><span style="color: #79B8FF">255.0</span><span style="color: #E1E4E8">, </span><span style="color: #79B8FF">154</span><span style="color: #F97583">/</span><span style="color: #79B8FF">255.0</span><span style="color: #E1E4E8">]</span><span style="color: #FDAEB7; font-style: italic">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #6A737D"># Main loop</span></span>
<span class="line"><span style="color: #E1E4E8">    done </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">False</span><span style="color: #FDAEB7; font-style: italic">;</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #F97583">while</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">not</span><span style="color: #E1E4E8"> done:</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">        event</span><span style="color: #F97583">=</span><span style="color: #E1E4E8">SDL_Event()</span><span style="color: #FDAEB7; font-style: italic">;</span></span>
<span class="line"><span style="color: #E1E4E8">        </span><span style="color: #F97583">while</span><span style="color: #E1E4E8"> SDL_PollEvent(event)</span><span style="color: #F97583">!=</span><span style="color: #79B8FF">0</span><span style="color: #E1E4E8">:</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">            ImplSdlGL3.ProcessEvent(event)</span><span style="color: #FDAEB7; font-style: italic">;</span></span>
<span class="line"><span style="color: #E1E4E8">            </span><span style="color: #F97583">if</span><span style="color: #E1E4E8"> event.type </span><span style="color: #F97583">==</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">SDL_QUIT</span><span style="color: #E1E4E8">:</span></span>
<span class="line"><span style="color: #E1E4E8">                done </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> true</span><span style="color: #FDAEB7; font-style: italic">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">        ImplSdlGL3.NewFrame(window)</span><span style="color: #FDAEB7; font-style: italic">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">        </span><span style="color: #6A737D"># 1. Show a simple window</span></span>
<span class="line"><span style="color: #E1E4E8">        </span><span style="color: #6A737D"># Tip: if we don't call imgui.Begin()/imgui.End() the widgets appears in a window automatically called "Debug"</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">        f </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">0.0</span><span style="color: #FDAEB7; font-style: italic">;</span></span>
<span class="line"><span style="color: #E1E4E8">        imgui.Text(</span><span style="color: #9ECBFF">"Hello, world!"</span><span style="color: #E1E4E8">)</span><span style="color: #FDAEB7; font-style: italic">;</span></span>
<span class="line"><span style="color: #E1E4E8">        imgui.SliderFloat(</span><span style="color: #9ECBFF">"float"</span><span style="color: #E1E4E8">, f, </span><span style="color: #79B8FF">0.0</span><span style="color: #E1E4E8">, </span><span style="color: #79B8FF">1.0</span><span style="color: #E1E4E8">)</span><span style="color: #FDAEB7; font-style: italic">;</span></span>
<span class="line"><span style="color: #E1E4E8">        imgui.ColorEdit3(</span><span style="color: #9ECBFF">"clear color"</span><span style="color: #E1E4E8">, clear_color)</span><span style="color: #FDAEB7; font-style: italic">;</span></span>
<span class="line"><span style="color: #E1E4E8">        </span><span style="color: #F97583">if</span><span style="color: #E1E4E8"> imgui.Button(</span><span style="color: #9ECBFF">"Test Window"</span><span style="color: #E1E4E8">): show_test_window </span><span style="color: #F97583">^=</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">1</span><span style="color: #FDAEB7; font-style: italic">;</span></span>
<span class="line"><span style="color: #E1E4E8">        </span><span style="color: #F97583">if</span><span style="color: #E1E4E8"> imgui.Button(</span><span style="color: #9ECBFF">"Another Window"</span><span style="color: #E1E4E8">): show_another_window </span><span style="color: #F97583">^=</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">1</span><span style="color: #FDAEB7; font-style: italic">;</span></span>
<span class="line"><span style="color: #E1E4E8">        imgui.Text(</span><span style="color: #9ECBFF">"Application average </span><span style="color: #79B8FF">%.3f</span><span style="color: #9ECBFF"> ms/frame (</span><span style="color: #79B8FF">%.1f</span><span style="color: #9ECBFF"> FPS)"</span><span style="color: #E1E4E8">, </span><span style="color: #79B8FF">1000.0</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">/</span><span style="color: #E1E4E8"> imgui.GetIO().Framerate, imgui.GetIO().Framerate)</span><span style="color: #FDAEB7; font-style: italic">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">        </span><span style="color: #6A737D"># 2. Show another simple window, this time using an explicit Begin/End pair</span></span>
<span class="line"><span style="color: #E1E4E8">        </span><span style="color: #F97583">if</span><span style="color: #E1E4E8"> show_another_window:</span></span>
<span class="line"><span style="color: #E1E4E8">            imgui.SetNextWindowSize(ImVec2(</span><span style="color: #79B8FF">200</span><span style="color: #E1E4E8">,</span><span style="color: #79B8FF">100</span><span style="color: #E1E4E8">), ImGuiSetCond_FirstUseEver)</span><span style="color: #FDAEB7; font-style: italic">;</span></span>
<span class="line"><span style="color: #E1E4E8">            imgui.Begin(</span><span style="color: #9ECBFF">"Another Window"</span><span style="color: #E1E4E8">, show_another_window)</span><span style="color: #FDAEB7; font-style: italic">;</span></span>
<span class="line"><span style="color: #E1E4E8">            imgui.Text(</span><span style="color: #9ECBFF">"Hello"</span><span style="color: #E1E4E8">)</span><span style="color: #FDAEB7; font-style: italic">;</span></span>
<span class="line"><span style="color: #E1E4E8">            imgui.End()</span><span style="color: #FDAEB7; font-style: italic">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">        </span><span style="color: #6A737D"># 3. Show the ImGui test window. Most of the sample code is in imgui.ShowTestWindow()</span></span>
<span class="line"><span style="color: #E1E4E8">        </span><span style="color: #F97583">if</span><span style="color: #E1E4E8"> show_test_window:</span></span>
<span class="line"><span style="color: #E1E4E8">            imgui.SetNextWindowPos(ImVec2(</span><span style="color: #79B8FF">650</span><span style="color: #E1E4E8">, </span><span style="color: #79B8FF">20</span><span style="color: #E1E4E8">), ImGuiSetCond_FirstUseEver)</span><span style="color: #FDAEB7; font-style: italic">;</span></span>
<span class="line"><span style="color: #E1E4E8">            imgui.ShowTestWindow(show_test_window)</span><span style="color: #FDAEB7; font-style: italic">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">        </span><span style="color: #6A737D"># Rendering</span></span>
<span class="line"><span style="color: #E1E4E8">        glViewport(</span><span style="color: #79B8FF">0</span><span style="color: #E1E4E8">, </span><span style="color: #79B8FF">0</span><span style="color: #E1E4E8">, </span><span style="color: #79B8FF">int</span><span style="color: #E1E4E8">(imgui.GetIO().DisplaySize.x), </span><span style="color: #79B8FF">int</span><span style="color: #E1E4E8">(imgui.GetIO().DisplaySize.y))</span><span style="color: #FDAEB7; font-style: italic">;</span></span>
<span class="line"><span style="color: #E1E4E8">        glClearColor(clear_color.x, clear_color.y, clear_color.z, clear_color.w)</span><span style="color: #FDAEB7; font-style: italic">;</span></span>
<span class="line"><span style="color: #E1E4E8">        glClear(</span><span style="color: #79B8FF">GL_COLOR_BUFFER_BIT</span><span style="color: #E1E4E8">)</span><span style="color: #FDAEB7; font-style: italic">;</span></span>
<span class="line"><span style="color: #E1E4E8">        imgui.Render()</span><span style="color: #FDAEB7; font-style: italic">;</span></span>
<span class="line"><span style="color: #E1E4E8">        SDL_GL_SwapWindow(window)</span><span style="color: #FDAEB7; font-style: italic">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #6A737D"># Cleanup</span></span>
<span class="line"><span style="color: #E1E4E8">    ImplSdlGL3.Shutdown()</span><span style="color: #FDAEB7; font-style: italic">;</span></span>
<span class="line"><span style="color: #E1E4E8">    SDL_GL_DeleteContext(glcontext)</span><span style="color: #FDAEB7; font-style: italic">;</span></span>
<span class="line"><span style="color: #E1E4E8">    SDL_DestroyWindow(window)</span><span style="color: #FDAEB7; font-style: italic">;</span></span>
<span class="line"><span style="color: #E1E4E8">    SDL_Quit()</span><span style="color: #FDAEB7; font-style: italic">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #F97583">return</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">0</span><span style="color: #FDAEB7; font-style: italic">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #F97583">if</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">**</span><span style="color: #E1E4E8">name</span><span style="color: #F97583">**==</span><span style="color: #9ECBFF">'**main**'</span><span style="color: #E1E4E8">:</span></span>
<span class="line"><span style="color: #E1E4E8">main()</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">ImplSdlGL3.py</span></span>
<span class="line"><span style="color: #F97583">def</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">Init</span><span style="color: #E1E4E8">(window):</span></span>
<span class="line"><span style="color: #F97583">pass</span></span>
<span class="line"></span>
<span class="line"><span style="color: #F97583">def</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">ProcessEvent</span><span style="color: #E1E4E8">(event):</span></span>
<span class="line"><span style="color: #F97583">pass</span></span>
<span class="line"></span>
<span class="line"><span style="color: #F97583">def</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">NewFrame</span><span style="color: #E1E4E8">(window):</span></span>
<span class="line"><span style="color: #F97583">pass</span></span></code></pre>
<p>pyd のサーチ
環境変数 PATH
環境変数 PYSDL2_DLL_PATH
実行
諸々、正しく初期化していないのでクラッシュする。
Init を移植</p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #F97583">import</span><span style="color: #E1E4E8"> swig_imgui </span><span style="color: #F97583">as</span><span style="color: #E1E4E8"> imgui</span></span>
<span class="line"><span style="color: #F97583">from</span><span style="color: #E1E4E8"> sdl2 </span><span style="color: #F97583">import</span><span style="color: #E1E4E8"> \</span><span style="color: #FDAEB7; font-style: italic">*</span></span>
<span class="line"></span>
<span class="line"><span style="color: #F97583">def</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">Init</span><span style="color: #E1E4E8">(window):</span></span>
<span class="line"><span style="color: #E1E4E8">io </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> imgui.GetIO()</span><span style="color: #FDAEB7; font-style: italic">;</span></span>
<span class="line"><span style="color: #6A737D">#io.KeyMap[imgui.ImGuiKey_Tab] = SDLK_TAB;</span></span>
<span class="line"><span style="color: #E1E4E8">io.KeyMap[imgui.ImGuiKey_LeftArrow] </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">SDL_SCANCODE_LEFT</span><span style="color: #FDAEB7; font-style: italic">;</span></span>
<span class="line"><span style="color: #E1E4E8">io.KeyMap[imgui.ImGuiKey_RightArrow] </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">SDL_SCANCODE_RIGHT</span><span style="color: #FDAEB7; font-style: italic">;</span></span>
<span class="line"><span style="color: #E1E4E8">io.KeyMap[imgui.ImGuiKey_UpArrow] </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">SDL_SCANCODE_UP</span><span style="color: #FDAEB7; font-style: italic">;</span></span>
<span class="line"><span style="color: #E1E4E8">io.KeyMap[imgui.ImGuiKey_DownArrow] </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">SDL_SCANCODE_DOWN</span><span style="color: #FDAEB7; font-style: italic">;</span></span>
<span class="line"><span style="color: #E1E4E8">io.KeyMap[imgui.ImGuiKey_PageUp] </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">SDL_SCANCODE_PAGEUP</span><span style="color: #FDAEB7; font-style: italic">;</span></span>
<span class="line"><span style="color: #E1E4E8">io.KeyMap[imgui.ImGuiKey_PageDown] </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">SDL_SCANCODE_PAGEDOWN</span><span style="color: #FDAEB7; font-style: italic">;</span></span>
<span class="line"><span style="color: #E1E4E8">io.KeyMap[imgui.ImGuiKey_Home] </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">SDL_SCANCODE_HOME</span><span style="color: #FDAEB7; font-style: italic">;</span></span>
<span class="line"><span style="color: #E1E4E8">io.KeyMap[imgui.ImGuiKey_End] </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">SDL_SCANCODE_END</span><span style="color: #FDAEB7; font-style: italic">;</span></span>
<span class="line"><span style="color: #E1E4E8">io.KeyMap[imgui.ImGuiKey_Delete] </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">SDLK_DELETE</span><span style="color: #FDAEB7; font-style: italic">;</span></span>
<span class="line"><span style="color: #E1E4E8">io.KeyMap[imgui.ImGuiKey_Backspace] </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">SDLK_BACKSPACE</span><span style="color: #FDAEB7; font-style: italic">;</span></span>
<span class="line"><span style="color: #E1E4E8">io.KeyMap[imgui.ImGuiKey_Enter] </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">SDLK_RETURN</span><span style="color: #FDAEB7; font-style: italic">;</span></span>
<span class="line"><span style="color: #E1E4E8">io.KeyMap[imgui.ImGuiKey_Escape] </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">SDLK_ESCAPE</span><span style="color: #FDAEB7; font-style: italic">;</span></span>
<span class="line"><span style="color: #E1E4E8">io.KeyMap[imgui.ImGuiKey_A] </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">SDLK_a</span><span style="color: #FDAEB7; font-style: italic">;</span></span>
<span class="line"><span style="color: #E1E4E8">io.KeyMap[imgui.ImGuiKey_C] </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">SDLK_c</span><span style="color: #FDAEB7; font-style: italic">;</span></span>
<span class="line"><span style="color: #E1E4E8">io.KeyMap[imgui.ImGuiKey_V] </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">SDLK_v</span><span style="color: #FDAEB7; font-style: italic">;</span></span>
<span class="line"><span style="color: #E1E4E8">io.KeyMap[imgui.ImGuiKey_X] </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">SDLK_x</span><span style="color: #FDAEB7; font-style: italic">;</span></span>
<span class="line"><span style="color: #E1E4E8">io.KeyMap[imgui.ImGuiKey_Y] </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">SDLK_y</span><span style="color: #FDAEB7; font-style: italic">;</span></span>
<span class="line"><span style="color: #E1E4E8">io.KeyMap[imgui.ImGuiKey_Z] </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">SDLK_z</span><span style="color: #FDAEB7; font-style: italic">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #6A737D"># Alternatively you can set this to NULL and call imgui.GetDrawData() after imgui.Render() to get the same ImDrawData pointer.</span></span>
<span class="line"><span style="color: #E1E4E8">    io.RenderDrawListsFn </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> ImGui_ImplSdlGL3_RenderDrawLists</span><span style="color: #FDAEB7; font-style: italic">;</span></span>
<span class="line"><span style="color: #E1E4E8">    io.SetClipboardTextFn </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> ImGui_ImplSdlGL3_SetClipboardText</span><span style="color: #FDAEB7; font-style: italic">;</span></span>
<span class="line"><span style="color: #E1E4E8">    io.GetClipboardTextFn </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> ImGui_ImplSdlGL3_GetClipboardText</span><span style="color: #FDAEB7; font-style: italic">;</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #6A737D">#io.ClipboardUserData = NULL;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #6A737D">#ifdef \_WIN32</span></span>
<span class="line"><span style="color: #E1E4E8">wmInfo</span><span style="color: #F97583">=</span><span style="color: #E1E4E8">SDL_SysWMinfo()</span><span style="color: #FDAEB7; font-style: italic">;</span></span>
<span class="line"><span style="color: #E1E4E8">SDL_VERSION(wmInfo.version)</span><span style="color: #FDAEB7; font-style: italic">;</span></span>
<span class="line"><span style="color: #E1E4E8">SDL_GetWindowWMInfo(window, wmInfo)</span><span style="color: #FDAEB7; font-style: italic">;</span></span>
<span class="line"><span style="color: #E1E4E8">io.ImeWindowHandle </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> wmInfo.info.win.window</span><span style="color: #FDAEB7; font-style: italic">;</span></span>
<span class="line"><span style="color: #6A737D">#else</span></span>
<span class="line"><span style="color: #6A737D">#(void)window;</span></span>
<span class="line"><span style="color: #6A737D">#endif</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #F97583">return</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">True</span><span style="color: #FDAEB7; font-style: italic">;</span></span></code></pre>
<p>実行してエラーをつぶしていく。
int 型配列への index を使った代入
冒頭の io.KeyMap[imgui.ImGuiKey_LeftArrow] = SDL_SCANCODE_LEFT;がエラーになる。</p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #e1e4e8">io.KeyMap[imgui.ImGuiKey_LeftArrow] = SDL_SCANCODE_LEFT;</span></span>
<span class="line"><span style="color: #e1e4e8">TypeError: 'SwigPyObject' object does not support item assignment</span></span></code></pre>
<p>io.KeyMap の C での型。</p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #F97583">int</span><span style="color: #E1E4E8"> </span><span style="color: #FFAB70">KeyMap</span><span style="color: #E1E4E8">[ImGuiKey_COUNT];</span></span></code></pre>
<p>単なる配列へのアクセス。KeyMap を list 的なオブジェクトとして python 側に公開するよりも、io にセッターを実装することにした。
imgui.i に追加。</p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #e1e4e8">%extend ImGuiIO {</span></span>
<span class="line"><span style="color: #e1e4e8">void SetKeyMap(int k, int v)</span></span>
<span class="line"><span style="color: #e1e4e8">{</span></span>
<span class="line"><span style="color: #e1e4e8">ImGui::GetIO().KeyMap[k]=v;</span></span>
<span class="line"><span style="color: #e1e4e8">}</span></span>
<span class="line"><span style="color: #e1e4e8">}</span></span></code></pre>
<p>python では次のように使う。</p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #E1E4E8">io.SetKeyMap(imgui.ImGuiKey_LeftArrow, </span><span style="color: #79B8FF">SDL_SCANCODE_LEFT</span><span style="color: #E1E4E8">)</span><span style="color: #FDAEB7; font-style: italic">;</span></span></code></pre>
<p>関数ポインタ型に python の関数を代入。
swig 的にはこれがいちばんの難問である。
関数ポインタを変数に代入するのがエラーになる。</p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #F97583">def</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">RenderDrawLists</span><span style="color: #E1E4E8">():</span></span>
<span class="line"><span style="color: #F97583">pass</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">io.RenderDrawListsFn </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> RenderDrawLists</span><span style="color: #FDAEB7; font-style: italic">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #79B8FF">TypeError</span><span style="color: #E1E4E8">: </span><span style="color: #F97583">in</span><span style="color: #E1E4E8"> method </span><span style="color: #9ECBFF">'ImGuiIO_RenderDrawListsFn_set'</span><span style="color: #E1E4E8">, argument </span><span style="color: #79B8FF">2</span><span style="color: #E1E4E8"> of </span><span style="color: #79B8FF">type</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">'void (_)(ImDrawData _)'</span></span>
<span class="line"><span style="color: #E1E4E8">Press </span><span style="color: #79B8FF">any</span><span style="color: #E1E4E8"> key to </span><span style="color: #F97583">continue</span><span style="color: #E1E4E8"> . . .</span></span></code></pre>
<p>そりゃ、python の関数をこれに代入するのは無理だ。
解決方法は、以下のようにする。
imgui.i に追記。場所に注意が必要。</p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #e1e4e8">%{</span></span>
<span class="line"><span style="color: #e1e4e8">static void PythonRenderDrawListsFn(ImDrawData* data)</span></span>
<span class="line"><span style="color: #e1e4e8">{</span></span>
<span class="line"><span style="color: #e1e4e8">auto func=(PyObject*)ImGui::GetIO().UserData; // Get Python function</span></span>
<span class="line"><span style="color: #e1e4e8">auto obj = SWIG_NewPointerObj(SWIG_as_voidptr(data)</span></span>
<span class="line"><span style="color: #e1e4e8">, SWIGTYPE_p_ImDrawData, 0 | 0 );</span></span>
<span class="line"><span style="color: #e1e4e8">auto arglist = Py_BuildValue("(O)",obj); // Build argument list</span></span>
<span class="line"><span style="color: #e1e4e8">PyEval_CallObject(func, arglist); // Call Python</span></span>
<span class="line"><span style="color: #e1e4e8">Py_DECREF(arglist); // Trash arglist</span></span>
<span class="line"><span style="color: #e1e4e8">Py_DECREF(obj);</span></span>
<span class="line"><span style="color: #e1e4e8">}</span></span>
<span class="line"><span style="color: #e1e4e8">%}</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">// before</span></span>
<span class="line"><span style="color: #e1e4e8">%include "imgui/imgui.h"</span></span>
<span class="line"><span style="color: #e1e4e8">// after</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">%extend ImGuiIO {</span></span>
<span class="line"><span style="color: #e1e4e8">void SetRenderDrawListsFn(PyObject \*pyfunc) {</span></span>
<span class="line"><span style="color: #e1e4e8">ImGui::GetIO().UserData=pyfunc;</span></span>
<span class="line"><span style="color: #e1e4e8">self->RenderDrawListsFn=PythonRenderDrawListsFn;</span></span>
<span class="line"><span style="color: #e1e4e8">Py_INCREF(pyfunc);</span></span>
<span class="line"><span style="color: #e1e4e8">}</span></span>
<span class="line"><span style="color: #e1e4e8">}</span></span></code></pre>
<p>残り２つの関数ポインタも同様の対応で行けると思うがコメントアウトして飛ばした。</p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #e1e4e8">io.SetClipboardTextFn = ImGui_ImplSdlGL3_SetClipboardText;</span></span>
<span class="line"><span style="color: #e1e4e8">io.GetClipboardTextFn = ImGui_ImplSdlGL3_GetClipboardText;</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">void\*の代入</span></span>
<span class="line"><span style="color: #e1e4e8">io.ImeWindowHandle = wmInfo.info.win.window;</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">TypeError: in method 'ImGuiIO_ImeWindowHandle_set', argument 2 of type 'void \*'</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">セッターを作った。</span></span>
<span class="line"><span style="color: #e1e4e8">%extend ImGuiIO {</span></span>
<span class="line"><span style="color: #e1e4e8">void SetImeWindowHandle(long long v)</span></span>
<span class="line"><span style="color: #e1e4e8">{</span></span>
<span class="line"><span style="color: #e1e4e8">ImGui::GetIO().ImeWindowHandle = (void\*)v;</span></span>
<span class="line"><span style="color: #e1e4e8">}</span></span>
<span class="line"><span style="color: #e1e4e8">}</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">NewFrame の移植</span></span>
<span class="line"><span style="color: #e1e4e8">def CreateDeviceObjects():</span></span>
<span class="line"><span style="color: #e1e4e8">pass</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">g_MousePressed=[False, False, False]</span></span>
<span class="line"><span style="color: #e1e4e8">g_MouseWheel=None</span></span>
<span class="line"><span style="color: #e1e4e8">def NewFrame(window):</span></span>
<span class="line"><span style="color: #e1e4e8">if not g_FontTexture:</span></span>
<span class="line"><span style="color: #e1e4e8">CreateDeviceObjects();</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">    io = imgui.GetIO();</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">    # Setup display size (every frame to accommodate for window resizing)</span></span>
<span class="line"><span style="color: #e1e4e8">    w, h=SDL_GetWindowSize(window);</span></span>
<span class="line"><span style="color: #e1e4e8">    display_w, display_h=SDL_GL_GetDrawableSize(window);</span></span>
<span class="line"><span style="color: #e1e4e8">    io.DisplaySize = imgui.ImVec2(w, h);</span></span>
<span class="line"><span style="color: #e1e4e8">    io.DisplayFramebufferScale = ImVec2(</span></span>
<span class="line"><span style="color: #e1e4e8">        (display_w / float(w)) if w > 0 else 0,</span></span>
<span class="line"><span style="color: #e1e4e8">        (display_h / float(h)) if h > 0 else 0);</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">    # Setup time step</span></span>
<span class="line"><span style="color: #e1e4e8">    time = SDL_GetTicks();</span></span>
<span class="line"><span style="color: #e1e4e8">    current_time = time / 1000.0;</span></span>
<span class="line"><span style="color: #e1e4e8">    io.DeltaTime = (current_time - g_Time) if g_Time > 0.0 else (1.0 / 60.0);</span></span>
<span class="line"><span style="color: #e1e4e8">    g_Time = current_time;</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">    # Setup inputs</span></span>
<span class="line"><span style="color: #e1e4e8">    # (we already got mouse wheel, keyboard keys &#x26; characters from SDL_PollEvent())</span></span>
<span class="line"><span style="color: #e1e4e8">    mouseMask, mx, my = SDL_GetMouseState();</span></span>
<span class="line"><span style="color: #e1e4e8">    if (SDL_GetWindowFlags(window) &#x26; SDL_WINDOW_MOUSE_FOCUS):</span></span>
<span class="line"><span style="color: #e1e4e8">        # Mouse position, in pixels (set to -1,-1 if no mouse / on another screen, etc.)</span></span>
<span class="line"><span style="color: #e1e4e8">        io.MousePos = ImVec2(mx, my);</span></span>
<span class="line"><span style="color: #e1e4e8">    else:</span></span>
<span class="line"><span style="color: #e1e4e8">        io.MousePos = ImVec2(-1, -1);</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">    # If a mouse press event came, always pass it as "mouse held this frame", so we don't miss click-release events that are shorter than 1 frame.</span></span>
<span class="line"><span style="color: #e1e4e8">    io.MouseDown[0] = g_MousePressed[0] or (mouseMask &#x26; SDL_BUTTON(SDL_BUTTON_LEFT)) != 0;</span></span>
<span class="line"><span style="color: #e1e4e8">    io.MouseDown[1] = g_MousePressed[1] or (mouseMask &#x26; SDL_BUTTON(SDL_BUTTON_RIGHT)) != 0;</span></span>
<span class="line"><span style="color: #e1e4e8">    io.MouseDown[2] = g_MousePressed[2] or (mouseMask &#x26; SDL_BUTTON(SDL_BUTTON_MIDDLE)) != 0;</span></span>
<span class="line"><span style="color: #e1e4e8">    g_MousePressed[0] = g_MousePressed[1] = g_MousePressed[2] = False;</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">    io.MouseWheel = g_MouseWheel;</span></span>
<span class="line"><span style="color: #e1e4e8">    g_MouseWheel = 0.0;</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">    # Hide OS mouse cursor if ImGui is drawing it</span></span>
<span class="line"><span style="color: #e1e4e8">    SDL_ShowCursor(0 if io.MouseDrawCursor else 1);</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">    # Start the frame</span></span>
<span class="line"><span style="color: #e1e4e8">    imgui.NewFrame();</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">io.MouseDown</span></span>
<span class="line"><span style="color: #e1e4e8">セッター。</span></span>
<span class="line"><span style="color: #e1e4e8">%extend ImGuiIO {</span></span>
<span class="line"><span style="color: #e1e4e8">void SetMouseDown(int k, int v)</span></span>
<span class="line"><span style="color: #e1e4e8">{</span></span>
<span class="line"><span style="color: #e1e4e8">ImGui::GetIO().MouseDown[k]=v;</span></span>
<span class="line"><span style="color: #e1e4e8">}</span></span>
<span class="line"><span style="color: #e1e4e8">}</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">CreateDeviceObjects の移植 # Backup GL state</span></span>
<span class="line"><span style="color: #e1e4e8">last_texture=glGetIntegerv(GL_TEXTURE_BINDING_2D);</span></span>
<span class="line"><span style="color: #e1e4e8">last_array_buffer=glGetIntegerv(GL_ARRAY_BUFFER_BINDING);</span></span>
<span class="line"><span style="color: #e1e4e8">last_vertex_array=glGetIntegerv(GL_VERTEX_ARRAY_BINDING);</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">    vertex_shader =b'''#version 330</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">uniform mat4 ProjMtx;</span></span>
<span class="line"><span style="color: #e1e4e8">in vec2 Position;</span></span>
<span class="line"><span style="color: #e1e4e8">in vec2 UV;</span></span>
<span class="line"><span style="color: #e1e4e8">in vec4 Color;</span></span>
<span class="line"><span style="color: #e1e4e8">out vec2 Frag_UV;</span></span>
<span class="line"><span style="color: #e1e4e8">out vec4 Frag_Color;</span></span>
<span class="line"><span style="color: #e1e4e8">void main()</span></span>
<span class="line"><span style="color: #e1e4e8">{</span></span>
<span class="line"><span style="color: #e1e4e8">Frag_UV = UV;</span></span>
<span class="line"><span style="color: #e1e4e8">Frag_Color = Color;</span></span>
<span class="line"><span style="color: #e1e4e8">gl_Position = ProjMtx \* vec4(Position.xy,0,1);</span></span>
<span class="line"><span style="color: #e1e4e8">};</span></span>
<span class="line"><span style="color: #e1e4e8">'''</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">    fragment_shader =b'''#version 330</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">uniform sampler2D Texture;</span></span>
<span class="line"><span style="color: #e1e4e8">in vec2 Frag_UV;</span></span>
<span class="line"><span style="color: #e1e4e8">in vec4 Frag_Color;</span></span>
<span class="line"><span style="color: #e1e4e8">out vec4 Out_Color;</span></span>
<span class="line"><span style="color: #e1e4e8">void main()</span></span>
<span class="line"><span style="color: #e1e4e8">{</span></span>
<span class="line"><span style="color: #e1e4e8">Out_Color = Frag_Color \* texture( Texture, Frag_UV.st);</span></span>
<span class="line"><span style="color: #e1e4e8">};</span></span>
<span class="line"><span style="color: #e1e4e8">'''</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">    g_ShaderHandle = glCreateProgram();</span></span>
<span class="line"><span style="color: #e1e4e8">    g_VertHandle = glCreateShader(GL_VERTEX_SHADER);</span></span>
<span class="line"><span style="color: #e1e4e8">    g_FragHandle = glCreateShader(GL_FRAGMENT_SHADER);</span></span>
<span class="line"><span style="color: #e1e4e8">    glShaderSource(g_VertHandle, vertex_shader);</span></span>
<span class="line"><span style="color: #e1e4e8">    glShaderSource(g_FragHandle, fragment_shader);</span></span>
<span class="line"><span style="color: #e1e4e8">    glCompileShader(g_VertHandle);</span></span>
<span class="line"><span style="color: #e1e4e8">    glCompileShader(g_FragHandle);</span></span>
<span class="line"><span style="color: #e1e4e8">    glAttachShader(g_ShaderHandle, g_VertHandle);</span></span>
<span class="line"><span style="color: #e1e4e8">    glAttachShader(g_ShaderHandle, g_FragHandle);</span></span>
<span class="line"><span style="color: #e1e4e8">    glLinkProgram(g_ShaderHandle);</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">    g_AttribLocationTex = glGetUniformLocation(g_ShaderHandle, "Texture");</span></span>
<span class="line"><span style="color: #e1e4e8">    g_AttribLocationProjMtx = glGetUniformLocation(g_ShaderHandle, "ProjMtx");</span></span>
<span class="line"><span style="color: #e1e4e8">    g_AttribLocationPosition = glGetAttribLocation(g_ShaderHandle, "Position");</span></span>
<span class="line"><span style="color: #e1e4e8">    g_AttribLocationUV = glGetAttribLocation(g_ShaderHandle, "UV");</span></span>
<span class="line"><span style="color: #e1e4e8">    g_AttribLocationColor = glGetAttribLocation(g_ShaderHandle, "Color");</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">    g_VboHandle=glGenBuffers(1);</span></span>
<span class="line"><span style="color: #e1e4e8">    g_ElementsHandle=glGenBuffers(1);</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">    g_VaoHandle=glGenVertexArrays(1);</span></span>
<span class="line"><span style="color: #e1e4e8">    glBindVertexArray(g_VaoHandle);</span></span>
<span class="line"><span style="color: #e1e4e8">    glBindBuffer(GL_ARRAY_BUFFER, g_VboHandle);</span></span>
<span class="line"><span style="color: #e1e4e8">    glEnableVertexAttribArray(g_AttribLocationPosition);</span></span>
<span class="line"><span style="color: #e1e4e8">    glEnableVertexAttribArray(g_AttribLocationUV);</span></span>
<span class="line"><span style="color: #e1e4e8">    glEnableVertexAttribArray(g_AttribLocationColor);</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">#define OFFSETOF(TYPE, ELEMENT) ((size_t)&#x26;(((TYPE \*)0)->ELEMENT))</span></span>
<span class="line"><span style="color: #e1e4e8">SIZEOF_ImDrawVert=20</span></span>
<span class="line"><span style="color: #e1e4e8">glVertexAttribPointer(g_AttribLocationPosition, 2, GL_FLOAT, GL_FALSE, SIZEOF_ImDrawVert, ctypes.c_void_p(0));</span></span>
<span class="line"><span style="color: #e1e4e8">glVertexAttribPointer(g_AttribLocationUV, 2, GL_FLOAT, GL_FALSE, SIZEOF_ImDrawVert, ctypes.c_void_p(8));</span></span>
<span class="line"><span style="color: #e1e4e8">glVertexAttribPointer(g_AttribLocationColor, 4, GL_UNSIGNED_BYTE, GL_TRUE, SIZEOF_ImDrawVert, ctypes.c_void_p(16));</span></span>
<span class="line"><span style="color: #e1e4e8">#undef OFFSETOF</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">    CreateFontsTexture();</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">    # Restore modified GL state</span></span>
<span class="line"><span style="color: #e1e4e8">    glBindTexture(GL_TEXTURE_2D, last_texture);</span></span>
<span class="line"><span style="color: #e1e4e8">    glBindBuffer(GL_ARRAY_BUFFER, last_array_buffer);</span></span>
<span class="line"><span style="color: #e1e4e8">    glBindVertexArray(last_vertex_array);</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">    return True;</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">sizeof</span></span>
<span class="line"><span style="color: #e1e4e8">%constant int SIZEOF_ImDrawVert = sizeof(ImDrawVert);</span></span>
<span class="line"><span style="color: #e1e4e8">%constant int SIZEOF_ImDrawIdx = sizeof(ImDrawIdx);</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">offset</span></span>
<span class="line"><span style="color: #e1e4e8">%{</span></span>
<span class="line"><span style="color: #e1e4e8">#define OFFSETOF(TYPE, ELEMENT) ((size_t)&#x26;(((TYPE \*)0)->ELEMENT))</span></span>
<span class="line"><span style="color: #e1e4e8">const int OFFSETOF_ImDrawVert_pos = OFFSETOF(ImDrawVert, pos);</span></span>
<span class="line"><span style="color: #e1e4e8">const int OFFSETOF_ImDrawVert_uv = OFFSETOF(ImDrawVert, uv);</span></span>
<span class="line"><span style="color: #e1e4e8">const int OFFSETOF_ImDrawVert_col = OFFSETOF(ImDrawVert, col);</span></span>
<span class="line"><span style="color: #e1e4e8">#undef OFFSETOF</span></span>
<span class="line"><span style="color: #e1e4e8">%}</span></span>
<span class="line"><span style="color: #e1e4e8">const int OFFSETOF_ImDrawVert_pos = OFFSETOF_ImDrawVert_pos;</span></span>
<span class="line"><span style="color: #e1e4e8">const int OFFSETOF_ImDrawVert_uv = OFFSETOF_ImDrawVert_uv;</span></span>
<span class="line"><span style="color: #e1e4e8">const int OFFSETOF_ImDrawVert_col = OFFSETOF_ImDrawVert_col;</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">CreateFontsTexture の移植</span></span>
<span class="line"><span style="color: #e1e4e8">def CreateFontsTexture(): # Build texture atlas</span></span>
<span class="line"><span style="color: #e1e4e8">io = imgui.GetIO(); # Load as RGBA 32-bits for OpenGL3 demo because it is more likely to be compatible with user's existing shader.</span></span>
<span class="line"><span style="color: #e1e4e8">pixels, width, height=io.Fonts.GetTexDataAsRGBA32();</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">    # Upload texture to graphics system</span></span>
<span class="line"><span style="color: #e1e4e8">    last_texture=glGetIntegerv(GL_TEXTURE_BINDING_2D);</span></span>
<span class="line"><span style="color: #e1e4e8">    g_FontTexture=glGenTextures(1);</span></span>
<span class="line"><span style="color: #e1e4e8">    glBindTexture(GL_TEXTURE_2D, g_FontTexture);</span></span>
<span class="line"><span style="color: #e1e4e8">    glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_MIN_FILTER, GL_LINEAR);</span></span>
<span class="line"><span style="color: #e1e4e8">    glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_MAG_FILTER, GL_LINEAR);</span></span>
<span class="line"><span style="color: #e1e4e8">    glPixelStorei(GL_UNPACK_ROW_LENGTH, 0);</span></span>
<span class="line"><span style="color: #e1e4e8">    glTexImage2D(GL_TEXTURE_2D, 0, GL_RGBA, width, height, 0, GL_RGBA, GL_UNSIGNED_BYTE, pixels);</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">    # Store our identifier</span></span>
<span class="line"><span style="color: #e1e4e8">    io.Fonts.TexID = g_FontTexture;</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">    # Restore state</span></span>
<span class="line"><span style="color: #e1e4e8">    glBindTexture(GL_TEXTURE_2D, last_texture);</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">値を返すためにポインタ引数を出力に使い(in + argout)、長さの分かっているバイト列へのポインタを bytes として返す</span></span>
<span class="line"><span style="color: #e1e4e8">対象はこれ。</span></span>
<span class="line"><span style="color: #e1e4e8">IMGUI_API void GetTexDataAsRGBA32(unsigned char\*_ out_pixels, int_ out_width, int* out_height, int* out_bytes_per_pixel = NULL);</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">typemap でやってみる。</span></span>
<span class="line"><span style="color: #e1e4e8">imgui.i の%include "imgui/imgui.h"より前に記述。</span></span>
<span class="line"><span style="color: #e1e4e8">%typemap(in, numinputs=0) (unsigned char** out_pixels, int* out_width, int* out_height, int* out_bytes_per_pixel) (unsigned char *tempP, int tempW, int tempH, int tempB) {</span></span>
<span class="line"><span style="color: #e1e4e8">$1 = &#x26;tempP;</span></span>
<span class="line"><span style="color: #e1e4e8">$2 = &#x26;tempW;</span></span>
<span class="line"><span style="color: #e1e4e8">$3 = &#x26;tempH;</span></span>
<span class="line"><span style="color: #e1e4e8">$4 = &#x26;tempB;</span></span>
<span class="line"><span style="color: #e1e4e8">}</span></span>
<span class="line"><span style="color: #e1e4e8">%typemap(argout)(unsigned char** out_pixels, int* out_width, int* out_height, int* out_bytes_per_pixel){</span></span>
<span class="line"><span style="color: #e1e4e8">auto b = PyBytes_FromStringAndSize((const char *)_$1, (_$2) _ (_$3) _ (_$4));</span></span>
<span class="line"><span style="color: #e1e4e8">auto w = PyLong_FromLong(_$2);</span></span>
<span class="line"><span style="color: #e1e4e8">auto h = PyLong_FromLong(_$3);</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">    if ((!$result) || ($result == Py_None)) {</span></span>
<span class="line"><span style="color: #e1e4e8">        // new tuple3</span></span>
<span class="line"><span style="color: #e1e4e8">        $result = PyTuple_New(3);</span></span>
<span class="line"><span style="color: #e1e4e8">        PyTuple_SetItem($result, 0, b);</span></span>
<span class="line"><span style="color: #e1e4e8">        PyTuple_SetItem($result, 1, w);</span></span>
<span class="line"><span style="color: #e1e4e8">        PyTuple_SetItem($result, 2, h);</span></span>
<span class="line"><span style="color: #e1e4e8">    }</span></span>
<span class="line"><span style="color: #e1e4e8">    else{</span></span>
<span class="line"><span style="color: #e1e4e8">        if (!PyTuple_Check($result)) {</span></span>
<span class="line"><span style="color: #e1e4e8">            // new tuple4</span></span>
<span class="line"><span style="color: #e1e4e8">            auto t= PyTuple_New(4);</span></span>
<span class="line"><span style="color: #e1e4e8">            PyTuple_SetItem(t, 0, $result);</span></span>
<span class="line"><span style="color: #e1e4e8">            PyTuple_SetItem(t, 1, b);</span></span>
<span class="line"><span style="color: #e1e4e8">            PyTuple_SetItem(t, 2, w);</span></span>
<span class="line"><span style="color: #e1e4e8">            PyTuple_SetItem(t, 3, h);</span></span>
<span class="line"><span style="color: #e1e4e8">            $result=t;</span></span>
<span class="line"><span style="color: #e1e4e8">        }</span></span>
<span class="line"><span style="color: #e1e4e8">        else {</span></span>
<span class="line"><span style="color: #e1e4e8">            // concat</span></span>
<span class="line"><span style="color: #e1e4e8">            auto head = $result;</span></span>
<span class="line"><span style="color: #e1e4e8">            auto tail = PyTuple_New(3);</span></span>
<span class="line"><span style="color: #e1e4e8">            PyTuple_SetItem($result, 0, b);</span></span>
<span class="line"><span style="color: #e1e4e8">            PyTuple_SetItem($result, 1, w);</span></span>
<span class="line"><span style="color: #e1e4e8">            PyTuple_SetItem($result, 2, h);</span></span>
<span class="line"><span style="color: #e1e4e8">            $result = PySequence_Concat(head, tail);</span></span>
<span class="line"><span style="color: #e1e4e8">            Py_DECREF(head);</span></span>
<span class="line"><span style="color: #e1e4e8">            Py_DECREF(tail);</span></span>
<span class="line"><span style="color: #e1e4e8">        }</span></span>
<span class="line"><span style="color: #e1e4e8">    }</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">}</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">typemap(in)で呼び出し時に出力変数を与える必要を無くして、typemap(argout)で呼び出し後の返り値を tuple 化して値を詰める。その際に、バイト列のサイズが計算できるので PyBytes_FromStringAndSize で bytes を作る。</span></span>
<span class="line"><span style="color: #e1e4e8">TexID のセッター</span></span>
<span class="line"><span style="color: #e1e4e8">int から void*への変換。</span></span>
<span class="line"><span style="color: #e1e4e8">%extend ImFontAtlas {</span></span>
<span class="line"><span style="color: #e1e4e8">void SetTexID(long long id) {</span></span>
<span class="line"><span style="color: #e1e4e8">self->TexID=reinterpret_cast&#x3C;void*>(id);</span></span>
<span class="line"><span style="color: #e1e4e8">}</span></span>
<span class="line"><span style="color: #e1e4e8">}</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">ここまで実装すると Texture の nullptr でプログラムがクラッシュしなくなる。</span></span>
<span class="line"><span style="color: #e1e4e8">imgui の widget に対する inout な引数</span></span>
<span class="line"><span style="color: #e1e4e8">float*</span></span>
<span class="line"><span style="color: #e1e4e8">IMGUI_API bool SliderFloat(const char* label, float* v, float v_min, float v_max, const char* display_format = "%.3f", float power = 1.0f);</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">argout にすると返り値が(bool, float)になっていまいちな気がする。</span></span>
<span class="line"><span style="color: #e1e4e8">swig で float\*型のヘルパークラスを作る。</span></span>
<span class="line"><span style="color: #e1e4e8">%include "cpointer.i"</span></span>
<span class="line"><span style="color: #e1e4e8">%pointer_functions(float, floatp);</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">f=imgui.new_floatp()</span></span>
<span class="line"><span style="color: #e1e4e8">imgui.floatp_assign(f, 0.0)</span></span>
<span class="line"><span style="color: #e1e4e8">imgui.SliderFloat("float", f, 0.0, 1.0);</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">bool*</span></span>
<span class="line"><span style="color: #e1e4e8">float と同様に。</span></span>
<span class="line"><span style="color: #e1e4e8">IMGUI_API void ShowTestWindow(bool* p_open = NULL);</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">%include "cpointer.i"</span></span>
<span class="line"><span style="color: #e1e4e8">%pointer_functions(bool, boolp);</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">    show_test_window = imgui.new_boolp();</span></span>
<span class="line"><span style="color: #e1e4e8">    imgui.boolp_assign(show_test_window, True)</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">    if imgui.Button("Test Window"): imgui.boolp_assign(show_test_window, not boolp_assign.value))</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">    if imgui.boolp_value(show_test_window):</span></span>
<span class="line"><span style="color: #e1e4e8">        imgui.SetNextWindowPos(imgui.ImVec2(650, 20), imgui.ImGuiSetCond_FirstUseEver);</span></span>
<span class="line"><span style="color: #e1e4e8">        imgui.ShowTestWindow(show_test_window);</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">動くとはいえこれはいかんな。ポインタクラスをもう少し便利にするか、別の方法を調べよう。</span></span>
<span class="line"><span style="color: #e1e4e8">float[3]</span></span>
<span class="line"><span style="color: #e1e4e8">IMGUI_API bool ColorEdit3(const char\* label, float col[3]);</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">typemap で list リストを受け取って、list に結果を格納するように記述する。</span></span>
<span class="line"><span style="color: #e1e4e8">%typemap(in) float col[3] (float temp[3]) {</span></span>
<span class="line"><span style="color: #e1e4e8">if (!PySequence_Check($input)) {</span></span>
<span class="line"><span style="color: #e1e4e8">        PyErr_SetString(PyExc_ValueError,"Expected a sequence");</span></span>
<span class="line"><span style="color: #e1e4e8">        return NULL;</span></span>
<span class="line"><span style="color: #e1e4e8">    }</span></span>
<span class="line"><span style="color: #e1e4e8">    if (PySequence_Length($input) &#x3C; $1_dim0) {</span></span>
<span class="line"><span style="color: #e1e4e8">        PyErr_SetString(PyExc_ValueError,"Size mismatch. Expected more than $1_dim0 elements");</span></span>
<span class="line"><span style="color: #e1e4e8">        return NULL;</span></span>
<span class="line"><span style="color: #e1e4e8">    }</span></span>
<span class="line"><span style="color: #e1e4e8">    for (int i = 0; i &#x3C; $1_dim0; i++) {</span></span>
<span class="line"><span style="color: #e1e4e8">        PyObject *o = PySequence_GetItem($input,i);</span></span>
<span class="line"><span style="color: #e1e4e8">if (PyNumber_Check(o)) {</span></span>
<span class="line"><span style="color: #e1e4e8">temp[i] = (float) PyFloat_AsDouble(o);</span></span>
<span class="line"><span style="color: #e1e4e8">}</span></span>
<span class="line"><span style="color: #e1e4e8">else {</span></span>
<span class="line"><span style="color: #e1e4e8">PyErr_SetString(PyExc_ValueError,"Sequence elements must be numbers");</span></span>
<span class="line"><span style="color: #e1e4e8">return NULL;</span></span>
<span class="line"><span style="color: #e1e4e8">}</span></span>
<span class="line"><span style="color: #e1e4e8">}</span></span>
<span class="line"><span style="color: #e1e4e8">$1 = temp;</span></span>
<span class="line"><span style="color: #e1e4e8">}</span></span>
<span class="line"><span style="color: #e1e4e8">%typemap(argout) float col[3] {</span></span>
<span class="line"><span style="color: #e1e4e8">    for (int i = 0; i &#x3C; $1_dim0; i++) {</span></span>
<span class="line"><span style="color: #e1e4e8">        PyObject *o = PyFloat_FromDouble((double) $1[i]);</span></span>
<span class="line"><span style="color: #e1e4e8">        PyList_SetItem($input, i, o);</span></span>
<span class="line"><span style="color: #e1e4e8">}</span></span>
<span class="line"><span style="color: #e1e4e8">}</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">clear_color = [114/255.0, 144/255.0, 154/255.0, 0];</span></span>
<span class="line"><span style="color: #e1e4e8">imgui.ColorEdit3("clear color", clear_color);</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">RenderDrawLists の移植</span></span>
<span class="line"><span style="color: #e1e4e8">def RenderDrawLists(draw_data):</span></span>
<span class="line"><span style="color: #e1e4e8">global g_ShaderHandle</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">    # Avoid rendering when minimized, scale coordinates for retina displays (screen coordinates != framebuffer coordinates)</span></span>
<span class="line"><span style="color: #e1e4e8">    io = imgui.GetIO();</span></span>
<span class="line"><span style="color: #e1e4e8">    fb_width = int(io.DisplaySize.x * io.DisplayFramebufferScale.x);</span></span>
<span class="line"><span style="color: #e1e4e8">    fb_height = int(io.DisplaySize.y * io.DisplayFramebufferScale.y);</span></span>
<span class="line"><span style="color: #e1e4e8">    if fb_width == 0 or fb_height == 0:</span></span>
<span class="line"><span style="color: #e1e4e8">        return;</span></span>
<span class="line"><span style="color: #e1e4e8">    draw_data.ScaleClipRects(io.DisplayFramebufferScale);</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">    # Backup GL state</span></span>
<span class="line"><span style="color: #e1e4e8">    last_active_texture=glGetIntegerv(GL_ACTIVE_TEXTURE);</span></span>
<span class="line"><span style="color: #e1e4e8">    glActiveTexture(GL_TEXTURE0);</span></span>
<span class="line"><span style="color: #e1e4e8">    last_program=glGetIntegerv(GL_CURRENT_PROGRAM);</span></span>
<span class="line"><span style="color: #e1e4e8">    last_texture=glGetIntegerv(GL_TEXTURE_BINDING_2D);</span></span>
<span class="line"><span style="color: #e1e4e8">    last_array_buffer=glGetIntegerv(GL_ARRAY_BUFFER_BINDING);</span></span>
<span class="line"><span style="color: #e1e4e8">    last_element_array_buffer=glGetIntegerv(GL_ELEMENT_ARRAY_BUFFER_BINDING);</span></span>
<span class="line"><span style="color: #e1e4e8">    last_vertex_array=glGetIntegerv(GL_VERTEX_ARRAY_BINDING);</span></span>
<span class="line"><span style="color: #e1e4e8">    last_blend_src_rgb=glGetIntegerv(GL_BLEND_SRC_RGB);</span></span>
<span class="line"><span style="color: #e1e4e8">    last_blend_dst_rgb=glGetIntegerv(GL_BLEND_DST_RGB);</span></span>
<span class="line"><span style="color: #e1e4e8">    last_blend_src_alpha=glGetIntegerv(GL_BLEND_SRC_ALPHA);</span></span>
<span class="line"><span style="color: #e1e4e8">    last_blend_dst_alpha=glGetIntegerv(GL_BLEND_DST_ALPHA);</span></span>
<span class="line"><span style="color: #e1e4e8">    last_blend_equation_rgb=glGetIntegerv(GL_BLEND_EQUATION_RGB);</span></span>
<span class="line"><span style="color: #e1e4e8">    last_blend_equation_alpha=glGetIntegerv(GL_BLEND_EQUATION_ALPHA);</span></span>
<span class="line"><span style="color: #e1e4e8">    last_viewport=glGetIntegerv(GL_VIEWPORT);</span></span>
<span class="line"><span style="color: #e1e4e8">    last_scissor_box=glGetIntegerv(GL_SCISSOR_BOX);</span></span>
<span class="line"><span style="color: #e1e4e8">    last_enable_blend = glIsEnabled(GL_BLEND);</span></span>
<span class="line"><span style="color: #e1e4e8">    last_enable_cull_face = glIsEnabled(GL_CULL_FACE);</span></span>
<span class="line"><span style="color: #e1e4e8">    last_enable_depth_test = glIsEnabled(GL_DEPTH_TEST);</span></span>
<span class="line"><span style="color: #e1e4e8">    last_enable_scissor_test = glIsEnabled(GL_SCISSOR_TEST);</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">    # Setup render state: alpha-blending enabled, no face culling, no depth testing, scissor enabled</span></span>
<span class="line"><span style="color: #e1e4e8">    glEnable(GL_BLEND);</span></span>
<span class="line"><span style="color: #e1e4e8">    glBlendEquation(GL_FUNC_ADD);</span></span>
<span class="line"><span style="color: #e1e4e8">    glBlendFunc(GL_SRC_ALPHA, GL_ONE_MINUS_SRC_ALPHA);</span></span>
<span class="line"><span style="color: #e1e4e8">    glDisable(GL_CULL_FACE);</span></span>
<span class="line"><span style="color: #e1e4e8">    glDisable(GL_DEPTH_TEST);</span></span>
<span class="line"><span style="color: #e1e4e8">    glEnable(GL_SCISSOR_TEST);</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">    # Setup viewport, orthographic projection matrix</span></span>
<span class="line"><span style="color: #e1e4e8">    glViewport(0, 0, fb_width, fb_height);</span></span>
<span class="line"><span style="color: #e1e4e8">    ortho_projection = (ctypes.c_float * 16)(</span></span>
<span class="line"><span style="color: #e1e4e8">         2.0/io.DisplaySize.x, 0.0,                   0.0, 0.0,</span></span>
<span class="line"><span style="color: #e1e4e8">         0.0,                  2.0/-io.DisplaySize.y, 0.0, 0.0,</span></span>
<span class="line"><span style="color: #e1e4e8">         0.0,                  0.0,                  -1.0, 0.0,</span></span>
<span class="line"><span style="color: #e1e4e8">        -1.0,                  1.0,                   0.0, 1.0,</span></span>
<span class="line"><span style="color: #e1e4e8">    );</span></span>
<span class="line"><span style="color: #e1e4e8">    glUseProgram(g_ShaderHandle);</span></span>
<span class="line"><span style="color: #e1e4e8">    glUniform1i(g_AttribLocationTex, 0);</span></span>
<span class="line"><span style="color: #e1e4e8">    glUniformMatrix4fv(g_AttribLocationProjMtx, 1, GL_FALSE, ortho_projection);</span></span>
<span class="line"><span style="color: #e1e4e8">    glBindVertexArray(g_VaoHandle);</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">    for n in range(draw_data.CmdListsCount):</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">        cmd_list = draw_data.CmdLists[n];</span></span>
<span class="line"><span style="color: #e1e4e8">        idx_buffer_offset = 0;</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">        glBindBuffer(GL_ARRAY_BUFFER, g_VboHandle);</span></span>
<span class="line"><span style="color: #e1e4e8">        glBufferData(GL_ARRAY_BUFFER, cmd_list.VtxBuffer.Size * SIZEOF_ImDrawVert, cmd_list.VtxBuffer.Data, GL_STREAM_DRAW);</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">        glBindBuffer(GL_ELEMENT_ARRAY_BUFFER, g_ElementsHandle);</span></span>
<span class="line"><span style="color: #e1e4e8">        glBufferData(GL_ELEMENT_ARRAY_BUFFER, cmd_list.IdxBuffer.Size * SIZEOF_ImDrawVert, cmd_list.IdxBuffer.Data, GL_STREAM_DRAW);</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">        for cmd_i in range(cmd_list.CmdBuffer.Size):</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">            pcmd = cmd_list.CmdBuffer[cmd_i];</span></span>
<span class="line"><span style="color: #e1e4e8">            if pcmd.UserCallback:</span></span>
<span class="line"><span style="color: #e1e4e8">                pcmd.UserCallback(cmd_list, pcmd);</span></span>
<span class="line"><span style="color: #e1e4e8">            else:</span></span>
<span class="line"><span style="color: #e1e4e8">                glBindTexture(GL_TEXTURE_2D, pcmd.TextureId);</span></span>
<span class="line"><span style="color: #e1e4e8">                glScissor(pcmd.ClipRect.x, (fb_height - pcmd.ClipRect.w), (pcmd.ClipRect.z - pcmd.ClipRect.x), (pcmd.ClipRect.w - pcmd.ClipRect.y));</span></span>
<span class="line"><span style="color: #e1e4e8">                glDrawElements(GL_TRIANGLES, pcmd.ElemCount, GL_UNSIGNED_SHORT, idx_buffer_offset);</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">            idx_buffer_offset += pcmd.ElemCount;</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">    # Restore modified GL state</span></span>
<span class="line"><span style="color: #e1e4e8">    glUseProgram(last_program);</span></span>
<span class="line"><span style="color: #e1e4e8">    glBindTexture(GL_TEXTURE_2D, last_texture);</span></span>
<span class="line"><span style="color: #e1e4e8">    glActiveTexture(last_active_texture);</span></span>
<span class="line"><span style="color: #e1e4e8">    glBindVertexArray(last_vertex_array);</span></span>
<span class="line"><span style="color: #e1e4e8">    glBindBuffer(GL_ARRAY_BUFFER, last_array_buffer);</span></span>
<span class="line"><span style="color: #e1e4e8">    glBindBuffer(GL_ELEMENT_ARRAY_BUFFER, last_element_array_buffer);</span></span>
<span class="line"><span style="color: #e1e4e8">    glBlendEquationSeparate(last_blend_equation_rgb, last_blend_equation_alpha);</span></span>
<span class="line"><span style="color: #e1e4e8">    glBlendFuncSeparate(last_blend_src_rgb, last_blend_dst_rgb, last_blend_src_alpha, last_blend_dst_alpha);</span></span>
<span class="line"><span style="color: #e1e4e8">    if (last_enable_blend):</span></span>
<span class="line"><span style="color: #e1e4e8">        glEnable(GL_BLEND);</span></span>
<span class="line"><span style="color: #e1e4e8">    else:</span></span>
<span class="line"><span style="color: #e1e4e8">        glDisable(GL_BLEND);</span></span>
<span class="line"><span style="color: #e1e4e8">    if (last_enable_cull_face):</span></span>
<span class="line"><span style="color: #e1e4e8">        glEnable(GL_CULL_FACE);</span></span>
<span class="line"><span style="color: #e1e4e8">    else:</span></span>
<span class="line"><span style="color: #e1e4e8">        glDisable(GL_CULL_FACE);</span></span>
<span class="line"><span style="color: #e1e4e8">    if (last_enable_depth_test):</span></span>
<span class="line"><span style="color: #e1e4e8">        glEnable(GL_DEPTH_TEST);</span></span>
<span class="line"><span style="color: #e1e4e8">    else:</span></span>
<span class="line"><span style="color: #e1e4e8">        glDisable(GL_DEPTH_TEST);</span></span>
<span class="line"><span style="color: #e1e4e8">    if (last_enable_scissor_test):</span></span>
<span class="line"><span style="color: #e1e4e8">        glEnable(GL_SCISSOR_TEST);</span></span>
<span class="line"><span style="color: #e1e4e8">    else:</span></span>
<span class="line"><span style="color: #e1e4e8">        glDisable(GL_SCISSOR_TEST);</span></span>
<span class="line"><span style="color: #e1e4e8">    glViewport(last_viewport[0], last_viewport[1], last_viewport[2], last_viewport[3]);</span></span>
<span class="line"><span style="color: #e1e4e8">    glScissor(last_scissor_box[0], last_scissor_box[1], last_scissor_box[2], last_scissor_box[3]);</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">getter</span></span>
<span class="line"><span style="color: #e1e4e8">配列アクセスできない。</span></span>
<span class="line"><span style="color: #e1e4e8">cmd_list = draw_data.CmdLists[n]</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">ゲッターを実装する</span></span>
<span class="line"><span style="color: #e1e4e8">%extend ImDrawData {</span></span>
<span class="line"><span style="color: #e1e4e8">ImDrawList\* GetCmdList(int n){</span></span>
<span class="line"><span style="color: #e1e4e8">return self->CmdLists[n];</span></span>
<span class="line"><span style="color: #e1e4e8">}</span></span>
<span class="line"><span style="color: #e1e4e8">}</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">template の型定義が無い</span></span>
<span class="line"><span style="color: #e1e4e8">実装する型を明示する。</span></span>
<span class="line"><span style="color: #e1e4e8">%template(ImVectorDrawVert) ImVector&#x3C;ImDrawVert>;</span></span>
<span class="line"><span style="color: #e1e4e8">%template(ImVectorDrawIdx) ImVector&#x3C;ImDrawIdx>;</span></span>
<span class="line"><span style="color: #e1e4e8">%template(ImVectorDrawCmd) ImVector&#x3C;ImDrawCmd>;</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">Byte 列を得る</span></span>
<span class="line"><span style="color: #e1e4e8">cmd_list.VtxBuffer.Data</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">%typemap(in, numinputs=0) (unsigned char** out_bytes, int* out_size) (unsigned char *tempP, int tempSize) {</span></span>
<span class="line"><span style="color: #e1e4e8">$1 = &#x26;tempP;</span></span>
<span class="line"><span style="color: #e1e4e8">$2 = &#x26;tempSize;</span></span>
<span class="line"><span style="color: #e1e4e8">}</span></span>
<span class="line"><span style="color: #e1e4e8">%typemap(argout)(unsigned char** out_bytes, int* out_size){</span></span>
<span class="line"><span style="color: #e1e4e8">auto b = PyBytes_FromStringAndSize((const char *)_$1, _$2);</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">    if ((!$result) || ($result == Py_None)) {</span></span>
<span class="line"><span style="color: #e1e4e8">        $result = b;</span></span>
<span class="line"><span style="color: #e1e4e8">    }</span></span>
<span class="line"><span style="color: #e1e4e8">    else{</span></span>
<span class="line"><span style="color: #e1e4e8">        if (!PyTuple_Check($result)) {</span></span>
<span class="line"><span style="color: #e1e4e8">            // new tuple4</span></span>
<span class="line"><span style="color: #e1e4e8">            auto t= PyTuple_New(2);</span></span>
<span class="line"><span style="color: #e1e4e8">            PyTuple_SetItem(t, 0, $result);</span></span>
<span class="line"><span style="color: #e1e4e8">            PyTuple_SetItem(t, 1, b);</span></span>
<span class="line"><span style="color: #e1e4e8">            $result=t;</span></span>
<span class="line"><span style="color: #e1e4e8">        }</span></span>
<span class="line"><span style="color: #e1e4e8">        else {</span></span>
<span class="line"><span style="color: #e1e4e8">            // concat</span></span>
<span class="line"><span style="color: #e1e4e8">            auto head = $result;</span></span>
<span class="line"><span style="color: #e1e4e8">            auto tail = PyTuple_New(1);</span></span>
<span class="line"><span style="color: #e1e4e8">            PyTuple_SetItem($result, 0, b);</span></span>
<span class="line"><span style="color: #e1e4e8">            $result = PySequence_Concat(head, tail);</span></span>
<span class="line"><span style="color: #e1e4e8">            Py_DECREF(head);</span></span>
<span class="line"><span style="color: #e1e4e8">            Py_DECREF(tail);</span></span>
<span class="line"><span style="color: #e1e4e8">        }</span></span>
<span class="line"><span style="color: #e1e4e8">    }</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">}</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">// before</span></span>
<span class="line"><span style="color: #e1e4e8">%include "imgui/imgui.h"</span></span>
<span class="line"><span style="color: #e1e4e8">// after</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">%extend ImDrawList {</span></span>
<span class="line"><span style="color: #e1e4e8">void GetVtxBufferData(unsigned char **out_bytes, int *out_size){</span></span>
<span class="line"><span style="color: #e1e4e8">*out_bytes=(unsigned char *)self->VtxBuffer.Data;</span></span>
<span class="line"><span style="color: #e1e4e8">*out_size=self->VtxBuffer.Size \* sizeof(self->VtxBuffer.Data[0]);</span></span>
<span class="line"><span style="color: #e1e4e8">}</span></span>
<span class="line"><span style="color: #e1e4e8">void GetIdxBufferData(unsigned char **out_bytes, int *out_size){</span></span>
<span class="line"><span style="color: #e1e4e8">*out_bytes=(unsigned char *)self->IdxBuffer.Data;</span></span>
<span class="line"><span style="color: #e1e4e8">*out_size=self->IdxBuffer.Size \* sizeof(self->IdxBuffer.Data[0]);</span></span>
<span class="line"><span style="color: #e1e4e8">}</span></span>
<span class="line"><span style="color: #e1e4e8">}</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">glBindBuffer(GL_ARRAY_BUFFER, g_VboHandle);</span></span>
<span class="line"><span style="color: #e1e4e8">glBufferData(GL_ARRAY_BUFFER, cmd_list.VtxBuffer.Size \* SIZEOF_ImDrawVert, cmd_list.GetVtxBufferData(), GL_STREAM_DRAW);</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">glBindBuffer(GL_ELEMENT_ARRAY_BUFFER, g_ElementsHandle);</span></span>
<span class="line"><span style="color: #e1e4e8">glBufferData(GL_ELEMENT_ARRAY_BUFFER, cmd_list.IdxBuffer.Size \* SIZEOF_Idx, cmd_list.GetIdxBufferData(), GL_STREAM_DRAW);</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">Shutdown の移植</span></span>
<span class="line"><span style="color: #e1e4e8">def Shutdown():</span></span>
<span class="line"><span style="color: #e1e4e8">InvalidateDeviceObjects();</span></span>
<span class="line"><span style="color: #e1e4e8">imgui.Shutdown();</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">def InvalidateDeviceObjects():</span></span>
<span class="line"><span style="color: #e1e4e8">global g_VaoHandle</span></span>
<span class="line"><span style="color: #e1e4e8">global g_VboHandle</span></span>
<span class="line"><span style="color: #e1e4e8">global g_ElementsHandle</span></span>
<span class="line"><span style="color: #e1e4e8">global g_ShaderHandle</span></span>
<span class="line"><span style="color: #e1e4e8">global g_VertHandle</span></span>
<span class="line"><span style="color: #e1e4e8">global g_FragHandle</span></span>
<span class="line"><span style="color: #e1e4e8">global g_FontTexture</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">    if (g_VaoHandle): glDeleteVertexArrays(1, g_VaoHandle);</span></span>
<span class="line"><span style="color: #e1e4e8">    if (g_VboHandle): glDeleteBuffers(1, g_VboHandle);</span></span>
<span class="line"><span style="color: #e1e4e8">    if (g_ElementsHandle): glDeleteBuffers(1, g_ElementsHandle);</span></span>
<span class="line"><span style="color: #e1e4e8">    g_VaoHandle = g_VboHandle = g_ElementsHandle = 0;</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">    if (g_ShaderHandle and g_VertHandle): glDetachShader(g_ShaderHandle, g_VertHandle);</span></span>
<span class="line"><span style="color: #e1e4e8">    if (g_VertHandle): glDeleteShader(g_VertHandle);</span></span>
<span class="line"><span style="color: #e1e4e8">    g_VertHandle = 0;</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">    if (g_ShaderHandle and g_FragHandle): glDetachShader(g_ShaderHandle, g_FragHandle);</span></span>
<span class="line"><span style="color: #e1e4e8">    if (g_FragHandle): glDeleteShader(g_FragHandle);</span></span>
<span class="line"><span style="color: #e1e4e8">    g_FragHandle = 0;</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">    if (g_ShaderHandle): glDeleteProgram(g_ShaderHandle);</span></span>
<span class="line"><span style="color: #e1e4e8">    g_ShaderHandle = 0;</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">    if (g_FontTexture):</span></span>
<span class="line"><span style="color: #e1e4e8">        glDeleteTextures(1, g_FontTexture);</span></span>
<span class="line"><span style="color: #e1e4e8">        imgui.GetIO().Fonts.SetTexID(0);</span></span>
<span class="line"><span style="color: #e1e4e8">        g_FontTexture = 0;</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">ProcessEvent の移植</span></span>
<span class="line"><span style="color: #e1e4e8">def ProcessEvent(event):</span></span>
<span class="line"><span style="color: #e1e4e8">global g_MouseWheel</span></span>
<span class="line"><span style="color: #e1e4e8">global g_MousePressed</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">    io = imgui.GetIO();</span></span>
<span class="line"><span style="color: #e1e4e8">    if event.type==SDL_MOUSEWHEEL:</span></span>
<span class="line"><span style="color: #e1e4e8">        if (event.wheel.y > 0):</span></span>
<span class="line"><span style="color: #e1e4e8">            g_MouseWheel = 1;</span></span>
<span class="line"><span style="color: #e1e4e8">        if (event.wheel.y &#x3C; 0):</span></span>
<span class="line"><span style="color: #e1e4e8">            g_MouseWheel = -1;</span></span>
<span class="line"><span style="color: #e1e4e8">        return True;</span></span>
<span class="line"><span style="color: #e1e4e8">    elif event.type==SDL_MOUSEBUTTONDOWN:</span></span>
<span class="line"><span style="color: #e1e4e8">        if (event.button.button == SDL_BUTTON_LEFT): g_MousePressed[0] = True;</span></span>
<span class="line"><span style="color: #e1e4e8">        if (event.button.button == SDL_BUTTON_RIGHT): g_MousePressed[1] = True;</span></span>
<span class="line"><span style="color: #e1e4e8">        if (event.button.button == SDL_BUTTON_MIDDLE): g_MousePressed[2] = True;</span></span>
<span class="line"><span style="color: #e1e4e8">        return True;</span></span>
<span class="line"><span style="color: #e1e4e8">    elif event.type==SDL_TEXTINPUT:</span></span>
<span class="line"><span style="color: #e1e4e8">        io.AddInputCharactersUTF8(event.text.text);</span></span>
<span class="line"><span style="color: #e1e4e8">        return True;</span></span>
<span class="line"><span style="color: #e1e4e8">    elif event.type==SDL_KEYDOWN or event.type==SDL_KEYUP:</span></span>
<span class="line"><span style="color: #e1e4e8">        key = event.key.keysym.sym &#x26; ~SDLK_SCANCODE_MASK;</span></span>
<span class="line"><span style="color: #e1e4e8">        io.SetKeysDown(key, event.type == SDL_KEYDOWN);</span></span>
<span class="line"><span style="color: #e1e4e8">        io.KeyShift = ((SDL_GetModState() &#x26; KMOD_SHIFT) != 0);</span></span>
<span class="line"><span style="color: #e1e4e8">        io.KeyCtrl = ((SDL_GetModState() &#x26; KMOD_CTRL) != 0);</span></span>
<span class="line"><span style="color: #e1e4e8">        io.KeyAlt = ((SDL_GetModState() &#x26; KMOD_ALT) != 0);</span></span>
<span class="line"><span style="color: #e1e4e8">        io.KeySuper = ((SDL_GetModState() &#x26; KMOD_GUI) != 0);</span></span>
<span class="line"><span style="color: #e1e4e8">        return True;</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">    return False;</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">io.KeysDown</span></span>
<span class="line"><span style="color: #e1e4e8">セッター</span></span>
<span class="line"><span style="color: #e1e4e8">%extend ImGuiIO {</span></span>
<span class="line"><span style="color: #e1e4e8">void SetKeysDown(int k, int v)</span></span>
<span class="line"><span style="color: #e1e4e8">{</span></span>
<span class="line"><span style="color: #e1e4e8">ImGui::GetIO().KeysDown[k]=v;</span></span>
<span class="line"><span style="color: #e1e4e8">}</span></span>
<span class="line"><span style="color: #e1e4e8">}</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">かくしてほぼ動くようになった。</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">実際には新しい Widget を Python から使用するたびに値をやりとりする部分を追加しなければならないが、そこはおいおいやっていく。</span></span>
<span class="line"><span style="color: #e1e4e8">VisualStudio のセットアップ</span></span>
<span class="line"><span style="color: #e1e4e8">こういうネイティブモジュールの開発ではないとクラッシュの原因を探すのが困難になるが、VisualStudio で普通にアタッチできるので便利。</span></span>
<span class="line"><span style="color: #e1e4e8">ひとつの solution に python プロジェクトと、c++の dll プロジェクトを同居させてデバッグできる。</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">あとで書く</span></span></code></pre>

				</div>
			</article>
		</main>
		<footer class="footer astro-SZ7XMLTE">
    <nav class="nav astro-SZ7XMLTE">
        <div class="astro-SZ7XMLTE">2021  &copy; Copyright notice |  <a href="https://github.com/one-aalam/astro-ink" title="三次元日誌(astro)'s Github URL'" class="astro-SZ7XMLTE">三次元日誌(astro)</a>
        <script>(()=>{var e=async t=>{await(await t())()};(self.Astro||(self.Astro={})).load=e;window.dispatchEvent(new Event("astro:load"));})();</script><astro-island uid="1QEdto" component-url="/_astro/ModeLabel.e3ff75e7.js" component-export="default" renderer-url="/_astro/client.cb726945.js" props="{&quot;class&quot;:[0,&quot;astro-SZ7XMLTE&quot;]}" ssr="" client="load" opts="{&quot;name&quot;:&quot;ModeLabel&quot;,&quot;value&quot;:true}" await-children=""><span slot="dark" data-svelte-h="svelte-14ov3lc">(dark)</span></astro-island> theme on <a href="https://astro.build/" class="astro-SZ7XMLTE">Astro</a></div>
        <astro-island uid="1I86to" component-url="/_astro/NetlifyIdentity.94b8edb0.js" component-export="default" renderer-url="/_astro/client.cb726945.js" props="{&quot;class&quot;:[0,&quot;astro-SZ7XMLTE&quot;]}" ssr="" client="load" opts="{&quot;name&quot;:&quot;NetlifyIdentity&quot;,&quot;value&quot;:true}"></astro-island>
    </nav>
</footer>
	</body></html>