<!DOCTYPE html>
<html lang="en" class="astro-BVZIHDZO">
	<head>
		<!-- Use Google Fonts, if you don't wanna prefer a self-hosted version --><!-- <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@300;400;500;600;700&display=swap" rel="stylesheet"> --><meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>Socket.IOな実験環境</title>
<meta name="title" content="Socket.IOな実験環境">


<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="shortcut icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">

<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="msapplication-config" content="/browserconfig.xml">
<meta name="theme-color" content="#ffffff">

<!-- Open Graph Tags (Facebook) -->
<meta property="og:type" content="website">
<meta property="og:title" content="Socket.IOな実験環境">




<!-- Twitter -->
<meta property="twitter:card" content="summary_large_image">
<meta property="twitter:title" content="Socket.IOな実験環境">





<script>
  const theme = (() => {
    if (typeof localStorage !== "undefined" && localStorage.getItem("theme")) {
      return localStorage.getItem("theme");
    }
    if (window.matchMedia("(prefers-color-scheme: dark)").matches) {
      return "dark";
    }
    return "light";
  })();

  if (theme === "light") {
    document.documentElement.classList.remove("dark");
  } else {
    document.documentElement.classList.add("dark");
  }
</script>
		
	<link rel="stylesheet" href="/_astro/about.6111bb3a.css" />
<link rel="stylesheet" href="/_astro/about.657f8f57.css" />
<link rel="stylesheet" href="/_astro/about.ee60a110.css" />
<link rel="stylesheet" href="/_astro/about.dcb84f3d.css" /><script type="module" src="/_astro/hoisted.e6960f2c.js"></script></head>

	<body class="astro-BVZIHDZO">
		<header class="header astro-3EF6KSR2">
    <div class="header__logo astro-3EF6KSR2">
        <a href="/" class="avatar astro-3EF6KSR2">
            <img class="header__logo-img astro-3EF6KSR2" src="/assets/logo.svg" alt="Astro logo">
        </a>
    </div>
    <div class="header__meta flex-1 astro-3EF6KSR2">
        <h3 class="header__title dark:text-theme-dark-secondary astro-3EF6KSR2">
            <a href="" class="astro-3EF6KSR2">三次元日誌(astro)</a>
        </h3>
        <div class="header__meta-more flex astro-3EF6KSR2">
            <p class="header__desc astro-3EF6KSR2">
                Crisp, minimal, personal blog theme for Astro
            </p>
            <nav class="header__nav flex astro-3EF6KSR2">
                <ul class="header__ref-list astro-3EF6KSR2">
                    <li class="astro-3EF6KSR2">
                        <style>astro-island,astro-slot,astro-static-slot{display:contents}</style><script>(()=>{var r=(i,c,n)=>{let s=async()=>{await(await i())()},t=new IntersectionObserver(e=>{for(let o of e)if(o.isIntersecting){t.disconnect(),s();break}});for(let e of n.children)t.observe(e)};(self.Astro||(self.Astro={})).visible=r;window.dispatchEvent(new Event("astro:visible"));})();;(()=>{var d;{let p={0:t=>u(t),1:t=>l(t),2:t=>new RegExp(t),3:t=>new Date(t),4:t=>new Map(l(t)),5:t=>new Set(l(t)),6:t=>BigInt(t),7:t=>new URL(t),8:t=>new Uint8Array(t),9:t=>new Uint16Array(t),10:t=>new Uint32Array(t)},h=t=>{let[e,n]=t;return e in p?p[e](n):void 0},l=t=>t.map(h),u=t=>typeof t!="object"||t===null?t:Object.fromEntries(Object.entries(t).map(([e,n])=>[e,h(n)]));customElements.get("astro-island")||customElements.define("astro-island",(d=class extends HTMLElement{constructor(){super(...arguments);this.hydrate=async()=>{var i;if(!this.hydrator||!this.isConnected)return;let e=(i=this.parentElement)==null?void 0:i.closest("astro-island[ssr]");if(e){e.addEventListener("astro:hydrate",this.hydrate,{once:!0});return}let n=this.querySelectorAll("astro-slot"),o={},a=this.querySelectorAll("template[data-astro-template]");for(let r of a){let s=r.closest(this.tagName);s!=null&&s.isSameNode(this)&&(o[r.getAttribute("data-astro-template")||"default"]=r.innerHTML,r.remove())}for(let r of n){let s=r.closest(this.tagName);s!=null&&s.isSameNode(this)&&(o[r.getAttribute("name")||"default"]=r.innerHTML)}let c;try{c=this.hasAttribute("props")?u(JSON.parse(this.getAttribute("props"))):{}}catch(r){let s=this.getAttribute("component-url")||"<unknown>",y=this.getAttribute("component-export");throw y&&(s+=` (export ${y})`),console.error(`[hydrate] Error parsing props for component ${s}`,this.getAttribute("props"),r),r}await this.hydrator(this)(this.Component,c,o,{client:this.getAttribute("client")}),this.removeAttribute("ssr"),this.dispatchEvent(new CustomEvent("astro:hydrate"))}}connectedCallback(){!this.hasAttribute("await-children")||this.firstChild?this.childrenConnectedCallback():new MutationObserver((e,n)=>{n.disconnect(),setTimeout(()=>this.childrenConnectedCallback(),0)}).observe(this,{childList:!0})}async childrenConnectedCallback(){let e=this.getAttribute("before-hydration-url");e&&await import(e),this.start()}start(){let e=JSON.parse(this.getAttribute("opts")),n=this.getAttribute("client");if(Astro[n]===void 0){window.addEventListener(`astro:${n}`,()=>this.start(),{once:!0});return}Astro[n](async()=>{let o=this.getAttribute("renderer-url"),[a,{default:c}]=await Promise.all([import(this.getAttribute("component-url")),o?import(o):()=>()=>{}]),i=this.getAttribute("component-export")||"default";if(!i.includes("."))this.Component=a[i];else{this.Component=a;for(let r of i.split("."))this.Component=this.Component[r]}return this.hydrator=c,this.hydrate},e,this)}attributeChangedCallback(){this.hydrate()}},d.observedAttributes=["props"],d))}})();</script><astro-island uid="2iKzVC" component-url="/_astro/SearchBtn.984510f3.js" component-export="default" renderer-url="/_astro/client.cb726945.js" props="{&quot;class&quot;:[0,&quot;astro-3EF6KSR2&quot;]}" ssr="" client="visible" opts="{&quot;name&quot;:&quot;SearchBtn&quot;,&quot;value&quot;:true}" await-children=""><button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"> <path fill-rule="evenodd" clip-rule="evenodd" d="M16.2071 4.89344C19.0923 7.77862 19.3131 12.3193 16.8693 15.4578C16.8846 15.4713 16.8996 15.4854 16.9143 15.5L21.1569 19.7427C21.5474 20.1332 21.5474 20.7664 21.1569 21.1569C20.7664 21.5474 20.1332 21.5474 19.7427 21.1569L15.5 16.9143C15.4854 16.8996 15.4713 16.8846 15.4578 16.8693C12.3193 19.3131 7.77862 19.0923 4.89344 16.2071C1.76924 13.083 1.76924 8.01763 4.89344 4.89344C8.01763 1.76924 13.083 1.76924 16.2071 4.89344ZM14.7929 14.7929C17.1361 12.4498 17.1361 8.6508 14.7929 6.30765C12.4498 3.96451 8.6508 3.96451 6.30765 6.30765C3.96451 8.6508 3.96451 12.4498 6.30765 14.7929C8.6508 17.1361 12.4498 17.1361 14.7929 14.7929Z" fill="currentColor"></path></svg></button></astro-island>
                    </li>
                    <li class="astro-3EF6KSR2">
                        <a href="https://github.com/one-aalam/astro-ink" title="三次元日誌(astro)'s Github URL'" class="astro-3EF6KSR2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    
                                <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22" class="astro-3EF6KSR2"></path>
                            
</svg>
                        </a>
                    </li>
                    <li class="astro-3EF6KSR2">
                        <a href="/rss.xml" title="RSS" class="astro-3EF6KSR2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    
                                <path d="M4 11a9 9 0 0 1 9 9" class="astro-3EF6KSR2"></path>
                                <path d="M4 4a16 16 0 0 1 16 16" class="astro-3EF6KSR2"></path>
                                <circle cx="5" cy="19" r="1" class="astro-3EF6KSR2"></circle>
                            
</svg>
                        </a>
                    </li>
                    <li class="astro-3EF6KSR2">
                        <astro-island uid="h8S6z" component-url="/_astro/ModeSwitcherBtn.0ddc5d6d.js" component-export="default" renderer-url="/_astro/client.cb726945.js" props="{&quot;class&quot;:[0,&quot;astro-3EF6KSR2&quot;]}" ssr="" client="visible" opts="{&quot;name&quot;:&quot;ModeSwitcherBtn&quot;,&quot;value&quot;:true}" await-children=""><button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle> <line x1="12" y1="1" x2="12" y2="3"></line> <line x1="12" y1="21" x2="12" y2="23"></line> <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line> <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line> <line x1="1" y1="12" x2="3" y2="12"></line> <line x1="21" y1="12" x2="23" y2="12"></line> <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line> <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg></button></astro-island>
                    </li>
                </ul>
            </nav>
        </div>
    </div>
</header>
		<main class="astro-BVZIHDZO">
			<article class="astro-BVZIHDZO">
				<div class="hero-image astro-BVZIHDZO">
					
				</div>
				<div class="prose astro-BVZIHDZO">
					<div class="title astro-BVZIHDZO">
						<div class="date astro-BVZIHDZO">
							<time datetime="2015-12-11T00:00:00.000Z">
	Dec 11, 2015
</time>
							
						</div>
						<h1 class="astro-BVZIHDZO">Socket.IOな実験環境</h1>
						<hr class="astro-BVZIHDZO">
					</div>
					
	<p>Socket.IO を実験する環境のメモ。</p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #e1e4e8">Expressは、serve-staticで静的なファイルのhostingが目的兼後で拡張できるように</span></span>
<span class="line"><span style="color: #e1e4e8">coffee-scriptは無しでES6要素をなるべく入れる</span></span>
<span class="line"><span style="color: #e1e4e8">Socket.IOを手早く展開するのが目的なのでtypescriptは抜きにしようと思ったが、無い方がつらいので矢張り入れる</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">https://github.com/ousttrue/sio_sample</span></span>
<span class="line"><span style="color: #e1e4e8">Project生成</span></span>
<span class="line"><span style="color: #e1e4e8">> mkdir sio_sample</span></span>
<span class="line"><span style="color: #e1e4e8">> cd sio_sample</span></span>
<span class="line"><span style="color: #e1e4e8">sio_sample> npm init -y</span></span>
<span class="line"><span style="color: #e1e4e8">sio_sample> npm install gulp gulp-load-plugins gulp-nodemon browser-sync -D</span></span>
<span class="line"><span style="color: #e1e4e8">sio_sample> npm install express socket.io body-parser method-override connect-logger errorhandler serve-static --save</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">vscodeでes6を使えるように</span></span>
<span class="line"><span style="color: #e1e4e8">jsconifg.json</span></span>
<span class="line"><span style="color: #e1e4e8">{</span></span>
<span class="line"><span style="color: #e1e4e8">    "compilerOptions": {</span></span>
<span class="line"><span style="color: #e1e4e8">        "target": "ES6"</span></span>
<span class="line"><span style="color: #e1e4e8">    }</span></span>
<span class="line"><span style="color: #e1e4e8">}</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">後で拡張できるように以下のようなディレクトリ構成にする。</span></span>
<span class="line"><span style="color: #e1e4e8">build &#x3C;- srcから(加工して)コピーされる</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">src &#x3C;- 加工前のファイル置き場</span></span>
<span class="line"><span style="color: #e1e4e8">  + server</span></span>
<span class="line"><span style="color: #e1e4e8">    + app.js</span></span>
<span class="line"><span style="color: #e1e4e8">  + client</span></span>
<span class="line"><span style="color: #e1e4e8">    + index.html</span></span>
<span class="line"><span style="color: #e1e4e8">    + index.js</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">src/server/app.js</span></span>
<span class="line"><span style="color: #e1e4e8">"use strict";</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">const http = require('http');</span></span>
<span class="line"><span style="color: #e1e4e8">const express = require('express');</span></span>
<span class="line"><span style="color: #e1e4e8">const port = process.env.port || 3000;</span></span>
<span class="line"><span style="color: #e1e4e8">const app = express();</span></span>
<span class="line"><span style="color: #e1e4e8">const server = http.createServer(app);</span></span>
<span class="line"><span style="color: #e1e4e8">const servestatic = require('serve-static');</span></span>
<span class="line"><span style="color: #e1e4e8">const serve_dir = __dirname + '/public';</span></span>
<span class="line"><span style="color: #e1e4e8">console.log('serve %s', serve_dir);</span></span>
<span class="line"><span style="color: #e1e4e8">app</span></span>
<span class="line"><span style="color: #e1e4e8">    .use(servestatic(serve_dir))</span></span>
<span class="line"><span style="color: #e1e4e8">;</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">// socket.io</span></span>
<span class="line"><span style="color: #e1e4e8">const socketio = require('socket.io');</span></span>
<span class="line"><span style="color: #e1e4e8">const io = socketio(server);</span></span>
<span class="line"><span style="color: #e1e4e8">io.on('connection', (socket) => {</span></span>
<span class="line"><span style="color: #e1e4e8">    console.log('a client connected %s', socket);</span></span>
<span class="line"><span style="color: #e1e4e8">    socket.on('disconnect', () => {</span></span>
<span class="line"><span style="color: #e1e4e8">        console.log('a client disconnected');</span></span>
<span class="line"><span style="color: #e1e4e8">    });</span></span>
<span class="line"><span style="color: #e1e4e8">});</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">// start</span></span>
<span class="line"><span style="color: #e1e4e8">server.listen(port);</span></span>
<span class="line"><span style="color: #e1e4e8">console.log('start port: %d...', port);</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">src/client/index.html</span></span>
<span class="line"><span style="color: #e1e4e8">&#x3C;!DOCTYPE html></span></span>
<span class="line"><span style="color: #e1e4e8">&#x3C;html lang="en"></span></span>
<span class="line"><span style="color: #e1e4e8">&#x3C;head></span></span>
<span class="line"><span style="color: #e1e4e8">    &#x3C;meta charset="UTF-8"></span></span>
<span class="line"><span style="color: #e1e4e8">    &#x3C;title>Document&#x3C;/title></span></span>
<span class="line"><span style="color: #e1e4e8">    &#x3C;script src="index.js">&#x3C;/script></span></span>
<span class="line"><span style="color: #e1e4e8">&#x3C;/head></span></span>
<span class="line"><span style="color: #e1e4e8">&#x3C;body></span></span>
<span class="line"><span style="color: #e1e4e8">    &#x3C;div id="target">&#x3C;/div></span></span>
<span class="line"><span style="color: #e1e4e8">&#x3C;/body></span></span>
<span class="line"><span style="color: #e1e4e8">&#x3C;/html></span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">src/client/index.js</span></span>
<span class="line"><span style="color: #e1e4e8">"use strict";</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">function setup(target) {</span></span>
<span class="line"><span style="color: #e1e4e8">    const div = document.createElement('div');</span></span>
<span class="line"><span style="color: #e1e4e8">    div.appendChild(document.createTextNode('onLoad'));</span></span>
<span class="line"><span style="color: #e1e4e8">    target.appendChild(div);</span></span>
<span class="line"><span style="color: #e1e4e8">}</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">window.onload = () => {</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">    setup(document.getElementById('target'));</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">};</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">srcからbuildに展開するgulp</span></span>
<span class="line"><span style="color: #e1e4e8">gulpfile.js</span></span>
<span class="line"><span style="color: #e1e4e8">const gulp = require('gulp');</span></span>
<span class="line"><span style="color: #e1e4e8">const $ = require('gulp-load-plugins')();</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">const config = {</span></span>
<span class="line"><span style="color: #e1e4e8">    server_src: './src/server/**/*',</span></span>
<span class="line"><span style="color: #e1e4e8">    server_dst: './build',</span></span>
<span class="line"><span style="color: #e1e4e8">    client_src: './src/client/**/*',</span></span>
<span class="line"><span style="color: #e1e4e8">    client_dst: './build/public'</span></span>
<span class="line"><span style="color: #e1e4e8">};</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">gulp.task('server', () => {</span></span>
<span class="line"><span style="color: #e1e4e8">    gulp.src(config.server_src)</span></span>
<span class="line"><span style="color: #e1e4e8">        .pipe(gulp.dest(config.server_dst));</span></span>
<span class="line"><span style="color: #e1e4e8">});</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">gulp.task('client', () => {</span></span>
<span class="line"><span style="color: #e1e4e8">    gulp.src(config.client_src)</span></span>
<span class="line"><span style="color: #e1e4e8">        .pipe(gulp.dest(config.client_dst));</span></span>
<span class="line"><span style="color: #e1e4e8">});</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">gulp.task('default', ['server', 'client']);</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">build</span></span>
<span class="line"><span style="color: #e1e4e8">sio_sample> gulp</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">ブラウザで動いた。</span></span>
<span class="line"><span style="color: #e1e4e8">browserSync導入</span></span>
<span class="line"><span style="color: #e1e4e8">gulpfile.js。browserSync</span></span>
<span class="line"><span style="color: #e1e4e8">const config = { // 追加分</span></span>
<span class="line"><span style="color: #e1e4e8">    app_entry: './build/app.js',</span></span>
<span class="line"><span style="color: #e1e4e8">    app_port: 5000,</span></span>
<span class="line"><span style="color: #e1e4e8">};</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">const browserSync = require('browser-sync').create();</span></span>
<span class="line"><span style="color: #e1e4e8">gulp.task('serve', ()=>{</span></span>
<span class="line"><span style="color: #e1e4e8">    $.nodemon({</span></span>
<span class="line"><span style="color: #e1e4e8">        script: config.app_entry,</span></span>
<span class="line"><span style="color: #e1e4e8">        exp: 'js',</span></span>
<span class="line"><span style="color: #e1e4e8">        ignore: [],</span></span>
<span class="line"><span style="color: #e1e4e8">        env: {</span></span>
<span class="line"><span style="color: #e1e4e8">            port: config.app_port</span></span>
<span class="line"><span style="color: #e1e4e8">        }</span></span>
<span class="line"><span style="color: #e1e4e8">    })</span></span>
<span class="line"><span style="color: #e1e4e8">    .on('readable', ()=>{</span></span>
<span class="line"><span style="color: #e1e4e8">        this.stdout.on('data', (chunk)=>{</span></span>
<span class="line"><span style="color: #e1e4e8">            if (/^start /.test(chunk)){</span></span>
<span class="line"><span style="color: #e1e4e8">                console.log('reloading...');</span></span>
<span class="line"><span style="color: #e1e4e8">                browserSync.reload();</span></span>
<span class="line"><span style="color: #e1e4e8">            }</span></span>
<span class="line"><span style="color: #e1e4e8">            process.stdout.write(chunk)</span></span>
<span class="line"><span style="color: #e1e4e8">        });</span></span>
<span class="line"><span style="color: #e1e4e8">    });</span></span>
<span class="line"><span style="color: #e1e4e8">});</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">gulp.task('browser-sync', ['serve'], ()=>{</span></span>
<span class="line"><span style="color: #e1e4e8">    browserSync.init({</span></span>
<span class="line"><span style="color: #e1e4e8">        proxy: 'localhost:' + config.app_port,</span></span>
<span class="line"><span style="color: #e1e4e8">        port: 3000,</span></span>
<span class="line"><span style="color: #e1e4e8">        ws: true</span></span>
<span class="line"><span style="color: #e1e4e8">    })</span></span>
<span class="line"><span style="color: #e1e4e8">});</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">gulpfile.js。watchタスク追加</span></span>
<span class="line"><span style="color: #e1e4e8">gulp.task('server', () => {</span></span>
<span class="line"><span style="color: #e1e4e8">    gulp.src(config.server_src)</span></span>
<span class="line"><span style="color: #e1e4e8">        .pipe(gulp.dest(config.server_dst))</span></span>
<span class="line"><span style="color: #e1e4e8">        .pipe(browserSync.stream())</span></span>
<span class="line"><span style="color: #e1e4e8">        ;</span></span>
<span class="line"><span style="color: #e1e4e8">});</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">gulp.task('client', () => {</span></span>
<span class="line"><span style="color: #e1e4e8">    gulp.src(config.client_src)</span></span>
<span class="line"><span style="color: #e1e4e8">        .pipe(gulp.dest(config.client_dst))</span></span>
<span class="line"><span style="color: #e1e4e8">        .pipe(browserSync.stream())</span></span>
<span class="line"><span style="color: #e1e4e8">        ;</span></span>
<span class="line"><span style="color: #e1e4e8">});</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">gulp.task('build', ['server', 'client']);</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">gulp.task('watch', ['build', 'browser-sync'], ()=>{</span></span>
<span class="line"><span style="color: #e1e4e8">    gulp.watch(config.server_src, ['server']);</span></span>
<span class="line"><span style="color: #e1e4e8">    gulp.watch(config.client_src, ['client']);</span></span>
<span class="line"><span style="color: #e1e4e8">});</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">gulp.task('default', ['watch']);</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">git</span></span>
<span class="line"><span style="color: #e1e4e8">いったんgitに登録しよう。</span></span>
<span class="line"><span style="color: #e1e4e8">.gitignore</span></span>
<span class="line"><span style="color: #e1e4e8">/node_modules/</span></span>
<span class="line"><span style="color: #e1e4e8">/build/</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">Socket.IOの疎通</span></span>
<span class="line"><span style="color: #e1e4e8">&#x3C;!DOCTYPE html></span></span>
<span class="line"><span style="color: #e1e4e8">&#x3C;html lang="en"></span></span>
<span class="line"><span style="color: #e1e4e8">&#x3C;head></span></span>
<span class="line"><span style="color: #e1e4e8">    &#x3C;meta charset="UTF-8"></span></span>
<span class="line"><span style="color: #e1e4e8">    &#x3C;title>Document&#x3C;/title></span></span>
<span class="line"><span style="color: #e1e4e8">    &#x3C;script type="text/javascript" src="/socket.io/socket.io.js">&#x3C;/script></span></span>
<span class="line"><span style="color: #e1e4e8">    &#x3C;script src="index.js">&#x3C;/script></span></span>
<span class="line"><span style="color: #e1e4e8">&#x3C;/head></span></span>
<span class="line"><span style="color: #e1e4e8">&#x3C;body></span></span>
<span class="line"><span style="color: #e1e4e8">    &#x3C;div id="target">&#x3C;/div></span></span>
<span class="line"><span style="color: #e1e4e8">&#x3C;/body></span></span>
<span class="line"><span style="color: #e1e4e8">&#x3C;/html></span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">"use strict";</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">function setup(target) {</span></span>
<span class="line"><span style="color: #e1e4e8">    const div = document.createElement('div');</span></span>
<span class="line"><span style="color: #e1e4e8">    div.appendChild(document.createTextNode('hello'));</span></span>
<span class="line"><span style="color: #e1e4e8">    target.appendChild(div);</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">    this.socket = io.connect();</span></span>
<span class="line"><span style="color: #e1e4e8">}</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">window.onload = () => {</span></span>
<span class="line"><span style="color: #e1e4e8">    setup(document.getElementById('target'));</span></span>
<span class="line"><span style="color: #e1e4e8">};</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">typescript導入</span></span>
<span class="line"><span style="color: #e1e4e8">sio_sample> tsc --init</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">tsconfig.json</span></span>
<span class="line"><span style="color: #e1e4e8">{</span></span>
<span class="line"><span style="color: #e1e4e8">    "compilerOptions": {</span></span>
<span class="line"><span style="color: #e1e4e8">        "module": "commonjs",</span></span>
<span class="line"><span style="color: #e1e4e8">        "target": "es5",</span></span>
<span class="line"><span style="color: #e1e4e8">        "noImplicitAny": true,</span></span>
<span class="line"><span style="color: #e1e4e8">        "outDir": ".",</span></span>
<span class="line"><span style="color: #e1e4e8">        "rootDir": ".",</span></span>
<span class="line"><span style="color: #e1e4e8">        "sourceMap": false</span></span>
<span class="line"><span style="color: #e1e4e8">    },</span></span>
<span class="line"><span style="color: #e1e4e8">    "exclude": [</span></span>
<span class="line"><span style="color: #e1e4e8">        "node_modules"</span></span>
<span class="line"><span style="color: #e1e4e8">    ]</span></span>
<span class="line"><span style="color: #e1e4e8">}</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">sio_sample> npm install gulp-typescript gulp-if gulp-plumber gulp-debug -D</span></span>
<span class="line"><span style="color: #e1e4e8">sio_sample> cd src</span></span>
<span class="line"><span style="color: #e1e4e8">sio_sample/src> tsd init</span></span>
<span class="line"><span style="color: #e1e4e8">sio_sample/src> tsd query node express socket.io -rosa install</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">gulpfile.js。typescriptのコンパイルを追加</span></span>
<span class="line"><span style="color: #e1e4e8">const path = require('path');</span></span>
<span class="line"><span style="color: #e1e4e8">const tsconfig = require('./tsconfig.json');</span></span>
<span class="line"><span style="color: #e1e4e8">const isTypescript = (file) => {</span></span>
<span class="line"><span style="color: #e1e4e8">    const ext = path.extname(file.path).toLowerCase();</span></span>
<span class="line"><span style="color: #e1e4e8">    return ext === '.ts';</span></span>
<span class="line"><span style="color: #e1e4e8">}</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">gulp.task('server', () => {</span></span>
<span class="line"><span style="color: #e1e4e8">    gulp.src(config.server_src)</span></span>
<span class="line"><span style="color: #e1e4e8">        .pipe($.plumber())</span></span>
<span class="line"><span style="color: #e1e4e8">        .pipe($.if(isTypescript, $.typescript(tsconfig.compilerOptions)))</span></span>
<span class="line"><span style="color: #e1e4e8">        .pipe($.debug('server'))</span></span>
<span class="line"><span style="color: #e1e4e8">        .pipe(gulp.dest(config.server_dst))</span></span>
<span class="line"><span style="color: #e1e4e8">        .pipe(browserSync.stream())</span></span>
<span class="line"><span style="color: #e1e4e8">    ;</span></span>
<span class="line"><span style="color: #e1e4e8">});</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">gulp.task('client', () => {</span></span>
<span class="line"><span style="color: #e1e4e8">    gulp.src(config.client_src)</span></span>
<span class="line"><span style="color: #e1e4e8">        .pipe($.plumber())</span></span>
<span class="line"><span style="color: #e1e4e8">        .pipe($.if(isTypescript, $.typescript(tsconfig.compilerOptions)))</span></span>
<span class="line"><span style="color: #e1e4e8">        .pipe($.debug('client'))</span></span>
<span class="line"><span style="color: #e1e4e8">        .pipe(gulp.dest(config.client_dst))</span></span>
<span class="line"><span style="color: #e1e4e8">        .pipe(browserSync.stream())</span></span>
<span class="line"><span style="color: #e1e4e8">    ;</span></span>
<span class="line"><span style="color: #e1e4e8">});</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">src/server/app.jsをapp.tsにリネーム</span></span>
<span class="line"><span style="color: #e1e4e8">/// &#x3C;reference path="../typings/tsd.d.ts" /></span></span>
<span class="line"><span style="color: #e1e4e8">"use strict";</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">import http = require('http');</span></span>
<span class="line"><span style="color: #e1e4e8">import express = require('express');</span></span>
<span class="line"><span style="color: #e1e4e8">const port = process.env.port || 3000;</span></span>
<span class="line"><span style="color: #e1e4e8">const app = express();</span></span>
<span class="line"><span style="color: #e1e4e8">const server = http.createServer(app);</span></span>
<span class="line"><span style="color: #e1e4e8">const servestatic = require('serve-static');</span></span>
<span class="line"><span style="color: #e1e4e8">const serve_dir = __dirname + '/public';</span></span>
<span class="line"><span style="color: #e1e4e8">console.log('serve %s', serve_dir);</span></span>
<span class="line"><span style="color: #e1e4e8">app</span></span>
<span class="line"><span style="color: #e1e4e8">    .use(servestatic(serve_dir))</span></span>
<span class="line"><span style="color: #e1e4e8">;</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">// socket.io</span></span>
<span class="line"><span style="color: #e1e4e8">import socketio = require('socket.io');</span></span>
<span class="line"><span style="color: #e1e4e8">const io = socketio(server);</span></span>
<span class="line"><span style="color: #e1e4e8">io.on('connection', (socket) => {</span></span>
<span class="line"><span style="color: #e1e4e8">    var clientAddress=socket.client.conn.remoteAddress;</span></span>
<span class="line"><span style="color: #e1e4e8">    console.log('connected: %s', clientAddress);</span></span>
<span class="line"><span style="color: #e1e4e8">    socket.on('disconnect', () => {</span></span>
<span class="line"><span style="color: #e1e4e8">        console.log('disconnected: %s', clientAddress);</span></span>
<span class="line"><span style="color: #e1e4e8">    });</span></span>
<span class="line"><span style="color: #e1e4e8">});</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">// start</span></span>
<span class="line"><span style="color: #e1e4e8">server.listen(port);</span></span>
<span class="line"><span style="color: #e1e4e8">console.log('start port: %d...', port);</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">src/client/index.jsをindex.tsにリネーム</span></span>
<span class="line"><span style="color: #e1e4e8">/// &#x3C;reference path="../typings/tsd.d.ts" /></span></span>
<span class="line"><span style="color: #e1e4e8">"use strict";</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">declare module io {</span></span>
<span class="line"><span style="color: #e1e4e8">    export function connect(): SocketIO.Socket;</span></span>
<span class="line"><span style="color: #e1e4e8">}</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">function setup(target: Element) {</span></span>
<span class="line"><span style="color: #e1e4e8">    const div = document.createElement('div');</span></span>
<span class="line"><span style="color: #e1e4e8">    div.appendChild(document.createTextNode('hello socket.io'));</span></span>
<span class="line"><span style="color: #e1e4e8">    target.appendChild(div);</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">    this.socket = io.connect();</span></span>
<span class="line"><span style="color: #e1e4e8">}</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">window.onload = () => {</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">    setup(document.getElementById('target'));</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">};</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">メッセージをやり取り</span></span>
<span class="line"><span style="color: #e1e4e8">src/server/app.ts サーバーサイド。client-messageを受けてserver-messageを発行</span></span>
<span class="line"><span style="color: #e1e4e8">// socket.io</span></span>
<span class="line"><span style="color: #e1e4e8">import socketio = require('socket.io');</span></span>
<span class="line"><span style="color: #e1e4e8">const io = socketio(server);</span></span>
<span class="line"><span style="color: #e1e4e8">io.on('connection', (socket) => {</span></span>
<span class="line"><span style="color: #e1e4e8">    var clientAddress = socket.client.conn.remoteAddress;</span></span>
<span class="line"><span style="color: #e1e4e8">    console.log('connected: %s', clientAddress);</span></span>
<span class="line"><span style="color: #e1e4e8">    socket.on('disconnect', () => {</span></span>
<span class="line"><span style="color: #e1e4e8">        console.log('disconnected: %s', clientAddress);</span></span>
<span class="line"><span style="color: #e1e4e8">    });</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">    socket.on('client-message', (data: any) => {</span></span>
<span class="line"><span style="color: #e1e4e8">        socket.emit('server-message', 'server clicked message');</span></span>
<span class="line"><span style="color: #e1e4e8">    });</span></span>
<span class="line"><span style="color: #e1e4e8">});</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">src/client/index.ts クライアントサイド。buttonを押したらclient-messageを発行。server-messageを受けてテキストを描画</span></span>
<span class="line"><span style="color: #e1e4e8">/// &#x3C;reference path="../typings/tsd.d.ts" /></span></span>
<span class="line"><span style="color: #e1e4e8">"use strict";</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">declare module io {</span></span>
<span class="line"><span style="color: #e1e4e8">    export function connect(): SocketIO.Socket;</span></span>
<span class="line"><span style="color: #e1e4e8">}</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">class Client {</span></span>
<span class="line"><span style="color: #e1e4e8">    socket: SocketIO.Socket;</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">    constructor() {</span></span>
<span class="line"><span style="color: #e1e4e8">        this.socket = io.connect();</span></span>
<span class="line"><span style="color: #e1e4e8">    }</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">    setup(target: Element) {</span></span>
<span class="line"><span style="color: #e1e4e8">        const div = document.createElement('div');</span></span>
<span class="line"><span style="color: #e1e4e8">        div.appendChild(document.createTextNode('hello socket.io'));</span></span>
<span class="line"><span style="color: #e1e4e8">        target.appendChild(div);</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">        this.socket.on('server-message', (data: any)=>{</span></span>
<span class="line"><span style="color: #e1e4e8">            const div = document.createElement('div');</span></span>
<span class="line"><span style="color: #e1e4e8">            div.appendChild(document.createTextNode(data.toString()));</span></span>
<span class="line"><span style="color: #e1e4e8">            target.appendChild(div);</span></span>
<span class="line"><span style="color: #e1e4e8">        });</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">        const button=document.createElement('button');</span></span>
<span class="line"><span style="color: #e1e4e8">        button.appendChild(document.createTextNode('send'));</span></span>
<span class="line"><span style="color: #e1e4e8">        button.onclick=(ev: MouseEvent)=>{</span></span>
<span class="line"><span style="color: #e1e4e8">            this.socket.emit('client-message', 'clicked');</span></span>
<span class="line"><span style="color: #e1e4e8">        };</span></span>
<span class="line"><span style="color: #e1e4e8">        target.appendChild(button);</span></span>
<span class="line"><span style="color: #e1e4e8">    }</span></span>
<span class="line"><span style="color: #e1e4e8">}</span></span>
<span class="line"><span style="color: #e1e4e8">var client=new Client();</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">window.onload = () => {</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">    client.setup(document.getElementById('target'));</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">};</span></span></code></pre>

				</div>
			</article>
		</main>
		<footer class="footer astro-SZ7XMLTE">
    <nav class="nav astro-SZ7XMLTE">
        <div class="astro-SZ7XMLTE">2021  &copy; Copyright notice |  <a href="https://github.com/one-aalam/astro-ink" title="三次元日誌(astro)'s Github URL'" class="astro-SZ7XMLTE">三次元日誌(astro)</a>
        <script>(()=>{var e=async t=>{await(await t())()};(self.Astro||(self.Astro={})).load=e;window.dispatchEvent(new Event("astro:load"));})();</script><astro-island uid="1QEdto" component-url="/_astro/ModeLabel.e3ff75e7.js" component-export="default" renderer-url="/_astro/client.cb726945.js" props="{&quot;class&quot;:[0,&quot;astro-SZ7XMLTE&quot;]}" ssr="" client="load" opts="{&quot;name&quot;:&quot;ModeLabel&quot;,&quot;value&quot;:true}" await-children=""><span slot="dark" data-svelte-h="svelte-14ov3lc">(dark)</span></astro-island> theme on <a href="https://astro.build/" class="astro-SZ7XMLTE">Astro</a></div>
        <astro-island uid="1I86to" component-url="/_astro/NetlifyIdentity.94b8edb0.js" component-export="default" renderer-url="/_astro/client.cb726945.js" props="{&quot;class&quot;:[0,&quot;astro-SZ7XMLTE&quot;]}" ssr="" client="load" opts="{&quot;name&quot;:&quot;NetlifyIdentity&quot;,&quot;value&quot;:true}"></astro-island>
    </nav>
</footer>
	</body></html>