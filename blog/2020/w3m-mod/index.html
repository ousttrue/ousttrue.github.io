<!DOCTYPE html>
<html lang="en" class="astro-BVZIHDZO">
	<head>
		<!-- Use Google Fonts, if you don't wanna prefer a self-hosted version --><!-- <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@300;400;500;600;700&display=swap" rel="stylesheet"> --><meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>w3m改造</title>
<meta name="title" content="w3m改造">


<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="shortcut icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">

<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="msapplication-config" content="/browserconfig.xml">
<meta name="theme-color" content="#ffffff">

<!-- Open Graph Tags (Facebook) -->
<meta property="og:type" content="website">
<meta property="og:title" content="w3m改造">




<!-- Twitter -->
<meta property="twitter:card" content="summary_large_image">
<meta property="twitter:title" content="w3m改造">





<script>
  const theme = (() => {
    if (typeof localStorage !== "undefined" && localStorage.getItem("theme")) {
      return localStorage.getItem("theme");
    }
    if (window.matchMedia("(prefers-color-scheme: dark)").matches) {
      return "dark";
    }
    return "light";
  })();

  if (theme === "light") {
    document.documentElement.classList.remove("dark");
  } else {
    document.documentElement.classList.add("dark");
  }
</script>
		
	<link rel="stylesheet" href="/_astro/about.6111bb3a.css" />
<link rel="stylesheet" href="/_astro/about.657f8f57.css" />
<link rel="stylesheet" href="/_astro/about.ee60a110.css" />
<link rel="stylesheet" href="/_astro/about.dcb84f3d.css" /><script type="module" src="/_astro/hoisted.e6960f2c.js"></script></head>

	<body class="astro-BVZIHDZO">
		<header class="header astro-3EF6KSR2">
    <div class="header__logo astro-3EF6KSR2">
        <a href="/" class="avatar astro-3EF6KSR2">
            <img class="header__logo-img astro-3EF6KSR2" src="/assets/logo.svg" alt="Astro logo">
        </a>
    </div>
    <div class="header__meta flex-1 astro-3EF6KSR2">
        <h3 class="header__title dark:text-theme-dark-secondary astro-3EF6KSR2">
            <a href="" class="astro-3EF6KSR2">三次元日誌(astro)</a>
        </h3>
        <div class="header__meta-more flex astro-3EF6KSR2">
            <p class="header__desc astro-3EF6KSR2">
                Crisp, minimal, personal blog theme for Astro
            </p>
            <nav class="header__nav flex astro-3EF6KSR2">
                <ul class="header__ref-list astro-3EF6KSR2">
                    <li class="astro-3EF6KSR2">
                        <style>astro-island,astro-slot,astro-static-slot{display:contents}</style><script>(()=>{var r=(i,c,n)=>{let s=async()=>{await(await i())()},t=new IntersectionObserver(e=>{for(let o of e)if(o.isIntersecting){t.disconnect(),s();break}});for(let e of n.children)t.observe(e)};(self.Astro||(self.Astro={})).visible=r;window.dispatchEvent(new Event("astro:visible"));})();;(()=>{var d;{let p={0:t=>u(t),1:t=>l(t),2:t=>new RegExp(t),3:t=>new Date(t),4:t=>new Map(l(t)),5:t=>new Set(l(t)),6:t=>BigInt(t),7:t=>new URL(t),8:t=>new Uint8Array(t),9:t=>new Uint16Array(t),10:t=>new Uint32Array(t)},h=t=>{let[e,n]=t;return e in p?p[e](n):void 0},l=t=>t.map(h),u=t=>typeof t!="object"||t===null?t:Object.fromEntries(Object.entries(t).map(([e,n])=>[e,h(n)]));customElements.get("astro-island")||customElements.define("astro-island",(d=class extends HTMLElement{constructor(){super(...arguments);this.hydrate=async()=>{var i;if(!this.hydrator||!this.isConnected)return;let e=(i=this.parentElement)==null?void 0:i.closest("astro-island[ssr]");if(e){e.addEventListener("astro:hydrate",this.hydrate,{once:!0});return}let n=this.querySelectorAll("astro-slot"),o={},a=this.querySelectorAll("template[data-astro-template]");for(let r of a){let s=r.closest(this.tagName);s!=null&&s.isSameNode(this)&&(o[r.getAttribute("data-astro-template")||"default"]=r.innerHTML,r.remove())}for(let r of n){let s=r.closest(this.tagName);s!=null&&s.isSameNode(this)&&(o[r.getAttribute("name")||"default"]=r.innerHTML)}let c;try{c=this.hasAttribute("props")?u(JSON.parse(this.getAttribute("props"))):{}}catch(r){let s=this.getAttribute("component-url")||"<unknown>",y=this.getAttribute("component-export");throw y&&(s+=` (export ${y})`),console.error(`[hydrate] Error parsing props for component ${s}`,this.getAttribute("props"),r),r}await this.hydrator(this)(this.Component,c,o,{client:this.getAttribute("client")}),this.removeAttribute("ssr"),this.dispatchEvent(new CustomEvent("astro:hydrate"))}}connectedCallback(){!this.hasAttribute("await-children")||this.firstChild?this.childrenConnectedCallback():new MutationObserver((e,n)=>{n.disconnect(),setTimeout(()=>this.childrenConnectedCallback(),0)}).observe(this,{childList:!0})}async childrenConnectedCallback(){let e=this.getAttribute("before-hydration-url");e&&await import(e),this.start()}start(){let e=JSON.parse(this.getAttribute("opts")),n=this.getAttribute("client");if(Astro[n]===void 0){window.addEventListener(`astro:${n}`,()=>this.start(),{once:!0});return}Astro[n](async()=>{let o=this.getAttribute("renderer-url"),[a,{default:c}]=await Promise.all([import(this.getAttribute("component-url")),o?import(o):()=>()=>{}]),i=this.getAttribute("component-export")||"default";if(!i.includes("."))this.Component=a[i];else{this.Component=a;for(let r of i.split("."))this.Component=this.Component[r]}return this.hydrator=c,this.hydrate},e,this)}attributeChangedCallback(){this.hydrate()}},d.observedAttributes=["props"],d))}})();</script><astro-island uid="2iKzVC" component-url="/_astro/SearchBtn.984510f3.js" component-export="default" renderer-url="/_astro/client.cb726945.js" props="{&quot;class&quot;:[0,&quot;astro-3EF6KSR2&quot;]}" ssr="" client="visible" opts="{&quot;name&quot;:&quot;SearchBtn&quot;,&quot;value&quot;:true}" await-children=""><button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"> <path fill-rule="evenodd" clip-rule="evenodd" d="M16.2071 4.89344C19.0923 7.77862 19.3131 12.3193 16.8693 15.4578C16.8846 15.4713 16.8996 15.4854 16.9143 15.5L21.1569 19.7427C21.5474 20.1332 21.5474 20.7664 21.1569 21.1569C20.7664 21.5474 20.1332 21.5474 19.7427 21.1569L15.5 16.9143C15.4854 16.8996 15.4713 16.8846 15.4578 16.8693C12.3193 19.3131 7.77862 19.0923 4.89344 16.2071C1.76924 13.083 1.76924 8.01763 4.89344 4.89344C8.01763 1.76924 13.083 1.76924 16.2071 4.89344ZM14.7929 14.7929C17.1361 12.4498 17.1361 8.6508 14.7929 6.30765C12.4498 3.96451 8.6508 3.96451 6.30765 6.30765C3.96451 8.6508 3.96451 12.4498 6.30765 14.7929C8.6508 17.1361 12.4498 17.1361 14.7929 14.7929Z" fill="currentColor"></path></svg></button></astro-island>
                    </li>
                    <li class="astro-3EF6KSR2">
                        <a href="https://github.com/one-aalam/astro-ink" title="三次元日誌(astro)'s Github URL'" class="astro-3EF6KSR2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    
                                <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22" class="astro-3EF6KSR2"></path>
                            
</svg>
                        </a>
                    </li>
                    <li class="astro-3EF6KSR2">
                        <a href="/rss.xml" title="RSS" class="astro-3EF6KSR2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    
                                <path d="M4 11a9 9 0 0 1 9 9" class="astro-3EF6KSR2"></path>
                                <path d="M4 4a16 16 0 0 1 16 16" class="astro-3EF6KSR2"></path>
                                <circle cx="5" cy="19" r="1" class="astro-3EF6KSR2"></circle>
                            
</svg>
                        </a>
                    </li>
                    <li class="astro-3EF6KSR2">
                        <astro-island uid="h8S6z" component-url="/_astro/ModeSwitcherBtn.0ddc5d6d.js" component-export="default" renderer-url="/_astro/client.cb726945.js" props="{&quot;class&quot;:[0,&quot;astro-3EF6KSR2&quot;]}" ssr="" client="visible" opts="{&quot;name&quot;:&quot;ModeSwitcherBtn&quot;,&quot;value&quot;:true}" await-children=""><button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle> <line x1="12" y1="1" x2="12" y2="3"></line> <line x1="12" y1="21" x2="12" y2="23"></line> <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line> <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line> <line x1="1" y1="12" x2="3" y2="12"></line> <line x1="21" y1="12" x2="23" y2="12"></line> <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line> <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg></button></astro-island>
                    </li>
                </ul>
            </nav>
        </div>
    </div>
</header>
		<main class="astro-BVZIHDZO">
			<article class="astro-BVZIHDZO">
				<div class="hero-image astro-BVZIHDZO">
					
				</div>
				<div class="prose astro-BVZIHDZO">
					<div class="title astro-BVZIHDZO">
						<div class="date astro-BVZIHDZO">
							<time datetime="2020-07-25T14:59:50.000Z">
	Jul 25, 2020
</time>
							
						</div>
						<h1 class="astro-BVZIHDZO">w3m改造</h1>
						<hr class="astro-BVZIHDZO">
					</div>
					
	<p>以前にも何度かやったことがあるのだけど立ち消えになっていた、 <a href="http://w3m.sourceforge.net/index.ja.html">w3m</a> の改造を試みている。
w3m はわりと好きなテキストブラウザなのだが、 2011 年くらいの 0.5.3 で開発が終了している様子。</p>
<p><a href="https://github.com/ousttrue/w3m">https://github.com/ousttrue/w3m</a></p>
<p>まずは <code>C++</code> 化してから、HTML処理などを再入可能にしてタブごとにスレッド独立する方向を目指す。
同時に、 <code>boehm-GC</code> を少しずつ <code>STL</code> のコンテナや <code>std::string</code> に置き換える。
どうも、<code>c++</code> と <code>boehm-GC</code> の共存するのに技がいるらしく、適当に置き換えていくとメモリ破壊で死ぬ。<code>boehm-GC</code> をすべて置き換える必要がありそう。<code>C++</code> クラスのメンバーに <code>GC</code> が要る、<code>GC struct</code> のメンバーに <code>C++</code> クラスが居るの両方に問題があるっぽい。一応、 <code>gc_cleanup</code> を継承したりしているのだけど、やり方がまずいぽい。</p>
<p>改造にあたってなるべく機能を維持しようとしていたのだけど、ある程度わりきって機能を落とさないと手に負えないところがある。</p>
<ul>
<li>http + https 以外の通信プロトコルは落とす。NNTP とか Gopher 使ったことないしなー、FTPもいったん落とす</li>
<li>backend, dump, halfload 等の出力に介入する機能は落とす。コードを読むのが大変</li>
<li>M17N, COLOR, IMAGE, MENU は残す</li>
<li>Mouse は微妙。削ってもよいかも</li>
<li>GetText も削る</li>
</ul>
<p>量を減らす。思ったよりコードが多かったのだ。</p>
<h1 id="下準備">下準備</h1>
<h2 id="msys2-でとりあえずビルド">msys2 でとりあえずビルド</h2>
<p>WSL Ubuntu だとビルドできなかった。
しかし、msys2 ならわりと簡単にビルドできることを発見。</p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #e1e4e8">$ pacman -S make gcc libgc-devel openssl-devel ncurses-devel</span></span>
<span class="line"><span style="color: #e1e4e8">$ x86_64-pc-msys-gcc --version</span></span>
<span class="line"><span style="color: #e1e4e8">x86_64-pc-msys-gcc (GCC) 9.3.0</span></span>
<span class="line"><span style="color: #e1e4e8">Copyright (C) 2019 Free Software Foundation, Inc.</span></span>
<span class="line"><span style="color: #e1e4e8">This is free software; see the source for copying conditions.  There is NO</span></span>
<span class="line"><span style="color: #e1e4e8">warranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.</span></span>
<span class="line"><span style="color: #e1e4e8">$ ./configure</span></span></code></pre>
<p>コンパイル環境の方が昔と変わってしまってビルドでエラーになる。</p>
<p>修正方法👇</p>
<p><a href="https://qiita.com/imkitchen/items/02a9df7baaaf434fee66">[CentOS7] emacs24にemacs-w3mインストール</a></p>
<p><code>#ifdef</code> の調整</p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #e1e4e8">// config.h</span></span>
<span class="line"><span style="color: #e1e4e8">//#define USE_BINMODE_STREAM 1</span></span>
<span class="line"><span style="color: #e1e4e8">//#define USE_EGD</span></span></code></pre>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #e1e4e8">$ make</span></span>
<span class="line"><span style="color: #e1e4e8">$ ./w3m www.google.com // 動いた</span></span></code></pre>
<h2 id="wsl-で-gc-がクラッシュする問題">WSL で GC がクラッシュする問題</h2>
<p><code>boehm-GC</code> がランタイムにエラーになることで、 <code>make</code> 中のコード生成 <code>mktable</code> がクラッシュするのが原因でビルドステップが途中で止まるのが原因だった。なので、たとえビルド済みの <code>w3m</code> を <code>apt get</code> しても、ランタイムも同じ原因でクラッシュする。</p>
<p>エラー。</p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #e1e4e8">Wrong __data_start/_end pair</span></span>
<span class="line"><span style="color: #e1e4e8">fish: './build/w3m' terminated by signal SIGABRT (Abort)</span></span></code></pre>
<p><a href="https://hitkey.nekokan.dyndns.info/diary2004.php#D200424">https://hitkey.nekokan.dyndns.info/diary2004.php#D200424</a></p>
<p>によると、stack size の制限が原因らしい。</p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #e1e4e8">$ ulimit -s</span></span>
<span class="line"><span style="color: #e1e4e8">8192</span></span></code></pre>
<p>WSL でこれを変えるには・・・。</p>
<p><a href="https://github.com/microsoft/WSL/issues/633">https://github.com/microsoft/WSL/issues/633</a></p>
<p>無理。</p>
<p><code>WSL2</code> ならできる？</p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #e1e4e8">> wsl -l -v</span></span>
<span class="line"><span style="color: #e1e4e8">  NAME            STATE           VERSION</span></span>
<span class="line"><span style="color: #e1e4e8">* Ubuntu-20.04    Running         2</span></span></code></pre>
<p>やってみる。</p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #e1e4e8">$ ulimit -s unlimited</span></span>
<span class="line"><span style="color: #e1e4e8">> ulimit -s</span></span>
<span class="line"><span style="color: #e1e4e8">unlimited</span></span></code></pre>
<p>できた。</p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #e1e4e8">$ w3m</span></span>
<span class="line"><span style="color: #e1e4e8">Wrong __data_start/_end pair</span></span></code></pre>
<p>うーむ。</p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #e1e4e8">$ ulimit -s 81920</span></span>
<span class="line"><span style="color: #e1e4e8">> ulimit -s</span></span>
<span class="line"><span style="color: #e1e4e8">81920</span></span></code></pre>
<p>動いた。
8192KB では足りなく、 unlimited では多すぎるらしい。これは、難しいな。</p>
<p>ちなみに、 <code>gdb</code> 上ならスタック問題を解決しなくても動いた。
<code>gdb</code> がスタックを覆い隠すのかな？
開発だけならできなくもない。</p>
<h2 id="ビルドシステム">ビルドシステム</h2>
<p>とりあえず慣れたツールに変更。
WSL 上の vscode で作業しているのもあり、autotools から CMake に変更。
クロスプラットフォームは後退させて、新しめの gcc(c++20) でビルドできればいいや。
config.h や funcname 系のコード生成結果はコミットしちゃう。
libwc が static ライブラリにわかれているのも、ひとまとめにしてしまった。
あと、適当にソースをフォルダに移動する。</p>
<p>生成コード一覧</p>



























































<table><thead><tr><th>ファイル</th><th>生成方法</th><th>入力</th><th>備考</th></tr></thead><tbody><tr><td>config.h</td><td>configure</td><td></td><td>各種 #define など</td></tr><tr><td>entity.h</td><td>Makefile(mktable)</td><td>entity.tab</td><td>./mktable 100 entity.tab > entity.h</td></tr><tr><td>funcname.tab</td><td>Makefile(awk)</td><td>main.c, menu.c</td><td></td></tr><tr><td>funcname.c</td><td>Makefile(awk)</td><td>funcname.tab</td><td>sort funcname.tab ｜ awk -f funcname0.awk > funcname.c</td></tr><tr><td>funcname1.h</td><td>Makefile(awk)</td><td>funcname.tab</td><td></td></tr><tr><td>funcname2.h</td><td>Makefile(awk)</td><td>funcname.tab</td><td></td></tr><tr><td>functable.c</td><td>Makefile(mktable)</td><td>funcname.tab</td><td></td></tr><tr><td>tagtable.c</td><td>Makefile(mktable)</td><td>funcname.tab</td><td></td></tr></tbody></table>
<h2 id="警告からエラーに引き上げ">警告からエラーに引き上げ</h2>
<p>改造していくのに <code>C</code> の緩い型制限が危険(コンパイルが通るのに型が不一致になりやすい)なので、
以下のオプションを追加。</p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #e1e4e8">-Werror=implicit-function-declaration</span></span>
<span class="line"><span style="color: #e1e4e8">-Werror=int-conversion</span></span>
<span class="line"><span style="color: #e1e4e8">-Werror=conversion-null</span></span></code></pre>
<p>これで、型宣言を補強しながら進める。</p>
<h1 id="第1段階">第1段階</h1>
<ul>
<li>extern “C” を追加してソースの拡張子を <code>.cpp</code> に変更</li>
<li>extern “C” をまとめて取り除く</li>
<li>typedef struct tag を取り除く</li>
</ul>
<p>ここまでやると、自由に <code>c++</code> のコードを混ぜることができる。
<code>std::string</code>、<code>std::vector</code>, <code>std::shared_ptr</code>, <code>std::function</code>, <code>std::string_view</code>, <code>template</code>, <code>class</code>, 前方宣言, <code>auto</code>, <code>inline</code> 等使い放題 👍</p>
<p>特に <code>std::string_view</code> の使い勝手を試したい。
所有しない文字列はすべて、 <code>std::string_view</code> でいけると思うのだが。
<code>split</code> の <code>std::string_view</code> 版は具合がよかった。</p>
<h2 id="c-化-extern-c">c++ 化 (extern “C”)</h2>
<p>手法としては、各ソースの拡張子を <code>.c</code> から <code>.cpp</code> に変更する。
<code>CMakeLists.txt</code> を修正。
<code>#include</code> を <code>extern "C"</code> で囲む、で <code>c++</code> 化することができる。</p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #F97583">extern</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">"C"</span><span style="color: #E1E4E8"> {</span></span>
<span class="line"><span style="color: #F97583">#include</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">"xxx.h"</span></span>
<span class="line"><span style="color: #E1E4E8">}</span></span></code></pre>
<p>ただ、 <code>cpp</code> で定義する関数の宣言が <code>extern "C"</code> の中に入らないとリンクエラーになるので、
そうなるようにソースごとにヘッダを分配してやる。
<code>w3m</code> は関数宣言が少数のファイル <code>proto.h</code>, <code>fm.h</code> とかに集中しているのだが、いっぱいあるので雑にやる。
コンパイルが通ればよい。</p>
<p>分配するときに未定義の型を前方宣言ですませたいのだけど、 <code>c</code> の <code>struct</code> 定義が、<code>struct tag</code> と <code>typedef</code> に分かれているのがやっかいだった。</p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #6A737D">// C</span></span>
<span class="line"><span style="color: #F97583">typedef</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">struct</span><span style="color: #E1E4E8"> hogeTag</span></span>
<span class="line"><span style="color: #E1E4E8">{</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">} Hoge;</span></span></code></pre>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #F97583">void</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">DoHoge</span><span style="color: #E1E4E8">(Hoge </span><span style="color: #F97583">*</span><span style="color: #FFAB70">p</span><span style="color: #E1E4E8">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #6A737D">// に対する前方宣言は、</span></span>
<span class="line"></span>
<span class="line"><span style="color: #F97583">struct</span><span style="color: #E1E4E8"> hogeTag;</span></span>
<span class="line"><span style="color: #F97583">typedef</span><span style="color: #E1E4E8"> hogeTag Hoge;</span></span></code></pre>
<p><code>C</code> の状態で、前方宣言を導入できずヘッダの分割が難航。
型ごとに別のヘッダに分割することは断念して、
ほとんど全部の <code>struct</code> 定義の入ったヘッダを <code>fm.h</code> から分離して作るのに留めた。</p>
<h2 id="defun">DEFUN</h2>
<p><code>w3m</code> は <code>DEFUN</code> でキーアサインできる関数を定義している。</p>
<p><a href="/w3m/doc-jp/readme.func/">readme.func</a></p>
<p>以下のように、キーボードなどのイベントをトリガーにアクションを実行するというイメージ。</p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #e1e4e8">Key</span></span>
<span class="line"><span style="color: #e1e4e8">    KeyMap</span></span>
<span class="line"><span style="color: #e1e4e8">        DEFUN</span></span>
<span class="line"><span style="color: #e1e4e8">    Menu</span></span>
<span class="line"><span style="color: #e1e4e8">        DEFUN</span></span>
<span class="line"><span style="color: #e1e4e8">MouseAction</span></span>
<span class="line"><span style="color: #e1e4e8">    ActionMap</span></span>
<span class="line"><span style="color: #e1e4e8">        DEFUN</span></span>
<span class="line"><span style="color: #e1e4e8">    Menu</span></span>
<span class="line"><span style="color: #e1e4e8">        DEFUN</span></span>
<span class="line"><span style="color: #e1e4e8">Alarm</span></span>
<span class="line"><span style="color: #e1e4e8">    DEFUN</span></span></code></pre>
<p>ソースは、<code>main.c</code> と <code>menu.c</code> に <code>DEFUN</code> とそれの使う補助関数がまとめて定義されていて、
ヘッダは <code>proto.h</code> に全部入れとなっている。</p>
<p>c++ で下記のようなディスパッチャを作った。</p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #F97583">typedef</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">void</span><span style="color: #E1E4E8"> (*Command)();</span></span>
<span class="line"><span style="color: #B392F0">std</span><span style="color: #E1E4E8">::unordered_map</span><span style="color: #F97583">&#x3C;</span><span style="color: #B392F0">std</span><span style="color: #E1E4E8">::string, Command</span><span style="color: #F97583">></span><span style="color: #E1E4E8"> g_commandMap;</span></span></code></pre>
<p>使い捨ての python で関数に登録するコードを生成した。</p>
<h1 id="第２段階">第２段階</h1>
<ul>
<li>PODじゃない型が動くようにする
<ul>
<li>constructor/destructor</li>
</ul>
</li>
<li>脱GC
<ul>
<li>コレクションをSTLに置き換える</li>
<li>std::string</li>
<li>std::shared_ptr</li>
</ul>
</li>
<li>機能ごとにモジュール化</li>
<li>再入可能</li>
</ul>
<h2 id="gc_malloc-から-gc_cleanup-継承へ">GC_MALLOC から gc_cleanup 継承へ</h2>
<p>boehm-GC を <code>c++</code> のクラスで使う方法を調べた。</p>
<p><a href="http://www.namikilab.tuat.ac.jp/~sasada/prog/boehmgc.html#i-0-5">http://www.namikilab.tuat.ac.jp/~sasada/prog/boehmgc.html#i-0-5</a></p>
<p><code>w3m</code> では、 <code>GC</code> を多用している。</p>
<p>おもに、</p>
<ul>
<li>struct Str</li>
<li>コレクション</li>
<li>struct の field</li>
</ul>
<p>という感じに。
このうち、 struct の field で使われるタイプの単発の <code>GC_MALLOC</code> している型を <code>gc_cleanup</code> 継承にして、 <code>new</code> で初期化するようにする。</p>
<ul>
<li>bzero, bcopy, memcpy, sizeof</li>
</ul>
<p>等でメモリクリアしているところに注意する。
これで、その型は <code>constructor/destructor</code> が動くようになり、
メンバーに <code>std::string</code> 等を配置できるようになる。
あとで、 <code>gc_cleanup</code> から <code>std::shared_ptr</code> に変更することも視野に入れている。</p>
<h2 id="gc文字列-str">GC文字列 Str</h2>
<p>アプリ全体で使われていて一挙になくすことはできないのだけど、構造体の末端のメンバーから <code>std::string</code> に変える。
あと、がんばって <code>const char *</code> の範囲を増やす。
<code>libwc</code> から <code>Str</code> を剥そうと思っていたのだが、逆に <code>libwc</code> に <code>Str</code> を封じ込める方向に軌道修正。
<code>indep.c</code> の便利文字列関数も少しずつ変えてく。</p>
<h2 id="グローバル変数を減らす">グローバル変数を減らす</h2>
<p>関数の中でグローバル変数にアクセスしている場合(CurrentBufferなど)、これを関数の引数経由とか、クラスのメンバー経由でもらう。面倒でも Getter と Setter を区別して、どこで変更されうるかわかりやすくする。
クラスのメンバーは、 <code>private</code> 化を試みる。</p>
<h2 id="stream処理">Stream処理</h2>
<p>多分、最難関の <code>loadGeneralFile</code> 関数。700行くらいだったか。
goto とか longjmp があってよくわからなかったのだが、慣れてきた。
<code>http</code>, <code>https</code>, <code>NNTP ?</code>, <code>gopher</code>, <code>ftp</code>, <code>pipe</code> 等、<code>http</code> のプロキシーやリダイレクト、 <code>www-auth</code> などを一手に処理していて容易に手を付けられない。
何度か整理しようとして悉く撃退されたので、雑にやることにした。
機能を <code>http(https)</code> に絞ってそれ以外をコメントアウトしてとにかく量を減らす。
プロキシーとか、 <code>dump</code>, <code>halfload</code> などのよく知らない機能もどんどん削る。
としてなんとか改造できるようになってきた。</p>
<p>ここを <code>HttpClient</code>, <code>LocalFile</code>, <code>PipeReader</code> あたりに整理したい。</p>
<h1 id="第３段階">第３段階</h1>
<p>Tab, Buffer, Line のリンクリストを STL のコレクションに置き換えた。</p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #F97583">auto</span><span style="color: #E1E4E8"> buf </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">load</span><span style="color: #E1E4E8">(url);</span></span>
<span class="line"><span style="color: #E1E4E8">tab-></span><span style="color: #B392F0">push</span><span style="color: #E1E4E8">(buf);</span></span></code></pre>
<p>という形を目指す。</p>
<p><code>loadGeneralFile</code> を解きほぐして、 <code>HTTP</code> 機能を抽出、リダイレクトまで動くようにできた。
<code>loadGeneralFile</code> は、</p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #e1e4e8">* OpenStream/Send HTTP Request</span></span>
<span class="line"><span style="color: #e1e4e8">* HTTP Response</span></span>
<span class="line"><span style="color: #e1e4e8">    * 3xx => Redirect</span></span>
<span class="line"><span style="color: #e1e4e8">* content-type で分岐</span></span>
<span class="line"><span style="color: #e1e4e8">    * BufferLoader => Buffer</span></span></code></pre>
<p>という感じに整理できそう。
HttpとBufferローダーを副作用の無い関数に整理できれば再入可能が見えてくる。
早めに分岐させて、分岐したら合流しない。同じ処理は関数で共有するという方向性で整理。</p>
<p>Buffer が多機能なので、Document, HttpResponse, FileInfo とかに分割したい。</p>
<h1 id="第４段階">第４段階</h1>
<p>mainloop の再実装。libuv, libevent 等を検討していたのだけど、 c++ との親和性の高い asio を使うことにした。
<code>tty read (keyboard input)</code>, <code>signal callback (sigint, winresize)</code>, <code>alarm</code> の割り込みを asio 経由にする。
アプリの終了をloop の終了にして、自然に destructor がコールされるようになる。</p>
<h1 id="第５段階">第５段階</h1>
<p>html parse から term へのレンダリング部分の分解。
やっと解読できて１パス目</p>
<ul>
<li>内部文字コード(wtf-8)に変換</li>
<li>tokenize</li>
<li>tag をパースして属性取得 => パースに成功したら行バッファに書き戻す。フォームの情報を蓄積する。テーブルのレイアウト</li>
</ul>
<p>結果として、行のリストと、フォーム情報を得る。</p>
<p>２パス目</p>
<ul>
<li>行のリストを再度パース</li>
<li>非タグ部分をBufferに出力</li>
<li>Aタグやフォームを Anchor などに出力</li>
</ul>
<p>という感じだった。
１パス目で html 化するときに知らない属性を捨てたり、内部属性を追加したりしている様子。
この、内部属性がよくわからなくて難しい。</p>
<h1 id="文字コード">文字コード</h1>
<p><code>content-charset</code> => <code>wtf</code> => <code>DisplayCharset</code> と文字コードを変換して動作していることがわかった。
試しに、<code>utf-8</code> であることが分かっている <code>html</code> で <code>wtf</code> 変換を飛ばしてみたところ表示が壊れた。
<code>wtf</code> は <code>utf-8</code> と互換性がないらしい。
<a href="http://simonsapin.github.io/wtf-8/">http://simonsapin.github.io/wtf-8/</a>
なのかと思ったのだが、違う独自形式かもしれない。</p>
<p>w3m は、この <code>wtf</code> エンコーディングで、html タグのパース、文字のバイト幅の判定、文字のカラム幅の判定をしているのだが、
<code>utf-8</code> では、文字のバイト幅、カラム幅の判定が狂う。
ということで、 <code>utf-8</code> でのバイト幅判定を自作して <code>wcwidth</code> を組み合わせてみた。
<code>*#12345;</code> 形式の <code>unicode</code> 埋め込みに対応するために、追加で <code>unicode</code> => <code>utf-8</code> 変換も作った。
正しく表示することができた。</p>
<p>ということで、<code>euc-jp</code> と <code>shift-jis</code> と <code>iso-2022-jp</code> から <code>utf-8</code> への変換を作れば日本語は対応できそう。
<code>std::string_view</code>, <code>char32_t</code>, <code>char8_t</code> あたりの新しい型を使った <code>\0</code> 終端に頼らないライブラリを作ってみる。</p>
<h1 id="メモ">メモ</h1>
<h2 id="モジュールに分割">モジュールに分割</h2>
<p>機能ごとにモジュールに分割する。</p>
<ul>
<li>
<p>UI(frontend)</p>
<ul>
<li>Term
<ul>
<li>低レベル描画
<ul>
<li>termcap の関数を直接呼ぶ。curses の自前実装的な</li>
<li>マルチバイト、マルチカラムの文字列と密接に関連していて libwc と不可分</li>
</ul>
</li>
<li>キーボード入力</li>
<li>マウス入力</li>
<li>リサイズイベント</li>
<li>SIGNALハンドリング
<ul>
<li>SIGINT => longjmp でキャンセル処理を実現している。c++ のデストラクタとかまずそう</li>
</ul>
</li>
</ul>
</li>
<li>高レベル描画
<ul>
<li>Lineの構築(byte ごとに char と Lineprop がペアになる)</li>
</ul>
</li>
<li>Tab</li>
<li>Buffer</li>
<li>Message</li>
<li>Menu</li>
<li>Keymap</li>
<li>LineInput
<ul>
<li>SearchKey</li>
<li>History</li>
</ul>
</li>
</ul>
</li>
<li>
<p>IO(transport)</p>
<ul>
<li>IStream
<ul>
<li>union => class polymorphism化</li>
<li>file descriptor</li>
<li>FILE*</li>
<li>ssl</li>
<li>memory</li>
<li>Compression</li>
</ul>
</li>
<li>LocalCGI</li>
</ul>
</li>
<li>
<p>http</p>
<ul>
<li>HttpSession
<ul>
<li>HttpRequest</li>
<li>HttpResponse</li>
</ul>
</li>
<li>cookie</li>
<li>redirect</li>
<li>referer</li>
<li>https</li>
<li>ftp</li>
<li>URL</li>
</ul>
</li>
<li>
<p>HTML</p>
<ul>
<li>HTMLtagproc1</li>
<li>HTMLlineproc2body
<ul>
<li>process_form</li>
<li>process_form_int</li>
</ul>
</li>
<li>form</li>
<li>table</li>
<li>frame</li>
<li>term rendering</li>
</ul>
</li>
<li>
<p>String</p>
<ul>
<li>文字コード</li>
<li>quote</li>
<li>url escape</li>
<li>html escape</li>
<li>html entity</li>
<li>char_util
<ul>
<li>myctype</li>
</ul>
</li>
<li>string_view_util
<ul>
<li>strip</li>
</ul>
</li>
<li>string_util
<ul>
<li>malloc</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="リンクをたどるfollowlink">リンクをたどる(followLink)</h2>
<p>followA();
loadLink();
loadGeneralFile();</p>
<p>cmd_loadURL();
loadGeneralFile();</p>
<p>cmd_loadURL();
loadGeneralFile();</p>
<h2 id="描画する">描画する</h2>
<p>displayBuffer
redrawBuffer
redrawNLine</p>
<h2 id="key入力">key入力</h2>

				</div>
			</article>
		</main>
		<footer class="footer astro-SZ7XMLTE">
    <nav class="nav astro-SZ7XMLTE">
        <div class="astro-SZ7XMLTE">2021  &copy; Copyright notice |  <a href="https://github.com/one-aalam/astro-ink" title="三次元日誌(astro)'s Github URL'" class="astro-SZ7XMLTE">三次元日誌(astro)</a>
        <script>(()=>{var e=async t=>{await(await t())()};(self.Astro||(self.Astro={})).load=e;window.dispatchEvent(new Event("astro:load"));})();</script><astro-island uid="1QEdto" component-url="/_astro/ModeLabel.e3ff75e7.js" component-export="default" renderer-url="/_astro/client.cb726945.js" props="{&quot;class&quot;:[0,&quot;astro-SZ7XMLTE&quot;]}" ssr="" client="load" opts="{&quot;name&quot;:&quot;ModeLabel&quot;,&quot;value&quot;:true}" await-children=""><span slot="dark" data-svelte-h="svelte-14ov3lc">(dark)</span></astro-island> theme on <a href="https://astro.build/" class="astro-SZ7XMLTE">Astro</a></div>
        <astro-island uid="1I86to" component-url="/_astro/NetlifyIdentity.94b8edb0.js" component-export="default" renderer-url="/_astro/client.cb726945.js" props="{&quot;class&quot;:[0,&quot;astro-SZ7XMLTE&quot;]}" ssr="" client="load" opts="{&quot;name&quot;:&quot;NetlifyIdentity&quot;,&quot;value&quot;:true}"></astro-island>
    </nav>
</footer>
	</body></html>