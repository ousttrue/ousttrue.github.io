<!DOCTYPE html>
<html lang="en" class="astro-BVZIHDZO">
	<head>
		<!-- Use Google Fonts, if you don't wanna prefer a self-hosted version --><!-- <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@300;400;500;600;700&display=swap" rel="stylesheet"> --><meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>VS2019 向けに hererocks を修正(vswhere を使う)</title>
<meta name="title" content="VS2019 向けに hererocks を修正(vswhere を使う)">


<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="shortcut icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">

<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="msapplication-config" content="/browserconfig.xml">
<meta name="theme-color" content="#ffffff">

<!-- Open Graph Tags (Facebook) -->
<meta property="og:type" content="website">
<meta property="og:title" content="VS2019 向けに hererocks を修正(vswhere を使う)">




<!-- Twitter -->
<meta property="twitter:card" content="summary_large_image">
<meta property="twitter:title" content="VS2019 向けに hererocks を修正(vswhere を使う)">





<script>
  const theme = (() => {
    if (typeof localStorage !== "undefined" && localStorage.getItem("theme")) {
      return localStorage.getItem("theme");
    }
    if (window.matchMedia("(prefers-color-scheme: dark)").matches) {
      return "dark";
    }
    return "light";
  })();

  if (theme === "light") {
    document.documentElement.classList.remove("dark");
  } else {
    document.documentElement.classList.add("dark");
  }
</script>
		
	<link rel="stylesheet" href="/_astro/about.6111bb3a.css" />
<link rel="stylesheet" href="/_astro/about.657f8f57.css" />
<link rel="stylesheet" href="/_astro/about.ee60a110.css" />
<link rel="stylesheet" href="/_astro/about.dcb84f3d.css" /><script type="module" src="/_astro/hoisted.e6960f2c.js"></script></head>

	<body class="astro-BVZIHDZO">
		<header class="header astro-3EF6KSR2">
    <div class="header__logo astro-3EF6KSR2">
        <a href="/" class="avatar astro-3EF6KSR2">
            <img class="header__logo-img astro-3EF6KSR2" src="/assets/logo.svg" alt="Astro logo">
        </a>
    </div>
    <div class="header__meta flex-1 astro-3EF6KSR2">
        <h3 class="header__title dark:text-theme-dark-secondary astro-3EF6KSR2">
            <a href="" class="astro-3EF6KSR2">三次元日誌(astro)</a>
        </h3>
        <div class="header__meta-more flex astro-3EF6KSR2">
            <p class="header__desc astro-3EF6KSR2">
                Crisp, minimal, personal blog theme for Astro
            </p>
            <nav class="header__nav flex astro-3EF6KSR2">
                <ul class="header__ref-list astro-3EF6KSR2">
                    <li class="astro-3EF6KSR2">
                        <style>astro-island,astro-slot,astro-static-slot{display:contents}</style><script>(()=>{var r=(i,c,n)=>{let s=async()=>{await(await i())()},t=new IntersectionObserver(e=>{for(let o of e)if(o.isIntersecting){t.disconnect(),s();break}});for(let e of n.children)t.observe(e)};(self.Astro||(self.Astro={})).visible=r;window.dispatchEvent(new Event("astro:visible"));})();;(()=>{var d;{let p={0:t=>u(t),1:t=>l(t),2:t=>new RegExp(t),3:t=>new Date(t),4:t=>new Map(l(t)),5:t=>new Set(l(t)),6:t=>BigInt(t),7:t=>new URL(t),8:t=>new Uint8Array(t),9:t=>new Uint16Array(t),10:t=>new Uint32Array(t)},h=t=>{let[e,n]=t;return e in p?p[e](n):void 0},l=t=>t.map(h),u=t=>typeof t!="object"||t===null?t:Object.fromEntries(Object.entries(t).map(([e,n])=>[e,h(n)]));customElements.get("astro-island")||customElements.define("astro-island",(d=class extends HTMLElement{constructor(){super(...arguments);this.hydrate=async()=>{var i;if(!this.hydrator||!this.isConnected)return;let e=(i=this.parentElement)==null?void 0:i.closest("astro-island[ssr]");if(e){e.addEventListener("astro:hydrate",this.hydrate,{once:!0});return}let n=this.querySelectorAll("astro-slot"),o={},a=this.querySelectorAll("template[data-astro-template]");for(let r of a){let s=r.closest(this.tagName);s!=null&&s.isSameNode(this)&&(o[r.getAttribute("data-astro-template")||"default"]=r.innerHTML,r.remove())}for(let r of n){let s=r.closest(this.tagName);s!=null&&s.isSameNode(this)&&(o[r.getAttribute("name")||"default"]=r.innerHTML)}let c;try{c=this.hasAttribute("props")?u(JSON.parse(this.getAttribute("props"))):{}}catch(r){let s=this.getAttribute("component-url")||"<unknown>",y=this.getAttribute("component-export");throw y&&(s+=` (export ${y})`),console.error(`[hydrate] Error parsing props for component ${s}`,this.getAttribute("props"),r),r}await this.hydrator(this)(this.Component,c,o,{client:this.getAttribute("client")}),this.removeAttribute("ssr"),this.dispatchEvent(new CustomEvent("astro:hydrate"))}}connectedCallback(){!this.hasAttribute("await-children")||this.firstChild?this.childrenConnectedCallback():new MutationObserver((e,n)=>{n.disconnect(),setTimeout(()=>this.childrenConnectedCallback(),0)}).observe(this,{childList:!0})}async childrenConnectedCallback(){let e=this.getAttribute("before-hydration-url");e&&await import(e),this.start()}start(){let e=JSON.parse(this.getAttribute("opts")),n=this.getAttribute("client");if(Astro[n]===void 0){window.addEventListener(`astro:${n}`,()=>this.start(),{once:!0});return}Astro[n](async()=>{let o=this.getAttribute("renderer-url"),[a,{default:c}]=await Promise.all([import(this.getAttribute("component-url")),o?import(o):()=>()=>{}]),i=this.getAttribute("component-export")||"default";if(!i.includes("."))this.Component=a[i];else{this.Component=a;for(let r of i.split("."))this.Component=this.Component[r]}return this.hydrator=c,this.hydrate},e,this)}attributeChangedCallback(){this.hydrate()}},d.observedAttributes=["props"],d))}})();</script><astro-island uid="2iKzVC" component-url="/_astro/SearchBtn.984510f3.js" component-export="default" renderer-url="/_astro/client.cb726945.js" props="{&quot;class&quot;:[0,&quot;astro-3EF6KSR2&quot;]}" ssr="" client="visible" opts="{&quot;name&quot;:&quot;SearchBtn&quot;,&quot;value&quot;:true}" await-children=""><button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"> <path fill-rule="evenodd" clip-rule="evenodd" d="M16.2071 4.89344C19.0923 7.77862 19.3131 12.3193 16.8693 15.4578C16.8846 15.4713 16.8996 15.4854 16.9143 15.5L21.1569 19.7427C21.5474 20.1332 21.5474 20.7664 21.1569 21.1569C20.7664 21.5474 20.1332 21.5474 19.7427 21.1569L15.5 16.9143C15.4854 16.8996 15.4713 16.8846 15.4578 16.8693C12.3193 19.3131 7.77862 19.0923 4.89344 16.2071C1.76924 13.083 1.76924 8.01763 4.89344 4.89344C8.01763 1.76924 13.083 1.76924 16.2071 4.89344ZM14.7929 14.7929C17.1361 12.4498 17.1361 8.6508 14.7929 6.30765C12.4498 3.96451 8.6508 3.96451 6.30765 6.30765C3.96451 8.6508 3.96451 12.4498 6.30765 14.7929C8.6508 17.1361 12.4498 17.1361 14.7929 14.7929Z" fill="currentColor"></path></svg></button></astro-island>
                    </li>
                    <li class="astro-3EF6KSR2">
                        <a href="https://github.com/one-aalam/astro-ink" title="三次元日誌(astro)'s Github URL'" class="astro-3EF6KSR2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    
                                <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22" class="astro-3EF6KSR2"></path>
                            
</svg>
                        </a>
                    </li>
                    <li class="astro-3EF6KSR2">
                        <a href="/rss.xml" title="RSS" class="astro-3EF6KSR2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    
                                <path d="M4 11a9 9 0 0 1 9 9" class="astro-3EF6KSR2"></path>
                                <path d="M4 4a16 16 0 0 1 16 16" class="astro-3EF6KSR2"></path>
                                <circle cx="5" cy="19" r="1" class="astro-3EF6KSR2"></circle>
                            
</svg>
                        </a>
                    </li>
                    <li class="astro-3EF6KSR2">
                        <astro-island uid="h8S6z" component-url="/_astro/ModeSwitcherBtn.0ddc5d6d.js" component-export="default" renderer-url="/_astro/client.cb726945.js" props="{&quot;class&quot;:[0,&quot;astro-3EF6KSR2&quot;]}" ssr="" client="visible" opts="{&quot;name&quot;:&quot;ModeSwitcherBtn&quot;,&quot;value&quot;:true}" await-children=""><button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle> <line x1="12" y1="1" x2="12" y2="3"></line> <line x1="12" y1="21" x2="12" y2="23"></line> <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line> <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line> <line x1="1" y1="12" x2="3" y2="12"></line> <line x1="21" y1="12" x2="23" y2="12"></line> <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line> <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg></button></astro-island>
                    </li>
                </ul>
            </nav>
        </div>
    </div>
</header>
		<main class="astro-BVZIHDZO">
			<article class="astro-BVZIHDZO">
				<div class="hero-image astro-BVZIHDZO">
					
				</div>
				<div class="prose astro-BVZIHDZO">
					<div class="title astro-BVZIHDZO">
						<div class="date astro-BVZIHDZO">
							<time datetime="2021-07-15T00:00:00.000Z">
	Jul 15, 2021
</time>
							
						</div>
						<h1 class="astro-BVZIHDZO">VS2019 向けに hererocks を修正(vswhere を使う)</h1>
						<hr class="astro-BVZIHDZO">
					</div>
					
	<p>hererocks が VS2019BuildTools を検知して動作するように改造してみた。</p>
<p><a href="https://github.com/luarocks/hererocks/pull/15">https://github.com/luarocks/hererocks/pull/15</a></p>
<p>通るかどうかは微妙。
内容的に、通りづらそう。
古い vc を使っていたり MinGW 使っていたりすると実験できないしね。
とりあえず、既存の動いている部分が壊れないようには配慮した。</p>
<p>採用されれば、</p>
<p><a href="https://github.com/wbthomason/packer.nvim/issues/302">https://github.com/wbthomason/packer.nvim/issues/302</a></p>
<p>も進展する。
Windows 版の luarocks 呼び出しに改造が必要なのだが、
先に hererocks が動いている必要があるという順番。</p>
<p>とりあえず単体で試すことができて</p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #e1e4e8"># C:/Python38/Scripts/pip.exe</span></span>
<span class="line"><span style="color: #e1e4e8">$ pip install https://github.com/ousttrue/hererocks/archive/add_vswhere.zip</span></span></code></pre>
<p>とする。</p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #e1e4e8"># C:/Python38/Scripts/hererocks.exe</span></span>
<span class="line"><span style="color: #e1e4e8">$ hererocks.exe --target vs -j 2.1.0-beta3 -r latest build_dir</span></span>
<span class="line"><span style="color: #e1e4e8">Using cl.exe found in PATH.</span></span>
<span class="line"><span style="color: #e1e4e8">Fetching LuaJIT 2.1.0-beta3 (target: vs) (cached)</span></span>
<span class="line"><span style="color: #e1e4e8">Verifying SHA256 checksum</span></span>
<span class="line"><span style="color: #e1e4e8">Building LuaJIT 2.1.0-beta3 (target: vs)</span></span>
<span class="line"><span style="color: #e1e4e8">Installing LuaJIT 2.1.0-beta3 (target: vs)</span></span>
<span class="line"><span style="color: #e1e4e8">Fetching LuaRocks 3.7.0 (cached)</span></span>
<span class="line"><span style="color: #e1e4e8">Verifying SHA256 checksum</span></span>
<span class="line"><span style="color: #e1e4e8">Building and installing LuaRocks 3.7.0</span></span></code></pre>
<p>lua はシステムにインストールして全体でライブラリを共有するというよりは、
プロジェクト単位でインストールしてローカルに必要なライブラリだけを追加するという運用になりそう。
なので、 hererocks でプロジェクトローカルに lua をサクッとビルドできるのはなかなかよい。
python の venv 的な運用。
展開先は、 <code>.gitignore</code> する。</p>
<p>ただ、外部ライブラリのラッパーがさくっと動くかというと Windows だと厳しいものがありますな・・・。
vcpkg と連携させるとか、更なる頑張りが必要かもしれない。
なので、 luajit の ffi が面白いかもしれない。
standalone の lua インタプリタを使う場合は <code>hererocks</code> がいいのではないか。</p>
<h2 id="vswhere-メモ">vswhere メモ</h2>
<p><a href="https://github.com/Microsoft/vswhere">https://github.com/Microsoft/vswhere</a></p>
<p><code>cl.exe</code>, <code>msbuild.exe</code> などの探索に使う。
<code>vs2017 version 15.2</code> 以降に入っているらしい。</p>
<p>こんな感じに使う。</p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #e1e4e8"># %ProgramFiles(x86)%\Microsoft Visual Studio\Installer\vswhere.exe</span></span>
<span class="line"><span style="color: #e1e4e8">> vswhere -nologo -products *</span></span>
<span class="line"><span style="color: #e1e4e8">instanceId: 6762dfe1</span></span>
<span class="line"><span style="color: #e1e4e8">installDate: 2020/07/21 9:26:34</span></span>
<span class="line"><span style="color: #e1e4e8">installationName: VisualStudio/16.7.3+30503.244</span></span>
<span class="line"><span style="color: #e1e4e8">installationPath: C:\Program Files (x86)\Microsoft Visual Studio\2019\BuildTools</span></span>
<span class="line"><span style="color: #e1e4e8">installationVersion: 16.7.30503.244</span></span>
<span class="line"><span style="color: #e1e4e8">productId: Microsoft.VisualStudio.Product.BuildTools</span></span>
<span class="line"><span style="color: #e1e4e8">productPath: C:\Program Files (x86)\Microsoft Visual Studio\2019\BuildTools\Common7\Tools\LaunchDevCmd.bat</span></span>
<span class="line"><span style="color: #e1e4e8">state: 4294967295</span></span>
<span class="line"><span style="color: #e1e4e8">isComplete: 1</span></span>
<span class="line"><span style="color: #e1e4e8">isLaunchable: 1</span></span>
<span class="line"><span style="color: #e1e4e8">isPrerelease: 0</span></span>
<span class="line"><span style="color: #e1e4e8">isRebootRequired: 0</span></span>
<span class="line"><span style="color: #e1e4e8">displayName: Visual Studio Build Tools 2019</span></span>
<span class="line"><span style="color: #e1e4e8">description: Visual Studio Build Tools では、Visual Studio IDE を必要とせずに、MSBuild ベースのネイティブ マネージド アプリケーションをビルドできます。また、Visual C++ のコンパイラやライブラリ、MFC、ATL、および C++/CLI サポートをインストールするオプションも用意されています。</span></span>
<span class="line"><span style="color: #e1e4e8">channelId: VisualStudio.16.Release</span></span>
<span class="line"><span style="color: #e1e4e8">channelUri: https://aka.ms/vs/16/release/channel</span></span>
<span class="line"><span style="color: #e1e4e8">enginePath: C:\Program Files (x86)\Microsoft Visual Studio\Installer\resources\app\ServiceHub\Services\Microsoft.VisualStudio.Setup.Service</span></span>
<span class="line"><span style="color: #e1e4e8">releaseNotes: https://go.microsoft.com/fwlink/?LinkId=660893#16.7.3</span></span>
<span class="line"><span style="color: #e1e4e8">thirdPartyNotices: https://go.microsoft.com/fwlink/?LinkId=660909</span></span>
<span class="line"><span style="color: #e1e4e8">updateDate: 2020-09-13T06:19:26.0508205Z</span></span>
<span class="line"><span style="color: #e1e4e8">catalog_buildBranch: d16.7</span></span>
<span class="line"><span style="color: #e1e4e8">catalog_buildVersion: 16.7.30503.244</span></span>
<span class="line"><span style="color: #e1e4e8">catalog_id: VisualStudio/16.7.3+30503.244</span></span>
<span class="line"><span style="color: #e1e4e8">catalog_localBuild: build-lab</span></span>
<span class="line"><span style="color: #e1e4e8">catalog_manifestName: VisualStudio</span></span>
<span class="line"><span style="color: #e1e4e8">catalog_manifestType: installer</span></span>
<span class="line"><span style="color: #e1e4e8">catalog_productDisplayVersion: 16.7.3</span></span>
<span class="line"><span style="color: #e1e4e8">catalog_productLine: Dev16</span></span>
<span class="line"><span style="color: #e1e4e8">catalog_productLineVersion: 2019</span></span>
<span class="line"><span style="color: #e1e4e8">catalog_productMilestone: RTW</span></span>
<span class="line"><span style="color: #e1e4e8">catalog_productMilestoneIsPreRelease: False</span></span>
<span class="line"><span style="color: #e1e4e8">catalog_productName: Visual Studio</span></span>
<span class="line"><span style="color: #e1e4e8">catalog_productPatchVersion: 3</span></span>
<span class="line"><span style="color: #e1e4e8">catalog_productPreReleaseMilestoneSuffix: 1.0</span></span>
<span class="line"><span style="color: #e1e4e8">catalog_productSemanticVersion: 16.7.3+30503.244</span></span>
<span class="line"><span style="color: #e1e4e8">catalog_requiredEngineVersion: 2.7.3132.26759</span></span>
<span class="line"><span style="color: #e1e4e8">properties_campaignId:</span></span>
<span class="line"><span style="color: #e1e4e8">properties_channelManifestId: VisualStudio.16.Release/16.7.3+30503.244</span></span>
<span class="line"><span style="color: #e1e4e8">properties_nickname:</span></span>
<span class="line"><span style="color: #e1e4e8">properties_setupEngineFilePath: C:\Program Files (x86)\Microsoft Visual Studio\Installer\vs_installershell.exe</span></span></code></pre>
<p><a href="https://github.com/microsoft/vswhere/wiki/Find-VC">https://github.com/microsoft/vswhere/wiki/Find-VC</a></p>
<p>フィルタをかけられる。</p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #e1e4e8">> vswhere -latest -products * -requires Microsoft.VisualStudio.Component.VC.Tools.x86.x64 -property installationPath</span></span>
<span class="line"><span style="color: #e1e4e8">C:\Program Files (x86)\Microsoft Visual Studio\2019\BuildTools</span></span></code></pre>
<p>見つかったパスから先は固定であるとみなして、 <code>vcvars64.bat</code> などを見つける。</p>

				</div>
			</article>
		</main>
		<footer class="footer astro-SZ7XMLTE">
    <nav class="nav astro-SZ7XMLTE">
        <div class="astro-SZ7XMLTE">2021  &copy; Copyright notice |  <a href="https://github.com/one-aalam/astro-ink" title="三次元日誌(astro)'s Github URL'" class="astro-SZ7XMLTE">三次元日誌(astro)</a>
        <script>(()=>{var e=async t=>{await(await t())()};(self.Astro||(self.Astro={})).load=e;window.dispatchEvent(new Event("astro:load"));})();</script><astro-island uid="1QEdto" component-url="/_astro/ModeLabel.e3ff75e7.js" component-export="default" renderer-url="/_astro/client.cb726945.js" props="{&quot;class&quot;:[0,&quot;astro-SZ7XMLTE&quot;]}" ssr="" client="load" opts="{&quot;name&quot;:&quot;ModeLabel&quot;,&quot;value&quot;:true}" await-children=""><span slot="dark" data-svelte-h="svelte-14ov3lc">(dark)</span></astro-island> theme on <a href="https://astro.build/" class="astro-SZ7XMLTE">Astro</a></div>
        <astro-island uid="1I86to" component-url="/_astro/NetlifyIdentity.94b8edb0.js" component-export="default" renderer-url="/_astro/client.cb726945.js" props="{&quot;class&quot;:[0,&quot;astro-SZ7XMLTE&quot;]}" ssr="" client="load" opts="{&quot;name&quot;:&quot;NetlifyIdentity&quot;,&quot;value&quot;:true}"></astro-island>
    </nav>
</footer>
	</body></html>