<!DOCTYPE html>
<html lang="en" class="astro-BVZIHDZO">
	<head>
		<!-- Use Google Fonts, if you don't wanna prefer a self-hosted version --><!-- <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@300;400;500;600;700&display=swap" rel="stylesheet"> --><meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>Asio と Coroutine (c++20)</title>
<meta name="title" content="Asio と Coroutine (c++20)">


<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="shortcut icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">

<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="msapplication-config" content="/browserconfig.xml">
<meta name="theme-color" content="#ffffff">

<!-- Open Graph Tags (Facebook) -->
<meta property="og:type" content="website">
<meta property="og:title" content="Asio と Coroutine (c++20)">




<!-- Twitter -->
<meta property="twitter:card" content="summary_large_image">
<meta property="twitter:title" content="Asio と Coroutine (c++20)">





<script>
  const theme = (() => {
    if (typeof localStorage !== "undefined" && localStorage.getItem("theme")) {
      return localStorage.getItem("theme");
    }
    if (window.matchMedia("(prefers-color-scheme: dark)").matches) {
      return "dark";
    }
    return "light";
  })();

  if (theme === "light") {
    document.documentElement.classList.remove("dark");
  } else {
    document.documentElement.classList.add("dark");
  }
</script>
		
	<link rel="stylesheet" href="/_astro/about.6111bb3a.css" />
<link rel="stylesheet" href="/_astro/about.657f8f57.css" />
<link rel="stylesheet" href="/_astro/about.ee60a110.css" />
<link rel="stylesheet" href="/_astro/about.dcb84f3d.css" /><script type="module" src="/_astro/hoisted.e6960f2c.js"></script></head>

	<body class="astro-BVZIHDZO">
		<header class="header astro-3EF6KSR2">
    <div class="header__logo astro-3EF6KSR2">
        <a href="/" class="avatar astro-3EF6KSR2">
            <img class="header__logo-img astro-3EF6KSR2" src="/assets/logo.svg" alt="Astro logo">
        </a>
    </div>
    <div class="header__meta flex-1 astro-3EF6KSR2">
        <h3 class="header__title dark:text-theme-dark-secondary astro-3EF6KSR2">
            <a href="" class="astro-3EF6KSR2">三次元日誌(astro)</a>
        </h3>
        <div class="header__meta-more flex astro-3EF6KSR2">
            <p class="header__desc astro-3EF6KSR2">
                Crisp, minimal, personal blog theme for Astro
            </p>
            <nav class="header__nav flex astro-3EF6KSR2">
                <ul class="header__ref-list astro-3EF6KSR2">
                    <li class="astro-3EF6KSR2">
                        <style>astro-island,astro-slot,astro-static-slot{display:contents}</style><script>(()=>{var r=(i,c,n)=>{let s=async()=>{await(await i())()},t=new IntersectionObserver(e=>{for(let o of e)if(o.isIntersecting){t.disconnect(),s();break}});for(let e of n.children)t.observe(e)};(self.Astro||(self.Astro={})).visible=r;window.dispatchEvent(new Event("astro:visible"));})();;(()=>{var d;{let p={0:t=>u(t),1:t=>l(t),2:t=>new RegExp(t),3:t=>new Date(t),4:t=>new Map(l(t)),5:t=>new Set(l(t)),6:t=>BigInt(t),7:t=>new URL(t),8:t=>new Uint8Array(t),9:t=>new Uint16Array(t),10:t=>new Uint32Array(t)},h=t=>{let[e,n]=t;return e in p?p[e](n):void 0},l=t=>t.map(h),u=t=>typeof t!="object"||t===null?t:Object.fromEntries(Object.entries(t).map(([e,n])=>[e,h(n)]));customElements.get("astro-island")||customElements.define("astro-island",(d=class extends HTMLElement{constructor(){super(...arguments);this.hydrate=async()=>{var i;if(!this.hydrator||!this.isConnected)return;let e=(i=this.parentElement)==null?void 0:i.closest("astro-island[ssr]");if(e){e.addEventListener("astro:hydrate",this.hydrate,{once:!0});return}let n=this.querySelectorAll("astro-slot"),o={},a=this.querySelectorAll("template[data-astro-template]");for(let r of a){let s=r.closest(this.tagName);s!=null&&s.isSameNode(this)&&(o[r.getAttribute("data-astro-template")||"default"]=r.innerHTML,r.remove())}for(let r of n){let s=r.closest(this.tagName);s!=null&&s.isSameNode(this)&&(o[r.getAttribute("name")||"default"]=r.innerHTML)}let c;try{c=this.hasAttribute("props")?u(JSON.parse(this.getAttribute("props"))):{}}catch(r){let s=this.getAttribute("component-url")||"<unknown>",y=this.getAttribute("component-export");throw y&&(s+=` (export ${y})`),console.error(`[hydrate] Error parsing props for component ${s}`,this.getAttribute("props"),r),r}await this.hydrator(this)(this.Component,c,o,{client:this.getAttribute("client")}),this.removeAttribute("ssr"),this.dispatchEvent(new CustomEvent("astro:hydrate"))}}connectedCallback(){!this.hasAttribute("await-children")||this.firstChild?this.childrenConnectedCallback():new MutationObserver((e,n)=>{n.disconnect(),setTimeout(()=>this.childrenConnectedCallback(),0)}).observe(this,{childList:!0})}async childrenConnectedCallback(){let e=this.getAttribute("before-hydration-url");e&&await import(e),this.start()}start(){let e=JSON.parse(this.getAttribute("opts")),n=this.getAttribute("client");if(Astro[n]===void 0){window.addEventListener(`astro:${n}`,()=>this.start(),{once:!0});return}Astro[n](async()=>{let o=this.getAttribute("renderer-url"),[a,{default:c}]=await Promise.all([import(this.getAttribute("component-url")),o?import(o):()=>()=>{}]),i=this.getAttribute("component-export")||"default";if(!i.includes("."))this.Component=a[i];else{this.Component=a;for(let r of i.split("."))this.Component=this.Component[r]}return this.hydrator=c,this.hydrate},e,this)}attributeChangedCallback(){this.hydrate()}},d.observedAttributes=["props"],d))}})();</script><astro-island uid="2iKzVC" component-url="/_astro/SearchBtn.984510f3.js" component-export="default" renderer-url="/_astro/client.cb726945.js" props="{&quot;class&quot;:[0,&quot;astro-3EF6KSR2&quot;]}" ssr="" client="visible" opts="{&quot;name&quot;:&quot;SearchBtn&quot;,&quot;value&quot;:true}" await-children=""><button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"> <path fill-rule="evenodd" clip-rule="evenodd" d="M16.2071 4.89344C19.0923 7.77862 19.3131 12.3193 16.8693 15.4578C16.8846 15.4713 16.8996 15.4854 16.9143 15.5L21.1569 19.7427C21.5474 20.1332 21.5474 20.7664 21.1569 21.1569C20.7664 21.5474 20.1332 21.5474 19.7427 21.1569L15.5 16.9143C15.4854 16.8996 15.4713 16.8846 15.4578 16.8693C12.3193 19.3131 7.77862 19.0923 4.89344 16.2071C1.76924 13.083 1.76924 8.01763 4.89344 4.89344C8.01763 1.76924 13.083 1.76924 16.2071 4.89344ZM14.7929 14.7929C17.1361 12.4498 17.1361 8.6508 14.7929 6.30765C12.4498 3.96451 8.6508 3.96451 6.30765 6.30765C3.96451 8.6508 3.96451 12.4498 6.30765 14.7929C8.6508 17.1361 12.4498 17.1361 14.7929 14.7929Z" fill="currentColor"></path></svg></button></astro-island>
                    </li>
                    <li class="astro-3EF6KSR2">
                        <a href="https://github.com/one-aalam/astro-ink" title="三次元日誌(astro)'s Github URL'" class="astro-3EF6KSR2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    
                                <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22" class="astro-3EF6KSR2"></path>
                            
</svg>
                        </a>
                    </li>
                    <li class="astro-3EF6KSR2">
                        <a href="/rss.xml" title="RSS" class="astro-3EF6KSR2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    
                                <path d="M4 11a9 9 0 0 1 9 9" class="astro-3EF6KSR2"></path>
                                <path d="M4 4a16 16 0 0 1 16 16" class="astro-3EF6KSR2"></path>
                                <circle cx="5" cy="19" r="1" class="astro-3EF6KSR2"></circle>
                            
</svg>
                        </a>
                    </li>
                    <li class="astro-3EF6KSR2">
                        <astro-island uid="h8S6z" component-url="/_astro/ModeSwitcherBtn.0ddc5d6d.js" component-export="default" renderer-url="/_astro/client.cb726945.js" props="{&quot;class&quot;:[0,&quot;astro-3EF6KSR2&quot;]}" ssr="" client="visible" opts="{&quot;name&quot;:&quot;ModeSwitcherBtn&quot;,&quot;value&quot;:true}" await-children=""><button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle> <line x1="12" y1="1" x2="12" y2="3"></line> <line x1="12" y1="21" x2="12" y2="23"></line> <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line> <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line> <line x1="1" y1="12" x2="3" y2="12"></line> <line x1="21" y1="12" x2="23" y2="12"></line> <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line> <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg></button></astro-island>
                    </li>
                </ul>
            </nav>
        </div>
    </div>
</header>
		<main class="astro-BVZIHDZO">
			<article class="astro-BVZIHDZO">
				<div class="hero-image astro-BVZIHDZO">
					
				</div>
				<div class="prose astro-BVZIHDZO">
					<div class="title astro-BVZIHDZO">
						<div class="date astro-BVZIHDZO">
							<time datetime="2021-08-15T00:00:00.000Z">
	Aug 15, 2021
</time>
							
						</div>
						<h1 class="astro-BVZIHDZO">Asio と Coroutine (c++20)</h1>
						<hr class="astro-BVZIHDZO">
					</div>
					
	<p>非同期ライブラリ ASIO</p>
<p><a href="http://think-async.com/Asio/index.html">http://think-async.com/Asio/index.html</a></p>
<p>の知識を <code>c++20</code> 時代にアップデート。</p>
<ul>
<li><a href="https://github.com/chriskohlhoff/talking-async">https://github.com/chriskohlhoff/talking-async</a></li>
</ul>
<p>に動画と動画のサンプルコードが有る。</p>
<h1 id="compiler-を最新にする">compiler を最新にする</h1>
<p><code>ASIO_HAS_CO_AWAIT</code> が必要でこれが有効になるには新しいコンパイラが必要。</p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #6A737D">// asio/detail/config.hpp`</span></span>
<span class="line"></span>
<span class="line"><span style="color: #6A737D">// Support the co_await keyword on compilers known to allow it.</span></span>
<span class="line"><span style="color: #F97583">#if</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">!defined</span><span style="color: #E1E4E8">(</span><span style="color: #B392F0">ASIO_HAS_CO_AWAIT</span><span style="color: #E1E4E8">)</span></span>
<span class="line"><span style="color: #F97583"># if</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">!defined</span><span style="color: #E1E4E8">(</span><span style="color: #B392F0">ASIO_DISABLE_CO_AWAIT</span><span style="color: #E1E4E8">)</span></span>
<span class="line"><span style="color: #F97583">#  if</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">defined</span><span style="color: #E1E4E8">(</span><span style="color: #B392F0">ASIO_MSVC</span><span style="color: #E1E4E8">)</span></span>
<span class="line"><span style="color: #F97583">#   if</span><span style="color: #E1E4E8"> (</span><span style="color: #B392F0">_MSC_VER</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">>=</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">1928</span><span style="color: #E1E4E8">) </span><span style="color: #F97583">&#x26;&#x26;</span><span style="color: #E1E4E8"> (</span><span style="color: #B392F0">_MSVC_LANG</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">>=</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">201705</span><span style="color: #E1E4E8">) </span><span style="color: #F97583">&#x26;&#x26;</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">!defined</span><span style="color: #E1E4E8">(</span><span style="color: #B392F0">__clang__</span><span style="color: #E1E4E8">)</span></span>
<span class="line"><span style="color: #F97583">#    define</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">ASIO_HAS_CO_AWAIT</span><span style="color: #E1E4E8"> 1</span></span>
<span class="line"><span style="color: #F97583">#   elif</span><span style="color: #E1E4E8"> (</span><span style="color: #B392F0">_MSC_FULL_VER</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">>=</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">190023506</span><span style="color: #E1E4E8">)</span></span>
<span class="line"><span style="color: #F97583">#    if</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">defined</span><span style="color: #E1E4E8">(</span><span style="color: #B392F0">_RESUMABLE_FUNCTIONS_SUPPORTED</span><span style="color: #E1E4E8">)</span></span>
<span class="line"><span style="color: #F97583">#     define</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">ASIO_HAS_CO_AWAIT</span><span style="color: #E1E4E8"> 1</span></span>
<span class="line"><span style="color: #F97583">#    endif</span><span style="color: #6A737D"> // defined(_RESUMABLE_FUNCTIONS_SUPPORTED)</span></span>
<span class="line"><span style="color: #F97583">#   endif</span><span style="color: #6A737D"> // (_MSC_FULL_VER >= 190023506)</span></span>
<span class="line"><span style="color: #F97583">#  elif</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">defined</span><span style="color: #E1E4E8">(</span><span style="color: #B392F0">__clang__</span><span style="color: #E1E4E8">)</span></span>
<span class="line"><span style="color: #F97583">#   if</span><span style="color: #E1E4E8"> (</span><span style="color: #B392F0">__cplusplus</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">>=</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">201703</span><span style="color: #E1E4E8">) </span><span style="color: #F97583">&#x26;&#x26;</span><span style="color: #E1E4E8"> (</span><span style="color: #B392F0">__cpp_coroutines</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">>=</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">201703</span><span style="color: #E1E4E8">)</span></span>
<span class="line"><span style="color: #F97583">#    if</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">__has_include</span><span style="color: #E1E4E8">(</span><span style="color: #F97583">&#x3C;</span><span style="color: #B392F0">experimental</span><span style="color: #F97583">/</span><span style="color: #B392F0">coroutine</span><span style="color: #F97583">></span><span style="color: #E1E4E8">)</span></span>
<span class="line"><span style="color: #F97583">#     define</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">ASIO_HAS_CO_AWAIT</span><span style="color: #E1E4E8"> 1</span></span>
<span class="line"><span style="color: #F97583">#    endif</span><span style="color: #6A737D"> // __has_include(&#x3C;experimental/coroutine>)</span></span>
<span class="line"><span style="color: #F97583">#   endif</span><span style="color: #6A737D"> // (__cplusplus >= 201703) &#x26;&#x26; (__cpp_coroutines >= 201703)</span></span>
<span class="line"><span style="color: #F97583">#  elif</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">defined</span><span style="color: #E1E4E8">(</span><span style="color: #B392F0">__GNUC__</span><span style="color: #E1E4E8">)</span></span>
<span class="line"><span style="color: #F97583">#   if</span><span style="color: #E1E4E8"> (</span><span style="color: #B392F0">__cplusplus</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">>=</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">201709</span><span style="color: #E1E4E8">) </span><span style="color: #F97583">&#x26;&#x26;</span><span style="color: #E1E4E8"> (</span><span style="color: #B392F0">__cpp_impl_coroutine</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">>=</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">201902</span><span style="color: #E1E4E8">)</span></span>
<span class="line"><span style="color: #F97583">#    if</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">__has_include</span><span style="color: #E1E4E8">(</span><span style="color: #F97583">&#x3C;</span><span style="color: #B392F0">coroutine</span><span style="color: #F97583">></span><span style="color: #E1E4E8">)</span></span>
<span class="line"><span style="color: #F97583">#     define</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">ASIO_HAS_CO_AWAIT</span><span style="color: #E1E4E8"> 1</span></span>
<span class="line"><span style="color: #F97583">#    endif</span><span style="color: #6A737D"> // __has_include(&#x3C;coroutine>)</span></span>
<span class="line"><span style="color: #F97583">#   endif</span><span style="color: #6A737D"> // (__cplusplus >= 201709) &#x26;&#x26; (__cpp_impl_coroutine >= 201902)</span></span>
<span class="line"><span style="color: #F97583">#  endif</span><span style="color: #6A737D"> // defined(__GNUC__)</span></span>
<span class="line"><span style="color: #F97583"># endif</span><span style="color: #6A737D"> // !defined(ASIO_DISABLE_CO_AWAIT)</span></span>
<span class="line"><span style="color: #F97583">#endif</span><span style="color: #6A737D"> // !defined(ASIO_HAS_CO_AWAIT)</span></span></code></pre>
<h2 id="vc201920210818最新版いける">VC2019(20210818最新版いける)</h2>
<p><a href="https://devblogs.microsoft.com/cppblog/c-coroutines-in-visual-studio-2019-version-16-8/">https://devblogs.microsoft.com/cppblog/c-coroutines-in-visual-studio-2019-version-16-8/</a></p>
<blockquote>
<p>C++20 coroutines in Visual Studio 2019 version 16.8.</p>
</blockquote>
<ul>
<li><code>16.7.3</code> だめ</li>
<li><code>16.11.1</code> 動いた。</li>
</ul>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #e1e4e8"># CMakeListx.txt</span></span>
<span class="line"><span style="color: #e1e4e8">set(TARGET_NAME pingpong)</span></span>
<span class="line"><span style="color: #e1e4e8">add_executable(${TARGET_NAME} main.cpp)</span></span>
<span class="line"><span style="color: #e1e4e8">target_link_libraries(${TARGET_NAME} PRIVATE asio)</span></span>
<span class="line"><span style="color: #e1e4e8">set_property(TARGET ${TARGET_NAME} PROPERTY CXX_STANDARD 20) # 必要</span></span>
<span class="line"><span style="color: #e1e4e8">target_compile_options(${TARGET_NAME} PUBLIC $&#x3C;$&#x3C;C_COMPILER_ID:MSVC>:/await>) # 必要</span></span>
<span class="line"><span style="color: #e1e4e8">target_compile_definitions(asio INTERFACE ASIO_DISABLE_STD_COROUTINE) # 必要</span></span></code></pre>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #F97583">#if</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">defined</span><span style="color: #E1E4E8">(</span><span style="color: #B392F0">ASIO_HAS_STD_COROUTINE</span><span style="color: #E1E4E8">)</span></span>
<span class="line"><span style="color: #F97583"># include</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">&#x3C;coroutine></span></span>
<span class="line"><span style="color: #F97583">#else</span><span style="color: #6A737D"> // defined(ASIO_HAS_STD_COROUTINE)</span></span>
<span class="line"><span style="color: #F97583"># include</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">&#x3C;experimental/coroutine></span></span>
<span class="line"><span style="color: #F97583">#endif</span><span style="color: #6A737D"> // defined(ASIO_HAS_STD_COROUTINE)</span></span></code></pre>
<h2 id="llvm-12うまくいかず追加のコマンドライン引数か">LLVM-12(うまくいかず。追加のコマンドライン引数か)</h2>
<p><a href="https://clang.llvm.org/cxx_status.html">https://clang.llvm.org/cxx_status.html</a></p>
<p>LLVM-12 だと、</p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #e1e4e8"> 'C:\Program Files\LLVM\bin\clang.exe' -v</span></span>
<span class="line"><span style="color: #e1e4e8">clang version 12.0.1</span></span>
<span class="line"><span style="color: #e1e4e8">Target: x86_64-pc-windows-msvc</span></span>
<span class="line"><span style="color: #e1e4e8">Thread model: posix</span></span>
<span class="line"><span style="color: #e1e4e8">InstalledDir: C:\Program Files\LLVM\bin</span></span></code></pre>
<p>わからん。</p>
<h1 id="コード">コード</h1>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #F97583">#include</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">&#x3C;asio/awaitable.hpp></span></span>
<span class="line"><span style="color: #F97583">#include</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">&#x3C;asio/co_spawn.hpp></span></span>
<span class="line"><span style="color: #F97583">#include</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">&#x3C;asio/detached.hpp></span></span>
<span class="line"><span style="color: #F97583">#include</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">&#x3C;asio/experimental/as_tuple.hpp></span></span>
<span class="line"><span style="color: #F97583">#include</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">&#x3C;asio/io_context.hpp></span></span>
<span class="line"><span style="color: #F97583">#include</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">&#x3C;asio/ip/tcp.hpp></span></span>
<span class="line"><span style="color: #F97583">#include</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">&#x3C;asio/read.hpp></span></span>
<span class="line"><span style="color: #F97583">#include</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">&#x3C;asio/streambuf.hpp></span></span>
<span class="line"><span style="color: #F97583">#include</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">&#x3C;asio/system_timer.hpp></span></span>
<span class="line"><span style="color: #F97583">#include</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">&#x3C;asio/use_awaitable.hpp></span></span>
<span class="line"><span style="color: #F97583">#include</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">&#x3C;asio/use_future.hpp></span></span>
<span class="line"><span style="color: #F97583">#include</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">&#x3C;asio/write.hpp></span></span></code></pre>
<h2 id="co_spawn-で-awaitable-を起動する">co_spawn で awaitable を起動する</h2>
<p>coroutine は 戻り値の型が <code>asio::awaitable&#x3C;T></code> である必要がある。この関数の中で <code>co_await</code>, <code>co_yield</code>, <code>co_return</code> が使える。
coroutine は lambda でもよいので、下記のようにできる。</p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #E1E4E8">  </span><span style="color: #F97583">auto</span><span style="color: #E1E4E8"> co </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> []() -> </span><span style="color: #F97583">asio::awaitable&#x3C;std::string></span><span style="color: #E1E4E8"> {</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #F97583">co_return</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">"result"</span><span style="color: #E1E4E8">;</span></span>
<span class="line"><span style="color: #E1E4E8">  };</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #F97583">auto</span><span style="color: #E1E4E8"> result </span><span style="color: #F97583">=</span></span>
<span class="line"><span style="color: #E1E4E8">      </span><span style="color: #B392F0">asio</span><span style="color: #E1E4E8">::</span><span style="color: #B392F0">co_spawn</span><span style="color: #E1E4E8">(client_context.</span><span style="color: #B392F0">get_executor</span><span style="color: #E1E4E8">(), co, </span><span style="color: #B392F0">asio</span><span style="color: #E1E4E8">::use_future);</span><span style="color: #6A737D"> // coroutine 登録</span></span>
<span class="line"><span style="color: #E1E4E8">  client_context.</span><span style="color: #B392F0">run</span><span style="color: #E1E4E8">();</span><span style="color: #6A737D"> // ループを回す</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #F97583">auto</span><span style="color: #E1E4E8"> pong </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> result.</span><span style="color: #B392F0">get</span><span style="color: #E1E4E8">();</span><span style="color: #6A737D"> // future から結果を得る</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #B392F0">std</span><span style="color: #E1E4E8">::cout </span><span style="color: #F97583">&#x3C;&#x3C;</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">"pong: "</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">&#x3C;&#x3C;</span><span style="color: #E1E4E8"> pong </span><span style="color: #F97583">&#x3C;&#x3C;</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">std</span><span style="color: #E1E4E8">::endl;</span></span></code></pre>
<p>asio::use_future を使うことで返り値 <code>std::future</code> になるので <code>co_return</code> の値を得ることも可能。
結果に興味がないときは、<code>asio::detached</code> でよい。
Completion Handler というコールバックなので、 promise に set_value する関数を自前で書いたりしてもよい様子。
<code>asio::use_awaitable</code> で <code>co_await</code> するのも可能。</p>
<p>返り値が <code>std::tuple&#x3C;asio::error_code, RESULT></code> になるハンドラ。</p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #F97583">constexpr</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">auto</span><span style="color: #E1E4E8"> use_nothrow_awaitable </span><span style="color: #F97583">=</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #B392F0">asio</span><span style="color: #E1E4E8">::</span><span style="color: #B392F0">experimental</span><span style="color: #E1E4E8">::</span><span style="color: #B392F0">as_tuple</span><span style="color: #E1E4E8">(</span><span style="color: #B392F0">asio</span><span style="color: #E1E4E8">::use_awaitable);</span></span></code></pre>
<h2 id="client-side">client side</h2>
<ul>
<li>timer</li>
<li>connect</li>
<li>send(ping)</li>
<li>receive(pong)</li>
</ul>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #E1E4E8">  </span><span style="color: #F97583">auto</span><span style="color: #E1E4E8"> co </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> [</span><span style="color: #F97583">&#x26;</span><span style="color: #FFAB70">context</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #FFAB70">client_context</span><span style="color: #E1E4E8">, </span><span style="color: #FFAB70">ep</span><span style="color: #E1E4E8">]() -> </span><span style="color: #F97583">asio::awaitable&#x3C;std::string></span><span style="color: #E1E4E8"> {</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #B392F0">std</span><span style="color: #E1E4E8">::cout </span><span style="color: #F97583">&#x3C;&#x3C;</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">"[client]wait 1000ms..."</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">&#x3C;&#x3C;</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">std</span><span style="color: #E1E4E8">::endl;</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #B392F0">asio</span><span style="color: #E1E4E8">::</span><span style="color: #B392F0">system_timer</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">timer</span><span style="color: #E1E4E8">(</span><span style="color: #B392F0">context</span><span style="color: #E1E4E8">);</span></span>
<span class="line"><span style="color: #E1E4E8">    timer.</span><span style="color: #B392F0">expires_from_now</span><span style="color: #E1E4E8">(</span><span style="color: #79B8FF">1000</span><span style="color: #F97583">ms</span><span style="color: #E1E4E8">);</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #F97583">co_await</span><span style="color: #E1E4E8"> timer.</span><span style="color: #B392F0">async_wait</span><span style="color: #E1E4E8">(</span><span style="color: #B392F0">asio</span><span style="color: #E1E4E8">::use_awaitable);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #B392F0">std</span><span style="color: #E1E4E8">::cout </span><span style="color: #F97583">&#x3C;&#x3C;</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">"[client]connect: "</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">&#x3C;&#x3C;</span><span style="color: #E1E4E8"> ep </span><span style="color: #F97583">&#x3C;&#x3C;</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">"..."</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">&#x3C;&#x3C;</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">std</span><span style="color: #E1E4E8">::endl;</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #B392F0">asio</span><span style="color: #E1E4E8">::</span><span style="color: #B392F0">ip</span><span style="color: #E1E4E8">::</span><span style="color: #B392F0">tcp</span><span style="color: #E1E4E8">::</span><span style="color: #B392F0">socket</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">socket</span><span style="color: #E1E4E8">(</span><span style="color: #B392F0">context</span><span style="color: #E1E4E8">);</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #F97583">co_await</span><span style="color: #E1E4E8"> socket.</span><span style="color: #B392F0">async_connect</span><span style="color: #E1E4E8">(ep, </span><span style="color: #B392F0">asio</span><span style="color: #E1E4E8">::use_awaitable);</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #B392F0">std</span><span style="color: #E1E4E8">::cout </span><span style="color: #F97583">&#x3C;&#x3C;</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">"[client]connected"</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">&#x3C;&#x3C;</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">std</span><span style="color: #E1E4E8">::endl;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #B392F0">std</span><span style="color: #E1E4E8">::cout </span><span style="color: #F97583">&#x3C;&#x3C;</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">"[client]ping..."</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">&#x3C;&#x3C;</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">std</span><span style="color: #E1E4E8">::endl;</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #B392F0">std</span><span style="color: #E1E4E8">::</span><span style="color: #B392F0">string</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">ping</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">"ping"</span><span style="color: #E1E4E8">);</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #F97583">auto</span><span style="color: #E1E4E8"> write_size </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">co_await</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">asio</span><span style="color: #E1E4E8">::</span><span style="color: #B392F0">async_write</span><span style="color: #E1E4E8">(socket, </span><span style="color: #B392F0">asio</span><span style="color: #E1E4E8">::</span><span style="color: #B392F0">buffer</span><span style="color: #E1E4E8">(ping),</span></span>
<span class="line"><span style="color: #E1E4E8">                                                 </span><span style="color: #B392F0">asio</span><span style="color: #E1E4E8">::use_awaitable);</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #B392F0">assert</span><span style="color: #E1E4E8">(write_size </span><span style="color: #F97583">==</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">4</span><span style="color: #E1E4E8">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #B392F0">std</span><span style="color: #E1E4E8">::cout </span><span style="color: #F97583">&#x3C;&#x3C;</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">"[client]read..."</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">&#x3C;&#x3C;</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">std</span><span style="color: #E1E4E8">::endl;</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #B392F0">asio</span><span style="color: #E1E4E8">::streambuf buf;</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #F97583">auto</span><span style="color: #E1E4E8"> read_size </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">co_await</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">asio</span><span style="color: #E1E4E8">::</span><span style="color: #B392F0">async_read</span><span style="color: #E1E4E8">(</span></span>
<span class="line"><span style="color: #E1E4E8">        socket, buf, </span><span style="color: #B392F0">asio</span><span style="color: #E1E4E8">::</span><span style="color: #B392F0">transfer_at_least</span><span style="color: #E1E4E8">(</span><span style="color: #79B8FF">1</span><span style="color: #E1E4E8">), </span><span style="color: #B392F0">asio</span><span style="color: #E1E4E8">::use_awaitable);</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #F97583">co_return</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">to_string</span><span style="color: #E1E4E8">(buf);</span></span>
<span class="line"><span style="color: #E1E4E8">  };</span></span></code></pre>
<h2 id="server-side">server side</h2>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #F97583">class</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">server</span><span style="color: #E1E4E8"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #B392F0">asio</span><span style="color: #E1E4E8">::io_context </span><span style="color: #F97583">&#x26;</span><span style="color: #E1E4E8">_context;</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #B392F0">asio</span><span style="color: #E1E4E8">::</span><span style="color: #B392F0">ip</span><span style="color: #E1E4E8">::</span><span style="color: #B392F0">tcp</span><span style="color: #E1E4E8">::acceptor _acceptor;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #F97583">public:</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #B392F0">server</span><span style="color: #E1E4E8">(</span><span style="color: #B392F0">asio</span><span style="color: #E1E4E8">::</span><span style="color: #B392F0">io_context</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">&#x26;</span><span style="color: #FFAB70">context</span><span style="color: #E1E4E8">) : </span><span style="color: #B392F0">_context</span><span style="color: #E1E4E8">(context), </span><span style="color: #B392F0">_acceptor</span><span style="color: #E1E4E8">(context) {}</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #B392F0">~server</span><span style="color: #E1E4E8">() {}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #F97583">void</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">listen</span><span style="color: #E1E4E8">(</span><span style="color: #F97583">const</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">asio</span><span style="color: #E1E4E8">::</span><span style="color: #B392F0">ip</span><span style="color: #E1E4E8">::</span><span style="color: #B392F0">tcp</span><span style="color: #E1E4E8">::</span><span style="color: #B392F0">endpoint</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">&#x26;</span><span style="color: #FFAB70">ep</span><span style="color: #E1E4E8">) {</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #B392F0">std</span><span style="color: #E1E4E8">::cout </span><span style="color: #F97583">&#x3C;&#x3C;</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">"[server]listen: "</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">&#x3C;&#x3C;</span><span style="color: #E1E4E8"> ep </span><span style="color: #F97583">&#x3C;&#x3C;</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">"..."</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">&#x3C;&#x3C;</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">std</span><span style="color: #E1E4E8">::endl;</span></span>
<span class="line"><span style="color: #E1E4E8">    _acceptor.</span><span style="color: #B392F0">open</span><span style="color: #E1E4E8">(ep.</span><span style="color: #B392F0">protocol</span><span style="color: #E1E4E8">());</span></span>
<span class="line"><span style="color: #E1E4E8">    _acceptor.</span><span style="color: #B392F0">bind</span><span style="color: #E1E4E8">(ep);</span></span>
<span class="line"><span style="color: #E1E4E8">    _acceptor.</span><span style="color: #B392F0">listen</span><span style="color: #E1E4E8">();</span></span>
<span class="line"></span>
<span class="line"><span style="color: #6A737D">    // coroutineを起動する</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #F97583">auto</span><span style="color: #E1E4E8"> ex </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> _context.</span><span style="color: #B392F0">get_executor</span><span style="color: #E1E4E8">();</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #B392F0">asio</span><span style="color: #E1E4E8">::</span><span style="color: #B392F0">co_spawn</span><span style="color: #E1E4E8">(ex, </span><span style="color: #B392F0">accept_loop</span><span style="color: #E1E4E8">(), </span><span style="color: #B392F0">asio</span><span style="color: #E1E4E8">::detached);</span></span>
<span class="line"><span style="color: #E1E4E8">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #B392F0">asio</span><span style="color: #E1E4E8">::</span><span style="color: #B392F0">awaitable</span><span style="color: #E1E4E8">&#x3C;</span><span style="color: #F97583">void</span><span style="color: #E1E4E8">> </span><span style="color: #B392F0">accept_loop</span><span style="color: #E1E4E8">() {</span></span>
<span class="line"></span>
<span class="line"><span style="color: #6A737D">    // 単なるループになって再起が不要に</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #F97583">while</span><span style="color: #E1E4E8"> (</span><span style="color: #79B8FF">true</span><span style="color: #E1E4E8">) {</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">      </span><span style="color: #F97583">auto</span><span style="color: #E1E4E8"> [e, socket] </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">co_await</span><span style="color: #E1E4E8"> _acceptor.</span><span style="color: #B392F0">async_accept</span><span style="color: #E1E4E8">(use_nothrow_awaitable);</span></span>
<span class="line"><span style="color: #E1E4E8">      </span><span style="color: #F97583">if</span><span style="color: #E1E4E8"> (e) {</span></span>
<span class="line"><span style="color: #E1E4E8">        </span><span style="color: #B392F0">std</span><span style="color: #E1E4E8">::cout </span><span style="color: #F97583">&#x3C;&#x3C;</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">"[server]accept error: "</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">&#x3C;&#x3C;</span><span style="color: #E1E4E8"> e </span><span style="color: #F97583">&#x3C;&#x3C;</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">std</span><span style="color: #E1E4E8">::endl;</span></span>
<span class="line"><span style="color: #E1E4E8">        </span><span style="color: #F97583">break</span><span style="color: #E1E4E8">;</span></span>
<span class="line"><span style="color: #E1E4E8">      }</span></span>
<span class="line"><span style="color: #E1E4E8">      </span><span style="color: #B392F0">std</span><span style="color: #E1E4E8">::cout </span><span style="color: #F97583">&#x3C;&#x3C;</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">"[server]accepted"</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">&#x3C;&#x3C;</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">std</span><span style="color: #E1E4E8">::endl;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #6A737D">      // coroutineを起動する</span></span>
<span class="line"><span style="color: #E1E4E8">      </span><span style="color: #F97583">auto</span><span style="color: #E1E4E8"> ex </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> _context.</span><span style="color: #B392F0">get_executor</span><span style="color: #E1E4E8">();</span></span>
<span class="line"><span style="color: #E1E4E8">      </span><span style="color: #B392F0">asio</span><span style="color: #E1E4E8">::</span><span style="color: #B392F0">co_spawn</span><span style="color: #E1E4E8">(ex, </span><span style="color: #B392F0">session</span><span style="color: #E1E4E8">(</span><span style="color: #B392F0">std</span><span style="color: #E1E4E8">::</span><span style="color: #B392F0">move</span><span style="color: #E1E4E8">(socket)), </span><span style="color: #B392F0">asio</span><span style="color: #E1E4E8">::detached);</span></span>
<span class="line"><span style="color: #E1E4E8">    }</span></span>
<span class="line"><span style="color: #E1E4E8">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #B392F0">asio</span><span style="color: #E1E4E8">::</span><span style="color: #B392F0">awaitable</span><span style="color: #E1E4E8">&#x3C;</span><span style="color: #F97583">void</span><span style="color: #E1E4E8">> </span><span style="color: #B392F0">session</span><span style="color: #E1E4E8">(</span><span style="color: #B392F0">asio</span><span style="color: #E1E4E8">::</span><span style="color: #B392F0">ip</span><span style="color: #E1E4E8">::</span><span style="color: #B392F0">tcp</span><span style="color: #E1E4E8">::</span><span style="color: #B392F0">socket</span><span style="color: #E1E4E8"> </span><span style="color: #FFAB70">socket</span><span style="color: #E1E4E8">) {</span></span>
<span class="line"></span>
<span class="line"><span style="color: #6A737D">    // echo server ぽい ping pong</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #B392F0">asio</span><span style="color: #E1E4E8">::streambuf buf;</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #F97583">auto</span><span style="color: #E1E4E8"> [e1, read_size] </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">co_await</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">asio</span><span style="color: #E1E4E8">::</span><span style="color: #B392F0">async_read</span><span style="color: #E1E4E8">(</span></span>
<span class="line"><span style="color: #E1E4E8">        socket, buf, </span><span style="color: #B392F0">asio</span><span style="color: #E1E4E8">::</span><span style="color: #B392F0">transfer_at_least</span><span style="color: #E1E4E8">(</span><span style="color: #79B8FF">1</span><span style="color: #E1E4E8">), use_nothrow_awaitable);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #F97583">auto</span><span style="color: #E1E4E8"> pong </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">to_string</span><span style="color: #E1E4E8">(buf);</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #B392F0">std</span><span style="color: #E1E4E8">::cout </span><span style="color: #F97583">&#x3C;&#x3C;</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">"[server]ping: "</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">&#x3C;&#x3C;</span><span style="color: #E1E4E8"> pong </span><span style="color: #F97583">&#x3C;&#x3C;</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">std</span><span style="color: #E1E4E8">::endl;</span></span>
<span class="line"><span style="color: #E1E4E8">    pong </span><span style="color: #F97583">+=</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">"pong"</span><span style="color: #E1E4E8">;</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #F97583">auto</span><span style="color: #E1E4E8"> [e2, write_size] </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">co_await</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">asio</span><span style="color: #E1E4E8">::</span><span style="color: #B392F0">async_write</span><span style="color: #E1E4E8">(</span></span>
<span class="line"><span style="color: #E1E4E8">        socket, </span><span style="color: #B392F0">asio</span><span style="color: #E1E4E8">::</span><span style="color: #B392F0">buffer</span><span style="color: #E1E4E8">(pong), use_nothrow_awaitable);</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #B392F0">std</span><span style="color: #E1E4E8">::cout </span><span style="color: #F97583">&#x3C;&#x3C;</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">"[server]pong: "</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">&#x3C;&#x3C;</span><span style="color: #E1E4E8"> write_size </span><span style="color: #F97583">&#x3C;&#x3C;</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">std</span><span style="color: #E1E4E8">::endl;</span></span>
<span class="line"><span style="color: #E1E4E8">  }</span></span>
<span class="line"><span style="color: #E1E4E8">};</span></span></code></pre>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #E1E4E8">  </span><span style="color: #F97583">auto</span><span style="color: #E1E4E8"> ep </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">asio</span><span style="color: #E1E4E8">::</span><span style="color: #B392F0">ip</span><span style="color: #E1E4E8">::</span><span style="color: #B392F0">tcp</span><span style="color: #E1E4E8">::</span><span style="color: #B392F0">endpoint</span><span style="color: #E1E4E8">(</span><span style="color: #B392F0">asio</span><span style="color: #E1E4E8">::</span><span style="color: #B392F0">ip</span><span style="color: #E1E4E8">::</span><span style="color: #B392F0">address</span><span style="color: #E1E4E8">::</span><span style="color: #B392F0">from_string</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">"127.0.0.1"</span><span style="color: #E1E4E8">),</span></span>
<span class="line"><span style="color: #E1E4E8">                                    PORT);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #6A737D">  // server</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #B392F0">asio</span><span style="color: #E1E4E8">::io_context server_context;</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #B392F0">server</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">server</span><span style="color: #E1E4E8">(</span><span style="color: #B392F0">server_context</span><span style="color: #E1E4E8">);</span></span>
<span class="line"><span style="color: #E1E4E8">  server.</span><span style="color: #B392F0">listen</span><span style="color: #E1E4E8">(ep);</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #B392F0">std</span><span style="color: #E1E4E8">::</span><span style="color: #B392F0">thread</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">server_thread</span><span style="color: #E1E4E8">([</span><span style="color: #F97583">&#x26;</span><span style="color: #FFAB70">server_context</span><span style="color: #E1E4E8">]() { server_context.</span><span style="color: #B392F0">run</span><span style="color: #E1E4E8">(); });</span><span style="color: #6A737D"> // thread でループを回す。</span></span></code></pre>
<p>ループ(io_context)が隠蔽されていないのが良いですね。</p>
<h1 id="asio-api">asio api</h1>
<h2 id="io_context">io_context</h2>
<p><code>c++23</code> の <code>Networking TS</code> に向けた変更？</p>
<ul>
<li><a href="https://amedama1x1.hatenablog.com/entry/2016/04/05/205340">Networking TS の Boost.Asio からの変更点 - その 1: Associated allocator</a></li>
<li><a href="https://amedama1x1.hatenablog.com/entry/2016/08/20/222326">Networking TS の Boost.Asio からの変更点 - その 3: Executor</a></li>
</ul>
<blockquote>
<p>io_service は Executor と ExecutionContext という概念に分割されたことで, io_context に名前が変わりました</p>
</blockquote>
<p><code>Boost 1.66</code></p>
<ul>
<li><a href="https://amedama1x1.hatenablog.com/entry/2017/12/09/102405">Networking TS の Boost.Asio からの変更点 - その 4: Associated Executor</a></li>
</ul>
<p>単純に io_service を io_context に追きかえるだけで動いた。</p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #F97583">#include</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">&#x3C;asio.hpp></span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">io_context context;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #6A737D">// 全てのタスクが消化されるまでブロックする。</span></span>
<span class="line"><span style="color: #E1E4E8">context.</span><span style="color: #B392F0">run</span><span style="color: #E1E4E8">();</span></span>
<span class="line"></span>
<span class="line"><span style="color: #6A737D">// スレッド上で実行する例</span></span>
<span class="line"><span style="color: #B392F0">std</span><span style="color: #E1E4E8">::</span><span style="color: #B392F0">thread</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">run_thread</span><span style="color: #E1E4E8">([</span><span style="color: #F97583">&#x26;</span><span style="color: #FFAB70">context</span><span style="color: #E1E4E8">](){ context.</span><span style="color: #B392F0">run</span><span style="color: #E1E4E8">(); });</span></span>
<span class="line"></span>
<span class="line"><span style="color: #6A737D">// 止める</span></span>
<span class="line"><span style="color: #E1E4E8">context.</span><span style="color: #B392F0">stop</span><span style="color: #E1E4E8">();</span></span>
<span class="line"><span style="color: #E1E4E8">run_thread.</span><span style="color: #B392F0">join</span><span style="color: #E1E4E8">();</span></span></code></pre>
<h2 id="endpoint">endpoint</h2>
<p>ipaddress + port</p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #B392F0">asip</span><span style="color: #E1E4E8">::</span><span style="color: #B392F0">ip</span><span style="color: #E1E4E8">::</span><span style="color: #B392F0">tcp</span><span style="color: #E1E4E8">::</span><span style="color: #B392F0">endpoint</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">ep</span><span style="color: #E1E4E8">(</span><span style="color: #B392F0">asio</span><span style="color: #E1E4E8">::</span><span style="color: #B392F0">ip</span><span style="color: #E1E4E8">::</span><span style="color: #B392F0">address</span><span style="color: #E1E4E8">::</span><span style="color: #B392F0">from_string</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">"127.0.0.1"</span><span style="color: #E1E4E8">), </span><span style="color: #79B8FF">1234</span><span style="color: #E1E4E8">);</span></span></code></pre>
<h2 id="tcp-connect">tcp connect</h2>
<p>socket</p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #E1E4E8">io_context context;</span></span>
<span class="line"><span style="color: #B392F0">asio</span><span style="color: #E1E4E8">::</span><span style="color: #B392F0">ip</span><span style="color: #E1E4E8">::</span><span style="color: #B392F0">tcp</span><span style="color: #E1E4E8">::</span><span style="color: #B392F0">socket</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">socket</span><span style="color: #E1E4E8">(</span><span style="color: #B392F0">coontext</span><span style="color: #E1E4E8">);</span></span></code></pre>
<p>basic</p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #F97583">void</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">connect</span><span style="color: #E1E4E8">(</span><span style="color: #B392F0">asio</span><span style="color: #E1E4E8">::</span><span style="color: #B392F0">ip</span><span style="color: #E1E4E8">::</span><span style="color: #B392F0">tcp</span><span style="color: #E1E4E8">::</span><span style="color: #B392F0">socket</span><span style="color: #E1E4E8"> </span><span style="color: #FFAB70">socket</span><span style="color: #E1E4E8">, </span><span style="color: #F97583">const</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">asio</span><span style="color: #E1E4E8">::</span><span style="color: #B392F0">ip</span><span style="color: #E1E4E8">::</span><span style="color: #B392F0">tcp</span><span style="color: #E1E4E8">::</span><span style="color: #B392F0">endpoint</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">&#x26;</span><span style="color: #FFAB70">ep</span><span style="color: #E1E4E8">)</span></span>
<span class="line"><span style="color: #E1E4E8">{</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #F97583">auto</span><span style="color: #E1E4E8"> on_connect </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> [](</span><span style="color: #F97583">const</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">asio</span><span style="color: #E1E4E8">::</span><span style="color: #B392F0">error_code</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">&#x26;</span><span style="color: #FFAB70">ec</span><span style="color: #E1E4E8">)</span></span>
<span class="line"><span style="color: #E1E4E8">  {</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #F97583">if</span><span style="color: #E1E4E8">(ec)</span></span>
<span class="line"><span style="color: #E1E4E8">    {</span></span>
<span class="line"><span style="color: #E1E4E8">      </span><span style="color: #B392F0">std</span><span style="color: #E1E4E8">::cout </span><span style="color: #F97583">&#x3C;&#x3C;</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">"error: "</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">&#x3C;&#x3C;</span><span style="color: #E1E4E8"> ec </span><span style="color: #F97583">&#x3C;&#x3C;</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">std</span><span style="color: #E1E4E8">::endl;</span></span>
<span class="line"><span style="color: #E1E4E8">    }</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #F97583">else</span><span style="color: #E1E4E8">{</span></span>
<span class="line"><span style="color: #E1E4E8">      </span><span style="color: #B392F0">std</span><span style="color: #E1E4E8">::cout </span><span style="color: #F97583">&#x3C;&#x3C;</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">"connected"</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">&#x3C;&#x3C;</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">std</span><span style="color: #E1E4E8">::endl;</span></span>
<span class="line"><span style="color: #E1E4E8">    }</span></span>
<span class="line"><span style="color: #E1E4E8">  };</span></span>
<span class="line"><span style="color: #E1E4E8">  socket.</span><span style="color: #B392F0">async_connect</span><span style="color: #E1E4E8">(ep, on_connect);</span></span>
<span class="line"><span style="color: #E1E4E8">}</span></span></code></pre>
<p><code>c++11 future</code></p>
<p>std::future に対して <code>continue_with</code> する手段を用意しないと、これ単体では使いづらい</p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #B392F0">std</span><span style="color: #E1E4E8">::</span><span style="color: #B392F0">future</span><span style="color: #E1E4E8">&#x3C;</span><span style="color: #F97583">void</span><span style="color: #E1E4E8">> </span><span style="color: #B392F0">connect_future</span><span style="color: #E1E4E8">(</span><span style="color: #B392F0">asio</span><span style="color: #E1E4E8">::</span><span style="color: #B392F0">ip</span><span style="color: #E1E4E8">::</span><span style="color: #B392F0">tcp</span><span style="color: #E1E4E8">::</span><span style="color: #B392F0">socket</span><span style="color: #E1E4E8"> </span><span style="color: #FFAB70">socket</span><span style="color: #E1E4E8">, </span><span style="color: #F97583">const</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">asio</span><span style="color: #E1E4E8">::</span><span style="color: #B392F0">ip</span><span style="color: #E1E4E8">::</span><span style="color: #B392F0">tcp</span><span style="color: #E1E4E8">::</span><span style="color: #B392F0">endpoint</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">&#x26;</span><span style="color: #FFAB70">ep</span><span style="color: #E1E4E8">)</span></span>
<span class="line"><span style="color: #E1E4E8">{</span></span>
<span class="line"><span style="color: #6A737D">  // move するのが大変な場合があるので手抜き</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #F97583">auto</span><span style="color: #E1E4E8"> p </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">std</span><span style="color: #E1E4E8">::</span><span style="color: #B392F0">make_shared</span><span style="color: #E1E4E8">&#x3C;</span><span style="color: #B392F0">std</span><span style="color: #E1E4E8">::</span><span style="color: #B392F0">promise</span><span style="color: #E1E4E8">&#x3C;</span><span style="color: #F97583">void</span><span style="color: #E1E4E8">>>();</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #F97583">auto</span><span style="color: #E1E4E8"> f </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> p-></span><span style="color: #B392F0">get_future</span><span style="color: #E1E4E8">();</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">  socket.</span><span style="color: #B392F0">async_connect</span><span style="color: #E1E4E8">(ep, [</span><span style="color: #FFAB70">p</span><span style="color: #E1E4E8">](</span><span style="color: #B392F0">asio</span><span style="color: #E1E4E8">::</span><span style="color: #B392F0">error_code</span><span style="color: #E1E4E8"> </span><span style="color: #FFAB70">ec</span><span style="color: #E1E4E8">){</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #F97583">if</span><span style="color: #E1E4E8">(ec)</span></span>
<span class="line"><span style="color: #E1E4E8">    {</span></span>
<span class="line"><span style="color: #E1E4E8">    }</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #F97583">else</span><span style="color: #E1E4E8">{</span></span>
<span class="line"><span style="color: #6A737D">      // future value</span></span>
<span class="line"><span style="color: #E1E4E8">      p-></span><span style="color: #B392F0">set_value</span><span style="color: #E1E4E8">();</span></span>
<span class="line"><span style="color: #E1E4E8">    }</span></span>
<span class="line"><span style="color: #E1E4E8">  });</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #F97583">return</span><span style="color: #E1E4E8"> f;</span></span>
<span class="line"><span style="color: #E1E4E8">}</span></span></code></pre>
<p><code>c++20 coroutine</code></p>
<p>有望</p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #B392F0">asio</span><span style="color: #E1E4E8">::</span><span style="color: #B392F0">awaitable</span><span style="color: #E1E4E8">&#x3C;</span><span style="color: #F97583">void</span><span style="color: #E1E4E8">> </span><span style="color: #B392F0">co</span><span style="color: #E1E4E8">(</span><span style="color: #B392F0">asio</span><span style="color: #E1E4E8">::</span><span style="color: #B392F0">io_context</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">&#x26;</span><span style="color: #FFAB70">context</span><span style="color: #E1E4E8">, </span><span style="color: #F97583">const</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">asio</span><span style="color: #E1E4E8">::</span><span style="color: #B392F0">ip</span><span style="color: #E1E4E8">::</span><span style="color: #B392F0">tcp</span><span style="color: #E1E4E8">::</span><span style="color: #B392F0">endpoint</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">&#x26;</span><span style="color: #FFAB70">ep</span><span style="color: #E1E4E8">)</span></span>
<span class="line"><span style="color: #E1E4E8">{</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #B392F0">asio</span><span style="color: #E1E4E8">::</span><span style="color: #B392F0">ip</span><span style="color: #E1E4E8">::</span><span style="color: #B392F0">tcp</span><span style="color: #E1E4E8">::socket </span><span style="color: #B392F0">socket</span><span style="color: #E1E4E8">(coontext);</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #F97583">co_await</span><span style="color: #E1E4E8"> socket.</span><span style="color: #B392F0">async_connect</span><span style="color: #E1E4E8">(ep, </span><span style="color: #B392F0">asio</span><span style="color: #E1E4E8">::use_awaitable);</span></span>
<span class="line"><span style="color: #E1E4E8">}</span></span></code></pre>
<h2 id="tcp-listen">tcp listen</h2>
<h2 id="raed_async">raed_async</h2>
<h2 id="write_async">write_async</h2>
<h1 id="coroutine-詳細">coroutine 詳細</h1>
<p>asio の coroutine を学んでいたらできないことが出てきた。</p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #F97583">auto</span><span style="color: #E1E4E8"> result </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">co_await</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">rpc_call</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">"add"</span><span style="color: #E1E4E8">, </span><span style="color: #79B8FF">1</span><span style="color: #E1E4E8">, </span><span style="color: #79B8FF">2</span><span style="color: #E1E4E8">);</span></span></code></pre>
<h1 id="自前の-awaiter-が必要">自前の Awaiter が必要？</h1>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #F97583">template</span><span style="color: #E1E4E8">&#x3C;</span><span style="color: #F97583">typename</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">R</span><span style="color: #E1E4E8">, </span><span style="color: #F97583">typename</span><span style="color: #E1E4E8"> ...</span><span style="color: #B392F0">AS</span><span style="color: #E1E4E8">></span></span>
<span class="line"><span style="color: #B392F0">asio</span><span style="color: #E1E4E8">::</span><span style="color: #B392F0">awaitable</span><span style="color: #E1E4E8">&#x3C;</span><span style="color: #B392F0">R</span><span style="color: #E1E4E8">> </span><span style="color: #B392F0">rpc_call</span><span style="color: #E1E4E8">(</span><span style="color: #F97583">const</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">std</span><span style="color: #E1E4E8">::</span><span style="color: #B392F0">string</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">&#x26;</span><span style="color: #FFAB70">method</span><span style="color: #E1E4E8">, </span><span style="color: #B392F0">AS</span><span style="color: #E1E4E8">... </span><span style="color: #FFAB70">as</span><span style="color: #E1E4E8">)</span></span>
<span class="line"><span style="color: #E1E4E8">{</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #B392F0">asio</span><span style="color: #E1E4E8">::io_context context;</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #B392F0">asio</span><span style="color: #E1E4E8">::</span><span style="color: #B392F0">ip</span><span style="color: #E1E4E8">::</span><span style="color: #B392F0">tcp</span><span style="color: #E1E4E8">::socket </span><span style="color: #B392F0">socket</span><span style="color: #E1E4E8">(context);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #B392F0">asio</span><span style="color: #E1E4E8">::</span><span style="color: #B392F0">ip</span><span style="color: #E1E4E8">::</span><span style="color: #B392F0">tcp</span><span style="color: #E1E4E8">::endpoint ep;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #F97583">co_await</span><span style="color: #E1E4E8"> socket.</span><span style="color: #B392F0">connect_async</span><span style="color: #E1E4E8">(ep, </span><span style="color: #B392F0">asio</span><span style="color: #E1E4E8">::use_awaitable);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #6A737D">  // msgpack-rpc</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #B392F0">std</span><span style="color: #E1E4E8">::vector</span><span style="color: #F97583">&#x3C;uint8_t></span><span style="color: #E1E4E8"> request </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">make_request</span><span style="color: #E1E4E8">(method, as...);</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #F97583">co_await</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">asio</span><span style="color: #E1E4E8">::</span><span style="color: #B392F0">write_async</span><span style="color: #E1E4E8">(socket, request, </span><span style="color: #B392F0">asio</span><span style="color: #E1E4E8">::use_awaitable); </span></span>
<span class="line"></span>
<span class="line"><span style="color: #6A737D">  // ここで実行の流れが切れる</span></span>
<span class="line"></span>
<span class="line"><span style="color: #6A737D">  // ?</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #B392F0">std</span><span style="color: #E1E4E8">::promise</span><span style="color: #F97583">&#x3C;</span><span style="color: #E1E4E8">R</span><span style="color: #F97583">></span><span style="color: #E1E4E8"> p;</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #F97583">return</span><span style="color: #E1E4E8"> p.</span><span style="color: #B392F0">get_future</span><span style="color: #E1E4E8">();</span></span>
<span class="line"><span style="color: #E1E4E8">}</span></span></code></pre>
<p><code>co_await std::future</code> できるぽいが, <code>asio</code> と混ぜてうまくいくのだろうか。</p>
<h1 id="c20-coroutine">c++20 coroutine</h1>
<ul>
<li><a href="https://cpprefjp.github.io/lang/cpp20/coroutines.html">https://cpprefjp.github.io/lang/cpp20/coroutines.html</a></li>
<li><a href="https://www.scs.stanford.edu/~dm/blog/c++-coroutines.html">https://www.scs.stanford.edu/~dm/blog/c++-coroutines.html</a></li>
<li><a href="https://qiita.com/tan-y/items/ae54153ec3eb42f80638">C++ でコルーチン (async/await 準備編)</a></li>
<li><a href="https://qiita.com/tan-y/items/6033ab9e7298999bf214#await_ready">C++ で async/await をする</a></li>
</ul>
<p>内部で <code>co_await</code>, <code>co_yield</code>, <code>co_return</code> の何れかを使う関数は coroutine になる。
返り値の型から promise_type を得られるようにする必要がある。</p>
<p>初期化は <code>promise_type::get_return_object</code> から始まるぽい。</p>
<h2 id="generator-の例">generator の例</h2>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #F97583">struct</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">generator</span><span style="color: #E1E4E8"> {</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #F97583">struct</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">promise_type</span><span style="color: #E1E4E8">;</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #F97583">using</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">handle</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">std</span><span style="color: #E1E4E8">::</span><span style="color: #B392F0">coroutine_handle</span><span style="color: #E1E4E8">&#x3C;</span><span style="color: #B392F0">promise_type</span><span style="color: #E1E4E8">>;  </span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #F97583">struct</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">promise_type</span><span style="color: #E1E4E8"> {</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #F97583">auto</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">get_return_object</span><span style="color: #E1E4E8">() { </span><span style="color: #F97583">return</span><span style="color: #E1E4E8"> generator{</span><span style="color: #B392F0">handle</span><span style="color: #E1E4E8">::</span><span style="color: #B392F0">from_promise</span><span style="color: #E1E4E8">(</span><span style="color: #F97583">*</span><span style="color: #79B8FF">this</span><span style="color: #E1E4E8">)}; }</span></span>
<span class="line"><span style="color: #E1E4E8">  };</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #F97583">using</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">handle</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">std</span><span style="color: #E1E4E8">::</span><span style="color: #B392F0">coroutine_handle</span><span style="color: #E1E4E8">&#x3C;</span><span style="color: #B392F0">promise_type</span><span style="color: #E1E4E8">>;</span></span>
<span class="line"><span style="color: #F97583">private:</span></span>
<span class="line"><span style="color: #E1E4E8">  handle coro;</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #B392F0">generator</span><span style="color: #E1E4E8">(</span><span style="color: #B392F0">handle</span><span style="color: #E1E4E8"> </span><span style="color: #FFAB70">h</span><span style="color: #E1E4E8">) : </span><span style="color: #B392F0">coro</span><span style="color: #E1E4E8">(h) {}</span></span>
<span class="line"><span style="color: #E1E4E8">};</span></span></code></pre>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #E1E4E8">promise_type promise;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #6A737D">// 戻り値型オブジェクトの初期化</span></span>
<span class="line"><span style="color: #F97583">auto</span><span style="color: #E1E4E8"> result </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> promise.</span><span style="color: #B392F0">get_return_object</span><span style="color: #E1E4E8">();</span></span></code></pre>
<h1 id="asio-の実装">Asio の実装</h1>
<h2 id="asioawaitable">asio::awaitable</h2>
<p><code>asio::awaitable&#x3C;T></code> が CoroutineTrait の実装。</p>
<p><code>include/asio/awaitable.hpp</code></p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #F97583">template</span><span style="color: #E1E4E8"> &#x3C;</span><span style="color: #F97583">typename</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">T</span><span style="color: #E1E4E8">, </span><span style="color: #F97583">typename</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">Executor</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> any_io_executor></span></span>
<span class="line"><span style="color: #F97583">class</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">ASIO_NODISCARD</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">awaitable</span></span>
<span class="line"><span style="color: #E1E4E8">{</span></span>
<span class="line"><span style="color: #F97583">public:</span></span>
<span class="line"><span style="color: #6A737D">  /// The type of the awaited value.</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #F97583">typedef</span><span style="color: #E1E4E8"> T value_type;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #6A737D">  /// The executor type that will be used for the coroutine.</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #F97583">typedef</span><span style="color: #E1E4E8"> Executor executor_type;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #6A737D">  /// Default constructor.</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #F97583">constexpr</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">awaitable</span><span style="color: #E1E4E8">() </span><span style="color: #F97583">noexcept</span></span>
<span class="line"><span style="color: #E1E4E8">    : </span><span style="color: #B392F0">frame_</span><span style="color: #E1E4E8">(</span><span style="color: #79B8FF">nullptr</span><span style="color: #E1E4E8">)</span></span>
<span class="line"><span style="color: #E1E4E8">  {</span></span>
<span class="line"><span style="color: #E1E4E8">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #6A737D">  /// Move constructor.</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #B392F0">awaitable</span><span style="color: #E1E4E8">(</span><span style="color: #B392F0">awaitable</span><span style="color: #F97583">&#x26;&#x26;</span><span style="color: #E1E4E8"> </span><span style="color: #FFAB70">other</span><span style="color: #E1E4E8">) </span><span style="color: #F97583">noexcept</span></span>
<span class="line"><span style="color: #E1E4E8">    : </span><span style="color: #B392F0">frame_</span><span style="color: #E1E4E8">(</span><span style="color: #B392F0">std</span><span style="color: #E1E4E8">::</span><span style="color: #B392F0">exchange</span><span style="color: #E1E4E8">(other.frame_, </span><span style="color: #79B8FF">nullptr</span><span style="color: #E1E4E8">))</span></span>
<span class="line"><span style="color: #E1E4E8">  {</span></span>
<span class="line"><span style="color: #E1E4E8">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #6A737D">  /// Destructor</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #B392F0">~awaitable</span><span style="color: #E1E4E8">()</span></span>
<span class="line"><span style="color: #E1E4E8">  {</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #F97583">if</span><span style="color: #E1E4E8"> (frame_)</span></span>
<span class="line"><span style="color: #E1E4E8">      frame_-></span><span style="color: #B392F0">destroy</span><span style="color: #E1E4E8">();</span></span>
<span class="line"><span style="color: #E1E4E8">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #6A737D">  /// Checks if the awaitable refers to a future result.</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #F97583">bool</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">valid</span><span style="color: #E1E4E8">() </span><span style="color: #F97583">const</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">noexcept</span></span>
<span class="line"><span style="color: #E1E4E8">  {</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #F97583">return</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">!!</span><span style="color: #E1E4E8">frame_;</span></span>
<span class="line"><span style="color: #E1E4E8">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #F97583">#if</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">!defined</span><span style="color: #E1E4E8">(</span><span style="color: #B392F0">GENERATING_DOCUMENTATION</span><span style="color: #E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #6A737D">  // Support for co_await keyword.</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #F97583">bool</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">await_ready</span><span style="color: #E1E4E8">() </span><span style="color: #F97583">const</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">noexcept</span></span>
<span class="line"><span style="color: #E1E4E8">  {</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #F97583">return</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">false</span><span style="color: #E1E4E8">;</span></span>
<span class="line"><span style="color: #E1E4E8">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #6A737D">  // Support for co_await keyword.</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #F97583">template</span><span style="color: #E1E4E8"> &#x3C;</span><span style="color: #F97583">class</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">U</span><span style="color: #E1E4E8">></span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #F97583">void</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">await_suspend</span><span style="color: #E1E4E8">(</span></span>
<span class="line"><span style="color: #E1E4E8">      </span><span style="color: #B392F0">detail</span><span style="color: #E1E4E8">::</span><span style="color: #B392F0">coroutine_handle</span><span style="color: #E1E4E8">&#x3C;</span><span style="color: #B392F0">detail</span><span style="color: #E1E4E8">::</span><span style="color: #B392F0">awaitable_frame</span><span style="color: #E1E4E8">&#x3C;</span><span style="color: #B392F0">U</span><span style="color: #E1E4E8">, </span><span style="color: #B392F0">Executor</span><span style="color: #E1E4E8">>> </span><span style="color: #FFAB70">h</span><span style="color: #E1E4E8">)</span></span>
<span class="line"><span style="color: #E1E4E8">  {</span></span>
<span class="line"><span style="color: #E1E4E8">    frame_-></span><span style="color: #B392F0">push_frame</span><span style="color: #E1E4E8">(</span><span style="color: #F97583">&#x26;</span><span style="color: #E1E4E8">h.</span><span style="color: #B392F0">promise</span><span style="color: #E1E4E8">());</span></span>
<span class="line"><span style="color: #E1E4E8">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #6A737D">  // Support for co_await keyword.</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #B392F0">T</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">await_resume</span><span style="color: #E1E4E8">()</span></span>
<span class="line"><span style="color: #E1E4E8">  {</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #F97583">return</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">awaitable</span><span style="color: #E1E4E8">(</span><span style="color: #F97583">static_cast&#x3C;</span><span style="color: #E1E4E8">awaitable</span><span style="color: #F97583">&#x26;&#x26;></span><span style="color: #E1E4E8">(</span><span style="color: #F97583">*</span><span style="color: #79B8FF">this</span><span style="color: #E1E4E8">)).frame_-></span><span style="color: #B392F0">get</span><span style="color: #E1E4E8">();</span></span>
<span class="line"><span style="color: #E1E4E8">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #F97583">#endif</span><span style="color: #6A737D"> // !defined(GENERATING_DOCUMENTATION)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #F97583">private:</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #F97583">template</span><span style="color: #E1E4E8"> &#x3C;</span><span style="color: #F97583">typename</span><span style="color: #E1E4E8">> </span><span style="color: #F97583">friend</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">class</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">detail</span><span style="color: #E1E4E8">::</span><span style="color: #B392F0">awaitable_thread</span><span style="color: #E1E4E8">;</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #F97583">template</span><span style="color: #E1E4E8"> &#x3C;</span><span style="color: #F97583">typename</span><span style="color: #E1E4E8">, </span><span style="color: #F97583">typename</span><span style="color: #E1E4E8">> </span><span style="color: #F97583">friend</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">class</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">detail</span><span style="color: #E1E4E8">::</span><span style="color: #B392F0">awaitable_frame</span><span style="color: #E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #6A737D">  // Not copy constructible or copy assignable.</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #B392F0">awaitable</span><span style="color: #E1E4E8">(</span><span style="color: #F97583">const</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">awaitable</span><span style="color: #F97583">&#x26;</span><span style="color: #E1E4E8">) </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">delete</span><span style="color: #E1E4E8">;</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #B392F0">awaitable</span><span style="color: #F97583">&#x26;</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">operator</span><span style="color: #B392F0">=</span><span style="color: #E1E4E8">(</span><span style="color: #F97583">const</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">awaitable</span><span style="color: #F97583">&#x26;</span><span style="color: #E1E4E8">) </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">delete</span><span style="color: #E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #6A737D">  // Construct the awaitable from a coroutine's frame object.</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #F97583">explicit</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">awaitable</span><span style="color: #E1E4E8">(</span><span style="color: #B392F0">detail</span><span style="color: #E1E4E8">::</span><span style="color: #B392F0">awaitable_frame</span><span style="color: #E1E4E8">&#x3C;</span><span style="color: #B392F0">T</span><span style="color: #E1E4E8">, </span><span style="color: #B392F0">Executor</span><span style="color: #E1E4E8">></span><span style="color: #F97583">*</span><span style="color: #E1E4E8"> </span><span style="color: #FFAB70">a</span><span style="color: #E1E4E8">)</span></span>
<span class="line"><span style="color: #E1E4E8">    : </span><span style="color: #B392F0">frame_</span><span style="color: #E1E4E8">(a)</span></span>
<span class="line"><span style="color: #E1E4E8">  {</span></span>
<span class="line"><span style="color: #E1E4E8">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #B392F0">detail</span><span style="color: #E1E4E8">::awaitable_frame</span><span style="color: #F97583">&#x3C;</span><span style="color: #E1E4E8">T, Executor</span><span style="color: #F97583">>*</span><span style="color: #E1E4E8"> frame_;</span></span>
<span class="line"><span style="color: #E1E4E8">};</span></span></code></pre>
<h2 id="promise_type">promise_type</h2>
<p><code>include/asio/impl/awaitable.hpp</code></p>
<p>// promise_type</p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #F97583"># if</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">defined</span><span style="color: #E1E4E8">(</span><span style="color: #B392F0">ASIO_HAS_STD_COROUTINE</span><span style="color: #E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #F97583">namespace</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">std</span><span style="color: #E1E4E8"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color: #F97583">template</span><span style="color: #E1E4E8"> &#x3C;</span><span style="color: #F97583">typename</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">T</span><span style="color: #E1E4E8">, </span><span style="color: #F97583">typename</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">Executor</span><span style="color: #E1E4E8">, </span><span style="color: #F97583">typename</span><span style="color: #E1E4E8">... </span><span style="color: #B392F0">Args</span><span style="color: #E1E4E8">></span></span>
<span class="line"><span style="color: #F97583">struct</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">coroutine_traits</span><span style="color: #E1E4E8">&#x3C;</span><span style="color: #B392F0">asio</span><span style="color: #E1E4E8">::</span><span style="color: #B392F0">awaitable</span><span style="color: #E1E4E8">&#x3C;</span><span style="color: #B392F0">T</span><span style="color: #E1E4E8">, </span><span style="color: #B392F0">Executor</span><span style="color: #E1E4E8">>, Args...></span></span>
<span class="line"><span style="color: #E1E4E8">{</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #F97583">typedef</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">asio</span><span style="color: #E1E4E8">::</span><span style="color: #B392F0">detail</span><span style="color: #E1E4E8">::awaitable_frame</span><span style="color: #F97583">&#x3C;</span><span style="color: #E1E4E8">T, Executor</span><span style="color: #F97583">></span><span style="color: #E1E4E8"> promise_type;</span></span>
<span class="line"><span style="color: #E1E4E8">};</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">}</span><span style="color: #6A737D"> // namespace std</span></span>
<span class="line"></span>
<span class="line"><span style="color: #F97583"># else</span><span style="color: #6A737D"> // defined(ASIO_HAS_STD_COROUTINE)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #F97583">namespace</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">std</span><span style="color: #E1E4E8"> { </span><span style="color: #F97583">namespace</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">experimental</span><span style="color: #E1E4E8"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color: #F97583">template</span><span style="color: #E1E4E8"> &#x3C;</span><span style="color: #F97583">typename</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">T</span><span style="color: #E1E4E8">, </span><span style="color: #F97583">typename</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">Executor</span><span style="color: #E1E4E8">, </span><span style="color: #F97583">typename</span><span style="color: #E1E4E8">... </span><span style="color: #B392F0">Args</span><span style="color: #E1E4E8">></span></span>
<span class="line"><span style="color: #F97583">struct</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">coroutine_traits</span><span style="color: #E1E4E8">&#x3C;</span><span style="color: #B392F0">asio</span><span style="color: #E1E4E8">::</span><span style="color: #B392F0">awaitable</span><span style="color: #E1E4E8">&#x3C;</span><span style="color: #B392F0">T</span><span style="color: #E1E4E8">, </span><span style="color: #B392F0">Executor</span><span style="color: #E1E4E8">>, Args...></span></span>
<span class="line"><span style="color: #E1E4E8">{</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #F97583">typedef</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">asio</span><span style="color: #E1E4E8">::</span><span style="color: #B392F0">detail</span><span style="color: #E1E4E8">::awaitable_frame</span><span style="color: #F97583">&#x3C;</span><span style="color: #E1E4E8">T, Executor</span><span style="color: #F97583">></span><span style="color: #E1E4E8"> promise_type;</span></span>
<span class="line"><span style="color: #E1E4E8">};</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">}}</span><span style="color: #6A737D"> // namespace std::experimental</span></span>
<span class="line"></span>
<span class="line"><span style="color: #F97583"># endif</span><span style="color: #6A737D"> // defined(ASIO_HAS_STD_COROUTINE)</span></span></code></pre>
<h2 id="asiodetailawaitable_frame">asio::detail::awaitable_frame</h2>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #F97583">template</span><span style="color: #E1E4E8"> &#x3C;</span><span style="color: #F97583">typename</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">Executor</span><span style="color: #E1E4E8">></span></span>
<span class="line"><span style="color: #F97583">class</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">awaitable_frame</span><span style="color: #E1E4E8">&#x3C;</span><span style="color: #F97583">void</span><span style="color: #E1E4E8">, </span><span style="color: #B392F0">Executor</span><span style="color: #E1E4E8">></span></span>
<span class="line"><span style="color: #E1E4E8">  : </span><span style="color: #F97583">public</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">awaitable_frame_base</span><span style="color: #E1E4E8">&#x3C;</span><span style="color: #B392F0">Executor</span><span style="color: #E1E4E8">></span></span>
<span class="line"><span style="color: #E1E4E8">{</span></span>
<span class="line"><span style="color: #F97583">public:</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #B392F0">awaitable</span><span style="color: #E1E4E8">&#x3C;</span><span style="color: #F97583">void</span><span style="color: #E1E4E8">, </span><span style="color: #B392F0">Executor</span><span style="color: #E1E4E8">> </span><span style="color: #B392F0">get_return_object</span><span style="color: #E1E4E8">()</span></span>
<span class="line"><span style="color: #E1E4E8">  {</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #79B8FF">this</span><span style="color: #E1E4E8">->coro_ </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">coroutine_handle</span><span style="color: #E1E4E8">&#x3C;</span><span style="color: #B392F0">awaitable_frame</span><span style="color: #E1E4E8">>::</span><span style="color: #B392F0">from_promise</span><span style="color: #E1E4E8">(</span><span style="color: #F97583">*</span><span style="color: #79B8FF">this</span><span style="color: #E1E4E8">);</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #F97583">return</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">awaitable</span><span style="color: #E1E4E8">&#x3C;</span><span style="color: #F97583">void</span><span style="color: #E1E4E8">, </span><span style="color: #B392F0">Executor</span><span style="color: #E1E4E8">>(</span><span style="color: #79B8FF">this</span><span style="color: #E1E4E8">);</span></span>
<span class="line"><span style="color: #E1E4E8">  };</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #F97583">void</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">return_void</span><span style="color: #E1E4E8">()</span></span>
<span class="line"><span style="color: #E1E4E8">  {</span></span>
<span class="line"><span style="color: #E1E4E8">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #F97583">void</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">get</span><span style="color: #E1E4E8">()</span></span>
<span class="line"><span style="color: #E1E4E8">  {</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #79B8FF">this</span><span style="color: #E1E4E8">->caller_ </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">nullptr</span><span style="color: #E1E4E8">;</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #79B8FF">this</span><span style="color: #E1E4E8">-></span><span style="color: #B392F0">rethrow_exception</span><span style="color: #E1E4E8">();</span></span>
<span class="line"><span style="color: #E1E4E8">  }</span></span>
<span class="line"><span style="color: #E1E4E8">};</span></span></code></pre>

				</div>
			</article>
		</main>
		<footer class="footer astro-SZ7XMLTE">
    <nav class="nav astro-SZ7XMLTE">
        <div class="astro-SZ7XMLTE">2021  &copy; Copyright notice |  <a href="https://github.com/one-aalam/astro-ink" title="三次元日誌(astro)'s Github URL'" class="astro-SZ7XMLTE">三次元日誌(astro)</a>
        <script>(()=>{var e=async t=>{await(await t())()};(self.Astro||(self.Astro={})).load=e;window.dispatchEvent(new Event("astro:load"));})();</script><astro-island uid="1QEdto" component-url="/_astro/ModeLabel.e3ff75e7.js" component-export="default" renderer-url="/_astro/client.cb726945.js" props="{&quot;class&quot;:[0,&quot;astro-SZ7XMLTE&quot;]}" ssr="" client="load" opts="{&quot;name&quot;:&quot;ModeLabel&quot;,&quot;value&quot;:true}" await-children=""><span slot="dark" data-svelte-h="svelte-14ov3lc">(dark)</span></astro-island> theme on <a href="https://astro.build/" class="astro-SZ7XMLTE">Astro</a></div>
        <astro-island uid="1I86to" component-url="/_astro/NetlifyIdentity.94b8edb0.js" component-export="default" renderer-url="/_astro/client.cb726945.js" props="{&quot;class&quot;:[0,&quot;astro-SZ7XMLTE&quot;]}" ssr="" client="load" opts="{&quot;name&quot;:&quot;NetlifyIdentity&quot;,&quot;value&quot;:true}"></astro-island>
    </nav>
</footer>
	</body></html>