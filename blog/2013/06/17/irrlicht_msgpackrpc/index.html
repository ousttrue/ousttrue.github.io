<!DOCTYPE html>
<html lang="en" class="astro-BVZIHDZO">
	<head>
		<!-- Use Google Fonts, if you don't wanna prefer a self-hosted version --><!-- <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@300;400;500;600;700&display=swap" rel="stylesheet"> --><meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>IrrlichtにMsgPackRPCを仕込む</title>
<meta name="title" content="IrrlichtにMsgPackRPCを仕込む">


<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="shortcut icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">

<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="msapplication-config" content="/browserconfig.xml">
<meta name="theme-color" content="#ffffff">

<!-- Open Graph Tags (Facebook) -->
<meta property="og:type" content="website">
<meta property="og:title" content="IrrlichtにMsgPackRPCを仕込む">




<!-- Twitter -->
<meta property="twitter:card" content="summary_large_image">
<meta property="twitter:title" content="IrrlichtにMsgPackRPCを仕込む">





<script>
  const theme = (() => {
    if (typeof localStorage !== "undefined" && localStorage.getItem("theme")) {
      return localStorage.getItem("theme");
    }
    if (window.matchMedia("(prefers-color-scheme: dark)").matches) {
      return "dark";
    }
    return "light";
  })();

  if (theme === "light") {
    document.documentElement.classList.remove("dark");
  } else {
    document.documentElement.classList.add("dark");
  }
</script>
		
	<link rel="stylesheet" href="/_astro/about.6111bb3a.css" />
<link rel="stylesheet" href="/_astro/about.657f8f57.css" />
<link rel="stylesheet" href="/_astro/about.ee60a110.css" />
<link rel="stylesheet" href="/_astro/about.dcb84f3d.css" /><script type="module" src="/_astro/hoisted.e6960f2c.js"></script></head>

	<body class="astro-BVZIHDZO">
		<header class="header astro-3EF6KSR2">
    <div class="header__logo astro-3EF6KSR2">
        <a href="/" class="avatar astro-3EF6KSR2">
            <img class="header__logo-img astro-3EF6KSR2" src="/assets/logo.svg" alt="Astro logo">
        </a>
    </div>
    <div class="header__meta flex-1 astro-3EF6KSR2">
        <h3 class="header__title dark:text-theme-dark-secondary astro-3EF6KSR2">
            <a href="" class="astro-3EF6KSR2">三次元日誌(astro)</a>
        </h3>
        <div class="header__meta-more flex astro-3EF6KSR2">
            <p class="header__desc astro-3EF6KSR2">
                Crisp, minimal, personal blog theme for Astro
            </p>
            <nav class="header__nav flex astro-3EF6KSR2">
                <ul class="header__ref-list astro-3EF6KSR2">
                    <li class="astro-3EF6KSR2">
                        <style>astro-island,astro-slot,astro-static-slot{display:contents}</style><script>(()=>{var r=(i,c,n)=>{let s=async()=>{await(await i())()},t=new IntersectionObserver(e=>{for(let o of e)if(o.isIntersecting){t.disconnect(),s();break}});for(let e of n.children)t.observe(e)};(self.Astro||(self.Astro={})).visible=r;window.dispatchEvent(new Event("astro:visible"));})();;(()=>{var d;{let p={0:t=>u(t),1:t=>l(t),2:t=>new RegExp(t),3:t=>new Date(t),4:t=>new Map(l(t)),5:t=>new Set(l(t)),6:t=>BigInt(t),7:t=>new URL(t),8:t=>new Uint8Array(t),9:t=>new Uint16Array(t),10:t=>new Uint32Array(t)},h=t=>{let[e,n]=t;return e in p?p[e](n):void 0},l=t=>t.map(h),u=t=>typeof t!="object"||t===null?t:Object.fromEntries(Object.entries(t).map(([e,n])=>[e,h(n)]));customElements.get("astro-island")||customElements.define("astro-island",(d=class extends HTMLElement{constructor(){super(...arguments);this.hydrate=async()=>{var i;if(!this.hydrator||!this.isConnected)return;let e=(i=this.parentElement)==null?void 0:i.closest("astro-island[ssr]");if(e){e.addEventListener("astro:hydrate",this.hydrate,{once:!0});return}let n=this.querySelectorAll("astro-slot"),o={},a=this.querySelectorAll("template[data-astro-template]");for(let r of a){let s=r.closest(this.tagName);s!=null&&s.isSameNode(this)&&(o[r.getAttribute("data-astro-template")||"default"]=r.innerHTML,r.remove())}for(let r of n){let s=r.closest(this.tagName);s!=null&&s.isSameNode(this)&&(o[r.getAttribute("name")||"default"]=r.innerHTML)}let c;try{c=this.hasAttribute("props")?u(JSON.parse(this.getAttribute("props"))):{}}catch(r){let s=this.getAttribute("component-url")||"<unknown>",y=this.getAttribute("component-export");throw y&&(s+=` (export ${y})`),console.error(`[hydrate] Error parsing props for component ${s}`,this.getAttribute("props"),r),r}await this.hydrator(this)(this.Component,c,o,{client:this.getAttribute("client")}),this.removeAttribute("ssr"),this.dispatchEvent(new CustomEvent("astro:hydrate"))}}connectedCallback(){!this.hasAttribute("await-children")||this.firstChild?this.childrenConnectedCallback():new MutationObserver((e,n)=>{n.disconnect(),setTimeout(()=>this.childrenConnectedCallback(),0)}).observe(this,{childList:!0})}async childrenConnectedCallback(){let e=this.getAttribute("before-hydration-url");e&&await import(e),this.start()}start(){let e=JSON.parse(this.getAttribute("opts")),n=this.getAttribute("client");if(Astro[n]===void 0){window.addEventListener(`astro:${n}`,()=>this.start(),{once:!0});return}Astro[n](async()=>{let o=this.getAttribute("renderer-url"),[a,{default:c}]=await Promise.all([import(this.getAttribute("component-url")),o?import(o):()=>()=>{}]),i=this.getAttribute("component-export")||"default";if(!i.includes("."))this.Component=a[i];else{this.Component=a;for(let r of i.split("."))this.Component=this.Component[r]}return this.hydrator=c,this.hydrate},e,this)}attributeChangedCallback(){this.hydrate()}},d.observedAttributes=["props"],d))}})();</script><astro-island uid="2iKzVC" component-url="/_astro/SearchBtn.984510f3.js" component-export="default" renderer-url="/_astro/client.cb726945.js" props="{&quot;class&quot;:[0,&quot;astro-3EF6KSR2&quot;]}" ssr="" client="visible" opts="{&quot;name&quot;:&quot;SearchBtn&quot;,&quot;value&quot;:true}" await-children=""><button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"> <path fill-rule="evenodd" clip-rule="evenodd" d="M16.2071 4.89344C19.0923 7.77862 19.3131 12.3193 16.8693 15.4578C16.8846 15.4713 16.8996 15.4854 16.9143 15.5L21.1569 19.7427C21.5474 20.1332 21.5474 20.7664 21.1569 21.1569C20.7664 21.5474 20.1332 21.5474 19.7427 21.1569L15.5 16.9143C15.4854 16.8996 15.4713 16.8846 15.4578 16.8693C12.3193 19.3131 7.77862 19.0923 4.89344 16.2071C1.76924 13.083 1.76924 8.01763 4.89344 4.89344C8.01763 1.76924 13.083 1.76924 16.2071 4.89344ZM14.7929 14.7929C17.1361 12.4498 17.1361 8.6508 14.7929 6.30765C12.4498 3.96451 8.6508 3.96451 6.30765 6.30765C3.96451 8.6508 3.96451 12.4498 6.30765 14.7929C8.6508 17.1361 12.4498 17.1361 14.7929 14.7929Z" fill="currentColor"></path></svg></button></astro-island>
                    </li>
                    <li class="astro-3EF6KSR2">
                        <a href="https://github.com/one-aalam/astro-ink" title="三次元日誌(astro)'s Github URL'" class="astro-3EF6KSR2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    
                                <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22" class="astro-3EF6KSR2"></path>
                            
</svg>
                        </a>
                    </li>
                    <li class="astro-3EF6KSR2">
                        <a href="/rss.xml" title="RSS" class="astro-3EF6KSR2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    
                                <path d="M4 11a9 9 0 0 1 9 9" class="astro-3EF6KSR2"></path>
                                <path d="M4 4a16 16 0 0 1 16 16" class="astro-3EF6KSR2"></path>
                                <circle cx="5" cy="19" r="1" class="astro-3EF6KSR2"></circle>
                            
</svg>
                        </a>
                    </li>
                    <li class="astro-3EF6KSR2">
                        <astro-island uid="h8S6z" component-url="/_astro/ModeSwitcherBtn.0ddc5d6d.js" component-export="default" renderer-url="/_astro/client.cb726945.js" props="{&quot;class&quot;:[0,&quot;astro-3EF6KSR2&quot;]}" ssr="" client="visible" opts="{&quot;name&quot;:&quot;ModeSwitcherBtn&quot;,&quot;value&quot;:true}" await-children=""><button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle> <line x1="12" y1="1" x2="12" y2="3"></line> <line x1="12" y1="21" x2="12" y2="23"></line> <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line> <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line> <line x1="1" y1="12" x2="3" y2="12"></line> <line x1="21" y1="12" x2="23" y2="12"></line> <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line> <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg></button></astro-island>
                    </li>
                </ul>
            </nav>
        </div>
    </div>
</header>
		<main class="astro-BVZIHDZO">
			<article class="astro-BVZIHDZO">
				<div class="hero-image astro-BVZIHDZO">
					
				</div>
				<div class="prose astro-BVZIHDZO">
					<div class="title astro-BVZIHDZO">
						<div class="date astro-BVZIHDZO">
							<time datetime="2013-06-17T00:00:00.000Z">
	Jun 17, 2013
</time>
							
						</div>
						<h1 class="astro-BVZIHDZO">IrrlichtにMsgPackRPCを仕込む</h1>
						<hr class="astro-BVZIHDZO">
					</div>
					
	<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #e1e4e8">IrrlichtにMsgPackRPCを仕込む</span></span>
<span class="line"><span style="color: #e1e4e8">Oculusの通販ステータスが早くもProcessingに変わって届くのが楽しみな今日この頃。</span></span>
<span class="line"><span style="color: #e1e4e8">レンダリングエンジンにはIrrlichtを選択したのであるが、</span></span>
<span class="line"><span style="color: #e1e4e8">そのままだとシーンを構築するとか諸々の作業がC++直叩きになる。</span></span>
<span class="line"><span style="color: #e1e4e8">これだとさすがに大変なのでMsgPackRPCでラップして外部のツールから</span></span>
<span class="line"><span style="color: #e1e4e8">操作しようと構想しておったのだが始めてみると早速問題に突き当たった。</span></span>
<span class="line"><span style="color: #e1e4e8">オブジェクトを生成してそのメソッドをコールするのにどうすればいいのか。</span></span>
<span class="line"><span style="color: #e1e4e8">こういう場合だ。</span></span>
<span class="line"><span style="color: #e1e4e8">IMesh *mesh=CreateMesh("miku.pmd");</span></span>
<span class="line"><span style="color: #e1e4e8">mesh->SetPosition(0, 0, 5);</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">MsgPackRPC経由だと以下のような感じか。</span></span>
<span class="line"><span style="color: #e1e4e8"># pythonとかそういうの</span></span>
<span class="line"><span style="color: #e1e4e8">client=msgpac.rpc.client()</span></span>
<span class="line"><span style="color: #e1e4e8">mesh=client.call("CreateMesh", "miku.pmd")</span></span>
<span class="line"><span style="color: #e1e4e8">client.call("Mesh_SetPosition", mesh, 0, 0, 5)</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">1つめのCreateMeshはグローバル関数かシングルトン的オブジェクトのメソッド呼び出しになるので特に問題は無い。</span></span>
<span class="line"><span style="color: #e1e4e8">2つめはSetPositionのthisとしてmeshを送ってやる必要がある。</span></span>
<span class="line"><span style="color: #e1e4e8">ここでmsgpack的にはIMesh*をシリアライズ/デシリアライズすることが必要になる。</span></span>
<span class="line"><span style="color: #e1e4e8">案１ ポインタを整数値としてキャストすればいいじゃない</span></span>
<span class="line"><span style="color: #e1e4e8">template &#x3C;typename Stream></span></span>
<span class="line"><span style="color: #e1e4e8">inline packer&#x3C;Stream>&#x26; operator&#x3C;&#x3C; (packer&#x3C;Stream>&#x26; o, IMesh *v)</span></span>
<span class="line"><span style="color: #e1e4e8">{</span></span>
<span class="line"><span style="color: #e1e4e8">    // ポインタをintにキャスト</span></span>
<span class="line"><span style="color: #e1e4e8">    o.pack((int)v);</span></span>
<span class="line"><span style="color: #e1e4e8">    return o;</span></span>
<span class="line"><span style="color: #e1e4e8">}</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">inline IMesh *v operator>> (object o, IMesh* v)</span></span>
<span class="line"><span style="color: #e1e4e8">{</span></span>
<span class="line"><span style="color: #e1e4e8">    unsigned int p;</span></span>
<span class="line"><span style="color: #e1e4e8">    o.convert(&#x26;p):</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">    // intをポインタにキャスト</span></span>
<span class="line"><span style="color: #e1e4e8">    v=(IMesh*)p;</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">    return v;</span></span>
<span class="line"><span style="color: #e1e4e8">}</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">さすがにワイルドすぎる。というかポインタが既に開放されている場合になすすべが無いので没</span></span>
<span class="line"><span style="color: #e1e4e8">案２ 適当にユニークなIDを振る</span></span>
<span class="line"><span style="color: #e1e4e8">template &#x3C;typename Stream></span></span>
<span class="line"><span style="color: #e1e4e8">inline packer&#x3C;Stream>&#x26; operator&#x3C;&#x3C; (packer&#x3C;Stream>&#x26; o, IMesh *v)</span></span>
<span class="line"><span style="color: #e1e4e8">{</span></span>
<span class="line"><span style="color: #e1e4e8">    // ポインタのuid値</span></span>
<span class="line"><span style="color: #e1e4e8">    o.pack(v->uid());</span></span>
<span class="line"><span style="color: #e1e4e8">    return o;</span></span>
<span class="line"><span style="color: #e1e4e8">}</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">inline IMesh *v operator>> (object o, IMesh* v)</span></span>
<span class="line"><span style="color: #e1e4e8">{</span></span>
<span class="line"><span style="color: #e1e4e8">    unsigned int uid;</span></span>
<span class="line"><span style="color: #e1e4e8">    o.convert(&#x26;uid):</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">    // uid値からポインタを得る</span></span>
<span class="line"><span style="color: #e1e4e8">    v=IMesh::get_from_uid(uid);</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">    return v;</span></span>
<span class="line"><span style="color: #e1e4e8">}</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">Irrlichtだと本体側に改造が要るけどこれでいってみるか。</span></span>
<span class="line"><span style="color: #e1e4e8">template&#x3C;typename T></span></span>
<span class="line"><span style="color: #e1e4e8">class IDGenerator</span></span>
<span class="line"><span style="color: #e1e4e8">{</span></span>
<span class="line"><span style="color: #e1e4e8">    unsigned int m_uid;</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">public:</span></span>
<span class="line"><span style="color: #e1e4e8">    IDGenerator():m_uid(generate_uid())</span></span>
<span class="line"><span style="color: #e1e4e8">    {</span></span>
<span class="line"><span style="color: #e1e4e8">        m_uid_map.insert(std::make_pair(m_uid, this));</span></span>
<span class="line"><span style="color: #e1e4e8">    }</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">    unsigned int uid()const</span></span>
<span class="line"><span style="color: #e1e4e8">    {</span></span>
<span class="line"><span style="color: #e1e4e8">        return m_uid;</span></span>
<span class="line"><span style="color: #e1e4e8">    }</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">////////////////////</span></span>
<span class="line"><span style="color: #e1e4e8">// static</span></span>
<span class="line"><span style="color: #e1e4e8">////////////////////</span></span>
<span class="line"><span style="color: #e1e4e8">private:</span></span>
<span class="line"><span style="color: #e1e4e8">    static unsigned int m_next_uid=1;</span></span>
<span class="line"><span style="color: #e1e4e8">    static std::hash_map&#x3C;unsigned int, T*> m_uid_map;</span></span>
<span class="line"><span style="color: #e1e4e8">public:</span></span>
<span class="line"><span style="color: #e1e4e8">    static unsigned int generate_uid(){</span></span>
<span class="line"><span style="color: #e1e4e8">        return m_next_uid++;</span></span>
<span class="line"><span style="color: #e1e4e8">    }</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">    statc T* get_from_uid(unsigned int uid){</span></span>
<span class="line"><span style="color: #e1e4e8">        auto found=m_uid_map.find(uid);</span></span>
<span class="line"><span style="color: #e1e4e8">        if(found==m_uid_map.end()){</span></span>
<span class="line"><span style="color: #e1e4e8">            return 0;</span></span>
<span class="line"><span style="color: #e1e4e8">        }</span></span>
<span class="line"><span style="color: #e1e4e8">        return found->second;</span></span>
<span class="line"><span style="color: #e1e4e8">    }</span></span>
<span class="line"><span style="color: #e1e4e8">};</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">// 継承階層のIReferenceCountedの下あたりにこんな感じで介入する予定</span></span>
<span class="line"><span style="color: #e1e4e8">class IMesh : public virtual IReferenceCounted, public IDGenerator&#x3C;IMesh></span></span>
<span class="line"><span style="color: #e1e4e8">{</span></span>
<span class="line"><span style="color: #e1e4e8">};</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">うまくいくかやってみるとしよう。</span></span>
<span class="line"><span style="color: #e1e4e8">書いてみた</span></span>
<span class="line"><span style="color: #e1e4e8">自由に書いてみたらこうなった。templateクラスのスタティックメンバ変数の書き方を学んだ。</span></span>
<span class="line"><span style="color: #e1e4e8">http://d.hatena.ne.jp/higepon/20100803/1280834422</span></span>
<span class="line"><span style="color: #e1e4e8">template&#x3C;typename T></span></span>
<span class="line"><span style="color: #e1e4e8">class IDGenerator</span></span>
<span class="line"><span style="color: #e1e4e8">{</span></span>
<span class="line"><span style="color: #e1e4e8">    struct Deleter{</span></span>
<span class="line"><span style="color: #e1e4e8">        unsigned int m_uid;</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">        Deleter(unsigned int uid): m_uid(uid){}</span></span>
<span class="line"><span style="color: #e1e4e8">        ~Deleter(){ remove_from_map(m_uid); }</span></span>
<span class="line"><span style="color: #e1e4e8">    };</span></span>
<span class="line"><span style="color: #e1e4e8">    Deleter m_deleter;</span></span>
<span class="line"><span style="color: #e1e4e8">    unsigned int m_uid;</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">public:</span></span>
<span class="line"><span style="color: #e1e4e8">    IDGenerator():m_uid(generate_uid()), m_deleter(m_uid)</span></span>
<span class="line"><span style="color: #e1e4e8">    {</span></span>
<span class="line"><span style="color: #e1e4e8">        s_uid_map[m_uid]=this;</span></span>
<span class="line"><span style="color: #e1e4e8">    }</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">    unsigned int uid()const</span></span>
<span class="line"><span style="color: #e1e4e8">    {</span></span>
<span class="line"><span style="color: #e1e4e8">        return m_uid;</span></span>
<span class="line"><span style="color: #e1e4e8">    }</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">    ////////////////////</span></span>
<span class="line"><span style="color: #e1e4e8">    // static</span></span>
<span class="line"><span style="color: #e1e4e8">    ////////////////////</span></span>
<span class="line"><span style="color: #e1e4e8">private:</span></span>
<span class="line"><span style="color: #e1e4e8">    static core::map&#x3C;unsigned int, IDGenerator*> s_uid_map;</span></span>
<span class="line"><span style="color: #e1e4e8">public:</span></span>
<span class="line"><span style="color: #e1e4e8">    static unsigned int generate_uid(){</span></span>
<span class="line"><span style="color: #e1e4e8">        static unsigned int next_uid=1;</span></span>
<span class="line"><span style="color: #e1e4e8">        return next_uid++;</span></span>
<span class="line"><span style="color: #e1e4e8">    }</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">    static T* get_from_uid(unsigned int uid){</span></span>
<span class="line"><span style="color: #e1e4e8">        return s_uid_map.find(uid);</span></span>
<span class="line"><span style="color: #e1e4e8">    }</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">    static void remove_from_map(unsigned int uid){</span></span>
<span class="line"><span style="color: #e1e4e8">        s_uid_map.remove(uid);</span></span>
<span class="line"><span style="color: #e1e4e8">    }</span></span>
<span class="line"><span style="color: #e1e4e8">};</span></span>
<span class="line"><span style="color: #e1e4e8">template &#x3C;typename T> core::map&#x3C;unsigned int, IDGenerator&#x3C;T>*> IDGenerator&#x3C;T>::s_uid_map;</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">しかし、この設計だとstaticメンバがdll境界を越えて２つ存在してうまくいかない罠があった。没</span></span>
<span class="line"><span style="color: #e1e4e8">案3 適当にユニークなIDを振る(非テンプレート)</span></span>
<span class="line"><span style="color: #e1e4e8">irr::IReferenceCountedを改造する。</span></span>
<span class="line"><span style="color: #e1e4e8">小賢しいtemplateをやめてべたにグローバル変数を隠蔽する方式を導入した。</span></span>
<span class="line"><span style="color: #e1e4e8">class IReferenceCounted</span></span>
<span class="line"><span style="color: #e1e4e8">{</span></span>
<span class="line"><span style="color: #e1e4e8">public:</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">    //! Constructor.</span></span>
<span class="line"><span style="color: #e1e4e8">    IReferenceCounted()</span></span>
<span class="line"><span style="color: #e1e4e8">        : DebugName(0), ReferenceCounter(1), UID(get_uid())</span></span>
<span class="line"><span style="color: #e1e4e8">    {</span></span>
<span class="line"><span style="color: #e1e4e8">        register_uid(UID, this);</span></span>
<span class="line"><span style="color: #e1e4e8">    }</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">    u32 uid(){ return UID; }</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">    //! Destructor.</span></span>
<span class="line"><span style="color: #e1e4e8">    virtual ~IReferenceCounted()</span></span>
<span class="line"><span style="color: #e1e4e8">    {</span></span>
<span class="line"><span style="color: #e1e4e8">        unregister_uid(UID);</span></span>
<span class="line"><span style="color: #e1e4e8">    }</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">// 省略</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">};</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">#include "IDGenerator.h"</span></span>
<span class="line"><span style="color: #e1e4e8">#include "IReferenceCounted.h"</span></span>
<span class="line"><span style="color: #e1e4e8">#include "irrMap.h"</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">namespace irr {</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">    extern "C" IRRLICHT_API u32 get_uid()</span></span>
<span class="line"><span style="color: #e1e4e8">    {</span></span>
<span class="line"><span style="color: #e1e4e8">        static u32 uid=1;</span></span>
<span class="line"><span style="color: #e1e4e8">        return uid++;</span></span>
<span class="line"><span style="color: #e1e4e8">    }</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">    static core::map&#x3C;u32, IReferenceCounted*> g_map;</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">    extern "C" IRRLICHT_API void register_uid(u32 uid, IReferenceCounted *p)</span></span>
<span class="line"><span style="color: #e1e4e8">    {</span></span>
<span class="line"><span style="color: #e1e4e8">        g_map.set(uid, p);</span></span>
<span class="line"><span style="color: #e1e4e8">    }</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">    extern "C" IRRLICHT_API void unregister_uid(u32 uid)</span></span>
<span class="line"><span style="color: #e1e4e8">    {</span></span>
<span class="line"><span style="color: #e1e4e8">        auto found=g_map.remove(uid);</span></span>
<span class="line"><span style="color: #e1e4e8">    }</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">    extern "C" IRRLICHT_API IReferenceCounted* get_from_uid(u32 uid)</span></span>
<span class="line"><span style="color: #e1e4e8">    {</span></span>
<span class="line"><span style="color: #e1e4e8">        auto found=g_map.find(uid);</span></span>
<span class="line"><span style="color: #e1e4e8">        if(!found){</span></span>
<span class="line"><span style="color: #e1e4e8">            return 0;</span></span>
<span class="line"><span style="color: #e1e4e8">        }</span></span>
<span class="line"><span style="color: #e1e4e8">        return found->getValue();</span></span>
<span class="line"><span style="color: #e1e4e8">    }</span></span>
<span class="line"><span style="color: #e1e4e8">}</span></span>
<span class="line"><span style="color: #e1e4e8"></span></span>
<span class="line"><span style="color: #e1e4e8">動作確認できた。</span></span>
<span class="line"><span style="color: #e1e4e8">ここまでの作業でMsgPackRPCを使ったIrrlichtエクスポートについて見通しを得ることができた。</span></span>
<span class="line"><span style="color: #e1e4e8">PythonやLuaから使えるようにするのと同じような作業でリモートから関数をコールできるようになるのでいい感じだ。</span></span>
<span class="line"><span style="color: #e1e4e8">呼び出し側にPythonのMsgPackRPCを使えば違う言語からでも呼び出せるので一石二鳥というもの。</span></span>
<span class="line"><span style="color: #e1e4e8">ということで引き続き作業を進める。</span></span>
<span class="line"><span style="color: #e1e4e8">MsgPackRPCのリモート呼び出しを利用したシーンエディタを作りながら表示できるものを増やしていく。</span></span></code></pre>

				</div>
			</article>
		</main>
		<footer class="footer astro-SZ7XMLTE">
    <nav class="nav astro-SZ7XMLTE">
        <div class="astro-SZ7XMLTE">2021  &copy; Copyright notice |  <a href="https://github.com/one-aalam/astro-ink" title="三次元日誌(astro)'s Github URL'" class="astro-SZ7XMLTE">三次元日誌(astro)</a>
        <script>(()=>{var e=async t=>{await(await t())()};(self.Astro||(self.Astro={})).load=e;window.dispatchEvent(new Event("astro:load"));})();</script><astro-island uid="1QEdto" component-url="/_astro/ModeLabel.e3ff75e7.js" component-export="default" renderer-url="/_astro/client.cb726945.js" props="{&quot;class&quot;:[0,&quot;astro-SZ7XMLTE&quot;]}" ssr="" client="load" opts="{&quot;name&quot;:&quot;ModeLabel&quot;,&quot;value&quot;:true}" await-children=""><span slot="dark" data-svelte-h="svelte-14ov3lc">(dark)</span></astro-island> theme on <a href="https://astro.build/" class="astro-SZ7XMLTE">Astro</a></div>
        <astro-island uid="1I86to" component-url="/_astro/NetlifyIdentity.94b8edb0.js" component-export="default" renderer-url="/_astro/client.cb726945.js" props="{&quot;class&quot;:[0,&quot;astro-SZ7XMLTE&quot;]}" ssr="" client="load" opts="{&quot;name&quot;:&quot;NetlifyIdentity&quot;,&quot;value&quot;:true}"></astro-island>
    </nav>
</footer>
	</body></html>