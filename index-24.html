<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article# " lang="ja">
<head>
<meta charset="utf-8">
<meta name="description" content="作業記録">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>三次元日誌 (過去の記事 24ページ目) | 三次元日誌</title>
<link href="assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<link href="https://fonts.googleapis.com/css?family=Playfair+Display:700,900" rel="stylesheet">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" hreflang="ja" href="rss.xml">
<link rel="canonical" href="https://ousttrue.github.io/index-24.html">
<link rel="prev" href="index-25.html" type="text/html">
<link rel="next" href="index-23.html" type="text/html">
<!--[if lt IE 9]><script src="assets/js/html5.js"></script><![endif]-->
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">本文を読み飛ばす</a>

<!-- Header and menu bar -->
<div class="container">
      <header class="blog-header py-3"><div class="row nbb-header align-items-center">
          <div class="col-md-3 col-xs-2 col-sm-2" style="width: auto;">
            <button class="navbar-toggler navbar-light bg-light nbb-navbar-toggler" type="button" data-toggle="collapse" data-target=".bs-nav-collapsible" aria-controls="bs-navbar" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse bs-nav-collapsible bootblog4-search-form-holder">
                
            </div>
        </div>
          <div class="col-md-6 col-xs-10 col-sm-10 bootblog4-brand" style="width: auto;">
            <a class="navbar-brand blog-header-logo text-dark" href=".">

            <span id="blog-title">三次元日誌</span>
        </a>
          </div>
            <div class="col-md-3 justify-content-end align-items-center bs-nav-collapsible collapse flex-collapse bootblog4-right-nav">
            <nav class="navbar navbar-light bg-white"><ul class="navbar-nav bootblog4-right-nav"></ul></nav>
</div>
    </div>
</header><nav class="navbar navbar-expand-md navbar-light bg-white static-top"><div class="collapse navbar-collapse bs-nav-collapsible" id="bs-navbar">
            <ul class="navbar-nav nav-fill d-flex w-100">
<li class="nav-item">
<a href="books" class="nav-link">MemoBooks</a>
                </li>
<li class="nav-item">
<a href="archive.html" class="nav-link">Archives</a>
                </li>
<li class="nav-item">
<a href="categories/index.html" class="nav-link">Tags</a>
                </li>
<li class="nav-item">
<a href="rss.xml" class="nav-link">RSS feed</a>
                </li>
<li class="nav-item">
<a href="about" class="nav-link">About</a>

                
            </li>
</ul>
</div>
<!-- /.navbar-collapse -->
</nav>
</div>

<div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        
        
        
    
        

    
        
    <div class="postindex">
            <article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/2017/08/mediasink_use_dxva/" class="u-url">MediaSinkでDXVA</a></h1>
                <div class="metadata">
                    <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                        ousttrue
                    </span></p>
            <p class="dateline">
            <a href="posts/2017/08/mediasink_use_dxva/" rel="bookmark">
            <time class="published dt-published" datetime="2017-08-28T00:00:00+09:00" itemprop="datePublished" title="2017-08-28 00:00">2017-08-28 00:00</time></a>
            </p>
                </div>
            </header><div class="e-content entry-content">
                    <div>
<p>MediaSinkでDXVAを使うには。</p>
<p>https://github.com/Microsoft/Windows-classic-samples/tree/master/Samples/DX11VideoRenderer</p>
<p>解読の後半。
DXVAが何かということについてはぼんやりとしているのだけれど、VideoSampleのバッファーにD3Dのテクスチャを使うということぽい。</p>
<p>DirectX Surface Buffer</p>
<p>ということはPipelineのどこかのタイミングでCPU上のbitmapをCreateTextureしてGPUに移動するのだけど、DecoderなりRendererなりのなるべく上流でGPUに上げた方がうれしいという話。
ID3D11DeviceをMediaSessionに供給する
Pipelineでテクスチャをやりとりするのだからデバイスを共有しましょうと。MediaSessionの場合は、レンダラがデバイスを作成してIMFDXGIDeviceManagerを公開する。
公開するのはIMFGetServiceを通してぽい。
この辺。
HRESULT DX11VideoRenderer::CMediaSink::GetService(__RPC__in REFGUID guidService, __RPC__in REFIID riid, __RPC__deref_out_opt LPVOID* ppvObject)
{
    HRESULT hr = S_OK;</p>
<pre class="code literal-block"><span></span>if (guidService == MF_RATE_CONTROL_SERVICE)
{
    hr = QueryInterface(riid, ppvObject);
}
else if (guidService == MR_VIDEO_RENDER_SERVICE)
{
    hr = m_pPresenter-&gt;QueryInterface(riid, ppvObject);
}
else if (guidService == MR_VIDEO_ACCELERATION_SERVICE)
{
    // ここからIMFDXGIDeviceManagerを得る
    hr = m_pPresenter-&gt;GetService(guidService, riid, ppvObject);
}
else
{
    hr = MF_E_UNSUPPORTED_SERVICE;
}

return hr;
</pre>

<p>}</p>
<p>実験
まだIMFGetServiceを実装していないVideoRendererで、
ProcessSampleに入ってくるIMFSampleからIMFDXGIBufferが取得できるか試してみよう。
DWORD cBuffers = 0;
auto hr = pSample-&gt;GetBufferCount(&amp;cBuffers);
if (FAILED(hr))
{
    return hr;
}</p>
<p>Microsoft::WRL::ComPtr<imfmediabuffer> pBuffer;
if (1 == cBuffers)
{
    hr = pSample-&gt;GetBufferByIndex(0, &amp;pBuffer);
}
else
{
    hr = pSample-&gt;ConvertToContiguousBuffer(&amp;pBuffer);
}
if (FAILED(hr))
{
    return hr;
}</imfmediabuffer></p>
<p>Microsoft::WRL::ComPtr<imfdxgibuffer> pDXGIBuffer;
hr = pBuffer.As(&amp;pDXGIBuffer);
if (FAILED(hr))
{
    // ここに来た
    return hr;
}</imfdxgibuffer></p>
<p>Microsoft::WRL::ComPtr<id3d11texture2d> pTexture2D;
hr = pDXGIBuffer-&gt;GetResource(IID_PPV_ARGS(&amp;pTexture2D));
if (FAILED(hr))
{
    return hr;
}</id3d11texture2d></p>
<p>実験２
StreamSinkにIMFGetServiceを実装した。
// IMFGetService
STDMETHODIMP GetService(__RPC__in REFGUID guidService, __RPC__in REFIID riid, __RPC__deref_out_opt LPVOID* ppvObject)override
{
    HRESULT hr = S_OK;</p>
<pre class="code literal-block"><span></span>if (guidService == MR_VIDEO_ACCELERATION_SERVICE)
{
    if (riid == __uuidof(IMFDXGIDeviceManager))
    {
        if (NULL != m_pDXGIManager)
        {
            *ppvObject = (void*) static_cast&lt;IUnknown*&gt;(m_pDXGIManager);
            ((IUnknown*)*ppvObject)-&gt;AddRef();
        }
        else
        {
            hr = E_NOINTERFACE;
        }
    }
    else
    {
        hr = E_NOINTERFACE;
    }
}
else
{
    hr = MF_E_UNSUPPORTED_SERVICE;
}

return hr;
</pre>

<p>}</p>
<p>IMFSampleからID3D11Texture2Dを取得できた。
上流が、DXVA化されてSampleのバッファがテクスチャになった。
どんなテクスチャなのか
ArraySize = 13
Format = DXGI_FORMAT_NV12</p>
<p>中身がよくわからぬ。
DecodeされたyuvフレームをSwapchainにコピーする</p>
<p>deinterlace
YUV To RGB
サイズ調整</p>
<p>等をしてデコード済みのフレームをRGB画像にする工程。
２種類の実装がある。</p>
<p>https://github.com/Microsoft/Windows-classic-samples/blob/master/Samples/DX11VideoRenderer/cpp/Presenter.cpp</p>
<p>の以下の部分。
if (m_useXVP)
{
    BOOL bInputFrameUsed = FALSE;</p>
<pre class="code literal-block"><span></span>hr = ProcessFrameUsingXVP( pCurrentType, pSample, pTexture2D, rcDest, ppOutputSample, &amp;bInputFrameUsed );

if (SUCCEEDED(hr) &amp;&amp; !bInputFrameUsed)
{
    *pbProcessAgain = TRUE;
}
</pre>

<p>}
else
{
    hr = ProcessFrameUsingD3D11( pTexture2D, pEVTexture2D, dwViewIndex, dwEVViewIndex, rcDest, *punInterlaceMode, ppOutputSample );</p>
<pre class="code literal-block"><span></span>// 省略
</pre>

<p>}</p>
<p>どちらでもだいたい同じ動きになると思う。
ProcessFrameUsingXVP</p>
<p>Video Processor MFT</p>
<p>初期化時にIDXGIDeviceManagerを直接渡してDXVAを有効にしている。
hr = CoCreateInstance(CLSID_VideoProcessorMFT, nullptr, CLSCTX_INPROC_SERVER, IID_IMFTransform, (void**)&amp;m_pXVP);
if (FAILED(hr))
{
    break;
}</p>
<p>// MFTにDirectXを渡す
hr = m_pXVP-&gt;ProcessMessage(MFT_MESSAGE_SET_D3D_MANAGER, ULONG_PTR(m_pDXGIManager));
if (FAILED(hr))
{
    break;
}</p>
<p>Textureの入ったサンプルを処理して、Textureの入ったサンプルに出力できる。
ProcessFrameUsingD3D11
D3D11VideoDeviceを使う。
こっちの方が手順が長くて大変。
おそらく、VideoProcessorMFTはD3D11VideoDeviceを使って実装していてこちらの方がローレベルなのであろう。
Decode
APIの説明としてはこれ。</p>
<p>Supporting Direct3D 11 Video Decoding in Media Foundation</p>
<p>DX11VideoRendererサンプルでは、直接使っていない。
Video Processing
DX11VideoRendererサンプルでは、D3D11VideoDeviceを最後の色変換等で使っている。</p>
<p>DXVA Video Processing</p>
<p>Video Process Blit</p>
<p>DXVA2.0+D3D9のドキュメントぽい。
D3D11ではこの関数。</p>
<p>D3D11VideoContext::VideoProcessorBlt</p>
</div>
                </div>
            </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/2017/08/create_mediasink/" class="u-url">MediaSinkを実装する</a></h1>
                <div class="metadata">
                    <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                        ousttrue
                    </span></p>
            <p class="dateline">
            <a href="posts/2017/08/create_mediasink/" rel="bookmark">
            <time class="published dt-published" datetime="2017-08-27T00:00:00+09:00" itemprop="datePublished" title="2017-08-27 00:00">2017-08-27 00:00</time></a>
            </p>
                </div>
            </header><div class="e-content entry-content">
                    <div>
<p>DX11VideoRendererを解読して、VideoRenderer要件を探る。</p>
<p>Microsoftのサンプルがあり参考になる。</p>
<p>https://github.com/Microsoft/Windows-classic-samples/tree/master/Samples/DX11VideoRenderer</p>
<p>これは結構がっつり作ってあるので、削って最低限必要な要素を探る。
IMFMediaSinkを作る
手抜きしてIMFActivate抜きで。
https://github.com/Microsoft/Windows-classic-samples/blob/master/Samples/DX11VideoRenderer/c++/DX11VideoRenderer.h
を参考に最低限を実装してみる。
guidgen.exeでguidを決めた。
CustomVideoRenderer.h</p>
<h2>pragma once</h2>
<h2>include <windows.h></windows.h>
</h2>
<p>// {8C5C51AD-F400-4B2A-BD36-4990D07420B4}
DEFINE_GUID(CLSID_CustomVideoRenderer, 
0x8c5c51ad, 0xf400, 0x4b2a, 0xbd, 0x36, 0x49, 0x90, 0xd0, 0x74, 0x20, 0xb4);</p>
<p>STDAPI CreateCustomVideoRenderer(REFIID riid, void **ppvObject);</p>
<p>DX11VideoRendererから必要な部分をコピペしてくるだけである。
CustomVideoRenderer.c++</p>
<h2>include "CustomVideoRenderer.h"</h2>
<h2>include <mfidl.h></mfidl.h>
</h2>
<p>class CustomVideoRenderer: public IMFMediaSink
{
    ULONG m_nRefCount = 1;</p>
<p>public:
    // IUnknown
    STDMETHODIMP_(ULONG) AddRef(void)override
    {
        return InterlockedIncrement(&amp;m_nRefCount);
    }</p>
<pre class="code literal-block"><span></span>STDMETHODIMP QueryInterface(REFIID iid, __RPC__deref_out _Result_nullonfailure_ void** ppv)override
{
    if (!ppv)
    {
        return E_POINTER;
    }
    if (iid == IID_IUnknown)
    {
        *ppv = static_cast&lt;IUnknown*&gt;(static_cast&lt;IMFMediaSink*&gt;(this));
    }
    else if (iid == __uuidof(IMFMediaSink))
    {
        *ppv = static_cast&lt;IMFMediaSink*&gt;(this);
    }
    else
    {
        *ppv = NULL;
        return E_NOINTERFACE;
    }
    AddRef();
    return S_OK;
}

STDMETHODIMP_(ULONG) Release(void)override
{
    ULONG uCount = InterlockedDecrement(&amp;m_nRefCount);
    if (uCount == 0)
    {
        delete this;
    }
    // For thread safety, return a temporary variable.
    return uCount;
}

// IMFMediaSink methods
STDMETHODIMP AddStreamSink(DWORD dwStreamSinkIdentifier, __RPC__in_opt IMFMediaType* pMediaType, __RPC__deref_out_opt IMFStreamSink** ppStreamSink)override;
STDMETHODIMP GetCharacteristics(__RPC__out DWORD* pdwCharacteristics)override;
STDMETHODIMP GetPresentationClock(__RPC__deref_out_opt IMFPresentationClock** ppPresentationClock)override;
STDMETHODIMP GetStreamSinkById(DWORD dwIdentifier, __RPC__deref_out_opt IMFStreamSink** ppStreamSink)override;
STDMETHODIMP GetStreamSinkByIndex(DWORD dwIndex, __RPC__deref_out_opt IMFStreamSink** ppStreamSink)override;
STDMETHODIMP GetStreamSinkCount(__RPC__out DWORD* pcStreamSinkCount)override;
STDMETHODIMP RemoveStreamSink(DWORD dwStreamSinkIdentifier)override;
STDMETHODIMP SetPresentationClock(__RPC__in_opt IMFPresentationClock* pPresentationClock)override;
STDMETHODIMP Shutdown(void)override;
</pre>

<p>};</p>
<p>STDAPI CreateCustomVideoRenderer(REFIID riid, void **ppvObject)
{
    if(!ppvObject){
        return E_FAIL;
    }</p>
<pre class="code literal-block"><span></span>auto sink=new CustomVideoRenderer();
*ppvObject=sink;
return S_OK;
</pre>

<p>}</p>
<p>使う
IMFStreamSinkからIMFTopologyNodeを作る。</p>
<p>Creating Output Nodes</p>
<pre class="code literal-block"><span></span><span class="nt">Microsoft</span><span class="p">::</span><span class="nd">WRL</span><span class="p">::</span><span class="nd">ComPtr</span><span class="o">&lt;</span><span class="nt">IMFTopologyNode</span><span class="o">&gt;</span> <span class="nt">pOutputNode</span><span class="o">;</span>
<span class="nt">if</span><span class="o">(</span><span class="nt">FAILED</span><span class="o">(</span><span class="nt">hr</span> <span class="o">=</span> <span class="nt">MFCreateTopologyNode</span><span class="o">(</span><span class="nt">MF_TOPOLOGY_OUTPUT_NODE</span><span class="o">,</span> <span class="o">&amp;</span><span class="nt">pOutputNode</span><span class="o">)))</span>
<span class="p">{</span>
    <span class="err">return</span> <span class="err">hr</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">Microsoft</span><span class="p">::</span><span class="nd">WRL</span><span class="p">::</span><span class="nd">ComPtr</span><span class="o">&lt;</span><span class="nt">IMFMediaSink</span><span class="o">&gt;</span> <span class="nt">pSink</span><span class="o">;</span>
<span class="o">//</span> <span class="nt">自前のIMFMediaSinkを作る</span>
<span class="nt">if</span><span class="o">(</span><span class="nt">FAILED</span><span class="o">(</span><span class="nt">hr</span><span class="o">=</span><span class="nt">CreateCustomVideoRenderer</span><span class="o">(</span><span class="nt">IID_PPV_ARGS</span><span class="o">(&amp;</span><span class="nt">pSink</span><span class="o">))))</span><span class="p">{</span>
    <span class="err">return</span> <span class="err">hr</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">Microsoft</span><span class="p">::</span><span class="nd">WRL</span><span class="p">::</span><span class="nd">ComPtr</span><span class="o">&lt;</span><span class="nt">IMFStreamSink</span><span class="o">&gt;</span> <span class="nt">pSSink</span><span class="o">;</span>
<span class="nt">if</span><span class="o">(</span><span class="nt">FAILED</span><span class="o">(</span><span class="nt">hr</span><span class="o">=</span><span class="nt">pSink-</span><span class="o">&gt;</span><span class="nt">GetStreamSinkByIndex</span><span class="o">(</span><span class="nt">0</span><span class="o">,</span> <span class="o">&amp;</span><span class="nt">pSSink</span><span class="o">)))</span><span class="p">{</span>
    <span class="err">//</span> <span class="err">まだ作っていないのでここでエラーになる</span>
    <span class="err">return</span> <span class="err">hr</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">if</span> <span class="o">(</span><span class="nt">FAILED</span><span class="o">(</span><span class="nt">hr</span> <span class="o">=</span> <span class="nt">pOutputNode-</span><span class="o">&gt;</span><span class="nt">SetObject</span><span class="o">(</span><span class="nt">pSSink</span><span class="p">.</span><span class="nc">Get</span><span class="o">())))</span>
<span class="p">{</span>
    <span class="err">return</span> <span class="err">hr</span><span class="p">;</span>
<span class="p">}</span>
</pre>

<p>IMFStreamSinkがひとつは必要
作る。
class CustomVideoStreamSink: public IMFStreamSink
{
    ULONG m_nRefCount = 1;</p>
<pre class="code literal-block"><span></span><span class="nt">const</span> <span class="nt">DWORD</span>                 <span class="nt">STREAM_ID</span><span class="o">;</span>
<span class="nt">CCritSec</span><span class="o">&amp;</span>                   <span class="nt">m_critSec</span><span class="o">;</span>                      <span class="o">//</span> <span class="nt">critical</span> <span class="nt">section</span> <span class="nt">for</span> <span class="nt">thread</span> <span class="nt">safety</span>
<span class="nt">Microsoft</span><span class="p">::</span><span class="nd">WRL</span><span class="p">::</span><span class="nd">ComPtr</span><span class="o">&lt;</span><span class="nt">IMFMediaSink</span><span class="o">&gt;</span>               <span class="nt">m_pSink</span><span class="o">;</span>
</pre>

<p>public:
    CustomVideoStreamSink(DWORD dwStreamId, CCritSec&amp; critSec
            , IMFMediaSink *parent)
        : STREAM_ID(dwStreamId)
          , m_critSec(critSec)
          , m_pSink(parent)
    {
    }</p>
<pre class="code literal-block"><span></span>// IUnknown
STDMETHODIMP_(ULONG) AddRef(void)override;
STDMETHODIMP QueryInterface(REFIID iid, __RPC__deref_out _Result_nullonfailure_ void** ppv)override;
STDMETHODIMP_(ULONG) Release(void)override;

// IMFStreamSink
STDMETHODIMP Flush(void)override;
STDMETHODIMP GetIdentifier(__RPC__out DWORD* pdwIdentifier)override;
STDMETHODIMP GetMediaSink(__RPC__deref_out_opt IMFMediaSink** ppMediaSink)override;
STDMETHODIMP GetMediaTypeHandler(__RPC__deref_out_opt IMFMediaTypeHandler** ppHandler)override;
STDMETHODIMP PlaceMarker(MFSTREAMSINK_MARKER_TYPE eMarkerType, __RPC__in const PROPVARIANT* pvarMarkerValue, __RPC__in const PROPVARIANT* pvarContextValue)override;
STDMETHODIMP ProcessSample(__RPC__in_opt IMFSample* pSample)override;

// IMFMediaEventGenerator (from IMFStreamSink)
STDMETHODIMP BeginGetEvent(IMFAsyncCallback* pCallback,IUnknown* punkState)override;
STDMETHODIMP EndGetEvent(IMFAsyncResult* pResult, _Out_ IMFMediaEvent** ppEvent)override;
STDMETHODIMP GetEvent(DWORD dwFlags, __RPC__deref_out_opt IMFMediaEvent** ppEvent)override;
STDMETHODIMP QueueEvent(MediaEventType met, __RPC__in REFGUID guidExtendedType, HRESULT hrStatus, __RPC__in_opt const PROPVARIANT* pvValue)override;
</pre>

<p>};</p>
<p>メソッドの中身は
return E_FAIL;</p>
<p>でお茶を濁した。
IMFMediaSink::AddStreamSink実装
IMFMediaSink::GetStreamSinkById実装
IMFMediaSink::GetStreamSinkByIndex実装
IMFMediaSink::GetStreamSinkCount実装
IMFMediaSink::RemoveStreamSink実装
実行してみる。
// Handler for Media Session events.
void OnPlayerEvent(HWND hwnd, WPARAM pUnkPtr)
{
    HRESULT hr = g_pPlayer-&gt;HandleEvent(pUnkPtr);
    if (FAILED(hr))
    {
        // ここに来る
        NotifyError(hwnd, L"An error occurred.", hr);
    }
    UpdateUI(hwnd, g_pPlayer-&gt;GetState());
}</p>
<pre class="code literal-block"><span></span>// Get the event status. If the operation that triggered the event 
// did not succeed, the status is a failure code.
HRESULT hrStatus = S_OK;
hr = pEvent-&gt;GetStatus(&amp;hrStatus);

// Check if the async operation succeeded.
if (SUCCEEDED(hr) &amp;&amp; FAILED(hrStatus)) 
{
    // ここに来る
    hr=hrStatus;
}
</pre>

<p>デバッガで調べたらIMFStreamSink::GetMediaSinkの直後にエラーになることがわかった。
IMFStreamSink::GetMediaSink実装
たんたんとエラーを直していく。
IMFStreamSink::GetMediaTypeHandler実装
HRESULT DX11VideoRenderer::CStreamSink::GetMediaTypeHandler(__RPC__deref_out_opt IMFMediaTypeHandler** ppHandler)
{
    CAutoLock lock(&amp;m_critSec);</p>
<pre class="code literal-block"><span></span>if (ppHandler == NULL)
{
    return E_POINTER;
}

HRESULT hr = CheckShutdown();

// This stream object acts as its own type handler, so we QI ourselves.
if (SUCCEEDED(hr))
{
    hr = this-&gt;QueryInterface(IID_IMFMediaTypeHandler, (void**)ppHandler);
}

return hr;
</pre>

<p>}</p>
<p>IMFMediaTypeHandlerが必要。
StreamSinkにIMFMediaTypeHandlerを実装
このインタフェースはStreamSinkが処理できるMediaTypeを示すので必要。
サポートするフォーマットを決める。
// IMFMediaTypeHandler
STDMETHODIMP GetCurrentMediaType(<em>Outptr</em> IMFMediaType<strong> ppMediaType);
STDMETHODIMP GetMajorType(__RPC__out GUID* pguidMajorType);
STDMETHODIMP GetMediaTypeByIndex(DWORD dwIndex, <em>Outptr</em> IMFMediaType</strong> ppType);
STDMETHODIMP GetMediaTypeCount(__RPC__out DWORD<em> pdwTypeCount);
STDMETHODIMP IsMediaTypeSupported(IMFMediaType</em> pMediaType, <em>Outptr_opt_result_maybenull</em> IMFMediaType*<em> ppMediaType);
STDMETHODIMP SetCurrentMediaType(IMFMediaType</em> pMediaType);</p>
<p>PresentationClockが必要</p>
<p>Presentation Clock</p>
<p>IMFMediaSink::GetPresentationClock実装
IMFMediaSink::SetPresentationClock実装
MediaSinkにIMFClockStateSinkを実装
// IMFClockStateSink methods
STDMETHODIMP OnClockPause(MFTIME hnsSystemTime);
STDMETHODIMP OnClockRestart(MFTIME hnsSystemTime);
STDMETHODIMP OnClockSetRate(MFTIME hnsSystemTime, float flRate);
STDMETHODIMP OnClockStart(MFTIME hnsSystemTime, LONGLONG llClockStartOffset);
STDMETHODIMP OnClockStop(MFTIME hnsSystemTime);</p>
<p>Data Flow
ここまでの実装でIMFSession::Startの呼び出しに応じてIMFClockStateSink::OnClockStartが呼ばれるようになった。
Data Flow</p>
<p>Media sinks use a pull model</p>
<p>MesiaSink側からサンプルを取りに行かないといけない。</p>
<p>[1] The client sets the media types and the presentation clock. The media sink registers itself with the presentation clock to receive notifications about clock state changes.
[2][3][4] はPreroll。ミニマムを目指す今回は省略。
[5] The client calls IMFPresentationClock::Start to start the presentation clock.
[6] The presentation clock notifies the media sink that the clock is starting, by calling IMFClockStateSink::OnClockStart.
[7] To get more data, each stream sink sends MEStreamSinkRequestSample events. In response to each of these events, the client gets the next sample and calls ProcessSample. This step is repeated until the presentation ends.</p>
<p>State Changes
IMFClockStateSinkの実装について。</p>
<p>In addition, stream sinks must send the following events when they have completed the state transitions:</p>
<p>OnClockStart, OnClockRestart: MEStreamSinkStarted event
OnClockPause: MEStreamSinkPaused event
OnClockStop: MEStreamSinkStopped event</p>
<p>なるほど。
STDMETHODIMP OnClockStart(MFTIME hnsSystemTime, LONGLONG llClockStartOffset)override
{
    CAutoLock lock(&amp;m_csMediaSink);</p>
<pre class="code literal-block"><span></span>HRESULT hr = CheckShutdown();
if (SUCCEEDED(hr))
{
    //
    // これが必要。このあとMEStreamSinkRequestSampleを受け付ける
    //
    hr = m_pStream-&gt;QueueEvent(MEStreamSinkStarted, GUID_NULL, hr, NULL);
}
if (SUCCEEDED(hr))
{
    hr = m_pStream-&gt;QueueEvent(MEStreamSinkRequestSample, GUID_NULL, hr, NULL);
}

return hr;
</pre>

<p>}</p>
<p>ついにIMFStreamSink::ProcessSampleがコールされた。
試しに下記のような実装にしてみたがこれではClock無視で最速でフレームを消化してしまうのでだめ。
int m_count = 0;
STDMETHODIMP ProcessSample(__RPC__in_opt IMFSample* pSample)override
{
    ++m_count;</p>
<pre class="code literal-block"><span></span>auto hr = S_OK;
hr = QueueEvent(MEStreamSinkRequestSample, GUID_NULL, hr, NULL);

return hr;
</pre>

<p>}</p>
<p>MEStreamSinkRequestSampleをスケジューリングする</p>
<p>Scheduled Work Items</p>
<p>これを使ってみる。
BOOL NeedMoreSamples(void)
{
    const DWORD cSamplesInFlight = /<em>m_SamplesToProcess.GetCount() +</em>/ m_cOutstandingSampleRequests;</p>
<pre class="code literal-block"><span></span>return cSamplesInFlight &lt; SAMPLE_QUEUE_HIWATER_THRESHOLD;
</pre>

<p>}</p>
<p>HRESULT RequestSamples(IMFAsyncResult* pAsyncResult)
{
    HRESULT hr = S_OK;</p>
<pre class="code literal-block"><span></span>while (NeedMoreSamples())
{
    hr = CheckShutdown();
    if (FAILED(hr))
    {
        break;
    }

    m_cOutstandingSampleRequests++;

    hr = QueueEvent(MEStreamSinkRequestSample, GUID_NULL, S_OK, NULL);
}

// 再突入
hr=QueueRequest();

return hr;
</pre>

<p>}</p>
<p>// 正しいRateにする必要がある
const INT64 interval = 1000 / 30;</p>
<p>HRESULT QueueRequest()
{
    HRESULT hr = S_OK;</p>
<pre class="code literal-block"><span></span>if (SUCCEEDED(hr))
{
    // Enqueue
    MFWORKITEM_KEY cancelKey;
    hr = MFScheduleWorkItem(&amp;m_WorkQueueCB, nullptr, -interval, &amp;cancelKey);
}

return hr;
</pre>

<p>}</p>
<p>int m_count = 0;
STDMETHODIMP ProcessSample(__RPC__in_opt IMFSample* pSample)override
{
    ++m_count;</p>
<pre class="code literal-block"><span></span>m_cOutstandingSampleRequests--;

// do something

return  S_OK;
</pre>

<p>}</p>
<p>DX11VideoRenderer::CSchedulerを使えばよいと思う。
だいたい仕組みがわかった。
DX11VideoRendererから引き算して最小限の構成にする(ProcessSampleが何もしない)場合、
以下の部品を残す必要がありそう。</p>
<p>Scheduler
StreamSink: IMFStreamSink, IMFMediaTypeHandler
MesiaSink: IMFMediaSink, IMFClockStateSink</p>
</div>
                </div>
            </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="github/mediafoundationsample/" class="u-url">MediaFoundationSample</a></h1>
                <div class="metadata">
                    <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                        ousttrue
                    </span></p>
            <p class="dateline">
            <a href="github/mediafoundationsample/" rel="bookmark">
            <time class="published dt-published" datetime="2017-08-24T18:54:35Z" itemprop="datePublished" title="2017-08-24 18:54">2017-08-24 18:54</time><span class="updated"> (更新日時
                    <time class="dt-updated" datetime="2017-08-28T09:26:05Z" itemprop="dateUpdated" title="2017-08-28 09:26">2017-08-28 09:26</time>)</span>
            </a>
            </p>
                </div>
            </header><div class="e-content entry-content">
                    <p><a href="https://github.com/ousttrue/MediaFoundationSample">https://github.com/ousttrue/MediaFoundationSample</a></p>
                </div>
            </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/2017/08/media_foundation/" class="u-url">MeidaFoundation情報収集</a></h1>
                <div class="metadata">
                    <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                        ousttrue
                    </span></p>
            <p class="dateline">
            <a href="posts/2017/08/media_foundation/" rel="bookmark">
            <time class="published dt-published" datetime="2017-08-25T00:00:00+09:00" itemprop="datePublished" title="2017-08-25 00:00">2017-08-25 00:00</time></a>
            </p>
                </div>
            </header><div class="e-content entry-content">
                    <div>
<p>DirectShow後継の動画・音声フレームワーク。</p>
<p>sampleのありか</p>
<p>https://github.com/Microsoft/Windows-classic-samples/tree/master/Samples/Win7Samples/multimedia/mediafoundation</p>
<p>Win7Samplesに気付かず・・・
はじめの一歩
ここから始めるのがよい。</p>
<p>Audio/Video Playback</p>
<p>How to Play Media Files with Media Foundation</p>
<p>Media Session Playback Example。ソースあり</p>
<p>MediaSessionPlaybackExampleで動画を開くとこんな感じのTopologyになる。
動画(MediaSource)---&gt;video-&gt; EVR(MediaSink)
                 |
                 +-&gt;audio-&gt; SAR(MediaSink)</p>
<p>MediaSourceとMediaSinkを作ってつなぐのがMediaFoundationの基本概念。
CMakeでビルドできるように取りまとめた。</p>
<p>https://github.com/ousttrue/MediaFoundationSample/tree/master/MediaSessionPlaybackExample</p>
<p>構成
DirectShowとは違う感じのところがある。</p>
<p>IMFMediaSourceがストレージとDemuxerを内包している
なので途中で枝分かれするというよりも、IMFMediaStream -&gt; IMFTransform -&gt; IMFStreamSinkというラインが複数ある感じになる。</p>
<p>+---------------+
|IMFMediaSource |
+---------------+
|+-------------+|
||IMFByteStream||
|+-------------+|                                          VideoRenderer
|  |  |Read     |                                          +------------+
|  |  v         |     (compressed) decoder (uncompressed)  |IMFMediaSink|
|  | +--------------+ IMFSample +------------+ IMFSample +-------------+|
|  | |IMFMediaStream|----------&gt;|IMFTransform|----------&gt;|IMFStreamSink|+
|  v +--------------+           +------------+           +-------------+
| +--------------+              +------------+           +-------------+
| |IMFMediaStream|-------------&gt;|IMFTransform|----------&gt;|IMFStreamSink|+
| +--------------+  IMFSample   +------------+ IMFSample +-------------+|
+---------------+   (compressed)           (uncompressed)  |IMFMediaSink|
                                                           +------------+
                                                           AudioRendrer</p>
<p>TopoEdit</p>
<p>https://github.com/Microsoft/Windows-classic-samples/tree/master/Samples/Win7Samples/multimedia/mediafoundation/topoedit
http://blogs.microsoft.co.il/pavely/2011/03/11/introduction-to-topoedit/</p>
<p>いろんなAPI
MediaSource(入力)とMediaSink(出力)を駆動する高レベルのAPIが複数ある。
[Obsolete]古のPlayer</p>
<p>IMFPMediaPlayer</p>
<p>Important  Deprecated. This API may be removed from future releases of Windows. Applications should use the Media Session for playback.</p>
<p>https://github.com/Microsoft/Windows-classic-samples/blob/master/Samples/Win7Samples/multimedia/mediafoundation/SimplePlay
https://github.com/Microsoft/Windows-classic-samples/tree/master/Samples/Win7Samples/multimedia/mediafoundation/MFPlayer2</p>
<p>[Desktop]再生向けのSession
Player向けのAPI。UWPには無い。</p>
<p>Media Session
http://blog.firefly-vj.net/2009/06/01/mediafoundation-play-with-mediasession.html
Media Foundationの再生サンプルの状態管理をMSMで行う</p>
<p>Topology</p>
<p>Topologies</p>
<p>変換向けのReader
Clockが必要ない用途に向いている。
各フレームを最速で処理したい場合や、MediaSourceがWebCamである場合など。</p>
<p>Source Reader
Using the Source Reader to Process Media Data
The Source Reader does not support reverse playback, even if the media source does.
MediaFoundationでID3D11Texture2Dに動画のフレームを読み込む 覚書β
MediaFoundation — 動画の読み込み</p>
<p>[Desktop][UWP]WinRTのEngine
Windows.Mediaのバックエンド？。UWPとDesktopの両方で使える。</p>
<p>Supported Microsoft Media Foundation APIs for Windows Phone 8
Walkthrough: Using Microsoft Media Foundation for Windows Phone 8</p>
<p>using a MediaElement control is a much quicker and easier way
You also must use MF if you want to use video as a texture on 3-D geometry</p>
<p>DXVAが簡単にできる。むしろUWPではDXVAしかない様子。情報少ないけど。</p>
<p>Media engine native C++ video playback sample</p>
<p>MediaSource</p>
<p>Media Sources</p>
<p>Writing a Custom Media Source
Case Study: MPEG-1 Media Source</p>
<p>https://github.com/Microsoft/Windows-classic-samples/tree/master/Samples/Win7Samples/multimedia/mediafoundation/mpeg1source
https://github.com/Microsoft/Windows-classic-samples/tree/master/Samples/Win7Samples/multimedia/mediafoundation/wavsource</p>
<p>Source Resolver</p>
<p>Using the Source Resolver</p>
<p>URL</p>
<p>IMFSourceResolver::CreateObjectFromURL</p>
<p>ByteStream</p>
<p>IMFSourceResolver::CreateObjectFromByteStream</p>
<p>ByteStreamを自作する
MP3 File Source</p>
<p>https://msdn.microsoft.com/en-us/library/windows/desktop/ff685299(v=vs.85).aspx</p>
<p>MPEG-4 File Source</p>
<p>https://msdn.microsoft.com/en-us/library/windows/desktop/dd757766(v=vs.85).aspx</p>
<p>MediaSink</p>
<p>Media Sinks</p>
<p>EVR</p>
<p>Enhanced Video Renderer
MediaSink
HWNDを渡してWindowに描画させることが出来る。
Presenterを自作して描画をカスタマイズできる。
D3D9 ?
EVR カスタムプレゼンタを実装する</p>
<p>SAR</p>
<p>Streaming Audio Renderer</p>
<p>AudioSink自作</p>
<p>https://github.com/Microsoft/Windows-classic-samples/tree/master/Samples/Win7Samples/multimedia/mediafoundation/wavsink</p>
<p>VideoSink自作</p>
<p>https://github.com/Microsoft/Windows-classic-samples/tree/master/Samples/DX11VideoRenderer</p>
<p>Playbackに対応した自前描画を作るには。</p>
<p>MediaSinkを自作する
MediaSinkでDXVAを使う</p>
<p>SampleGrabberSink</p>
<p>MFCreateSampleGrabberSinkActivate</p>
<p>MediaTransform</p>
<p>Media Foundation Transforms</p>
<p>About MFTs</p>
<p>Comparison of MFTs and DMOs</p>
<p>H.264</p>
<p>H.264 Video Decoder</p>
<p>DXVA
DirectX Video Acceleration。</p>
<p>About DXVA 2.0
Adding a Decoder to a Topology</p>
<p>MR_VIDEO_ACCELERATION_SERVICE
D3d9</p>
<p>Supporting DXVA 2.0 in Media Foundation
DXVA Video Processing
IDirect3DDeviceManager9</p>
<p>D3D11</p>
<p>https://github.com/Microsoft/Windows-classic-samples/tree/master/Samples/DX11VideoRenderer
Supporting Direct3D 11 Video Decoding in Media Foundation
IMFDXGIDeviceManager</p>
<p>Sample &amp; Buffer
Sampleの中にBufferが入っている。</p>
<p>Media Samples</p>
<p>Video Samples</p>
<p>Media Buffers
https://github.com/loskutov/VideoCapture/blob/master/src/DesktopDuplicationSampleProvider.cpp</p>
<p>MediaType</p>
<p>Media Types</p>
<p>Presentation Clock</p>
<p>Presentation Clock</p>
<p>Media Event</p>
<p>Media Event Generators</p>
<p>linkするライブラリ
関数はドキュメントでわかるが定数はどれに入っているかわからない。
わりと総当たりで試すはめになる。</p>
<p>mf.lib
mfplat.lib
mfuuid.lib
strmiids.lib
wmcodecdspuuid.lib</p>
<p>参考</p>
<p>Media Foundation Programming Guide</p>
</div>
                </div>
            </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/2017/08/usd/" class="u-url">PixarのUniversal Scene Descriptionをビルドしてみる</a></h1>
                <div class="metadata">
                    <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                        ousttrue
                    </span></p>
            <p class="dateline">
            <a href="posts/2017/08/usd/" rel="bookmark">
            <time class="published dt-published" datetime="2017-08-14T00:00:00+09:00" itemprop="datePublished" title="2017-08-14 00:00">2017-08-14 00:00</time></a>
            </p>
                </div>
            </header><div class="e-content entry-content">
                    <div>
<p>20170902。実はビルドスクリプトがあって、簡単になっていた。</p>
<p>動画でCEDEC2017のセッションを聞いてよさげな気がしたので再度やってみた(ちょっと前に途中までやって放置していた)。
usdviewが使えるようにするとよいらしい。</p>
<h3>Pixar USD の Windows ビルド方法（2017/9 版）</h3>
<p>自動ビルドスクリプトがついているので放っておくだけなのだけど、うまくいかなかったところを補足する。
環境は、Windows10(64bit) + VisualStudio2017 + VisualStudio2015のコンパイラ追加インストール(VisualStudio2017のインストールメニューにある)
visualstudio補足
VisualStudioは、最近のバージョンに限ってもいろいろある。</p>
<p>VisualStudio2017(MSVC14.1)のみ
VisualStudio2017(MSVC14.1)にVS2015(MSVC14.0)のコンパイラが追加インストールされている(うちはこれ)
VisualStudio2015(MSVC14.0)のみ
Visual C++ 2015 Build Tools(MSVC14.0)Python3ビルド向けにIDEの無いバージョン)</p>
<p>ものによってvcvars.batの場所が違って、bjamとかdistutilsがコンパイラの発見に失敗したりする場合があるようだ。
cl.exeが見つからないような場合、visualstudioの提供する設定済みのdosプロンプトから始めるのが手堅いかもしれない。
一応、
VisualStudio2017 - x64 native tools command promptからはじめる。
CMakeはVisualStudioの検出にあまり失敗しないので、おもにBoostのビルド対策。
効果があったかは不明。
D:\work&gt; cl
Microsoft(R) C/C++ Optimizing Compiler Version 19.10.25019 for x64
Copyright (C) Microsoft Corporation.  All rights reserved.</p>
<p>使い方: cl [ オプション... ] ファイル名... [ /link リンク オプション... ]</p>
<p>VS2017しか入っていないとき
build_usd.py内Boost.Pythonに関してmsvc=14.0指定(VS2015)があるので、これをコメントアウトすればたぶんVS2017しかなくてもビルドできる。Windows版のPython2.7のビルドコンパイラはVS2008(MSVC9.0)らしい。</p>
<p><a href="https://www.microsoft.com/en-us/download/details.aspx?id=44266">https://www.microsoft.com/en-us/download/details.aspx?id=44266</a></p>
<p>python補足
Python27以外のPythonが入っているとはまる率が上がる。</p>
<pre class="code literal-block"><span></span><span class="nt">D</span><span class="o">:</span><span class="err">\</span><span class="nt">work</span><span class="o">&gt;</span> <span class="nt">python</span> <span class="nt">-V</span>
<span class="nt">Python</span> <span class="nt">3</span><span class="p">.</span><span class="nc">6</span><span class="p">.</span><span class="nc">0</span> <span class="o">::</span> <span class="nt">Anaconda</span> <span class="nt">4</span><span class="p">.</span><span class="nc">3</span><span class="p">.</span><span class="nc">0</span> <span class="o">(</span><span class="nt">64-bit</span><span class="o">)</span>

<span class="nt">違うPythonだー</span><span class="err">。</span>
<span class="nt">D</span><span class="o">:</span><span class="err">\</span><span class="nt">work</span><span class="o">&gt;</span> <span class="nt">set</span> <span class="nt">PATH</span><span class="o">=</span><span class="nt">D</span><span class="o">:</span><span class="err">\</span><span class="nt">Python27</span><span class="o">;</span><span class="nt">D</span><span class="o">:</span><span class="err">\</span><span class="nt">Python27</span><span class="err">\</span><span class="nt">Scripts</span><span class="o">;%</span><span class="nt">PATH</span><span class="o">%</span>
<span class="nt">D</span><span class="o">:</span><span class="err">\</span><span class="nt">work</span><span class="o">&gt;</span> <span class="nt">python</span> <span class="nt">-V</span>
<span class="nt">Python</span> <span class="nt">2</span><span class="p">.</span><span class="nc">7</span><span class="p">.</span><span class="nc">14rc1</span>
<span class="nt">D</span><span class="o">:</span><span class="err">\</span><span class="nt">work</span><span class="o">&gt;</span> <span class="nt">pip</span> <span class="nt">install</span> <span class="nt">pyside</span>
<span class="nt">Collecting</span> <span class="nt">pyside</span>
  <span class="nt">Downloading</span> <span class="nt">PySide-1</span><span class="p">.</span><span class="nc">2</span><span class="p">.</span><span class="nc">4-cp27-none-win_amd64</span><span class="p">.</span><span class="nc">whl</span> <span class="o">(</span><span class="nt">45</span><span class="p">.</span><span class="nc">0MB</span><span class="o">)</span>
    <span class="nt">100</span><span class="o">%</span> <span class="o">|</span><span class="err">################################</span><span class="o">|</span> <span class="nt">45</span><span class="p">.</span><span class="nc">0MB</span> <span class="nt">36kB</span><span class="o">/</span><span class="nt">s</span>
<span class="nt">Installing</span> <span class="nt">collected</span> <span class="nt">packages</span><span class="o">:</span> <span class="nt">pyside</span>
<span class="nt">Successfully</span> <span class="nt">installed</span> <span class="nt">pyside-1</span><span class="p">.</span><span class="nc">2</span><span class="p">.</span><span class="nc">4</span>
</pre>

<p>python使いたるもの２系、３系両方入っていたりするものである。
cloneしてビルドスクリプトを実行</p>
<pre class="code literal-block"><span></span>D:\work&gt; git clone https://github.com/PixarAnimationStudios/USD

D:\work&gt; mkdir USD_build
D:\work&gt; cd USD_build
D:\work\USD_build&gt;

D:\work\USD_build&gt; python ..\USD\build_scripts\build_usd.py
usage: build_usd.py [-h] [-n] [-v | -q] [--build BUILD]
                    [--generator GENERATOR]
                    [--build-shared | --build-monolithic] [--src SRC]
                    [--inst INST] [--force FORCE_BUILD] [--force-all]
                    [--tests | --no-tests] [--docs | --no-docs]
                    [--imaging | --usd-imaging | --no-imaging]
                    [--ptex | --no-ptex] [--embree | --no-embree]
                    [--embree-location EMBREE_LOCATION]
                    [--alembic | --no-alembic] [--hdf5 | --no-hdf5]
                    [--maya | --no-maya] [--maya-location MAYA_LOCATION]
                    [--katana | --no-katana]
                    [--katana-api-location KATANA_API_LOCATION]
                    [--houdini | --no-houdini]
                    [--houdini-location HOUDINI_LOCATION]
                    install_dir
build_usd.py: error: too few arguments

D:\work\USD_build&gt; python ..\USD\build_scripts\build_usd.py .
ERROR: CMake not found -- please install it and adjust your PATH
</pre>

<p>こんな風に足りないツールのメッセージが出るのでせっせとインストールしてパスを設定する。</p>
<blockquote>
<p>set PATH=D:\Program Files\CMake\bin;%PATH%
set PATH=D:\Program Files\NASM;%PATH%</p>
</blockquote>
<p>build…</p>
<h3>Alembicとか無しの最小ビルド。</h3>
<pre class="code literal-block"><span></span>D:\work\USD_build&gt; python ..\USD\build_scripts\build_usd.py .

Building with settings:
  USD source directory          D:\work\USD
  USD install directory         D:\work\USD_build
  3rd-party source directory    D:\work\USD_build\src
  3rd-party install directory   D:\work\USD_build
  Build directory               D:\work\USD_build\build

  Building                      Shared libraries
    Imaging                     On
      Ptex support:             Off
    UsdImaging                  On
    Documentation               Off
    Tests                       Off
    Alembic Plugin              Off
      HDF5 support:             Off
    Maya Plugin                 Off
    Katana Plugin               Off
    Houdini Plugin              Off

    Dependencies                zlib, boost, TBB, JPEG, TIFF, PNG, OpenEXR, GLEW, OpenImageIO, OpenSubdiv, PyOpenGL

STATUS: Installing zlib...
STATUS: Installing boost...
STATUS: Installing TBB...
STATUS: Installing JPEG...
STATUS: Installing TIFF...
STATUS: Installing PNG...
</pre>

<p>こんな感じに順番にビルドが進んでいく。
pngのビルドでこけた
pngrutil.obj : error LNK2019: 未解決の外部シンボル inflateValidate が関数 png_inflate_claim で参照されました。</p>
<p>何故か、zlibへのリンクがうまくいっていない？
CMakeのGUIでsourceをUSD_build/src/libpng-1.6.29、buildをD:/dev/_alembic/USD_build/build/libpng-1.6.29にして確認するとZLIB_LIBRARY_RELEASEがC:/Program Files/Anaconda3/Library/lib/z.libになっていてお察し。
pythonをフルパスで指定したらなんか治った。違うPythonが意図せず使われていたか。
dos窓は、whichコマンドが無いしよくわからん。</p>
<pre class="code literal-block"><span></span>work\USD_build&gt; D:\python27\python ..\USD\build_scripts\build_usd.py . --force png

STATUS: Installing PNG...
STATUS: Installing OpenEXR...
STATUS: Installing GLEW...
STATUS: Installing OpenImageIO...
STATUS: Installing OpenSubdiv...
STATUS: Installing PyOpenGL...
STATUS: Installing PyOpenGL...
STATUS: Installing USD...

Success! To use USD, please ensure that you have:
  The following in your PYTHONPATH environment variable:
    D:\dev\_alembic\USD_build\lib\python

  The following in your PATH environment variable:
    D:\dev\_alembic\USD_build\bin
    D:\dev\_alembic\USD_build\lib
</pre>

<p>ビルドできた。</p>
<h3>Boost.Pythonメモ</h3>
<p>boost_python-vc140-mt-1_61.dllがpython36.dllとか違うのにリンクしてしまう場合。
最悪PythonをすべてアンインストールしてPython27(64bit)だけをインストールすればいけるのだが、それでは負けた気がするのでBoost.Pythonに使うPythonを強制する方法。
USD_BUILD/user-conifg.jam
using python
    : 2.7                   # Version
    : C:\Python27\python.exe      # Python Path
    : C:\Python27\include         # include path
    : C:\Python27\libs            # lib path(s)
    ;</p>
<p>を作って環境変数BOOST_BUILD_PATHをuser-config.jamのあるディレクトリに指定する。
%USERROFILE%\user-config.jamに作ってBOOST_BUILD_PATH無しでもよいが、消し忘れるとあとではまる可能性が増えると思う。</p>
<p>http://www.boost.org/build/doc/html/bbv2/overview/configuration.html</p>
<p>WindowsのBoost.Pythonは作るときも使うときもリンクではまる。
usdviewを使ってみる
USD_BUILD/bin/usdviewがある。
USD_BUILD\bin&gt; D:\python27\python usdview</p>
<p>sys.path
Traceback (most recent call last):
  File "usdview", line 25, in <module>
    import pxr.Usdviewq as Usdviewq
ImportError: No module named pxr.Usdviewq</module></p>
<p>environ[‘PATH’]
Traceback (most recent call last):
  File "usdview", line 37, in <module>
    Usdviewq.Launcher().Run()
  File "D:\dev_alembic\USD_build\lib\python\pxr\Usdviewq__init__.py", line 54, in Run
    valid = self.ValidateOptions(arg_parse_result)
  File "D:\dev_alembic\USD_build\lib\python\pxr\Usdviewq__init__.py", line 167, in ValidateOptions
    from pxr import Sdf
  File "D:\dev_alembic\USD_build\lib\python\pxr\Sdf__init__.py", line 24, in <module>
    import _sdf
ImportError: DLL load failed: 指定されたモジュールが見つかりません。</module></module></p>
<p>usdviewを改造してしまおう。
環境変数PATHとPYTHONPATHを追加。
usdview.cmd改造でもよいがpythonの方が書きやすいので。
usdviewの冒頭のimport前に下記を追加。
import os
import sys</p>
<p>basepath=os.path.dirname(os.path.dirname(os.path.abspath(<strong>file</strong>)))
bin_dir=os.path.join(basepath, 'bin')
lib_dir=os.path.join(basepath, 'lib')
libpython_dir=os.path.join(lib_dir, 'python')</p>
<p>sys.path.append(libpython_dir)
os.environ['PATH']="%s;%s;" % (bin_dir, lib_dir) + os.environ['PATH']</p>
<p>import pxr.Usdviewq as Usdviewq</p>
<p>実行。
USD_BUILD\bin&gt; D:\python27\python usdview
usage: usdview [-h] [--renderer {opt,simple}] [--select PRIMPATH]
               [--camera CAMERA] [--mask PRIMPATH[,PRIMPATH...]]
               [--clearsettings] [--norender] [--unloaded] [--timing]
               [--memstats {none,stage,stageAndImaging}]
               [--numThreads NUMTHREADS] [--ff FIRSTFRAME] [--lf LASTFRAME]
               [--complexity COMPLEXITY] [--quitAfterStartup]
               usdFile
usdview: error: too few arguments</p>
<p>引数が必要と。
cube.usd</p>
<h2>usda 1.0</h2>
<p>def Cube "Cube"
{
}</p>
<p>実行。
Warning: in Link at line 180 of D:\dev_alembic\USD\pxr\imaging\lib\hd\glslProgram.cpp -- Failed to link shader:
Geometry shader(s) failed to link.
Geometry link error: HW_UNSUPPORTED.
ERROR: Internal compile error, error code: E_SC_LITERAL_NOT_DEFINED
Shader not supported by HW</p>
<p>Windowは出た。しかしglslのエラーで3DViewの描画ができぬ。
Rx480がだめなのだろうか。
GTX買わねば・・・
Alembic追加する
ToDo</p>
</div>
                </div>
            </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/2017/08/pybullet/" class="u-url">PyBulletを使ってみる</a></h1>
                <div class="metadata">
                    <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                        ousttrue
                    </span></p>
            <p class="dateline">
            <a href="posts/2017/08/pybullet/" rel="bookmark">
            <time class="published dt-published" datetime="2017-08-14T00:00:00+09:00" itemprop="datePublished" title="2017-08-14 00:00">2017-08-14 00:00</time></a>
            </p>
                </div>
            </header><div class="e-content entry-content">
                    <div>
<p>BulletPhysicsの公式Pythonバインディングが出てたので使ってみる。</p>
<p>Windows10(64bit) + Python3.6
pip</p>
<blockquote>
<p>C:\Python36\Scripts\pip.exe install pybullet</p>
</blockquote>
<p>cl.exe not found的な
msvc-14.0なコンパイラがインストールされているにも関わらず出るなら
これ
かもしれない
C:\Python36\Lib\distutils_msvccompiler.pyを修正すればいけるかも。
    try:
        out = subprocess.check_output(
            'cmd /u /c "{}" {} &amp;&amp; set'.format(vcvarsall, plat_spec),
            stderr=subprocess.STDOUT,
        ).decode('utf-16le', errors='replace')
        #######################################################################
        if out.startswith("Error in script usage"):
            out = subprocess.check_output(
                'cmd /u /c "{}" {} &amp;&amp; set'.format("C:\Program Files (x86)\Microsoft Visual C++ Build Tools\vcbuildtools.bat", plat_spec),
                stderr=subprocess.STDOUT,
            ).decode('utf-16le', errors='replace')
        #######################################################################
    except subprocess.CalledProcessError as exc:
        log.error(exc.output)
        raise DistutilsPlatformError("Error executing {}"
                .format(exc.cmd))</p>
<p>utf-8がどうこう的な
いい加減WindowsはCP932を使うのやめて欲しいのだけど。
chcp65001</p>
<p>インストールできた。
使ってみる</p>
<p>pybullet quickstart guide</p>
<p>日付が2017で思ったより新しい。むしろ、記述中くらいか。
hello pybullet
import pybullet as p
physicsClient = p.connect(p.GUI)#or p.DIRECT for non-graphical version
p.setGravity(0,0,-10)
planeId = p.loadURDF("plane.urdf")
cubeStartPos = [0,0,1]
cubeStartOrientation = p.getQuaternionFromEuler([0,0,0])
boxId = p.loadURDF("r2d2.urdf",cubeStartPos, cubeStartOrientation)
p.stepSimulation()
cubePos, cubeOrn = p.getBasePositionAndOrientation(boxId)
print(cubePos,cubeOrn)
p.disconnect()</p>
<p>plane.urdfはどこにあるのか。
bullet3のソースの中にあった。bullet3/build/data/plane.urdf</p>
<?xml version="0.0" ?><p><robot name="plane"><link name="planeLink">
<contact><lateral_friction value="1"></lateral_friction></contact><inertial><origin rpy="0 0 0" xyz="0 0 0"></origin><mass value=".0"></mass><inertia ixx="0" ixy="0" ixz="0" iyy="0" iyz="0" izz="0"></inertia></inertial><visual><origin rpy="0 0 0" xyz="0 0 0"></origin><geometry><mesh filename="plane.obj" scale="1 1 1"></mesh></geometry><material name="white"><color rgba="1 1 1 1"></color></material></visual><collision><origin rpy="0 0 0" xyz="0 0 -5"></origin><geometry><box size="30 30 10"></box></geometry></collision></robot></p>
<p>なるほどー。
ちょっとhelloを改造
import os
os.chdir('D:/dev/_python/bullet3/build/data') # urdfのあるところに移動</p>
<p>import pybullet as p
physicsClient = p.connect(p.GUI)#or p.DIRECT for non-graphical version
p.setGravity(0,0,-10)
planeId = p.loadURDF("plane.urdf")
cubeStartPos = [0,0,1]
cubeStartOrientation = p.getQuaternionFromEuler([0,0,0])
boxId = p.loadURDF("r2d2.urdf",cubeStartPos, cubeStartOrientation)</p>
<p>while True: # とりあえずpythonを抜けないように
    p.stepSimulation()
    cubePos, cubeOrn = p.getBasePositionAndOrientation(boxId)
    print(cubePos,cubeOrn)</p>
<p>p.disconnect()</p>
<p>面白そう。</p>
</div>
                </div>
            </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/2017/08/cmake_find_boost_python/" class="u-url">CMakeでBoost.Pythonを使う</a></h1>
                <div class="metadata">
                    <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                        ousttrue
                    </span></p>
            <p class="dateline">
            <a href="posts/2017/08/cmake_find_boost_python/" rel="bookmark">
            <time class="published dt-published" datetime="2017-08-09T00:00:00+09:00" itemprop="datePublished" title="2017-08-09 00:00">2017-08-09 00:00</time></a>
            </p>
                </div>
            </header><div class="e-content entry-content">
                    <div>
<p>Windows上のCMakeでFIND_PACKAGE(Boost)する件について。</p>
<p>Boost.Pythonのビルド
C:/boost_1_61_0に解凍して、b2 --with-pythonしたとする。
のようなディレクトリ構成。
C:/boost_1_61_0
    stage
        lib
            boost_python.lib</p>
<p>FIND_PACKAGE
BOOST.Pythonを使う場合は下記の記述をして、-DBOOST_ROOT=C:/boost_1_61_0を指定してやるとcmakeはBoost.Pythonを見つけることができる。
ただし、検索パスが${BOOST_ROOT}/stage/lib決め打ち。
FIND_PACKAGE (Boost COMPONENTS PYTHON REQUIRED)
MESSAGE(STATUS ${Boost_LIBRARIES})</p>
<p>見つかった
optimizedD:/lib/boost_1_61_0/stage/lib/boost_python-vc140-mt-1_61.libdebugD:/lib/boost_1_61_0/stage/lib/boost_python-vc140-mt-gd-1_61.lib</p>
<p>Python3は？
FIND_PACKAGE (Boost COMPONENTS python3 REQUIRED)
MESSAGE(STATUS ${Boost_LIBRARIES})</p>
<p>でいける。
しかし、警告が出た。
CMake Warning at D:/Program Files/CMake/share/cmake-3.9/Modules/FindBoost.cmake:1564 (message):
  No header defined for python3; skipping header check
Call Stack (most recent call first):
  CMakeLists.txt:42 (FIND_PACKAGE)</p>
<p>3がついてなくても同じだった
stage/libに出力されているboost_python3.dllとboost_python.dllは同じバイナリぽい。
static, sharedの呼び分けは？
後で。
FindBoost</p>
<p>https://cmake.org/cmake/help/latest/module/FindBoost.html</p>
<p>しかし
FIND_PACKAGEした結果のBoost_LIBRARIESを使うのには注意が必要。
ネイティブモジュール開発で、デバッグ版にRelease版のPythonをリンクする場合(通常そうする)に、Boost.PytnonもRelease版にリンクするべきなのでここではまりうる(コンパイルは通るが実行時に謎エラーが出る)。LINK_DIRECTORIESを使って、リンク対象はBOOSTのautolink頼りの方が確実かもしれない。</p>
<p>BOOST_ALL_NO_LIB を定義して Boost_LIBRARIESにリンクする
Boost_LIBRARIESを使わずに、BoostのAutoLinkに従う</p>
<p>のいずれかになるが、ネイティブモジュール開発では後者がおすすめか。</p>
</div>
                </div>
            </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/2017/08/pyalembic/" class="u-url">WindowsでPyAlembicできるのか</a></h1>
                <div class="metadata">
                    <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                        ousttrue
                    </span></p>
            <p class="dateline">
            <a href="posts/2017/08/pyalembic/" rel="bookmark">
            <time class="published dt-published" datetime="2017-08-07T00:00:00+09:00" itemprop="datePublished" title="2017-08-07 00:00">2017-08-07 00:00</time></a>
            </p>
                </div>
            </header><div class="e-content entry-content">
                    <div>
<p>Windows上でPyAlembicを使いたいのだができるのか。
素直にLinuxでやるべきでは・・・
Windows10(64bit) + Python-3.6(64bit)</p>
<p>作業場。</p>
<p>https://github.com/ousttrue/openexr</p>
<p>Anaconda3(Windows10 64bit)でモジュール探す</p>
<blockquote>
<p>conda install -c conda-forge alembic</p>
</blockquote>
<p>しかし、これは違うAlembicだった。
Pythonのalembicは、database migrations toolと名前が被っております。
なるほど・・・。
Python2.7なら</p>
<p>http://www.lfd.uci.edu/~gohlke/pythonlibs/#pyalembic</p>
<p>あとから発見。わいは、Python3.6にしたいので。
自前でビルドを試みる
alembic-1.7.1/python/PyAlembicがそれですな。
問題が２つある。</p>
<p>Python2(Python3にしたい)
Boost.Python(PyBind11にしてリンク問題とおさらばしたい)</p>
<p>さすがにPyBind11差し替えはやるにしても後にするべきなので、 Python3化だけやる。
Boost.Pythonのビルド
Boost.Pythonで使うPythonを明示するには、user-config.jamに記述する。
BOOST_DIR/user-conifg.jam
using python 
    : 3.6                   # Version
    : D:\Anaconda3\python.exe      # Python Path
    : D:\Anaconda3\include         # include path
    : D:\Anaconda3\libs            # lib path(s)
    : <define>BOOST_ALL_NO_LIB=1
    ;</define></p>
<p>ビルド
boost&gt; b2.exe -j3 --stagedir=stage\x86_64 link=shared runtime-link=shared threading=multi toolset=msvc-14.0 address-model=64 --with-python</p>
<p>link=sharedにしてdllを生成することが必要。
これは、iex.pydとimath.pyd間でBoost.Pythonのstatic変数を共有するために必須である(pyexの型登録周りか)。
IlmBaseを修正
ilmbase-2.2.0/IexMath/IexMathFloatExc.h
の以下の部分を修正する。多分、記述ミスなのだけど誰もWindowsビルドしないので気付かれていないのであろう。
//#if defined(IEX_EXPORTS)↲</p>
<h2>if defined(IEXMATH_EXPORTS)↲</h2>
<p>これでilmbaseをビルドしておく。vcpkgを使った。
alembicを修正
alembic-1.7.1/lib/Alembic/AbcCoreLayer/CMakeLists.txtを修正してヘッダを追加する(PyAlembicが使う)
INSTALL(FILES Read.h Util.h
    Foundation.h # 追加
    DESTINATION include/Alembic/AbcCoreLayer)</p>
<p>これも、vcpkgを使った。
PyIlmBaseのビルド
OpenEXRのサイトにあるpyilmbase-2.2.0tar.gzを使おうとしたのだけど、githubの方が新しいようなのでこちらを使う。
Python3向けの修正
Python2とPytnon3間での非互換によるコンパイルエラーを直していく。</p>
<p>PySliceObject_XXX -&gt; PyObject_XXX
PyInt_XXX -&gt; PyLong_XXX
PyString_AsString -&gt; PyUnicode_AsUTF8
_PyThreadState_Current -&gt; _PyThreadState_UncheckedGet()</p>
<p>参考</p>
<p>Python3 Advent Calendar - Pythonで2/3両方で動くコードを書く(C/API)
Fix build for Python 3.5
http://py3c.readthedocs.io/en/latest/guide.html</p>
<p>CMake設定</p>
<p>CMAKE_INSTALL_PREFIX
BOOST_ROOT
ILMBASE_PACKAGE_PREFIX
FIND_PACKAGE(numpy)をコメントアウト
DebugでもPython36.libにリンクするように、#include <python.h>を除去(boost/python.hpp経由でインクルードさせればそうなる)</python.h></p>
<p>ビルドが通るようになった。
PyAlembicのビルド
当初、AlembicのプロジェクトでPythonフラグを有効にして一緒にビルドしようとしていたが、PyIlmBase傘下にPyAlembicをコピーする方式に変えた。
alembic-1.7.1/python/PyAlembicをilmbase-2.2.0/PyIlmBaseにコピーして、CMakeLists.txtを調整する。
CMake設定</p>
<p>Alembic_ROOT</p>
<p>参考</p>
<p>uimac実装メモ - PyImath</p>
<p>PyAlembicのビルドが通ったので実行してみよう
PyAlembic/Tests/testPolyMesh.pyを動かしてみようと思う。
こういう感じに準備する。
testPolyMesh.py
iex.pyd
PyIex.dll
imath.pyd
PyImath.dll
alembic.lib
alembic.pyd
boost_python-vc140-mt-1_61.dll # debug buildもこれ</p>
<blockquote>
<p>C:/python36/python.exe testPolyMesh.py</p>
</blockquote>
<p>import alembicでクラッシュする。デバッガで追ってみると、モジュールの初期化でエラーが発生している。一個ずつ直す。
初期化の修正
Python3化による変更？
AbcView
今回の作業目標。</p>
<p>http://alembic.github.io/abcview/</p>
<p>これを動作させたい。
AbcView has the following requirements:</p>
<p>Python 2.6+ =&gt; Python 3.6 で動くように改造する(print文とか)
PyAlembic。できた
PyAbcOpenGL。できた
PyOpenGL。pip
argparse。pip
PyQt4。http://www.lfd.uci.edu/~gohlke/pythonlibs/#pyalembic
numpy-mkl。http://www.lfd.uci.edu/~gohlke/pythonlibs/#pyalembic</p>
<p>PyQt4をインストール</p>
<p>https://stackoverflow.com/questions/22640640/how-to-install-pyqt4-on-windows-using-pip
http://www.lfd.uci.edu/~gohlke/pythonlibs/#pyqt4</p>
<p>こんな感じで公式のPython3.6(64bit)に対してインストール。
D:\Python36\Scripts\pip.exe install .\PyQt4-4.11.4-cp36-cp36m-win_amd64.whl</p>
<p>https://www.tutorialspoint.com/pyqt/pyqt_hello_world.htm</p>
<p>import sys
from PyQt4 import QtGui</p>
<p>def window():
    app = QtGui.QApplication(sys.argv)
    w = QtGui.QWidget()
    b = QtGui.QLabel(w)
    b.setText("Hello World!")
    w.setGeometry(100,100,200,50)
    b.move(50,20)
    w.setWindowTitle("PyQt")
    w.show()
    sys.exit(app.exec_())</p>
<p>if <strong>name</strong> == '<strong>main</strong>':
    window()</p>
<p>動いた。
alembicgl.pyd, alembic.pyd, imath.pyd, iex.pydと依存dll群をwheel化する
同じdllを参照するpydを同じフォルダに配置したいので、
共通の親モジュールとしてilmを定義してその中にすべてのpydとdllを収めることにした。
そのうえでこれを間接的にエクスポートするモジュール’iex’, ‘imath’, ‘alembic’, ‘alembicgl’
を作る計画。
ilm
    + <strong>init</strong>.py
    + iex.pyd
    + imath.pyd
    + alembic.pyd
    + alembicgl.pyd
    + PyEx.dll
    + PyImath.dll
    + boost_python.dll
    + Alembic.dll # VCPKG BUILD
    + ilmbase.dll # VCPKG BUILD
    + iex.dll # VCPKG BUILD
    + imath.dll # VCPKG BUILD
    + half.dll # VCPKG BUILD
    + hdf5.dll # VCPKG BUILD
    + zip.dll # VCPKG BUILD
    + szip.dll # VCPKG BUILD
iex
    + <strong>init</strong>.py # ilm.iexを公開
imath
    + <strong>init</strong>.py # ilm.imathを公開
alembic
    + <strong>init</strong>.py # ilm.alembicを公開
alembicgl
    + <strong>init</strong>.py # ilm.alembicglを公開
setup.py</p>
<p>iex/init.py
from ilm.iex import *</p>
<p>こういうのをiex, imath, alembic, alembicglそれぞれに作った。
setup.py</p>
<h2>!/usr/bin/env python</h2>
<p>from setuptools import setup, Distribution</p>
<p>setup(
        name='alembic',
        version='0.1',
        description='Alembic Library',
        packages=['ilm', 'iex', 'imath', 'alembic', 'alembicgl'],
        package_data={
            'ilm':['<em>.pyd', '</em>.dll'],
            },
        )</p>
<p>py_package&gt; D:\Python36\python.exe setup.py bidst_wheel
py_package&gt; D:\Python36\Scripts\pip.exe install .\dist\alembic-0.1-cp36-cp36m-win_amd64.whl</p>
<p>AbcViewを実行してみる
こういう感じに配置して、abcview_main.pyを実行してみる。
abcview_main.py # bin/abcviewから改名(名前がフォルダと被らないように変更)
abcview
    <strong>init</strong>.py</p>
<p>python2仕様の部分をまとめて修正。</p>
<p>https://docs.python.jp/3/library/2to3.html</p>
<p>AbcView&gt; D:\Python36\python.exe D:\Python36\Tools\scripts\2to3.py -w .</p>
<p>print文、except文などの定型的な文法問題はこれで一網打尽。ディレクトリを指定することでまとめて処理できる。
file.toAscii() =&gt; file
これもPython2との非互換か。
QtCore.QString(str(value)) =&gt; str(value)
QStringは、PythonのStringでよさげ。
動いた</p>
<p>https://github.com/ousttrue/openexr/releases/tag/v0.1</p>
<p>タイムラインを操作したら蛸が動いた。</p>
</div>
                </div>
            </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/2017/08/distutils_msvccompiler/" class="u-url">distutilsでcl.exeが見つからない</a></h1>
                <div class="metadata">
                    <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                        ousttrue
                    </span></p>
            <p class="dateline">
            <a href="posts/2017/08/distutils_msvccompiler/" rel="bookmark">
            <time class="published dt-published" datetime="2017-08-06T00:00:00+09:00" itemprop="datePublished" title="2017-08-06 00:00">2017-08-06 00:00</time></a>
            </p>
                </div>
            </header><div class="e-content entry-content">
                    <div>
<p>PythonじゃなくてVisualStudio側の問題のようなのだけど、setup.pyでネイティブモジュールをビルドするときに顕在化したので。</p>
<p>こういう感じのネイティブモジュールを作った。
from distutils.core import setup, Extension</p>
<p>imgui_module = Extension('_swig_imgui',
        sources=[
            #'imgui_wrap.cxx',
            'imgui.i',
            'imgui/imgui.cpp',
            'imgui/imgui_draw.cpp',
            'imgui/imgui_demo.cpp',
            ],
        swig_opts=[
            #'-modern',
            '-c++',
            '-py3',
            ]
        )</p>
<p>setup (name = 'swig_imgui',
        version = '0.1',
        author      = "ousttrue",
        description = """imgui wrapper using swig""",
        ext_modules = [imgui_module],
        py_modules = ["swig_imgui"],
        )</p>
<blockquote>
<p>python setup.py build</p>
</blockquote>
<p>とするとエラーになる。
Windows10(64bit)上のvs2017 + vcbuildtoolsの組み合わせの環境である。
cl.exe /c /nologo /Ox /W3 /GL /DNDEBUG /MD -ID:\Anaconda3\include -ID:\Anaconda3\include /EHsc /Tpimgui_wrap.cpp /Fobuild\temp.win-amd64-3.6\Release\imgui_wrap.obj
error: command 'cl.exe' failed: No such file or directory</p>
<p>distutilsがcl.exeを探すのに失敗しているようなのである。
lib/distutils下を調べてみた。
どうやらlib/distutils/_msvccompiler.pyでvcvarsall.batから環境変数を得ることに失敗しているらしい。
実際、C:\Program Files (x86)\Microsoft Visual Studio\Shared\14.0\VC\vcvarsall.batの呼び出しが失敗していることを突き止めた。
Error in script usage. The correct usage is:
    "C:\Program Files (x86)\Microsoft Visual Studio\Shared\14.0\VC\vcvarsall.bat" [option]
  or
    "C:\Program Files (x86)\Microsoft Visual Studio\Shared\14.0\VC\vcvarsall.bat" [option] store
  or
    "C:\Program Files (x86)\Microsoft Visual Studio\Shared\14.0\VC\vcvarsall.bat" [option] [version number]
  or
    "C:\Program Files (x86)\Microsoft Visual Studio\Shared\14.0\VC\vcvarsall.bat" [option] store [version number]
where [option] is: x86 | amd64 | arm | x86_amd64 | x86_arm | amd64_x86 | amd64_arm
where [version number] is either the full Windows 10 SDK version number or "8.1" to use the windows 8.1 SDK
:
The store parameter sets environment variables to support
  store (rather than desktop) development.
:
For example:
    "C:\Program Files (x86)\Microsoft Visual Studio\Shared\14.0\VC\vcvarsall.bat" x86_amd64
    "C:\Program Files (x86)\Microsoft Visual Studio\Shared\14.0\VC\vcvarsall.bat" x86_arm store
    "C:\Program Files (x86)\Microsoft Visual Studio\Shared\14.0\VC\vcvarsall.bat" x86_amd64 10.0.10240.0
    "C:\Program Files (x86)\Microsoft Visual Studio\Shared\14.0\VC\vcvarsall.bat" x86_arm store 10.0.10240.0
    "C:\Program Files (x86)\Microsoft Visual Studio\Shared\14.0\VC\vcvarsall.bat" x64 8.1
    "C:\Program Files (x86)\Microsoft Visual Studio\Shared\14.0\VC\vcvarsall.bat" x64 store 8.1</p>
<p>コマンドラインから実行しても失敗していて、vcvarsall.batに以下のコードがあるのだが、
:setup_buildsku
if not exist "%~dp0......\Microsoft Visual C++ Build Tools\vcbuildtools.bat" goto usage
set CurrentDir=%CD%
call "%~dp0......\Microsoft Visual C++ Build Tools\vcbuildtools.bat" %1 %2
cd /d %CurrentDir%
goto :eof</p>
<p>C:\Program Files (x86)\Microsoft Visual Studio\Shared\14.0\VC\vcvarsall.bat
から
C:\Program Files (x86)\Microsoft Visual C++ Build Tools\vcbuildtools.bat"
への相対パスだと一致しないよなーと。
これが原因でcl.exeのパスが取れない。
setup.pyにモンキーパッチを当ててcl.exeを発見できるようにしてみた。
以下をsetup.pyの先頭に追加。</p>
<h2>monkey patch for _msvccompiler</h2>
<p>import distutils._msvccompiler
import os
import subprocess
def _get_vc_env(plat_spec):
    if os.getenv("DISTUTILS_USE_SDK"):
        return {
            key.lower(): value
            for key, value in os.environ.items()
        }</p>
<pre class="code literal-block"><span></span>vcvarsall, vcruntime = distutils._msvccompiler._find_vcvarsall(plat_spec)
if not vcvarsall:
    raise DistutilsPlatformError("Unable to find vcvarsall.bat")

try:
    out = subprocess.check_output(
        'cmd /u /c "{}" {} &amp;&amp; set'.format(vcvarsall, plat_spec),
        stderr=subprocess.STDOUT,
    ).decode('utf-16le', errors='replace')
    #######################################################################
    if out.startswith("Error in script usage"):
        out = subprocess.check_output(
            'cmd /u /c "{}" {} &amp;&amp; set'.format("C:\\Program Files (x86)\\Microsoft Visual C++ Build Tools\\vcbuildtools.bat", plat_spec),
            stderr=subprocess.STDOUT,
        ).decode('utf-16le', errors='replace')
    #######################################################################
except subprocess.CalledProcessError as exc:
    log.error(exc.output)
    raise DistutilsPlatformError("Error executing {}"
            .format(exc.cmd))

env = {
    key.lower(): value
    for key, _, value in
    (line.partition('=') for line in out.splitlines())
    if key and value
}

if vcruntime:
    env['py_vcruntime_redist'] = vcruntime
return env
</pre>

<p>distutils._msvccompiler._get_vc_env=_get_vc_env</p>
<p>以前にもこんなことやったことあるような気がする・・・。</p>
</div>
                </div>
            </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/2017/07/imgui_python/" class="u-url">PythonでImGuiする</a></h1>
                <div class="metadata">
                    <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                        ousttrue
                    </span></p>
            <p class="dateline">
            <a href="posts/2017/07/imgui_python/" rel="bookmark">
            <time class="published dt-published" datetime="2017-07-31T00:00:00+09:00" itemprop="datePublished" title="2017-07-31 00:00">2017-07-31 00:00</time></a>
            </p>
                </div>
            </header><div class="e-content entry-content">
                    <div>
<p>PythonでImGuiするのがよさげな気がしたのでやってみた。</p>
<p>ImGuiはcではなくc++のライブラリなのでPythonのctypesは使えぬ。
本家のBindingsの項に２つのpython bindingが紹介されている。</p>
<p>https://github.com/chromy/cyimgui
https://github.com/swistakm/pyimgui</p>
<p>なんかうまくいかなった。
ならばswigで自前でラップすればええやんということで、やってみる。</p>
<p>https://github.com/ousttrue/SwigImGui</p>
<p>Swig
%module swig_imgui</p>
<p>%{
/<em> Includes the header in the wrapper code </em>/</p>
<h2>include "imgui/imgui.h"</h2>
<p>%}</p>
<p>/<em> Parse the header file to generate wrappers </em>/
%include "imgui/imgui.h"</p>
<blockquote>
<p>swig -python -c++ imgui.i</p>
</blockquote>
<p>imgui_wrap.cxxと”swig_imgui.py”を生成した。
imgui_wrap.cxxから_swig_imgui.pydをビルドする。
ビルドしてみる
pythonのNativeModuleをビルドするのでsetup.pyを書いてみる。
from distutils.core import setup, Extension</p>
<p>imgui_module = Extension('_swig_imgui',
        sources=[
            'imgui_wrap.cxx',
            'imgui/imgui.cpp',
            'imgui/imgui_draw.cpp',
            'imgui/imgui_demo.cpp',
            ],
        )</p>
<p>setup (name = 'swig_imgeui',
        version = '0.1',
        author      = "ousttrue",
        description = """imgui wrapper using swig""",
        ext_modules = [imgui_module],
        py_modules = ["imgui"],
        )</p>
<p>ビルド。</p>
<blockquote>
<p>C:\python36\python.exe setup.py build</p>
</blockquote>
<p>ビルドしてみるとエラー。
swigimgui\imgui_wrap.cxx(26285): error C2668: 'ImGui::TreePush': オーバーロード関数の呼び出しを解決することができません。(新機能 ; ヘルプを参照)
swigimgui\imgui\imgui.h(338): note: 'void ImGui::TreePush(const void <em>)' の可能性があります
swigimgui\imgui\imgui.h(337): note: または 'void ImGui::TreePush(const char </em>)'
swigimgui\imgui_wrap.cxx(26285): note: 引数リスト '()' を一致させようとしているとき</p>
<p>ImGui::TreePush();がTreePush(const char<em> str_id = NULL)とTreePush(const void</em> ptr_id = NULL)でどちらなのか解決できない。
修正。
%module swig_imgui</p>
<p>%{
/<em> Includes the header in the wrapper code </em>/</p>
<h2>include "imgui/imgui.h"</h2>
<p>%}</p>
<p>%ignore ImGui::TreePush();</p>
<p>/<em> Parse the header file to generate wrappers </em>/
%include "imgui/imgui.h"</p>
<p>%include "imgui/imgui.h"の前に%ignoreを記述することで、
引数無しのTreePushを作らないようにした。
これでコンパイルは通った。
python36_d.libにリンクしない
python36_d.libではなあくpython36.libにリンクする。
imgui.iの上の方に以下の記述を追加する。
%begin %{</p>
<h2>ifdef _MSC_VER</h2>
<h2>define SWIG_PYTHON_INTERPRETER_NO_DEBUG</h2>
<h2>endif</h2>
<p>%}</p>
<p>実行してみよう</p>
<p>https://github.com/ocornut/imgui/tree/master/examples/sdl_opengl3_example</p>
<p>をまるっとpythonに移植してみる。
ここからが長くなるで。</p>
<h2>ImGui - standalone example application for SDL2 + OpenGL</h2>
<h2>If you are new to ImGui, see examples/README.txt and documentation at the top of imgui.cpp.</h2>
<p>import os
import sys</p>
<p>if not 'PYSDL2_DLL_PATH' in os.environ:
    os.environ['PYSDL2_DLL_PATH']=os.environ['VCPKG_DIR'] + '/installed/x64-windows/bin'
from sdl2 import *</p>
<p>python_dir=os.path.dirname(sys.executable)
os.environ['PATH']+=(';'+python_dir)
import swig_imgui as imgui</p>
<p>import ImplSdlGL3</p>
<p>def main():</p>
<pre class="code literal-block"><span></span><span class="err">#</span> <span class="nt">Setup</span> <span class="nt">SDL</span>
<span class="nt">if</span> <span class="o">(</span><span class="nt">SDL_Init</span><span class="o">(</span><span class="nt">SDL_INIT_VIDEO</span><span class="o">|</span><span class="nt">SDL_INIT_TIMER</span><span class="o">)</span> <span class="o">!=</span> <span class="nt">0</span><span class="o">):</span>
    <span class="nt">print</span><span class="o">(</span><span class="s2">"Error: %s\n"</span><span class="o">,</span> <span class="nt">SDL_GetError</span><span class="o">());</span>
    <span class="nt">return</span> <span class="nt">-1</span><span class="o">;</span>

<span class="err">#</span> <span class="nt">Setup</span> <span class="nt">window</span>
<span class="nt">SDL_GL_SetAttribute</span><span class="o">(</span><span class="nt">SDL_GL_CONTEXT_FLAGS</span><span class="o">,</span> <span class="nt">SDL_GL_CONTEXT_FORWARD_COMPATIBLE_FLAG</span><span class="o">);</span>
<span class="nt">SDL_GL_SetAttribute</span><span class="o">(</span><span class="nt">SDL_GL_CONTEXT_PROFILE_MASK</span><span class="o">,</span> <span class="nt">SDL_GL_CONTEXT_PROFILE_CORE</span><span class="o">);</span>
<span class="nt">SDL_GL_SetAttribute</span><span class="o">(</span><span class="nt">SDL_GL_DOUBLEBUFFER</span><span class="o">,</span> <span class="nt">1</span><span class="o">);</span>
<span class="nt">SDL_GL_SetAttribute</span><span class="o">(</span><span class="nt">SDL_GL_DEPTH_SIZE</span><span class="o">,</span> <span class="nt">24</span><span class="o">);</span>
<span class="nt">SDL_GL_SetAttribute</span><span class="o">(</span><span class="nt">SDL_GL_STENCIL_SIZE</span><span class="o">,</span> <span class="nt">8</span><span class="o">);</span>
<span class="nt">SDL_GL_SetAttribute</span><span class="o">(</span><span class="nt">SDL_GL_CONTEXT_MAJOR_VERSION</span><span class="o">,</span> <span class="nt">3</span><span class="o">);</span>
<span class="nt">SDL_GL_SetAttribute</span><span class="o">(</span><span class="nt">SDL_GL_CONTEXT_MINOR_VERSION</span><span class="o">,</span> <span class="nt">2</span><span class="o">);</span>
<span class="nt">current</span><span class="o">=</span><span class="nt">SDL_DisplayMode</span><span class="o">();</span>
<span class="nt">SDL_GetCurrentDisplayMode</span><span class="o">(</span><span class="nt">0</span><span class="o">,</span> <span class="nt">current</span><span class="o">);</span>
<span class="nt">window</span> <span class="o">=</span> <span class="nt">SDL_CreateWindow</span><span class="o">(</span><span class="nt">b</span><span class="s2">"ImGui SDL2+OpenGL3 example"</span><span class="o">,</span> <span class="nt">SDL_WINDOWPOS_CENTERED</span><span class="o">,</span> <span class="nt">SDL_WINDOWPOS_CENTERED</span><span class="o">,</span> <span class="nt">1280</span><span class="o">,</span> <span class="nt">720</span><span class="o">,</span> <span class="nt">SDL_WINDOW_OPENGL</span><span class="o">|</span><span class="nt">SDL_WINDOW_RESIZABLE</span><span class="o">);</span>
<span class="nt">glcontext</span> <span class="o">=</span> <span class="nt">SDL_GL_CreateContext</span><span class="o">(</span><span class="nt">window</span><span class="o">);</span>
<span class="p">#</span><span class="nn">gl3wInit</span><span class="o">();</span>

<span class="err">#</span> <span class="nt">Setup</span> <span class="nt">ImGui</span> <span class="nt">binding</span>
<span class="nt">ImplSdlGL3</span><span class="p">.</span><span class="nc">Init</span><span class="o">(</span><span class="nt">window</span><span class="o">);</span>

<span class="err">#</span> <span class="nt">Load</span> <span class="nt">Fonts</span>
<span class="err">#</span> <span class="o">(</span><span class="nt">there</span> <span class="nt">is</span> <span class="nt">a</span> <span class="nt">default</span> <span class="nt">font</span><span class="o">,</span> <span class="nt">this</span> <span class="nt">is</span> <span class="nt">only</span> <span class="nt">if</span> <span class="nt">you</span> <span class="nt">want</span> <span class="nt">to</span> <span class="nt">change</span> <span class="nt">it</span><span class="o">.</span> <span class="nt">see</span> <span class="nt">extra_fonts</span><span class="o">/</span><span class="nt">README</span><span class="p">.</span><span class="nc">txt</span> <span class="nt">for</span> <span class="nt">more</span> <span class="nt">details</span><span class="o">)</span>
<span class="p">#</span><span class="nn">ImGuiIO</span><span class="o">&amp;</span> <span class="nt">io</span> <span class="o">=</span> <span class="nt">imgui</span><span class="p">.</span><span class="nc">GetIO</span><span class="o">();</span>
<span class="p">#</span><span class="nn">io</span><span class="p">.</span><span class="nc">Fonts-</span><span class="o">&gt;</span><span class="nt">AddFontDefault</span><span class="o">();</span>
<span class="p">#</span><span class="nn">io</span><span class="p">.</span><span class="nc">Fonts-</span><span class="o">&gt;</span><span class="nt">AddFontFromFileTTF</span><span class="o">(</span><span class="s2">"../../extra_fonts/Cousine-Regular.ttf"</span><span class="o">,</span> <span class="nt">15</span><span class="p">.</span><span class="nc">0f</span><span class="o">);</span>
<span class="p">#</span><span class="nn">io</span><span class="p">.</span><span class="nc">Fonts-</span><span class="o">&gt;</span><span class="nt">AddFontFromFileTTF</span><span class="o">(</span><span class="s2">"../../extra_fonts/DroidSans.ttf"</span><span class="o">,</span> <span class="nt">16</span><span class="p">.</span><span class="nc">0f</span><span class="o">);</span>
<span class="p">#</span><span class="nn">io</span><span class="p">.</span><span class="nc">Fonts-</span><span class="o">&gt;</span><span class="nt">AddFontFromFileTTF</span><span class="o">(</span><span class="s2">"../../extra_fonts/ProggyClean.ttf"</span><span class="o">,</span> <span class="nt">13</span><span class="p">.</span><span class="nc">0f</span><span class="o">);</span>
<span class="p">#</span><span class="nn">io</span><span class="p">.</span><span class="nc">Fonts-</span><span class="o">&gt;</span><span class="nt">AddFontFromFileTTF</span><span class="o">(</span><span class="s2">"../../extra_fonts/ProggyTiny.ttf"</span><span class="o">,</span> <span class="nt">10</span><span class="p">.</span><span class="nc">0f</span><span class="o">);</span>
<span class="p">#</span><span class="nn">io</span><span class="p">.</span><span class="nc">Fonts-</span><span class="o">&gt;</span><span class="nt">AddFontFromFileTTF</span><span class="o">(</span><span class="s2">"c:\\Windows\\Fonts\\ArialUni.ttf"</span><span class="o">,</span> <span class="nt">18</span><span class="p">.</span><span class="nc">0f</span><span class="o">,</span> <span class="nt">NULL</span><span class="o">,</span> <span class="nt">io</span><span class="p">.</span><span class="nc">Fonts-</span><span class="o">&gt;</span><span class="nt">GetGlyphRangesJapanese</span><span class="o">());</span>

<span class="nt">show_test_window</span> <span class="o">=</span> <span class="nt">True</span><span class="o">;</span>
<span class="nt">show_another_window</span> <span class="o">=</span> <span class="nt">False</span><span class="o">;</span>
<span class="nt">clear_color</span> <span class="o">=</span> <span class="cp">[</span><span class="mi">114</span><span class="p">/</span><span class="nx">255.0</span><span class="p">,</span> <span class="mi">144</span><span class="p">/</span><span class="nx">255.0</span><span class="p">,</span> <span class="mi">154</span><span class="p">/</span><span class="nx">255.0</span><span class="cp">]</span><span class="o">;</span>

<span class="err">#</span> <span class="nt">Main</span> <span class="nt">loop</span>
<span class="nt">done</span> <span class="o">=</span> <span class="nt">False</span><span class="o">;</span>
<span class="nt">while</span> <span class="nt">not</span> <span class="nt">done</span><span class="o">:</span>

    <span class="nt">event</span><span class="o">=</span><span class="nt">SDL_Event</span><span class="o">();</span>
    <span class="nt">while</span> <span class="nt">SDL_PollEvent</span><span class="o">(</span><span class="nt">event</span><span class="o">)!=</span><span class="nt">0</span><span class="o">:</span>

        <span class="nt">ImplSdlGL3</span><span class="p">.</span><span class="nc">ProcessEvent</span><span class="o">(</span><span class="nt">event</span><span class="o">);</span>
        <span class="nt">if</span> <span class="nt">event</span><span class="p">.</span><span class="nc">type</span> <span class="o">==</span> <span class="nt">SDL_QUIT</span><span class="o">:</span>
            <span class="nt">done</span> <span class="o">=</span> <span class="nt">true</span><span class="o">;</span>

    <span class="nt">ImplSdlGL3</span><span class="p">.</span><span class="nc">NewFrame</span><span class="o">(</span><span class="nt">window</span><span class="o">);</span>

    <span class="err">#</span> <span class="nt">1</span><span class="o">.</span> <span class="nt">Show</span> <span class="nt">a</span> <span class="nt">simple</span> <span class="nt">window</span>
    <span class="err">#</span> <span class="nt">Tip</span><span class="o">:</span> <span class="nt">if</span> <span class="nt">we</span> <span class="nt">don</span><span class="err">'</span><span class="nt">t</span> <span class="nt">call</span> <span class="nt">imgui</span><span class="p">.</span><span class="nc">Begin</span><span class="o">()/</span><span class="nt">imgui</span><span class="p">.</span><span class="nc">End</span><span class="o">()</span> <span class="nt">the</span> <span class="nt">widgets</span> <span class="nt">appears</span> <span class="nt">in</span> <span class="nt">a</span> <span class="nt">window</span> <span class="nt">automatically</span> <span class="nt">called</span> <span class="s2">"Debug"</span>

    <span class="nt">f</span> <span class="o">=</span> <span class="nt">0</span><span class="p">.</span><span class="nc">0</span><span class="o">;</span>
    <span class="nt">imgui</span><span class="p">.</span><span class="nc">Text</span><span class="o">(</span><span class="s2">"Hello, world!"</span><span class="o">);</span>
    <span class="nt">imgui</span><span class="p">.</span><span class="nc">SliderFloat</span><span class="o">(</span><span class="s2">"float"</span><span class="o">,</span> <span class="nt">f</span><span class="o">,</span> <span class="nt">0</span><span class="p">.</span><span class="nc">0</span><span class="o">,</span> <span class="nt">1</span><span class="p">.</span><span class="nc">0</span><span class="o">);</span>
    <span class="nt">imgui</span><span class="p">.</span><span class="nc">ColorEdit3</span><span class="o">(</span><span class="s2">"clear color"</span><span class="o">,</span> <span class="nt">clear_color</span><span class="o">);</span>
    <span class="nt">if</span> <span class="nt">imgui</span><span class="p">.</span><span class="nc">Button</span><span class="o">(</span><span class="s2">"Test Window"</span><span class="o">):</span> <span class="nt">show_test_window</span> <span class="o">^=</span> <span class="nt">1</span><span class="o">;</span>
    <span class="nt">if</span> <span class="nt">imgui</span><span class="p">.</span><span class="nc">Button</span><span class="o">(</span><span class="s2">"Another Window"</span><span class="o">):</span> <span class="nt">show_another_window</span> <span class="o">^=</span> <span class="nt">1</span><span class="o">;</span>
    <span class="nt">imgui</span><span class="p">.</span><span class="nc">Text</span><span class="o">(</span><span class="s2">"Application average %.3f ms/frame (%.1f FPS)"</span><span class="o">,</span> <span class="nt">1000</span><span class="p">.</span><span class="nc">0</span> <span class="o">/</span> <span class="nt">imgui</span><span class="p">.</span><span class="nc">GetIO</span><span class="o">()</span><span class="p">.</span><span class="nc">Framerate</span><span class="o">,</span> <span class="nt">imgui</span><span class="p">.</span><span class="nc">GetIO</span><span class="o">()</span><span class="p">.</span><span class="nc">Framerate</span><span class="o">);</span>

    <span class="err">#</span> <span class="nt">2</span><span class="o">.</span> <span class="nt">Show</span> <span class="nt">another</span> <span class="nt">simple</span> <span class="nt">window</span><span class="o">,</span> <span class="nt">this</span> <span class="nt">time</span> <span class="nt">using</span> <span class="nt">an</span> <span class="nt">explicit</span> <span class="nt">Begin</span><span class="o">/</span><span class="nt">End</span> <span class="nt">pair</span>
    <span class="nt">if</span> <span class="nt">show_another_window</span><span class="o">:</span>
        <span class="nt">imgui</span><span class="p">.</span><span class="nc">SetNextWindowSize</span><span class="o">(</span><span class="nt">ImVec2</span><span class="o">(</span><span class="nt">200</span><span class="o">,</span><span class="nt">100</span><span class="o">),</span> <span class="nt">ImGuiSetCond_FirstUseEver</span><span class="o">);</span>
        <span class="nt">imgui</span><span class="p">.</span><span class="nc">Begin</span><span class="o">(</span><span class="s2">"Another Window"</span><span class="o">,</span> <span class="nt">show_another_window</span><span class="o">);</span>
        <span class="nt">imgui</span><span class="p">.</span><span class="nc">Text</span><span class="o">(</span><span class="s2">"Hello"</span><span class="o">);</span>
        <span class="nt">imgui</span><span class="p">.</span><span class="nc">End</span><span class="o">();</span>

    <span class="err">#</span> <span class="nt">3</span><span class="o">.</span> <span class="nt">Show</span> <span class="nt">the</span> <span class="nt">ImGui</span> <span class="nt">test</span> <span class="nt">window</span><span class="o">.</span> <span class="nt">Most</span> <span class="nt">of</span> <span class="nt">the</span> <span class="nt">sample</span> <span class="nt">code</span> <span class="nt">is</span> <span class="nt">in</span> <span class="nt">imgui</span><span class="p">.</span><span class="nc">ShowTestWindow</span><span class="o">()</span>
    <span class="nt">if</span> <span class="nt">show_test_window</span><span class="o">:</span>
        <span class="nt">imgui</span><span class="p">.</span><span class="nc">SetNextWindowPos</span><span class="o">(</span><span class="nt">ImVec2</span><span class="o">(</span><span class="nt">650</span><span class="o">,</span> <span class="nt">20</span><span class="o">),</span> <span class="nt">ImGuiSetCond_FirstUseEver</span><span class="o">);</span>
        <span class="nt">imgui</span><span class="p">.</span><span class="nc">ShowTestWindow</span><span class="o">(</span><span class="nt">show_test_window</span><span class="o">);</span>

    <span class="err">#</span> <span class="nt">Rendering</span>
    <span class="nt">glViewport</span><span class="o">(</span><span class="nt">0</span><span class="o">,</span> <span class="nt">0</span><span class="o">,</span> <span class="nt">int</span><span class="o">(</span><span class="nt">imgui</span><span class="p">.</span><span class="nc">GetIO</span><span class="o">()</span><span class="p">.</span><span class="nc">DisplaySize</span><span class="p">.</span><span class="nc">x</span><span class="o">),</span> <span class="nt">int</span><span class="o">(</span><span class="nt">imgui</span><span class="p">.</span><span class="nc">GetIO</span><span class="o">()</span><span class="p">.</span><span class="nc">DisplaySize</span><span class="p">.</span><span class="nc">y</span><span class="o">));</span>
    <span class="nt">glClearColor</span><span class="o">(</span><span class="nt">clear_color</span><span class="p">.</span><span class="nc">x</span><span class="o">,</span> <span class="nt">clear_color</span><span class="p">.</span><span class="nc">y</span><span class="o">,</span> <span class="nt">clear_color</span><span class="p">.</span><span class="nc">z</span><span class="o">,</span> <span class="nt">clear_color</span><span class="p">.</span><span class="nc">w</span><span class="o">);</span>
    <span class="nt">glClear</span><span class="o">(</span><span class="nt">GL_COLOR_BUFFER_BIT</span><span class="o">);</span>
    <span class="nt">imgui</span><span class="p">.</span><span class="nc">Render</span><span class="o">();</span>
    <span class="nt">SDL_GL_SwapWindow</span><span class="o">(</span><span class="nt">window</span><span class="o">);</span>

<span class="err">#</span> <span class="nt">Cleanup</span>
<span class="nt">ImplSdlGL3</span><span class="p">.</span><span class="nc">Shutdown</span><span class="o">();</span>
<span class="nt">SDL_GL_DeleteContext</span><span class="o">(</span><span class="nt">glcontext</span><span class="o">);</span>
<span class="nt">SDL_DestroyWindow</span><span class="o">(</span><span class="nt">window</span><span class="o">);</span>
<span class="nt">SDL_Quit</span><span class="o">();</span>

<span class="nt">return</span> <span class="nt">0</span><span class="o">;</span>
</pre>

<p>if <strong>name</strong>=='<strong>main</strong>':
    main()</p>
<p>ImplSdlGL3.py
def Init(window):
    pass</p>
<p>def ProcessEvent(event):
    pass</p>
<p>def NewFrame(window):
    pass</p>
<p>pydのサーチ
環境変数PATH
環境変数PYSDL2_DLL_PATH
実行
諸々、正しく初期化していないのでクラッシュする。
Initを移植
import swig_imgui as imgui
from sdl2 import *</p>
<p>def Init(window):
    io = imgui.GetIO();
    #io.KeyMap[imgui.ImGuiKey_Tab] = SDLK_TAB;
    io.KeyMap[imgui.ImGuiKey_LeftArrow] = SDL_SCANCODE_LEFT;
    io.KeyMap[imgui.ImGuiKey_RightArrow] = SDL_SCANCODE_RIGHT;
    io.KeyMap[imgui.ImGuiKey_UpArrow] = SDL_SCANCODE_UP;
    io.KeyMap[imgui.ImGuiKey_DownArrow] = SDL_SCANCODE_DOWN;
    io.KeyMap[imgui.ImGuiKey_PageUp] = SDL_SCANCODE_PAGEUP;
    io.KeyMap[imgui.ImGuiKey_PageDown] = SDL_SCANCODE_PAGEDOWN;
    io.KeyMap[imgui.ImGuiKey_Home] = SDL_SCANCODE_HOME;
    io.KeyMap[imgui.ImGuiKey_End] = SDL_SCANCODE_END;
    io.KeyMap[imgui.ImGuiKey_Delete] = SDLK_DELETE;
    io.KeyMap[imgui.ImGuiKey_Backspace] = SDLK_BACKSPACE;
    io.KeyMap[imgui.ImGuiKey_Enter] = SDLK_RETURN;
    io.KeyMap[imgui.ImGuiKey_Escape] = SDLK_ESCAPE;
    io.KeyMap[imgui.ImGuiKey_A] = SDLK_a;
    io.KeyMap[imgui.ImGuiKey_C] = SDLK_c;
    io.KeyMap[imgui.ImGuiKey_V] = SDLK_v;
    io.KeyMap[imgui.ImGuiKey_X] = SDLK_x;
    io.KeyMap[imgui.ImGuiKey_Y] = SDLK_y;
    io.KeyMap[imgui.ImGuiKey_Z] = SDLK_z;</p>
<pre class="code literal-block"><span></span># Alternatively you can set this to NULL and call imgui.GetDrawData() after imgui.Render() to get the same ImDrawData pointer.
io.RenderDrawListsFn = ImGui_ImplSdlGL3_RenderDrawLists;
io.SetClipboardTextFn = ImGui_ImplSdlGL3_SetClipboardText;
io.GetClipboardTextFn = ImGui_ImplSdlGL3_GetClipboardText;
#io.ClipboardUserData = NULL;
</pre>

<h2>ifdef _WIN32</h2>
<pre class="code literal-block"><span></span>wmInfo=SDL_SysWMinfo();
SDL_VERSION(wmInfo.version);
SDL_GetWindowWMInfo(window, wmInfo);
io.ImeWindowHandle = wmInfo.info.win.window;
</pre>

<h2>else</h2>
<pre class="code literal-block"><span></span>#(void)window;
</pre>

<h2>endif</h2>
<pre class="code literal-block"><span></span>return True;
</pre>

<p>実行してエラーをつぶしていく。
int型配列へのindexを使った代入
冒頭のio.KeyMap[imgui.ImGuiKey_LeftArrow] = SDL_SCANCODE_LEFT;がエラーになる。
io.KeyMap[imgui.ImGuiKey_LeftArrow] = SDL_SCANCODE_LEFT;
TypeError: 'SwigPyObject' object does not support item assignment</p>
<p>io.KeyMapのCでの型。
int           KeyMap[ImGuiKey_COUNT];</p>
<p>単なる配列へのアクセス。KeyMapをlist的なオブジェクトとしてpython側に公開するよりも、ioにセッターを実装することにした。
imgui.iに追加。
%extend ImGuiIO {
    void SetKeyMap(int k, int v)
    {
        ImGui::GetIO().KeyMap[k]=v;
    }
}</p>
<p>pythonでは次のように使う。
io.SetKeyMap(imgui.ImGuiKey_LeftArrow, SDL_SCANCODE_LEFT);</p>
<p>関数ポインタ型にpythonの関数を代入。
swig的にはこれがいちばんの難問である。
関数ポインタを変数に代入するのがエラーになる。
def RenderDrawLists():
    pass</p>
<p>io.RenderDrawListsFn = RenderDrawLists;</p>
<p>TypeError: in method 'ImGuiIO_RenderDrawListsFn_set', argument 2 of type 'void (<em>)(ImDrawData </em>)'
Press any key to continue . . .</p>
<p>そりゃ、pythonの関数をこれに代入するのは無理だ。
解決方法は、以下のようにする。
imgui.iに追記。場所に注意が必要。
%{
static void PythonRenderDrawListsFn(ImDrawData<em> data)
{
    auto func=(PyObject</em>)ImGui::GetIO().UserData; // Get Python function
    auto obj = SWIG_NewPointerObj(SWIG_as_voidptr(data)
    , SWIGTYPE_p_ImDrawData, 0 |  0 );
    auto arglist = Py_BuildValue("(O)",obj); // Build argument list
    PyEval_CallObject(func, arglist); // Call Python
    Py_DECREF(arglist); // Trash arglist
    Py_DECREF(obj);
}
%}</p>
<p>// before
%include "imgui/imgui.h"
// after</p>
<p>%extend ImGuiIO {
    void SetRenderDrawListsFn(PyObject *pyfunc) {
        ImGui::GetIO().UserData=pyfunc;
        self-&gt;RenderDrawListsFn=PythonRenderDrawListsFn;
        Py_INCREF(pyfunc);
    }
}</p>
<p>残り２つの関数ポインタも同様の対応で行けると思うがコメントアウトして飛ばした。
io.SetClipboardTextFn = ImGui_ImplSdlGL3_SetClipboardText;
io.GetClipboardTextFn = ImGui_ImplSdlGL3_GetClipboardText;</p>
<p>void*の代入
io.ImeWindowHandle = wmInfo.info.win.window;</p>
<p>TypeError: in method 'ImGuiIO_ImeWindowHandle_set', argument 2 of type 'void *'</p>
<p>セッターを作った。
%extend ImGuiIO {
    void SetImeWindowHandle(long long v)
    {
        ImGui::GetIO().ImeWindowHandle = (void*)v;
    }
}</p>
<p>NewFrameの移植
def CreateDeviceObjects():
    pass</p>
<p>g_MousePressed=[False, False, False]
g_MouseWheel=None
def NewFrame(window):
    if not g_FontTexture:
        CreateDeviceObjects();</p>
<pre class="code literal-block"><span></span>io = imgui.GetIO();

# Setup display size (every frame to accommodate for window resizing)
w, h=SDL_GetWindowSize(window);
display_w, display_h=SDL_GL_GetDrawableSize(window);
io.DisplaySize = imgui.ImVec2(w, h);
io.DisplayFramebufferScale = ImVec2(
    (display_w / float(w)) if w &gt; 0 else 0, 
    (display_h / float(h)) if h &gt; 0 else 0);

# Setup time step
time = SDL_GetTicks();
current_time = time / 1000.0;
io.DeltaTime = (current_time - g_Time) if g_Time &gt; 0.0 else (1.0 / 60.0);
g_Time = current_time;

# Setup inputs
# (we already got mouse wheel, keyboard keys &amp; characters from SDL_PollEvent())
mouseMask, mx, my = SDL_GetMouseState();
if (SDL_GetWindowFlags(window) &amp; SDL_WINDOW_MOUSE_FOCUS):
    # Mouse position, in pixels (set to -1,-1 if no mouse / on another screen, etc.)
    io.MousePos = ImVec2(mx, my);   
else:
    io.MousePos = ImVec2(-1, -1);

# If a mouse press event came, always pass it as "mouse held this frame", so we don't miss click-release events that are shorter than 1 frame.
io.MouseDown[0] = g_MousePressed[0] or (mouseMask &amp; SDL_BUTTON(SDL_BUTTON_LEFT)) != 0;      
io.MouseDown[1] = g_MousePressed[1] or (mouseMask &amp; SDL_BUTTON(SDL_BUTTON_RIGHT)) != 0;
io.MouseDown[2] = g_MousePressed[2] or (mouseMask &amp; SDL_BUTTON(SDL_BUTTON_MIDDLE)) != 0;
g_MousePressed[0] = g_MousePressed[1] = g_MousePressed[2] = False;

io.MouseWheel = g_MouseWheel;
g_MouseWheel = 0.0;

# Hide OS mouse cursor if ImGui is drawing it
SDL_ShowCursor(0 if io.MouseDrawCursor else 1);

# Start the frame
imgui.NewFrame();
</pre>

<p>io.MouseDown
セッター。
%extend ImGuiIO {
    void SetMouseDown(int k, int v)
    {
        ImGui::GetIO().MouseDown[k]=v;
    }
}</p>
<p>CreateDeviceObjectsの移植
    # Backup GL state
    last_texture=glGetIntegerv(GL_TEXTURE_BINDING_2D);
    last_array_buffer=glGetIntegerv(GL_ARRAY_BUFFER_BINDING);
    last_vertex_array=glGetIntegerv(GL_VERTEX_ARRAY_BINDING);</p>
<pre class="code literal-block"><span></span>vertex_shader =b'''#version 330
</pre>

<p>uniform mat4 ProjMtx;
in vec2 Position;
in vec2 UV;
in vec4 Color;
out vec2 Frag_UV;
out vec4 Frag_Color;
void main()
{
    Frag_UV = UV;
    Frag_Color = Color;
    gl_Position = ProjMtx * vec4(Position.xy,0,1);
};
'''</p>
<pre class="code literal-block"><span></span>fragment_shader =b'''#version 330
</pre>

<p>uniform sampler2D Texture;
in vec2 Frag_UV;
in vec4 Frag_Color;
out vec4 Out_Color;
void main()
{
    Out_Color = Frag_Color * texture( Texture, Frag_UV.st);
};
'''</p>
<pre class="code literal-block"><span></span>g_ShaderHandle = glCreateProgram();
g_VertHandle = glCreateShader(GL_VERTEX_SHADER);
g_FragHandle = glCreateShader(GL_FRAGMENT_SHADER);
glShaderSource(g_VertHandle, vertex_shader);
glShaderSource(g_FragHandle, fragment_shader);
glCompileShader(g_VertHandle);
glCompileShader(g_FragHandle);
glAttachShader(g_ShaderHandle, g_VertHandle);
glAttachShader(g_ShaderHandle, g_FragHandle);
glLinkProgram(g_ShaderHandle);

g_AttribLocationTex = glGetUniformLocation(g_ShaderHandle, "Texture");
g_AttribLocationProjMtx = glGetUniformLocation(g_ShaderHandle, "ProjMtx");
g_AttribLocationPosition = glGetAttribLocation(g_ShaderHandle, "Position");
g_AttribLocationUV = glGetAttribLocation(g_ShaderHandle, "UV");
g_AttribLocationColor = glGetAttribLocation(g_ShaderHandle, "Color");

g_VboHandle=glGenBuffers(1);
g_ElementsHandle=glGenBuffers(1);

g_VaoHandle=glGenVertexArrays(1);
glBindVertexArray(g_VaoHandle);
glBindBuffer(GL_ARRAY_BUFFER, g_VboHandle);
glEnableVertexAttribArray(g_AttribLocationPosition);
glEnableVertexAttribArray(g_AttribLocationUV);
glEnableVertexAttribArray(g_AttribLocationColor);
</pre>

<h2>define OFFSETOF(TYPE, ELEMENT) ((size_t)&amp;(((TYPE *)0)-&gt;ELEMENT))</h2>
<pre class="code literal-block"><span></span>SIZEOF_ImDrawVert=20
glVertexAttribPointer(g_AttribLocationPosition, 2, GL_FLOAT, GL_FALSE, SIZEOF_ImDrawVert, ctypes.c_void_p(0));
glVertexAttribPointer(g_AttribLocationUV, 2, GL_FLOAT, GL_FALSE, SIZEOF_ImDrawVert, ctypes.c_void_p(8));
glVertexAttribPointer(g_AttribLocationColor, 4, GL_UNSIGNED_BYTE, GL_TRUE, SIZEOF_ImDrawVert, ctypes.c_void_p(16));
</pre>

<h2>undef OFFSETOF</h2>
<pre class="code literal-block"><span></span>CreateFontsTexture();

# Restore modified GL state
glBindTexture(GL_TEXTURE_2D, last_texture);
glBindBuffer(GL_ARRAY_BUFFER, last_array_buffer);
glBindVertexArray(last_vertex_array);

return True;
</pre>

<p>sizeof
%constant int SIZEOF_ImDrawVert = sizeof(ImDrawVert);
%constant int SIZEOF_ImDrawIdx = sizeof(ImDrawIdx);</p>
<p>offset
%{</p>
<h2>define OFFSETOF(TYPE, ELEMENT) ((size_t)&amp;(((TYPE *)0)-&gt;ELEMENT))</h2>
<p>const int OFFSETOF_ImDrawVert_pos = OFFSETOF(ImDrawVert, pos);
const int OFFSETOF_ImDrawVert_uv = OFFSETOF(ImDrawVert, uv);
const int OFFSETOF_ImDrawVert_col = OFFSETOF(ImDrawVert, col);</p>
<h2>undef OFFSETOF</h2>
<p>%}
const int OFFSETOF_ImDrawVert_pos = OFFSETOF_ImDrawVert_pos;
const int OFFSETOF_ImDrawVert_uv = OFFSETOF_ImDrawVert_uv;
const int OFFSETOF_ImDrawVert_col = OFFSETOF_ImDrawVert_col;</p>
<p>CreateFontsTextureの移植
def CreateFontsTexture():
    # Build texture atlas
    io = imgui.GetIO();
    # Load as RGBA 32-bits for OpenGL3 demo because it is more likely to be compatible with user's existing shader.
    pixels, width, height=io.Fonts.GetTexDataAsRGBA32();</p>
<pre class="code literal-block"><span></span># Upload texture to graphics system
last_texture=glGetIntegerv(GL_TEXTURE_BINDING_2D);
g_FontTexture=glGenTextures(1);
glBindTexture(GL_TEXTURE_2D, g_FontTexture);
glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_MIN_FILTER, GL_LINEAR);
glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_MAG_FILTER, GL_LINEAR);
glPixelStorei(GL_UNPACK_ROW_LENGTH, 0);
glTexImage2D(GL_TEXTURE_2D, 0, GL_RGBA, width, height, 0, GL_RGBA, GL_UNSIGNED_BYTE, pixels);

# Store our identifier
io.Fonts.TexID = g_FontTexture;

# Restore state
glBindTexture(GL_TEXTURE_2D, last_texture);
</pre>

<p>値を返すためにポインタ引数を出力に使い(in + argout)、長さの分かっているバイト列へのポインタをbytesとして返す
対象はこれ。
IMGUI_API void GetTexDataAsRGBA32(unsigned char<em><em> out_pixels, int</em> out_width, int</em> out_height, int* out_bytes_per_pixel = NULL);</p>
<p>typemapでやってみる。
imgui.iの%include "imgui/imgui.h"より前に記述。
%typemap(in, numinputs=0) (unsigned char<strong> out_pixels, int<em> out_width, int</em> out_height, int<em> out_bytes_per_pixel) (unsigned char </em>tempP, int tempW, int tempH, int tempB) {
    $1 = &amp;tempP;
    $2 = &amp;tempW;
    $3 = &amp;tempH;
    $4 = &amp;tempB;
}
%typemap(argout)(unsigned char</strong> out_pixels, int<em> out_width, int</em> out_height, int<em> out_bytes_per_pixel){
    auto b = PyBytes_FromStringAndSize((const char </em>)<em>$1, (</em>$2) * (<em>$3) * (</em>$4));
    auto w = PyLong_FromLong(<em>$2);
    auto h = PyLong_FromLong(</em>$3);</p>
<pre class="code literal-block"><span></span>if ((!$result) || ($result == Py_None)) {
    // new tuple3
    $result = PyTuple_New(3);
    PyTuple_SetItem($result, 0, b);
    PyTuple_SetItem($result, 1, w);
    PyTuple_SetItem($result, 2, h);
}
else{
    if (!PyTuple_Check($result)) {
        // new tuple4
        auto t= PyTuple_New(4);
        PyTuple_SetItem(t, 0, $result);
        PyTuple_SetItem(t, 1, b);
        PyTuple_SetItem(t, 2, w);
        PyTuple_SetItem(t, 3, h);
        $result=t;
    }
    else {
        // concat
        auto head = $result;
        auto tail = PyTuple_New(3);
        PyTuple_SetItem($result, 0, b);
        PyTuple_SetItem($result, 1, w);
        PyTuple_SetItem($result, 2, h);
        $result = PySequence_Concat(head, tail);
        Py_DECREF(head);
        Py_DECREF(tail);
    }
}
</pre>

<p>}</p>
<p>typemap(in)で呼び出し時に出力変数を与える必要を無くして、typemap(argout)で呼び出し後の返り値をtuple化して値を詰める。その際に、バイト列のサイズが計算できるのでPyBytes_FromStringAndSizeでbytesを作る。
TexIDのセッター
intからvoid*への変換。
%extend ImFontAtlas {
    void SetTexID(long long id) {
        self-&gt;TexID=reinterpret_cast<void>(id);
    }
}</void></p>
<p>ここまで実装するとTextureのnullptrでプログラムがクラッシュしなくなる。
imguiのwidgetに対するinoutな引数
float<em>
IMGUI_API bool SliderFloat(const char</em> label, float<em> v, float v_min, float v_max, const char</em> display_format = "%.3f", float power = 1.0f);</p>
<p>argoutにすると返り値が(bool, float)になっていまいちな気がする。
swigでfloat*型のヘルパークラスを作る。
%include "cpointer.i"
%pointer_functions(float, floatp);</p>
<p>f=imgui.new_floatp()
imgui.floatp_assign(f, 0.0)
imgui.SliderFloat("float", f, 0.0, 1.0);</p>
<p>bool<em>
floatと同様に。
IMGUI_API void ShowTestWindow(bool</em> p_open = NULL);</p>
<p>%include "cpointer.i"
%pointer_functions(bool, boolp);</p>
<pre class="code literal-block"><span></span>show_test_window = imgui.new_boolp();
imgui.boolp_assign(show_test_window, True)

if imgui.Button("Test Window"): imgui.boolp_assign(show_test_window, not boolp_assign.value))

if imgui.boolp_value(show_test_window):
    imgui.SetNextWindowPos(imgui.ImVec2(650, 20), imgui.ImGuiSetCond_FirstUseEver);
    imgui.ShowTestWindow(show_test_window);
</pre>

<p>動くとはいえこれはいかんな。ポインタクラスをもう少し便利にするか、別の方法を調べよう。
float[3]
IMGUI_API bool ColorEdit3(const char* label, float col[3]);</p>
<p>typemapでlistリストを受け取って、listに結果を格納するように記述する。
%typemap(in) float col[3] (float temp[3]) {
    if (!PySequence_Check($input)) {
        PyErr_SetString(PyExc_ValueError,"Expected a sequence");
        return NULL;
    }
    if (PySequence_Length($input) &lt; $1_dim0) {
        PyErr_SetString(PyExc_ValueError,"Size mismatch. Expected more than $1_dim0 elements");
        return NULL;
    }
    for (int i = 0; i &lt; $1_dim0; i++) {
        PyObject <em>o = PySequence_GetItem($input,i);
        if (PyNumber_Check(o)) {
            temp[i] = (float) PyFloat_AsDouble(o);
        }
        else {
            PyErr_SetString(PyExc_ValueError,"Sequence elements must be numbers");
            return NULL;
        }
    }
    $1 = temp;
}
%typemap(argout) float col[3] {
    for (int i = 0; i &lt; $1_dim0; i++) {
        PyObject </em>o = PyFloat_FromDouble((double) $1[i]);
        PyList_SetItem($input, i, o);
    }
}</p>
<p>clear_color = [114/255.0, 144/255.0, 154/255.0, 0];
imgui.ColorEdit3("clear color", clear_color);</p>
<p>RenderDrawListsの移植
def RenderDrawLists(draw_data):
    global g_ShaderHandle</p>
<pre class="code literal-block"><span></span># Avoid rendering when minimized, scale coordinates for retina displays (screen coordinates != framebuffer coordinates)
io = imgui.GetIO();
fb_width = int(io.DisplaySize.x * io.DisplayFramebufferScale.x);
fb_height = int(io.DisplaySize.y * io.DisplayFramebufferScale.y);
if fb_width == 0 or fb_height == 0:
    return;
draw_data.ScaleClipRects(io.DisplayFramebufferScale);

# Backup GL state
last_active_texture=glGetIntegerv(GL_ACTIVE_TEXTURE);
glActiveTexture(GL_TEXTURE0);
last_program=glGetIntegerv(GL_CURRENT_PROGRAM);
last_texture=glGetIntegerv(GL_TEXTURE_BINDING_2D);
last_array_buffer=glGetIntegerv(GL_ARRAY_BUFFER_BINDING);
last_element_array_buffer=glGetIntegerv(GL_ELEMENT_ARRAY_BUFFER_BINDING);
last_vertex_array=glGetIntegerv(GL_VERTEX_ARRAY_BINDING);
last_blend_src_rgb=glGetIntegerv(GL_BLEND_SRC_RGB);
last_blend_dst_rgb=glGetIntegerv(GL_BLEND_DST_RGB);
last_blend_src_alpha=glGetIntegerv(GL_BLEND_SRC_ALPHA);
last_blend_dst_alpha=glGetIntegerv(GL_BLEND_DST_ALPHA);
last_blend_equation_rgb=glGetIntegerv(GL_BLEND_EQUATION_RGB);
last_blend_equation_alpha=glGetIntegerv(GL_BLEND_EQUATION_ALPHA);
last_viewport=glGetIntegerv(GL_VIEWPORT);
last_scissor_box=glGetIntegerv(GL_SCISSOR_BOX);
last_enable_blend = glIsEnabled(GL_BLEND);
last_enable_cull_face = glIsEnabled(GL_CULL_FACE);
last_enable_depth_test = glIsEnabled(GL_DEPTH_TEST);
last_enable_scissor_test = glIsEnabled(GL_SCISSOR_TEST);

# Setup render state: alpha-blending enabled, no face culling, no depth testing, scissor enabled
glEnable(GL_BLEND);
glBlendEquation(GL_FUNC_ADD);
glBlendFunc(GL_SRC_ALPHA, GL_ONE_MINUS_SRC_ALPHA);
glDisable(GL_CULL_FACE);
glDisable(GL_DEPTH_TEST);
glEnable(GL_SCISSOR_TEST);

# Setup viewport, orthographic projection matrix
glViewport(0, 0, fb_width, fb_height);
ortho_projection = (ctypes.c_float * 16)(
     2.0/io.DisplaySize.x, 0.0,                   0.0, 0.0,
     0.0,                  2.0/-io.DisplaySize.y, 0.0, 0.0,
     0.0,                  0.0,                  -1.0, 0.0,
    -1.0,                  1.0,                   0.0, 1.0,
);
glUseProgram(g_ShaderHandle);
glUniform1i(g_AttribLocationTex, 0);
glUniformMatrix4fv(g_AttribLocationProjMtx, 1, GL_FALSE, ortho_projection);
glBindVertexArray(g_VaoHandle);

for n in range(draw_data.CmdListsCount):

    cmd_list = draw_data.CmdLists[n];
    idx_buffer_offset = 0;

    glBindBuffer(GL_ARRAY_BUFFER, g_VboHandle);
    glBufferData(GL_ARRAY_BUFFER, cmd_list.VtxBuffer.Size * SIZEOF_ImDrawVert, cmd_list.VtxBuffer.Data, GL_STREAM_DRAW);

    glBindBuffer(GL_ELEMENT_ARRAY_BUFFER, g_ElementsHandle);
    glBufferData(GL_ELEMENT_ARRAY_BUFFER, cmd_list.IdxBuffer.Size * SIZEOF_ImDrawVert, cmd_list.IdxBuffer.Data, GL_STREAM_DRAW);

    for cmd_i in range(cmd_list.CmdBuffer.Size):

        pcmd = cmd_list.CmdBuffer[cmd_i];
        if pcmd.UserCallback:
            pcmd.UserCallback(cmd_list, pcmd);
        else:
            glBindTexture(GL_TEXTURE_2D, pcmd.TextureId);
            glScissor(pcmd.ClipRect.x, (fb_height - pcmd.ClipRect.w), (pcmd.ClipRect.z - pcmd.ClipRect.x), (pcmd.ClipRect.w - pcmd.ClipRect.y));
            glDrawElements(GL_TRIANGLES, pcmd.ElemCount, GL_UNSIGNED_SHORT, idx_buffer_offset);

        idx_buffer_offset += pcmd.ElemCount;

# Restore modified GL state
glUseProgram(last_program);
glBindTexture(GL_TEXTURE_2D, last_texture);
glActiveTexture(last_active_texture);
glBindVertexArray(last_vertex_array);
glBindBuffer(GL_ARRAY_BUFFER, last_array_buffer);
glBindBuffer(GL_ELEMENT_ARRAY_BUFFER, last_element_array_buffer);
glBlendEquationSeparate(last_blend_equation_rgb, last_blend_equation_alpha);
glBlendFuncSeparate(last_blend_src_rgb, last_blend_dst_rgb, last_blend_src_alpha, last_blend_dst_alpha);
if (last_enable_blend): 
    glEnable(GL_BLEND); 
else: 
    glDisable(GL_BLEND);
if (last_enable_cull_face): 
    glEnable(GL_CULL_FACE); 
else: 
    glDisable(GL_CULL_FACE);
if (last_enable_depth_test): 
    glEnable(GL_DEPTH_TEST);
else: 
    glDisable(GL_DEPTH_TEST);
if (last_enable_scissor_test): 
    glEnable(GL_SCISSOR_TEST); 
else: 
    glDisable(GL_SCISSOR_TEST);
glViewport(last_viewport[0], last_viewport[1], last_viewport[2], last_viewport[3]);
glScissor(last_scissor_box[0], last_scissor_box[1], last_scissor_box[2], last_scissor_box[3]);
</pre>

<p>getter
配列アクセスできない。
cmd_list = draw_data.CmdLists[n]</p>
<p>ゲッターを実装する
%extend ImDrawData {
    ImDrawList* GetCmdList(int n){
        return self-&gt;CmdLists[n];
    }
}</p>
<p>templateの型定義が無い
実装する型を明示する。
%template(ImVectorDrawVert) ImVector<imdrawvert>;
%template(ImVectorDrawIdx) ImVector<imdrawidx>;
%template(ImVectorDrawCmd) ImVector<imdrawcmd>;</imdrawcmd></imdrawidx></imdrawvert></p>
<p>Byte列を得る
cmd_list.VtxBuffer.Data</p>
<p>%typemap(in, numinputs=0) (unsigned char<strong> out_bytes, int<em> out_size) (unsigned char </em>tempP, int tempSize) {
    $1 = &amp;tempP;
    $2 = &amp;tempSize;
}
%typemap(argout)(unsigned char</strong> out_bytes, int<em> out_size){
    auto b = PyBytes_FromStringAndSize((const char </em>)<em>$1, </em>$2);</p>
<pre class="code literal-block"><span></span>if ((!$result) || ($result == Py_None)) {
    $result = b;
}
else{
    if (!PyTuple_Check($result)) {
        // new tuple4
        auto t= PyTuple_New(2);
        PyTuple_SetItem(t, 0, $result);
        PyTuple_SetItem(t, 1, b);
        $result=t;
    }
    else {
        // concat
        auto head = $result;
        auto tail = PyTuple_New(1);
        PyTuple_SetItem($result, 0, b);
        $result = PySequence_Concat(head, tail);
        Py_DECREF(head);
        Py_DECREF(tail);
    }
}
</pre>

<p>}</p>
<p>// before
%include "imgui/imgui.h"
// after</p>
<p>%extend ImDrawList {
    void GetVtxBufferData(unsigned char <strong>out_bytes, int <em>out_size){
        </em>out_bytes=(unsigned char <em>)self-&gt;VtxBuffer.Data;
        </em>out_size=self-&gt;VtxBuffer.Size * sizeof(self-&gt;VtxBuffer.Data[0]);
    }
    void GetIdxBufferData(unsigned char </strong>out_bytes, int <em>out_size){
        </em>out_bytes=(unsigned char <em>)self-&gt;IdxBuffer.Data;
        </em>out_size=self-&gt;IdxBuffer.Size * sizeof(self-&gt;IdxBuffer.Data[0]);
    }
}</p>
<p>glBindBuffer(GL_ARRAY_BUFFER, g_VboHandle);
glBufferData(GL_ARRAY_BUFFER, cmd_list.VtxBuffer.Size * SIZEOF_ImDrawVert, cmd_list.GetVtxBufferData(), GL_STREAM_DRAW);</p>
<p>glBindBuffer(GL_ELEMENT_ARRAY_BUFFER, g_ElementsHandle);
glBufferData(GL_ELEMENT_ARRAY_BUFFER, cmd_list.IdxBuffer.Size * SIZEOF_Idx, cmd_list.GetIdxBufferData(), GL_STREAM_DRAW);</p>
<p>Shutdownの移植
def Shutdown():
    InvalidateDeviceObjects();
    imgui.Shutdown();</p>
<p>def InvalidateDeviceObjects():
    global g_VaoHandle
    global g_VboHandle
    global g_ElementsHandle
    global g_ShaderHandle
    global g_VertHandle
    global g_FragHandle
    global g_FontTexture</p>
<pre class="code literal-block"><span></span>if (g_VaoHandle): glDeleteVertexArrays(1, g_VaoHandle);
if (g_VboHandle): glDeleteBuffers(1, g_VboHandle);
if (g_ElementsHandle): glDeleteBuffers(1, g_ElementsHandle);
g_VaoHandle = g_VboHandle = g_ElementsHandle = 0;

if (g_ShaderHandle and g_VertHandle): glDetachShader(g_ShaderHandle, g_VertHandle);
if (g_VertHandle): glDeleteShader(g_VertHandle);
g_VertHandle = 0;

if (g_ShaderHandle and g_FragHandle): glDetachShader(g_ShaderHandle, g_FragHandle);
if (g_FragHandle): glDeleteShader(g_FragHandle);
g_FragHandle = 0;

if (g_ShaderHandle): glDeleteProgram(g_ShaderHandle);
g_ShaderHandle = 0;

if (g_FontTexture):
    glDeleteTextures(1, g_FontTexture);
    imgui.GetIO().Fonts.SetTexID(0);
    g_FontTexture = 0;
</pre>

<p>ProcessEventの移植
def ProcessEvent(event):
    global g_MouseWheel
    global g_MousePressed</p>
<pre class="code literal-block"><span></span>io = imgui.GetIO();
if event.type==SDL_MOUSEWHEEL:
    if (event.wheel.y &gt; 0):
        g_MouseWheel = 1;
    if (event.wheel.y &lt; 0):
        g_MouseWheel = -1;
    return True;
elif event.type==SDL_MOUSEBUTTONDOWN:
    if (event.button.button == SDL_BUTTON_LEFT): g_MousePressed[0] = True;
    if (event.button.button == SDL_BUTTON_RIGHT): g_MousePressed[1] = True;
    if (event.button.button == SDL_BUTTON_MIDDLE): g_MousePressed[2] = True;
    return True;
elif event.type==SDL_TEXTINPUT:
    io.AddInputCharactersUTF8(event.text.text);
    return True;
elif event.type==SDL_KEYDOWN or event.type==SDL_KEYUP:
    key = event.key.keysym.sym &amp; ~SDLK_SCANCODE_MASK;
    io.SetKeysDown(key, event.type == SDL_KEYDOWN);
    io.KeyShift = ((SDL_GetModState() &amp; KMOD_SHIFT) != 0);
    io.KeyCtrl = ((SDL_GetModState() &amp; KMOD_CTRL) != 0);
    io.KeyAlt = ((SDL_GetModState() &amp; KMOD_ALT) != 0);
    io.KeySuper = ((SDL_GetModState() &amp; KMOD_GUI) != 0);
    return True;

return False;
</pre>

<p>io.KeysDown
セッター
%extend ImGuiIO {
    void SetKeysDown(int k, int v)
    {
        ImGui::GetIO().KeysDown[k]=v;
    }
}</p>
<p>かくしてほぼ動くようになった。</p>
<p>実際には新しいWidgetをPythonから使用するたびに値をやりとりする部分を追加しなければならないが、そこはおいおいやっていく。
VisualStudioのセットアップ
こういうネイティブモジュールの開発ではないとクラッシュの原因を探すのが困難になるが、VisualStudioで普通にアタッチできるので便利。
ひとつのsolutionにpythonプロジェクトと、c++のdllプロジェクトを同居させてデバッグできる。</p>
<p>あとで書く</p>
</div>
                </div>
            </article>
</div>
    
        <ul class="pager postindexpager clearfix">
<li class="previous"><a href="index-25.html" rel="prev">新しい記事</a></li>
            <li class="next"><a href="index-23.html" rel="next">過去の記事</a></li>
        </ul>
<!--End of body content--><footer id="footer">
            Contents © 2021         <a href="mailto:ousttrue@gmail.com">ousttrue</a> - Powered by         <a href="https://getnikola.com" rel="nofollow">Nikola</a>         
            
            
        </footer>
</div>
</div>


        <script src="assets/js/all-nocdn.js"></script><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element){var i=element.getElementsByTagName('img')[0];return i===undefined?'':i.alt;}});
    </script>
</body>
</html>
