<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <title>三次元日誌</title>

    

  <script src="https://ousttrue.github.io/plugins/elasticlunr.min.js" defer></script>
  <script src="https://ousttrue.github.io/search_index.en.js" defer></script>
  <script src="https://ousttrue.github.io/js/search.js" defer></script>

    

     
    <link rel="stylesheet" href="https://ousttrue.github.io/main.css">
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css"
      />
    
  </head>

  <body class="container">
    <a class="site_title" href="https:&#x2F;&#x2F;ousttrue.github.io&#x2F;">
      <div>三次元日誌</div>
    </a>

    <nav class="nav">
      <a class="item" href="/tags/">tags</a>
      <a class="item" href="https://github.com/ousttrue" aria-label="github">
        <i class="fab fa-github fa-lg"></i>
      </a>
      

        
            <form class="navbar-form">
                <input id="userinput" class="form-control is-search" type="search" placeholder="Search docs..."
                    aria-label="Search docs..." autocomplete="off">
                <div id="suggestions" class="shadow bg-white rounded"></div>
            </form>
        
    </nav>

    <main class="main">
<div class="page">
<div class="content">
  <div class="headline">
  
  

  
  <a class="headline_title" href="https:&#x2F;&#x2F;ousttrue.github.io&#x2F;python&#x2F;python-logger&#x2F;"> Pythonのlogger 
  

  
  </a>

  

  <div>
    <ul class="tags">
      <li class="headline_date">
        <div class="year">2017</div>
        <div class="md">1009</div>
      </li>
      
      


    <li class="tag"><a href="https:&#x2F;&#x2F;ousttrue.github.io&#x2F;tags&#x2F;python&#x2F;">python</a></li>




    </ul>
  </div>
</div>
 <p>Pythonのロガーの設定をどうすればいいのか。</p>
<p><a href="https://qiita.com/amedama/items/b856b2f30c2f38665701">ログ出力のための print と import logging はやめてほしい</a></p>
<p>を元に模索してみた。
今使っている設定
すべてのファイルの先頭にはこれだけ書いておく。
いわばログ入力の設定。</p>
<pre style="background-color:#2b303b;">
<code class="language-py" data-lang="py"><span style="color:#b48ead;">from </span><span style="color:#c0c5ce;">logging </span><span style="color:#b48ead;">import </span><span style="color:#c0c5ce;">getLogger
logger = </span><span style="color:#bf616a;">getLogger</span><span style="color:#c0c5ce;">(__name__)
</span></code></pre>
<p>これとは別に、ログ出力の設定を一か所だけ記述する。
メインの始まるところがいいんでないか。
他のライブラリをimportするより前に書きたいということもあるだろうからその辺はお好みで。</p>
<pre style="background-color:#2b303b;">
<code class="language-py" data-lang="py"><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">__name__==&#39;</span><span style="color:#a3be8c;">__main__</span><span style="color:#c0c5ce;">&#39;:
    </span><span style="color:#65737e;"># defaultのlogレベルではdebug出ないよ
    </span><span style="color:#c0c5ce;">logger.</span><span style="color:#bf616a;">debug</span><span style="color:#c0c5ce;">(&#39;</span><span style="color:#a3be8c;">before</span><span style="color:#c0c5ce;">&#39;)

    </span><span style="color:#b48ead;">from </span><span style="color:#c0c5ce;">logging </span><span style="color:#b48ead;">import </span><span style="color:#c0c5ce;">basicConfig, </span><span style="color:#bf616a;">DEBUG
    basicConfig</span><span style="color:#c0c5ce;">(
        </span><span style="color:#bf616a;">level</span><span style="color:#c0c5ce;">=</span><span style="color:#bf616a;">DEBUG</span><span style="color:#c0c5ce;">,
        </span><span style="color:#bf616a;">datefmt</span><span style="color:#c0c5ce;">=&#39;</span><span style="color:#d08770;">%H</span><span style="color:#a3be8c;">:</span><span style="color:#d08770;">%M</span><span style="color:#a3be8c;">:</span><span style="color:#d08770;">%S</span><span style="color:#c0c5ce;">&#39;,
        </span><span style="color:#bf616a;">format</span><span style="color:#c0c5ce;">=&#39;</span><span style="color:#d08770;">%(</span><span style="color:#bf616a;">asctime</span><span style="color:#d08770;">)s</span><span style="color:#a3be8c;">[</span><span style="color:#d08770;">%(</span><span style="color:#bf616a;">levelname</span><span style="color:#d08770;">)s</span><span style="color:#a3be8c;">][</span><span style="color:#d08770;">%(</span><span style="color:#bf616a;">name</span><span style="color:#d08770;">)s</span><span style="color:#a3be8c;">.</span><span style="color:#d08770;">%(</span><span style="color:#bf616a;">funcName</span><span style="color:#d08770;">)s</span><span style="color:#a3be8c;">] </span><span style="color:#d08770;">%(</span><span style="color:#bf616a;">message</span><span style="color:#d08770;">)s</span><span style="color:#c0c5ce;">&#39;
    )

    </span><span style="color:#65737e;"># 以降出る
    </span><span style="color:#c0c5ce;">logger.</span><span style="color:#bf616a;">debug</span><span style="color:#c0c5ce;">(&#39;</span><span style="color:#a3be8c;">after</span><span style="color:#c0c5ce;">&#39;)
</span></code></pre>
<p>以上で、デフォルトのログ設定を使ってログが画面に出力される。
デフォルトのログ設定とは
上記のプログラムでは以下のようにログが流れる。</p>
<pre style="background-color:#2b303b;">
<code><span style="color:#c0c5ce;">logger.debug(&#39;message&#39;)
  |
  v            propagate(親にメッセージが伝搬する)
logger(__name__) -&gt; logger(&#39;&#39;)
  handlers[           handlers[
  ]                     Streamhandler -&gt; コンソール画面
                      ]
</span></code></pre>
<p>pythonのロガーは木構造
<code>getLogger(__name__)</code> で得たロガーは <code>__name__</code> という名前になり、<code>''</code> という名のロガーが親になる。</p>
<pre style="background-color:#2b303b;">
<code class="language-py" data-lang="py"><span style="color:#96b5b4;">print</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">getLogger</span><span style="color:#c0c5ce;">(&#39;&#39;))
&lt;RootLogger </span><span style="color:#bf616a;">root </span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">WARNING</span><span style="color:#c0c5ce;">)&gt;
</span></code></pre>
<p>というように <code>''</code> ロガーはルートロガーである。
どういう基準で親子が決まるかというと名前ベースで <code>''</code> がすべての親、その子 <code>'hoge'</code> 、さらにその子 <code>'hoge.fuga'</code> というように <code>.</code> をセパレータとしたパス名で決めているぽい。 <code>getLogger(__name__)</code> という風にロガーを得れば、とりあえず <code>getLogger('')</code> の子孫になる。</p>
<p>https://docs.python.org/2/library/logging.html#logger-objects</p>
<p>さらにログは木構造を親に向かって遡りながら、通り道にあったhandlerに出力される。
なのですべての親になるルートロガーにひとつだけhandlerをセットしておけばよい。</p>
<pre style="background-color:#2b303b;">
<code class="language-py" data-lang="py"><span style="color:#96b5b4;">print</span><span style="color:#c0c5ce;">(logger.handlers)
[]
</span></code></pre><h1 id="rutoroganihadehuorutodestreamhandlergasetutosareteiru">ルートロガーにはデフォルトでStreamHandlerがセットされている</h1>
<pre style="background-color:#2b303b;">
<code class="language-py" data-lang="py"><span style="color:#96b5b4;">print</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">getLogger</span><span style="color:#c0c5ce;">(&#39;&#39;).handlers)
[&lt;StreamHandler &lt;stderr&gt; (</span><span style="color:#bf616a;">NOTSET</span><span style="color:#c0c5ce;">)&gt;]
</span></code></pre>
<p>親に向かって流すかどうかを設定するには以下のようにする。</p>
<h1 id="qin-niliu-sanai">親に流さない</h1>
<pre style="background-color:#2b303b;">
<code class="language-py" data-lang="py"><span style="color:#c0c5ce;">logger.propagate=</span><span style="color:#d08770;">False
</span></code></pre>
<p>前知識としてこれくらいあればカスタマイズできる。
出力のカスタマイズ
基本的に、ルートロガーに好みのフォーマットやハンドラを設定することになると思う。
デフォルトのStreamHandlerを削除する</p>
<pre style="background-color:#2b303b;">
<code class="language-py" data-lang="py"><span style="color:#bf616a;">getLogger</span><span style="color:#c0c5ce;">(&#39;&#39;).handlers.</span><span style="color:#bf616a;">clear</span><span style="color:#c0c5ce;">()
</span></code></pre><h2 id="formatwobian-eyou">Formatを変えよう</h2>
<p>サーバー風の時刻付きのフォーマットとか。</p>
<h2 id="dehuorutonohandorawode-ru">デフォルトのハンドラを得る</h2>
<pre style="background-color:#2b303b;">
<code class="language-py" data-lang="py"><span style="color:#c0c5ce;">handler=</span><span style="color:#bf616a;">getLogger</span><span style="color:#c0c5ce;">(&#39;&#39;).handlers[</span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">]
</span></code></pre><h2 id="mosikuhazi-qian-dezuo-ru">もしくは自前で作る</h2>
<pre style="background-color:#2b303b;">
<code class="language-py" data-lang="py"><span style="color:#b48ead;">from </span><span style="color:#c0c5ce;">logging </span><span style="color:#b48ead;">import </span><span style="color:#c0c5ce;">StreamHandler
handler=</span><span style="color:#bf616a;">StreamHandler</span><span style="color:#c0c5ce;">()
</span><span style="color:#bf616a;">getLogger</span><span style="color:#c0c5ce;">(&#39;&#39;).</span><span style="color:#bf616a;">addHandler</span><span style="color:#c0c5ce;">(handler)

</span><span style="color:#b48ead;">from </span><span style="color:#c0c5ce;">logging </span><span style="color:#b48ead;">import </span><span style="color:#c0c5ce;">Formatter
formatter=</span><span style="color:#bf616a;">Formatter</span><span style="color:#c0c5ce;">(&#39;</span><span style="color:#d08770;">%(</span><span style="color:#bf616a;">name</span><span style="color:#d08770;">)s</span><span style="color:#a3be8c;"> =&gt; </span><span style="color:#d08770;">%(</span><span style="color:#bf616a;">asctime</span><span style="color:#d08770;">)s</span><span style="color:#a3be8c;"> [</span><span style="color:#d08770;">%(</span><span style="color:#bf616a;">levelname</span><span style="color:#d08770;">)s</span><span style="color:#a3be8c;">] </span><span style="color:#d08770;">%(</span><span style="color:#bf616a;">message</span><span style="color:#d08770;">)s</span><span style="color:#c0c5ce;">&#39;)
handler.</span><span style="color:#bf616a;">setFormatter</span><span style="color:#c0c5ce;">(formatter)
</span></code></pre>
<p>使える変数は、LogRecord attributesらしい。</p>
<p>https://docs.python.org/2/library/logging.html#logrecord-attributes</p>
<p>日付のカスタマイズは？</p>
<pre style="background-color:#2b303b;">
<code class="language-py" data-lang="py"><span style="color:#bf616a;">basicConfig</span><span style="color:#c0c5ce;">(
       </span><span style="color:#bf616a;">datefmt</span><span style="color:#c0c5ce;">=&#39;</span><span style="color:#d08770;">%H</span><span style="color:#a3be8c;">:</span><span style="color:#d08770;">%M</span><span style="color:#a3be8c;">:</span><span style="color:#d08770;">%S</span><span style="color:#c0c5ce;">&#39;,
       </span><span style="color:#bf616a;">format</span><span style="color:#c0c5ce;">=&#39;</span><span style="color:#d08770;">%(</span><span style="color:#bf616a;">asctime</span><span style="color:#d08770;">)s</span><span style="color:#a3be8c;">[</span><span style="color:#d08770;">%(</span><span style="color:#bf616a;">levelname</span><span style="color:#d08770;">)s</span><span style="color:#a3be8c;">] </span><span style="color:#d08770;">%(</span><span style="color:#bf616a;">name</span><span style="color:#d08770;">)s</span><span style="color:#a3be8c;">.</span><span style="color:#d08770;">%(</span><span style="color:#bf616a;">funcName</span><span style="color:#d08770;">)s</span><span style="color:#a3be8c;"> =&gt; </span><span style="color:#d08770;">%(</span><span style="color:#bf616a;">message</span><span style="color:#d08770;">)s</span><span style="color:#c0c5ce;">&#39;)
       </span><span style="background-color:#bf616a;color:#2b303b;">)</span><span style="color:#c0c5ce;">
</span></code></pre><h2 id="se-fu-kinisiyou">色付きにしよう</h2>
<p>おされなコンソール</p>
<p>Pythonで色つきログを - rainbow_logging_handler をPyPIにリリースしました</p>
<pre style="background-color:#2b303b;">
<code class="language-py" data-lang="py"><span style="color:#b48ead;">from </span><span style="color:#c0c5ce;">rainbow_logging_handler </span><span style="color:#b48ead;">import </span><span style="color:#c0c5ce;">RainbowLoggingHandler
handler = </span><span style="color:#bf616a;">RainbowLoggingHandler</span><span style="color:#c0c5ce;">(sys.stderr)
</span><span style="color:#bf616a;">getLogger</span><span style="color:#c0c5ce;">(&#39;&#39;).</span><span style="color:#bf616a;">addHandler</span><span style="color:#c0c5ce;">(handler)
</span></code></pre>
<p>QtのWidgetに出力する
StackOverflowとかで見つけた気がするがとりあえず。</p>
<p>https://github.com/buha/gpibcs/blob/master/qplaintexteditlogger.py</p>
<pre style="background-color:#2b303b;">
<code class="language-py" data-lang="py"><span style="color:#b48ead;">class </span><span style="color:#ebcb8b;">QPlainTextEditLogger</span><span style="color:#eff1f5;">(</span><span style="color:#a3be8c;">logging.Handler</span><span style="color:#eff1f5;">):
    </span><span style="color:#65737e;">&#39;&#39;&#39;
    Logger
    &#39;&#39;&#39;
    </span><span style="color:#b48ead;">def </span><span style="color:#96b5b4;">__init__</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">self</span><span style="color:#c0c5ce;">):
        </span><span style="color:#96b5b4;">super</span><span style="color:#c0c5ce;">().</span><span style="color:#96b5b4;">__init__</span><span style="color:#c0c5ce;">()
        </span><span style="color:#bf616a;">self</span><span style="color:#c0c5ce;">.widget=</span><span style="color:#d08770;">None

    </span><span style="color:#b48ead;">def </span><span style="color:#8fa1b3;">set_widget</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">self</span><span style="color:#c0c5ce;">, </span><span style="color:#bf616a;">widget</span><span style="color:#c0c5ce;">):
        </span><span style="color:#bf616a;">self</span><span style="color:#c0c5ce;">.widget = widget
        </span><span style="color:#bf616a;">self</span><span style="color:#c0c5ce;">.widget.</span><span style="color:#bf616a;">setReadOnly</span><span style="color:#c0c5ce;">(</span><span style="color:#d08770;">True</span><span style="color:#c0c5ce;">)

    </span><span style="color:#b48ead;">def </span><span style="color:#8fa1b3;">emit</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">self</span><span style="color:#c0c5ce;">, </span><span style="color:#bf616a;">record</span><span style="color:#c0c5ce;">):

        msg = </span><span style="color:#bf616a;">self</span><span style="color:#c0c5ce;">.</span><span style="color:#bf616a;">format</span><span style="color:#c0c5ce;">(record)
        </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">not </span><span style="color:#bf616a;">self</span><span style="color:#c0c5ce;">.widget:
            </span><span style="color:#96b5b4;">print</span><span style="color:#c0c5ce;">(msg)
            </span><span style="color:#b48ead;">return

        if </span><span style="color:#c0c5ce;">not msg.</span><span style="color:#bf616a;">endswith</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#96b5b4;">\n</span><span style="color:#c0c5ce;">&quot;):
            msg+=&quot;</span><span style="color:#96b5b4;">\n</span><span style="color:#c0c5ce;">&quot;
        </span><span style="color:#bf616a;">self</span><span style="color:#c0c5ce;">.widget.</span><span style="color:#bf616a;">textCursor</span><span style="color:#c0c5ce;">().</span><span style="color:#bf616a;">movePosition</span><span style="color:#c0c5ce;">(QtGui.QTextCursor.Start)
        </span><span style="color:#bf616a;">self</span><span style="color:#c0c5ce;">.widget.</span><span style="color:#bf616a;">textCursor</span><span style="color:#c0c5ce;">().</span><span style="color:#bf616a;">insertText</span><span style="color:#c0c5ce;">(msg)
        </span><span style="color:#65737e;">#self.widget.insertPlainText(msg)

    </span><span style="color:#b48ead;">def </span><span style="color:#8fa1b3;">write</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">self</span><span style="color:#c0c5ce;">, </span><span style="color:#bf616a;">m</span><span style="color:#c0c5ce;">):
        </span><span style="color:#b48ead;">pass

</span><span style="color:#c0c5ce;">handler=</span><span style="color:#bf616a;">QPlainTextEditLogger</span><span style="color:#c0c5ce;">()
</span><span style="color:#bf616a;">getLogger</span><span style="color:#c0c5ce;">(&#39;&#39;).</span><span style="color:#bf616a;">addHandler</span><span style="color:#c0c5ce;">(handler)
</span></code></pre>
<p>ログレベル別に色を付けてみる</p>
<pre style="background-color:#2b303b;">
<code class="language-py" data-lang="py"><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">def </span><span style="color:#8fa1b3;">emit</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">self</span><span style="color:#c0c5ce;">, </span><span style="color:#bf616a;">record</span><span style="color:#c0c5ce;">):
        msg = </span><span style="color:#bf616a;">self</span><span style="color:#c0c5ce;">.</span><span style="color:#bf616a;">format</span><span style="color:#c0c5ce;">(record)
        </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">not </span><span style="color:#bf616a;">self</span><span style="color:#c0c5ce;">.widget:
            </span><span style="color:#96b5b4;">print</span><span style="color:#c0c5ce;">(msg)
            </span><span style="color:#b48ead;">return

        if </span><span style="color:#c0c5ce;">record.levelno == </span><span style="color:#bf616a;">DEBUG</span><span style="color:#c0c5ce;">:
            msg = </span><span style="color:#b48ead;">f</span><span style="color:#c0c5ce;">&#39;</span><span style="color:#a3be8c;">&lt;font color=&quot;gray&quot;&gt;</span><span style="color:#c0c5ce;">{msg}</span><span style="color:#a3be8c;">&lt;/font&gt;&lt;br&gt;</span><span style="color:#c0c5ce;">&#39;
        </span><span style="color:#b48ead;">elif </span><span style="color:#c0c5ce;">record.levelno == </span><span style="color:#bf616a;">WARNING</span><span style="color:#c0c5ce;">:
            msg = </span><span style="color:#b48ead;">f</span><span style="color:#c0c5ce;">&#39;</span><span style="color:#a3be8c;">&lt;font color=&quot;orange&quot;&gt;</span><span style="color:#c0c5ce;">{msg}</span><span style="color:#a3be8c;">&lt;/font&gt;&lt;br&gt;</span><span style="color:#c0c5ce;">&#39;
        </span><span style="color:#b48ead;">elif </span><span style="color:#c0c5ce;">record.levelno == </span><span style="color:#bf616a;">ERROR</span><span style="color:#c0c5ce;">:
            msg = </span><span style="color:#b48ead;">f</span><span style="color:#c0c5ce;">&#39;</span><span style="color:#a3be8c;">&lt;font color=&quot;red&quot;&gt;</span><span style="color:#c0c5ce;">{msg}</span><span style="color:#a3be8c;">&lt;/font&gt;&lt;br&gt;</span><span style="color:#c0c5ce;">&#39;
        </span><span style="color:#b48ead;">else</span><span style="color:#c0c5ce;">:
            msg = </span><span style="color:#b48ead;">f</span><span style="color:#c0c5ce;">&#39;{msg}</span><span style="color:#a3be8c;">&lt;br&gt;</span><span style="color:#c0c5ce;">&#39;

        </span><span style="color:#bf616a;">self</span><span style="color:#c0c5ce;">.widget.</span><span style="color:#bf616a;">textCursor</span><span style="color:#c0c5ce;">().</span><span style="color:#bf616a;">movePosition</span><span style="color:#c0c5ce;">(QtGui.QTextCursor.Start)
        </span><span style="color:#bf616a;">self</span><span style="color:#c0c5ce;">.widget.</span><span style="color:#bf616a;">textCursor</span><span style="color:#c0c5ce;">().</span><span style="color:#bf616a;">insertHtml</span><span style="color:#c0c5ce;">(msg)
</span></code></pre>
</div>

<nav class="toc">

<div class="toc_fix">
<ul>
    
        <li>
            <a href="https://ousttrue.github.io/python/python-logger/#rutoroganihadehuorutodestreamhandlergasetutosareteiru">ルートロガーにはデフォルトでStreamHandlerがセットされている</a>
            
        </li>
    
        <li>
            <a href="https://ousttrue.github.io/python/python-logger/#qin-niliu-sanai">親に流さない</a>
            
                <ul>
                    
                        <li>
                            <a href="https://ousttrue.github.io/python/python-logger/#formatwobian-eyou">Formatを変えよう</a>
                        </li>
                    
                        <li>
                            <a href="https://ousttrue.github.io/python/python-logger/#dehuorutonohandorawode-ru">デフォルトのハンドラを得る</a>
                        </li>
                    
                        <li>
                            <a href="https://ousttrue.github.io/python/python-logger/#mosikuhazi-qian-dezuo-ru">もしくは自前で作る</a>
                        </li>
                    
                        <li>
                            <a href="https://ousttrue.github.io/python/python-logger/#se-fu-kinisiyou">色付きにしよう</a>
                        </li>
                    
                </ul>
            
        </li>
    
</ul>
</div>


</nav>
</div>
</main>

    <footer class="footer">Powered by <a href="https://www.getzola.org/">Zola</a> <a href="https://github.com/ousttrue/zola/tree/custom">custom</a></footer>

  </body>
</html>
