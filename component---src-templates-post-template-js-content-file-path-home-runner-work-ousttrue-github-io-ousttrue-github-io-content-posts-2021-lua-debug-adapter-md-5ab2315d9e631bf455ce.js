"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[5618],{7977:function(n,e,a){a.r(e),a.d(e,{default:function(){return d}});var t=a(1151),s=a(7294);function l(n){const e=Object.assign({p:"p",span:"span",h2:"h2",h3:"h3"},(0,t.ah)(),n.components);return s.createElement(s.Fragment,null,s.createElement(e.p,null,"nvim の nvim-dap で lua をデバッグするべく自分で書いてみた。\n手頃なのが見つからなかったので。"),"\n",s.createElement(e.p,null,"https://github.com/ousttrue/my_nvim/blob/master/luada.lua"),"\n",s.createElement(e.p,null,"https://microsoft.github.io/debug-adapter-protocol/ の自前実装。"),"\n",s.createElement(e.p,null,s.createElement(e.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">request</code>'}})," のうち ",s.createElement(e.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">initialize</code>'}}),", ",s.createElement(e.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">launch</code>'}}),", ",s.createElement(e.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">setBreakpoints</code>'}}),", ",s.createElement(e.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">configurationDone</code>'}}),", ",s.createElement(e.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">threads</code>'}}),", ",s.createElement(e.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">stackTrace</code>'}}),", ",s.createElement(e.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">scopes</code>'}}),", ",s.createElement(e.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">variables</code>'}}),", ",s.createElement(e.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">continue</code>'}}),", ",s.createElement(e.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">next</code>'}})," を実装した。\n",s.createElement(e.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">event</code>'}})," のうち ",s.createElement(e.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">initialized</code>'}}),", ",s.createElement(e.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">exited</code>'}}),", ",s.createElement(e.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">stopped(breakpoint, step)</code>'}})," を実装した。"),"\n",s.createElement(e.p,null,"これで最低限の breakpoint を設定して止める、ステップ実行、変数表示までできた。"),"\n",s.createElement(e.p,null,"ログレベルを設定して"),"\n",s.createElement(e.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="lua"><pre class="language-lua"><code class="language-lua"><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'dap\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set_log_level</span><span class="token punctuation">(</span><span class="token string">\'trace\'</span><span class="token punctuation">)</span></code></pre></div>'}}),"\n",s.createElement(e.p,null,"nvim の ",s.createElement(e.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">:lua print(vim.fn.stdpath "cache")</code>'}})," に配置される ",s.createElement(e.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">dap.log</code>'}})," を観察したらだいたいできた。"),"\n",s.createElement(e.p,null,"nvim-dap の設定は以下。"),"\n",s.createElement(e.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="lua"><pre class="language-lua"><code class="language-lua"><span class="token keyword">local</span> dap <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"dap"</span><span class="token punctuation">)</span>\n\n<span class="token keyword">local</span> luada <span class="token operator">=</span> vim<span class="token punctuation">.</span>api<span class="token punctuation">.</span><span class="token function">nvim_get_var</span><span class="token punctuation">(</span><span class="token string">"my_nvim_root"</span><span class="token punctuation">)</span> <span class="token operator">..</span> <span class="token string">"/luada.lua"</span>\n\n<span class="token comment">-- luada adapter を登録</span>\ndap<span class="token punctuation">.</span>adapters<span class="token punctuation">.</span>luada <span class="token operator">=</span> <span class="token punctuation">{</span>\n\t<span class="token comment">-- debug用のスクリプトを lua で実行し、標準入出力で DAP 通信(JSON-RPC)を開始する</span>\n\ttype <span class="token operator">=</span> <span class="token string">"executable"</span><span class="token punctuation">,</span>\n\tcommand <span class="token operator">=</span> vim<span class="token punctuation">.</span>api<span class="token punctuation">.</span><span class="token function">nvim_get_var</span><span class="token punctuation">(</span><span class="token string">"my_nvim_root"</span><span class="token punctuation">)</span> <span class="token operator">..</span> <span class="token string">"/neovim/.deps/usr/bin/luajit.exe"</span><span class="token punctuation">,</span>\n\targs <span class="token operator">=</span> <span class="token punctuation">{</span> luada <span class="token punctuation">}</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span>\n<span class="token comment">-- filetype lua のときに luada を使用する。launch の引数</span>\ndap<span class="token punctuation">.</span>configurations<span class="token punctuation">.</span>lua <span class="token operator">=</span> <span class="token punctuation">{</span>\n\t<span class="token punctuation">{</span>\n\t\tname <span class="token operator">=</span> <span class="token string">"lua debug adapter"</span><span class="token punctuation">,</span>\n\t\ttype <span class="token operator">=</span> <span class="token string">"luada"</span><span class="token punctuation">,</span>\n\t\trequest <span class="token operator">=</span> <span class="token string">"launch"</span><span class="token punctuation">,</span>\n\t\tprogram <span class="token operator">=</span> <span class="token string">"${fileDirname}\\\\${file}"</span><span class="token punctuation">,</span>\n\t\targs <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token string">"a"</span><span class="token punctuation">,</span> <span class="token string">"b"</span><span class="token punctuation">,</span> <span class="token string">"c"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>\n\t<span class="token punctuation">}</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span></code></pre></div>'}}),"\n",s.createElement(e.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">+---------+    DAP       +--------------------+\n| nvim dap|-------\x3estdin |luajit.exe luada.lua|\n|         |&lt;-------stdout|                    |\n+---------+              +--------------------+\n                                              +==> loadscript(target_lua_script)</code></pre></div>'}}),"\n",s.createElement(e.p,null,"入出力を DAP で占有してしまうので、それでも大丈夫なスクリプトしかデバッグできない。\n(print 関数は、stderr に出力するように退避したので、",s.createElement(e.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">dap.log</code>'}})," には出る)"),"\n",s.createElement(e.p,null,"素の standalone の lua interpreter で簡単にできる範囲で実装する方針。"),"\n",s.createElement(e.h2,null,"はまりポイント"),"\n",s.createElement(e.h3,null,"Windows 版 は、",s.createElement(e.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">io.stdout</code>'}})," で ",s.createElement(e.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">CR</code>'}})," が ",s.createElement(e.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">CRLF</code>'}})," に変換されるのを回避できない。"),"\n",s.createElement(e.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="c++"><pre class="language-c++"><code class="language-c++">setmode(_fileno(stdout),_O_BINARY);</code></pre></div>'}}),"\n",s.createElement(e.p,null,"を lua で呼び出す手段が無い。"),"\n",s.createElement(e.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">Content-Leght: 123\\n\\n</code></pre></div>'}}),"\n",s.createElement(e.p,null,"と出力して変換されるのに任せることにした。"),"\n",s.createElement(e.h3,null,"debug.sethook 内で coroutine.yield できない"),"\n",s.createElement(e.p,null,"https://stackoverflow.com/questions/54858455/lua-debug-hooks-seems-to-prevent-the-coroutine-from-working"),"\n",s.createElement(e.p,null,"breakpoint 等によるスクリプト中断を ",s.createElement(e.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">coroutine.yield</code>'}})," で実装しようとしたのだけど断念した。\n(yield すると ",s.createElement(e.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">suspend</code>'}})," にならずに ",s.createElement(e.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">dead</code>'}})," になる)"),"\n",s.createElement(e.p,null,"https://github.com/tomblind/local-lua-debugger-vscode は、coroutine で実装しているような気がするのだが・・・。"),"\n",s.createElement(e.p,null,"yield する代わりに main.loop をネストさせてそこで通信待機させることにした、"),"\n",s.createElement(e.h3,null,"launch で開始すると早すぎる"),"\n",s.createElement(e.p,null,"これは、 ",s.createElement(e.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">nvim-dap</code>'}})," の実装の問題のような気がするが、\ncapabilities に以下を設定して、 ",s.createElement(e.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">configurationDone</code>'}})," リクエストで自開始する。"),"\n",s.createElement(e.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="lua"><pre class="language-lua"><code class="language-lua">supportsConfigurationDoneRequest <span class="token operator">=</span> <span class="token keyword">true</span><span class="token punctuation">,</span></code></pre></div>'}}),"\n",s.createElement(e.h2,null,"ToDo"),"\n",s.createElement(e.p,null,"luada リポジトリを作って vscode 拡張としてリリースする。"))}var c=function(n){void 0===n&&(n={});const{wrapper:e}=Object.assign({},(0,t.ah)(),n.components);return e?s.createElement(e,n,s.createElement(l,n)):l(n)},o=a(8678),p=a(8838);const u={code:n=>{let{children:e,className:a}=n;return a?s.createElement(p.Z,{className:a},e):s.createElement("code",null,e)}};function r(n){let{data:e,children:a}=n;return s.createElement(o.Z,null,s.createElement("h1",null,e.mdx.frontmatter.title),s.createElement(t.Zo,{components:u},a))}function d(n){return s.createElement(r,n,s.createElement(c,n))}}}]);
//# sourceMappingURL=component---src-templates-post-template-js-content-file-path-home-runner-work-ousttrue-github-io-ousttrue-github-io-content-posts-2021-lua-debug-adapter-md-5ab2315d9e631bf455ce.js.map