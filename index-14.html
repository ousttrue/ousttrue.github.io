<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article# " lang="ja">
<head>
<meta charset="utf-8">
<meta name="description" content="作業記録">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>三次元日誌 (過去の記事 14ページ目) | 三次元日誌</title>
<link href="assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<link href="https://fonts.googleapis.com/css?family=Playfair+Display:700,900" rel="stylesheet">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" hreflang="ja" href="rss.xml">
<link rel="canonical" href="https://ousttrue.github.io/index-14.html">
<link rel="prev" href="index-15.html" type="text/html">
<link rel="next" href="index-13.html" type="text/html">
<!--[if lt IE 9]><script src="assets/js/html5.js"></script><![endif]-->
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">本文を読み飛ばす</a>

<!-- Header and menu bar -->
<div class="container">
      <header class="blog-header py-3"><div class="row nbb-header align-items-center">
          <div class="col-md-3 col-xs-2 col-sm-2" style="width: auto;">
            <button class="navbar-toggler navbar-light bg-light nbb-navbar-toggler" type="button" data-toggle="collapse" data-target=".bs-nav-collapsible" aria-controls="bs-navbar" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse bs-nav-collapsible bootblog4-search-form-holder">
                
            </div>
        </div>
          <div class="col-md-6 col-xs-10 col-sm-10 bootblog4-brand" style="width: auto;">
            <a class="navbar-brand blog-header-logo text-dark" href=".">

            <span id="blog-title">三次元日誌</span>
        </a>
          </div>
            <div class="col-md-3 justify-content-end align-items-center bs-nav-collapsible collapse flex-collapse bootblog4-right-nav">
            <nav class="navbar navbar-light bg-white"><ul class="navbar-nav bootblog4-right-nav"></ul></nav>
</div>
    </div>
</header><nav class="navbar navbar-expand-md navbar-light bg-white static-top"><div class="collapse navbar-collapse bs-nav-collapsible" id="bs-navbar">
            <ul class="navbar-nav nav-fill d-flex w-100">
<li class="nav-item">
<a href="books" class="nav-link">MemoBooks</a>
                </li>
<li class="nav-item">
<a href="archive.html" class="nav-link">Archives</a>
                </li>
<li class="nav-item">
<a href="categories/index.html" class="nav-link">Tags</a>
                </li>
<li class="nav-item">
<a href="rss.xml" class="nav-link">RSS feed</a>
                </li>
<li class="nav-item">
<a href="about" class="nav-link">About</a>

                
            </li>
</ul>
</div>
<!-- /.navbar-collapse -->
</nav>
</div>

<div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        
        
        
    
        

    
        
    <div class="postindex">
            <article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/2015/12/17/toggle/" class="u-url">特定のHtmlElementを画面いっぱいにするToggleの実験</a></h1>
                <div class="metadata">
                    <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                        ousttrue
                    </span></p>
            <p class="dateline">
            <a href="posts/2015/12/17/toggle/" rel="bookmark">
            <time class="published dt-published" datetime="2015-12-17T00:00:00+09:00" itemprop="datePublished" title="2015-12-17 00:00">2015-12-17 00:00</time></a>
            </p>
                </div>
            </header><div class="e-content entry-content">
                    <div>
<p>“W” translate | “E” rotate | “R” scale | “+” increase size | “-” decrease size
Press “Q” to toggle world/local space, keep “Ctrl” down to snap to grid</p>
<p>close</p>
<p>ボタンが押されたら、最前面にposition: fixedの板($modal)を表示してそっちに
Three.jsで使っているElement($renderer)の内容を付け替える。
let $children=$renderer.children();</p>
<p>$modal
    .appendTo($('body'))
    .css({
        display: 'block',
        position: 'fixed',
        left: 0,
        width: '100%',
        top: 0,
        height: '100%',
        'z-index': 100
    });</p>
<p>$children.appendTo($modal);
$(window).trigger('resize');</p>
<p>概ねこんな感じ。
スクロールバーをbodyじゃなくて最大化表示用のdivより後ろにまわすなどの細工はしてある。</p>
</div>
                </div>
            </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/2015/12/12/dat_gui/" class="u-url">dat-guiを試してみる</a></h1>
                <div class="metadata">
                    <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                        ousttrue
                    </span></p>
            <p class="dateline">
            <a href="posts/2015/12/12/dat_gui/" rel="bookmark">
            <time class="published dt-published" datetime="2015-12-12T00:00:00+09:00" itemprop="datePublished" title="2015-12-12 00:00">2015-12-12 00:00</time></a>
            </p>
                </div>
            </header><div class="e-content entry-content">
                    <div>
<p>view typescript
view javascript</p>
<p>たまにthree.jsのデモと連動して使われているGUIライブラリdat-guiを試してみる。</p>
<p>https://code.google.com/p/dat-gui/
http://workshop.chromeexperiments.com/examples/gui/#1--Basic-Usage
https://stemkoski.github.io/Three.js/#gui</p>
<p>ライブラリを導入</p>
<blockquote>
<p>bower install dat.gui
tsd query dat-gui -rosa install</p>
</blockquote>
<p>dat.GuiControllerのnameプロパティがtypings/dat-gui/dat-gui.d.tsで未定義だった。
bower_components/dat.gui/dat.gui.jsでは定義されていた。
    /*<em>
    * The name of <code>GUI</code>. Used for folders. i.e
    * a folder's name
    * @type String
    </em>/
    name: {
    get: function() {
        return params.name;
    },
    set: function(v) {
        // TODO Check for collisions among sibling folders
        params.name = v;
        if (title_row_name) {
        title_row_name.innerHTML = params.name;
        }
    }
    },</p>
<p>既存のd.tsにプロパティを追加する(C# partial class的な)方法があるかどうかわからないので、
dat-gui.d.tsを改造することにした。
dat-gui.d.tsにnameプロパティを追加
declare module dat {</p>
<pre class="code literal-block"><span></span><span class="c1">// 省略</span>

<span class="kr">export</span> <span class="kr">class</span> <span class="nx">Controller</span> <span class="p">{</span> <span class="c1">// &lt;- dat.gui.jsに合わせて名前変えてみた</span>
    <span class="nx">destroy</span><span class="p">()</span><span class="o">:</span> <span class="k">void</span><span class="p">;</span>
    <span class="nx">fire</span><span class="p">()</span><span class="o">:</span> <span class="nx">Controller</span><span class="p">;</span>
    <span class="nx">getValue</span><span class="p">()</span><span class="o">:</span> <span class="nx">any</span><span class="p">;</span>
    <span class="nx">isModified</span><span class="p">()</span><span class="o">:</span> <span class="kr">boolean</span><span class="p">;</span>
    <span class="nx">listen</span><span class="p">()</span><span class="o">:</span> <span class="nx">Controller</span><span class="p">;</span>
    <span class="nx">min</span><span class="p">(</span><span class="nx">n</span>: <span class="kt">number</span><span class="p">)</span><span class="o">:</span> <span class="nx">Controller</span><span class="p">;</span>
    <span class="nx">remove</span><span class="p">(</span><span class="nx">target</span>: <span class="kt">Controller</span><span class="p">)</span><span class="o">:</span> <span class="k">void</span><span class="p">;</span>
    <span class="nx">setValue</span><span class="p">(</span><span class="nx">value</span>: <span class="kt">any</span><span class="p">)</span><span class="o">:</span> <span class="nx">Controller</span><span class="p">;</span>
    <span class="nx">step</span><span class="p">(</span><span class="nx">n</span>: <span class="kt">number</span><span class="p">)</span><span class="o">:</span> <span class="nx">Controller</span><span class="p">;</span>
    <span class="nx">updateDisplay</span><span class="p">()</span><span class="o">:</span> <span class="k">void</span><span class="p">;</span>
    <span class="nx">name</span><span class="p">(</span><span class="nx">newName?</span>: <span class="kt">string</span><span class="p">)</span><span class="o">:</span> <span class="kt">string</span><span class="p">;</span> <span class="c1">// &lt;- これ追加した</span>
    <span class="nx">onChange</span><span class="o">:</span> <span class="p">(</span><span class="nx">value?</span>: <span class="kt">any</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="k">void</span><span class="p">;</span>
    <span class="nx">onFinishChange</span><span class="o">:</span> <span class="p">(</span><span class="nx">value?</span>: <span class="kt">any</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="k">void</span><span class="p">;</span>
<span class="p">}</span>
</pre>

<p>}</p>
<p>サンプルコードを元にtypescript化してみる
https://stemkoski.github.io/Three.js/GUI-Controller.html
をベースにした。
javscriptのコードをまるっとtsファイルにコピーして淡々と型を指定していく。
dat.guiの場所調整の件</p>
<p>http://stackoverflow.com/questions/25653639/how-do-i-change-the-location-of-the-dat-gui-dropdown</p>
<p>autoPlace: falseがポインツ。そのうえでdomにposition:abusolute
var  gui = new dat.GUI( { autoPlace: false } );</p>
</div>
                </div>
            </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/2015/12/12/threejs_control/" class="u-url">Three.jsのトランスフォームコントロールでメッシュをマウスで移動</a></h1>
                <div class="metadata">
                    <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                        ousttrue
                    </span></p>
            <p class="dateline">
            <a href="posts/2015/12/12/threejs_control/" rel="bookmark">
            <time class="published dt-published" datetime="2015-12-12T00:00:00+09:00" itemprop="datePublished" title="2015-12-12 00:00">2015-12-12 00:00</time></a>
            </p>
                </div>
            </header><div class="e-content entry-content">
                    <div>
<p>"W" translate | "E" rotate | "R" scale | "+" increase size | "-" decrease size
Press "Q" to toggle world/local space, keep "Ctrl" down to snap to grid</p>
<p>source
今回は、本家サイトのサンプル
http://threejs.org/examples/#misc_controls_transform
をやってみよう。
まず、TransformControlsのtypescriptインターフェースを用意する。
というか書きながら作った。
TransformControls.d.ts。モジュールの細かいところがよくわからん・・・
declare module THREE {
    export class TransformControls extends THREE.Mesh {
        constructor(camera: THREE.Camera, element: Element);
        update():void;
        addEventListener(event: string, callback: Function): void;
        attach(mesh: THREE.Mesh): void;</p>
<pre class="code literal-block"><span></span>    <span class="nt">setSpace</span><span class="o">(</span><span class="nt">space</span><span class="o">:</span> <span class="nt">string</span><span class="o">):</span> <span class="nt">void</span><span class="o">;</span>
    <span class="nt">setTranslationSnap</span><span class="o">(</span><span class="nt">snap</span><span class="o">:</span> <span class="nt">number</span><span class="o">):</span> <span class="nt">void</span><span class="o">;</span>
    <span class="nt">setRotationSnap</span><span class="o">(</span><span class="nt">radians</span><span class="o">:</span> <span class="nt">number</span><span class="o">):</span> <span class="nt">void</span><span class="o">;</span>
    <span class="nt">setMode</span><span class="o">(</span><span class="nt">mode</span><span class="o">:</span> <span class="nt">string</span><span class="o">):</span> <span class="nt">void</span><span class="o">;</span>
    <span class="nt">setSize</span><span class="o">(</span><span class="nt">size</span><span class="o">:</span> <span class="nt">number</span><span class="o">):</span> <span class="nt">void</span><span class="o">;</span>

    <span class="nt">space</span><span class="o">:</span> <span class="nt">string</span><span class="o">;</span>
    <span class="nt">size</span><span class="o">:</span> <span class="nt">number</span><span class="o">;</span>
<span class="err">}</span>
</pre>

<p>}</p>
<p>TransformControlsを初期化する。カメラとhtmlノードを渡して初期化する
CreateTransformControl(mesh: THREE.Mesh) {
    this.transform = new THREE.TransformControls(this.camera, this.renderer.domElement);
    this.transform.addEventListener('change', () =&gt; this.Render());
    this.transform.attach(mesh);
    this.scene.add(this.transform);</p>
<pre class="code literal-block"><span></span>window.addEventListener('keydown', (event: KeyboardEvent) =&gt; {

    switch (event.keyCode) {

        case 81: // Q
            this.transform.setSpace(this.transform.space === "local" ? "world" : "local");
            break;

        case 17: // Ctrl
            this.transform.setTranslationSnap(100);
            this.transform.setRotationSnap(THREE.Math.degToRad(15));
            break;

        case 87: // W
            this.transform.setMode("translate");
            break;

        case 69: // E
            this.transform.setMode("rotate");
            break;

        case 82: // R
            this.transform.setMode("scale");
            break;

        case 187:
        case 107: // +, =, num+
            this.transform.setSize(this.transform.size + 0.1);
            break;

        case 189:
        case 109: // -, _, num-
            this.transform.setSize(Math.max(this.transform.size - 0.1, 0.1));
            break;

    }
});

window.addEventListener('keyup', (event: KeyboardEvent) =&gt; {

    switch (event.keyCode) {

        case 17: // Ctrl
            this.transform.setTranslationSnap(null);
            this.transform.setRotationSnap(null);
            break;

    }

});
</pre>

<p>}</p>
<p>マウスイベントを監視するHtmlノードと、マウスの動きをどのように解釈するかを知るためにカメラが必要ということですね。</p>
</div>
                </div>
            </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="github/sio_sample/" class="u-url">sio_sample</a></h1>
                <div class="metadata">
                    <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                        ousttrue
                    </span></p>
            <p class="dateline">
            <a href="github/sio_sample/" rel="bookmark">
            <time class="published dt-published" datetime="2015-12-10T17:19:31Z" itemprop="datePublished" title="2015-12-10 17:19">2015-12-10 17:19</time><span class="updated"> (更新日時
                    <time class="dt-updated" datetime="2015-12-15T13:55:49Z" itemprop="dateUpdated" title="2015-12-15 13:55">2015-12-15 13:55</time>)</span>
            </a>
            </p>
                </div>
            </header><div class="e-content entry-content">
                    <div>
<p><a href="https://github.com/ousttrue/sio_sample">https://github.com/ousttrue/sio_sample</a></p>
<p>socket.io start up sample</p>
</div>
                </div>
            </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/2015/12/11/fontawesome/" class="u-url">FontAwesomeを取り入れる</a></h1>
                <div class="metadata">
                    <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                        ousttrue
                    </span></p>
            <p class="dateline">
            <a href="posts/2015/12/11/fontawesome/" rel="bookmark">
            <time class="published dt-published" datetime="2015-12-11T00:00:00+09:00" itemprop="datePublished" title="2015-12-11 00:00">2015-12-11 00:00</time></a>
            </p>
                </div>
            </header><div class="e-content entry-content">
                    <div>
<p>https://fortawesome.github.io/Font-Awesome/</p>
<p>取り入れてみた。
cssをセットアップして
アイコンを選択してコピペすると。
無駄にアイコンを配置してみよう。
 fa-lg
 fa-2x
 fa-3x
 fa-4x
 fa-5x
なるほど。
<i class="fa fa-wrench fa-5x"></i></p>
<p>iでアイコンタグを導入して、クラスで種類とサイズを指定する仕組み。</p>
<p>適当にサイトのテンプレートにアイコンを入れてみる。
わりとお手軽におされ？なサイトに。</p>
</div>
                </div>
            </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/2015/12/11/express_socketio/" class="u-url">Socket.IOな実験環境</a></h1>
                <div class="metadata">
                    <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                        ousttrue
                    </span></p>
            <p class="dateline">
            <a href="posts/2015/12/11/express_socketio/" rel="bookmark">
            <time class="published dt-published" datetime="2015-12-11T00:00:00+09:00" itemprop="datePublished" title="2015-12-11 00:00">2015-12-11 00:00</time></a>
            </p>
                </div>
            </header><div class="e-content entry-content">
                    <div>
<p>Socket.IOを実験する環境のメモ。</p>
<p>Expressは、serve-staticで静的なファイルのhostingが目的兼後で拡張できるように
coffee-scriptは無しでES6要素をなるべく入れる
Socket.IOを手早く展開するのが目的なのでtypescriptは抜きにしようと思ったが、無い方がつらいので矢張り入れる</p>
<p>https://github.com/ousttrue/sio_sample
Project生成</p>
<blockquote>
<p>mkdir sio_sample
cd sio_sample
sio_sample&gt; npm init -y
sio_sample&gt; npm install gulp gulp-load-plugins gulp-nodemon browser-sync -D
sio_sample&gt; npm install express socket.io body-parser method-override connect-logger errorhandler serve-static --save</p>
</blockquote>
<p>vscodeでes6を使えるように
jsconifg.json
{
    "compilerOptions": {
        "target": "ES6"
    }
}</p>
<p>後で拡張できるように以下のようなディレクトリ構成にする。
build &lt;- srcから(加工して)コピーされる</p>
<p>src &lt;- 加工前のファイル置き場
  + server
    + app.js
  + client
    + index.html
    + index.js</p>
<p>src/server/app.js
"use strict";</p>
<p>const http = require('http');
const express = require('express');
const port = process.env.port || 3000;
const app = express();
const server = http.createServer(app);
const servestatic = require('serve-static');
const serve_dir = __dirname + '/public';
console.log('serve %s', serve_dir);
app
    .use(servestatic(serve_dir))
;</p>
<p>// socket.io
const socketio = require('socket.io');
const io = socketio(server);
io.on('connection', (socket) =&gt; {
    console.log('a client connected %s', socket);
    socket.on('disconnect', () =&gt; {
        console.log('a client disconnected');
    });
});</p>
<p>// start
server.listen(port);
console.log('start port: %d...', port);</p>
<p>src/client/index.html</p>

<p>
</p>
    <meta charset="UTF-8">
<title>Document</title>
<script src="posts/2015/12/11/express_socketio/index.js"></script><div id="target"></div>

<p></p>
<p>src/client/index.js
"use strict";</p>
<p>function setup(target) {
    const div = document.createElement('div');
    div.appendChild(document.createTextNode('onLoad'));
    target.appendChild(div);
}</p>
<p>window.onload = () =&gt; {</p>
<pre class="code literal-block"><span></span>setup(document.getElementById('target'));
</pre>

<p>};</p>
<p>srcからbuildに展開するgulp
gulpfile.js
const gulp = require('gulp');
const $ = require('gulp-load-plugins')();</p>
<p>const config = {
    server_src: './src/server/<strong>/*',
    server_dst: './build',
    client_src: './src/client/</strong>/*',
    client_dst: './build/public'
};</p>
<p>gulp.task('server', () =&gt; {
    gulp.src(config.server_src)
        .pipe(gulp.dest(config.server_dst));
});</p>
<p>gulp.task('client', () =&gt; {
    gulp.src(config.client_src)
        .pipe(gulp.dest(config.client_dst));
});</p>
<p>gulp.task('default', ['server', 'client']);</p>
<p>build
sio_sample&gt; gulp</p>
<p>ブラウザで動いた。
browserSync導入
gulpfile.js。browserSync
const config = { // 追加分
    app_entry: './build/app.js',
    app_port: 5000,  <br>
};</p>
<p>const browserSync = require('browser-sync').create();
gulp.task('serve', ()=&gt;{
    $.nodemon({
        script: config.app_entry,
        exp: 'js',
        ignore: [],
        env: {
            port: config.app_port
        }
    })
    .on('readable', ()=&gt;{
        this.stdout.on('data', (chunk)=&gt;{
            if (/^start /.test(chunk)){
                console.log('reloading...');
                browserSync.reload();
            }
            process.stdout.write(chunk)
        });
    });
});</p>
<p>gulp.task('browser-sync', ['serve'], ()=&gt;{
    browserSync.init({
        proxy: 'localhost:' + config.app_port,
        port: 3000,
        ws: true
    })
});</p>
<p>gulpfile.js。watchタスク追加
gulp.task('server', () =&gt; {
    gulp.src(config.server_src)
        .pipe(gulp.dest(config.server_dst))
        .pipe(browserSync.stream())
        ;
});</p>
<p>gulp.task('client', () =&gt; {
    gulp.src(config.client_src)
        .pipe(gulp.dest(config.client_dst))
        .pipe(browserSync.stream())
        ;
});</p>
<p>gulp.task('build', ['server', 'client']);</p>
<p>gulp.task('watch', ['build', 'browser-sync'], ()=&gt;{
    gulp.watch(config.server_src, ['server']);
    gulp.watch(config.client_src, ['client']);
});</p>
<p>gulp.task('default', ['watch']);</p>
<p>git
いったんgitに登録しよう。
.gitignore
/node_modules/
/build/</p>
<p>Socket.IOの疎通</p>

<p>
</p>
    <meta charset="UTF-8">
<title>Document</title>
<script type="text/javascript" src="socket.io/socket.io.js"></script><br><script src="posts/2015/12/11/express_socketio/index.js"></script><div id="target"></div>

<p></p>
<p>"use strict";</p>
<p>function setup(target) {
    const div = document.createElement('div');
    div.appendChild(document.createTextNode('hello'));
    target.appendChild(div);</p>
<pre class="code literal-block"><span></span>this.socket = io.connect();
</pre>

<p>}</p>
<p>window.onload = () =&gt; {
    setup(document.getElementById('target'));
};</p>
<p>typescript導入
sio_sample&gt; tsc --init</p>
<p>tsconfig.json
{
    "compilerOptions": {
        "module": "commonjs",
        "target": "es5",
        "noImplicitAny": true,
        "outDir": ".",
        "rootDir": ".",
        "sourceMap": false
    },
    "exclude": [
        "node_modules"
    ]
}</p>
<p>sio_sample&gt; npm install gulp-typescript gulp-if gulp-plumber gulp-debug -D
sio_sample&gt; cd src
sio_sample/src&gt; tsd init
sio_sample/src&gt; tsd query node express socket.io -rosa install</p>
<p>gulpfile.js。typescriptのコンパイルを追加
const path = require('path');
const tsconfig = require('./tsconfig.json');
const isTypescript = (file) =&gt; {
    const ext = path.extname(file.path).toLowerCase();
    return ext === '.ts';
}</p>
<p>gulp.task('server', () =&gt; {
    gulp.src(config.server_src)
        .pipe($.plumber())
        .pipe($.if(isTypescript, $.typescript(tsconfig.compilerOptions)))
        .pipe($.debug('server'))
        .pipe(gulp.dest(config.server_dst))
        .pipe(browserSync.stream())
    ;
});</p>
<p>gulp.task('client', () =&gt; {
    gulp.src(config.client_src)
        .pipe($.plumber())
        .pipe($.if(isTypescript, $.typescript(tsconfig.compilerOptions)))
        .pipe($.debug('client'))
        .pipe(gulp.dest(config.client_dst))
        .pipe(browserSync.stream())
    ;
});</p>
<p>src/server/app.jsをapp.tsにリネーム
/// <reference path="../typings/tsd.d.ts"></reference>
"use strict";</p>
<p>import http = require('http');
import express = require('express');
const port = process.env.port || 3000;
const app = express();
const server = http.createServer(app);
const servestatic = require('serve-static');
const serve_dir = __dirname + '/public';
console.log('serve %s', serve_dir);
app
    .use(servestatic(serve_dir))
;</p>
<p>// socket.io
import socketio = require('socket.io');
const io = socketio(server);
io.on('connection', (socket) =&gt; {
    var clientAddress=socket.client.conn.remoteAddress;
    console.log('connected: %s', clientAddress);
    socket.on('disconnect', () =&gt; {
        console.log('disconnected: %s', clientAddress);
    });
});</p>
<p>// start
server.listen(port);
console.log('start port: %d...', port);</p>
<p>src/client/index.jsをindex.tsにリネーム
/// <reference path="../typings/tsd.d.ts"></reference>
"use strict";</p>
<p>declare module io {
    export function connect(): SocketIO.Socket;
}</p>
<p>function setup(target: Element) {
    const div = document.createElement('div');
    div.appendChild(document.createTextNode('hello socket.io'));
    target.appendChild(div);</p>
<pre class="code literal-block"><span></span>this.socket = io.connect();
</pre>

<p>}</p>
<p>window.onload = () =&gt; {</p>
<pre class="code literal-block"><span></span>setup(document.getElementById('target'));
</pre>

<p>};</p>
<p>メッセージをやり取り
src/server/app.ts サーバーサイド。client-messageを受けてserver-messageを発行
// socket.io
import socketio = require('socket.io');
const io = socketio(server);
io.on('connection', (socket) =&gt; {
    var clientAddress = socket.client.conn.remoteAddress;
    console.log('connected: %s', clientAddress);
    socket.on('disconnect', () =&gt; {
        console.log('disconnected: %s', clientAddress);
    });</p>
<pre class="code literal-block"><span></span>socket.on('client-message', (data: any) =&gt; {
    socket.emit('server-message', 'server clicked message');
});
</pre>

<p>});</p>
<p>src/client/index.ts クライアントサイド。buttonを押したらclient-messageを発行。server-messageを受けてテキストを描画
/// <reference path="../typings/tsd.d.ts"></reference>
"use strict";</p>
<p>declare module io {
    export function connect(): SocketIO.Socket;
}</p>
<p>class Client {
    socket: SocketIO.Socket;</p>
<pre class="code literal-block"><span></span>constructor() {
    this.socket = io.connect();
}

setup(target: Element) {
    const div = document.createElement('div');
    div.appendChild(document.createTextNode('hello socket.io'));
    target.appendChild(div);

    this.socket.on('server-message', (data: any)=&gt;{
        const div = document.createElement('div');
        div.appendChild(document.createTextNode(data.toString()));
        target.appendChild(div);
    });

    const button=document.createElement('button');
    button.appendChild(document.createTextNode('send'));
    button.onclick=(ev: MouseEvent)=&gt;{
        this.socket.emit('client-message', 'clicked');
    };
    target.appendChild(button);
}
</pre>

<p>}
var client=new Client();</p>
<p>window.onload = () =&gt; {</p>
<pre class="code literal-block"><span></span>client.setup(document.getElementById('target'));
</pre>

<p>};</p>
</div>
                </div>
            </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/2015/12/11/tree/" class="u-url">Treeを表示・操作する</a></h1>
                <div class="metadata">
                    <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                        ousttrue
                    </span></p>
            <p class="dateline">
            <a href="posts/2015/12/11/tree/" rel="bookmark">
            <time class="published dt-published" datetime="2015-12-11T00:00:00+09:00" itemprop="datePublished" title="2015-12-11 00:00">2015-12-11 00:00</time></a>
            </p>
                </div>
            </header><div class="e-content entry-content">
                    <div>
<p>JavascriptでTreeを表示操作するライブラリを探してみる。
なんとなくサンプルが充実している
jqTree
にしてみた。</p>
<p>このサンプルに必要だったのでFontAwesomeも取り入れてみた。
めんどくさいので避けていたが、そろそろscssを取り入れるべきか。</p>
</div>
                </div>
            </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/2015/12/10/nodejs_v4/" class="u-url">Node.jsのアップデート</a></h1>
                <div class="metadata">
                    <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                        ousttrue
                    </span></p>
            <p class="dateline">
            <a href="posts/2015/12/10/nodejs_v4/" rel="bookmark">
            <time class="published dt-published" datetime="2015-12-10T00:00:00+09:00" itemprop="datePublished" title="2015-12-10 00:00">2015-12-10 00:00</time></a>
            </p>
                </div>
            </header><div class="e-content entry-content">
                    <div>
<p>ちょうど組み込まれているv8エンジンのバージョンが3から4に上がる直前にインストールしていたようで、
node.jsのバージョン</p>
<blockquote>
<p>node --version
v0.12.7
node -p process.versions.v8
3.28.71.19</p>
</blockquote>
<p>だった。
最新版(node-v4.2.3-x64.msi)をインストールしてみる。
node.jsのバージョン</p>
<blockquote>
<p>node --version
v4.2.3
node -p process.versions.v8
4.5.103.35</p>
</blockquote>
<p>v8 4.5搭載ということでES6の機能がいろいろ使えるぞ。</p>
<p>http://v8project.blogspot.jp/2015/07/v8-45-release.html</p>
<p>exp.js
let x=1;
console.log(x);</p>
<blockquote>
<p>node exp.js
SyntaxError: Block-scoped declarations (let, const, function, class) not yet supported outside strict mode</p>
</blockquote>
<p>最近よく見る”use strict”が要るのか。
exp.js。use strict
"use strict";</p>
<p>let x=1;
console.log(x);</p>
<p>としたらいけた。
class構文も問題なし。typescript使った後だとちょっと機能的に物足りない・・・
class Hoge
{
    // コンストラクタと
    constructor(name)
    {
        this.name=name;
    }</p>
<pre class="code literal-block"><span></span>// メソッドだけ定義できるらしい
printName()
{
    console.log(this.name);
}
</pre>

<p>}</p>
<p>let hoge=new Hoge('hoge');
hoge.printName();</p>
<p>let fuga={
    name: 'fuga',
    printName: hoge.printName,
};</p>
<p>fuga.printName();</p>
<p>hoge
fuga</p>
<p>thisは元の通り。
arrow functionも問題なく動いた。
ついでにbrowserでも実験してみよう。
result</p>
<p>source
firefox では、
SyntaxError: class is a reserved identifier</p>
<p>になった。
Chromeなら動いた。なるほど。</p>
</div>
                </div>
            </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/2015/12/09/threejs_editor/" class="u-url">Three.jsのEditor</a></h1>
                <div class="metadata">
                    <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                        ousttrue
                    </span></p>
            <p class="dateline">
            <a href="posts/2015/12/09/threejs_editor/" rel="bookmark">
            <time class="published dt-published" datetime="2015-12-09T00:00:00+09:00" itemprop="datePublished" title="2015-12-09 00:00">2015-12-09 00:00</time></a>
            </p>
                </div>
            </header><div class="e-content entry-content">
                    <div>
<p>Three.js本家のサイトにeditor (beta)というリンクあるのだけどこれ面白いなぁ。
わりといろんなことができそうだし、いまわしの中で流行り出しているSPAとしてとてもよさげだ。
使っている外部ライブラリ
いろんなものが入っている。
system.js</p>
<p>http://www.javascriptoo.com/System-js
System情報取得ライブラリ</p>
<p>jszip.js</p>
<p>http://stuk.github.io/jszip/
JavascriptでZipを作る。そんなライブラリあるのんか。</p>
<p>codemirror</p>
<p>https://codemirror.net/</p>
<p>acorn</p>
<p>https://marijnhaverbeke.nl/acorn/</p>
<p>ternjs</p>
<p>http://ternjs.net/</p>
<p>sortable</p>
<p>https://github.com/RubaXa/Sortable</p>
<p>js-signals</p>
<p>https://github.com/millermedeiros/js-signals</p>
<p>ui.js</p>
<p>https://jqueryui.com/</p>
<p>app.js</p>
<p>http://code.kik.com/app/3/index.html</p>
<p>という感じでいろんなライブラリが組み合わされている。
最近のJavascriptはこんなことになっているのか・・・
entrypointは・・・
index.htmlで初期化が走っていてuiの構築はたぶんこれ。
var editor = new Editor();</p>
<p>var viewport = new Viewport( editor );
document.body.appendChild( viewport.dom );</p>
<p>var player = new Player( editor );
document.body.appendChild( player.dom );</p>
<p>var script = new Script( editor );
document.body.appendChild( script.dom );</p>
<p>var toolbar = new Toolbar( editor );
document.body.appendChild( toolbar.dom );</p>
<p>var menubar = new Menubar( editor );
document.body.appendChild( menubar.dom );</p>
<p>var sidebar = new Sidebar( editor );
document.body.appendChild( sidebar.dom );</p>
<p>var modal = new UI.Modal();
document.body.appendChild( modal.dom );</p>
<p>UI的には４つの部分に分かれていて
見た目こういう感じ。
menu
viewport | sidebar
toolbar</p>
<p>レイアウトは、position: absoluteな感じでcssに書いてあった。
結構な大作で簡単には把握できない感じだなぁ。</p>
</div>
                </div>
            </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/2015/12/08/threejs_05/" class="u-url">Three.jsのBuild</a></h1>
                <div class="metadata">
                    <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                        ousttrue
                    </span></p>
            <p class="dateline">
            <a href="posts/2015/12/08/threejs_05/" rel="bookmark">
            <time class="published dt-published" datetime="2015-12-08T00:00:00+09:00" itemprop="datePublished" title="2015-12-08 00:00">2015-12-08 00:00</time></a>
            </p>
                </div>
            </header><div class="e-content entry-content">
                    <div>
<p>骨入りモデルとかやってみようかと思ったのだけど、その前にThree.jsのソースを見やすい状態で作業したい。
結合前のThree.jsを自前ビルドしながら運用する方法を調べてみる。
build.py, or how to generate a compressed three.js file
と本家に書いてある。python使うんか。gulpでやりてぇな。
全部concatしてuglifyしたらいいんじゃないか。
やってみよう。
とりあえずbowerで導入したthree.js関連を削除。
threejs.srcフォルダを作ってthree.jsソースのsrcディレクトリの中身を展開した。
gulp.task('bowerjs', function () {</p>
<pre class="code literal-block"><span></span><span class="x">var files = [</span>
<span class="x">    './bower_components/jquery/dist/jquery.js',</span>
<span class="x">    './bower_components/highlightjs/highlight.pack.js',</span>
<span class="x">    './bower_components/stats.js/build/stats.min.js',</span>
<span class="x">    './lib/**/*.js', // &lt;-- 中にthree.jsのsrcをコピーした</span>
<span class="x">];</span>
<span class="x">gulp.src(files)</span>
<span class="x">    .pipe($.plumber({ errorHandler: $.notify.onError('</span><span class="cp">&lt;%=</span> <span class="n">error</span><span class="o">.</span><span class="n">message</span> <span class="cp">%&gt;</span><span class="x">') }))</span>
<span class="x">    .pipe($.debug({ title: 'bowerjs files:' }))</span>
<span class="x">    .pipe($.sourcemaps.init())</span>
<span class="x">    //.pipe($.uglify())</span>
<span class="x">    .pipe($.concat('all.min.js'))</span>
<span class="x">    .pipe($.sourcemaps.write('./', {</span>
<span class="x">        sourceMappingURL: function (file) {</span>
<span class="x">            return file.relative + '.map';</span>
<span class="x">        }</span>
<span class="x">    }))</span>
<span class="x">    .pipe(gulp.dest('build/js'))</span>
<span class="x">    .pipe(browser.reload({ stream: true }))</span>
<span class="x">;</span>
</pre>

<p>});</p>
<p>これで作ったall.min.jsではエラーが出てだめですね。
単にsrcをconcatするだけではだめだ。本家のドキュメントを読み始める。
/three.js/utils/build/</p>
<p>でビルドできるよって書いてあります。python関係ないみたいだ。</p>
<blockquote>
<p>npm install
node build.js --include common --include extras</p>
</blockquote>
<p>なるほどbuild.jsを見てみよう。
includeってなんだろうと調べてみると
/three.js/utils/build/includes</p>
<p>にjsonファイルがあり中にjsファイルがリストされている。
なるほど。src下を全部concatするのではなくここに書いてあるものを、書いてある順でconcatすればいいんでないか。
// 
gulp.task('threejs:build', function(){
    var common=JSON.parse(fs.readFileSync('three.js/includes/common.json')).map(function(v, i){ return 'three.js/'+v; });
    gulp.src(common)
        .pipe($.concat('three.js'))
        .pipe(gulp.dest('./lib'))
        ;
});</p>
<p>gulp.task('bowerjs', ['threejs:build'], function () {
    // 前と同じ
}
````</p>
<p>これで実行するとそれっぽいthree.jsが出てくるが、まだエラーが出る。
でエラー行に飛ぶとifdefがある。なんだこれは。</p>
<p>```glsl</p>
<h2>ifdef USE_ALPHAMAP</h2>
<pre class="code literal-block"><span></span>diffuseColor.a *= texture2D( alphaMap, vUv ).g;
</pre>

<h2>endif</h2>
<p>glslだ・・・。
確かに、build.js内で拡張子がglslのファイルだけ別処理になっている。
if( file.indexOf( '.glsl') &gt;= 0 ) {</p>
<pre class="code literal-block"><span></span>contents = 'THREE.ShaderChunk[ \'' +
    path.basename( file, '.glsl' ) + '\' ] =' +
    JSON.stringify( contents ) + ';\n';
</pre>

<p>}</p>
<p>ちょっとgulpのフィルタを作りますか。
three.shaderchunk.js
var through = require('through2');
var gutil = require('gulp-util');
var fs = require('fs');
var path = require('path');</p>
<p>module.exports = function () {</p>
<pre class="code literal-block"><span></span>return through.obj(function (file, enc, cb) {

    if (file.isStream()) {
        cb(new gutil.PluginError('three.shadechunk', 'Streaming not supported'));
        return;
    }

    if (path.extname(file.path).toLowerCase() == '.glsl') {
        var contents = 'THREE.ShaderChunk[ \'' +
            path.basename(file.path, '.glsl') + '\' ] =' +
            JSON.stringify(file.contents.toString()) + ';\n';
        file.contents = new Buffer(contents);
        file.path = file.path + ".js";
    }

    this.push(file);

    cb();
});
</pre>

<p>}</p>
<p>gulpファイルの呼び出しの方。これでthree.js/srcからthree.jsを作成できた。
あとは、sourcemapが付くようにした。
gulpfile.js
gulp.task('threejs:build', function(){
    var common=JSON.parse(fs.readFileSync('three.js/includes/common.json'))
    .map(function(v, i){ return 'three.js/'+v; });
    var extras=JSON.parse(fs.readFileSync('three.js/includes/extras.json'))
    .map(function(v, i){ return 'three.js/'+v; });
    gulp.src(common.concat(extras))
        .pipe(threeShaderchunk())
        .pipe($.concat('three.js'))
        .pipe(gulp.dest('./lib'))
        ;
});</p>
<p>FireFoxでブレイクポイントを仕掛けてステップ実行できた。
これで、Loaderの自作とかが捗るぞ。</p>
</div>
                </div>
            </article>
</div>
    
        <ul class="pager postindexpager clearfix">
<li class="previous"><a href="index-15.html" rel="prev">新しい記事</a></li>
            <li class="next"><a href="index-13.html" rel="next">過去の記事</a></li>
        </ul>
<!--End of body content--><footer id="footer">
            Contents © 2021         <a href="mailto:ousttrue@gmail.com">ousttrue</a> - Powered by         <a href="https://getnikola.com" rel="nofollow">Nikola</a>         
            
            
        </footer>
</div>
</div>


        <script src="assets/js/all-nocdn.js"></script><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element){var i=element.getElementsByTagName('img')[0];return i===undefined?'':i.alt;}});
    </script>
</body>
</html>
