"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[769],{6074:function(e,n,l){l.r(n),l.d(n,{default:function(){return m}});var t=l(1151),c=l(7294);function r(e){const n=Object.assign({h1:"h1",p:"p",h2:"h2",code:"code",pre:"pre",ul:"ul",li:"li",h3:"h3"},(0,t.ah)(),e.components);return c.createElement(c.Fragment,null,c.createElement(n.h1,null,"w3m改造に再突入"),"\n",c.createElement(n.p,null,"なんとなく最初からやり直し。"),"\n",c.createElement(n.h2,null,"マクロカッター"),"\n",c.createElement(n.p,null,"今回は、 ",c.createElement(n.code,null,"python")," でマクロカッターを作って前処理してみた。"),"\n",c.createElement(n.pre,null,c.createElement(n.code,null,"#ifdef USE_UNICODE\n// hogehoge\n#endif\n")),"\n",c.createElement(n.p,null,"みたいな ",c.createElement(n.code,null,"#ifdef")," 事前に解決しえカットしていくツールである。\nめんどくさいので ",c.createElement(n.code,null,"if defined(HOGE)")," などは実装していない。\n",c.createElement(n.code,null,"true"),", ",c.createElement(n.code,null,"false"),", ",c.createElement(n.code,null,"none")," の3値で判断。\ntrue であれば ",c.createElement(n.code,null,"#if")," を削除。\nfalse であれば ",c.createElement(n.code,null,"#if")," ブロックをコードごと削除し。\n",c.createElement(n.code,null,"none")," であれば保持するというロジック。\nわりとうまくいって、コードがかなり簡単になった。"),"\n",c.createElement(n.h2,null,"いつも通り C++ 化"),"\n",c.createElement(n.p,null,"C++ 化しないとCの暗黙の型変換が緩すぎてコンパイルエラー追うのが難しくなるので、\n次の一手はこれ。"),"\n",c.createElement(n.p,null,c.createElement(n.code,null,"c++")," できたら、 ",c.createElement(n.code,null,"typdef struct Some {} Some;")," を ",c.createElement(n.code,null,"struct Some;")," に書き換える。\nこれでストレスをかなり低減できる。"),"\n",c.createElement(n.p,null,"局所性の高い関数をメンバー関数にする。\nなるべくメンバーを private にして、名前も ",c.createElement(n.code,null,"_")," などの prefix を付ける。\n大きい struct は分割する。\nコンストラクタ、デストラクタ、コピーコンストラクタは避ける。",c.createElement(n.code,null,"GC")," や ",c.createElement(n.code,null,"setmem(0)")," で死ぬ。\n同様に、 std::vector, std::string は慎重に導入する。"),"\n",c.createElement(n.h2,null,"macro 減らす"),"\n",c.createElement(n.p,null,"macro 関数を",c.createElement(n.code,null,"inline 関数")," に置き換えたり、\nmacro 定数を ",c.createElement(n.code,null,"enum")," に置き換える。int, char などを enum に置き換える。\n使えれば ",c.createElement(n.code,null,"bitfield")," とかも駆使。"),"\n",c.createElement(n.h2,null,"fm.h, proto.h, file.c の分配"),"\n",c.createElement(n.ul,null,"\n",c.createElement(n.li,null,c.createElement(n.code,null,".c")," と ",c.createElement(n.code,null,".h")," をペアにして関数を一致させる"),"\n",c.createElement(n.li,null,c.createElement(n.code,null,"struct")," 毎にヘッダを分ける。"),"\n",c.createElement(n.li,null,c.createElement(n.code,null,"global")," 変数を散らす"),"\n",c.createElement(n.li,null,c.createElement(n.code,null,"const char*")," との戦い。順次"),"\n"),"\n",c.createElement(n.p,null,"膨大な global 変数があるので、使わないもの思い切って削除する。"),"\n",c.createElement(n.h3,null,"file.c"),"\n",c.createElement(n.p,null,c.createElement(n.code,null,"file.c")," が 7000 行とかあってすごい。"),"\n",c.createElement(n.ul,null,"\n",c.createElement(n.li,null,"html のロードが 4500 くらい。 ",c.createElement(n.code,null,"table.c"),", ",c.createElement(n.code,null,"frame.c")," も関連？"),"\n",c.createElement(n.li,null,"http を操作が 500 くらい"),"\n"),"\n",c.createElement(n.p,null,"http アクセスや、html パース、ローカルCGI とか Buffer 操作が色々入っている。"),"\n",c.createElement(n.h2,null,"libuv"),"\n",c.createElement(n.h3,null,"mainloop"),"\n",c.createElement(n.p,null,"あっさりできてしまった。"),"\n",c.createElement(n.p,null,c.createElement(n.code,null,"tty input"),", ",c.createElement(n.code,null,"resize signal")," で ",c.createElement(n.code,null,"idle")," のときに描画などという方針でよさそう。\nraw モード切り替えなども ",c.createElement(n.code,null,"libuv")," 移行できそう。"),"\n",c.createElement(n.h3,null,"入力ストリーム"),"\n",c.createElement(n.p,null,"tcp, fd, FILE*, Str と圧縮 decoder のランタイム polymorphism.\nc++ の継承に置き換えて、 ",c.createElement(n.code,null,"void*")," の cast より、型チェックの聞く状態にできる。"),"\n",c.createElement(n.p,null,"TODO: libuv を使う"),"\n",c.createElement(n.h3,null,"linein / readline"),"\n",c.createElement(n.h3,null,"出力"),"\n",c.createElement(n.h3,null,"signal"),"\n",c.createElement(n.p,null,"読み込みを ",c.createElement(n.code,null,"ctrl-c")," で中断するなど。"),"\n",c.createElement(n.h2,null,"使わない機能を削る"),"\n",c.createElement(n.ul,null,"\n",c.createElement(n.li,null,"backend, dump など"),"\n",c.createElement(n.li,null,"pager 系の機能"),"\n",c.createElement(n.li,null,"news, gopher など使わないプロトコル"),"\n",c.createElement(n.li,null,"mouse 系の機能"),"\n",c.createElement(n.li,null,"search_header 系の機能"),"\n"),"\n",c.createElement(n.h2,null,"wtf-8 とは？"),"\n",c.createElement(n.p,null,"謎の文字コード ",c.createElement(n.code,null,"wtf-8")," について、再調査。"),"\n",c.createElement(n.p,null,"https://badsector.pullup.net/?p=70"),"\n",c.createElement(n.p,null,"👇"),"\n",c.createElement(n.p,null,"https://simonsapin.github.io/wtf-8/"),"\n",c.createElement(n.h2,null,"vt100 分離"),"\n",c.createElement(n.p,null,c.createElement(n.code,null,"Buffer = Screen => tty_out")," という流れに統一する。\n各所からローレベルの描画機能を呼ばない。"),"\n",c.createElement(n.p,null,"メッセージ表示も抽象化して、text を push するだけに。"),"\n",c.createElement(n.ul,null,"\n",c.createElement(n.li,null,"カーソル移動"),"\n",c.createElement(n.li,null,"out"),"\n",c.createElement(n.li,null,"flush"),"\n",c.createElement(n.li,null,"カーソル復帰"),"\n"),"\n",c.createElement(n.p,null,"とかしない。"),"\n",c.createElement(n.h2,null,"TODO: logger 導入"),"\n",c.createElement(n.h2,null,"UIとデータ構造の分離"),"\n",c.createElement(n.pre,null,c.createElement(n.code,null,"+----+\n|DATA| TabBuffer, Buffer, Anchor, Form, Image...\n+----+\n  A\n  |\n+----+\n| UI | mainloop... tty, key dispatch\n+----+\n")),"\n",c.createElement(n.p,null,c.createElement(n.code,null,"TabBuffer, Buffer, Anchor, FormList")," と ",c.createElement(n.code,null,"mainloop keydispatch")," あたりを分離する。\n片方向の参照。"),"\n",c.createElement(n.p,null,"バッファーローダーからグローバル変数を除去して、再入可能にする。\ntab を平行動作可能にする。"),"\n",c.createElement(n.h3,null,"TODO: lua 導入"),"\n",c.createElement(n.p,null,"DEFUN を lua で記述したい。\nrc も？"),"\n",c.createElement(n.h2,null,"TODO: libgc 減らす。止める"),"\n",c.createElement(n.h2,null,"TODO: zig に移植"),"\n",c.createElement(n.p,null,c.createElement(n.code,null,"zig cc")," でビルドはできた。\nじゃなくて、ソースを ",c.createElement(n.code,null,"zig")," にしたい。"),"\n",c.createElement(n.h2,null,"TODO"),"\n",c.createElement(n.p,null,"Windows ネイティブで動くようにしたい。\n",c.createElement(n.code,null,"libuv")," + ",c.createElement(n.code,null,"conpty")," できそうな気がするのだけど、まだまだ。"))}var u=function(e){void 0===e&&(e={});const{wrapper:n}=Object.assign({},(0,t.ah)(),e.components);return n?c.createElement(n,e,c.createElement(r,e)):r(e)};l(8678);function a(e){let{data:n,children:l}=e;return c.createElement(c.Fragment,null,c.createElement("h1",null,n.mdx.frontmatter.title),c.createElement(t.Zo,null,l))}function m(e){return c.createElement(a,e,c.createElement(u,e))}},8678:function(e,n,l){l(7294)},1151:function(e,n,l){l.d(n,{Zo:function(){return a},ah:function(){return r}});var t=l(7294);const c=t.createContext({});function r(e){const n=t.useContext(c);return t.useMemo((()=>"function"==typeof e?e(n):{...n,...e}),[n,e])}const u={};function a({components:e,children:n,disableParentContext:l}){let a;return a=l?"function"==typeof e?e({}):e||u:r(e),t.createElement(c.Provider,{value:a},n)}}}]);
//# sourceMappingURL=component---src-templates-post-template-js-content-file-path-home-runner-work-ousttrue-github-io-ousttrue-github-io-content-posts-2022-0918-w-3-m-mod-md-c7be9d8bcd68367b5565.js.map