<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article# " lang="ja">
<head>
<meta charset="utf-8">
<meta name="description" content="作業記録">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>三次元日誌 (過去の記事 22ページ目) | 三次元日誌</title>
<link href="assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<link href="https://fonts.googleapis.com/css?family=Playfair+Display:700,900" rel="stylesheet">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" hreflang="ja" href="rss.xml">
<link rel="canonical" href="https://ousttrue.github.io/index-22.html">
<link rel="prev" href="index-23.html" type="text/html">
<link rel="next" href="index-21.html" type="text/html">
<!--[if lt IE 9]><script src="assets/js/html5.js"></script><![endif]-->
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">本文を読み飛ばす</a>

<!-- Header and menu bar -->
<div class="container">
      <header class="blog-header py-3"><div class="row nbb-header align-items-center">
          <div class="col-md-3 col-xs-2 col-sm-2" style="width: auto;">
            <button class="navbar-toggler navbar-light bg-light nbb-navbar-toggler" type="button" data-toggle="collapse" data-target=".bs-nav-collapsible" aria-controls="bs-navbar" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse bs-nav-collapsible bootblog4-search-form-holder">
                
            </div>
        </div>
          <div class="col-md-6 col-xs-10 col-sm-10 bootblog4-brand" style="width: auto;">
            <a class="navbar-brand blog-header-logo text-dark" href=".">

            <span id="blog-title">三次元日誌</span>
        </a>
          </div>
            <div class="col-md-3 justify-content-end align-items-center bs-nav-collapsible collapse flex-collapse bootblog4-right-nav">
            <nav class="navbar navbar-light bg-white"><ul class="navbar-nav bootblog4-right-nav"></ul></nav>
</div>
    </div>
</header><nav class="navbar navbar-expand-md navbar-light bg-white static-top"><div class="collapse navbar-collapse bs-nav-collapsible" id="bs-navbar">
            <ul class="navbar-nav nav-fill d-flex w-100">
<li class="nav-item">
<a href="books" class="nav-link">MemoBooks</a>
                </li>
<li class="nav-item">
<a href="archive.html" class="nav-link">Archives</a>
                </li>
<li class="nav-item">
<a href="categories/index.html" class="nav-link">Tags</a>
                </li>
<li class="nav-item">
<a href="rss.xml" class="nav-link">RSS feed</a>
                </li>
<li class="nav-item">
<a href="about" class="nav-link">About</a>

                
            </li>
</ul>
</div>
<!-- /.navbar-collapse -->
</nav>
</div>

<div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        
        
        
    
        

    
        
    <div class="postindex">
            <article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="github/aruco_test/" class="u-url">aruco_test</a></h1>
                <div class="metadata">
                    <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                        ousttrue
                    </span></p>
            <p class="dateline">
            <a href="github/aruco_test/" rel="bookmark">
            <time class="published dt-published" datetime="2017-07-01T14:50:56Z" itemprop="datePublished" title="2017-07-01 14:50">2017-07-01 14:50</time><span class="updated"> (更新日時
                    <time class="dt-updated" datetime="2017-07-04T11:35:36Z" itemprop="dateUpdated" title="2017-07-04 11:35">2017-07-04 11:35</time>)</span>
            </a>
            </p>
                </div>
            </header><div class="e-content entry-content">
                    <div>
<p><a href="https://github.com/ousttrue/aruco_test">https://github.com/ousttrue/aruco_test</a></p>
<p>aruco test project</p>
</div>
                </div>
            </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/2017/07/cmake_2017/" class="u-url">vcpkgでopencvの開発環境を作る</a></h1>
                <div class="metadata">
                    <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                        ousttrue
                    </span></p>
            <p class="dateline">
            <a href="posts/2017/07/cmake_2017/" rel="bookmark">
            <time class="published dt-published" datetime="2017-07-01T00:00:00+09:00" itemprop="datePublished" title="2017-07-01 00:00">2017-07-01 00:00</time></a>
            </p>
                </div>
            </header><div class="e-content entry-content">
                    <div>
<p>Windowsでcmakeを使う場合に外部ライブラリの解決がわりと困難。</p>
<p>cmakeのfind_packageがうまくうごかないのである。Unix系であれば <code>CMAKE_INSTALL_PREFIX(/usr/local)</code> にインストールされた依存プロジェクトを発見できるし、足りなければインストールすることもできる。それに、<code>apt-get</code> とか <code>pacman</code> とかあるので、自分で全部ビルドするということはあまり必要なかったりする今日この頃です。Windowsにはそういうのがなかった(CMAKE_INSTALL_PREFIXはどこなのか)のだけど、最近出てきたvcpkgがそれをやってくれる。</p>
<p>ArUcoをvcpkgとcmakeでビルドする
ということでvcpkgで外部ライブラリを構築し、一部をソースごとプロジェクトにコピーする方法でArUco(OpenCV)のビルドをやってみる。ArUcoのデバッグ版にアタッチしたり改造したりするつもりなので、opencvのモジュール版ArUcoではなく単体の方を使う。環境は、Windows10(64bit)にVisualStudio2017(C++)。
vcpkgを準備</p>
<ul>
<li>https://github.com/Microsoft/vcpkg</li>
</ul>
<pre class="code literal-block"><span></span>&gt; git clone https://github.com/Microsoft/vcpkg.git
&gt; <span class="nb">cd</span> vcpkg
vcpkg&gt; .<span class="se">\b</span>ootstrap-vcpkg.bat

vcpkgで64bit版のopencvをインストール
vcpkg&gt; .<span class="se">\v</span>cpkg.exe install opencv:x64-windows

vcpkg/installed/x64-windowsにinclude, lib, bin等がインストールされる。
vcpkgで64bit版のfreeglutをインストール
vcpkg&gt; .<span class="se">\v</span>cpkg.exe install freeglut:x64-windows
</pre>

<p>arucoのソースを入手
OpenCVのモジュール</p>
<p>http://docs.opencv.org/trunk/d9/d6d/tutorial_table_of_content_aruco.html</p>
<p>ではなくてこっち。</p>
<p>http://www.uco.es/investiga/grupos/ava/node/26
https://sourceforge.net/projects/aruco/files/</p>
<p>aruco-2.0.19.zipを手に入れた。
とりあえずビルドしてみる
vcpkgはd:/vcpkgにインストールされている。</p>
<pre class="code literal-block"><span></span>aruco-2.0.19&gt; mkdir build
aruco-2.0.19/build&gt; cmake -D <span class="nv">CMAKE_INSTALL_PREFIX</span><span class="o">=</span>d:/vcpkg/installed/x64-windows -D <span class="nv">OpenCVDir</span><span class="o">=</span>d:/vcpkg/installed/x64-windows/share/opencv -D <span class="nv">BUILD_GLSAMPLES</span><span class="o">=</span><span class="m">1</span> -G <span class="s2">"Visual Studio 15 2017 Win64"</span> ..
</pre>

<p>aruco_test_glとaruco_test_markermap_glのビルドでエラーが出るのでちょっとコードを修正する。
gl.hより先にWindows.hをincludeしてあげる。</p>
<pre class="code literal-block"><span></span><span class="cp">#ifdef __APPLE__</span>
<span class="cp">#include</span> <span class="cpf">&lt;GLUT/glut.h&gt;</span><span class="cp"></span>

<span class="cp">#elif defined(_MSC_VER)</span>
<span class="cp">#include</span> <span class="cpf">&lt;Windows.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;GL/glut.h&gt;</span><span class="cp"></span>

<span class="cp">#else</span>
<span class="cp">#include</span> <span class="cpf">&lt;GL/gl.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;GL/glut.h&gt;</span><span class="cp"></span>
<span class="cp">#endif</span>
</pre>

<p>あとfreeglutのリンクををdebug, release振り分けのために、
CMakeLists.txtをちょっと改造。だいたいこういう感じ。</p>
<pre class="code literal-block"><span></span><span class="nb">IF</span> <span class="p">(</span><span class="s">GLUT_FOUND</span><span class="p">)</span>
    <span class="nb">STRING</span><span class="p">(</span><span class="s">REPLACE</span> <span class="s">lib/freeglut.lib</span> <span class="s">debug/lib/freeglutd.lib</span> <span class="s">GLUT_glut_DEBUG_LIBRARY</span> <span class="o">${</span><span class="nv">GLUT_glut_LIBRARY</span><span class="o">}</span><span class="p">)</span>
    <span class="nb">MESSAGE</span><span class="p">(</span><span class="s">STATUS</span> <span class="s2">"GLUT_glut_DEBUG_LIBRARY=${GLUT_glut_DEBUG_LIBRARY}"</span><span class="p">)</span>
    <span class="nb">set</span> <span class="p">(</span><span class="s">OPENGL_LIBS</span>  <span class="s">general</span>
        <span class="o">${</span><span class="nv">OPENGL_gl_LIBRARY</span><span class="o">}</span>
        <span class="o">${</span><span class="nv">OPENGL_glu_LIBRARY</span><span class="o">}</span>
        <span class="s">optimized</span> <span class="o">${</span><span class="nv">GLUT_glut_LIBRARY</span><span class="o">}</span>
        <span class="s">debug</span> <span class="o">${</span><span class="nv">GLUT_glut_DEBUG_LIBRARY</span><span class="o">}</span>
        <span class="p">)</span>
<span class="nb">ENDIF</span><span class="p">()</span>
</pre>

<p>この部分と連携する。
TARGET_LINK_LIBRARIES(aruco_test_gl ${OPENGL_LIBS})</p>
<p>これで、CMAKE_INSTALL_PREFIX/binにパスを通せばプログラムは動作する。
arucoのテストデータを入手してwebcamで動作確認
テストデータを入手する。</p>
<p>https://sourceforge.net/projects/aruco/files/</p>
<p>aruco-test-data-2.0.zipを手に入れた。
この中のintrinsics.ymlを引数にして実行する(本来は、カメラキャリブレーションをしてintrinsics.ymlを自分のカメラ用に作成する必要がある)。
aruco_test_gl.exe "live" "path_to_intrinsics.yml" 0.05
aruco_test_glとarucoの入った小さいプロジェクト
ArUcoを改造する予定。</p>
<p>intrinsics.ymlを省略したり簡略化したい(fovyとaspectratioだけにするなど)
左手系(DirectXやUnity)に対応</p>
<p>ということで、arucoのソースを含めている。</p>
<pre class="code literal-block"><span></span>aruco_test

  + CMakeLists.txt

  + aruco_test_gl
    + CMakeLists.txt
    + aruco_test_gl.cpp<span class="o">(</span>aruco-2.0.19/utils_gl/aruco_test_gl.cppをコピー<span class="o">)</span>

  + src<span class="o">(</span>aruco-2.0.19/srcをコピー<span class="o">)</span>
</pre>

<pre class="code literal-block"><span></span><span class="nb">CMAKE_MINIMUM_REQUIRED</span><span class="p">(</span><span class="s">VERSION</span> <span class="s">2.8</span><span class="p">)</span>
<span class="nb">PROJECT</span><span class="p">(</span><span class="s">aruco</span><span class="p">)</span>

<span class="nb">FIND_PACKAGE</span><span class="p">(</span><span class="s">OpenCV</span> <span class="s">REQUIRED</span> <span class="p">)</span>
<span class="nb">SET</span> <span class="p">(</span><span class="s">ARUCO_REQUIRED_LIBRARIES</span> <span class="o">${</span><span class="nv">OpenCV_LIBS</span><span class="o">}</span><span class="p">)</span>
<span class="nb">INCLUDE_DIRECTORIES</span><span class="p">(</span><span class="o">${</span><span class="nv">OpenCV_INCLUDE_DIRS</span><span class="o">}</span><span class="p">)</span>

<span class="nb">FIND_PACKAGE</span><span class="p">(</span><span class="s">OpenGL</span> <span class="s">REQUIRED</span><span class="p">)</span>

<span class="nb">FIND_PACKAGE</span><span class="p">(</span><span class="s">GLUT</span><span class="p">)</span>
<span class="nb">MESSAGE</span><span class="p">(</span><span class="s">STATUS</span> <span class="s2">"GLUT_glut_LIBRARY=${GLUT_glut_LIBRARY}"</span><span class="p">)</span>
<span class="nb">STRING</span><span class="p">(</span><span class="s">REPLACE</span> <span class="s">lib/freeglut.lib</span> <span class="s">debug/lib/freeglutd.lib</span> <span class="s">GLUT_glut_DEBUG_LIBRARY</span> <span class="o">${</span><span class="nv">GLUT_glut_LIBRARY</span><span class="o">}</span><span class="p">)</span>
<span class="nb">MESSAGE</span><span class="p">(</span><span class="s">STATUS</span> <span class="s2">"GLUT_glut_DEBUG_LIBRARY=${GLUT_glut_DEBUG_LIBRARY}"</span><span class="p">)</span>
<span class="nb">IF</span> <span class="p">(</span><span class="s">GLUT_FOUND</span><span class="p">)</span>
    <span class="nb">set</span> <span class="p">(</span><span class="s">OPENGL_LIBS</span>  <span class="s">general</span>
        <span class="o">${</span><span class="nv">OPENGL_gl_LIBRARY</span><span class="o">}</span>
        <span class="o">${</span><span class="nv">OPENGL_glu_LIBRARY</span><span class="o">}</span>
        <span class="s">optimized</span> <span class="o">${</span><span class="nv">GLUT_glut_LIBRARY</span><span class="o">}</span>
        <span class="s">debug</span> <span class="o">${</span><span class="nv">GLUT_glut_DEBUG_LIBRARY</span><span class="o">}</span>
        <span class="p">)</span>
<span class="nb">ENDIF</span><span class="p">()</span>

<span class="nb">ADD_DEFINITIONS</span><span class="p">(</span><span class="s">-D_SCL_SECURE_NO_WARNINGS</span><span class="p">)</span>
<span class="nb">SET</span><span class="p">(</span><span class="s">CMAKE_CXX_FLAGS</span> <span class="s2">"/wd4819 /EHsc"</span><span class="p">)</span>

<span class="nb">ADD_SUBDIRECTORY</span><span class="p">(</span><span class="s">src</span><span class="p">)</span>
<span class="nb">ADD_SUBDIRECTORY</span><span class="p">(</span><span class="s">utils_gl</span><span class="p">)</span>

<span class="err">aruco_test_gl/CMakeLists.txt</span>
<span class="nb">INCLUDE_DIRECTORIES</span><span class="p">(</span><span class="o">${</span><span class="nv">PROJECT_SOURCE_DIR</span><span class="o">}</span><span class="s">/src</span> <span class="o">${</span><span class="nv">GNULIBS_INCLUDE_DIR</span><span class="o">}</span><span class="p">)</span>
<span class="nb">LINK_LIBRARIES</span><span class="p">(</span><span class="o">${</span><span class="nv">PROJECT_NAME</span><span class="o">}</span> <span class="o">${</span><span class="nv">REQUIRED_LIBRARIES</span><span class="o">}</span> <span class="p">)</span>

<span class="nb">IF</span><span class="p">(</span><span class="s">OPENGL_LIBS</span><span class="p">)</span>
    <span class="nb">ADD_EXECUTABLE</span><span class="p">(</span><span class="s">aruco_test_gl</span>
        <span class="s">aruco_test_gl.cpp</span>
        <span class="p">)</span>
    <span class="nb">TARGET_LINK_LIBRARIES</span><span class="p">(</span><span class="s">aruco_test_gl</span> <span class="o">${</span><span class="nv">OPENGL_LIBS</span><span class="o">}</span><span class="p">)</span>
</pre>

<p>以上で、arucoを例にvcpkgでopencvとfreeglutdを外部管理してcmakeでプロジェクトを取り廻す例を作った。
作業例。</p>
<p>https://github.com/ousttrue/aruco_test</p>
</div>
                </div>
            </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/2017/06/ts_module/" class="u-url">Typescriptのモジュールでまたはまる</a></h1>
                <div class="metadata">
                    <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                        ousttrue
                    </span></p>
            <p class="dateline">
            <a href="posts/2017/06/ts_module/" rel="bookmark">
            <time class="published dt-published" datetime="2017-06-14T00:00:00+09:00" itemprop="datePublished" title="2017-06-14 00:00">2017-06-14 00:00</time></a>
            </p>
                </div>
            </header><div class="e-content entry-content">
                    <div>
<p>Typescriptで出力したjsのimort周りではまったので実験してみる。</p>
<p>export + import from</p>
</div>
                </div>
            </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/2017/06/python_asyncio/" class="u-url">Python3のasyncioについてのメモ</a></h1>
                <div class="metadata">
                    <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                        ousttrue
                    </span></p>
            <p class="dateline">
            <a href="posts/2017/06/python_asyncio/" rel="bookmark">
            <time class="published dt-published" datetime="2017-06-10T00:00:00+09:00" itemprop="datePublished" title="2017-06-10 00:00">2017-06-10 00:00</time></a>
            </p>
                </div>
            </header><div class="e-content entry-content">
                    <div>
<p>PythonのVersion3.4から始まったasyncio周りについてのメモ。
環境は、Windows10上のpython3.6(64bit)。</p>
<p>Version
Python3.4</p>
<p>asyncio
yield from</p>
<p>Python3.5</p>
<p>async def
await</p>
<p>EventLoop</p>
<p>https://docs.python.org/3/library/asyncio-eventloop.html</p>
<p>import asyncio
loop=asyncio.get_event_loop()
print(loop)</p>
<h2>&lt;_WindowsSelectorEventLoop running=False closed=False debug=False&gt;</h2>
<p>loop.run_forever()
print('done')</p>
<p>ただし永遠(forever)走り続けるのでプロセスをkillしないと止まらず。
Windows向けのloop</p>
<p>https://docs.python.org/3/library/asyncio-eventloops.html#asyncio.ProactorEventLoop</p>
<p>import asyncio
import sys</p>
<p>if sys.platform == 'win32':
    loop = asyncio.ProactorEventLoop()
    # <proactoreventloop running="False" closed="False" debug="False">
    asyncio.set_event_loop(loop)
else:
    loop = asyncio.get_event_loop()</proactoreventloop></p>
<p>以降、loopを得るコードを省略。
EventLoopに関数を投入する
def func(loop):
    loop.stop() # 停止</p>
<p>loop.call_soon(func, loop)
loop.run_forever()
print('done')</p>
<p>asyncio.get_event_loopでloopを取得。loop.call_soonでloopに関数を投入できる。
投入された関数は、loop.run_foreverで消化される。
ついでに、loop.stopでrun_foreverから抜けることができる。
EventLoopにgeneratorを投入する
def gen(loop, name, count):
    print(name, loop.time())
    for i in range(count):
        print(name, i, loop.time())
        yield
    print(name, 'done')
    loop.stop()</p>
<p>asyncio.ensure_future(gen(loop, 'a', 3))
asyncio.ensure_future(gen(loop, 'b', 3))
loop.run_forever()</p>
<p>a 534341.609
a 0 534341.609
b 534341.609
b 0 534341.609
a 1 534341.609
b 1 534341.609
a 2 534341.609
b 2 534341.609
a done
b done</p>
<p>loop.stopで止まった。
すべてのtaskが終わるのを待つ
def gen(loop, name, count):
    print(name, loop.time())
    for i in range(count):
        print(name, i, loop.time())
        yield
    print(name, 'done')</p>
<p>taskA=asyncio.ensure_future(gen(loop, 'a', 3), loop=loop)
taskB=asyncio.ensure_future(gen(loop, 'b', 5), loop=loop)
future=asyncio.gather(taskA, taskB)
future.add_done_callback(lambda future: loop.stop())
task=asyncio.ensure_future(future, loop=loop)</p>
<p>loop.run_forever()</p>
<p>a 571911.359
a 0 571911.359
b 571911.359
b 0 571911.359
a 1 571911.359
b 1 571911.359
a 2 571911.359
b 2 571911.359
a done
b 3 571911.359
b 4 571911.359
b done</p>
<p>loop.run_until_completeでfutureが終わるのを待つ
def gen(loop, name, count):
    print(name, loop.time())
    for i in range(count):
        print(name, i, loop.time())
        yield
    print(name, 'done')
futureA=asyncio.ensure_future(gen(loop, 'a', 3), loop=loop)
futureB=asyncio.ensure_future(gen(loop, 'b', 5), loop=loop)
future=asyncio.gather(futureA, futureB)</p>
<p>loop.run_until_complete(future)</p>
<p>futureの終了を待ってloop.stopしたいならrun_until_completeするのが明瞭。
PEP492 – Coroutines with async and await syntax(python3.5 09-Apr-2015)</p>
<p>generatorを流用したcoroutineは紛らわしいので、coroutineに独自のシンタックスを導入するで。native coroutineと呼称する。Cで実装しているわけではない。
関数内でawaitを使わなくてもcoroutineとして有効</p>
<p>async def read_data(db):
    pass</p>
<p>EventLoopにnative coroutineを投入する
async def gen(loop, name, count):
    print(name, loop.time())
    for i in range(count):
        print(name, i, loop.time())
        #yield
        await asyncio.sleep(0)
    print(name, 'done')</p>
<p>taskA=asyncio.ensure_future(gen(loop, 'a', 3), loop=loop)
taskB=asyncio.ensure_future(gen(loop, 'b', 5), loop=loop)
future=asyncio.gather(taskA, taskB)</p>
<p>loop.run_until_complete(future)</p>
<p>yieldをawait asyncio.sleep(0)で置き換えた。
yieldのままだとTypeErrorになる。
Traceback (most recent call last):
  File ".\exp.py", line 18, in <module>
    taskA=asyncio.ensure_future(gen(loop, 'a', 3), loop=loop)
  File "D:\Python36\lib\asyncio\tasks.py", line 519, in ensure_future
    raise TypeError('A Future, a coroutine or an awaitable is required')
TypeError: A Future, a coroutine or an awaitable is required</module></p>
<p>It is a TypeError if <strong>await</strong> returns anything but an iterator.
実験。
def it():
    yield</p>
<p>async def co_y():
    yield</p>
<p>async def co():
    pass</p>
<p><class><class>
.\exp.py:22: RuntimeWarning: coroutine 'co' was never awaited
  print(type(co()))
<class></class></class></class></p>
<p>async_generator…。async def内でyieldすると違うものになるのね。syntax errorにはできんな。
自前のメインループにloopを組み込むとすれば
loop.onceのような関数があると毎フレーム小出しにタスクを消化できるのだが。
ググってみた。</p>
<p>https://stackoverflow.com/questions/29868372/python-asyncio-run-event-loop-once</p>
<p>loop.stop(); loop.run_forever()</p>
<p>なるほど。
async def gen(loop, name, count):
    print(name, loop.time())
    for i in range(count):
        print(name, i, loop.time())
        await asyncio.sleep(0)
    print(name, 'done')</p>
<p>taskA=asyncio.ensure_future(gen(loop, 'a', 3), loop=loop)
taskB=asyncio.ensure_future(gen(loop, 'b', 5), loop=loop)
future=asyncio.gather(taskA, taskB)</p>
<p>count=1
while not future.done():
    print(count)
    count+=1
    # loop one step
    loop.stop()
    loop.run_forever()</p>
<p>print('done')</p>
<p>1
a 579281.828
a 0 579281.828
b 579281.828
b 0 579281.828
2
a 1 579281.828
b 1 579281.828
3
a 2 579281.828
b 2 579281.828
4
a done
b 3 579281.828
5
b 4 579281.828
6
b done
7
done</p>
<p>いいかんじになった。これなら付き合っていけそうだ。</p>
</div>
                </div>
            </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/2017/06/threejs_setup/" class="u-url">threejsとwebsocketを使った開発環境</a></h1>
                <div class="metadata">
                    <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                        ousttrue
                    </span></p>
            <p class="dateline">
            <a href="posts/2017/06/threejs_setup/" rel="bookmark">
            <time class="published dt-published" datetime="2017-06-07T00:00:00+09:00" itemprop="datePublished" title="2017-06-07 00:00">2017-06-07 00:00</time></a>
            </p>
                </div>
            </header><div class="e-content entry-content">
                    <div>
<p>threejsのソースを自前で、minimizeする環境を模索する。</p>
<p>なんとなくwebpackをメインに据えてみたい。
npm install -g xxxは適宜やるとして省略。
es2015メモ</p>
<p>const, let
無名関数はアロー形式で()=&gt;{} もしくは()=&gt;expression
文字テンプレート<code>${expression}</code>
promise, await</p>
<p>Project作成
$ mkdir app
$ cd app
app$ npm init</p>
<p>とりあえずgitに登録しよう。
.gitignoreは、</p>
<p>https://github.com/github/gitignore/blob/master/Node.gitignore
https://raw.githubusercontent.com/github/gitignore/master/Node.gitignore</p>
<p>をそのまま採用させていただきます。
app$ git init
app$ git add .
app$ git commit -m init </p>
<p>WebSocketServer
app$ npm install websocket --save</p>
<p>server.js
'use strict';</p>
<p>const http = require('http');
const WSServer = require('websocket').server;
const url = require('url');
const fs = require('fs')</p>
<p>const port=8888;</p>
<p>function onHttpRequest(req, res)
{
    fs.readFile('client.html', 'utf8', (err, text)=&gt;{
        res.writeHead(200, { 'Content-Type': 'text/html'});
        res.end(text);
    });
}
const plainHttpServer = http.createServer(onHttpRequest).listen(port);
const webSocketServer = new WSServer({httpServer: plainHttpServer});</p>
<p>let clients=[];
function broadcast(message) {
    clients.forEach((con, i)=&gt; {
        con.send(message);
    });
}</p>
<p>function onRequest(req)
{
    const websocket = req.accept(null, req.origin || '*');</p>
<pre class="code literal-block"><span></span>clients.push(websocket);

websocket.send("welcome to this server");
broadcast(`clients: [<span class="cp">${</span><span class="n">clients</span><span class="o">.</span><span class="n">map</span><span class="p">((</span><span class="n">v</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span><span class="o">=&gt;</span><span class="n">v</span><span class="o">.</span><span class="n">remoteAddress</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">', '</span><span class="p">)</span><span class="cp">}</span>]`);

websocket.on('message', (msg)=&gt;{
    console.log(`"<span class="cp">${</span><span class="n">msg</span><span class="o">.</span><span class="n">utf8Data</span><span class="cp">}</span>" is recieved from <span class="cp">${</span><span class="n">req</span><span class="o">.</span><span class="n">origin</span><span class="cp">}</span> !`);
    websocket.send(msg.utf8Data);
});

websocket.on('close', (code,desc)=&gt;{
    console.log(`connection released!: <span class="cp">${</span><span class="n">code</span><span class="cp">}</span> - <span class="cp">${</span><span class="n">desc</span><span class="cp">}</span>`);

    clients=clients.filter((v, i)=&gt;v!=websocket);
    broadcast(`clients: [<span class="cp">${</span><span class="n">clients</span><span class="o">.</span><span class="n">map</span><span class="p">((</span><span class="n">v</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span><span class="o">=&gt;</span><span class="n">v</span><span class="o">.</span><span class="n">remoteAddress</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">', '</span><span class="p">)</span><span class="cp">}</span>]`);
});
</pre>

<p>}</p>
<p>webSocketServer.on('request', onRequest);</p>
<p>console.log(<code>server start: ${port}</code>);</p>
<p>client.html

    </p>
    
    
        <input id="message" type="text"><button id="send">send</button>
        <div id="output"></div>
<pre class="code literal-block"><span></span>    &lt;script&gt;
</pre>

<p>'use strict';
let attempts = 1;
let ws=null;</p>
<p>const output = document.getElementById('output');
const sendmessage = document.getElementById('message');
sendmessage.addEventListener('keydown', (e)=&gt;{
    if(e.keyCode==13){
        send(sendmessage.value);
    }
});
document.getElementById('send').addEventListener('click', ()=&gt;send(sendmessage.value));</p>
<p>function logger(msg)
{
    output.innerHTML += <code>&lt;div&gt;${msg}&lt;/div&gt;</code>;
}
function send(msg)
{
    ws.send(msg);
    logger(<code>send: ${msg}</code>);
}</p>
<p>function createWebSocket () {
    logger(<code>connecting... ${attempts++}</code>);</p>
<pre class="code literal-block"><span></span>ws = new WebSocket(`ws://<span class="cp">${</span><span class="n">location</span><span class="o">.</span><span class="n">host</span><span class="cp">}</span>`);

ws.onopen = (e)=&gt; {
    logger(`<span class="cp">${</span><span class="n">e</span><span class="o">.</span><span class="n">type</span><span class="cp">}</span>: <span class="cp">${</span><span class="n">e</span><span class="o">.</span><span class="n">code</span> <span class="o">||</span> <span class="s1">''</span><span class="cp">}</span>`);

    // reset the tries back to 1 since we have a new ws opened.
    attempts = 1;

    // ...Your app's logic...
}

ws.onclose = (e)=&gt; {
    logger(`<span class="cp">${</span><span class="n">e</span><span class="o">.</span><span class="n">type</span><span class="cp">}</span>: <span class="cp">${</span><span class="n">e</span><span class="o">.</span><span class="n">code</span> <span class="o">||</span> <span class="s1">''</span><span class="cp">}</span>`);
    ws=null;

    const time = generateInterval(attempts);

    setTimeout(()=&gt;{
        // Connection has closed so try to reconnect every 10 seconds.
        createWebSocket(); 
    }, time);
}

ws.onmessage =(e)=&gt;{
    logger(`<span class="cp">${</span><span class="n">e</span><span class="o">.</span><span class="n">type</span><span class="cp">}</span>: <span class="cp">${</span><span class="n">e</span><span class="o">.</span><span class="n">data</span><span class="cp">}</span>`);
}
</pre>

<p>}</p>
<p>function generateInterval (k) {
    let maxInterval = (Math.pow(2, k) - 1) * 1000;</p>
<pre class="code literal-block"><span></span>if (maxInterval &gt; 30*1000) {
    maxInterval = 30*1000; // If the generated interval is more than 30 seconds, truncate it down to 30 seconds.
}

// generate the interval to a random number between 0 and the maxInterval determined from above
return Math.random() * maxInterval;
</pre>

<p>}</p>
<p>window.addEventListener('DOMContentLoaded', ()=&gt; createWebSocket());
        
    
</p>
<p>WebSocketを再接続するアルゴリズムの工夫</p>
<p>webpack</p>
<p>http://webpack.github.io/docs/tutorials/getting-started/</p>
<p>threejs</p>
</div>
                </div>
            </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/2017/06/threejs/" class="u-url">threejs再始動</a></h1>
                <div class="metadata">
                    <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                        ousttrue
                    </span></p>
            <p class="dateline">
            <a href="posts/2017/06/threejs/" rel="bookmark">
            <time class="published dt-published" datetime="2017-06-06T00:00:00+09:00" itemprop="datePublished" title="2017-06-06 00:00">2017-06-06 00:00</time></a>
            </p>
                </div>
            </header><div class="e-content entry-content">
                    <div>
<p>前のサイトはgulpを使ってtypescriptでthreejs.jsしていたのだけど、hugoで生成している今サイトでは素のjavascriptかなぁ。
es6の練習を兼ねて。</p>
<p>hugoのmdファイルの中に直書きしてみた</p>
<div id="threejs"></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/85/three.min.js"></script><script type="text/javascript" src="https://threejs.org/examples/js/controls/OrbitControls.js"></script><script>
function createScene()
{
    var scene=new THREE.Scene();

    var geometry = new THREE.BoxGeometry(1, 1, 1);
    var material = new THREE.MeshPhongMaterial({ color: 0x0000ff });
    var box = new THREE.Mesh(geometry, material);
    box.position.y = 0.5;
    scene.add(box);

    var light = new THREE.DirectionalLight(0xffffff);
    light.position.set(1, 1, 1);
    scene.add(light);

    var planeGeometry = new THREE.PlaneGeometry( 10, 10, 10, 10 );
    var planeMaterial = new THREE.MeshBasicMaterial( { color: 0x533E25, wireframe:true} );
    var planeMesh = new THREE.Mesh( planeGeometry, planeMaterial );
    var toRad=Math.PI / 180;
    planeMesh.rotation.x = 90 * toRad;
    scene.add( planeMesh );

    var axis = new THREE.AxisHelper(1000);
    axis.position.set(0,0,0);
    scene.add(axis);

    return scene;
}

window.addEventListener('DOMContentLoaded', function() {

    var renderer = new THREE.WebGLRenderer();
    renderer.setSize(800, 600);
    document.getElementById("threejs").appendChild(renderer.domElement);

    var scene = createScene();

    var camera = new THREE.PerspectiveCamera(45, 800 / 600, 1, 1000);
    camera.position.set(2, 3, 5);
    camera.lookAt({x:0, y:0, z:0 });

    var controls = new THREE.OrbitControls(camera);

    var render = function () {
        requestAnimationFrame(render);
        //cube.rotation.x += 1 * Math.PI / 180;
        //cube.rotation.y += 1 * Math.PI / 180;
        //cube.rotation.z += 1 * Math.PI / 180;
        controls.update();
        renderer.render(scene, camera);
    };
    render();
});
</script><p>動いた。
なるほど。
ToDo
ちょっとOrbitControlsをカスタマイズしたいね。
メタセコ的なマウスボタンのアサインにしたい</p>
<p>左ドラッグはカメラ操作以外に開けておく
右ドラッグがカメラ回転
中ドラッグがカメラ移動
ホイールがカメラドリー</p>
<p>マウスイベントの取得はWebGLエレメントの上にマウスカーソルがあるときだけ</p>
<p>OrbitControls.jsが原因でテキストボックスに入力できなくなった問題の解決</p>
<pre class="code literal-block"><span></span>stage.addEventListener('mouseover', function() {
        controls.enabled = true;
        document.body.style.cursor = "pointer";
        });

stage.addEventListener('mouseout', function() {
        controls.enabled = false;
        document.body.style.cursor = "default";
        });
</pre>

<p>function createScene()
{
    var scene=new THREE.Scene();</p>
<pre class="code literal-block"><span></span><span class="nt">var</span> <span class="nt">geometry</span> <span class="o">=</span> <span class="nt">new</span> <span class="nt">THREE</span><span class="p">.</span><span class="nc">BoxGeometry</span><span class="o">(</span><span class="nt">1</span><span class="o">,</span> <span class="nt">1</span><span class="o">,</span> <span class="nt">1</span><span class="o">);</span>
<span class="nt">var</span> <span class="nt">material</span> <span class="o">=</span> <span class="nt">new</span> <span class="nt">THREE</span><span class="p">.</span><span class="nc">MeshPhongMaterial</span><span class="o">(</span><span class="p">{</span> <span class="k">color</span><span class="p">:</span> <span class="mi">0</span><span class="n">x0000ff</span> <span class="p">}</span><span class="o">);</span>
<span class="nt">var</span> <span class="nt">box</span> <span class="o">=</span> <span class="nt">new</span> <span class="nt">THREE</span><span class="p">.</span><span class="nc">Mesh</span><span class="o">(</span><span class="nt">geometry</span><span class="o">,</span> <span class="nt">material</span><span class="o">);</span>
<span class="nt">box</span><span class="p">.</span><span class="nc">position</span><span class="p">.</span><span class="nc">y</span> <span class="o">=</span> <span class="nt">0</span><span class="p">.</span><span class="nc">5</span><span class="o">;</span>
<span class="nt">scene</span><span class="p">.</span><span class="nc">add</span><span class="o">(</span><span class="nt">box</span><span class="o">);</span>

<span class="nt">var</span> <span class="nt">light</span> <span class="o">=</span> <span class="nt">new</span> <span class="nt">THREE</span><span class="p">.</span><span class="nc">DirectionalLight</span><span class="o">(</span><span class="nt">0xffffff</span><span class="o">);</span>
<span class="nt">light</span><span class="p">.</span><span class="nc">position</span><span class="p">.</span><span class="nc">set</span><span class="o">(</span><span class="nt">1</span><span class="o">,</span> <span class="nt">1</span><span class="o">,</span> <span class="nt">1</span><span class="o">);</span>
<span class="nt">scene</span><span class="p">.</span><span class="nc">add</span><span class="o">(</span><span class="nt">light</span><span class="o">);</span>

<span class="nt">var</span> <span class="nt">planeGeometry</span> <span class="o">=</span> <span class="nt">new</span> <span class="nt">THREE</span><span class="p">.</span><span class="nc">PlaneGeometry</span><span class="o">(</span> <span class="nt">10</span><span class="o">,</span> <span class="nt">10</span><span class="o">,</span> <span class="nt">10</span><span class="o">,</span> <span class="nt">10</span> <span class="o">);</span>
<span class="nt">var</span> <span class="nt">planeMaterial</span> <span class="o">=</span> <span class="nt">new</span> <span class="nt">THREE</span><span class="p">.</span><span class="nc">MeshBasicMaterial</span><span class="o">(</span> <span class="p">{</span> <span class="k">color</span><span class="p">:</span> <span class="mi">0</span><span class="n">x533E25</span><span class="p">,</span> <span class="n">wireframe</span><span class="o">:</span><span class="n">true</span><span class="p">}</span> <span class="o">);</span>
<span class="nt">var</span> <span class="nt">planeMesh</span> <span class="o">=</span> <span class="nt">new</span> <span class="nt">THREE</span><span class="p">.</span><span class="nc">Mesh</span><span class="o">(</span> <span class="nt">planeGeometry</span><span class="o">,</span> <span class="nt">planeMaterial</span> <span class="o">);</span>
<span class="nt">var</span> <span class="nt">toRad</span><span class="o">=</span><span class="nt">Math</span><span class="p">.</span><span class="nc">PI</span> <span class="o">/</span> <span class="nt">180</span><span class="o">;</span>
<span class="nt">planeMesh</span><span class="p">.</span><span class="nc">rotation</span><span class="p">.</span><span class="nc">x</span> <span class="o">=</span> <span class="nt">90</span> <span class="o">*</span> <span class="nt">toRad</span><span class="o">;</span>
<span class="nt">scene</span><span class="p">.</span><span class="nc">add</span><span class="o">(</span> <span class="nt">planeMesh</span> <span class="o">);</span>

<span class="nt">var</span> <span class="nt">axis</span> <span class="o">=</span> <span class="nt">new</span> <span class="nt">THREE</span><span class="p">.</span><span class="nc">AxisHelper</span><span class="o">(</span><span class="nt">1000</span><span class="o">);</span>
<span class="nt">axis</span><span class="p">.</span><span class="nc">position</span><span class="p">.</span><span class="nc">set</span><span class="o">(</span><span class="nt">0</span><span class="o">,</span><span class="nt">0</span><span class="o">,</span><span class="nt">0</span><span class="o">);</span>
<span class="nt">scene</span><span class="p">.</span><span class="nc">add</span><span class="o">(</span><span class="nt">axis</span><span class="o">);</span>

<span class="nt">scene</span><span class="p">.</span><span class="nc">update</span><span class="o">=</span><span class="nt">function</span><span class="o">()</span>
<span class="p">{</span>
    <span class="err">box.rotation.x</span> <span class="err">+=</span> <span class="err">1</span> <span class="err">*</span> <span class="err">toRad</span><span class="p">;</span>
    <span class="err">box.rotation.y</span> <span class="err">+=</span> <span class="err">1</span> <span class="err">*</span> <span class="err">toRad</span><span class="p">;</span>
    <span class="err">box.rotation.z</span> <span class="err">+=</span> <span class="err">1</span> <span class="err">*</span> <span class="err">toRad</span><span class="p">;</span>
<span class="p">}</span><span class="o">;</span>

<span class="nt">return</span> <span class="nt">scene</span><span class="o">;</span>
</pre>

<p>}</p>
<p>function onLoaded()
{
    var stage=document.getElementById("threejs");</p>
<pre class="code literal-block"><span></span><span class="nt">var</span> <span class="nt">width</span><span class="o">=</span><span class="nt">stage</span><span class="p">.</span><span class="nc">clientWidth</span><span class="o">;</span>
<span class="nt">var</span> <span class="nt">height</span><span class="o">=</span><span class="nt">stage</span><span class="p">.</span><span class="nc">clientHeight</span><span class="o">;</span>
<span class="nt">console</span><span class="p">.</span><span class="nc">log</span><span class="o">(</span><span class="nt">width</span><span class="o">,</span> <span class="nt">height</span><span class="o">);</span>

<span class="nt">var</span> <span class="nt">renderer</span> <span class="o">=</span> <span class="nt">new</span> <span class="nt">THREE</span><span class="p">.</span><span class="nc">WebGLRenderer</span><span class="o">();</span>
<span class="nt">renderer</span><span class="p">.</span><span class="nc">setSize</span><span class="o">(</span><span class="nt">width</span><span class="o">,</span> <span class="nt">height</span><span class="o">);</span>
<span class="nt">stage</span><span class="p">.</span><span class="nc">appendChild</span><span class="o">(</span><span class="nt">renderer</span><span class="p">.</span><span class="nc">domElement</span><span class="o">);</span>

<span class="nt">var</span> <span class="nt">scene</span> <span class="o">=</span> <span class="nt">createScene</span><span class="o">();</span>

<span class="nt">var</span> <span class="nt">camera</span> <span class="o">=</span> <span class="nt">new</span> <span class="nt">THREE</span><span class="p">.</span><span class="nc">PerspectiveCamera</span><span class="o">(</span><span class="nt">45</span><span class="o">,</span> <span class="nt">width</span> <span class="o">/</span> <span class="nt">height</span><span class="o">,</span> <span class="nt">1</span><span class="o">,</span> <span class="nt">1000</span><span class="o">);</span>
<span class="nt">camera</span><span class="p">.</span><span class="nc">position</span><span class="p">.</span><span class="nc">set</span><span class="o">(</span><span class="nt">2</span><span class="o">,</span> <span class="nt">3</span><span class="o">,</span> <span class="nt">5</span><span class="o">);</span>
<span class="nt">camera</span><span class="p">.</span><span class="nc">lookAt</span><span class="o">(</span><span class="p">{</span><span class="n">x</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span> <span class="n">y</span><span class="o">:</span><span class="mi">0</span><span class="p">,</span> <span class="n">z</span><span class="o">:</span><span class="mi">0</span> <span class="p">}</span><span class="o">);</span>

<span class="nt">var</span> <span class="nt">controls</span> <span class="o">=</span> <span class="nt">new</span> <span class="nt">THREE</span><span class="p">.</span><span class="nc">OrbitControls</span><span class="o">(</span><span class="nt">camera</span><span class="o">);</span>
<span class="nt">controls</span><span class="p">.</span><span class="nc">enabled</span> <span class="o">=</span> <span class="nt">false</span><span class="o">;</span>

<span class="nt">stage</span><span class="p">.</span><span class="nc">addEventListener</span><span class="o">(</span><span class="s1">'mouseover'</span><span class="o">,</span> <span class="nt">function</span><span class="o">()</span> <span class="p">{</span>
        <span class="err">controls.enabled</span> <span class="err">=</span> <span class="err">true</span><span class="p">;</span>
        <span class="err">document.body.style.cursor</span> <span class="err">=</span> <span class="err">"pointer"</span><span class="p">;</span>
        <span class="p">}</span><span class="o">);</span>

<span class="nt">stage</span><span class="p">.</span><span class="nc">addEventListener</span><span class="o">(</span><span class="s1">'mouseout'</span><span class="o">,</span> <span class="nt">function</span><span class="o">()</span> <span class="p">{</span>
        <span class="err">controls.enabled</span> <span class="err">=</span> <span class="err">false</span><span class="p">;</span>
        <span class="err">document.body.style.cursor</span> <span class="err">=</span> <span class="err">"default"</span><span class="p">;</span>
        <span class="p">}</span><span class="o">);</span>

<span class="nt">var</span> <span class="nt">render</span> <span class="o">=</span> <span class="nt">function</span> <span class="o">()</span> <span class="p">{</span>
    <span class="err">requestAnimationFrame(render)</span><span class="p">;</span>
    <span class="err">scene.update()</span><span class="p">;</span>
    <span class="err">controls.update()</span><span class="p">;</span>
    <span class="err">renderer.render(scene,</span> <span class="err">camera)</span><span class="p">;</span>
<span class="p">}</span><span class="o">;</span>
<span class="nt">render</span><span class="o">();</span>
</pre>

<p>}</p>
<p>window.addEventListener('DOMContentLoaded', onLoaded);</p>
</div>
                </div>
            </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/2017/06/hugo_frontmatter/" class="u-url">hugoのfrontmatter</a></h1>
                <div class="metadata">
                    <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                        ousttrue
                    </span></p>
            <p class="dateline">
            <a href="posts/2017/06/hugo_frontmatter/" rel="bookmark">
            <time class="published dt-published" datetime="2017-06-05T00:00:00+09:00" itemprop="datePublished" title="2017-06-05 00:00">2017-06-05 00:00</time></a>
            </p>
                </div>
            </header><div class="e-content entry-content">
                    <div>
<p>hugo newで新しく記事を作成した時のfrontmatterをカスタマイズするには。</p>
<p>とりあえず本家のドキュメントに目を通す。</p>
<p>https://gohugo.io/content/archetypes/</p>
<p>archetypes/default.md
にfrontmatterのみの記事を作ればよいらしい。
+++
tags = []
draft = true
+++</p>
<p>やってみた。
hugo newでfrontmatterがカスタマイズされることを確認できた。</p>
</div>
                </div>
            </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/2017/06/cpp11_rpc/" class="u-url">C++でMessagePack-RPCを実装する</a></h1>
                <div class="metadata">
                    <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                        ousttrue
                    </span></p>
            <p class="dateline">
            <a href="posts/2017/06/cpp11_rpc/" rel="bookmark">
            <time class="published dt-published" datetime="2017-06-03T00:00:00+09:00" itemprop="datePublished" title="2017-06-03 00:00">2017-06-03 00:00</time></a>
            </p>
                </div>
            </header><div class="e-content entry-content">
                    <div>
<p>最近のC++(-std=c++14)でMessagePack-RPCを再実装してみる。</p>
<h2>基本設計</h2>
<p>MessagePack-RPCの仕様をおさらいすると以下の通り。</p>
<p>request</p>
<pre class="code literal-block"><span></span><span class="k">[type, msgid, method, params]</span>
 <span class="na">(0)   (int)  (str)   (array)</span>
</pre>

<p>response</p>
<pre class="code literal-block"><span></span><span class="k">[type, msgid, error, result]</span>
 <span class="na">(1)   (int)  (any)  (any)</span>
</pre>

<p>msgpackのバイト列を受け取って、msgpackのバイト列を返す関数として一般化する。</p>
<pre class="code literal-block"><span></span><span class="k">typedef</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="kt">uint8_t</span><span class="o">&gt;</span> <span class="n">bytes</span><span class="p">;</span>
<span class="c1">// msgpackのバイト列を引数にとり、msgpackのバイト列を返す</span>
<span class="k">typedef</span> <span class="n">std</span><span class="o">::</span><span class="n">function</span><span class="o">&lt;</span><span class="n">bytes</span><span class="p">(</span><span class="k">const</span> <span class="o">&amp;</span><span class="n">bytes</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">procedurecall</span><span class="p">;</span>
</pre>

<p>任意の関数呼び出しからprocedurecallを作り出せるようにして、MessagePack-RPCシステムの部品として使えるようにする。
簡単な例
例として</p>
<pre class="code literal-block"><span></span><span class="k">static</span> <span class="kt">int</span> <span class="nf">add</span><span class="p">(</span><span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">){</span> <span class="k">return</span> <span class="n">a</span><span class="o">+</span><span class="n">b</span><span class="p">;</span> <span class="p">}</span>
</pre>

<p>をprocedurecallに変換してみる。</p>
<pre class="code literal-block"><span></span><span class="n">procedurecall</span> <span class="nf">make_procedurecall</span><span class="p">(</span><span class="kt">int</span><span class="p">(</span><span class="o">*</span><span class="n">f</span><span class="p">)(</span><span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">))</span>
<span class="p">{</span>
    <span class="c1">// request -&gt; response ではなくparams -&gt; result</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">f</span><span class="p">](</span><span class="k">const</span> <span class="n">bytes</span><span class="o">&amp;</span> <span class="n">src</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">bytes</span>
    <span class="p">{</span>
        <span class="c1">// unpack args</span>
        <span class="k">auto</span> <span class="n">parser</span> <span class="o">=</span> <span class="n">msgpackpp</span><span class="o">::</span><span class="n">parser</span><span class="p">(</span><span class="n">src</span><span class="p">);</span>
        <span class="n">std</span><span class="o">::</span><span class="n">tuple</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="o">&gt;</span> <span class="n">args</span><span class="p">;</span>
        <span class="n">parser</span> <span class="o">&gt;&gt;</span> <span class="n">args</span><span class="p">;</span>

        <span class="c1">// call</span>
        <span class="k">auto</span> <span class="n">r</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">get</span><span class="o">&lt;</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">(</span><span class="n">args</span><span class="p">),</span> <span class="n">std</span><span class="o">::</span><span class="n">get</span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span><span class="p">(</span><span class="n">args</span><span class="p">));</span>

        <span class="c1">// pack result</span>
        <span class="n">msgpackpp</span><span class="o">::</span><span class="n">packer</span> <span class="n">packer</span><span class="p">;</span>
        <span class="n">packer</span> <span class="o">&lt;&lt;</span> <span class="n">r</span><span class="p">;</span>
        <span class="k">return</span> <span class="n">packer</span><span class="p">.</span><span class="n">get_payload</span><span class="p">();</span>
    <span class="p">};</span>
<span class="p">}</span>
</pre>

<p><code>int add(int, int)</code> を <code>procedurecall</code> に変換するというのは、引数のアンパック、関数呼び出し、結果のパックという一連の定型コードの呼び出しになる。</p>
<p><code>procedurecall</code> の使い方は以下の通り。</p>
<pre class="code literal-block"><span></span><span class="c1">// register</span>
<span class="k">auto</span> <span class="n">proc</span> <span class="o">=</span> <span class="n">msgpackpp</span><span class="o">::</span><span class="n">rpc</span><span class="o">::</span><span class="n">make_procedurecall</span><span class="p">(</span><span class="o">&amp;</span><span class="n">add</span><span class="p">);</span>

<span class="c1">// call</span>
<span class="k">auto</span> <span class="n">packer</span> <span class="o">=</span> <span class="n">msgpackpp</span><span class="o">::</span><span class="n">packer</span><span class="p">();</span>
<span class="n">packer</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">make_tuple</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
<span class="k">auto</span> <span class="n">result</span> <span class="o">=</span> <span class="n">proc</span><span class="p">(</span><span class="n">packer</span><span class="p">.</span><span class="n">get_payload</span><span class="p">());</span>

<span class="c1">// result</span>
<span class="n">REQUIRE</span><span class="p">(</span><span class="mi">3</span> <span class="o">==</span> <span class="n">msgpackpp</span><span class="o">::</span><span class="n">parser</span><span class="p">(</span><span class="n">result</span><span class="p">).</span><span class="n">get_number</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">());</span>
</pre>

<p>とりあえず動いたが、関数を増やすたびにこれだけのコードを記述するのはやってられませぬ。
以下のような理想形を目指して作りこんでゆく。</p>
<pre class="code literal-block"><span></span><span class="n">REQUIRE</span><span class="p">(</span><span class="mi">3</span> <span class="o">==</span> <span class="n">msgpack_procedurecall</span><span class="p">([](</span><span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">){</span> <span class="k">return</span> <span class="n">a</span><span class="o">+</span><span class="n">b</span><span class="p">;</span> <span class="p">},</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">));</span>
</pre>

<p><code>lambda</code> が動けば他も動くようにできるので、<code>lambda</code> を第一に実装する。</p>
<h2>実装</h2>
<p>ステップ毎に説明しようと思っていたが分かりにくいので、コードにコメントを追加することにした。</p>
<pre class="code literal-block"><span></span><span class="n">make_procedurecall</span>
<span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">F</span><span class="p">,</span> <span class="k">typename</span> <span class="n">R</span><span class="p">,</span> <span class="k">typename</span> <span class="n">C</span><span class="p">,</span> <span class="k">typename</span> <span class="p">...</span><span class="n">AS</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="kt">size_t</span><span class="p">...</span> <span class="n">IS</span><span class="o">&gt;</span>
<span class="n">procedurecall</span> <span class="n">_make_procedurecall</span><span class="p">(</span><span class="k">const</span> <span class="n">F</span> <span class="o">&amp;</span><span class="n">f</span>
    <span class="p">,</span> <span class="n">R</span><span class="p">(</span><span class="n">C</span><span class="o">::*</span><span class="p">)(</span><span class="n">AS</span><span class="p">...)</span><span class="k">const</span> <span class="c1">// template引数R, C, ASを受け付けるためのダミー</span>
    <span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">index_sequence</span><span class="o">&lt;</span><span class="n">IS</span><span class="p">...</span><span class="o">&gt;</span> <span class="c1">// template引数ISを受け付けるためのダミー</span>
<span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// request -&gt; response ではなくparams -&gt; result</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">f</span><span class="p">](</span><span class="k">const</span> <span class="n">bytes</span><span class="o">&amp;</span> <span class="n">src</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">bytes</span>
    <span class="p">{</span>
        <span class="c1">// unpack args</span>
        <span class="k">auto</span> <span class="n">parser</span> <span class="o">=</span> <span class="n">msgpackpp</span><span class="o">::</span><span class="n">parser</span><span class="p">(</span><span class="n">src</span><span class="p">);</span>
        <span class="n">std</span><span class="o">::</span><span class="n">tuple</span><span class="o">&lt;</span><span class="n">AS</span><span class="p">...</span><span class="o">&gt;</span> <span class="n">args</span><span class="p">;</span>
        <span class="n">parser</span> <span class="o">&gt;&gt;</span> <span class="n">args</span><span class="p">;</span>

        <span class="c1">// call</span>
        <span class="k">auto</span> <span class="n">r</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">get</span><span class="o">&lt;</span><span class="n">IS</span><span class="o">&gt;</span><span class="p">(</span><span class="n">args</span><span class="p">)...);</span> <span class="c1">// 可変長テンプレート引数を展開できる。ISと...が離れていることに注意</span>

        <span class="c1">// pack result</span>
        <span class="n">msgpackpp</span><span class="o">::</span><span class="n">packer</span> <span class="n">packer</span><span class="p">;</span>
        <span class="n">packer</span> <span class="o">&lt;&lt;</span> <span class="n">r</span><span class="p">;</span>
        <span class="k">return</span> <span class="n">packer</span><span class="p">.</span><span class="n">get_payload</span><span class="p">();</span>
    <span class="p">};</span>
<span class="p">}</span>

<span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">F</span><span class="p">,</span> <span class="k">typename</span> <span class="n">R</span><span class="p">,</span> <span class="k">typename</span> <span class="n">C</span><span class="p">,</span> <span class="k">typename</span> <span class="p">...</span><span class="n">AS</span><span class="o">&gt;</span>
<span class="n">procedurecall</span> <span class="n">_make_procedurecall</span><span class="p">(</span><span class="n">F</span> <span class="n">f</span>
    <span class="p">,</span> <span class="n">R</span><span class="p">(</span><span class="n">C</span><span class="o">::*</span><span class="p">)(</span><span class="n">AS</span><span class="p">...)</span><span class="k">const</span> <span class="c1">// template引数R, C, ASを受け付けるためのダミー</span>
<span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">_make_procedurecall</span><span class="p">(</span><span class="n">f</span>
        <span class="p">,</span> <span class="o">&amp;</span><span class="k">decltype</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">::</span><span class="k">operator</span><span class="p">()</span> <span class="c1">// lambdaの返り値と引数の型を次のテンプレートに渡す</span>
        <span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">index_sequence_for</span><span class="o">&lt;</span><span class="n">AS</span><span class="p">...</span><span class="o">&gt;</span><span class="p">{}</span> <span class="c1">// std::get呼び出しのためにindex_sequenceを作る。</span>
    <span class="p">);</span>
<span class="p">}</span>

<span class="c1">//</span>
<span class="c1">// あらゆる型のlambdaを受け付けるようにした</span>
<span class="c1">//</span>
<span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">F</span><span class="o">&gt;</span>
<span class="n">procedurecall</span> <span class="n">make_procedurecall</span><span class="p">(</span><span class="n">F</span> <span class="n">f</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">_make_procedurecall</span><span class="p">(</span><span class="n">f</span>
        <span class="p">,</span> <span class="o">&amp;</span><span class="k">decltype</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">::</span><span class="k">operator</span><span class="p">()</span> <span class="c1">// lambdaの返り値と引数の型を次のテンプレートに渡す</span>
    <span class="p">);</span>
<span class="p">}</span>

<span class="n">msgpack_call</span>
<span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">F</span><span class="p">,</span> <span class="k">typename</span> <span class="n">R</span><span class="p">,</span> <span class="k">typename</span> <span class="n">C</span><span class="p">,</span> <span class="k">typename</span> <span class="p">...</span><span class="n">AS</span><span class="o">&gt;</span>
<span class="k">decltype</span><span class="p">(</span><span class="k">auto</span><span class="p">)</span> <span class="n">_msgpack_call</span><span class="p">(</span><span class="n">F</span> <span class="n">f</span>
    <span class="p">,</span> <span class="n">R</span><span class="p">(</span><span class="n">C</span><span class="o">::*</span><span class="p">)(</span><span class="n">AS</span><span class="p">...)</span><span class="k">const</span> <span class="c1">// template引数R, C, ASを受けるためのダミー</span>
    <span class="p">,</span> <span class="n">AS</span><span class="p">...</span> <span class="n">args</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">auto</span> <span class="n">proc</span> <span class="o">=</span> <span class="n">msgpackpp</span><span class="o">::</span><span class="n">rpc</span><span class="o">::</span><span class="n">make_procedurecall</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>

    <span class="c1">// call</span>
    <span class="n">msgpackpp</span><span class="o">::</span><span class="n">packer</span> <span class="n">packer</span><span class="p">;</span>
    <span class="n">packer</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">make_tuple</span><span class="p">(</span><span class="n">args</span><span class="p">...);</span> <span class="c1">// 可変長テンプレート引数を展開できる</span>
    <span class="k">auto</span> <span class="n">result</span> <span class="o">=</span> <span class="n">proc</span><span class="p">(</span><span class="n">packer</span><span class="p">.</span><span class="n">get_payload</span><span class="p">());</span>

    <span class="c1">// unpack result</span>
    <span class="n">R</span> <span class="n">value</span><span class="p">;</span>
    <span class="n">msgpackpp</span><span class="o">::</span><span class="n">parser</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">value</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">F</span><span class="p">,</span> <span class="k">typename</span> <span class="p">...</span><span class="n">AS</span><span class="o">&gt;</span>
<span class="k">decltype</span><span class="p">(</span><span class="k">auto</span><span class="p">)</span> <span class="n">msgpack_call</span><span class="p">(</span><span class="n">F</span> <span class="n">f</span><span class="p">,</span> <span class="n">AS</span><span class="p">...</span> <span class="n">args</span><span class="p">)</span> <span class="c1">// 返り値の型はreturnから型推論</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">_msgpack_call</span><span class="p">(</span><span class="n">f</span>
    <span class="p">,</span> <span class="o">&amp;</span><span class="k">decltype</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">::</span><span class="k">operator</span><span class="p">()</span> <span class="c1">// lambdaの返り値と引数の型をテンプレート引数に渡す</span>
    <span class="p">,</span> <span class="n">args</span><span class="p">...</span>
    <span class="p">);</span>
<span class="p">}</span>
</pre>

<h2>使う。</h2>
<pre class="code literal-block"><span></span><span class="n">REQUIRE</span><span class="p">(</span><span class="mi">3</span><span class="o">==</span><span class="n">msgpack_call</span><span class="p">([](</span><span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">;</span> <span class="p">},</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">));</span>
<span class="n">REQUIRE</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">==</span><span class="n">msgpack_call</span><span class="p">([](</span><span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">a</span> <span class="o">-</span> <span class="n">b</span><span class="p">;</span> <span class="p">},</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">));</span>
</pre>

<p><code>valiadic template</code> おそるべし。
従来であれば、1引数、２引数・・・と引数の個数ごとに手作業でバージョンを増やさねばならなかったものが、わりとさくっと書けるな。</p>
</div>
                </div>
            </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/2017/05/add_executable/" class="u-url">cmakeで実行ファイルを作成する例</a></h1>
                <div class="metadata">
                    <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                        ousttrue
                    </span></p>
            <p class="dateline">
            <a href="posts/2017/05/add_executable/" rel="bookmark">
            <time class="published dt-published" datetime="2017-05-28T00:00:00+09:00" itemprop="datePublished" title="2017-05-28 00:00">2017-05-28 00:00</time></a>
            </p>
                </div>
            </header><div class="e-content entry-content">
                    <div>
<p>main.cpp
CMakeLists.txt</p>
<p>main.cpp
int main()
{
   return 0;
}</p>
<p>CMakeLists.txt
cmake_minimum_required(VERSION 2.8)
project(hello) # .sln
add_executable(hello main.cpp) # .vcxproj</p>
<p>実行</p>
<blockquote>
<p>mkdir build
cd build
build&gt; cmake.exe .. -G "Visual Studio 15 2017"
build&gt; dir 
CMakeFiles
ALL_BUILD.vcxproj
ALL_BUILD.vcxproj.filters
CMakeCache.txt
cmake_install.cmake
hello.sln
hello.vcxproj
hello.vcxproj.filters
ZERO_CHECK.vcxproj
ZERO_CHECK.vcxproj.filters</p>
</blockquote>
</div>
                </div>
            </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/2017/05/cmake_compileoptions/" class="u-url">cmakeチートシート</a></h1>
                <div class="metadata">
                    <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                        ousttrue
                    </span></p>
            <p class="dateline">
            <a href="posts/2017/05/cmake_compileoptions/" rel="bookmark">
            <time class="published dt-published" datetime="2017-05-28T00:00:00+09:00" itemprop="datePublished" title="2017-05-28 00:00">2017-05-28 00:00</time></a>
            </p>
                </div>
            </header><div class="e-content entry-content">
                    <div>
<p>すぐ忘れるのでここをチートシート化しよう。</p>
<p>構成
solution
CMAKE_MINIMUM_REQUIRED(VERSION 2.8)
PROJECT(hello) # .sln</p>
<p>subdirectory</p>
<p>https://cmake.org/cmake/help/latest/command/add_subdirectory.html</p>
<p>ADD_SUBDIRECTORY(src)</p>
<h2>もしくは</h2>
<p>SUBDIRS(FOO BAR HOGE FUGA)</p>
<p>target
exe</p>
<p>https://cmake.org/cmake/help/latest/command/add_executable.html</p>
<p>ADD_EXECUTABLE(hello
    main.cpp
    renderer.cpp
    scene.cpp
    )</p>
<p>fileを集める例
FILE(GLOB SRC
    <em>.cpp
    </em>.h
    )
ADD_EXECUTABLE(hello
    ${SRC}
    )</p>
<h2>fo winmain</h2>
<p>ADD_EXECUTABLE(hello_windows WIN32
    ${SRC}
    )</p>
<p>static lib</p>
<p>https://cmake.org/cmake/help/latest/command/add_library.html</p>
<p>ADD_LIBRARY(renderer STATIC
    renderer.cpp
    )</p>
<p>dll
ADD_LIBRARY(renderer SHARED
    renderer.cpp
    )</p>
<p>compile
compiler options
全体
SET(CMAKE_CXX_FLAGS "-Wall")</p>
<p>ターゲット指定
TARGET_COMPILE_OPTIONS(foo PUBLIC "$&lt;$<debug>:${MY_DEBUG_OPTIONS}&gt;")
TARGET_COMPILE_OPTIONS(foo PUBLIC "$&lt;$<release>:${MY_RELEASE_OPTIONS}&gt;")</release></debug></p>
<p>include path
全体
以降のADD_XXXに対して有効になる
INCLUDE_DIRECTORIES(libpath/include)</p>
<p>ターゲット指定
PUBLICの部分はよくわからぬ。
TARGET_INCLUDE_DIRECTORIES(HELLO PUBLIC
    ${BOOST_DIR}
    )</p>
<p>define
全体
以降のADD_XXXに対して有効になる
ADD_DEFINITIONS(-DWITH_OPENCV2)</p>
<p>ターゲット指定
PUBLICの部分はよくわからぬ。</p>
<h2>-Dなし</h2>
<p>TARGET_COMPILE_DEFINITIONS(TARGET PUBLIC
    WITH_OPENCV2=1
    )</p>
<p>link
link path
LINK_DIRECTORIES(libpath/lib)</p>
<p>x86とx64で違うパスにしたい時は？
LINK_LIBRARIES
TARGET_LINK_LIBRARIES
TARGET_LINK_LIBRARIES(MediaSessionPlaybackExample
    Mf
    Mfplat
    Mfuuid
    strmiids
    )</p>
<p>Debug Releaseの切り分け
TARGET_LINK_LIBRARIES(Fuga
    DEBUG hoge_d
    OPTIMIZE hoge
    )</p>
<p>変数
ソース
cmake -G CMAKE_SOURCE_DIR
CMAKE_SOURCE_DIR</p>
<p>ビルドディレクトリ
cmake -G CMAKE_SOURCE_DIRを実行したディレクトリ
CMAKE_BINARY_DIR</p>
<p>The path to the top level of the build tree</p>
<p>出力ディレクトリ
exeとdllの出力先。
SET(CMAKE_RUNTIME_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/bin)</p>
<p>example
CMakeLists.txt
CMAKE_MINIMUM_REQUIRED(VERSION 2.8)
PROJECT(hello) # hello.sln
ADD_EXECUTABLE(hello main.cpp) # hello.vcxproj</p>
<p>set(CMAKE_CXX_FLAGS "/WD4096")
set(CMAKE_C_FLAGS "/WD4096")
include_directories(libpath/include)
add_definitions(
    -DUNICODE
    -D_UNICODE
    )</p>
</div>
                </div>
            </article>
</div>
    
        <ul class="pager postindexpager clearfix">
<li class="previous"><a href="index-23.html" rel="prev">新しい記事</a></li>
            <li class="next"><a href="index-21.html" rel="next">過去の記事</a></li>
        </ul>
<!--End of body content--><footer id="footer">
            Contents © 2021         <a href="mailto:ousttrue@gmail.com">ousttrue</a> - Powered by         <a href="https://getnikola.com" rel="nofollow">Nikola</a>         
            
            
        </footer>
</div>
</div>


        <script src="assets/js/all-nocdn.js"></script><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element){var i=element.getElementsByTagName('img')[0];return i===undefined?'':i.alt;}});
    </script>
</body>
</html>
