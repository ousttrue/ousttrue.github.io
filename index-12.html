<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article# " lang="ja">
<head>
<meta charset="utf-8">
<meta name="description" content="作業記録">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>三次元日誌 (過去の記事 12ページ目) | 三次元日誌</title>
<link href="assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<link href="https://fonts.googleapis.com/css?family=Playfair+Display:700,900" rel="stylesheet">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" hreflang="ja" href="rss.xml">
<link rel="canonical" href="https://ousttrue.github.io/index-12.html">
<link rel="prev" href="index-13.html" type="text/html">
<link rel="next" href="index-11.html" type="text/html">
<!--[if lt IE 9]><script src="assets/js/html5.js"></script><![endif]-->
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">本文を読み飛ばす</a>

<!-- Header and menu bar -->
<div class="container">
      <header class="blog-header py-3"><div class="row nbb-header align-items-center">
          <div class="col-md-3 col-xs-2 col-sm-2" style="width: auto;">
            <button class="navbar-toggler navbar-light bg-light nbb-navbar-toggler" type="button" data-toggle="collapse" data-target=".bs-nav-collapsible" aria-controls="bs-navbar" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse bs-nav-collapsible bootblog4-search-form-holder">
                
            </div>
        </div>
          <div class="col-md-6 col-xs-10 col-sm-10 bootblog4-brand" style="width: auto;">
            <a class="navbar-brand blog-header-logo text-dark" href=".">

            <span id="blog-title">三次元日誌</span>
        </a>
          </div>
            <div class="col-md-3 justify-content-end align-items-center bs-nav-collapsible collapse flex-collapse bootblog4-right-nav">
            <nav class="navbar navbar-light bg-white"><ul class="navbar-nav bootblog4-right-nav"></ul></nav>
</div>
    </div>
</header><nav class="navbar navbar-expand-md navbar-light bg-white static-top"><div class="collapse navbar-collapse bs-nav-collapsible" id="bs-navbar">
            <ul class="navbar-nav nav-fill d-flex w-100">
<li class="nav-item">
<a href="archive.html" class="nav-link">Archives</a>
                </li>
<li class="nav-item">
<a href="categories/index.html" class="nav-link">Tags</a>
                </li>
<li class="nav-item">
<a href="rss.xml" class="nav-link">RSS feed</a>

                
            </li>
</ul>
</div>
<!-- /.navbar-collapse -->
</nav>
</div>

<div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        
        
        
    
        

    
        
    <div class="postindex">
            <article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/2017/08/pyalembic/" class="u-url">WindowsでPyAlembicできるのか</a></h1>
                <div class="metadata">
                    <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                        ousttrue
                    </span></p>
            <p class="dateline">
            <a href="posts/2017/08/pyalembic/" rel="bookmark">
            <time class="published dt-published" datetime="2017-08-07T00:00:00Z" itemprop="datePublished" title="2017-08-07 00:00">2017-08-07 00:00</time></a>
            </p>
                        <p class="commentline">
        
    <a href="posts/2017/08/pyalembic/#disqus_thread" data-disqus-identifier="cache/content/posts/2017/08/pyalembic.html">コメント</a>


                </p>
</div>
            </header><div class="e-content entry-content">
                    <div>
<p>Windows上でPyAlembicを使いたいのだができるのか。
素直にLinuxでやるべきでは・・・
Windows10(64bit) + Python-3.6(64bit)</p>
<p>作業場。</p>
<p>https://github.com/ousttrue/openexr</p>
<p>Anaconda3(Windows10 64bit)でモジュール探す</p>
<blockquote>
<p>conda install -c conda-forge alembic</p>
</blockquote>
<p>しかし、これは違うAlembicだった。
Pythonのalembicは、database migrations toolと名前が被っております。
なるほど・・・。
Python2.7なら</p>
<p>http://www.lfd.uci.edu/~gohlke/pythonlibs/#pyalembic</p>
<p>あとから発見。わいは、Python3.6にしたいので。
自前でビルドを試みる
alembic-1.7.1/python/PyAlembicがそれですな。
問題が２つある。</p>
<p>Python2(Python3にしたい)
Boost.Python(PyBind11にしてリンク問題とおさらばしたい)</p>
<p>さすがにPyBind11差し替えはやるにしても後にするべきなので、 Python3化だけやる。
Boost.Pythonのビルド
Boost.Pythonで使うPythonを明示するには、user-config.jamに記述する。
BOOST_DIR/user-conifg.jam
using python 
    : 3.6                   # Version
    : D:\Anaconda3\python.exe      # Python Path
    : D:\Anaconda3\include         # include path
    : D:\Anaconda3\libs            # lib path(s)
    : <define>BOOST_ALL_NO_LIB=1
    ;</define></p>
<p>ビルド
boost&gt; b2.exe -j3 --stagedir=stage\x86_64 link=shared runtime-link=shared threading=multi toolset=msvc-14.0 address-model=64 --with-python</p>
<p>link=sharedにしてdllを生成することが必要。
これは、iex.pydとimath.pyd間でBoost.Pythonのstatic変数を共有するために必須である(pyexの型登録周りか)。
IlmBaseを修正
ilmbase-2.2.0/IexMath/IexMathFloatExc.h
の以下の部分を修正する。多分、記述ミスなのだけど誰もWindowsビルドしないので気付かれていないのであろう。
//#if defined(IEX_EXPORTS)↲</p>
<h2>if defined(IEXMATH_EXPORTS)↲</h2>
<p>これでilmbaseをビルドしておく。vcpkgを使った。
alembicを修正
alembic-1.7.1/lib/Alembic/AbcCoreLayer/CMakeLists.txtを修正してヘッダを追加する(PyAlembicが使う)
INSTALL(FILES Read.h Util.h
    Foundation.h # 追加
    DESTINATION include/Alembic/AbcCoreLayer)</p>
<p>これも、vcpkgを使った。
PyIlmBaseのビルド
OpenEXRのサイトにあるpyilmbase-2.2.0tar.gzを使おうとしたのだけど、githubの方が新しいようなのでこちらを使う。
Python3向けの修正
Python2とPytnon3間での非互換によるコンパイルエラーを直していく。</p>
<p>PySliceObject_XXX -&gt; PyObject_XXX
PyInt_XXX -&gt; PyLong_XXX
PyString_AsString -&gt; PyUnicode_AsUTF8
_PyThreadState_Current -&gt; _PyThreadState_UncheckedGet()</p>
<p>参考</p>
<p>Python3 Advent Calendar - Pythonで2/3両方で動くコードを書く(C/API)
Fix build for Python 3.5
http://py3c.readthedocs.io/en/latest/guide.html</p>
<p>CMake設定</p>
<p>CMAKE_INSTALL_PREFIX
BOOST_ROOT
ILMBASE_PACKAGE_PREFIX
FIND_PACKAGE(numpy)をコメントアウト
DebugでもPython36.libにリンクするように、#include <python.h>を除去(boost/python.hpp経由でインクルードさせればそうなる)</python.h></p>
<p>ビルドが通るようになった。
PyAlembicのビルド
当初、AlembicのプロジェクトでPythonフラグを有効にして一緒にビルドしようとしていたが、PyIlmBase傘下にPyAlembicをコピーする方式に変えた。
alembic-1.7.1/python/PyAlembicをilmbase-2.2.0/PyIlmBaseにコピーして、CMakeLists.txtを調整する。
CMake設定</p>
<p>Alembic_ROOT</p>
<p>参考</p>
<p>uimac実装メモ - PyImath</p>
<p>PyAlembicのビルドが通ったので実行してみよう
PyAlembic/Tests/testPolyMesh.pyを動かしてみようと思う。
こういう感じに準備する。
testPolyMesh.py
iex.pyd
PyIex.dll
imath.pyd
PyImath.dll
alembic.lib
alembic.pyd
boost_python-vc140-mt-1_61.dll # debug buildもこれ</p>
<blockquote>
<p>C:/python36/python.exe testPolyMesh.py</p>
</blockquote>
<p>import alembicでクラッシュする。デバッガで追ってみると、モジュールの初期化でエラーが発生している。一個ずつ直す。
初期化の修正
Python3化による変更？
AbcView
今回の作業目標。</p>
<p>http://alembic.github.io/abcview/</p>
<p>これを動作させたい。
AbcView has the following requirements:</p>
<p>Python 2.6+ =&gt; Python 3.6 で動くように改造する(print文とか)
PyAlembic。できた
PyAbcOpenGL。できた
PyOpenGL。pip
argparse。pip
PyQt4。http://www.lfd.uci.edu/~gohlke/pythonlibs/#pyalembic
numpy-mkl。http://www.lfd.uci.edu/~gohlke/pythonlibs/#pyalembic</p>
<p>PyQt4をインストール</p>
<p>https://stackoverflow.com/questions/22640640/how-to-install-pyqt4-on-windows-using-pip
http://www.lfd.uci.edu/~gohlke/pythonlibs/#pyqt4</p>
<p>こんな感じで公式のPython3.6(64bit)に対してインストール。
D:\Python36\Scripts\pip.exe install .\PyQt4-4.11.4-cp36-cp36m-win_amd64.whl</p>
<p>https://www.tutorialspoint.com/pyqt/pyqt_hello_world.htm</p>
<p>import sys
from PyQt4 import QtGui</p>
<p>def window():
    app = QtGui.QApplication(sys.argv)
    w = QtGui.QWidget()
    b = QtGui.QLabel(w)
    b.setText("Hello World!")
    w.setGeometry(100,100,200,50)
    b.move(50,20)
    w.setWindowTitle("PyQt")
    w.show()
    sys.exit(app.exec_())</p>
<p>if <strong>name</strong> == '<strong>main</strong>':
    window()</p>
<p>動いた。
alembicgl.pyd, alembic.pyd, imath.pyd, iex.pydと依存dll群をwheel化する
同じdllを参照するpydを同じフォルダに配置したいので、
共通の親モジュールとしてilmを定義してその中にすべてのpydとdllを収めることにした。
そのうえでこれを間接的にエクスポートするモジュール’iex’, ‘imath’, ‘alembic’, ‘alembicgl’
を作る計画。
ilm
    + <strong>init</strong>.py
    + iex.pyd
    + imath.pyd
    + alembic.pyd
    + alembicgl.pyd
    + PyEx.dll
    + PyImath.dll
    + boost_python.dll
    + Alembic.dll # VCPKG BUILD
    + ilmbase.dll # VCPKG BUILD
    + iex.dll # VCPKG BUILD
    + imath.dll # VCPKG BUILD
    + half.dll # VCPKG BUILD
    + hdf5.dll # VCPKG BUILD
    + zip.dll # VCPKG BUILD
    + szip.dll # VCPKG BUILD
iex
    + <strong>init</strong>.py # ilm.iexを公開
imath
    + <strong>init</strong>.py # ilm.imathを公開
alembic
    + <strong>init</strong>.py # ilm.alembicを公開
alembicgl
    + <strong>init</strong>.py # ilm.alembicglを公開
setup.py</p>
<p>iex/init.py
from ilm.iex import *</p>
<p>こういうのをiex, imath, alembic, alembicglそれぞれに作った。
setup.py</p>
<h2>!/usr/bin/env python</h2>
<p>from setuptools import setup, Distribution</p>
<p>setup(
        name='alembic',
        version='0.1',
        description='Alembic Library',
        packages=['ilm', 'iex', 'imath', 'alembic', 'alembicgl'],
        package_data={
            'ilm':['<em>.pyd', '</em>.dll'],
            },
        )</p>
<p>py_package&gt; D:\Python36\python.exe setup.py bidst_wheel
py_package&gt; D:\Python36\Scripts\pip.exe install .\dist\alembic-0.1-cp36-cp36m-win_amd64.whl</p>
<p>AbcViewを実行してみる
こういう感じに配置して、abcview_main.pyを実行してみる。
abcview_main.py # bin/abcviewから改名(名前がフォルダと被らないように変更)
abcview
    <strong>init</strong>.py</p>
<p>python2仕様の部分をまとめて修正。</p>
<p>https://docs.python.jp/3/library/2to3.html</p>
<p>AbcView&gt; D:\Python36\python.exe D:\Python36\Tools\scripts\2to3.py -w .</p>
<p>print文、except文などの定型的な文法問題はこれで一網打尽。ディレクトリを指定することでまとめて処理できる。
file.toAscii() =&gt; file
これもPython2との非互換か。
QtCore.QString(str(value)) =&gt; str(value)
QStringは、PythonのStringでよさげ。
動いた</p>
<p>https://github.com/ousttrue/openexr/releases/tag/v0.1</p>
<p>タイムラインを操作したら蛸が動いた。</p>
</div>
                </div>
            </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/2017/08/distutils_msvccompiler/" class="u-url">distutilsでcl.exeが見つからない</a></h1>
                <div class="metadata">
                    <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                        ousttrue
                    </span></p>
            <p class="dateline">
            <a href="posts/2017/08/distutils_msvccompiler/" rel="bookmark">
            <time class="published dt-published" datetime="2017-08-06T00:00:00Z" itemprop="datePublished" title="2017-08-06 00:00">2017-08-06 00:00</time></a>
            </p>
                        <p class="commentline">
        
    <a href="posts/2017/08/distutils_msvccompiler/#disqus_thread" data-disqus-identifier="cache/content/posts/2017/08/distutils_msvccompiler.html">コメント</a>


                </p>
</div>
            </header><div class="e-content entry-content">
                    <div>
<p>PythonじゃなくてVisualStudio側の問題のようなのだけど、setup.pyでネイティブモジュールをビルドするときに顕在化したので。</p>
<p>こういう感じのネイティブモジュールを作った。
from distutils.core import setup, Extension</p>
<p>imgui_module = Extension('_swig_imgui',
        sources=[
            #'imgui_wrap.cxx',
            'imgui.i',
            'imgui/imgui.cpp',
            'imgui/imgui_draw.cpp',
            'imgui/imgui_demo.cpp',
            ],
        swig_opts=[
            #'-modern',
            '-c++',
            '-py3',
            ]
        )</p>
<p>setup (name = 'swig_imgui',
        version = '0.1',
        author      = "ousttrue",
        description = """imgui wrapper using swig""",
        ext_modules = [imgui_module],
        py_modules = ["swig_imgui"],
        )</p>
<blockquote>
<p>python setup.py build</p>
</blockquote>
<p>とするとエラーになる。
Windows10(64bit)上のvs2017 + vcbuildtoolsの組み合わせの環境である。
cl.exe /c /nologo /Ox /W3 /GL /DNDEBUG /MD -ID:\Anaconda3\include -ID:\Anaconda3\include /EHsc /Tpimgui_wrap.cpp /Fobuild\temp.win-amd64-3.6\Release\imgui_wrap.obj
error: command 'cl.exe' failed: No such file or directory</p>
<p>distutilsがcl.exeを探すのに失敗しているようなのである。
lib/distutils下を調べてみた。
どうやらlib/distutils/_msvccompiler.pyでvcvarsall.batから環境変数を得ることに失敗しているらしい。
実際、C:\Program Files (x86)\Microsoft Visual Studio\Shared\14.0\VC\vcvarsall.batの呼び出しが失敗していることを突き止めた。
Error in script usage. The correct usage is:
    "C:\Program Files (x86)\Microsoft Visual Studio\Shared\14.0\VC\vcvarsall.bat" [option]
  or
    "C:\Program Files (x86)\Microsoft Visual Studio\Shared\14.0\VC\vcvarsall.bat" [option] store
  or
    "C:\Program Files (x86)\Microsoft Visual Studio\Shared\14.0\VC\vcvarsall.bat" [option] [version number]
  or
    "C:\Program Files (x86)\Microsoft Visual Studio\Shared\14.0\VC\vcvarsall.bat" [option] store [version number]
where [option] is: x86 | amd64 | arm | x86_amd64 | x86_arm | amd64_x86 | amd64_arm
where [version number] is either the full Windows 10 SDK version number or "8.1" to use the windows 8.1 SDK
:
The store parameter sets environment variables to support
  store (rather than desktop) development.
:
For example:
    "C:\Program Files (x86)\Microsoft Visual Studio\Shared\14.0\VC\vcvarsall.bat" x86_amd64
    "C:\Program Files (x86)\Microsoft Visual Studio\Shared\14.0\VC\vcvarsall.bat" x86_arm store
    "C:\Program Files (x86)\Microsoft Visual Studio\Shared\14.0\VC\vcvarsall.bat" x86_amd64 10.0.10240.0
    "C:\Program Files (x86)\Microsoft Visual Studio\Shared\14.0\VC\vcvarsall.bat" x86_arm store 10.0.10240.0
    "C:\Program Files (x86)\Microsoft Visual Studio\Shared\14.0\VC\vcvarsall.bat" x64 8.1
    "C:\Program Files (x86)\Microsoft Visual Studio\Shared\14.0\VC\vcvarsall.bat" x64 store 8.1</p>
<p>コマンドラインから実行しても失敗していて、vcvarsall.batに以下のコードがあるのだが、
:setup_buildsku
if not exist "%~dp0......\Microsoft Visual C++ Build Tools\vcbuildtools.bat" goto usage
set CurrentDir=%CD%
call "%~dp0......\Microsoft Visual C++ Build Tools\vcbuildtools.bat" %1 %2
cd /d %CurrentDir%
goto :eof</p>
<p>C:\Program Files (x86)\Microsoft Visual Studio\Shared\14.0\VC\vcvarsall.bat
から
C:\Program Files (x86)\Microsoft Visual C++ Build Tools\vcbuildtools.bat"
への相対パスだと一致しないよなーと。
これが原因でcl.exeのパスが取れない。
setup.pyにモンキーパッチを当ててcl.exeを発見できるようにしてみた。
以下をsetup.pyの先頭に追加。</p>
<h2>monkey patch for _msvccompiler</h2>
<p>import distutils._msvccompiler
import os
import subprocess
def _get_vc_env(plat_spec):
    if os.getenv("DISTUTILS_USE_SDK"):
        return {
            key.lower(): value
            for key, value in os.environ.items()
        }</p>
<pre class="code literal-block"><span></span>vcvarsall, vcruntime = distutils._msvccompiler._find_vcvarsall(plat_spec)
if not vcvarsall:
    raise DistutilsPlatformError("Unable to find vcvarsall.bat")

try:
    out = subprocess.check_output(
        'cmd /u /c "{}" {} &amp;&amp; set'.format(vcvarsall, plat_spec),
        stderr=subprocess.STDOUT,
    ).decode('utf-16le', errors='replace')
    #######################################################################
    if out.startswith("Error in script usage"):
        out = subprocess.check_output(
            'cmd /u /c "{}" {} &amp;&amp; set'.format("C:\\Program Files (x86)\\Microsoft Visual C++ Build Tools\\vcbuildtools.bat", plat_spec),
            stderr=subprocess.STDOUT,
        ).decode('utf-16le', errors='replace')
    #######################################################################
except subprocess.CalledProcessError as exc:
    log.error(exc.output)
    raise DistutilsPlatformError("Error executing {}"
            .format(exc.cmd))

env = {
    key.lower(): value
    for key, _, value in
    (line.partition('=') for line in out.splitlines())
    if key and value
}

if vcruntime:
    env['py_vcruntime_redist'] = vcruntime
return env
</pre>

<p>distutils._msvccompiler._get_vc_env=_get_vc_env</p>
<p>以前にもこんなことやったことあるような気がする・・・。</p>
</div>
                </div>
            </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/2017/07/imgui_python/" class="u-url">PythonでImGuiする</a></h1>
                <div class="metadata">
                    <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                        ousttrue
                    </span></p>
            <p class="dateline">
            <a href="posts/2017/07/imgui_python/" rel="bookmark">
            <time class="published dt-published" datetime="2017-07-31T00:00:00Z" itemprop="datePublished" title="2017-07-31 00:00">2017-07-31 00:00</time></a>
            </p>
                        <p class="commentline">
        
    <a href="posts/2017/07/imgui_python/#disqus_thread" data-disqus-identifier="cache/content/posts/2017/07/imgui_python.html">コメント</a>


                </p>
</div>
            </header><div class="e-content entry-content">
                    <div>
<p>PythonでImGuiするのがよさげな気がしたのでやってみた。</p>
<p>ImGuiはcではなくc++のライブラリなのでPythonのctypesは使えぬ。
本家のBindingsの項に２つのpython bindingが紹介されている。</p>
<p>https://github.com/chromy/cyimgui
https://github.com/swistakm/pyimgui</p>
<p>なんかうまくいかなった。
ならばswigで自前でラップすればええやんということで、やってみる。</p>
<p>https://github.com/ousttrue/SwigImGui</p>
<p>Swig
%module swig_imgui</p>
<p>%{
/<em> Includes the header in the wrapper code </em>/</p>
<h2>include "imgui/imgui.h"</h2>
<p>%}</p>
<p>/<em> Parse the header file to generate wrappers </em>/
%include "imgui/imgui.h"</p>
<blockquote>
<p>swig -python -c++ imgui.i</p>
</blockquote>
<p>imgui_wrap.cxxと”swig_imgui.py”を生成した。
imgui_wrap.cxxから_swig_imgui.pydをビルドする。
ビルドしてみる
pythonのNativeModuleをビルドするのでsetup.pyを書いてみる。
from distutils.core import setup, Extension</p>
<p>imgui_module = Extension('_swig_imgui',
        sources=[
            'imgui_wrap.cxx',
            'imgui/imgui.cpp',
            'imgui/imgui_draw.cpp',
            'imgui/imgui_demo.cpp',
            ],
        )</p>
<p>setup (name = 'swig_imgeui',
        version = '0.1',
        author      = "ousttrue",
        description = """imgui wrapper using swig""",
        ext_modules = [imgui_module],
        py_modules = ["imgui"],
        )</p>
<p>ビルド。</p>
<blockquote>
<p>C:\python36\python.exe setup.py build</p>
</blockquote>
<p>ビルドしてみるとエラー。
swigimgui\imgui_wrap.cxx(26285): error C2668: 'ImGui::TreePush': オーバーロード関数の呼び出しを解決することができません。(新機能 ; ヘルプを参照)
swigimgui\imgui\imgui.h(338): note: 'void ImGui::TreePush(const void <em>)' の可能性があります
swigimgui\imgui\imgui.h(337): note: または 'void ImGui::TreePush(const char </em>)'
swigimgui\imgui_wrap.cxx(26285): note: 引数リスト '()' を一致させようとしているとき</p>
<p>ImGui::TreePush();がTreePush(const char<em> str_id = NULL)とTreePush(const void</em> ptr_id = NULL)でどちらなのか解決できない。
修正。
%module swig_imgui</p>
<p>%{
/<em> Includes the header in the wrapper code </em>/</p>
<h2>include "imgui/imgui.h"</h2>
<p>%}</p>
<p>%ignore ImGui::TreePush();</p>
<p>/<em> Parse the header file to generate wrappers </em>/
%include "imgui/imgui.h"</p>
<p>%include "imgui/imgui.h"の前に%ignoreを記述することで、
引数無しのTreePushを作らないようにした。
これでコンパイルは通った。
python36_d.libにリンクしない
python36_d.libではなあくpython36.libにリンクする。
imgui.iの上の方に以下の記述を追加する。
%begin %{</p>
<h2>ifdef _MSC_VER</h2>
<h2>define SWIG_PYTHON_INTERPRETER_NO_DEBUG</h2>
<h2>endif</h2>
<p>%}</p>
<p>実行してみよう</p>
<p>https://github.com/ocornut/imgui/tree/master/examples/sdl_opengl3_example</p>
<p>をまるっとpythonに移植してみる。
ここからが長くなるで。</p>
<h2>ImGui - standalone example application for SDL2 + OpenGL</h2>
<h2>If you are new to ImGui, see examples/README.txt and documentation at the top of imgui.cpp.</h2>
<p>import os
import sys</p>
<p>if not 'PYSDL2_DLL_PATH' in os.environ:
    os.environ['PYSDL2_DLL_PATH']=os.environ['VCPKG_DIR'] + '/installed/x64-windows/bin'
from sdl2 import *</p>
<p>python_dir=os.path.dirname(sys.executable)
os.environ['PATH']+=(';'+python_dir)
import swig_imgui as imgui</p>
<p>import ImplSdlGL3</p>
<p>def main():</p>
<pre class="code literal-block"><span></span><span class="err">#</span> <span class="nt">Setup</span> <span class="nt">SDL</span>
<span class="nt">if</span> <span class="o">(</span><span class="nt">SDL_Init</span><span class="o">(</span><span class="nt">SDL_INIT_VIDEO</span><span class="o">|</span><span class="nt">SDL_INIT_TIMER</span><span class="o">)</span> <span class="o">!=</span> <span class="nt">0</span><span class="o">):</span>
    <span class="nt">print</span><span class="o">(</span><span class="s2">"Error: %s\n"</span><span class="o">,</span> <span class="nt">SDL_GetError</span><span class="o">());</span>
    <span class="nt">return</span> <span class="nt">-1</span><span class="o">;</span>

<span class="err">#</span> <span class="nt">Setup</span> <span class="nt">window</span>
<span class="nt">SDL_GL_SetAttribute</span><span class="o">(</span><span class="nt">SDL_GL_CONTEXT_FLAGS</span><span class="o">,</span> <span class="nt">SDL_GL_CONTEXT_FORWARD_COMPATIBLE_FLAG</span><span class="o">);</span>
<span class="nt">SDL_GL_SetAttribute</span><span class="o">(</span><span class="nt">SDL_GL_CONTEXT_PROFILE_MASK</span><span class="o">,</span> <span class="nt">SDL_GL_CONTEXT_PROFILE_CORE</span><span class="o">);</span>
<span class="nt">SDL_GL_SetAttribute</span><span class="o">(</span><span class="nt">SDL_GL_DOUBLEBUFFER</span><span class="o">,</span> <span class="nt">1</span><span class="o">);</span>
<span class="nt">SDL_GL_SetAttribute</span><span class="o">(</span><span class="nt">SDL_GL_DEPTH_SIZE</span><span class="o">,</span> <span class="nt">24</span><span class="o">);</span>
<span class="nt">SDL_GL_SetAttribute</span><span class="o">(</span><span class="nt">SDL_GL_STENCIL_SIZE</span><span class="o">,</span> <span class="nt">8</span><span class="o">);</span>
<span class="nt">SDL_GL_SetAttribute</span><span class="o">(</span><span class="nt">SDL_GL_CONTEXT_MAJOR_VERSION</span><span class="o">,</span> <span class="nt">3</span><span class="o">);</span>
<span class="nt">SDL_GL_SetAttribute</span><span class="o">(</span><span class="nt">SDL_GL_CONTEXT_MINOR_VERSION</span><span class="o">,</span> <span class="nt">2</span><span class="o">);</span>
<span class="nt">current</span><span class="o">=</span><span class="nt">SDL_DisplayMode</span><span class="o">();</span>
<span class="nt">SDL_GetCurrentDisplayMode</span><span class="o">(</span><span class="nt">0</span><span class="o">,</span> <span class="nt">current</span><span class="o">);</span>
<span class="nt">window</span> <span class="o">=</span> <span class="nt">SDL_CreateWindow</span><span class="o">(</span><span class="nt">b</span><span class="s2">"ImGui SDL2+OpenGL3 example"</span><span class="o">,</span> <span class="nt">SDL_WINDOWPOS_CENTERED</span><span class="o">,</span> <span class="nt">SDL_WINDOWPOS_CENTERED</span><span class="o">,</span> <span class="nt">1280</span><span class="o">,</span> <span class="nt">720</span><span class="o">,</span> <span class="nt">SDL_WINDOW_OPENGL</span><span class="o">|</span><span class="nt">SDL_WINDOW_RESIZABLE</span><span class="o">);</span>
<span class="nt">glcontext</span> <span class="o">=</span> <span class="nt">SDL_GL_CreateContext</span><span class="o">(</span><span class="nt">window</span><span class="o">);</span>
<span class="p">#</span><span class="nn">gl3wInit</span><span class="o">();</span>

<span class="err">#</span> <span class="nt">Setup</span> <span class="nt">ImGui</span> <span class="nt">binding</span>
<span class="nt">ImplSdlGL3</span><span class="p">.</span><span class="nc">Init</span><span class="o">(</span><span class="nt">window</span><span class="o">);</span>

<span class="err">#</span> <span class="nt">Load</span> <span class="nt">Fonts</span>
<span class="err">#</span> <span class="o">(</span><span class="nt">there</span> <span class="nt">is</span> <span class="nt">a</span> <span class="nt">default</span> <span class="nt">font</span><span class="o">,</span> <span class="nt">this</span> <span class="nt">is</span> <span class="nt">only</span> <span class="nt">if</span> <span class="nt">you</span> <span class="nt">want</span> <span class="nt">to</span> <span class="nt">change</span> <span class="nt">it</span><span class="o">.</span> <span class="nt">see</span> <span class="nt">extra_fonts</span><span class="o">/</span><span class="nt">README</span><span class="p">.</span><span class="nc">txt</span> <span class="nt">for</span> <span class="nt">more</span> <span class="nt">details</span><span class="o">)</span>
<span class="p">#</span><span class="nn">ImGuiIO</span><span class="o">&amp;</span> <span class="nt">io</span> <span class="o">=</span> <span class="nt">imgui</span><span class="p">.</span><span class="nc">GetIO</span><span class="o">();</span>
<span class="p">#</span><span class="nn">io</span><span class="p">.</span><span class="nc">Fonts-</span><span class="o">&gt;</span><span class="nt">AddFontDefault</span><span class="o">();</span>
<span class="p">#</span><span class="nn">io</span><span class="p">.</span><span class="nc">Fonts-</span><span class="o">&gt;</span><span class="nt">AddFontFromFileTTF</span><span class="o">(</span><span class="s2">"../../extra_fonts/Cousine-Regular.ttf"</span><span class="o">,</span> <span class="nt">15</span><span class="p">.</span><span class="nc">0f</span><span class="o">);</span>
<span class="p">#</span><span class="nn">io</span><span class="p">.</span><span class="nc">Fonts-</span><span class="o">&gt;</span><span class="nt">AddFontFromFileTTF</span><span class="o">(</span><span class="s2">"../../extra_fonts/DroidSans.ttf"</span><span class="o">,</span> <span class="nt">16</span><span class="p">.</span><span class="nc">0f</span><span class="o">);</span>
<span class="p">#</span><span class="nn">io</span><span class="p">.</span><span class="nc">Fonts-</span><span class="o">&gt;</span><span class="nt">AddFontFromFileTTF</span><span class="o">(</span><span class="s2">"../../extra_fonts/ProggyClean.ttf"</span><span class="o">,</span> <span class="nt">13</span><span class="p">.</span><span class="nc">0f</span><span class="o">);</span>
<span class="p">#</span><span class="nn">io</span><span class="p">.</span><span class="nc">Fonts-</span><span class="o">&gt;</span><span class="nt">AddFontFromFileTTF</span><span class="o">(</span><span class="s2">"../../extra_fonts/ProggyTiny.ttf"</span><span class="o">,</span> <span class="nt">10</span><span class="p">.</span><span class="nc">0f</span><span class="o">);</span>
<span class="p">#</span><span class="nn">io</span><span class="p">.</span><span class="nc">Fonts-</span><span class="o">&gt;</span><span class="nt">AddFontFromFileTTF</span><span class="o">(</span><span class="s2">"c:\\Windows\\Fonts\\ArialUni.ttf"</span><span class="o">,</span> <span class="nt">18</span><span class="p">.</span><span class="nc">0f</span><span class="o">,</span> <span class="nt">NULL</span><span class="o">,</span> <span class="nt">io</span><span class="p">.</span><span class="nc">Fonts-</span><span class="o">&gt;</span><span class="nt">GetGlyphRangesJapanese</span><span class="o">());</span>

<span class="nt">show_test_window</span> <span class="o">=</span> <span class="nt">True</span><span class="o">;</span>
<span class="nt">show_another_window</span> <span class="o">=</span> <span class="nt">False</span><span class="o">;</span>
<span class="nt">clear_color</span> <span class="o">=</span> <span class="cp">[</span><span class="mi">114</span><span class="p">/</span><span class="nx">255.0</span><span class="p">,</span> <span class="mi">144</span><span class="p">/</span><span class="nx">255.0</span><span class="p">,</span> <span class="mi">154</span><span class="p">/</span><span class="nx">255.0</span><span class="cp">]</span><span class="o">;</span>

<span class="err">#</span> <span class="nt">Main</span> <span class="nt">loop</span>
<span class="nt">done</span> <span class="o">=</span> <span class="nt">False</span><span class="o">;</span>
<span class="nt">while</span> <span class="nt">not</span> <span class="nt">done</span><span class="o">:</span>

    <span class="nt">event</span><span class="o">=</span><span class="nt">SDL_Event</span><span class="o">();</span>
    <span class="nt">while</span> <span class="nt">SDL_PollEvent</span><span class="o">(</span><span class="nt">event</span><span class="o">)!=</span><span class="nt">0</span><span class="o">:</span>

        <span class="nt">ImplSdlGL3</span><span class="p">.</span><span class="nc">ProcessEvent</span><span class="o">(</span><span class="nt">event</span><span class="o">);</span>
        <span class="nt">if</span> <span class="nt">event</span><span class="p">.</span><span class="nc">type</span> <span class="o">==</span> <span class="nt">SDL_QUIT</span><span class="o">:</span>
            <span class="nt">done</span> <span class="o">=</span> <span class="nt">true</span><span class="o">;</span>

    <span class="nt">ImplSdlGL3</span><span class="p">.</span><span class="nc">NewFrame</span><span class="o">(</span><span class="nt">window</span><span class="o">);</span>

    <span class="err">#</span> <span class="nt">1</span><span class="o">.</span> <span class="nt">Show</span> <span class="nt">a</span> <span class="nt">simple</span> <span class="nt">window</span>
    <span class="err">#</span> <span class="nt">Tip</span><span class="o">:</span> <span class="nt">if</span> <span class="nt">we</span> <span class="nt">don</span><span class="err">'</span><span class="nt">t</span> <span class="nt">call</span> <span class="nt">imgui</span><span class="p">.</span><span class="nc">Begin</span><span class="o">()/</span><span class="nt">imgui</span><span class="p">.</span><span class="nc">End</span><span class="o">()</span> <span class="nt">the</span> <span class="nt">widgets</span> <span class="nt">appears</span> <span class="nt">in</span> <span class="nt">a</span> <span class="nt">window</span> <span class="nt">automatically</span> <span class="nt">called</span> <span class="s2">"Debug"</span>

    <span class="nt">f</span> <span class="o">=</span> <span class="nt">0</span><span class="p">.</span><span class="nc">0</span><span class="o">;</span>
    <span class="nt">imgui</span><span class="p">.</span><span class="nc">Text</span><span class="o">(</span><span class="s2">"Hello, world!"</span><span class="o">);</span>
    <span class="nt">imgui</span><span class="p">.</span><span class="nc">SliderFloat</span><span class="o">(</span><span class="s2">"float"</span><span class="o">,</span> <span class="nt">f</span><span class="o">,</span> <span class="nt">0</span><span class="p">.</span><span class="nc">0</span><span class="o">,</span> <span class="nt">1</span><span class="p">.</span><span class="nc">0</span><span class="o">);</span>
    <span class="nt">imgui</span><span class="p">.</span><span class="nc">ColorEdit3</span><span class="o">(</span><span class="s2">"clear color"</span><span class="o">,</span> <span class="nt">clear_color</span><span class="o">);</span>
    <span class="nt">if</span> <span class="nt">imgui</span><span class="p">.</span><span class="nc">Button</span><span class="o">(</span><span class="s2">"Test Window"</span><span class="o">):</span> <span class="nt">show_test_window</span> <span class="o">^=</span> <span class="nt">1</span><span class="o">;</span>
    <span class="nt">if</span> <span class="nt">imgui</span><span class="p">.</span><span class="nc">Button</span><span class="o">(</span><span class="s2">"Another Window"</span><span class="o">):</span> <span class="nt">show_another_window</span> <span class="o">^=</span> <span class="nt">1</span><span class="o">;</span>
    <span class="nt">imgui</span><span class="p">.</span><span class="nc">Text</span><span class="o">(</span><span class="s2">"Application average %.3f ms/frame (%.1f FPS)"</span><span class="o">,</span> <span class="nt">1000</span><span class="p">.</span><span class="nc">0</span> <span class="o">/</span> <span class="nt">imgui</span><span class="p">.</span><span class="nc">GetIO</span><span class="o">()</span><span class="p">.</span><span class="nc">Framerate</span><span class="o">,</span> <span class="nt">imgui</span><span class="p">.</span><span class="nc">GetIO</span><span class="o">()</span><span class="p">.</span><span class="nc">Framerate</span><span class="o">);</span>

    <span class="err">#</span> <span class="nt">2</span><span class="o">.</span> <span class="nt">Show</span> <span class="nt">another</span> <span class="nt">simple</span> <span class="nt">window</span><span class="o">,</span> <span class="nt">this</span> <span class="nt">time</span> <span class="nt">using</span> <span class="nt">an</span> <span class="nt">explicit</span> <span class="nt">Begin</span><span class="o">/</span><span class="nt">End</span> <span class="nt">pair</span>
    <span class="nt">if</span> <span class="nt">show_another_window</span><span class="o">:</span>
        <span class="nt">imgui</span><span class="p">.</span><span class="nc">SetNextWindowSize</span><span class="o">(</span><span class="nt">ImVec2</span><span class="o">(</span><span class="nt">200</span><span class="o">,</span><span class="nt">100</span><span class="o">),</span> <span class="nt">ImGuiSetCond_FirstUseEver</span><span class="o">);</span>
        <span class="nt">imgui</span><span class="p">.</span><span class="nc">Begin</span><span class="o">(</span><span class="s2">"Another Window"</span><span class="o">,</span> <span class="nt">show_another_window</span><span class="o">);</span>
        <span class="nt">imgui</span><span class="p">.</span><span class="nc">Text</span><span class="o">(</span><span class="s2">"Hello"</span><span class="o">);</span>
        <span class="nt">imgui</span><span class="p">.</span><span class="nc">End</span><span class="o">();</span>

    <span class="err">#</span> <span class="nt">3</span><span class="o">.</span> <span class="nt">Show</span> <span class="nt">the</span> <span class="nt">ImGui</span> <span class="nt">test</span> <span class="nt">window</span><span class="o">.</span> <span class="nt">Most</span> <span class="nt">of</span> <span class="nt">the</span> <span class="nt">sample</span> <span class="nt">code</span> <span class="nt">is</span> <span class="nt">in</span> <span class="nt">imgui</span><span class="p">.</span><span class="nc">ShowTestWindow</span><span class="o">()</span>
    <span class="nt">if</span> <span class="nt">show_test_window</span><span class="o">:</span>
        <span class="nt">imgui</span><span class="p">.</span><span class="nc">SetNextWindowPos</span><span class="o">(</span><span class="nt">ImVec2</span><span class="o">(</span><span class="nt">650</span><span class="o">,</span> <span class="nt">20</span><span class="o">),</span> <span class="nt">ImGuiSetCond_FirstUseEver</span><span class="o">);</span>
        <span class="nt">imgui</span><span class="p">.</span><span class="nc">ShowTestWindow</span><span class="o">(</span><span class="nt">show_test_window</span><span class="o">);</span>

    <span class="err">#</span> <span class="nt">Rendering</span>
    <span class="nt">glViewport</span><span class="o">(</span><span class="nt">0</span><span class="o">,</span> <span class="nt">0</span><span class="o">,</span> <span class="nt">int</span><span class="o">(</span><span class="nt">imgui</span><span class="p">.</span><span class="nc">GetIO</span><span class="o">()</span><span class="p">.</span><span class="nc">DisplaySize</span><span class="p">.</span><span class="nc">x</span><span class="o">),</span> <span class="nt">int</span><span class="o">(</span><span class="nt">imgui</span><span class="p">.</span><span class="nc">GetIO</span><span class="o">()</span><span class="p">.</span><span class="nc">DisplaySize</span><span class="p">.</span><span class="nc">y</span><span class="o">));</span>
    <span class="nt">glClearColor</span><span class="o">(</span><span class="nt">clear_color</span><span class="p">.</span><span class="nc">x</span><span class="o">,</span> <span class="nt">clear_color</span><span class="p">.</span><span class="nc">y</span><span class="o">,</span> <span class="nt">clear_color</span><span class="p">.</span><span class="nc">z</span><span class="o">,</span> <span class="nt">clear_color</span><span class="p">.</span><span class="nc">w</span><span class="o">);</span>
    <span class="nt">glClear</span><span class="o">(</span><span class="nt">GL_COLOR_BUFFER_BIT</span><span class="o">);</span>
    <span class="nt">imgui</span><span class="p">.</span><span class="nc">Render</span><span class="o">();</span>
    <span class="nt">SDL_GL_SwapWindow</span><span class="o">(</span><span class="nt">window</span><span class="o">);</span>

<span class="err">#</span> <span class="nt">Cleanup</span>
<span class="nt">ImplSdlGL3</span><span class="p">.</span><span class="nc">Shutdown</span><span class="o">();</span>
<span class="nt">SDL_GL_DeleteContext</span><span class="o">(</span><span class="nt">glcontext</span><span class="o">);</span>
<span class="nt">SDL_DestroyWindow</span><span class="o">(</span><span class="nt">window</span><span class="o">);</span>
<span class="nt">SDL_Quit</span><span class="o">();</span>

<span class="nt">return</span> <span class="nt">0</span><span class="o">;</span>
</pre>

<p>if <strong>name</strong>=='<strong>main</strong>':
    main()</p>
<p>ImplSdlGL3.py
def Init(window):
    pass</p>
<p>def ProcessEvent(event):
    pass</p>
<p>def NewFrame(window):
    pass</p>
<p>pydのサーチ
環境変数PATH
環境変数PYSDL2_DLL_PATH
実行
諸々、正しく初期化していないのでクラッシュする。
Initを移植
import swig_imgui as imgui
from sdl2 import *</p>
<p>def Init(window):
    io = imgui.GetIO();
    #io.KeyMap[imgui.ImGuiKey_Tab] = SDLK_TAB;
    io.KeyMap[imgui.ImGuiKey_LeftArrow] = SDL_SCANCODE_LEFT;
    io.KeyMap[imgui.ImGuiKey_RightArrow] = SDL_SCANCODE_RIGHT;
    io.KeyMap[imgui.ImGuiKey_UpArrow] = SDL_SCANCODE_UP;
    io.KeyMap[imgui.ImGuiKey_DownArrow] = SDL_SCANCODE_DOWN;
    io.KeyMap[imgui.ImGuiKey_PageUp] = SDL_SCANCODE_PAGEUP;
    io.KeyMap[imgui.ImGuiKey_PageDown] = SDL_SCANCODE_PAGEDOWN;
    io.KeyMap[imgui.ImGuiKey_Home] = SDL_SCANCODE_HOME;
    io.KeyMap[imgui.ImGuiKey_End] = SDL_SCANCODE_END;
    io.KeyMap[imgui.ImGuiKey_Delete] = SDLK_DELETE;
    io.KeyMap[imgui.ImGuiKey_Backspace] = SDLK_BACKSPACE;
    io.KeyMap[imgui.ImGuiKey_Enter] = SDLK_RETURN;
    io.KeyMap[imgui.ImGuiKey_Escape] = SDLK_ESCAPE;
    io.KeyMap[imgui.ImGuiKey_A] = SDLK_a;
    io.KeyMap[imgui.ImGuiKey_C] = SDLK_c;
    io.KeyMap[imgui.ImGuiKey_V] = SDLK_v;
    io.KeyMap[imgui.ImGuiKey_X] = SDLK_x;
    io.KeyMap[imgui.ImGuiKey_Y] = SDLK_y;
    io.KeyMap[imgui.ImGuiKey_Z] = SDLK_z;</p>
<pre class="code literal-block"><span></span># Alternatively you can set this to NULL and call imgui.GetDrawData() after imgui.Render() to get the same ImDrawData pointer.
io.RenderDrawListsFn = ImGui_ImplSdlGL3_RenderDrawLists;
io.SetClipboardTextFn = ImGui_ImplSdlGL3_SetClipboardText;
io.GetClipboardTextFn = ImGui_ImplSdlGL3_GetClipboardText;
#io.ClipboardUserData = NULL;
</pre>

<h2>ifdef _WIN32</h2>
<pre class="code literal-block"><span></span>wmInfo=SDL_SysWMinfo();
SDL_VERSION(wmInfo.version);
SDL_GetWindowWMInfo(window, wmInfo);
io.ImeWindowHandle = wmInfo.info.win.window;
</pre>

<h2>else</h2>
<pre class="code literal-block"><span></span>#(void)window;
</pre>

<h2>endif</h2>
<pre class="code literal-block"><span></span>return True;
</pre>

<p>実行してエラーをつぶしていく。
int型配列へのindexを使った代入
冒頭のio.KeyMap[imgui.ImGuiKey_LeftArrow] = SDL_SCANCODE_LEFT;がエラーになる。
io.KeyMap[imgui.ImGuiKey_LeftArrow] = SDL_SCANCODE_LEFT;
TypeError: 'SwigPyObject' object does not support item assignment</p>
<p>io.KeyMapのCでの型。
int           KeyMap[ImGuiKey_COUNT];</p>
<p>単なる配列へのアクセス。KeyMapをlist的なオブジェクトとしてpython側に公開するよりも、ioにセッターを実装することにした。
imgui.iに追加。
%extend ImGuiIO {
    void SetKeyMap(int k, int v)
    {
        ImGui::GetIO().KeyMap[k]=v;
    }
}</p>
<p>pythonでは次のように使う。
io.SetKeyMap(imgui.ImGuiKey_LeftArrow, SDL_SCANCODE_LEFT);</p>
<p>関数ポインタ型にpythonの関数を代入。
swig的にはこれがいちばんの難問である。
関数ポインタを変数に代入するのがエラーになる。
def RenderDrawLists():
    pass</p>
<p>io.RenderDrawListsFn = RenderDrawLists;</p>
<p>TypeError: in method 'ImGuiIO_RenderDrawListsFn_set', argument 2 of type 'void (<em>)(ImDrawData </em>)'
Press any key to continue . . .</p>
<p>そりゃ、pythonの関数をこれに代入するのは無理だ。
解決方法は、以下のようにする。
imgui.iに追記。場所に注意が必要。
%{
static void PythonRenderDrawListsFn(ImDrawData<em> data)
{
    auto func=(PyObject</em>)ImGui::GetIO().UserData; // Get Python function
    auto obj = SWIG_NewPointerObj(SWIG_as_voidptr(data)
    , SWIGTYPE_p_ImDrawData, 0 |  0 );
    auto arglist = Py_BuildValue("(O)",obj); // Build argument list
    PyEval_CallObject(func, arglist); // Call Python
    Py_DECREF(arglist); // Trash arglist
    Py_DECREF(obj);
}
%}</p>
<p>// before
%include "imgui/imgui.h"
// after</p>
<p>%extend ImGuiIO {
    void SetRenderDrawListsFn(PyObject *pyfunc) {
        ImGui::GetIO().UserData=pyfunc;
        self-&gt;RenderDrawListsFn=PythonRenderDrawListsFn;
        Py_INCREF(pyfunc);
    }
}</p>
<p>残り２つの関数ポインタも同様の対応で行けると思うがコメントアウトして飛ばした。
io.SetClipboardTextFn = ImGui_ImplSdlGL3_SetClipboardText;
io.GetClipboardTextFn = ImGui_ImplSdlGL3_GetClipboardText;</p>
<p>void*の代入
io.ImeWindowHandle = wmInfo.info.win.window;</p>
<p>TypeError: in method 'ImGuiIO_ImeWindowHandle_set', argument 2 of type 'void *'</p>
<p>セッターを作った。
%extend ImGuiIO {
    void SetImeWindowHandle(long long v)
    {
        ImGui::GetIO().ImeWindowHandle = (void*)v;
    }
}</p>
<p>NewFrameの移植
def CreateDeviceObjects():
    pass</p>
<p>g_MousePressed=[False, False, False]
g_MouseWheel=None
def NewFrame(window):
    if not g_FontTexture:
        CreateDeviceObjects();</p>
<pre class="code literal-block"><span></span>io = imgui.GetIO();

# Setup display size (every frame to accommodate for window resizing)
w, h=SDL_GetWindowSize(window);
display_w, display_h=SDL_GL_GetDrawableSize(window);
io.DisplaySize = imgui.ImVec2(w, h);
io.DisplayFramebufferScale = ImVec2(
    (display_w / float(w)) if w &gt; 0 else 0, 
    (display_h / float(h)) if h &gt; 0 else 0);

# Setup time step
time = SDL_GetTicks();
current_time = time / 1000.0;
io.DeltaTime = (current_time - g_Time) if g_Time &gt; 0.0 else (1.0 / 60.0);
g_Time = current_time;

# Setup inputs
# (we already got mouse wheel, keyboard keys &amp; characters from SDL_PollEvent())
mouseMask, mx, my = SDL_GetMouseState();
if (SDL_GetWindowFlags(window) &amp; SDL_WINDOW_MOUSE_FOCUS):
    # Mouse position, in pixels (set to -1,-1 if no mouse / on another screen, etc.)
    io.MousePos = ImVec2(mx, my);   
else:
    io.MousePos = ImVec2(-1, -1);

# If a mouse press event came, always pass it as "mouse held this frame", so we don't miss click-release events that are shorter than 1 frame.
io.MouseDown[0] = g_MousePressed[0] or (mouseMask &amp; SDL_BUTTON(SDL_BUTTON_LEFT)) != 0;      
io.MouseDown[1] = g_MousePressed[1] or (mouseMask &amp; SDL_BUTTON(SDL_BUTTON_RIGHT)) != 0;
io.MouseDown[2] = g_MousePressed[2] or (mouseMask &amp; SDL_BUTTON(SDL_BUTTON_MIDDLE)) != 0;
g_MousePressed[0] = g_MousePressed[1] = g_MousePressed[2] = False;

io.MouseWheel = g_MouseWheel;
g_MouseWheel = 0.0;

# Hide OS mouse cursor if ImGui is drawing it
SDL_ShowCursor(0 if io.MouseDrawCursor else 1);

# Start the frame
imgui.NewFrame();
</pre>

<p>io.MouseDown
セッター。
%extend ImGuiIO {
    void SetMouseDown(int k, int v)
    {
        ImGui::GetIO().MouseDown[k]=v;
    }
}</p>
<p>CreateDeviceObjectsの移植
    # Backup GL state
    last_texture=glGetIntegerv(GL_TEXTURE_BINDING_2D);
    last_array_buffer=glGetIntegerv(GL_ARRAY_BUFFER_BINDING);
    last_vertex_array=glGetIntegerv(GL_VERTEX_ARRAY_BINDING);</p>
<pre class="code literal-block"><span></span>vertex_shader =b'''#version 330
</pre>

<p>uniform mat4 ProjMtx;
in vec2 Position;
in vec2 UV;
in vec4 Color;
out vec2 Frag_UV;
out vec4 Frag_Color;
void main()
{
    Frag_UV = UV;
    Frag_Color = Color;
    gl_Position = ProjMtx * vec4(Position.xy,0,1);
};
'''</p>
<pre class="code literal-block"><span></span>fragment_shader =b'''#version 330
</pre>

<p>uniform sampler2D Texture;
in vec2 Frag_UV;
in vec4 Frag_Color;
out vec4 Out_Color;
void main()
{
    Out_Color = Frag_Color * texture( Texture, Frag_UV.st);
};
'''</p>
<pre class="code literal-block"><span></span>g_ShaderHandle = glCreateProgram();
g_VertHandle = glCreateShader(GL_VERTEX_SHADER);
g_FragHandle = glCreateShader(GL_FRAGMENT_SHADER);
glShaderSource(g_VertHandle, vertex_shader);
glShaderSource(g_FragHandle, fragment_shader);
glCompileShader(g_VertHandle);
glCompileShader(g_FragHandle);
glAttachShader(g_ShaderHandle, g_VertHandle);
glAttachShader(g_ShaderHandle, g_FragHandle);
glLinkProgram(g_ShaderHandle);

g_AttribLocationTex = glGetUniformLocation(g_ShaderHandle, "Texture");
g_AttribLocationProjMtx = glGetUniformLocation(g_ShaderHandle, "ProjMtx");
g_AttribLocationPosition = glGetAttribLocation(g_ShaderHandle, "Position");
g_AttribLocationUV = glGetAttribLocation(g_ShaderHandle, "UV");
g_AttribLocationColor = glGetAttribLocation(g_ShaderHandle, "Color");

g_VboHandle=glGenBuffers(1);
g_ElementsHandle=glGenBuffers(1);

g_VaoHandle=glGenVertexArrays(1);
glBindVertexArray(g_VaoHandle);
glBindBuffer(GL_ARRAY_BUFFER, g_VboHandle);
glEnableVertexAttribArray(g_AttribLocationPosition);
glEnableVertexAttribArray(g_AttribLocationUV);
glEnableVertexAttribArray(g_AttribLocationColor);
</pre>

<h2>define OFFSETOF(TYPE, ELEMENT) ((size_t)&amp;(((TYPE *)0)-&gt;ELEMENT))</h2>
<pre class="code literal-block"><span></span>SIZEOF_ImDrawVert=20
glVertexAttribPointer(g_AttribLocationPosition, 2, GL_FLOAT, GL_FALSE, SIZEOF_ImDrawVert, ctypes.c_void_p(0));
glVertexAttribPointer(g_AttribLocationUV, 2, GL_FLOAT, GL_FALSE, SIZEOF_ImDrawVert, ctypes.c_void_p(8));
glVertexAttribPointer(g_AttribLocationColor, 4, GL_UNSIGNED_BYTE, GL_TRUE, SIZEOF_ImDrawVert, ctypes.c_void_p(16));
</pre>

<h2>undef OFFSETOF</h2>
<pre class="code literal-block"><span></span>CreateFontsTexture();

# Restore modified GL state
glBindTexture(GL_TEXTURE_2D, last_texture);
glBindBuffer(GL_ARRAY_BUFFER, last_array_buffer);
glBindVertexArray(last_vertex_array);

return True;
</pre>

<p>sizeof
%constant int SIZEOF_ImDrawVert = sizeof(ImDrawVert);
%constant int SIZEOF_ImDrawIdx = sizeof(ImDrawIdx);</p>
<p>offset
%{</p>
<h2>define OFFSETOF(TYPE, ELEMENT) ((size_t)&amp;(((TYPE *)0)-&gt;ELEMENT))</h2>
<p>const int OFFSETOF_ImDrawVert_pos = OFFSETOF(ImDrawVert, pos);
const int OFFSETOF_ImDrawVert_uv = OFFSETOF(ImDrawVert, uv);
const int OFFSETOF_ImDrawVert_col = OFFSETOF(ImDrawVert, col);</p>
<h2>undef OFFSETOF</h2>
<p>%}
const int OFFSETOF_ImDrawVert_pos = OFFSETOF_ImDrawVert_pos;
const int OFFSETOF_ImDrawVert_uv = OFFSETOF_ImDrawVert_uv;
const int OFFSETOF_ImDrawVert_col = OFFSETOF_ImDrawVert_col;</p>
<p>CreateFontsTextureの移植
def CreateFontsTexture():
    # Build texture atlas
    io = imgui.GetIO();
    # Load as RGBA 32-bits for OpenGL3 demo because it is more likely to be compatible with user's existing shader.
    pixels, width, height=io.Fonts.GetTexDataAsRGBA32();</p>
<pre class="code literal-block"><span></span># Upload texture to graphics system
last_texture=glGetIntegerv(GL_TEXTURE_BINDING_2D);
g_FontTexture=glGenTextures(1);
glBindTexture(GL_TEXTURE_2D, g_FontTexture);
glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_MIN_FILTER, GL_LINEAR);
glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_MAG_FILTER, GL_LINEAR);
glPixelStorei(GL_UNPACK_ROW_LENGTH, 0);
glTexImage2D(GL_TEXTURE_2D, 0, GL_RGBA, width, height, 0, GL_RGBA, GL_UNSIGNED_BYTE, pixels);

# Store our identifier
io.Fonts.TexID = g_FontTexture;

# Restore state
glBindTexture(GL_TEXTURE_2D, last_texture);
</pre>

<p>値を返すためにポインタ引数を出力に使い(in + argout)、長さの分かっているバイト列へのポインタをbytesとして返す
対象はこれ。
IMGUI_API void GetTexDataAsRGBA32(unsigned char<em><em> out_pixels, int</em> out_width, int</em> out_height, int* out_bytes_per_pixel = NULL);</p>
<p>typemapでやってみる。
imgui.iの%include "imgui/imgui.h"より前に記述。
%typemap(in, numinputs=0) (unsigned char<strong> out_pixels, int<em> out_width, int</em> out_height, int<em> out_bytes_per_pixel) (unsigned char </em>tempP, int tempW, int tempH, int tempB) {
    $1 = &amp;tempP;
    $2 = &amp;tempW;
    $3 = &amp;tempH;
    $4 = &amp;tempB;
}
%typemap(argout)(unsigned char</strong> out_pixels, int<em> out_width, int</em> out_height, int<em> out_bytes_per_pixel){
    auto b = PyBytes_FromStringAndSize((const char </em>)<em>$1, (</em>$2) * (<em>$3) * (</em>$4));
    auto w = PyLong_FromLong(<em>$2);
    auto h = PyLong_FromLong(</em>$3);</p>
<pre class="code literal-block"><span></span>if ((!$result) || ($result == Py_None)) {
    // new tuple3
    $result = PyTuple_New(3);
    PyTuple_SetItem($result, 0, b);
    PyTuple_SetItem($result, 1, w);
    PyTuple_SetItem($result, 2, h);
}
else{
    if (!PyTuple_Check($result)) {
        // new tuple4
        auto t= PyTuple_New(4);
        PyTuple_SetItem(t, 0, $result);
        PyTuple_SetItem(t, 1, b);
        PyTuple_SetItem(t, 2, w);
        PyTuple_SetItem(t, 3, h);
        $result=t;
    }
    else {
        // concat
        auto head = $result;
        auto tail = PyTuple_New(3);
        PyTuple_SetItem($result, 0, b);
        PyTuple_SetItem($result, 1, w);
        PyTuple_SetItem($result, 2, h);
        $result = PySequence_Concat(head, tail);
        Py_DECREF(head);
        Py_DECREF(tail);
    }
}
</pre>

<p>}</p>
<p>typemap(in)で呼び出し時に出力変数を与える必要を無くして、typemap(argout)で呼び出し後の返り値をtuple化して値を詰める。その際に、バイト列のサイズが計算できるのでPyBytes_FromStringAndSizeでbytesを作る。
TexIDのセッター
intからvoid*への変換。
%extend ImFontAtlas {
    void SetTexID(long long id) {
        self-&gt;TexID=reinterpret_cast<void>(id);
    }
}</void></p>
<p>ここまで実装するとTextureのnullptrでプログラムがクラッシュしなくなる。
imguiのwidgetに対するinoutな引数
float<em>
IMGUI_API bool SliderFloat(const char</em> label, float<em> v, float v_min, float v_max, const char</em> display_format = "%.3f", float power = 1.0f);</p>
<p>argoutにすると返り値が(bool, float)になっていまいちな気がする。
swigでfloat*型のヘルパークラスを作る。
%include "cpointer.i"
%pointer_functions(float, floatp);</p>
<p>f=imgui.new_floatp()
imgui.floatp_assign(f, 0.0)
imgui.SliderFloat("float", f, 0.0, 1.0);</p>
<p>bool<em>
floatと同様に。
IMGUI_API void ShowTestWindow(bool</em> p_open = NULL);</p>
<p>%include "cpointer.i"
%pointer_functions(bool, boolp);</p>
<pre class="code literal-block"><span></span>show_test_window = imgui.new_boolp();
imgui.boolp_assign(show_test_window, True)

if imgui.Button("Test Window"): imgui.boolp_assign(show_test_window, not boolp_assign.value))

if imgui.boolp_value(show_test_window):
    imgui.SetNextWindowPos(imgui.ImVec2(650, 20), imgui.ImGuiSetCond_FirstUseEver);
    imgui.ShowTestWindow(show_test_window);
</pre>

<p>動くとはいえこれはいかんな。ポインタクラスをもう少し便利にするか、別の方法を調べよう。
float[3]
IMGUI_API bool ColorEdit3(const char* label, float col[3]);</p>
<p>typemapでlistリストを受け取って、listに結果を格納するように記述する。
%typemap(in) float col[3] (float temp[3]) {
    if (!PySequence_Check($input)) {
        PyErr_SetString(PyExc_ValueError,"Expected a sequence");
        return NULL;
    }
    if (PySequence_Length($input) &lt; $1_dim0) {
        PyErr_SetString(PyExc_ValueError,"Size mismatch. Expected more than $1_dim0 elements");
        return NULL;
    }
    for (int i = 0; i &lt; $1_dim0; i++) {
        PyObject <em>o = PySequence_GetItem($input,i);
        if (PyNumber_Check(o)) {
            temp[i] = (float) PyFloat_AsDouble(o);
        }
        else {
            PyErr_SetString(PyExc_ValueError,"Sequence elements must be numbers");
            return NULL;
        }
    }
    $1 = temp;
}
%typemap(argout) float col[3] {
    for (int i = 0; i &lt; $1_dim0; i++) {
        PyObject </em>o = PyFloat_FromDouble((double) $1[i]);
        PyList_SetItem($input, i, o);
    }
}</p>
<p>clear_color = [114/255.0, 144/255.0, 154/255.0, 0];
imgui.ColorEdit3("clear color", clear_color);</p>
<p>RenderDrawListsの移植
def RenderDrawLists(draw_data):
    global g_ShaderHandle</p>
<pre class="code literal-block"><span></span># Avoid rendering when minimized, scale coordinates for retina displays (screen coordinates != framebuffer coordinates)
io = imgui.GetIO();
fb_width = int(io.DisplaySize.x * io.DisplayFramebufferScale.x);
fb_height = int(io.DisplaySize.y * io.DisplayFramebufferScale.y);
if fb_width == 0 or fb_height == 0:
    return;
draw_data.ScaleClipRects(io.DisplayFramebufferScale);

# Backup GL state
last_active_texture=glGetIntegerv(GL_ACTIVE_TEXTURE);
glActiveTexture(GL_TEXTURE0);
last_program=glGetIntegerv(GL_CURRENT_PROGRAM);
last_texture=glGetIntegerv(GL_TEXTURE_BINDING_2D);
last_array_buffer=glGetIntegerv(GL_ARRAY_BUFFER_BINDING);
last_element_array_buffer=glGetIntegerv(GL_ELEMENT_ARRAY_BUFFER_BINDING);
last_vertex_array=glGetIntegerv(GL_VERTEX_ARRAY_BINDING);
last_blend_src_rgb=glGetIntegerv(GL_BLEND_SRC_RGB);
last_blend_dst_rgb=glGetIntegerv(GL_BLEND_DST_RGB);
last_blend_src_alpha=glGetIntegerv(GL_BLEND_SRC_ALPHA);
last_blend_dst_alpha=glGetIntegerv(GL_BLEND_DST_ALPHA);
last_blend_equation_rgb=glGetIntegerv(GL_BLEND_EQUATION_RGB);
last_blend_equation_alpha=glGetIntegerv(GL_BLEND_EQUATION_ALPHA);
last_viewport=glGetIntegerv(GL_VIEWPORT);
last_scissor_box=glGetIntegerv(GL_SCISSOR_BOX);
last_enable_blend = glIsEnabled(GL_BLEND);
last_enable_cull_face = glIsEnabled(GL_CULL_FACE);
last_enable_depth_test = glIsEnabled(GL_DEPTH_TEST);
last_enable_scissor_test = glIsEnabled(GL_SCISSOR_TEST);

# Setup render state: alpha-blending enabled, no face culling, no depth testing, scissor enabled
glEnable(GL_BLEND);
glBlendEquation(GL_FUNC_ADD);
glBlendFunc(GL_SRC_ALPHA, GL_ONE_MINUS_SRC_ALPHA);
glDisable(GL_CULL_FACE);
glDisable(GL_DEPTH_TEST);
glEnable(GL_SCISSOR_TEST);

# Setup viewport, orthographic projection matrix
glViewport(0, 0, fb_width, fb_height);
ortho_projection = (ctypes.c_float * 16)(
     2.0/io.DisplaySize.x, 0.0,                   0.0, 0.0,
     0.0,                  2.0/-io.DisplaySize.y, 0.0, 0.0,
     0.0,                  0.0,                  -1.0, 0.0,
    -1.0,                  1.0,                   0.0, 1.0,
);
glUseProgram(g_ShaderHandle);
glUniform1i(g_AttribLocationTex, 0);
glUniformMatrix4fv(g_AttribLocationProjMtx, 1, GL_FALSE, ortho_projection);
glBindVertexArray(g_VaoHandle);

for n in range(draw_data.CmdListsCount):

    cmd_list = draw_data.CmdLists[n];
    idx_buffer_offset = 0;

    glBindBuffer(GL_ARRAY_BUFFER, g_VboHandle);
    glBufferData(GL_ARRAY_BUFFER, cmd_list.VtxBuffer.Size * SIZEOF_ImDrawVert, cmd_list.VtxBuffer.Data, GL_STREAM_DRAW);

    glBindBuffer(GL_ELEMENT_ARRAY_BUFFER, g_ElementsHandle);
    glBufferData(GL_ELEMENT_ARRAY_BUFFER, cmd_list.IdxBuffer.Size * SIZEOF_ImDrawVert, cmd_list.IdxBuffer.Data, GL_STREAM_DRAW);

    for cmd_i in range(cmd_list.CmdBuffer.Size):

        pcmd = cmd_list.CmdBuffer[cmd_i];
        if pcmd.UserCallback:
            pcmd.UserCallback(cmd_list, pcmd);
        else:
            glBindTexture(GL_TEXTURE_2D, pcmd.TextureId);
            glScissor(pcmd.ClipRect.x, (fb_height - pcmd.ClipRect.w), (pcmd.ClipRect.z - pcmd.ClipRect.x), (pcmd.ClipRect.w - pcmd.ClipRect.y));
            glDrawElements(GL_TRIANGLES, pcmd.ElemCount, GL_UNSIGNED_SHORT, idx_buffer_offset);

        idx_buffer_offset += pcmd.ElemCount;

# Restore modified GL state
glUseProgram(last_program);
glBindTexture(GL_TEXTURE_2D, last_texture);
glActiveTexture(last_active_texture);
glBindVertexArray(last_vertex_array);
glBindBuffer(GL_ARRAY_BUFFER, last_array_buffer);
glBindBuffer(GL_ELEMENT_ARRAY_BUFFER, last_element_array_buffer);
glBlendEquationSeparate(last_blend_equation_rgb, last_blend_equation_alpha);
glBlendFuncSeparate(last_blend_src_rgb, last_blend_dst_rgb, last_blend_src_alpha, last_blend_dst_alpha);
if (last_enable_blend): 
    glEnable(GL_BLEND); 
else: 
    glDisable(GL_BLEND);
if (last_enable_cull_face): 
    glEnable(GL_CULL_FACE); 
else: 
    glDisable(GL_CULL_FACE);
if (last_enable_depth_test): 
    glEnable(GL_DEPTH_TEST);
else: 
    glDisable(GL_DEPTH_TEST);
if (last_enable_scissor_test): 
    glEnable(GL_SCISSOR_TEST); 
else: 
    glDisable(GL_SCISSOR_TEST);
glViewport(last_viewport[0], last_viewport[1], last_viewport[2], last_viewport[3]);
glScissor(last_scissor_box[0], last_scissor_box[1], last_scissor_box[2], last_scissor_box[3]);
</pre>

<p>getter
配列アクセスできない。
cmd_list = draw_data.CmdLists[n]</p>
<p>ゲッターを実装する
%extend ImDrawData {
    ImDrawList* GetCmdList(int n){
        return self-&gt;CmdLists[n];
    }
}</p>
<p>templateの型定義が無い
実装する型を明示する。
%template(ImVectorDrawVert) ImVector<imdrawvert>;
%template(ImVectorDrawIdx) ImVector<imdrawidx>;
%template(ImVectorDrawCmd) ImVector<imdrawcmd>;</imdrawcmd></imdrawidx></imdrawvert></p>
<p>Byte列を得る
cmd_list.VtxBuffer.Data</p>
<p>%typemap(in, numinputs=0) (unsigned char<strong> out_bytes, int<em> out_size) (unsigned char </em>tempP, int tempSize) {
    $1 = &amp;tempP;
    $2 = &amp;tempSize;
}
%typemap(argout)(unsigned char</strong> out_bytes, int<em> out_size){
    auto b = PyBytes_FromStringAndSize((const char </em>)<em>$1, </em>$2);</p>
<pre class="code literal-block"><span></span>if ((!$result) || ($result == Py_None)) {
    $result = b;
}
else{
    if (!PyTuple_Check($result)) {
        // new tuple4
        auto t= PyTuple_New(2);
        PyTuple_SetItem(t, 0, $result);
        PyTuple_SetItem(t, 1, b);
        $result=t;
    }
    else {
        // concat
        auto head = $result;
        auto tail = PyTuple_New(1);
        PyTuple_SetItem($result, 0, b);
        $result = PySequence_Concat(head, tail);
        Py_DECREF(head);
        Py_DECREF(tail);
    }
}
</pre>

<p>}</p>
<p>// before
%include "imgui/imgui.h"
// after</p>
<p>%extend ImDrawList {
    void GetVtxBufferData(unsigned char <strong>out_bytes, int <em>out_size){
        </em>out_bytes=(unsigned char <em>)self-&gt;VtxBuffer.Data;
        </em>out_size=self-&gt;VtxBuffer.Size * sizeof(self-&gt;VtxBuffer.Data[0]);
    }
    void GetIdxBufferData(unsigned char </strong>out_bytes, int <em>out_size){
        </em>out_bytes=(unsigned char <em>)self-&gt;IdxBuffer.Data;
        </em>out_size=self-&gt;IdxBuffer.Size * sizeof(self-&gt;IdxBuffer.Data[0]);
    }
}</p>
<p>glBindBuffer(GL_ARRAY_BUFFER, g_VboHandle);
glBufferData(GL_ARRAY_BUFFER, cmd_list.VtxBuffer.Size * SIZEOF_ImDrawVert, cmd_list.GetVtxBufferData(), GL_STREAM_DRAW);</p>
<p>glBindBuffer(GL_ELEMENT_ARRAY_BUFFER, g_ElementsHandle);
glBufferData(GL_ELEMENT_ARRAY_BUFFER, cmd_list.IdxBuffer.Size * SIZEOF_Idx, cmd_list.GetIdxBufferData(), GL_STREAM_DRAW);</p>
<p>Shutdownの移植
def Shutdown():
    InvalidateDeviceObjects();
    imgui.Shutdown();</p>
<p>def InvalidateDeviceObjects():
    global g_VaoHandle
    global g_VboHandle
    global g_ElementsHandle
    global g_ShaderHandle
    global g_VertHandle
    global g_FragHandle
    global g_FontTexture</p>
<pre class="code literal-block"><span></span>if (g_VaoHandle): glDeleteVertexArrays(1, g_VaoHandle);
if (g_VboHandle): glDeleteBuffers(1, g_VboHandle);
if (g_ElementsHandle): glDeleteBuffers(1, g_ElementsHandle);
g_VaoHandle = g_VboHandle = g_ElementsHandle = 0;

if (g_ShaderHandle and g_VertHandle): glDetachShader(g_ShaderHandle, g_VertHandle);
if (g_VertHandle): glDeleteShader(g_VertHandle);
g_VertHandle = 0;

if (g_ShaderHandle and g_FragHandle): glDetachShader(g_ShaderHandle, g_FragHandle);
if (g_FragHandle): glDeleteShader(g_FragHandle);
g_FragHandle = 0;

if (g_ShaderHandle): glDeleteProgram(g_ShaderHandle);
g_ShaderHandle = 0;

if (g_FontTexture):
    glDeleteTextures(1, g_FontTexture);
    imgui.GetIO().Fonts.SetTexID(0);
    g_FontTexture = 0;
</pre>

<p>ProcessEventの移植
def ProcessEvent(event):
    global g_MouseWheel
    global g_MousePressed</p>
<pre class="code literal-block"><span></span>io = imgui.GetIO();
if event.type==SDL_MOUSEWHEEL:
    if (event.wheel.y &gt; 0):
        g_MouseWheel = 1;
    if (event.wheel.y &lt; 0):
        g_MouseWheel = -1;
    return True;
elif event.type==SDL_MOUSEBUTTONDOWN:
    if (event.button.button == SDL_BUTTON_LEFT): g_MousePressed[0] = True;
    if (event.button.button == SDL_BUTTON_RIGHT): g_MousePressed[1] = True;
    if (event.button.button == SDL_BUTTON_MIDDLE): g_MousePressed[2] = True;
    return True;
elif event.type==SDL_TEXTINPUT:
    io.AddInputCharactersUTF8(event.text.text);
    return True;
elif event.type==SDL_KEYDOWN or event.type==SDL_KEYUP:
    key = event.key.keysym.sym &amp; ~SDLK_SCANCODE_MASK;
    io.SetKeysDown(key, event.type == SDL_KEYDOWN);
    io.KeyShift = ((SDL_GetModState() &amp; KMOD_SHIFT) != 0);
    io.KeyCtrl = ((SDL_GetModState() &amp; KMOD_CTRL) != 0);
    io.KeyAlt = ((SDL_GetModState() &amp; KMOD_ALT) != 0);
    io.KeySuper = ((SDL_GetModState() &amp; KMOD_GUI) != 0);
    return True;

return False;
</pre>

<p>io.KeysDown
セッター
%extend ImGuiIO {
    void SetKeysDown(int k, int v)
    {
        ImGui::GetIO().KeysDown[k]=v;
    }
}</p>
<p>かくしてほぼ動くようになった。</p>
<p>実際には新しいWidgetをPythonから使用するたびに値をやりとりする部分を追加しなければならないが、そこはおいおいやっていく。
VisualStudioのセットアップ
こういうネイティブモジュールの開発ではないとクラッシュの原因を探すのが困難になるが、VisualStudioで普通にアタッチできるので便利。
ひとつのsolutionにpythonプロジェクトと、c++のdllプロジェクトを同居させてデバッグできる。</p>
<p>あとで書く</p>
</div>
                </div>
            </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/2017/07/simpleabcviewer/" class="u-url">SimpleAbcViewerをビルドしてみる</a></h1>
                <div class="metadata">
                    <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                        ousttrue
                    </span></p>
            <p class="dateline">
            <a href="posts/2017/07/simpleabcviewer/" rel="bookmark">
            <time class="published dt-published" datetime="2017-07-28T00:00:00Z" itemprop="datePublished" title="2017-07-28 00:00">2017-07-28 00:00</time></a>
            </p>
                        <p class="commentline">
        
    <a href="posts/2017/07/simpleabcviewer/#disqus_thread" data-disqus-identifier="cache/content/posts/2017/07/simpleabcviewer.html">コメント</a>


                </p>
</div>
            </header><div class="e-content entry-content">
                    <div>
<p>alembic-1.7.1に無かったので、alembic-1.5.8から発掘してビルドしてみた。</p>
<ul>
<li>https://github.com/ousttrue/SimpleAbcViewer</li>
</ul>
<p>CMakeLists.txtを再構成して、ビルド・動作を確認できた。
SimpleAbcViewerが消えたのは、SimpleじゃないAbcViewができて分離したからぽい。</p>
<ul>
<li>https://github.com/alembic/abcview</li>
</ul>
<p>こっちはQt4を使っていてWindowsではシンプルじゃなかったので、ビルドを断念したのであった・・・。
SimpleAbcViewerのAbcOpenGLを読めばAlembicのAPI(読む方)が分かりそう。
書く方は、mmdbridgeを読むのがよさげ。
タコのサンプルを表示。</p>
<ul>
<li>https://code.google.com/archive/p/alembic/downloads?page=2</li>
</ul>
</div>
                </div>
            </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/2017/07/cmake_find_package/" class="u-url">cmakeのfind_package</a></h1>
                <div class="metadata">
                    <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                        ousttrue
                    </span></p>
            <p class="dateline">
            <a href="posts/2017/07/cmake_find_package/" rel="bookmark">
            <time class="published dt-published" datetime="2017-07-20T00:00:00Z" itemprop="datePublished" title="2017-07-20 00:00">2017-07-20 00:00</time></a>
            </p>
                        <p class="commentline">
        
    <a href="posts/2017/07/cmake_find_package/#disqus_thread" data-disqus-identifier="cache/content/posts/2017/07/cmake_find_package.html">コメント</a>


                </p>
</div>
            </header><div class="e-content entry-content">
                    <div>
<p>cmakeのFIND_PACKAGEわかりずらいよ。もやもやするものがある。</p>
<p>GLUTの例
検証用に小さい例を作ってみた。</p>
<p>https://stackoverflow.com/questions/9460242/how-to-compile-glut-opengl-project-with-cmake-and-kdevelop-in-linux</p>
<p>これを参考にしたのだけどちょっと手直しした。</p>
<p>ADD_EXECUTABLEの前にINCLUDE_DIRECTORIESする必要がある
OPENGL_INCLUDE_DIRSじゃなくてOPENGL_INCLUDE_DIR
GLUT_INCLUDE_DIRSじゃなくてGLUT_INCLUDE_DIR</p>
<p>Linuxとかだとdistributionがcmakeファイルを管理してたりするかもしれん。
main.cpp</p>
<h2>include <gl></gl>
</h2>
<p>void display(void)
{
}</p>
<p>int main(int argc, char *argv[])
{
    glutInit(&amp;argc, argv);
    glutCreateWindow(argv[0]);
    glutDisplayFunc(display);
    glutMainLoop();
    return 0;
}</p>
<p>CMakeLists.txt
CMAKE_MINIMUM_REQUIRED(VERSION 2.8)
PROJECT(hello)</p>
<p>FIND_PACKAGE(OpenGL REQUIRED)
MESSAGE(STATUS ${OPENGL_LIBRARIES})
MESSAGE(STATUS ${OPENGL_INCLUDE_DIR})</p>
<p>FIND_PACKAGE(GLUT REQUIRED)
MESSAGE(STATUS ${GLUT_LIBRARY})
MESSAGE(STATUS ${GLUT_INCLUDE_DIR})</p>
<p>INCLUDE_DIRECTORIES(
    ${OPENGL_INCLUDE_DIR}
    ${GLUT_INCLUDE_DIR}
    )
ADD_DEFINITIONS(
    -DFREEGLUT_LIB_PRAGMAS=0 # avoid pragma
    )
ADD_EXECUTABLE(hello 
    main.cpp
    )
TARGET_LINK_LIBRARIES(hello
    ${OPENGL_LIBRARIES}
    ${GLUT_LIBRARY}
    )</p>
<p>実行時のメッセージ
-- glu32opengl32
--
-- D:/vcpkg/installed/x64-windows/lib/freeglut.lib
-- D:/vcpkg/installed/x64-windows/include
-- Configuring done
-- Generating done</p>
<p>なぜかvcpkgのfreeglutを発見してくれた。
vcpkgがcmakeの探索パスを追加しているぽい。レジストリとかか？
まず、第1に
FIND_PACKAGEの結果として如何なる変数が増えるのかが分からん。</p>
<p>https://cmake.org/Wiki/CMake:How_To_Find_Libraries#How_package_finding_works</p>
<p>慣例では、下記のようになっている。</p>
<p>_FOUND
_INCLUDE_DIRS or _INCLUDES
_LIBRARIES or _LIBRARIES or _LIBS
_DEFINITIONS</p>
<p>強制じゃなくて規約なので各種表記ブレの余地が危険を醸し出している。
大文字小文字(find_package(glut)に対して${GLUT_FOUND})、複数単数(DIR, DIRS)、短縮(LIBRARIES, LIBS)とか一貫性が。はまりそうだー。
とりあえあず、標準のパッケージに関してはコマンドから問い合わせることができる。</p>
<blockquote>
<p>cmake --help-module OpenGL
FindOpenGL</p>
</blockquote>
<hr>
<p>FindModule for OpenGL and GLU.</p>
<p>IMPORTED Targets
^^^^^^^^^^^^^^^^</p>
<p>This module defines the <code>IMPORTED</code> targets:</p>
<p><code>OpenGL::GL</code>
 Defined if the system has OpenGL.
<code>OpenGL::GLU</code>
 Defined if the system has GLU.</p>
<p>Result Variables
^^^^^^^^^^^^^^^^</p>
<p>This module sets the following variables:</p>
<p><code>OPENGL_FOUND</code>
 True, if the system has OpenGL.
<code>OPENGL_XMESA_FOUND</code>
 True, if the system has XMESA.
<code>OPENGL_GLU_FOUND</code>
 True, if the system has GLU.
<code>OPENGL_INCLUDE_DIR</code>
 Path to the OpenGL include directory.
<code>OPENGL_LIBRARIES</code>
 Paths to the OpenGL and GLU libraries.</p>
<p>If you want to use just GL you can use these values:</p>
<p><code>OPENGL_gl_LIBRARY</code>
 Path to the OpenGL library.
<code>OPENGL_glu_LIBRARY</code>
 Path to the GLU library.</p>
<p>OSX Specific
^^^^^^^^^^^^</p>
<p>On OSX default to using the framework version of OpenGL. People will
have to change the cache values of OPENGL_glu_LIBRARY and
OPENGL_gl_LIBRARY to use OpenGL with X11 on OSX.</p>
<blockquote>
<p>cmake --help-module GLUT
FindGLUT</p>
</blockquote>
<hr>
<p>try to find glut library and include files.</p>
<p>IMPORTED Targets
^^^^^^^^^^^^^^^^</p>
<p>This module defines the <code>IMPORTED</code> targets:</p>
<p><code>GLUT::GLUT</code>
 Defined if the system has GLUT.</p>
<p>Result Variables
^^^^^^^^^^^^^^^^</p>
<p>This module sets the following variables:</p>
<p>::</p>
<p>GLUT_INCLUDE_DIR, where to find GL/glut.h, etc.
 GLUT_LIBRARIES, the libraries to link against
 GLUT_FOUND, If false, do not try to use GLUT.</p>
<p>Also defined, but not for general use are:</p>
<p>::</p>
<p>GLUT_glut_LIBRARY = the full path to the glut library.
 GLUT_Xmu_LIBRARY  = the full path to the Xmu library.
 GLUT_Xi_LIBRARY   = the full path to the Xi Library.</p>
<p>という感じでcmakeに最初から入っているタイプのモジュールはわかる。
ちなみにFIND_PACKAGEの引数は大文字小文字を区別しないが、結果はただの変数なので区別することに注意。
${OPENGL_GL_LIBRARY}とかだめですから。
不安があるときはMESSAGEでプリントデバッグするのが手堅い。
MESSAGE(STATUS ${OPENGL_gl_LIBRARY})</p>
<p>VisualStudioなのでリンクをDebug, Releaseで振り分けたいんだけど
lib/freeglut.libとdebug/lib/freeglutd.libとか。
上の例は問答無用でRelease版にリンクされる(glutの場合は、別にfreeglutのデバッグはしないのでそれはそれでよかったりもするが・・・)。プラグマでリンクすればいいやんとなるのだが、link_directoriesにはDebug, Releaseの振り分けはない。Release決め打ちの方がましである。
TARGET_LINK_LIBRARIESには振り分け機能が実装されている。
TARGET_LINK_LIBRARIES(hello
    debug path_to_freeglutd.lib
    optimized path_to_freeglut.lib
    )</p>
<p>という風に記述できる。で、これを如何にしてFIND_PACKAGEと連携させるのか。
例としてfreeglut.libとfreeglutd.lib。
FIND_PACKAGE(OpenGL REQUIRED)
MESSAGE(STATUS ${OPENGL_LIBRARIES})
FIND_PACKAGE(GLUT)
MESSAGE(STATUS ${GLUT_LIBRARY})
STRING(REPLACE lib/freeglut.lib debug/lib/freeglutd.lib GLUT_LIBRARY_DEBUG ${GLUT_LIBRARY})
SET(OPENGL_LIBS 
    general ${OPENGL_LIBRARIES} 
    optimized ${GLUT_LIBRARY} 
    debug ${GLUT_LIBRARY_DEBUG}
    )
TARGET_LINK_LIBRARIES(hello
    ${OPENGL_LIBS}
    )</p>
<p>インストールしたパッケージがFindされないんだけど
alembicなどvcpkgでインストールしたパッケージをVCPKG_DIR/installed/x64-windowsから探索して欲しいのだが方法がよくわからない。</p>
<p>CMakeを使ってみた (7) find_packageとpkg_check_modulesによるライブラリ探索</p>
<p>あとで</p>
</div>
                </div>
            </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/2017/07/vcpkg_alembic/" class="u-url">vcpkgのAlembicパッケージ(USE_HDF5)を作ってみる</a></h1>
                <div class="metadata">
                    <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                        ousttrue
                    </span></p>
            <p class="dateline">
            <a href="posts/2017/07/vcpkg_alembic/" rel="bookmark">
            <time class="published dt-published" datetime="2017-07-18T00:00:00Z" itemprop="datePublished" title="2017-07-18 00:00">2017-07-18 00:00</time></a>
            </p>
                        <p class="commentline">
        
    <a href="posts/2017/07/vcpkg_alembic/#disqus_thread" data-disqus-identifier="cache/content/posts/2017/07/vcpkg_alembic.html">コメント</a>


                </p>
</div>
            </header><div class="e-content entry-content">
                    <div>
<p>mmdbridgeのvcpkgを使ったビルド手順を作ったついでにAlembicのvcpkg向けパッケージを作ってみる。</p>
<p>情報収集</p>
<ul>
<li>https://github.com/Microsoft/vcpkg/blob/master/docs/examples/packaging-zlib.md</li>
</ul>
<p>読んだ。</p>
<p><code>vcpkg create url</code> で雛形が作れる。</p>
<p>実験</p>
<pre class="code literal-block"><span></span>.<span class="se">\v</span>cpkg.exe create alembic https://github.com/alembic/alembic/archive/1.7.1.tar.gz
CMake Error at scripts/ports.cmake:101 <span class="o">(</span>message<span class="o">)</span>:
  Portfile already exists: <span class="s1">'D:\vcpkg\ports\alembic\portfile.cmake'</span>
</pre>

<p>すでにあるだと！？
最近できたらしい。</p>
<ul>
<li>https://github.com/Microsoft/vcpkg/tree/master/ports/alembic</li>
</ul>
<p>しかし、hdf非対応みたいなので作ってみる。</p>
<pre class="code literal-block"><span></span>.<span class="se">\v</span>cpkg.exe create alembic-hdf https://github.com/alembic/alembic/archive/1.7.1.tar.gz

VCPKG_DIR
    ports
        alembic-hdf
            CONTROL
            portfile.cmake
</pre>

<p>ができた。
簡単なCONTROLから。
こっちはパッケージ情報を決めるだけなのでさくっと。</p>
<pre class="code literal-block"><span></span>Source: alembic-hdf
Version: <span class="m">1</span>.7.1
Description: alembic with hdf5
Build-Depends: hdf5
</pre>

<p>本題のportfile.cmake。
そのままだとエラーになるの。最低限以下が必要なようだ。
アーカイブを展開パスの指定。</p>
<pre class="code literal-block"><span></span><span class="nb">set</span><span class="p">(</span><span class="s">SOURCE_PATH</span> <span class="o">${</span><span class="nv">CURRENT_BUILDTREES_DIR</span><span class="o">}</span><span class="s">/src/1.7.1</span><span class="p">)</span>

<span class="c"># ↓ 修正する</span>

<span class="nb">set</span><span class="p">(</span><span class="s">SOURCE_PATH</span> <span class="o">${</span><span class="nv">CURRENT_BUILDTREES_DIR</span><span class="o">}</span><span class="s">/src/alembic-1.7.1</span><span class="p">)</span>
</pre>

<p>実行してみる。</p>
<pre class="code literal-block"><span></span>&gt; ./vcpkg install alembic-hdf:x64-windows
The following packages will be built and installed:
    alembic-hdf:x64-windows
Building package alembic-hdf:x64-windows...
-- <span class="nv">CURRENT_INSTALLED_DIR</span><span class="o">=</span>D:/vcpkg/installed/x64-windows
-- <span class="nv">DOWNLOADS</span><span class="o">=</span>D:/vcpkg/downloads
-- <span class="nv">CURRENT_PACKAGES_DIR</span><span class="o">=</span>D:/vcpkg/packages/alembic-hdf_x64-windows
-- <span class="nv">CURRENT_BUILDTREES_DIR</span><span class="o">=</span>D:/vcpkg/buildtrees/alembic-hdf
-- <span class="nv">CURRENT_PORT_DIR</span><span class="o">=</span>D:/vcpkg/ports/alembic-hdf/.
-- Using cached D:/vcpkg/downloads/1.7.1.tar.gz
-- Testing integrity of cached file...
-- Testing integrity of cached file... OK
-- Extracting <span class="k">done</span>
-- Configuring x64-windows-rel
-- Configuring x64-windows-rel <span class="k">done</span>
-- Configuring x64-windows-dbg
PS D:<span class="se">\v</span>cpkg&gt; .<span class="se">\v</span>cpkg.exe install alembic-hdf:x64-windows
The following packages will be built and installed:
    alembic-hdf:x64-windows
Building package alembic-hdf:x64-windows...
-- <span class="nv">CURRENT_INSTALLED_DIR</span><span class="o">=</span>D:/vcpkg/installed/x64-windows
-- <span class="nv">DOWNLOADS</span><span class="o">=</span>D:/vcpkg/downloads
-- <span class="nv">CURRENT_PACKAGES_DIR</span><span class="o">=</span>D:/vcpkg/packages/alembic-hdf_x64-windows
-- <span class="nv">CURRENT_BUILDTREES_DIR</span><span class="o">=</span>D:/vcpkg/buildtrees/alembic-hdf
-- <span class="nv">CURRENT_PORT_DIR</span><span class="o">=</span>D:/vcpkg/ports/alembic-hdf/.
-- Using cached D:/vcpkg/downloads/1.7.1.tar.gz
-- Testing integrity of cached file...
-- Testing integrity of cached file... OK
-- Extracting <span class="k">done</span>
-- Configuring x64-windows-rel
-- Configuring x64-windows-rel <span class="k">done</span>
-- Configuring x64-windows-dbg
-- Configuring x64-windows-dbg <span class="k">done</span>
-- Package x64-windows-rel
-- Package x64-windows-rel <span class="k">done</span>
-- Package x64-windows-dbg
-- Package x64-windows-dbg <span class="k">done</span>
-- Performing post-build validation
Include files should not be duplicated into the /debug/include directory. If this cannot be disabled in the project cmake, use
    file<span class="o">(</span>REMOVE_RECURSE <span class="si">${</span><span class="nv">CURRENT_PACKAGES_DIR</span><span class="si">}</span>/debug/include<span class="o">)</span>
The /lib/cmake folder should be merged with /debug/lib/cmake and moved to /share/alembic-hdf/cmake.
The following cmake files were found outside /share/alembic-hdf. Please place cmake files in /share/alembic-hdf.

    D:/vcpkg/packages/alembic-hdf_x64-windows/lib/cmake/Alembic/AlembicConfig.cmake
    D:/vcpkg/packages/alembic-hdf_x64-windows/lib/cmake/Alembic/AlembicConfigVersion.cmake
    D:/vcpkg/packages/alembic-hdf_x64-windows/lib/cmake/Alembic/AlembicTargets-release.cmake
    D:/vcpkg/packages/alembic-hdf_x64-windows/lib/cmake/Alembic/AlembicTargets.cmake
    D:/vcpkg/packages/alembic-hdf_x64-windows/debug/lib/cmake/Alembic/AlembicConfig.cmake
    D:/vcpkg/packages/alembic-hdf_x64-windows/debug/lib/cmake/Alembic/AlembicConfigVersion.cmake
    D:/vcpkg/packages/alembic-hdf_x64-windows/debug/lib/cmake/Alembic/AlembicTargets-debug.cmake
    D:/vcpkg/packages/alembic-hdf_x64-windows/debug/lib/cmake/Alembic/AlembicTargets.cmake

The /debug/lib/cmake folder should be merged with /lib/cmake into /share/alembic-hdf

The following dlls were found in /lib or /debug/lib. Please move them to /bin or /debug/bin, respectively.

    D:/vcpkg/packages/alembic-hdf_x64-windows/lib/Alembic.dll


The following dlls were found in /lib or /debug/lib. Please move them to /bin or /debug/bin, respectively.

    D:/vcpkg/packages/alembic-hdf_x64-windows/debug/lib/Alembic.dll

The software license must be available at <span class="si">${</span><span class="nv">CURRENT_PACKAGES_DIR</span><span class="si">}</span>/share/alembic-hdf/copyright

    file<span class="o">(</span>COPY <span class="si">${</span><span class="nv">CURRENT_BUILDTREES_DIR</span><span class="si">}</span>/src/alembic-1.7.1/LICENSE.txt DESTINATION <span class="si">${</span><span class="nv">CURRENT_PACKAGES_DIR</span><span class="si">}</span>/share/alembic-hdf<span class="o">)</span>
    file<span class="o">(</span>RENAME <span class="si">${</span><span class="nv">CURRENT_PACKAGES_DIR</span><span class="si">}</span>/share/alembic-hdf/LICENSE.txt <span class="si">${</span><span class="nv">CURRENT_PACKAGES_DIR</span><span class="si">}</span>/share/alembic-hdf/copyright<span class="o">)</span>
The following EXEs were found in /bin or /debug/bin. EXEs are not valid distribution targets.

    D:/vcpkg/packages/alembic-hdf_x64-windows/bin/abcdiff.exe
    D:/vcpkg/packages/alembic-hdf_x64-windows/bin/abcecho.exe
    D:/vcpkg/packages/alembic-hdf_x64-windows/bin/abcechobounds.exe
    D:/vcpkg/packages/alembic-hdf_x64-windows/bin/abcls.exe
    D:/vcpkg/packages/alembic-hdf_x64-windows/bin/abcstitcher.exe
    D:/vcpkg/packages/alembic-hdf_x64-windows/bin/abctree.exe

The following EXEs were found in /bin or /debug/bin. EXEs are not valid distribution targets.

    D:/vcpkg/packages/alembic-hdf_x64-windows/debug/bin/abcdiff.exe
    D:/vcpkg/packages/alembic-hdf_x64-windows/debug/bin/abcecho.exe
    D:/vcpkg/packages/alembic-hdf_x64-windows/debug/bin/abcechobounds.exe
    D:/vcpkg/packages/alembic-hdf_x64-windows/debug/bin/abcls.exe
    D:/vcpkg/packages/alembic-hdf_x64-windows/debug/bin/abcstitcher.exe
    D:/vcpkg/packages/alembic-hdf_x64-windows/debug/bin/abctree.exe

Found <span class="m">9</span> error<span class="o">(</span>s<span class="o">)</span>. Please correct the portfile:
    D:<span class="se">\v</span>cpkg<span class="se">\p</span>orts<span class="se">\a</span>lembic-hdf<span class="se">\p</span>ortfile.cmake
-- Performing post-build validation <span class="k">done</span>
Error: Building package alembic-hdf:x64-windows failed with: POST_BUILD_CHECKS_FAILED
Please ensure you<span class="err">'</span>re using the latest portfiles with <span class="sb">`</span>.<span class="se">\v</span>cpkg update<span class="sb">`</span>, <span class="k">then</span>
submit an issue at https://github.com/Microsoft/vcpkg/issues including:
  Package: alembic-hdf:x64-windows
  Vcpkg version: <span class="m">0</span>.0.81-144d3718c4197b101c7d61ee6a258200371fb1ab

Additionally, attach any relevant sections from the log files above.
</pre>

<p>という感じになった。
エラーメッセージがすごく親切。
あと、NINJAビルド速い。
エラーにはなるがビルド結果は以下のように出力された。</p>
<pre class="code literal-block"><span></span>VCPKG_DIR/packages/alembic-hdf_x64-windows
│  BUILD_INFO
│
├─bin
│      abcdiff.exe
│      abcecho.exe
│      abcechobounds.exe
│      abcls.exe
│      abcstitcher.exe
│      abctree.exe
│
├─debug
│  ├─bin
│  │      abcdiff.exe
│  │      abcecho.exe
│  │      abcechobounds.exe
│  │      abcls.exe
│  │      abcstitcher.exe
│  │      abctree.exe
│  │
│  ├─include
│  │  └─Alembic
│  │      ├─Abc
│  │      │      *.h
│  │      │
│  │      ├─AbcCollection
│  │      │      *.h
│  │      │
│  │      ├─AbcCoreAbstract
│  │      │      *.h
│  │      │
│  │      ├─AbcCoreFactory
│  │      │      *.h
│  │      │
│  │      ├─AbcCoreLayer
│  │      │      *.h
│  │      │
│  │      ├─AbcCoreOgawa
│  │      │      *.h
│  │      │
│  │      ├─AbcGeom
│  │      │      *.h
│  │      │
│  │      ├─AbcMaterial
│  │      │      *.h
│  │      │
│  │      └─Util
│  │              *.h
│  │
│  └─lib
│      │  Alembic.dll
│      │  Alembic.lib
│      │
│      └─cmake
│          └─Alembic
│                  AlembicConfig.cmake
│                  AlembicConfigVersion.cmake
│                  AlembicTargets-debug.cmake
│                  AlembicTargets.cmake
│
├─include
│  └─Alembic
│      ├─Abc
│      │      *.h
│      │
│      ├─AbcCollection
│      │      *.h
│      │
│      ├─AbcCoreAbstract
│      │      *.h
│      │
│      ├─AbcCoreFactory
│      │      *.h
│      │
│      ├─AbcCoreLayer
│      │      *.h
│      │
│      ├─AbcCoreOgawa
│      │      *.h
│      │
│      ├─AbcGeom
│      │      *.h
│      │
│      ├─AbcMaterial
│      │      *.h
│      │
│      └─Util
│              *.h
│
└─lib
    │  Alembic.dll
    │  Alembic.lib
    │
    └─cmake
        └─Alembic
                AlembicConfig.cmake
                AlembicConfigVersion.cmake
                AlembicTargets-release.cmake
                AlembicTargets.cmake
</pre>

<p>ここから不要なものを削除したり、場所の違うものを移動したりすることで完成できそう。
エラーメッセージに沿って修正してみる</p>
<p><code>debug/include</code> 不要</p>
<p>エラーメッセージに含まれるとおりに。</p>
<pre class="code literal-block"><span></span><span class="nb">file</span><span class="p">(</span><span class="s">REMOVE_RECURSE</span> <span class="o">${</span><span class="nv">CURRENT_PACKAGES_DIR</span><span class="o">}</span><span class="s">/debug/include</span><span class="p">)</span>

<span class="err">lib/cmake/Alembic/*.cmakeをshare/alembic-hdfに移動するべし</span>
<span class="err">debug/lib/cmake/Alembicを統合するべし。</span>
<span class="nb">vcpkg_fixup_cmake_targets</span><span class="p">(</span><span class="s">CONFIG_PATH</span> <span class="s2">"lib/cmake/Alembic"</span><span class="p">)</span>
</pre>

<p>ぽい。 <code>alembic/portfile.cmake</code> を参考にした</p>
<pre class="code literal-block"><span></span><span class="err">lib/Alembic.dllをbin/Alembic.dllに移動せよ</span>
<span class="err">debug/lib/Alembic.dllも。</span>
<span class="nb">file</span><span class="p">(</span><span class="s">RENAME</span> <span class="o">${</span><span class="nv">CURRENT_PACKAGES_DIR</span><span class="o">}</span><span class="s">/lib/Alembic.dll</span> <span class="o">${</span><span class="nv">CURRENT_PACKAGES_DIR</span><span class="o">}</span><span class="s">/bin/Alembic.dll</span><span class="p">)</span>
<span class="nb">file</span><span class="p">(</span><span class="s">RENAME</span> <span class="o">${</span><span class="nv">CURRENT_PACKAGES_DIR</span><span class="o">}</span><span class="s">/debug/lib/Alembic.dll</span> <span class="o">${</span><span class="nv">CURRENT_PACKAGES_DIR</span><span class="o">}</span><span class="s">/debug/bin/Alembic.dll</span><span class="p">)</span>
</pre>

<p><code>alembic/portfile.cmake</code> を参考にした</p>
<p>ライセンスファイルをコピーせよ
エラーメッセージに含まれるとおりに。</p>
<pre class="code literal-block"><span></span><span class="nb">file</span><span class="p">(</span><span class="s">COPY</span> <span class="o">${</span><span class="nv">CURRENT_BUILDTREES_DIR</span><span class="o">}</span><span class="s">/src/alembic-1.7.1/LICENSE.txt</span> <span class="s">DESTINATION</span> <span class="o">${</span><span class="nv">CURRENT_PACKAGES_DIR</span><span class="o">}</span><span class="s">/share/alembic-hdf</span><span class="p">)</span>
<span class="nb">file</span><span class="p">(</span><span class="s">RENAME</span> <span class="o">${</span><span class="nv">CURRENT_PACKAGES_DIR</span><span class="o">}</span><span class="s">/share/alembic-hdf/LICENSE.txt</span> <span class="o">${</span><span class="nv">CURRENT_PACKAGES_DIR</span><span class="o">}</span><span class="s">/share/alembic-hdf/copyright</span><span class="p">)</span>
</pre>

<p>exeを削除せよ</p>
<pre class="code literal-block"><span></span><span class="nb">file</span><span class="p">(</span><span class="s">GLOB</span> <span class="s">EXE</span> <span class="o">${</span><span class="nv">CURRENT_PACKAGES_DIR</span><span class="o">}</span><span class="s">/bin/*.exe</span><span class="p">)</span>
<span class="nb">file</span><span class="p">(</span><span class="s">GLOB</span> <span class="s">DEBUG_EXE</span> <span class="o">${</span><span class="nv">CURRENT_PACKAGES_DIR</span><span class="o">}</span><span class="s">/debug/bin/*.exe</span><span class="p">)</span>
<span class="nb">file</span><span class="p">(</span><span class="s">REMOVE</span> <span class="o">${</span><span class="nv">EXE</span><span class="o">}</span><span class="p">)</span>
<span class="nb">file</span><span class="p">(</span><span class="s">REMOVE</span> <span class="o">${</span><span class="nv">DEBUG_EXE</span><span class="o">}</span><span class="p">)</span>
</pre>

<p>alembic/portfile.cmakeを参考にした
おまけ: debug用にpdbをコピー
alembic/portfile.cmakeを参考にした
vcpkg_copy_pdbs()</p>
<p>vcpkg_install_cmakeより下を抜粋。</p>
<pre class="code literal-block"><span></span><span class="nb">vcpkg_install_cmake</span><span class="p">()</span>

<span class="c"># Remove debug/include</span>
<span class="nb">file</span><span class="p">(</span><span class="s">REMOVE_RECURSE</span> <span class="o">${</span><span class="nv">CURRENT_PACKAGES_DIR</span><span class="o">}</span><span class="s">/debug/include</span><span class="p">)</span>
<span class="c"># fix *.cmake</span>
<span class="nb">vcpkg_fixup_cmake_targets</span><span class="p">(</span><span class="s">CONFIG_PATH</span> <span class="s2">"lib/cmake/Alembic"</span><span class="p">)</span>
<span class="c"># Rename dll</span>
<span class="nb">file</span><span class="p">(</span><span class="s">RENAME</span> <span class="o">${</span><span class="nv">CURRENT_PACKAGES_DIR</span><span class="o">}</span><span class="s">/lib/Alembic.dll</span> <span class="o">${</span><span class="nv">CURRENT_PACKAGES_DIR</span><span class="o">}</span><span class="s">/bin/Alembic.dll</span><span class="p">)</span>
<span class="nb">file</span><span class="p">(</span><span class="s">RENAME</span> <span class="o">${</span><span class="nv">CURRENT_PACKAGES_DIR</span><span class="o">}</span><span class="s">/debug/lib/Alembic.dll</span> <span class="o">${</span><span class="nv">CURRENT_PACKAGES_DIR</span><span class="o">}</span><span class="s">/debug/bin/Alembic.dll</span><span class="p">)</span>
<span class="c"># Handle copyright</span>
<span class="nb">file</span><span class="p">(</span><span class="s">COPY</span> <span class="o">${</span><span class="nv">CURRENT_BUILDTREES_DIR</span><span class="o">}</span><span class="s">/src/alembic-1.7.1/LICENSE.txt</span> <span class="s">DESTINATION</span> <span class="o">${</span><span class="nv">CURRENT_PACKAGES_DIR</span><span class="o">}</span><span class="s">/share/alembic-hdf</span><span class="p">)</span>
<span class="nb">file</span><span class="p">(</span><span class="s">RENAME</span> <span class="o">${</span><span class="nv">CURRENT_PACKAGES_DIR</span><span class="o">}</span><span class="s">/share/alembic-hdf/LICENSE.txt</span> <span class="o">${</span><span class="nv">CURRENT_PACKAGES_DIR</span><span class="o">}</span><span class="s">/share/alembic-hdf/copyright</span><span class="p">)</span>
<span class="c"># Remove exe files</span>
<span class="nb">file</span><span class="p">(</span><span class="s">GLOB</span> <span class="s">EXE</span> <span class="o">${</span><span class="nv">CURRENT_PACKAGES_DIR</span><span class="o">}</span><span class="s">/bin/*.exe</span><span class="p">)</span>
<span class="nb">file</span><span class="p">(</span><span class="s">GLOB</span> <span class="s">DEBUG_EXE</span> <span class="o">${</span><span class="nv">CURRENT_PACKAGES_DIR</span><span class="o">}</span><span class="s">/debug/bin/*.exe</span><span class="p">)</span>
<span class="nb">file</span><span class="p">(</span><span class="s">REMOVE</span> <span class="o">${</span><span class="nv">EXE</span><span class="o">}</span><span class="p">)</span>
<span class="nb">file</span><span class="p">(</span><span class="s">REMOVE</span> <span class="o">${</span><span class="nv">DEBUG_EXE</span><span class="o">}</span><span class="p">)</span>
<span class="c"># Copy pdb</span>
<span class="nb">vcpkg_copy_pdbs</span><span class="p">()</span>
</pre>

<p>再度ビルド。</p>
<p><code>&gt; vcpkg install alembic-hdf:x64-windows</code></p>
<p>うまくいった。
USE_HDF5を有効にする
portfileの修正
CONTROLに依存追加。
Build-Depends: ilmbase, hdf5</p>
<p>USE_HDF5を有効に。</p>
<pre class="code literal-block"><span></span><span class="nb">vcpkg_configure_cmake</span><span class="p">(</span>
    <span class="s">SOURCE_PATH</span> <span class="o">${</span><span class="nv">SOURCE_PATH</span><span class="o">}</span>
    <span class="s">PREFER_NINJA</span> <span class="c"># Disable this option if project cannot be built with Ninja</span>
    <span class="s">OPTIONS</span> <span class="s">-DUSE_HDF5=ON</span>
    <span class="c"># OPTIONS_RELEASE -DOPTIMIZE=1</span>
    <span class="c"># OPTIONS_DEBUG -DDEBUGGABLE=1</span>
<span class="p">)</span>
</pre>

<p>ビルドあんどエラー
ビルドしてみるがエラーになる。</p>
<p><code>VCPKG_DIR\buildtrees\alembic-hdf\package-x64-windows-rel-out.log</code> を見て原因を探る。</p>
<p>hdf5に対するlinkが無くて、hdf5関連のシンボルが見つからん。
パッチ
alembic-1.7.1/lib/Alembic/CMakeLists.txtを修正したいのでやり方を調べる。
パッチの当て方</p>
<p>portfile.cmakeに記述する。</p>
<pre class="code literal-block"><span></span><span class="err">vcpkg_extract_source_archiveよりあと、vcpkg_install_cmakeより前。</span>
<span class="nb">vcpkg_apply_patches</span><span class="p">(</span>
    <span class="s">SOURCE_PATH</span> <span class="o">${</span><span class="nv">SOURCE_PATH</span><span class="o">}</span>
    <span class="s">PATCHES</span> <span class="o">${</span><span class="nv">CMAKE_CURRENT_LIST_DIR</span><span class="o">}</span><span class="s">/fix-hdf5link.patch</span>
<span class="p">)</span>
</pre>

<p>パッチの作り方</p>
<p>https://github.com/Microsoft/vcpkg/blob/master/docs/examples/patching-libpng.md#patching-the-code-to-improve-compatibility</p>
<p>なるほど。
gitを準備して・・・</p>
<pre class="code literal-block"><span></span>vcpkg&gt; <span class="nb">cd</span> ./buildtrees/alembic-hdf/src/alembic-1.7.1/
vcpkg/buildtrees/alembic-hdf/src/alembic-1.7.1&gt; git init
vcpkg/buildtrees/alembic-hdf/src/alembic-1.7.1&gt; git add .
vcpkg/buildtrees/alembic-hdf/src/alembic-1.7.1&gt; git commit -m <span class="s2">"temp"</span>
</pre>

<p>修正
alembic-1.7.1/lib/Alembic/CMakeLists.txtを修正。</p>
<pre class="code literal-block"><span></span>&gt; git diff
<span class="gd">--git a/lib/Alembic/CMakeLists.txt b/lib/Alembic/CMakeLists.txt</span>
<span class="gh">index 5028c91..1f81d50 100644</span>
<span class="gd">--- a/lib/Alembic/CMakeLists.txt</span>
<span class="gi">+++ b/lib/Alembic/CMakeLists.txt</span>
<span class="gu">@@ -49,6 +49,12 @@ ADD_SUBDIRECTORY(AbcMaterial)</span>
 ADD_SUBDIRECTORY(Ogawa)

 ADD_LIBRARY(Alembic ${LIB_TYPE} ${CXX_FILES})
<span class="gi">+IF (USE_HDF5)</span>
<span class="gi">+    TARGET_LINK_LIBRARIES(Alembic</span>
<span class="gi">+        ${HDF5_LIBRARIES}</span>
<span class="gi">+        )</span>
<span class="gi">+    ADD_DEFINITIONS(-DH5_BUILT_AS_DYNAMIC_LIB)</span>
<span class="gi">+ENDIF()</span>

 TARGET_INCLUDE_DIRECTORIES(Alembic
     PUBLIC
</pre>

<p>gitでpatchを作成</p>
<p><code>&gt; git diff | out-file -enc ascii ..\..\..\..\ports\alembic-hdf\fix-hdf5link.patch</code></p>
<p>ビルド</p>
<pre class="code literal-block"><span></span>&gt; .<span class="se">\v</span>cpkg.exe install alembic-hdf:x64-windows
Installing package alembic-hdf:x64-windows... <span class="k">done</span>
</pre>

<p>VCPKG_DIR/installed/x64-windows/bin/Alembic.dllをdependencywalkerで見てみるとばっちりhdf5.dllへのリンクが含まれている。作業完了。
はじめてで調べながらでもわりとさくさく作業が進んだ。エラーメッセージの出し方とか、フォルダの構成とかvcpkgなかなかレベルが高いな。</p>
<pre class="code literal-block"><span></span>ports
ports/alembic-hdf/CONTROL
Source: alembic-hdf
Version: <span class="m">1</span>.7.1
Description: alembic with hdf5
Build-Depends: ilmbase, hdf5
</pre>

<p>```ports/alembic-hdf/portfile.cmake</p>
<h2>Common Ambient Variables:</h2>
<h2>CURRENT_BUILDTREES_DIR    = ${VCPKG_ROOT_DIR}\buildtrees\${PORT}</h2>
<h2>CURRENT_PACKAGES_DIR      = ${VCPKG_ROOT_DIR}\packages\${PORT}_${TARGET_TRIPLET}</h2>
<h2>CURRENT_PORT_DIR          = ${VCPKG_ROOT_DIR}\ports\${PORT}</h2>
<h2>PORT                      = current port name (zlib, etc)</h2>
<h2>TARGET_TRIPLET            = current triplet (x86-windows, x64-windows-static, etc)</h2>
<h2>VCPKG_CRT_LINKAGE         = C runtime linkage type (static, dynamic)</h2>
<h2>VCPKG_LIBRARY_LINKAGE     = target library linkage type (static, dynamic)</h2>
<h2>VCPKG_ROOT_DIR            = <c:></c:>
</h2>
<h2>VCPKG_TARGET_ARCHITECTURE = target architecture (x64, x86, arm)</h2>
<h2></h2>
<p>include(vcpkg_common_functions)
set(SOURCE_PATH ${CURRENT_BUILDTREES_DIR}/src/alembic-1.7.1)
vcpkg_download_distfile(ARCHIVE
    URLS "https://github.com/alembic/alembic/archive/1.7.1.tar.gz"
    FILENAME "1.7.1.tar.gz"
    SHA512 89e30b681a76eaf79b20ebeff62c495971b0eb64b28f249a14bbcf3bdb40df7eda93b0ede299dd5511bd4587a2cc2d4ebd851fb89bf999fdccc31fee3cffbba2
)
vcpkg_extract_source_archive(${ARCHIVE})</p>
<p>vcpkg_apply_patches(
    SOURCE_PATH ${SOURCE_PATH}
    PATCHES ${CMAKE_CURRENT_LIST_DIR}/fix-hdf5link.patch
)</p>
<p>vcpkg_configure_cmake(
    SOURCE_PATH ${SOURCE_PATH}
    PREFER_NINJA # Disable this option if project cannot be built with Ninja
    OPTIONS -DUSE_HDF5=ON
    # OPTIONS_RELEASE -DOPTIMIZE=1
    # OPTIONS_DEBUG -DDEBUGGABLE=1
)</p>
<p>vcpkg_install_cmake()</p>
<h2>Remove debug/include</h2>
<p>file(REMOVE_RECURSE ${CURRENT_PACKAGES_DIR}/debug/include)</p>
<h2>fix *.cmake</h2>
<p>vcpkg_fixup_cmake_targets(CONFIG_PATH "lib/cmake/Alembic")</p>
<h2>Rename dll</h2>
<p>file(RENAME ${CURRENT_PACKAGES_DIR}/lib/Alembic.dll ${CURRENT_PACKAGES_DIR}/bin/Alembic.dll)
file(RENAME ${CURRENT_PACKAGES_DIR}/debug/lib/Alembic.dll ${CURRENT_PACKAGES_DIR}/debug/bin/Alembic.dll)</p>
<h2>Handle copyright</h2>
<p>file(COPY ${CURRENT_BUILDTREES_DIR}/src/alembic-1.7.1/LICENSE.txt DESTINATION ${CURRENT_PACKAGES_DIR}/share/alembic-hdf)
file(RENAME ${CURRENT_PACKAGES_DIR}/share/alembic-hdf/LICENSE.txt ${CURRENT_PACKAGES_DIR}/share/alembic-hdf/copyright)</p>
<h2>Remove exe files</h2>
<p>file(GLOB EXE ${CURRENT_PACKAGES_DIR}/bin/<em>.exe)
file(GLOB DEBUG_EXE ${CURRENT_PACKAGES_DIR}/debug/bin/</em>.exe)
file(REMOVE ${EXE})
file(REMOVE ${DEBUG_EXE})</p>
<h2>Copy pdb</h2>
<p>vcpkg_copy_pdbs()</p>
<pre class="code literal-block"><span></span>```ports/alembic-hdf/fix-hdf5link.patch
diff --git a/lib/Alembic/CMakeLists.txt b/lib/Alembic/CMakeLists.txt
index 5028c91..1f81d50 100644
--- a/lib/Alembic/CMakeLists.txt
+++ b/lib/Alembic/CMakeLists.txt
@@ -49,6 +49,12 @@ ADD_SUBDIRECTORY(AbcMaterial)
 ADD_SUBDIRECTORY(Ogawa)

 ADD_LIBRARY(Alembic <span class="cp">${</span><span class="n">LIB_TYPE</span><span class="cp">}</span> <span class="cp">${</span><span class="n">CXX_FILES</span><span class="cp">}</span>)
+IF (USE_HDF5)
+    TARGET_LINK_LIBRARIES(Alembic 
+        <span class="cp">${</span><span class="n">HDF5_LIBRARIES</span><span class="cp">}</span>
+        )
+    ADD_DEFINITIONS(-DH5_BUILT_AS_DYNAMIC_LIB)
+ENDIF()

 TARGET_INCLUDE_DIRECTORIES(Alembic
     PUBLIC
</pre>

<p>vcpkgにPR送った
採用されたので上記の作業は必要なくなったのが、cmake-3.9.0の更新でFindHDF5が壊れるという事態が発生したので対応中…。</p>
</div>
                </div>
            </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/2017/07/hololens_cpp/" class="u-url">c++でHololens</a></h1>
                <div class="metadata">
                    <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                        ousttrue
                    </span></p>
            <p class="dateline">
            <a href="posts/2017/07/hololens_cpp/" rel="bookmark">
            <time class="published dt-published" datetime="2017-07-09T00:00:00Z" itemprop="datePublished" title="2017-07-09 00:00">2017-07-09 00:00</time></a>
            </p>
                        <p class="commentline">
        
    <a href="posts/2017/07/hololens_cpp/#disqus_thread" data-disqus-identifier="cache/content/posts/2017/07/hololens_cpp.html">コメント</a>


                </p>
</div>
            </header><div class="e-content entry-content">
                    <div>
<p>SharpDXでHololensが頓挫したので、C++でまいりましょう。</p>
<p>VisualStudio2015update3しかUnivsersal cpp HolographicApp templateが含まれないので githubにコピーしておいた。</p>
<p>https://github.com/ousttrue/HolographicApp</p>
<p>エミュレーターで描画が乱れる件</p>
<blockquote>
<blockquote>
<p>(tools)から</p>
</blockquote>
</blockquote>
<p>checkを外したらなおった。
実機
問題ない。
Hololens特有の部分
通常のDirectXとHolographicAppの違いを調べていたのだけれど、
両目レンダリングを効率よくするために、複数のレンダーターゲットに対して
まとめてパイプラインを実行する関連のようだ。
VPAndRTArrayIndexFromAnyShaderFeedingRasterizer
VPAndRTArrayIndexFromAnyShaderFeedingRasterizerないとき(エミュレーター)
// A constant buffer that stores the model transform.
cbuffer ModelConstantBuffer : register(b0)
{
    float4x4 model;
};</p>
<p>// A constant buffer that stores each set of view and projection matrices in column-major format.
cbuffer ViewProjectionConstantBuffer : register(b1)
{
    float4x4 viewProjection[2];
};</p>
<p>// Per-vertex data used as input to the vertex shader.
struct VertexShaderInput
{
    min16float3 pos     : POSITION;
    min16float3 color   : COLOR0;
    uint        instId  : SV_InstanceID;
};</p>
<p>// Per-vertex data passed to the geometry shader.
// Note that the render target array index will be set by the geometry shader
// using the value of viewId.
struct VertexShaderOutput
{
    min16float4 pos     : SV_POSITION;
    min16float3 color   : COLOR0;
    uint        viewId  : TEXCOORD0;  // SV_InstanceID % 2
};</p>
<p>// Simple shader to do vertex processing on the GPU.
VertexShaderOutput main(VertexShaderInput input)
{
    VertexShaderOutput output;
    float4 pos = float4(input.pos, 1.0f);</p>
<pre class="code literal-block"><span></span>// Note which view this vertex has been sent to. Used for matrix lookup.
// Taking the modulo of the instance ID allows geometry instancing to be used
// along with stereo instanced drawing; in that case, two copies of each 
// instance would be drawn, one for left and one for right.
int idx = input.instId % 2;

// Transform the vertex position into world space.
pos = mul(pos, model);

// Correct for perspective and project the vertex position onto the screen.
pos = mul(pos, viewProjection[idx]);
output.pos = (min16float4)pos;

// Pass the color through without modification.
output.color = input.color;

// Set the instance ID. The pass-through geometry shader will set the
// render target array index to whatever value is set here.
output.viewId = idx;

return output;
</pre>

<p>}</p>
<p>// Per-vertex data from the vertex shader.
struct GeometryShaderInput
{
    min16float4 pos     : SV_POSITION;
    min16float3 color   : COLOR0;
    uint        instId  : TEXCOORD0;
};</p>
<p>// Per-vertex data passed to the rasterizer.
struct GeometryShaderOutput
{
    min16float4 pos     : SV_POSITION;
    min16float3 color   : COLOR0;
    uint        rtvId   : SV_RenderTargetArrayIndex; // &lt;- RTVテクスチャアレイのindex
};</p>
<p>// This geometry shader is a pass-through that leaves the geometry unmodified 
// and sets the render target array index.
[maxvertexcount(3)]
void main(triangle GeometryShaderInput input[3], inout TriangleStream<geometryshaderoutput> outStream)
{
    GeometryShaderOutput output;
    [unroll(3)]
    for (int i = 0; i &lt; 3; ++i)
    {
        output.pos   = input[i].pos;
        output.color = input[i].color;
        output.rtvId = input[i].instId;
        outStream.Append(output);
    }
}</geometryshaderoutput></p>
<p>VPAndRTArrayIndexFromAnyShaderFeedingRasterizerあるとき
// A constant buffer that stores the model transform.
cbuffer ModelConstantBuffer : register(b0)
{
    float4x4 model;
};</p>
<p>// A constant buffer that stores each set of view and projection matrices in column-major format.
cbuffer ViewProjectionConstantBuffer : register(b1)
{
    float4x4 viewProjection[2];
};</p>
<p>// Per-vertex data used as input to the vertex shader.
struct VertexShaderInput
{
    min16float3 pos     : POSITION;
    min16float3 color   : COLOR0;
    uint        instId  : SV_InstanceID;
};</p>
<p>// Per-vertex data passed to the geometry shader.
// Note that the render target array index is set here in the vertex shader.
struct VertexShaderOutput
{
    min16float4 pos     : SV_POSITION;
    min16float3 color   : COLOR0;
    uint        rtvId   : SV_RenderTargetArrayIndex; // SV_InstanceID % 2 // &lt;- RTVテクスチャアレイのindex
};</p>
<p>// Simple shader to do vertex processing on the GPU.
VertexShaderOutput main(VertexShaderInput input)
{
    VertexShaderOutput output;
    float4 pos = float4(input.pos, 1.0f);</p>
<pre class="code literal-block"><span></span>// Note which view this vertex has been sent to. Used for matrix lookup.
// Taking the modulo of the instance ID allows geometry instancing to be used
// along with stereo instanced drawing; in that case, two copies of each 
// instance would be drawn, one for left and one for right.
int idx = input.instId % 2;

// Transform the vertex position into world space.
pos = mul(pos, model);

// Correct for perspective and project the vertex position onto the screen.
pos = mul(pos, viewProjection[idx]);
output.pos = (min16float4)pos;

// Pass the color through without modification.
output.color = input.color;

// Set the render target array index.
output.rtvId = idx;

return output;
</pre>

<p>}</p>
<p>どう違うのか
見比べてみたところ、
VPAndRTArrayIndexFromAnyShaderFeedingRasterizer=trueの場合
VertexShaderでSV_RenderTargetArrayIndexを使うことが可能で、
そうでない場合はVertexShaderで使うことができないがGeometryShaderでSV_RenderTargetArrayIndexを使うことが可能ということらしい。
デバッガで確認したところ、実機・エミュレーター共に
backbufferはD3D11_TEXTURE2D_DESC.ArraySize=2となっていた。</p>
<p>https://developer.microsoft.com/en-us/windows/mixed-reality/rendering_in_directx#important_note_about_rendering_on_non-hololens_devices</p>
<p>実機ではVPAndRTArrayIndexFromAnyShaderFeedingRasterizer=true、エミュレーターでfalseでgometryshader版になることがわかった。
SV_RenderTargetArrayIndex</p>
<p>VRのためのステレオレンダリングを高速化するアイデア</p>
<p>なんとなくわかってきた。</p>
<p>ジオメトリシェーダを使用した複数画面描画</p>
<p>SV_ViewportArrayIndexというのもあるらしい。
なるほどー。</p>
<p>セマンティクス (DirectX HLSL)</p>
<p>まとめ
D3D11専用のレンダラを作ってみる。
HololensとUWP兼用のプロジェクトにできそうな気がする。
Hololensの初期化に失敗したら通常のUWPにフォールバックすればよいのではないか。
HoloApp
    Backbuffer
    CameraUpdate
    Input
        |
        v
    +----------+
    |SceneGraph|
    |Renderer  |
    +----------+
        ^
        |
    Input
    CameraUpdate
    Backbuffer
UwpApp</p>
<p>こんな感じのプロジェクトを模索してみよう。</p>
</div>
                </div>
            </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/2017/07/hololens_sharpdx/" class="u-url">SharpDXでHololens</a></h1>
                <div class="metadata">
                    <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                        ousttrue
                    </span></p>
            <p class="dateline">
            <a href="posts/2017/07/hololens_sharpdx/" rel="bookmark">
            <time class="published dt-published" datetime="2017-07-05T00:00:00Z" itemprop="datePublished" title="2017-07-05 00:00">2017-07-05 00:00</time></a>
            </p>
                        <p class="commentline">
        
    <a href="posts/2017/07/hololens_sharpdx/#disqus_thread" data-disqus-identifier="cache/content/posts/2017/07/hololens_sharpdx.html">コメント</a>


                </p>
</div>
            </header><div class="e-content entry-content">
                    <div>
<p>SharpDXでHololensできないかやってみる。</p>
<p>頓挫した。
VisualStudioのHolographicAppテンプレートをSharpDXに移植できないかやってみる。
C# Universal 空白のテンプレートで始める
以前書いたUWPでSharpDXを見てSharpDXの最低限を作成。
C++ Universal D3D11のテンプレートを移植する
とりあえず練習に素の”uwp directx11 template”を移植してみた。
これは、D2DのFPSテキストが何も描画されないことを除いて動いた。
C++ HolographicApp DirectXのテンプレートを移植する
途中まで移植したのだが以下の部分でクラッシュして、 エラーコード0xc0000409が解決できなくなってしまった。
// Starts the holographic frame and updates the content.
public Windows.Graphics.Holographic.HolographicFrame Update()
{
    // Before doing the timer update, there is some work to do per-frame
    // to maintain holographic rendering. First, we will get information
    // about the current frame.</p>
<pre class="code literal-block"><span></span>// The HolographicFrame has information that the app needs in order
// to update and render the current frame. The app begins each new
// frame by calling CreateNextFrame.
var holographicFrame = m_holographicSpace.CreateNextFrame(); // &lt;-- クラッシュする

// 省略
</pre>

<p>}</p>
<p>作業は頓挫した。</p>
</div>
                </div>
            </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/2017/07/cmake_2017/" class="u-url">vcpkgでopencvの開発環境を作る</a></h1>
                <div class="metadata">
                    <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                        ousttrue
                    </span></p>
            <p class="dateline">
            <a href="posts/2017/07/cmake_2017/" rel="bookmark">
            <time class="published dt-published" datetime="2017-07-01T00:00:00Z" itemprop="datePublished" title="2017-07-01 00:00">2017-07-01 00:00</time></a>
            </p>
                        <p class="commentline">
        
    <a href="posts/2017/07/cmake_2017/#disqus_thread" data-disqus-identifier="cache/content/posts/2017/07/cmake_2017.html">コメント</a>


                </p>
</div>
            </header><div class="e-content entry-content">
                    <div>
<p>Windowsでcmakeを使う場合に外部ライブラリの解決がわりと困難。</p>
<p>cmakeのfind_packageがうまくうごかないのである。Unix系であれば <code>CMAKE_INSTALL_PREFIX(/usr/local)</code> にインストールされた依存プロジェクトを発見できるし、足りなければインストールすることもできる。それに、<code>apt-get</code> とか <code>pacman</code> とかあるので、自分で全部ビルドするということはあまり必要なかったりする今日この頃です。Windowsにはそういうのがなかった(CMAKE_INSTALL_PREFIXはどこなのか)のだけど、最近出てきたvcpkgがそれをやってくれる。</p>
<p>ArUcoをvcpkgとcmakeでビルドする
ということでvcpkgで外部ライブラリを構築し、一部をソースごとプロジェクトにコピーする方法でArUco(OpenCV)のビルドをやってみる。ArUcoのデバッグ版にアタッチしたり改造したりするつもりなので、opencvのモジュール版ArUcoではなく単体の方を使う。環境は、Windows10(64bit)にVisualStudio2017(C++)。
vcpkgを準備</p>
<ul>
<li>https://github.com/Microsoft/vcpkg</li>
</ul>
<pre class="code literal-block"><span></span>&gt; git clone https://github.com/Microsoft/vcpkg.git
&gt; <span class="nb">cd</span> vcpkg
vcpkg&gt; .<span class="se">\b</span>ootstrap-vcpkg.bat

vcpkgで64bit版のopencvをインストール
vcpkg&gt; .<span class="se">\v</span>cpkg.exe install opencv:x64-windows

vcpkg/installed/x64-windowsにinclude, lib, bin等がインストールされる。
vcpkgで64bit版のfreeglutをインストール
vcpkg&gt; .<span class="se">\v</span>cpkg.exe install freeglut:x64-windows
</pre>

<p>arucoのソースを入手
OpenCVのモジュール</p>
<p>http://docs.opencv.org/trunk/d9/d6d/tutorial_table_of_content_aruco.html</p>
<p>ではなくてこっち。</p>
<p>http://www.uco.es/investiga/grupos/ava/node/26
https://sourceforge.net/projects/aruco/files/</p>
<p>aruco-2.0.19.zipを手に入れた。
とりあえずビルドしてみる
vcpkgはd:/vcpkgにインストールされている。</p>
<pre class="code literal-block"><span></span>aruco-2.0.19&gt; mkdir build
aruco-2.0.19/build&gt; cmake -D <span class="nv">CMAKE_INSTALL_PREFIX</span><span class="o">=</span>d:/vcpkg/installed/x64-windows -D <span class="nv">OpenCVDir</span><span class="o">=</span>d:/vcpkg/installed/x64-windows/share/opencv -D <span class="nv">BUILD_GLSAMPLES</span><span class="o">=</span><span class="m">1</span> -G <span class="s2">"Visual Studio 15 2017 Win64"</span> ..
</pre>

<p>aruco_test_glとaruco_test_markermap_glのビルドでエラーが出るのでちょっとコードを修正する。
gl.hより先にWindows.hをincludeしてあげる。</p>
<pre class="code literal-block"><span></span><span class="cp">#ifdef __APPLE__</span>
<span class="cp">#include</span> <span class="cpf">&lt;GLUT/glut.h&gt;</span><span class="cp"></span>

<span class="cp">#elif defined(_MSC_VER)</span>
<span class="cp">#include</span> <span class="cpf">&lt;Windows.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;GL/glut.h&gt;</span><span class="cp"></span>

<span class="cp">#else</span>
<span class="cp">#include</span> <span class="cpf">&lt;GL/gl.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;GL/glut.h&gt;</span><span class="cp"></span>
<span class="cp">#endif</span>
</pre>

<p>あとfreeglutのリンクををdebug, release振り分けのために、
CMakeLists.txtをちょっと改造。だいたいこういう感じ。</p>
<pre class="code literal-block"><span></span><span class="nb">IF</span> <span class="p">(</span><span class="s">GLUT_FOUND</span><span class="p">)</span>
    <span class="nb">STRING</span><span class="p">(</span><span class="s">REPLACE</span> <span class="s">lib/freeglut.lib</span> <span class="s">debug/lib/freeglutd.lib</span> <span class="s">GLUT_glut_DEBUG_LIBRARY</span> <span class="o">${</span><span class="nv">GLUT_glut_LIBRARY</span><span class="o">}</span><span class="p">)</span>
    <span class="nb">MESSAGE</span><span class="p">(</span><span class="s">STATUS</span> <span class="s2">"GLUT_glut_DEBUG_LIBRARY=${GLUT_glut_DEBUG_LIBRARY}"</span><span class="p">)</span>
    <span class="nb">set</span> <span class="p">(</span><span class="s">OPENGL_LIBS</span>  <span class="s">general</span>
        <span class="o">${</span><span class="nv">OPENGL_gl_LIBRARY</span><span class="o">}</span>
        <span class="o">${</span><span class="nv">OPENGL_glu_LIBRARY</span><span class="o">}</span>
        <span class="s">optimized</span> <span class="o">${</span><span class="nv">GLUT_glut_LIBRARY</span><span class="o">}</span>
        <span class="s">debug</span> <span class="o">${</span><span class="nv">GLUT_glut_DEBUG_LIBRARY</span><span class="o">}</span>
        <span class="p">)</span>
<span class="nb">ENDIF</span><span class="p">()</span>
</pre>

<p>この部分と連携する。
TARGET_LINK_LIBRARIES(aruco_test_gl ${OPENGL_LIBS})</p>
<p>これで、CMAKE_INSTALL_PREFIX/binにパスを通せばプログラムは動作する。
arucoのテストデータを入手してwebcamで動作確認
テストデータを入手する。</p>
<p>https://sourceforge.net/projects/aruco/files/</p>
<p>aruco-test-data-2.0.zipを手に入れた。
この中のintrinsics.ymlを引数にして実行する(本来は、カメラキャリブレーションをしてintrinsics.ymlを自分のカメラ用に作成する必要がある)。
aruco_test_gl.exe "live" "path_to_intrinsics.yml" 0.05
aruco_test_glとarucoの入った小さいプロジェクト
ArUcoを改造する予定。</p>
<p>intrinsics.ymlを省略したり簡略化したい(fovyとaspectratioだけにするなど)
左手系(DirectXやUnity)に対応</p>
<p>ということで、arucoのソースを含めている。</p>
<pre class="code literal-block"><span></span>aruco_test

  + CMakeLists.txt

  + aruco_test_gl
    + CMakeLists.txt
    + aruco_test_gl.cpp<span class="o">(</span>aruco-2.0.19/utils_gl/aruco_test_gl.cppをコピー<span class="o">)</span>

  + src<span class="o">(</span>aruco-2.0.19/srcをコピー<span class="o">)</span>
</pre>

<pre class="code literal-block"><span></span><span class="nb">CMAKE_MINIMUM_REQUIRED</span><span class="p">(</span><span class="s">VERSION</span> <span class="s">2.8</span><span class="p">)</span>
<span class="nb">PROJECT</span><span class="p">(</span><span class="s">aruco</span><span class="p">)</span>

<span class="nb">FIND_PACKAGE</span><span class="p">(</span><span class="s">OpenCV</span> <span class="s">REQUIRED</span> <span class="p">)</span>
<span class="nb">SET</span> <span class="p">(</span><span class="s">ARUCO_REQUIRED_LIBRARIES</span> <span class="o">${</span><span class="nv">OpenCV_LIBS</span><span class="o">}</span><span class="p">)</span>
<span class="nb">INCLUDE_DIRECTORIES</span><span class="p">(</span><span class="o">${</span><span class="nv">OpenCV_INCLUDE_DIRS</span><span class="o">}</span><span class="p">)</span>

<span class="nb">FIND_PACKAGE</span><span class="p">(</span><span class="s">OpenGL</span> <span class="s">REQUIRED</span><span class="p">)</span>

<span class="nb">FIND_PACKAGE</span><span class="p">(</span><span class="s">GLUT</span><span class="p">)</span>
<span class="nb">MESSAGE</span><span class="p">(</span><span class="s">STATUS</span> <span class="s2">"GLUT_glut_LIBRARY=${GLUT_glut_LIBRARY}"</span><span class="p">)</span>
<span class="nb">STRING</span><span class="p">(</span><span class="s">REPLACE</span> <span class="s">lib/freeglut.lib</span> <span class="s">debug/lib/freeglutd.lib</span> <span class="s">GLUT_glut_DEBUG_LIBRARY</span> <span class="o">${</span><span class="nv">GLUT_glut_LIBRARY</span><span class="o">}</span><span class="p">)</span>
<span class="nb">MESSAGE</span><span class="p">(</span><span class="s">STATUS</span> <span class="s2">"GLUT_glut_DEBUG_LIBRARY=${GLUT_glut_DEBUG_LIBRARY}"</span><span class="p">)</span>
<span class="nb">IF</span> <span class="p">(</span><span class="s">GLUT_FOUND</span><span class="p">)</span>
    <span class="nb">set</span> <span class="p">(</span><span class="s">OPENGL_LIBS</span>  <span class="s">general</span>
        <span class="o">${</span><span class="nv">OPENGL_gl_LIBRARY</span><span class="o">}</span>
        <span class="o">${</span><span class="nv">OPENGL_glu_LIBRARY</span><span class="o">}</span>
        <span class="s">optimized</span> <span class="o">${</span><span class="nv">GLUT_glut_LIBRARY</span><span class="o">}</span>
        <span class="s">debug</span> <span class="o">${</span><span class="nv">GLUT_glut_DEBUG_LIBRARY</span><span class="o">}</span>
        <span class="p">)</span>
<span class="nb">ENDIF</span><span class="p">()</span>

<span class="nb">ADD_DEFINITIONS</span><span class="p">(</span><span class="s">-D_SCL_SECURE_NO_WARNINGS</span><span class="p">)</span>
<span class="nb">SET</span><span class="p">(</span><span class="s">CMAKE_CXX_FLAGS</span> <span class="s2">"/wd4819 /EHsc"</span><span class="p">)</span>

<span class="nb">ADD_SUBDIRECTORY</span><span class="p">(</span><span class="s">src</span><span class="p">)</span>
<span class="nb">ADD_SUBDIRECTORY</span><span class="p">(</span><span class="s">utils_gl</span><span class="p">)</span>

<span class="err">aruco_test_gl/CMakeLists.txt</span>
<span class="nb">INCLUDE_DIRECTORIES</span><span class="p">(</span><span class="o">${</span><span class="nv">PROJECT_SOURCE_DIR</span><span class="o">}</span><span class="s">/src</span> <span class="o">${</span><span class="nv">GNULIBS_INCLUDE_DIR</span><span class="o">}</span><span class="p">)</span>
<span class="nb">LINK_LIBRARIES</span><span class="p">(</span><span class="o">${</span><span class="nv">PROJECT_NAME</span><span class="o">}</span> <span class="o">${</span><span class="nv">REQUIRED_LIBRARIES</span><span class="o">}</span> <span class="p">)</span>

<span class="nb">IF</span><span class="p">(</span><span class="s">OPENGL_LIBS</span><span class="p">)</span>
    <span class="nb">ADD_EXECUTABLE</span><span class="p">(</span><span class="s">aruco_test_gl</span>
        <span class="s">aruco_test_gl.cpp</span>
        <span class="p">)</span>
    <span class="nb">TARGET_LINK_LIBRARIES</span><span class="p">(</span><span class="s">aruco_test_gl</span> <span class="o">${</span><span class="nv">OPENGL_LIBS</span><span class="o">}</span><span class="p">)</span>
</pre>

<p>以上で、arucoを例にvcpkgでopencvとfreeglutdを外部管理してcmakeでプロジェクトを取り廻す例を作った。
作業例。</p>
<p>https://github.com/ousttrue/aruco_test</p>
</div>
                </div>
            </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/2017/06/ts_module/" class="u-url">Typescriptのモジュールでまたはまる</a></h1>
                <div class="metadata">
                    <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                        ousttrue
                    </span></p>
            <p class="dateline">
            <a href="posts/2017/06/ts_module/" rel="bookmark">
            <time class="published dt-published" datetime="2017-06-14T00:00:00Z" itemprop="datePublished" title="2017-06-14 00:00">2017-06-14 00:00</time></a>
            </p>
                        <p class="commentline">
        
    <a href="posts/2017/06/ts_module/#disqus_thread" data-disqus-identifier="cache/content/posts/2017/06/ts_module.html">コメント</a>


                </p>
</div>
            </header><div class="e-content entry-content">
                    <div>
<p>Typescriptで出力したjsのimort周りではまったので実験してみる。</p>
<p>export + import from</p>
</div>
                </div>
            </article>
</div>
    
        <ul class="pager postindexpager clearfix">
<li class="previous"><a href="index-13.html" rel="prev">新しい記事</a></li>
            <li class="next"><a href="index-11.html" rel="next">過去の記事</a></li>
        </ul>
<script>var disqus_shortname="nikolademo";(function(){var a=document.createElement("script");a.async=true;a.src="https://"+disqus_shortname+".disqus.com/count.js";(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(a)}());</script><!--End of body content--><footer id="footer">
            Contents © 2021         <a href="mailto:ousttrue@gmail.com">ousttrue</a> - Powered by         <a href="https://getnikola.com" rel="nofollow">Nikola</a>         
            
            
        </footer>
</div>
</div>


        <script src="assets/js/all-nocdn.js"></script><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element){var i=element.getElementsByTagName('img')[0];return i===undefined?'':i.alt;}});
    </script>
</body>
</html>
