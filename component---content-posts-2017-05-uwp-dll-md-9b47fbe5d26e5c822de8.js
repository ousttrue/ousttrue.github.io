"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[4912],{683:function(n,e,t){t.r(e);var o=t(1151),i=t(7294);function c(n){const e=Object.assign({pre:"pre",code:"code"},(0,o.ah)(),n.components);return i.createElement(e.pre,null,i.createElement(e.code,null,"UWPでNativeのDLLを使うとどんな感じなのか試してみた。\n\nhttps://github.com/ousttrue/UwpNativeDllSample\n\nCMakeのCache機構のせいで挙動を勘違いした部分を書き直し。\n\n自前でビルドしたlibpng.dllでpngを表示するサンプル。\nデスクトップアプリとの違い\n\ndllのロードパスがカレントディレクトリと環境変数PATHに記述された場所ではなく、projectのトップレベルのみ\nデスクトップと公開されているAPIに差異がある\nprojectが違う。x86 vxprojとuwp32 vcxprojのdiffの抜粋。\n\n>     <ApplicationType>Windows Store</ApplicationType>^M\n>     <DefaultLanguage>en-US</DefaultLanguage>^M\n>     <ApplicationTypeRevision>10.0</ApplicationTypeRevision>^M\n>     <MinimumVisualStudioVersion>14.0</MinimumVisualStudioVersion>^M\n>     <AppContainerApplication>true</AppContainerApplication>^M\n\n\nzlib-1.2.11を無修正でビルドできた。\nlibpng-1.6.29は_ExitProcessにリンクする段階でエラーになった\n\n修正方法が書いてあった。\n\nhttps://github.com/Microsoft/vcpkg/blob/master/docs/example-3-patch-libpng.md\n\nUWP向けビルドオプション/zw\n無くても動いた。UWP固有のAPIにアクセスするときもしくはC++/CXに必要？\n\nhttps://msdn.microsoft.com/ja-jp/library/hh561383.aspx\n\ncmakeでWindowsStore向けのprojectを生成する\nMicrosoft版のcmakeなら作れる。\nVS2017にも含まれていて以下のパスにあった。\nC:\\Program Files (x86)\\Microsoft Visual Studio\\2017\\Community\\Common7\\IDE\\CommonExtensions\\Microsoft\\CMake\\CMake\\bin\\cmake.exe\n本家のcmakeでもできるかもしれないが未確認。\nプロジェクトを生成するときに以下のオプションを指定する。\n\n-DCMAKE_SYSTEM_NAME=WindowsStore\n-DCMAKE_SYSTEM_VERSION=10.0\n\nこれだけだとCMAKE_SYSTEM_PROCESSORが空になってlibpngではエラーになる。追加で下記のオプションも指定した。\n\n-DCMAKE_SYSTEM_PROCESSOR=x86\n\nほかに/zwの指定など。\n\n-DCMAKE_C_FLAGS=/ZW /EHsc /DWIN32=1\n-DCMAKE_CXX_FLAGS=/ZW /EHsc /DWIN32=1\n\n例\nzlib-1.2.11/build> cmake.exe .. -G Visual Studio 15 2017 -DCMAKE_SYSTEM_PROCESSOR=x86 -DCMAKE_SYSTEM_NAME=WindowsStore -DCMAKE_SYSTEM_VERSION=10.0 -DCMAKE_C_FLAGS=/ZW /EHsc /DWIN32=1 -DCMAKE_CXX_FLAGS=/ZW /EHsc /DWIN32=1\n\nC#からDllImport\nDesktopの時と記述方法は同じ。dllの配置場所は上記の通りprojectに放り込むだけ。\nデスクトップ向けにビルドしたdllは動くのか\n動いた。\n逆にUWP向けにビルドしたdllはデスクトップで動くのか\n動かなかった。ソース互換はある程度あるがバイナリ互換は無い。\n{\"DLL 'libpng16' を読み込めません:この操作はアプリ コンテナーのコンテキストでのみ有効です。 (HRESULT からの例外:0x8007109A)\"}\n\nこのエラーがデスクトップでuwpのdllを呼び出したとき固有のエラーメッセージぽい。\nまとめ\nCMakeの場合はプロジェクト生成オプションさえわかれば、 デスクトップとそれほど使い勝手は変わらない。この煩雑な手順を記録しておくべく自動ビルドツール作成中。\n\nhttps://github.com/ousttrue/bldproc\n"))}e.default=function(n){void 0===n&&(n={});const{wrapper:e}=Object.assign({},(0,o.ah)(),n.components);return e?i.createElement(e,n,i.createElement(c,n)):c(n)}},1151:function(n,e,t){t.d(e,{ah:function(){return c}});var o=t(7294);const i=o.createContext({});function c(n){const e=o.useContext(i);return o.useMemo((()=>"function"==typeof n?n(e):{...e,...n}),[e,n])}}}]);
//# sourceMappingURL=component---content-posts-2017-05-uwp-dll-md-9b47fbe5d26e5c822de8.js.map