<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="generator" content="Nikola (getnikola.com)">
<meta name="viewport" content="width=device-width">
<script src="../../../assets/js/all-nocdn.js"></script><title>vim で LSP | 三次元日誌</title>
<link href="../../../assets/css/code.css" rel="stylesheet" type="text/css">
<link href="../../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
</head>
<body>
    <h1 id="brand">
        <a href="../../../" title="三次元日誌" rel="home">
            <span id="blog-title">三次元日誌</span>
        </a>
    </h1>

    <nav id="menu"><ul>
<li><a href="../../../archive.html">Archives</a></li>
<li><a href="../../../categories/index.html">Tags</a></li>
<li><a href="../../../rss.xml">RSS feed</a></li>
<li><a href="../../../about">About</a></li>
<li><a href="../../../books">MemoBooks</a></li>

            
            
            
        </ul></nav><hr>
<main id="content"><h1 class="p-name entry-title" itemprop="headline name">
    <h1 class="p-name entry-title" itemprop="headline name">
    <a href="." class="u-url">vim で LSP
    </a>
</h1>
<ul itemprop="keywords" class="tags">
<li>
        <time datetime="2019-04-19T16:32:35+09:00" title="2019-04-19">2019-04-19</time>
</li>
</ul>
</h1>

<div>
<h3>vim lsp client</h3>
<p>vimのlspクライアント。</p>
<h4>vim-lsp</h4>
<ul>
<li>https://github.com/prabirshrestha/vim-lsp</li>
</ul>
<h5>vim-lsp解読</h5>
<p>plugin/lsp.vim</p>
<pre class="code literal-block"><span></span><span class="k">if</span> <span class="k">g</span>:lsp_auto_enable
    augroup lsp_auto_enable
        autocmd<span class="p">!</span>
        autocmd <span class="nb">VimEnter</span> * <span class="k">call</span> <span class="nb">lsp</span>#enable<span class="p">()</span>
    augroup END
<span class="k">endif</span>
</pre>

<p>autoload/lsp.vim</p>
<pre class="code literal-block"><span></span><span class="k">function</span><span class="p">!</span> <span class="nb">lsp</span>#enable<span class="p">()</span> abort
    <span class="k">call</span> s:register_events<span class="p">()</span>
<span class="k">endfunction</span>

<span class="k">function</span><span class="p">!</span> s:register_events<span class="p">()</span> abort
    <span class="k">call</span> s:on_text_document_did_open<span class="p">()</span>
<span class="k">endfunction</span>

<span class="k">function</span><span class="p">!</span> s:on_text_document_did_open<span class="p">()</span> abort
<span class="k">endfunction</span>

<span class="c">" lspサーバの初期化をするぽい</span>
<span class="c">" server_nameは 'pyls'など</span>
<span class="k">function</span><span class="p">!</span> s:ensure_flush<span class="p">(</span><span class="k">buf</span><span class="p">,</span> server_name<span class="p">,</span> <span class="k">cb</span><span class="p">)</span> abort
<span class="k">endfunction</span>

<span class="c">" lspサーバープロセスを起動して、stdin, stdout, stderrを接続する</span>
<span class="k">function</span><span class="p">!</span> s:lsp_start<span class="p">(</span>opts<span class="p">)</span> abort

    <span class="k">let</span> <span class="k">l</span>:lsp_id <span class="p">=</span> <span class="nb">lsp</span>#client#<span class="k">start</span><span class="p">(</span>{
        \ <span class="s1">'cmd'</span>: <span class="k">l</span>:cmd<span class="p">,</span>
        \ <span class="s1">'on_stderr'</span>: <span class="k">function</span><span class="p">(</span><span class="s1">'s:on_stderr'</span><span class="p">,</span> [<span class="k">a</span>:server_name]<span class="p">),</span>
        \ <span class="s1">'on_exit'</span>: <span class="k">function</span><span class="p">(</span><span class="s1">'s:on_exit'</span><span class="p">,</span> [<span class="k">a</span>:server_name]<span class="p">),</span>
        \ <span class="s1">'on_notification'</span>: <span class="k">function</span><span class="p">(</span><span class="s1">'s:on_notification'</span><span class="p">,</span> [<span class="k">a</span>:server_name]<span class="p">),</span>
        \ <span class="s1">'on_request'</span>: <span class="k">function</span><span class="p">(</span><span class="s1">'s:on_request'</span><span class="p">,</span> [<span class="k">a</span>:server_name]<span class="p">),</span>
        \ }<span class="p">)</span>

<span class="k">endfunction</span>
</pre>

<p><code>autoload/lsp/client.vim</code></p>
<pre class="code literal-block"><span></span><span class="k">function</span><span class="p">!</span> s:lsp_start<span class="p">(</span>opts<span class="p">)</span> abort
<span class="c">    " async.vim ライブラリに移る</span>
    <span class="k">let</span> <span class="k">l</span>:client_id <span class="p">=</span> async#job#<span class="k">start</span><span class="p">(</span><span class="k">a</span>:opts.cmd<span class="p">,</span> {
        \ <span class="s1">'on_stdout'</span>: <span class="k">function</span><span class="p">(</span><span class="s1">'s:on_stdout'</span><span class="p">),</span>
        \ <span class="s1">'on_stderr'</span>: <span class="k">function</span><span class="p">(</span><span class="s1">'s:on_stderr'</span><span class="p">),</span>
        \ <span class="s1">'on_exit'</span>: <span class="k">function</span><span class="p">(</span><span class="s1">'s:on_exit'</span><span class="p">),</span>
        \ }<span class="p">)</span>
<span class="k">endfunction</span>

<span class="c">" stdout を on_notification と on_request に切り出す</span>
<span class="k">function</span><span class="p">!</span> s:on_stdout<span class="p">(</span>id<span class="p">,</span> data<span class="p">,</span> <span class="nb">event</span><span class="p">)</span> abort
<span class="k">endfunction</span>
</pre>

<ul>
<li>https://github.com/prabirshrestha/async.vim</li>
</ul>
<p><code>autoload/async/job.vim</code> ファイル一個だけだった。</p>
<p><code>vim</code> と <code>nvim</code> の違いをラップしているぽい。</p>
<p><code>vim</code> の <code>job_start</code> と <code>nvim</code> の <code>jobstart</code>。
なるほど。</p>
<h5>vim-lspの動きを追う(dls)</h5>
<p><a href="https://github.com/d-language-server/dls">dls</a> だと</p>
<p>ServerCapabilities </p>
<p>に</p>
<p>definitionProvider</p>
<p>が入ってないな・・・</p>
<p>Requestにそもそも入っていないのでは</p>
<p>入れてみた。</p>
<pre class="code literal-block"><span></span>        autocmd <span class="nb">User</span> lsp_setup <span class="k">call</span> <span class="nb">lsp</span>#register_server<span class="p">(</span>{
                    \ <span class="s1">'name'</span>: <span class="s1">'d'</span><span class="p">,</span>
                    \ <span class="s1">'cmd'</span>: {server_info<span class="p">-&gt;</span>[<span class="s1">'root_dls'</span>]}<span class="p">,</span>
<span class="c">                    "\ 'cmd': {server_info-&gt;['dub', 'run', '-q', 'serve-d']},</span>
                    \ <span class="s1">'root_uri'</span>: {server_info<span class="p">-&gt;</span><span class="nb">lsp</span>#utils#path_to_uri<span class="p">(</span><span class="nb">lsp</span>#utils#find_nearest_parent_file_directory<span class="p">(</span><span class="nb">lsp</span>#utils#get_buffer_path<span class="p">(),</span> <span class="s1">'dub.json'</span><span class="p">))</span>}<span class="p">,</span>
                    \ <span class="s1">'whitelist'</span>: [<span class="s1">'d'</span>]<span class="p">,</span>
                    \ <span class="s1">'capabilities'</span>: {
                    \   <span class="s1">'workspace'</span>: {
                    \       <span class="s1">'applyEdit'</span>: <span class="k">v</span>:true
                    \   }<span class="p">,</span>
                    \   <span class="s1">'textDocument'</span>: { <span class="c">" これ</span>
                    \       <span class="s1">'definition'</span>: {
                    \         <span class="s1">'dynamicRegistration'</span>: <span class="k">v</span>:true
                    \     }
                    \   }
                    \ }
                    \ }<span class="p">)</span>
</pre>

<p>実際に通信するようになた。</p>
<pre class="code literal-block"><span></span><span class="p">[</span><span class="s2">"---&gt;"</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">"d"</span><span class="p">,</span> <span class="p">{</span><span class="nt">"method"</span><span class="p">:</span> <span class="s2">"textDocument/definition"</span><span class="p">,</span> <span class="nt">"on_notification"</span><span class="p">:</span> <span class="s2">"---funcref---"</span><span class="p">,</span> <span class="nt">"params"</span><span class="p">:</span> <span class="p">{</span><span class="nt">"textDocument"</span><span class="p">:</span> <span class="p">{</span><span class="nt">"uri"</span><span class="p">:</span> <span class="s2">"file:///home/ousttrue/work/d_hello/source/app.d"</span><span class="p">},</span> <span class="nt">"position"</span><span class="p">:</span> <span class="p">{</span><span class="nt">"character"</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="nt">"line"</span><span class="p">:</span> <span class="mi">14</span><span class="p">}}}]</span>
</pre>

<pre class="code literal-block"><span></span><span class="p">[</span><span class="s2">"&lt;---"</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">"d"</span><span class="p">,</span> <span class="p">{</span><span class="nt">"response"</span><span class="p">:</span> <span class="p">{</span><span class="nt">"id"</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span> <span class="nt">"jsonrpc"</span><span class="p">:</span> <span class="s2">"2.0"</span><span class="p">,</span> <span class="nt">"result"</span><span class="p">:</span> <span class="p">[]},</span> <span class="nt">"request"</span><span class="p">:</span> <span class="p">{</span><span class="nt">"id"</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span> <span class="nt">"jsonrpc"</span><span class="p">:</span> <span class="s2">"2.0"</span><span class="p">,</span> <span class="nt">"method"</span><span class="p">:</span> <span class="s2">"textDocument/definition"</span><span class="p">,</span> <span class="nt">"params"</span><span class="p">:</span> <span class="p">{</span><span class="nt">"textDocument"</span><span class="p">:</span> <span class="p">{</span><span class="nt">"uri"</span><span class="p">:</span> <span class="s2">"file:///home/ousttrue/work/d_hello/source/app.d"</span><span class="p">},</span> <span class="nt">"position"</span><span class="p">:</span> <span class="p">{</span><span class="nt">"character"</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="nt">"line"</span><span class="p">:</span> <span class="mi">14</span><span class="p">}}}}]</span>
</pre>

<p>エラーが <code>Definition not found</code> に変わって
確かに、 <code>result</code> の中身が空っぽなので <code>not found</code> とサーバーが応答している。</p>
<p>問題が <code>vim-lsp</code> から <code>dls</code> に移った。</p>
<h4>ale</h4>
<ul>
<li>https://github.com/w0rp/ale</li>
</ul>
<h4>LanguageClient</h4>
<ul>
<li>https://github.com/autozimu/LanguageClient-neovim</li>
</ul>
<p>一部が <code>rust</code> で実装されているぽい。</p>
<h4>vim-lsp</h4>
<ul>
<li>https://www.kieranbamforth.me/blog/vim-lsp.html</li>
</ul>
<h4>built-in</h4>
<p>まだ、実装中？</p>
<h3>Language Server Protocol</h3>
<ul>
<li>https://microsoft.github.io/language-server-protocol/specification</li>
</ul>
<p><code>version 3.x</code></p>
<p>https://github.com/Microsoft/language-server-protocol/blob/master/versions/protocol-2-x.md</p>
<h4>通信シーケンス</h4>
<h5><code>&lt;-- request1 initialize</code></h5>
<h5><code>--&gt; response1</code></h5>
<h5><code>&lt;-- notify initialized</code></h5>
<h5><code>&lt;-- notify textDocument/didOpen</code></h5>
<pre class="code literal-block"><span></span>autocmd <span class="nb">FileType</span> * <span class="k">call</span> wf#<span class="nb">lsp</span>#setFileType<span class="p">()</span>
</pre>

<h5><code>&lt;-- notify textDocument/didChange</code></h5>
<h5><code>--&gt; notify textDocument/publishDiagnostics</code></h5>
<h5><code>&lt;-- request2 textDocument/documentHighlight</code></h5>
<h5><code>--&gt; response2</code></h5>
<h3>log viewer</h3>
<ul>
<li>
<p>https://github.com/Microsoft/language-server-protocol-inspector</p>
<ul>
<li>https://microsoft.github.io/language-server-protocol/inspector/</li>
</ul>
</li>
<li>
<p><a href="https://qiita.com/Rockdoor/items/f5dca558bbc843d8f334">VSCode 用 SystemVerilogの拡張を作る（#7）</a></p>
</li>
<li>
<p>VSCodeでlsp を実行させて通信ログを出力</p>
</li>
<li>通信ログを見やすく表示</li>
</ul>
<p>しかし、どうやってログを作るかよくわからん。
<code>vim-lsp</code> のログを改造して作ってみる。</p>
<h3>各言語のサーバー</h3>
<p>試してみたやつ。</p>
<h4>python</h4>
<h5>pyls</h5>
<p>Linux, Windows 共に動いた。</p>
<h4>dlang</h4>
<h5>serve-d</h5>
<p>うまくいかなかったので、調べている・・・</p>
<h5>dls</h5>
<p>うまくいかなかったので、調べている・・・</p>
<h4>c++</h4>
<p>Linuxで動いた。</p>
<h5>cquery</h5>
</div>

<hr>
<ul class="pager hidden-print">
<li class="previous">
        <a href="../../../github/workspacefolder/" rel="prev" title="WorkspaceFolder">
            WorkspaceFolder 👈
        </a>
    </li>
    <li style="flex-grow: 1">
    <li class="next">
        <a href="../../../qiita/zui-jin-nounicodedecodeerror/" rel="next" title="最近のUnicodeDecodeError">
            👉 最近のUnicodeDecodeError
        </a>
    </li>
</ul></main><footer id="footer"><p>
            Powered by
            <a href="https://getnikola.com" rel="nofollow">Nikola</a>
        </p>
    </footer>
</body>
</html>
