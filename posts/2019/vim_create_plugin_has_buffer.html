
<!DOCTYPE html>

<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>BufferList読んでみる &#8212; 三次元日誌  ドキュメント</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/translations.js"></script>
    <link rel="index" title="索引" href="../../genindex.html" />
    <link rel="search" title="検索" href="../../search.html" /> 
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />
 
<link
  rel="alternate"
  type="application/atom+xml"
  href="../../blog/atom.xml"
  title="三次元日誌(ablog)"
/>
 
<style type="text/css">
  ul.ablog-archive {
    list-style: none;
    overflow: auto;
    margin-left: 0px;
  }
  ul.ablog-archive li {
    float: left;
    margin-right: 5px;
    font-size: 80%;
  }
  ul.postlist a {
    font-style: italic;
  }
  ul.postlist-style-disc {
    list-style-type: disc;
  }
  ul.postlist-style-none {
    list-style-type: none;
  }
  ul.postlist-style-circle {
    list-style-type: circle;
  }
</style>

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
             <p>独自のバッファを持つpluginを作りたい</p>
<section id="bufferlist">
<h1>BufferList読んでみる<a class="headerlink" href="#bufferlist" title="このヘッドラインへのパーマリンク">¶</a></h1>
<ul class="simple">
<li><p>https://github.com/vim-scripts/bufferlist.vim/blob/master/plugin/bufferlist.vim</p></li>
</ul>
<p>273行</p>
<p>この量なら読める。</p>
<section id="id1">
<h2>インクルードガード<a class="headerlink" href="#id1" title="このヘッドラインへのパーマリンク">¶</a></h2>
<div class="highlight-vim notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> exists<span class="p">(</span><span class="s1">&#39;g:BufferListLoaded&#39;</span><span class="p">)</span>
  <span class="k">finish</span>
<span class="k">endif</span>
<span class="k">let</span> <span class="k">g</span>:BufferListLoaded <span class="p">=</span> <span class="m">1</span>
</pre></div>
</div>
</section>
<section id="id2">
<h2>初期値決め<a class="headerlink" href="#id2" title="このヘッドラインへのパーマリンク">¶</a></h2>
<div class="highlight-vim notranslate"><div class="highlight"><pre><span></span><span class="c">&quot; vimrcで先に値を決められるようにしている？</span>
<span class="c">&quot; vimrc より plugin の方が後に実行されるからか？</span>
<span class="k">if</span> <span class="p">!</span>exists<span class="p">(</span><span class="s1">&#39;g:BufferListWidth&#39;</span><span class="p">)</span>
  <span class="k">let</span> <span class="k">g</span>:BufferListWidth <span class="p">=</span> <span class="m">20</span>
<span class="k">endif</span>

<span class="k">if</span> <span class="p">!</span>exists<span class="p">(</span><span class="s1">&#39;g:BufferListMaxWidth&#39;</span><span class="p">)</span>
  <span class="k">let</span> <span class="k">g</span>:BufferListMaxWidth <span class="p">=</span> <span class="m">40</span>
<span class="k">endif</span>
</pre></div>
</div>
</section>
<section id="id3">
<h2>BufferList関数<a class="headerlink" href="#id3" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">__BUFFERLIST__</span></code> という Buffer を専用のバッファとして扱う。</p>
<div class="highlight-vim notranslate"><div class="highlight"><pre><span></span><span class="c">&quot; toggled the buffer list on/off</span>
<span class="k">function</span><span class="p">!</span> BufferList<span class="p">()</span>
<span class="c">  &quot; if we get called and the list is open --&gt; close it</span>
  <span class="k">if</span> bufexists<span class="p">(</span>bufnr<span class="p">(</span><span class="s2">&quot;__BUFFERLIST__&quot;</span><span class="p">))</span>
<span class="c">    &quot; 既に開いていたら閉じる</span>
    exec <span class="s1">&#39;:&#39;</span> . bufnr<span class="p">(</span><span class="s2">&quot;__BUFFERLIST__&quot;</span><span class="p">)</span> . <span class="s1">&#39;bwipeout&#39;</span>
    <span class="k">return</span>
  <span class="k">endif</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">bufnr</span></code> でバッファ名からバッファ番号を得て、<code class="docutils literal notranslate"><span class="pre">bufexists</span></code> で存在を確認する。
<code class="docutils literal notranslate"><span class="pre">bufnr</span></code> には特別な名前を指定出来て以下のような効果があるようだ。</p>
<div class="highlight-vim notranslate"><div class="highlight"><pre><span></span>  <span class="k">let</span> <span class="k">l</span>:bufcount <span class="p">=</span> bufnr<span class="p">(</span><span class="s1">&#39;$&#39;</span><span class="p">)</span>
  <span class="k">let</span> <span class="k">l</span>:activebuf <span class="p">=</span> bufnr<span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
</pre></div>
</div>
<section id="id4">
<h3>バッファを作る<a class="headerlink" href="#id4" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>作ったバッファがアクティブになり、以降の操作対象になる。</p>
<div class="highlight-vim notranslate"><div class="highlight"><pre><span></span><span class="c">  &quot; now, create the buffer &amp; set it up</span>
  exec <span class="s1">&#39;silent! &#39;</span> . <span class="k">l</span>:width . <span class="s1">&#39;vne __BUFFERLIST__&#39;</span>
</pre></div>
</div>
</section>
<section id="id5">
<h3>色決め<a class="headerlink" href="#id5" title="このヘッドラインへのパーマリンク">¶</a></h3>
<div class="highlight-vim notranslate"><div class="highlight"><pre><span></span><span class="c">  &quot; set up syntax highlighting</span>
  <span class="k">if</span> has<span class="p">(</span><span class="s2">&quot;syntax&quot;</span><span class="p">)</span>
    <span class="k">syn</span> clear
    <span class="k">syn</span> <span class="k">match</span> BufferNormal <span class="sr">/  .*/</span>
    <span class="k">syn</span> <span class="k">match</span> BufferSelected <span class="sr">/&gt; .*/</span>hs<span class="p">=</span>s<span class="p">+</span><span class="m">1</span>
    <span class="k">hi</span> <span class="nb">def</span> BufferNormal ctermfg<span class="p">=</span>black ctermbg<span class="p">=</span>white
    <span class="k">hi</span> <span class="nb">def</span> BufferSelected ctermfg<span class="p">=</span>white ctermbg<span class="p">=</span>black
  <span class="k">endif</span>
</pre></div>
</div>
</section>
<section id="buffer">
<h3>Buffer構築<a class="headerlink" href="#buffer" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">setlocal</span> <span class="pre">nomodifiable</span></code> で編集不可に</p>
<div class="highlight-vim notranslate"><div class="highlight"><pre><span></span>  <span class="k">setlocal</span> <span class="nb">modifiable</span>
  <span class="k">if</span> <span class="k">l</span>:displayedbufs <span class="p">&gt;</span> <span class="m">0</span>
<span class="c">    &quot; input the buffer list, delete the trailing newline, &amp; fill with blank lines</span>
    <span class="k">put</span><span class="p">!</span> <span class="p">=</span><span class="k">l</span>:buflist
<span class="c">    &quot; is there any way to NOT delete into a register? bummer...</span>
<span class="c">    &quot;norm Gdd$</span>
    norm GkJ
    <span class="k">while</span> <span class="nb">winheight</span><span class="p">(</span><span class="m">0</span><span class="p">)</span> <span class="p">&gt;</span> line<span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
      <span class="k">put</span> <span class="p">=</span><span class="k">l</span>:fill
    <span class="k">endwhile</span>
  <span class="k">else</span>
    <span class="k">let</span> <span class="k">l</span>:<span class="k">i</span> <span class="p">=</span> <span class="m">0</span> <span class="p">|</span> <span class="k">while</span> <span class="k">l</span>:<span class="k">i</span> <span class="p">&lt;</span> <span class="nb">winheight</span><span class="p">(</span><span class="m">0</span><span class="p">)</span> <span class="p">|</span> <span class="k">let</span> <span class="k">l</span>:<span class="k">i</span> <span class="p">=</span> <span class="k">l</span>:<span class="k">i</span> <span class="p">+</span> <span class="m">1</span>
      <span class="k">put</span><span class="p">!</span> <span class="p">=</span><span class="k">l</span>:fill
    <span class="k">endwhile</span>
    norm <span class="m">0</span>
  <span class="k">endif</span>
  <span class="k">setlocal</span> <span class="nb">nomodifiable</span>
</pre></div>
</div>
</section>
<section id="id6">
<h3>操作を設定<a class="headerlink" href="#id6" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>バッファローカルに <code class="docutils literal notranslate"><span class="pre">map</span></code> を設定する。
<code class="docutils literal notranslate"><span class="pre">map</span></code> がキーボード・マウス入力へのコールバック設定になっているのか。なるほど。</p>
<div class="highlight-vim notranslate"><div class="highlight"><pre><span></span><span class="c">  &quot; set up the keymap</span>
  <span class="nb">noremap</span> <span class="p">&lt;</span><span class="k">silent</span><span class="p">&gt;</span> <span class="p">&lt;</span>buffer<span class="p">&gt;</span> <span class="p">&lt;</span>CR<span class="p">&gt;</span> :<span class="k">call</span> LoadBuffer<span class="p">()&lt;</span>CR<span class="p">&gt;</span>
  map <span class="p">&lt;</span><span class="k">silent</span><span class="p">&gt;</span> <span class="p">&lt;</span>buffer<span class="p">&gt;</span> <span class="k">q</span> :<span class="k">bwipeout</span><span class="p">&lt;</span>CR<span class="p">&gt;</span> 
  map <span class="p">&lt;</span><span class="k">silent</span><span class="p">&gt;</span> <span class="p">&lt;</span>buffer<span class="p">&gt;</span> <span class="k">j</span> :<span class="k">call</span> BufferListMove<span class="p">(</span><span class="s2">&quot;down&quot;</span><span class="p">)&lt;</span>CR<span class="p">&gt;</span>
  map <span class="p">&lt;</span><span class="k">silent</span><span class="p">&gt;</span> <span class="p">&lt;</span>buffer<span class="p">&gt;</span> <span class="k">k</span> :<span class="k">call</span> BufferListMove<span class="p">(</span><span class="s2">&quot;up&quot;</span><span class="p">)&lt;</span>CR<span class="p">&gt;</span>
  map <span class="p">&lt;</span><span class="k">silent</span><span class="p">&gt;</span> <span class="p">&lt;</span>buffer<span class="p">&gt;</span> <span class="k">d</span> :<span class="k">call</span> BufferListDeleteBuffer<span class="p">()&lt;</span>CR<span class="p">&gt;</span>
  map <span class="p">&lt;</span><span class="k">silent</span><span class="p">&gt;</span> <span class="p">&lt;</span>buffer<span class="p">&gt;</span> <span class="p">&lt;</span>MouseDown<span class="p">&gt;</span> :<span class="k">call</span> BufferListMove<span class="p">(</span><span class="s2">&quot;up&quot;</span><span class="p">)&lt;</span>CR<span class="p">&gt;</span>
  map <span class="p">&lt;</span><span class="k">silent</span><span class="p">&gt;</span> <span class="p">&lt;</span>buffer<span class="p">&gt;</span> <span class="p">&lt;</span>MouseUp<span class="p">&gt;</span> :<span class="k">call</span> BufferListMove<span class="p">(</span><span class="s2">&quot;down&quot;</span><span class="p">)&lt;</span>CR<span class="p">&gt;</span>
  map <span class="p">&lt;</span><span class="k">silent</span><span class="p">&gt;</span> <span class="p">&lt;</span>buffer<span class="p">&gt;</span> <span class="p">&lt;</span>LeftDrag<span class="p">&gt;</span> <span class="p">&lt;</span>Nop<span class="p">&gt;</span>
  map <span class="p">&lt;</span><span class="k">silent</span><span class="p">&gt;</span> <span class="p">&lt;</span>buffer<span class="p">&gt;</span> <span class="p">&lt;</span>LeftRelease<span class="p">&gt;</span> :<span class="k">call</span> BufferListMove<span class="p">(</span><span class="s2">&quot;mouse&quot;</span><span class="p">)&lt;</span>CR<span class="p">&gt;</span>
  map <span class="p">&lt;</span><span class="k">silent</span><span class="p">&gt;</span> <span class="p">&lt;</span>buffer<span class="p">&gt;</span> <span class="p">&lt;</span><span class="m">2</span><span class="p">-</span>LeftMouse<span class="p">&gt;</span> :<span class="k">call</span> BufferListMove<span class="p">(</span><span class="s2">&quot;mouse&quot;</span><span class="p">)&lt;</span>CR<span class="p">&gt;</span>
    \:<span class="k">call</span> LoadBuffer<span class="p">()&lt;</span>CR<span class="p">&gt;</span>
  map <span class="p">&lt;</span><span class="k">silent</span><span class="p">&gt;</span> <span class="p">&lt;</span>buffer<span class="p">&gt;</span> <span class="p">&lt;</span>Down<span class="p">&gt;</span> <span class="k">j</span>
  map <span class="p">&lt;</span><span class="k">silent</span><span class="p">&gt;</span> <span class="p">&lt;</span>buffer<span class="p">&gt;</span> <span class="p">&lt;</span>Up<span class="p">&gt;</span> <span class="k">k</span>
</pre></div>
</div>
<p>左右への動きを封じてある</p>
<div class="highlight-vim notranslate"><div class="highlight"><pre><span></span>  map <span class="p">&lt;</span>buffer<span class="p">&gt;</span> <span class="k">h</span> <span class="p">&lt;</span>Nop<span class="p">&gt;</span>
  map <span class="p">&lt;</span>buffer<span class="p">&gt;</span> <span class="k">l</span> <span class="p">&lt;</span>Nop<span class="p">&gt;</span>
  map <span class="p">&lt;</span>buffer<span class="p">&gt;</span> <span class="p">&lt;</span>Left<span class="p">&gt;</span> <span class="p">&lt;</span>Nop<span class="p">&gt;</span>
  map <span class="p">&lt;</span>buffer<span class="p">&gt;</span> <span class="p">&lt;</span>Right<span class="p">&gt;</span> <span class="p">&lt;</span>Nop<span class="p">&gt;</span>
</pre></div>
</div>
<p>その他編集系の機能を封じる</p>
<div class="highlight-vim notranslate"><div class="highlight"><pre><span></span>  map <span class="p">&lt;</span>buffer<span class="p">&gt;</span> <span class="k">i</span> <span class="p">&lt;</span>Nop<span class="p">&gt;</span>
  map <span class="p">&lt;</span>buffer<span class="p">&gt;</span> <span class="k">a</span> <span class="p">&lt;</span>Nop<span class="p">&gt;</span>
  map <span class="p">&lt;</span>buffer<span class="p">&gt;</span> I <span class="p">&lt;</span>Nop<span class="p">&gt;</span>
  map <span class="p">&lt;</span>buffer<span class="p">&gt;</span> A <span class="p">&lt;</span>Nop<span class="p">&gt;</span>
  map <span class="p">&lt;</span>buffer<span class="p">&gt;</span> <span class="k">o</span> <span class="p">&lt;</span>Nop<span class="p">&gt;</span>
  map <span class="p">&lt;</span>buffer<span class="p">&gt;</span> O <span class="p">&lt;</span>Nop<span class="p">&gt;</span>
</pre></div>
</div>
<p>移動</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="nb">map</span> <span class="o">&lt;</span><span class="n">silent</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="n">buffer</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="n">Home</span><span class="o">&gt;</span> <span class="p">:</span><span class="n">call</span> <span class="n">BufferListMove</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">&lt;</span><span class="n">CR</span><span class="o">&gt;</span>
  <span class="nb">map</span> <span class="o">&lt;</span><span class="n">silent</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="n">buffer</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="n">End</span><span class="o">&gt;</span> <span class="p">:</span><span class="n">call</span> <span class="n">BufferListMove</span><span class="p">(</span><span class="n">line</span><span class="p">(</span><span class="s2">&quot;$&quot;</span><span class="p">))</span><span class="o">&lt;</span><span class="n">CR</span><span class="o">&gt;</span>
</pre></div>
</div>
</section>
</section>
</section>
<section id="id7">
<h1>情報収集<a class="headerlink" href="#id7" title="このヘッドラインへのパーマリンク">¶</a></h1>
<p><code class="docutils literal notranslate"><span class="pre">:set</span> <span class="pre">nomodifiable</span></code> で調べてみた</p>
<ul class="simple">
<li><p>http://tyru.hatenablog.com/entry/20101107/modifiable_and_readonly</p></li>
<li><p>https://vimconf.org/2018/slides/Effective_Modern_Vim_scripting_at_vimconf2018_for_PDF.pdf</p></li>
<li><p>https://vi.stackexchange.com/questions/17140/how-to-create-a-buffer-like-a-fugitive-temporary-buffer</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">:set</span> <span class="pre">buftype=nofile</span></code> が出てきた</p>
<ul class="simple">
<li><p><a class="reference external" href="http://leafcage.hateblo.jp/entry/2013/11/21/083830">'nobuflisted' なバッファの作り方</a></p></li>
<li><p>https://vi.stackexchange.com/questions/14832/how-to-create-a-buffer-with-customized-behavior-how-to-create-a-buffer-that-a</p></li>
<li><p>http://learnvimscriptthehardway.stevelosh.com/</p></li>
</ul>
</section>
<section id="nerdtree">
<h1>NERDTree解読<a class="headerlink" href="#nerdtree" title="このヘッドラインへのパーマリンク">¶</a></h1>
<section id="split">
<h2>左側にどうやって <code class="docutils literal notranslate"><span class="pre">split</span></code> して開くのか<a class="headerlink" href="#split" title="このヘッドラインへのパーマリンク">¶</a></h2>
</section>
<section id="id8">
<h2>ファイルを選択して開くとき開き先をどうやって決めるのか<a class="headerlink" href="#id8" title="このヘッドラインへのパーマリンク">¶</a></h2>
</section>
</section>
<section id="python">
<h1>pythonに移植できんやろか<a class="headerlink" href="#python" title="このヘッドラインへのパーマリンク">¶</a></h1>
<p>つまり、Pythonでvimから見える関数を定義できれば勝つるのでは。</p>
<ul class="simple">
<li><p>http://candidtim.github.io/vim/2017/08/11/write-vim-plugin-in-python.html</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">vim.eval</span></code> とかあるな・・・。いけるのでは？</p>
<p>慣れたら全部 <code class="docutils literal notranslate"><span class="pre">vim</span> <span class="pre">script</span></code> で書くようになりそうだけど、練習に移植してみよか。</p>
<p>nvimで、</p>
<p><code class="docutils literal notranslate"><span class="pre">:py3</span> <span class="pre">import</span> <span class="pre">sys;</span> <span class="pre">print(sys.version)</span></code></p>
<p>としたら</p>
<p><code class="docutils literal notranslate"><span class="pre">3.6.8</span> <span class="pre">(tags/v3.6.8:3c6b436a57,</span> <span class="pre">Dec</span> <span class="pre">23</span> <span class="pre">2018,</span> <span class="pre">23:31:17)</span> <span class="pre">[MSC</span> <span class="pre">v.1916</span> <span class="pre">32</span> <span class="pre">bit</span> <span class="pre">(Intel)]</span></code></p>
<p>と返ってきた。なるほど。</p>
<ul class="simple">
<li><p>[Pythonでvim pluginを書く https://qiita.com/zakuro9715/items/98449dd4c6b9e1d61ef5]</p></li>
</ul>
</section>

<div class="section">
   
</div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">三次元日誌</a></h1>








<h3>ナビゲーション</h3>


<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">クイック検索</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="検索" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2021, ousttrue.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 4.3.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../../_sources/posts/2019/vim_create_plugin_has_buffer.md.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>