<!DOCTYPE html><html lang="ja"><head><link rel="icon" type="image/svg+xml" href="/favicon.svg"><!-- Global Metadata --><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="generator" content="Astro v3.4.3"><!-- Font preloads --><link rel="preload" href="/fonts/atkinson-regular.woff" as="font" type="font/woff" crossorigin><link rel="preload" href="/fonts/atkinson-bold.woff" as="font" type="font/woff" crossorigin><!-- Canonical URL --><link rel="canonical" href="https://ousttrue.github.io/posts/2020/w3m-mod/"><!-- Primary Meta Tags --><title></title><meta name="title"><!-- Open Graph / Facebook --><meta property="og:type" content="website"><meta property="og:url" content="https://ousttrue.github.io/posts/2020/w3m-mod/"><meta property="og:title"><!-- Twitter --><meta property="twitter:card" content="summary_large_image"><meta property="twitter:url" content="https://ousttrue.github.io/posts/2020/w3m-mod/"><meta property="twitter:title"><style>:root{--accent: #2337ff;--accent-dark: #000d8a;--black: 15, 18, 25;--gray: 96, 115, 159;--gray-light: 229, 233, 240;--gray-dark: 34, 41, 57;--gray-gradient: rgba(var(--gray-light), 50%), #fff;--box-shadow: 0 2px 6px rgba(var(--gray), 25%), 0 8px 24px rgba(var(--gray), 33%), 0 16px 32px rgba(var(--gray), 33%)}@font-face{font-family:Atkinson;src:url(/fonts/atkinson-regular.woff) format("woff");font-weight:400;font-style:normal;font-display:swap}@font-face{font-family:Atkinson;src:url(/fonts/atkinson-bold.woff) format("woff");font-weight:700;font-style:normal;font-display:swap}body{font-family:Atkinson,sans-serif;margin:0;padding:0;text-align:left;background:linear-gradient(var(--gray-gradient)) no-repeat;background-size:100% 600px;word-wrap:break-word;overflow-wrap:break-word;color:rgb(var(--gray-dark));font-size:20px;line-height:1.7}main{width:720px;max-width:calc(100% - 2em);margin:auto;padding:3em 1em}h1,h2,h3,h4,h5,h6{margin:0 0 .5rem;color:rgb(var(--black));line-height:1.2}h1{font-size:2em}h2{font-size:1.8em}h3{font-size:1.6em}h4{font-size:1.4em}h5{font-size:1.2em}strong,b{font-weight:700}a,a:hover{color:var(--accent)}p{margin-bottom:1em}.prose p{margin-bottom:2em}textarea{width:100%;font-size:16px}input{font-size:16px}table{width:100%}img{max-width:100%;height:auto;border-radius:8px}code{padding:2px 5px;background-color:rgb(var(--gray-light));border-radius:2px}pre{padding:1.5em;border-radius:8px}pre>code{all:unset}blockquote{border-left:4px solid var(--accent);padding:0 0 0 20px;margin:0;font-size:1.333em}hr{border:none;border-top:1px solid rgb(var(--gray-light))}@media (max-width: 720px){body{font-size:18px}main{padding:1em}}.sr-only{border:0;padding:0;margin:0;position:absolute!important;height:1px;width:1px;overflow:hidden;clip:rect(1px 1px 1px 1px);clip:rect(1px,1px,1px,1px);clip-path:inset(50%);white-space:nowrap}.date{margin-bottom:.5em;color:rgb(var(--gray))}.tags{display:flex;flex-wrap:wrap}.tag{margin:.25em;border:dotted 1px #a1a1a1;border-radius:.5em;padding:.5em 1em;font-size:1.15em;background-color:#f8fcfd}a[data-astro-cid-eimmu3lg]{display:inline-block;text-decoration:none}a[data-astro-cid-eimmu3lg].active{font-weight:bolder;text-decoration:underline}header[data-astro-cid-3ef6ksr2]{margin:0;padding:0 1em;background:white;box-shadow:0 2px 8px rgba(var(--black),5%)}h2[data-astro-cid-3ef6ksr2]{margin:0;font-size:1em}h2[data-astro-cid-3ef6ksr2] a[data-astro-cid-3ef6ksr2],h2[data-astro-cid-3ef6ksr2] a[data-astro-cid-3ef6ksr2].active{text-decoration:none}nav[data-astro-cid-3ef6ksr2]{display:flex;align-items:center;justify-content:space-between}nav[data-astro-cid-3ef6ksr2] a[data-astro-cid-3ef6ksr2]{padding:1em .5em;color:var(--black);border-bottom:4px solid transparent;text-decoration:none}nav[data-astro-cid-3ef6ksr2] a[data-astro-cid-3ef6ksr2].active{text-decoration:none;border-bottom-color:var(--accent)}.social-links[data-astro-cid-3ef6ksr2],.social-links[data-astro-cid-3ef6ksr2] a[data-astro-cid-3ef6ksr2]{display:flex}@media (max-width: 720px){.social-links[data-astro-cid-3ef6ksr2]{display:none}}footer[data-astro-cid-sz7xmlte]{padding:2em 1em 6em;background:linear-gradient(var(--gray-gradient)) no-repeat;color:rgb(var(--gray));text-align:center}.social-links[data-astro-cid-sz7xmlte]{display:flex;justify-content:center;gap:1em;margin-top:1em}.social-links[data-astro-cid-sz7xmlte] a[data-astro-cid-sz7xmlte]{text-decoration:none;color:rgb(var(--gray))}.social-links[data-astro-cid-sz7xmlte] a[data-astro-cid-sz7xmlte]:hover{color:rgb(var(--gray-dark))}
</style></head><body><header data-astro-cid-3ef6ksr2><nav data-astro-cid-3ef6ksr2><h2 data-astro-cid-3ef6ksr2><a href="/" data-astro-cid-3ef6ksr2>三次元日誌(Astro)</a></h2><div class="internal-links" data-astro-cid-3ef6ksr2><a href="/tags/" data-astro-cid-3ef6ksr2 data-astro-cid-eimmu3lg>Tags</a><a href="/about" data-astro-cid-3ef6ksr2 data-astro-cid-eimmu3lg>About</a></div><div class="social-links" data-astro-cid-3ef6ksr2><a href="https://github.com/ousttrue/" target="_blank" data-astro-cid-3ef6ksr2><span class="sr-only" data-astro-cid-3ef6ksr2>Go to Astro's GitHub repo</span><svg viewBox="0 0 16 16" aria-hidden="true" width="32" height="32" data-astro-cid-3ef6ksr2><path fill="currentColor" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z" data-astro-cid-3ef6ksr2></path></svg></a></div></nav></header><main><article><div class="prose"><div class="title"><div class="date"><time datetime="2020-07-25T14:59:50.000Z">2020
-07
-25</time></div><a href="/posts/2020/w3m-mod"><h1>w3m改造</h1></a><div class="tags"><p class="tag"><a href="/tags/w3m">w3m</a></p></div></div></div><p>以前にも何度かやったことがあるのだけど立ち消えになっていた、 <a href="http://w3m.sourceforge.net/index.ja.html">w3m</a> の改造を試みている。
w3m はわりと好きなテキストブラウザなのだが、 2011 年くらいの 0.5.3 で開発が終了している様子。</p>
<p><a href="https://github.com/ousttrue/w3m">https://github.com/ousttrue/w3m</a></p>
<p>まずは <code>C++</code> 化してから、HTML処理などを再入可能にしてタブごとにスレッド独立する方向を目指す。
同時に、 <code>boehm-GC</code> を少しずつ <code>STL</code> のコンテナや <code>std::string</code> に置き換える。
どうも、<code>c++</code> と <code>boehm-GC</code> の共存するのに技がいるらしく、適当に置き換えていくとメモリ破壊で死ぬ。<code>boehm-GC</code> をすべて置き換える必要がありそう。<code>C++</code> クラスのメンバーに <code>GC</code> が要る、<code>GC struct</code> のメンバーに <code>C++</code> クラスが居るの両方に問題があるっぽい。一応、 <code>gc_cleanup</code> を継承したりしているのだけど、やり方がまずいぽい。</p>
<p>改造にあたってなるべく機能を維持しようとしていたのだけど、ある程度わりきって機能を落とさないと手に負えないところがある。</p>
<ul>
<li>http + https 以外の通信プロトコルは落とす。NNTP とか Gopher 使ったことないしなー、FTPもいったん落とす</li>
<li>backend, dump, halfload 等の出力に介入する機能は落とす。コードを読むのが大変</li>
<li>M17N, COLOR, IMAGE, MENU は残す</li>
<li>Mouse は微妙。削ってもよいかも</li>
<li>GetText も削る</li>
</ul>
<p>量を減らす。思ったよりコードが多かったのだ。</p>
<h1 id="下準備">下準備</h1>
<h2 id="msys2-でとりあえずビルド">msys2 でとりあえずビルド</h2>
<p>WSL Ubuntu だとビルドできなかった。
しかし、msys2 ならわりと簡単にビルドできることを発見。</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" lang="plaintext"><code><span class="line"><span>$ pacman -S make gcc libgc-devel openssl-devel ncurses-devel</span></span>
<span class="line"><span>$ x86_64-pc-msys-gcc --version</span></span>
<span class="line"><span>x86_64-pc-msys-gcc (GCC) 9.3.0</span></span>
<span class="line"><span>Copyright (C) 2019 Free Software Foundation, Inc.</span></span>
<span class="line"><span>This is free software; see the source for copying conditions.  There is NO</span></span>
<span class="line"><span>warranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.</span></span>
<span class="line"><span>$ ./configure</span></span></code></pre>
<p>コンパイル環境の方が昔と変わってしまってビルドでエラーになる。</p>
<p>修正方法👇</p>
<p><a href="https://qiita.com/imkitchen/items/02a9df7baaaf434fee66">[CentOS7] emacs24にemacs-w3mインストール</a></p>
<p><code>#ifdef</code> の調整</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" lang="plaintext"><code><span class="line"><span>// config.h</span></span>
<span class="line"><span>//#define USE_BINMODE_STREAM 1</span></span>
<span class="line"><span>//#define USE_EGD</span></span></code></pre>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" lang="plaintext"><code><span class="line"><span>$ make</span></span>
<span class="line"><span>$ ./w3m www.google.com // 動いた</span></span></code></pre>
<h2 id="wsl-で-gc-がクラッシュする問題">WSL で GC がクラッシュする問題</h2>
<p><code>boehm-GC</code> がランタイムにエラーになることで、 <code>make</code> 中のコード生成 <code>mktable</code> がクラッシュするのが原因でビルドステップが途中で止まるのが原因だった。なので、たとえビルド済みの <code>w3m</code> を <code>apt get</code> しても、ランタイムも同じ原因でクラッシュする。</p>
<p>エラー。</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" lang="plaintext"><code><span class="line"><span>Wrong __data_start/_end pair</span></span>
<span class="line"><span>fish: './build/w3m' terminated by signal SIGABRT (Abort)</span></span></code></pre>
<p><a href="https://hitkey.nekokan.dyndns.info/diary2004.php#D200424">https://hitkey.nekokan.dyndns.info/diary2004.php#D200424</a></p>
<p>によると、stack size の制限が原因らしい。</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" lang="plaintext"><code><span class="line"><span>$ ulimit -s</span></span>
<span class="line"><span>8192</span></span></code></pre>
<p>WSL でこれを変えるには・・・。</p>
<p><a href="https://github.com/microsoft/WSL/issues/633">https://github.com/microsoft/WSL/issues/633</a></p>
<p>無理。</p>
<p><code>WSL2</code> ならできる？</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" lang="plaintext"><code><span class="line"><span>> wsl -l -v</span></span>
<span class="line"><span>  NAME            STATE           VERSION</span></span>
<span class="line"><span>* Ubuntu-20.04    Running         2</span></span></code></pre>
<p>やってみる。</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" lang="plaintext"><code><span class="line"><span>$ ulimit -s unlimited</span></span>
<span class="line"><span>> ulimit -s</span></span>
<span class="line"><span>unlimited</span></span></code></pre>
<p>できた。</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" lang="plaintext"><code><span class="line"><span>$ w3m</span></span>
<span class="line"><span>Wrong __data_start/_end pair</span></span></code></pre>
<p>うーむ。</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" lang="plaintext"><code><span class="line"><span>$ ulimit -s 81920</span></span>
<span class="line"><span>> ulimit -s</span></span>
<span class="line"><span>81920</span></span></code></pre>
<p>動いた。
8192KB では足りなく、 unlimited では多すぎるらしい。これは、難しいな。</p>
<p>ちなみに、 <code>gdb</code> 上ならスタック問題を解決しなくても動いた。
<code>gdb</code> がスタックを覆い隠すのかな？
開発だけならできなくもない。</p>
<h2 id="ビルドシステム">ビルドシステム</h2>
<p>とりあえず慣れたツールに変更。
WSL 上の vscode で作業しているのもあり、autotools から CMake に変更。
クロスプラットフォームは後退させて、新しめの gcc(c++20) でビルドできればいいや。
config.h や funcname 系のコード生成結果はコミットしちゃう。
libwc が static ライブラリにわかれているのも、ひとまとめにしてしまった。
あと、適当にソースをフォルダに移動する。</p>
<p>生成コード一覧</p>



























































<table><thead><tr><th>ファイル</th><th>生成方法</th><th>入力</th><th>備考</th></tr></thead><tbody><tr><td>config.h</td><td>configure</td><td></td><td>各種 #define など</td></tr><tr><td>entity.h</td><td>Makefile(mktable)</td><td>entity.tab</td><td>./mktable 100 entity.tab > entity.h</td></tr><tr><td>funcname.tab</td><td>Makefile(awk)</td><td>main.c, menu.c</td><td></td></tr><tr><td>funcname.c</td><td>Makefile(awk)</td><td>funcname.tab</td><td>sort funcname.tab ｜ awk -f funcname0.awk > funcname.c</td></tr><tr><td>funcname1.h</td><td>Makefile(awk)</td><td>funcname.tab</td><td></td></tr><tr><td>funcname2.h</td><td>Makefile(awk)</td><td>funcname.tab</td><td></td></tr><tr><td>functable.c</td><td>Makefile(mktable)</td><td>funcname.tab</td><td></td></tr><tr><td>tagtable.c</td><td>Makefile(mktable)</td><td>funcname.tab</td><td></td></tr></tbody></table>
<h2 id="警告からエラーに引き上げ">警告からエラーに引き上げ</h2>
<p>改造していくのに <code>C</code> の緩い型制限が危険(コンパイルが通るのに型が不一致になりやすい)なので、
以下のオプションを追加。</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" lang="plaintext"><code><span class="line"><span>-Werror=implicit-function-declaration</span></span>
<span class="line"><span>-Werror=int-conversion</span></span>
<span class="line"><span>-Werror=conversion-null</span></span></code></pre>
<p>これで、型宣言を補強しながら進める。</p>
<h1 id="第1段階">第1段階</h1>
<ul>
<li>extern “C” を追加してソースの拡張子を <code>.cpp</code> に変更</li>
<li>extern “C” をまとめて取り除く</li>
<li>typedef struct tag を取り除く</li>
</ul>
<p>ここまでやると、自由に <code>c++</code> のコードを混ぜることができる。
<code>std::string</code>、<code>std::vector</code>, <code>std::shared_ptr</code>, <code>std::function</code>, <code>std::string_view</code>, <code>template</code>, <code>class</code>, 前方宣言, <code>auto</code>, <code>inline</code> 等使い放題 👍</p>
<p>特に <code>std::string_view</code> の使い勝手を試したい。
所有しない文字列はすべて、 <code>std::string_view</code> でいけると思うのだが。
<code>split</code> の <code>std::string_view</code> 版は具合がよかった。</p>
<h2 id="c-化-extern-c">c++ 化 (extern “C”)</h2>
<p>手法としては、各ソースの拡張子を <code>.c</code> から <code>.cpp</code> に変更する。
<code>CMakeLists.txt</code> を修正。
<code>#include</code> を <code>extern "C"</code> で囲む、で <code>c++</code> 化することができる。</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" lang="c++"><code><span class="line"><span style="color:#F97583">extern</span><span style="color:#9ECBFF"> "C"</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">#include</span><span style="color:#9ECBFF"> "xxx.h"</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>ただ、 <code>cpp</code> で定義する関数の宣言が <code>extern "C"</code> の中に入らないとリンクエラーになるので、
そうなるようにソースごとにヘッダを分配してやる。
<code>w3m</code> は関数宣言が少数のファイル <code>proto.h</code>, <code>fm.h</code> とかに集中しているのだが、いっぱいあるので雑にやる。
コンパイルが通ればよい。</p>
<p>分配するときに未定義の型を前方宣言ですませたいのだけど、 <code>c</code> の <code>struct</code> 定義が、<code>struct tag</code> と <code>typedef</code> に分かれているのがやっかいだった。</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" lang="c"><code><span class="line"><span style="color:#6A737D">// C</span></span>
<span class="line"><span style="color:#F97583">typedef</span><span style="color:#F97583"> struct</span><span style="color:#E1E4E8"> hogeTag</span></span>
<span class="line"><span style="color:#E1E4E8">{</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">} Hoge;</span></span></code></pre>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" lang="c"><code><span class="line"><span style="color:#F97583">void</span><span style="color:#B392F0"> DoHoge</span><span style="color:#E1E4E8">(Hoge </span><span style="color:#F97583">*</span><span style="color:#FFAB70">p</span><span style="color:#E1E4E8">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">// に対する前方宣言は、</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">struct</span><span style="color:#E1E4E8"> hogeTag;</span></span>
<span class="line"><span style="color:#F97583">typedef</span><span style="color:#E1E4E8"> hogeTag Hoge;</span></span></code></pre>
<p><code>C</code> の状態で、前方宣言を導入できずヘッダの分割が難航。
型ごとに別のヘッダに分割することは断念して、
ほとんど全部の <code>struct</code> 定義の入ったヘッダを <code>fm.h</code> から分離して作るのに留めた。</p>
<h2 id="defun">DEFUN</h2>
<p><code>w3m</code> は <code>DEFUN</code> でキーアサインできる関数を定義している。</p>
<p><a href="/w3m/doc-jp/readme.func/">readme.func</a></p>
<p>以下のように、キーボードなどのイベントをトリガーにアクションを実行するというイメージ。</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" lang="plaintext"><code><span class="line"><span>Key</span></span>
<span class="line"><span>    KeyMap</span></span>
<span class="line"><span>        DEFUN</span></span>
<span class="line"><span>    Menu</span></span>
<span class="line"><span>        DEFUN</span></span>
<span class="line"><span>MouseAction</span></span>
<span class="line"><span>    ActionMap</span></span>
<span class="line"><span>        DEFUN</span></span>
<span class="line"><span>    Menu</span></span>
<span class="line"><span>        DEFUN</span></span>
<span class="line"><span>Alarm</span></span>
<span class="line"><span>    DEFUN</span></span></code></pre>
<p>ソースは、<code>main.c</code> と <code>menu.c</code> に <code>DEFUN</code> とそれの使う補助関数がまとめて定義されていて、
ヘッダは <code>proto.h</code> に全部入れとなっている。</p>
<p>c++ で下記のようなディスパッチャを作った。</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" lang="c++"><code><span class="line"><span style="color:#F97583">typedef</span><span style="color:#F97583"> void</span><span style="color:#E1E4E8"> (*Command)();</span></span>
<span class="line"><span style="color:#B392F0">std</span><span style="color:#E1E4E8">::unordered_map</span><span style="color:#F97583">&#x3C;</span><span style="color:#B392F0">std</span><span style="color:#E1E4E8">::string, Command</span><span style="color:#F97583">></span><span style="color:#E1E4E8"> g_commandMap;</span></span></code></pre>
<p>使い捨ての python で関数に登録するコードを生成した。</p>
<h1 id="第２段階">第２段階</h1>
<ul>
<li>PODじゃない型が動くようにする
<ul>
<li>constructor/destructor</li>
</ul>
</li>
<li>脱GC
<ul>
<li>コレクションをSTLに置き換える</li>
<li>std::string</li>
<li>std::shared_ptr</li>
</ul>
</li>
<li>機能ごとにモジュール化</li>
<li>再入可能</li>
</ul>
<h2 id="gc_malloc-から-gc_cleanup-継承へ">GC_MALLOC から gc_cleanup 継承へ</h2>
<p>boehm-GC を <code>c++</code> のクラスで使う方法を調べた。</p>
<p><a href="http://www.namikilab.tuat.ac.jp/~sasada/prog/boehmgc.html#i-0-5">http://www.namikilab.tuat.ac.jp/~sasada/prog/boehmgc.html#i-0-5</a></p>
<p><code>w3m</code> では、 <code>GC</code> を多用している。</p>
<p>おもに、</p>
<ul>
<li>struct Str</li>
<li>コレクション</li>
<li>struct の field</li>
</ul>
<p>という感じに。
このうち、 struct の field で使われるタイプの単発の <code>GC_MALLOC</code> している型を <code>gc_cleanup</code> 継承にして、 <code>new</code> で初期化するようにする。</p>
<ul>
<li>bzero, bcopy, memcpy, sizeof</li>
</ul>
<p>等でメモリクリアしているところに注意する。
これで、その型は <code>constructor/destructor</code> が動くようになり、
メンバーに <code>std::string</code> 等を配置できるようになる。
あとで、 <code>gc_cleanup</code> から <code>std::shared_ptr</code> に変更することも視野に入れている。</p>
<h2 id="gc文字列-str">GC文字列 Str</h2>
<p>アプリ全体で使われていて一挙になくすことはできないのだけど、構造体の末端のメンバーから <code>std::string</code> に変える。
あと、がんばって <code>const char *</code> の範囲を増やす。
<code>libwc</code> から <code>Str</code> を剥そうと思っていたのだが、逆に <code>libwc</code> に <code>Str</code> を封じ込める方向に軌道修正。
<code>indep.c</code> の便利文字列関数も少しずつ変えてく。</p>
<h2 id="グローバル変数を減らす">グローバル変数を減らす</h2>
<p>関数の中でグローバル変数にアクセスしている場合(CurrentBufferなど)、これを関数の引数経由とか、クラスのメンバー経由でもらう。面倒でも Getter と Setter を区別して、どこで変更されうるかわかりやすくする。
クラスのメンバーは、 <code>private</code> 化を試みる。</p>
<h2 id="stream処理">Stream処理</h2>
<p>多分、最難関の <code>loadGeneralFile</code> 関数。700行くらいだったか。
goto とか longjmp があってよくわからなかったのだが、慣れてきた。
<code>http</code>, <code>https</code>, <code>NNTP ?</code>, <code>gopher</code>, <code>ftp</code>, <code>pipe</code> 等、<code>http</code> のプロキシーやリダイレクト、 <code>www-auth</code> などを一手に処理していて容易に手を付けられない。
何度か整理しようとして悉く撃退されたので、雑にやることにした。
機能を <code>http(https)</code> に絞ってそれ以外をコメントアウトしてとにかく量を減らす。
プロキシーとか、 <code>dump</code>, <code>halfload</code> などのよく知らない機能もどんどん削る。
としてなんとか改造できるようになってきた。</p>
<p>ここを <code>HttpClient</code>, <code>LocalFile</code>, <code>PipeReader</code> あたりに整理したい。</p>
<h1 id="第３段階">第３段階</h1>
<p>Tab, Buffer, Line のリンクリストを STL のコレクションに置き換えた。</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" lang="c++"><code><span class="line"><span style="color:#F97583">auto</span><span style="color:#E1E4E8"> buf </span><span style="color:#F97583">=</span><span style="color:#B392F0"> load</span><span style="color:#E1E4E8">(url);</span></span>
<span class="line"><span style="color:#E1E4E8">tab-></span><span style="color:#B392F0">push</span><span style="color:#E1E4E8">(buf);</span></span></code></pre>
<p>という形を目指す。</p>
<p><code>loadGeneralFile</code> を解きほぐして、 <code>HTTP</code> 機能を抽出、リダイレクトまで動くようにできた。
<code>loadGeneralFile</code> は、</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" lang="plaintext"><code><span class="line"><span>* OpenStream/Send HTTP Request</span></span>
<span class="line"><span>* HTTP Response</span></span>
<span class="line"><span>    * 3xx => Redirect</span></span>
<span class="line"><span>* content-type で分岐</span></span>
<span class="line"><span>    * BufferLoader => Buffer</span></span></code></pre>
<p>という感じに整理できそう。
HttpとBufferローダーを副作用の無い関数に整理できれば再入可能が見えてくる。
早めに分岐させて、分岐したら合流しない。同じ処理は関数で共有するという方向性で整理。</p>
<p>Buffer が多機能なので、Document, HttpResponse, FileInfo とかに分割したい。</p>
<h1 id="第４段階">第４段階</h1>
<p>mainloop の再実装。libuv, libevent 等を検討していたのだけど、 c++ との親和性の高い asio を使うことにした。
<code>tty read (keyboard input)</code>, <code>signal callback (sigint, winresize)</code>, <code>alarm</code> の割り込みを asio 経由にする。
アプリの終了をloop の終了にして、自然に destructor がコールされるようになる。</p>
<h1 id="第５段階">第５段階</h1>
<p>html parse から term へのレンダリング部分の分解。
やっと解読できて１パス目</p>
<ul>
<li>内部文字コード(wtf-8)に変換</li>
<li>tokenize</li>
<li>tag をパースして属性取得 => パースに成功したら行バッファに書き戻す。フォームの情報を蓄積する。テーブルのレイアウト</li>
</ul>
<p>結果として、行のリストと、フォーム情報を得る。</p>
<p>２パス目</p>
<ul>
<li>行のリストを再度パース</li>
<li>非タグ部分をBufferに出力</li>
<li>Aタグやフォームを Anchor などに出力</li>
</ul>
<p>という感じだった。
１パス目で html 化するときに知らない属性を捨てたり、内部属性を追加したりしている様子。
この、内部属性がよくわからなくて難しい。</p>
<h1 id="文字コード">文字コード</h1>
<p><code>content-charset</code> => <code>wtf</code> => <code>DisplayCharset</code> と文字コードを変換して動作していることがわかった。
試しに、<code>utf-8</code> であることが分かっている <code>html</code> で <code>wtf</code> 変換を飛ばしてみたところ表示が壊れた。
<code>wtf</code> は <code>utf-8</code> と互換性がないらしい。
<a href="http://simonsapin.github.io/wtf-8/">http://simonsapin.github.io/wtf-8/</a>
なのかと思ったのだが、違う独自形式かもしれない。</p>
<p>w3m は、この <code>wtf</code> エンコーディングで、html タグのパース、文字のバイト幅の判定、文字のカラム幅の判定をしているのだが、
<code>utf-8</code> では、文字のバイト幅、カラム幅の判定が狂う。
ということで、 <code>utf-8</code> でのバイト幅判定を自作して <code>wcwidth</code> を組み合わせてみた。
<code>*#12345;</code> 形式の <code>unicode</code> 埋め込みに対応するために、追加で <code>unicode</code> => <code>utf-8</code> 変換も作った。
正しく表示することができた。</p>
<p>ということで、<code>euc-jp</code> と <code>shift-jis</code> と <code>iso-2022-jp</code> から <code>utf-8</code> への変換を作れば日本語は対応できそう。
<code>std::string_view</code>, <code>char32_t</code>, <code>char8_t</code> あたりの新しい型を使った <code>\0</code> 終端に頼らないライブラリを作ってみる。</p>
<h1 id="メモ">メモ</h1>
<h2 id="モジュールに分割">モジュールに分割</h2>
<p>機能ごとにモジュールに分割する。</p>
<ul>
<li>
<p>UI(frontend)</p>
<ul>
<li>Term
<ul>
<li>低レベル描画
<ul>
<li>termcap の関数を直接呼ぶ。curses の自前実装的な</li>
<li>マルチバイト、マルチカラムの文字列と密接に関連していて libwc と不可分</li>
</ul>
</li>
<li>キーボード入力</li>
<li>マウス入力</li>
<li>リサイズイベント</li>
<li>SIGNALハンドリング
<ul>
<li>SIGINT => longjmp でキャンセル処理を実現している。c++ のデストラクタとかまずそう</li>
</ul>
</li>
</ul>
</li>
<li>高レベル描画
<ul>
<li>Lineの構築(byte ごとに char と Lineprop がペアになる)</li>
</ul>
</li>
<li>Tab</li>
<li>Buffer</li>
<li>Message</li>
<li>Menu</li>
<li>Keymap</li>
<li>LineInput
<ul>
<li>SearchKey</li>
<li>History</li>
</ul>
</li>
</ul>
</li>
<li>
<p>IO(transport)</p>
<ul>
<li>IStream
<ul>
<li>union => class polymorphism化</li>
<li>file descriptor</li>
<li>FILE*</li>
<li>ssl</li>
<li>memory</li>
<li>Compression</li>
</ul>
</li>
<li>LocalCGI</li>
</ul>
</li>
<li>
<p>http</p>
<ul>
<li>HttpSession
<ul>
<li>HttpRequest</li>
<li>HttpResponse</li>
</ul>
</li>
<li>cookie</li>
<li>redirect</li>
<li>referer</li>
<li>https</li>
<li>ftp</li>
<li>URL</li>
</ul>
</li>
<li>
<p>HTML</p>
<ul>
<li>HTMLtagproc1</li>
<li>HTMLlineproc2body
<ul>
<li>process_form</li>
<li>process_form_int</li>
</ul>
</li>
<li>form</li>
<li>table</li>
<li>frame</li>
<li>term rendering</li>
</ul>
</li>
<li>
<p>String</p>
<ul>
<li>文字コード</li>
<li>quote</li>
<li>url escape</li>
<li>html escape</li>
<li>html entity</li>
<li>char_util
<ul>
<li>myctype</li>
</ul>
</li>
<li>string_view_util
<ul>
<li>strip</li>
</ul>
</li>
<li>string_util
<ul>
<li>malloc</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="リンクをたどるfollowlink">リンクをたどる(followLink)</h2>
<p>followA();
loadLink();
loadGeneralFile();</p>
<p>cmd_loadURL();
loadGeneralFile();</p>
<p>cmd_loadURL();
loadGeneralFile();</p>
<h2 id="描画する">描画する</h2>
<p>displayBuffer
redrawBuffer
redrawNLine</p>
<h2 id="key入力">key入力</h2></article></main><footer data-astro-cid-sz7xmlte>
&copy; 2023 ousttrue. All rights reserved.
<div class="social-links" data-astro-cid-sz7xmlte><a href="https://github.com/ousttrue/" target="_blank" data-astro-cid-sz7xmlte><svg viewBox="0 0 16 16" aria-hidden="true" width="32" height="32" astro-icon="social/github" data-astro-cid-sz7xmlte><path fill="currentColor" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z" data-astro-cid-sz7xmlte></path></svg></a></div></footer></body></html>