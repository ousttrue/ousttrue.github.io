<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="generator" content="Nikola (getnikola.com)">
<meta name="viewport" content="width=device-width">
<script src="../../../../../assets/js/all-nocdn.js"></script><title>おれおれmsgpack-rpc-pythonを作る | 三次元日誌</title>
<link href="../../../../../assets/css/code.css" rel="stylesheet" type="text/css">
<link href="../../../../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
</head>
<body>
    <h1 id="brand">
        <a href="../../../../../" title="三次元日誌" rel="home">
            <span id="blog-title">三次元日誌</span>
        </a>
    </h1>

    <nav id="menu"><ul>
<li><a href="../../../../../archive.html">Archives</a></li>
<li><a href="../../../../../categories/index.html">Tags</a></li>
<li><a href="../../../../../rss.xml">RSS feed</a></li>
<li><a href="../../../../../about">About</a></li>
<li><a href="../../../../../books">MemoBooks</a></li>

            
            
            
        </ul></nav><hr>
<main id="content"><h1 class="p-name entry-title" itemprop="headline name">
    <h1 class="p-name entry-title" itemprop="headline name">
    <a href="." class="u-url">おれおれmsgpack-rpc-pythonを作る
    </a>
</h1>
<ul itemprop="keywords" class="tags">
<li>
        <time datetime="2013-05-31T00:00:00+09:00" title="2013-05-31">2013-05-31</time>
</li>
    <li><a class="tag p-category" href="../../../../../categories/cpp/" rel="tag">cpp</a></li>
    <li><a class="tag p-category" href="../../../../../categories/msgpack/" rel="tag">msgpack</a></li>
</ul>
</h1>

<p>おれおれmsgpack-rpc-pythonを作る
MsgPackRPCのpythonバインディング(クライアント側)が必要になったのでmsgpack-rpc-pythonを使ってみたのだが、
GUI(pyqt)に載せて接続制御とエラーハンドリングを細やかに制御したいので俺俺で類似品を作ることにした。
tonado-msgpackと名付けて取り合えず作業開始。
https://github.com/ousttrue/tornado-msgpack
msgpack-rpc-pythonのおかげでtornadoの存在を知ったのだがtornado.ioloopが見れば見るほどboost::asioっぽい。
ということで、c++で作成中のmsgpack-rpc-asioのpython版のような感じのAPIにしてみた。
以下の点を考慮している。</p>
<p>tornado.ioloopを隠さない
tornado.ioloopをスレッドに乗せて回しっぱなしにする
tornado.ioloopひとつで複数の接続を扱う
dispatcherを乗せ換え易くする。
接続ステータスの変化をコールバックで受け取る
非同期リクエストのコールバックを早期にセットする
TCP以外は考慮しない</p>
<p>プロジェクト作成
tonado_msgpack/
    setup.py
    sample/
        sample.py
    tonado_msgpack</p>
<p>setup.py
from distutils.core import setup</p>
<p>setup(
    name='tonado_msgpack',
    version='0.1',
    py_modules=['tonado_msgpack'],
    )</p>
<p>作業開始
$ python setup.py develop --user</p>
<p>sample/sample.py</p>
<h2>!/usr/bin/env python</h2>
<p>import tornado_msgpack
import tornado</p>
<p>if <strong>name</strong>=="<strong>main</strong>":
    port=18080</p>
<div class="code"><pre class="code literal-block">#<span class="w"> </span><span class="nv">dispatcher</span><span class="w"></span>
<span class="nv">dispatcher</span><span class="o">=</span><span class="nv">tornado_msgpack</span>.<span class="nv">Dispatcher</span><span class="ss">()</span><span class="w"></span>
<span class="nv">def</span><span class="w"> </span><span class="nv">add</span><span class="ss">(</span><span class="nv">a</span>,<span class="w"> </span><span class="nv">b</span><span class="ss">)</span>:<span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nv">a</span><span class="o">+</span><span class="nv">b</span><span class="w"></span>
<span class="nv">dispatcher</span>.<span class="nv">add_handler</span><span class="ss">(</span><span class="s2">"add"</span>,<span class="w"> </span><span class="nv">add</span><span class="ss">)</span><span class="w"></span>

#<span class="w"> </span><span class="nv">server</span><span class="w"></span>
<span class="nv">server_loop</span><span class="o">=</span><span class="nv">tornado</span>.<span class="nv">ioloop</span>.<span class="nv">IOLoop</span><span class="ss">()</span><span class="w"></span>
<span class="nv">def</span><span class="w"> </span><span class="nv">on_receive</span><span class="ss">(</span><span class="nv">msg</span>,<span class="w"> </span><span class="nv">session</span><span class="ss">)</span>:<span class="w"></span>
<span class="w">    </span><span class="nb">result</span><span class="o">=</span><span class="nv">dispatcher</span>.<span class="nv">dispatch</span><span class="ss">(</span><span class="nv">msg</span><span class="ss">)</span><span class="w"></span>
<span class="w">    </span><span class="nv">session</span>.<span class="nv">send_async</span><span class="ss">(</span><span class="nb">result</span><span class="ss">)</span><span class="w"></span>
<span class="nv">server</span><span class="o">=</span><span class="nv">tornado_msgpack</span>.<span class="nv">Server</span><span class="ss">(</span><span class="nv">server_loop</span><span class="ss">)</span><span class="w"></span>
<span class="nv">server</span>.<span class="nv">listen</span><span class="ss">(</span><span class="s2">"localhost"</span>,<span class="w"> </span><span class="nv">port</span><span class="ss">)</span><span class="w"></span>
<span class="nv">server_thread</span><span class="o">=</span><span class="nv">threading</span>.<span class="nv">Thread</span><span class="ss">(</span><span class="nv">target</span><span class="o">=</span><span class="nv">lambda</span><span class="w"> </span>:<span class="w"> </span><span class="nv">server_loop</span>.<span class="nv">start</span><span class="ss">()</span><span class="w"> </span><span class="ss">)</span><span class="w"></span>

#<span class="w"> </span><span class="nv">clinet</span><span class="w"></span>
<span class="nv">client_loop</span><span class="o">=</span><span class="nv">tornado</span>.<span class="nv">ioloop</span>.<span class="nv">IOLoop</span><span class="ss">()</span><span class="w"></span>
<span class="nv">client</span><span class="o">=</span><span class="nv">tornado_msgpack</span>.<span class="nv">Client</span><span class="ss">(</span><span class="nv">client_loop</span><span class="ss">)</span><span class="w"></span>
<span class="nv">def</span><span class="w"> </span><span class="nv">on_status_changed</span><span class="ss">(</span><span class="nv">status</span><span class="ss">)</span>:<span class="w"></span>
<span class="w">    </span><span class="nv">print</span><span class="ss">(</span><span class="nv">status</span><span class="ss">)</span><span class="w"></span>
<span class="nv">clinet</span>.<span class="nv">attach_status_callback</span><span class="ss">(</span><span class="nv">on_status_changed</span><span class="ss">)</span><span class="w"></span>
<span class="nv">client</span>.<span class="k">connect</span><span class="ss">(</span><span class="s2">"localhost"</span>,<span class="w"> </span><span class="nv">port</span><span class="ss">)</span><span class="w"></span>
<span class="nv">clinet_thread</span><span class="o">=</span><span class="nv">threading</span>.<span class="nv">Thread</span><span class="ss">(</span><span class="nv">target</span><span class="o">=</span><span class="nv">lambda</span><span class="w"> </span>:<span class="w"> </span><span class="nv">client_loop</span>.<span class="nv">start</span><span class="ss">()</span><span class="w"> </span><span class="ss">)</span><span class="w"></span>

#<span class="w"> </span><span class="nv">request</span><span class="w"></span>
<span class="nv">def</span><span class="w"> </span><span class="nv">on_receive</span><span class="ss">(</span><span class="nb">result</span><span class="ss">)</span>:<span class="w"></span>
<span class="w">    </span><span class="nv">print</span><span class="ss">(</span><span class="nb">result</span><span class="ss">)</span><span class="w"></span>

<span class="nv">future</span><span class="o">=</span><span class="nv">clinet</span>.<span class="nv">call_async_with_callback</span><span class="ss">(</span><span class="nv">on_receive</span>,<span class="w"> </span><span class="s2">"add"</span>,<span class="w"> </span><span class="mi">1</span><span class="ss">)</span><span class="w"></span>
<span class="nv">future</span>.<span class="nv">join</span><span class="ss">()</span><span class="w"></span>

<span class="nv">future</span><span class="o">=</span><span class="nv">clinet</span>.<span class="nv">call_async_with_callback</span><span class="ss">(</span><span class="nv">on_receive</span>,<span class="w"> </span><span class="s2">"add"</span>,<span class="w"> </span><span class="mi">1</span>,<span class="w"> </span><span class="mi">2</span><span class="ss">)</span><span class="w"></span>
<span class="nv">future</span>.<span class="nv">join</span><span class="ss">()</span><span class="w"></span>

<span class="nv">future</span><span class="o">=</span><span class="nv">clinet</span>.<span class="nv">call_async_with_callback</span><span class="ss">(</span><span class="nv">on_receive</span>,<span class="w"> </span><span class="s2">"add"</span>,<span class="w"> </span><span class="mi">1</span>,<span class="w"> </span><span class="mi">2</span>,<span class="w"> </span><span class="mi">3</span><span class="ss">)</span><span class="w"></span>
<span class="nv">future</span>.<span class="nv">join</span><span class="ss">()</span><span class="w"></span>

<span class="nv">print</span><span class="ss">(</span><span class="s2">"stop client..."</span><span class="ss">)</span><span class="w"></span>
<span class="nv">client_loop</span>.<span class="nv">stop</span><span class="ss">()</span><span class="w"></span>
<span class="nv">clinet_thread</span>.<span class="nv">join</span><span class="ss">()</span><span class="w"></span>

<span class="nv">print</span><span class="ss">(</span><span class="s2">"stop server..."</span><span class="ss">)</span><span class="w"></span>
<span class="nv">server_loop</span>.<span class="nv">stop</span><span class="ss">()</span><span class="w"></span>
<span class="nv">server_thread</span>.<span class="nv">join</span><span class="ss">()</span><span class="w"></span>

<span class="nv">print</span><span class="ss">(</span><span class="s2">"done"</span><span class="ss">)</span><span class="w"></span>
</pre></div>

<p>とりあえずこんな感じを予定。
./sample/sample.pyでシンタックスエラーが出なくなるところまで確認。
tornado_msgpackを順次実装していく。
Tornado Reference - http://www.tornadoweb.org/en/stable/
だいたい動くようになった。
$ ./sample/sample
connected
&lt;_MainThread(MainThread, started 140102020679424)&gt;:send 9 bytes
<thread started>:on_read
<thread started>:send 48 bytes
<thread started>:on_read
on_receive:[1, 1, True, 'add() takes exactly 2 arguments (1 given)']
&lt;_MainThread(MainThread, started 140102020679424)&gt;:send 10 bytes
<thread started>:on_read
<thread started>:send 5 bytes
<thread started>:on_read
on_receive:[1, 2, False, 3]
&lt;_MainThread(MainThread, started 140102020679424)&gt;:send 11 bytes
<thread started>:on_read
<thread started>:send 59 bytes
<thread started>:on_read
on_receive:[1, 3, True, 'add() takes exactly 2 positional arguments (3 given)']
stop client...
stop server...
done</thread></thread></thread></thread></thread></thread></thread></thread></thread></p>
<p>サーバースレッドのioloopと、クライアントスレッドのioloopが相互にやり取りしている感じでちゃんと動いている。</p>

<hr>
<ul class="pager hidden-print">
<li class="previous">
        <a href="../../30/python-path/" rel="prev" title="Pythonモジュールをユーザーローカルにインストールする">
            Pythonモジュールをユーザーローカルにインストールする 👈
        </a>
    </li>
    <li style="flex-grow: 1">
    <li class="next">
        <a href="../../../../../github/tornado-msgpack/" rel="next" title="tornado-msgpack">
            👉 tornado-msgpack
        </a>
    </li>
</ul></main><footer id="footer"><p>
            Powered by
            <a href="https://getnikola.com" rel="nofollow">Nikola</a>
        </p>
    </footer>
</body>
</html>
