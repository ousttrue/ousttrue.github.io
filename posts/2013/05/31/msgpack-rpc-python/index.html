<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <title>三次元日誌</title>

    

  <script src="https://ousttrue.github.io/plugins/elasticlunr.min.js" defer></script>
  <script src="https://ousttrue.github.io/search_index.en.js" defer></script>
  <script src="https://ousttrue.github.io/js/search.js" defer></script>

    

     
    <link rel="stylesheet" href="https://ousttrue.github.io/main.css">
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css"
      />
    
  </head>

  <body class="container">
    <a class="site_title" href="https:&#x2F;&#x2F;ousttrue.github.io&#x2F;">
      <div>三次元日誌</div>
    </a>

    <nav class="nav">
      <a class="item" href="/tags/">tags</a>
      <a class="item" href="https://github.com/ousttrue" aria-label="github">
        <i class="fab fa-github fa-lg"></i>
      </a>
      

        
            <form class="navbar-form">
                <input id="userinput" class="form-control is-search" type="search" placeholder="Search docs..."
                    aria-label="Search docs..." autocomplete="off">
                <div id="suggestions" class="shadow bg-white rounded"></div>
            </form>
        
    </nav>

    <main class="main">
<div class="page">
<div class="content">
  <div class="headline">
  
  

  
  <a class="headline_title" href="https:&#x2F;&#x2F;ousttrue.github.io&#x2F;posts&#x2F;2013&#x2F;05&#x2F;31&#x2F;msgpack-rpc-python&#x2F;"> おれおれmsgpack-rpc-pythonを作る 
  

  
  </a>

  

  <div>
    <ul class="tags">
      <li class="headline_date">
        <div class="year">2013</div>
        <div class="md">0531</div>
      </li>
      
      


    <li class="tag"><a href="https:&#x2F;&#x2F;ousttrue.github.io&#x2F;tags&#x2F;cpp&#x2F;">cpp</a></li>

    <li class="tag"><a href="https:&#x2F;&#x2F;ousttrue.github.io&#x2F;tags&#x2F;msgpack&#x2F;">msgpack</a></li>




    </ul>
  </div>
</div>
 <p>おれおれmsgpack-rpc-pythonを作る
MsgPackRPCのpythonバインディング(クライアント側)が必要になったのでmsgpack-rpc-pythonを使ってみたのだが、
GUI(pyqt)に載せて接続制御とエラーハンドリングを細やかに制御したいので俺俺で類似品を作ることにした。
tonado-msgpackと名付けて取り合えず作業開始。
https://github.com/ousttrue/tornado-msgpack
msgpack-rpc-pythonのおかげでtornadoの存在を知ったのだがtornado.ioloopが見れば見るほどboost::asioっぽい。
ということで、c++で作成中のmsgpack-rpc-asioのpython版のような感じのAPIにしてみた。
以下の点を考慮している。</p>
<p>tornado.ioloopを隠さない
tornado.ioloopをスレッドに乗せて回しっぱなしにする
tornado.ioloopひとつで複数の接続を扱う
dispatcherを乗せ換え易くする。
接続ステータスの変化をコールバックで受け取る
非同期リクエストのコールバックを早期にセットする
TCP以外は考慮しない</p>
<p>プロジェクト作成
tonado_msgpack/
setup.py
sample/
sample.py
tonado_msgpack</p>
<p>setup.py
from distutils.core import setup</p>
<p>setup(
name='tonado_msgpack',
version='0.1',
py_modules=['tonado_msgpack'],
)</p>
<p>作業開始
$ python setup.py develop --user</p>
<p>sample/sample.py
#!/usr/bin/env python</p>
<p>import tornado_msgpack
import tornado</p>
<p>if <strong>name</strong>==&quot;<strong>main</strong>&quot;:
port=18080</p>
<pre style="background-color:#2b303b;">
<code># dispatcher
dispatcher=tornado_msgpack.Dispatcher()
def add(a, b):
    return a+b
dispatcher.add_handler(&quot;add&quot;, add)

# server
server_loop=tornado.ioloop.IOLoop()
def on_receive(msg, session):
    result=dispatcher.dispatch(msg)
    session.send_async(result)
server=tornado_msgpack.Server(server_loop)
server.listen(&quot;localhost&quot;, port)
server_thread=threading.Thread(target=lambda : server_loop.start() )

# clinet
client_loop=tornado.ioloop.IOLoop()
client=tornado_msgpack.Client(client_loop)
def on_status_changed(status):
    print(status)
clinet.attach_status_callback(on_status_changed)
client.connect(&quot;localhost&quot;, port)
clinet_thread=threading.Thread(target=lambda : client_loop.start() )

# request
def on_receive(result):
    print(result)

future=clinet.call_async_with_callback(on_receive, &quot;add&quot;, 1)
future.join()

future=clinet.call_async_with_callback(on_receive, &quot;add&quot;, 1, 2)
future.join()

future=clinet.call_async_with_callback(on_receive, &quot;add&quot;, 1, 2, 3)
future.join()

print(&quot;stop client...&quot;)
client_loop.stop()
clinet_thread.join()

print(&quot;stop server...&quot;)
server_loop.stop()
server_thread.join()

print(&quot;done&quot;)
</code></pre>
<p>とりあえずこんな感じを予定。
./sample/sample.pyでシンタックスエラーが出なくなるところまで確認。
tornado_msgpackを順次実装していく。
Tornado Reference - http://www.tornadoweb.org/en/stable/
だいたい動くようになった。
$ ./sample/sample
connected
&lt;_MainThread(MainThread, started 140102020679424)&gt;:send 9 bytes
&lt;Thread(Thread-1, started 140101931136768)&gt;:on_read
&lt;Thread(Thread-1, started 140101931136768)&gt;:send 48 bytes
&lt;Thread(Thread-2, started 140101918488320)&gt;:on_read
on_receive:[1, 1, True, 'add() takes exactly 2 arguments (1 given)']
&lt;_MainThread(MainThread, started 140102020679424)&gt;:send 10 bytes
&lt;Thread(Thread-1, started 140101931136768)&gt;:on_read
&lt;Thread(Thread-1, started 140101931136768)&gt;:send 5 bytes
&lt;Thread(Thread-2, started 140101918488320)&gt;:on_read
on_receive:[1, 2, False, 3]
&lt;_MainThread(MainThread, started 140102020679424)&gt;:send 11 bytes
&lt;Thread(Thread-1, started 140101931136768)&gt;:on_read
&lt;Thread(Thread-1, started 140101931136768)&gt;:send 59 bytes
&lt;Thread(Thread-2, started 140101918488320)&gt;:on_read
on_receive:[1, 3, True, 'add() takes exactly 2 positional arguments (3 given)']
stop client...
stop server...
done</p>
<p>サーバースレッドのioloopと、クライアントスレッドのioloopが相互にやり取りしている感じでちゃんと動いている。</p>

</div>

<nav class="toc">


</nav>
</div>
</main>

    <footer class="footer">Powered by <a href="https://www.getzola.org/">Zola</a> <a href="https://github.com/ousttrue/zola/tree/custom">custom</a></footer>

  </body>
</html>
