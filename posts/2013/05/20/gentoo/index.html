<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="generator" content="Nikola (getnikola.com)">
<meta name="viewport" content="width=device-width">
<script src="../../../../../assets/js/all-nocdn.js"></script><title>Gentoo再構築 | 三次元日誌</title>
<link href="../../../../../assets/css/code.css" rel="stylesheet" type="text/css">
<link href="../../../../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
</head>
<body>
    <h1 id="brand">
        <a href="../../../../../" title="三次元日誌" rel="home">
            <span id="blog-title">三次元日誌</span>
        </a>
    </h1>

    <nav id="menu"><ul>
<li><a href="../../../../../archive.html">Archives</a></li>
<li><a href="../../../../../categories/index.html">Tags</a></li>
<li><a href="../../../../../rss.xml">RSS feed</a></li>
<li><a href="../../../../../about">About</a></li>
<li><a href="../../../../../books">MemoBooks</a></li>

            
            
            
        </ul></nav><hr>
<main id="content"><h1 class="p-name entry-title" itemprop="headline name">
    <h1 class="p-name entry-title" itemprop="headline name">
    <a href="." class="u-url">Gentoo再構築
    </a>
</h1>
<ul itemprop="keywords" class="tags">
<li>
        <time datetime="2013-05-20T00:00:00+09:00" title="2013-05-20">2013-05-20</time>
</li>
    <li><a class="tag p-category" href="../../../../../categories/linux/" rel="tag">linux</a></li>
</ul>
</h1>

<h2>Gentoo再構築</h2>
<p>gentooのルートファイルシステムに10Gを割り当てていたのだがいつのまにかディスクフルになってしまった。
portageとhomeをmountしていたので大丈夫かと思っていたのだが意外と容量を使ってしまっていた様子。
いろいろインストールしすぎなのかもしれぬ。
とりあえず/var/logの大きいファイルをxzして急場を凌いだが、
パーティションの割り方の都合で拡大できないので新しく作り直すことにした。</p>
<h3>作業記録。</h3>
<h4>ファイルシステム準備</h4>
<pre class="code literal-block"># lvcreate -L 100G -n gentoo_root mygroup
# mkfs.ext4 /dev/mygroup/gentoo_root
# cd /mnt
# mkdir gentoo
# mount /dev/mygroup/gentoo_root
</pre>
<h4>Installing the Gentoo Installation Files</h4>
<p><a href="http://www.gentoo.org/doc/en/handbook/handbook-amd64.xml?part=1&amp;chap=5">http://www.gentoo.org/doc/en/handbook/handbook-amd64.xml?part=1&amp;chap=5</a></p>
<p>stage3ファイルの取得と展開</p>
<pre class="code literal-block"># cd /mnt/gentoo
# wget http://ftp.jaist.ac.jp/pub/Linux/Gentoo/releases/amd64/current-stage3/stage3-amd64-20130516.tar.bz2
# tar xvjpf stage3-*.tar.bz2
</pre>
<p>portageは旧パーティションを流用</p>
<pre class="code literal-block"># mkdir usr/portage
# mount /dev/mygroup/portage usr/portage

/etc/portage/make.conf
# These settings were set by the catalyst build script that automatically
# built this stage.
# Please consult /usr/share/portage/config/make.conf.example for a more
# detailed example.
CFLAGS="-march=native -O2 -pipe"
#CFLAGS="-march=bdver2 -O2 -pipe"
CXXFLAGS="<span class="cp">${</span><span class="n">CFLAGS</span><span class="cp">}</span>"
# WARNING: Changing your CHOST is not something that should be done lightly.
# Please consult http://www.gentoo.org/doc/en/change-chost.xml before changing.
CHOST="x86_64-pc-linux-gnu"
# These are the USE flags that were used in addition to what is provided by the
# profile used for building.
USE=""
USE="<span class="nv">$USE</span> -ldap"
USE="<span class="nv">$USE</span> mmx sse sse2 sse3 ssse3"
USE="<span class="nv">$USE</span> openal alsa gstreamer phonon pulseaudio xft xnest"
USE="<span class="nv">$USE</span> gtk gnome xfce imlib gconf"
USE="<span class="nv">$USE</span> qt4 kde"
USE="<span class="nv">$USE</span> gd imlib eigen"
USE="<span class="nv">$USE</span> sqlite apache2"
USE="<span class="nv">$USE</span> ffmpeg theora lame mms"
USE="<span class="nv">$USE</span> samba fuse udisks"
USE="<span class="nv">$USE</span> icu"
USE="<span class="nv">$USE</span> consolekit dbus pam policykit udev"
USE="<span class="nv">$USE</span> c++0x"

INPUT_DEVICES="evdev"
#VIDEO_CARDS="radeon"
VIDEO_CARDS="fglrx"
LINGUAS="ja"

MAKEOPTS="-j5"
GENTOO_MIRRORS="http://ftp.iij.ad.jp/pub/linux/gentoo/ ftp://ftp.iij.ad.jp/pub/linux/gentoo/ http://ftp.jaist.ac.jp/pub/Linux/Gentoo/"
</pre>
<p>CFLAGSに-march=nativeを使えるようになった</p>
<h4>Installing the Gentoo Base System</h4>
<p><a href="http://www.gentoo.org/doc/en/handbook/handbook-amd64.xml?part=1&amp;chap=6">http://www.gentoo.org/doc/en/handbook/handbook-amd64.xml?part=1&amp;chap=6</a></p>
<pre class="code literal-block"><span class="c1"># cp -L /etc/resolv.conf /mnt/gentoo/etc/</span>
<span class="c1"># mount -t proc none /mnt/gentoo/proc</span>
<span class="c1"># mount --rbind /sys /mnt/gentoo/sys</span>
<span class="c1"># mount --rbind /dev /mnt/gentoo/dev</span>

<span class="c1"># chroot /mnt/gentoo /bin/bash</span>
<span class="c1"># source /etc/profile</span>
<span class="c1"># export PS1="(chroot) $PS1"</span>

<span class="c1"># emerge --sync</span>
<span class="c1"># cp /usr/share/zoneinfo/Asia/Tokyo /etc/localtime</span>
<span class="c1"># echo "Asia/Tokyo" &gt; /etc/timezone</span>
</pre>
<h4>Configuring the Kernel</h4>
<p><a href="http://www.gentoo.org/doc/en/handbook/handbook-amd64.xml?part=1&amp;chap=7">http://www.gentoo.org/doc/en/handbook/handbook-amd64.xml?part=1&amp;chap=7</a></p>
<pre class="code literal-block"># emerge gentoo-sources
</pre>
<p>LVMからブートするのでgenkernelを使う</p>
<pre class="code literal-block"># emerge genkernel
# genkernel --lvm --install all
</pre>
<h4>Configuring your System</h4>
<p><a href="http://www.gentoo.org/doc/en/handbook/handbook-amd64.xml?part=1&amp;chap=8">http://www.gentoo.org/doc/en/handbook/handbook-amd64.xml?part=1&amp;chap=8</a></p>
<h4>Installing Necessary System Tools</h4>
<p><a href="http://www.gentoo.org/doc/en/handbook/handbook-amd64.xml?part=1&amp;chap=9">http://www.gentoo.org/doc/en/handbook/handbook-amd64.xml?part=1&amp;chap=9</a></p>
<h4>Configuring the Bootloader</h4>
<p><a href="http://www.gentoo.org/doc/en/handbook/handbook-amd64.xml?part=1&amp;chap=10">http://www.gentoo.org/doc/en/handbook/handbook-amd64.xml?part=1&amp;chap=10</a></p>
<p>/boot/grub/menu.lst</p>
<pre class="code literal-block">title genkernel 3.8.13
root (hd0,0)
kernel /boot/kernel-genkernel-x86_64-3.8.13-gentoo real_root=/dev/mygroup/gentoo_root rootfstype=ext4 dolvm
initrd /boot/initramfs-genkernel-x86_64-3.8.13-gentoo
</pre>

<hr>
<ul class="pager hidden-print">
<li class="previous">
        <a href="../../19/call-with-tuple/" rel="prev" title="msgpack-rpc-asioの関数登録と実行">
            msgpack-rpc-asioの関数登録と実行 👈
        </a>
    </li>
    <li style="flex-grow: 1">
    <li class="next">
        <a href="../../21/xorg/" rel="next" title="xorgインストール">
            👉 xorgインストール
        </a>
    </li>
</ul></main><footer id="footer"><p>
            Powered by
            <a href="https://getnikola.com" rel="nofollow">Nikola</a>
        </p>
    </footer>
</body>
</html>
