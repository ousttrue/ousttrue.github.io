<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="generator" content="Nikola (getnikola.com)">
<meta name="viewport" content="width=device-width">
<script src="../../../../../assets/js/all-nocdn.js"></script><title>msgpack-rpcのasio版を作成中 | 三次元日誌</title>
<link href="../../../../../assets/css/code.css" rel="stylesheet" type="text/css">
<link href="../../../../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
</head>
<body>
    <h1 id="brand">
        <a href="../../../../../" title="三次元日誌" rel="home">
            <span id="blog-title">三次元日誌</span>
        </a>
    </h1>
    <hr>
<main id="content"><h1 class="p-name entry-title" itemprop="headline name">
    <a href="." class="u-url">msgpack-rpcのasio版を作成中</a>
</h1>
<div>
<p>msgpack-rpcのasio版を作成中
連休から始めていたmsgpack-rpcのバックエンドをasioに置き換えてWindowsでも動くようにする試みがやっと目処が立った。</p>
<p><a href="https://github.com/ousttrue/msgpack-asiorpc">https://github.com/ousttrue/msgpack-asiorpc</a></p>
<p>改め</p>
<p><a href="https://github.com/ousttrue/msgpack-rpc-asio">https://github.com/ousttrue/msgpack-rpc-asio</a></p>
<p>当初は <code>msgpack-rpc</code> のバックエンドの <code>mpio</code> に <code>asio</code> の <code>kernel</code> を追加することで乗り切ろうとしたのだが、わりとすぐに頓挫した。
<code>mpio</code> のファイルディスクリプタでIOを管理するAPIがasioと合わないのですな。
次に、 <code>msgpack-rpc</code> の <code>mp::wavy::loop</code> をasioをラップしたクラスで置き換える作戦で
進めていたのだがだいぶ改造して構造が見えてきたところで、 <code>asio</code> との設計の違いをラップするのがめんどくさく
なってまた頓挫した。 <a href="http://dev.activebasic.com/egtra/2011/10/27/449/">http://dev.activebasic.com/egtra/2011/10/27/449/</a>
を見ると簡単そうに見えるのだが功夫が足らないようだ。
で、上記の反省を踏まえて <code>asio</code> で <code>msgpack-rpc</code> を自由に実装することにした。
バイナリデータと <code>msgpack-rpc</code> の変換部分に <code>msgpack-rpc</code> のコードを借用して、
ネットワーク通信部分は <code>asio</code> で普通に作成した。
だいたいこんな感じのAPIになる予定。 </p>
<pre class="code literal-block"><span></span><span class="k">static</span> <span class="kt">int</span> <span class="nf">server_method</span><span class="p">(</span><span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">a</span><span class="o">+</span><span class="n">b</span><span class="p">;</span> <span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span> <span class="p">{</span> 
    <span class="kt">int</span> <span class="n">port</span><span class="o">=</span><span class="mi">18080</span><span class="p">;</span>
    <span class="c1">// server</span>
    <span class="n">boost</span><span class="o">::</span><span class="n">io_service</span> <span class="n">server_io</span><span class="p">;</span>
    <span class="n">msgpack</span><span class="o">::</span><span class="n">asiorpc</span><span class="o">::</span><span class="n">server</span> <span class="n">s</span><span class="p">(</span><span class="n">server_io</span><span class="p">);</span>
    <span class="n">s</span><span class="p">.</span><span class="n">add_handler</span><span class="p">(</span><span class="o">&amp;</span><span class="n">server_method</span><span class="p">,</span> <span class="s">"add"</span><span class="p">);</span>
    <span class="n">s</span><span class="p">.</span><span class="n">start</span><span class="p">(</span><span class="n">boost</span><span class="o">::</span><span class="n">asio</span><span class="o">::</span><span class="n">ip</span><span class="o">::</span><span class="n">tcp</span><span class="o">::</span><span class="n">endpoint</span><span class="p">(</span><span class="n">boost</span><span class="o">::</span><span class="n">asio</span><span class="o">::</span><span class="n">ip</span><span class="o">::</span><span class="n">tcp</span><span class="o">::</span><span class="n">v4</span><span class="p">(),</span> <span class="n">port</span><span class="p">));</span>
    <span class="n">boost</span><span class="o">::</span><span class="kr">thread</span> <span class="n">server_thread</span><span class="p">([</span><span class="o">&amp;</span><span class="n">server_io</span><span class="p">](){</span> <span class="n">server_io</span><span class="p">.</span><span class="n">run</span><span class="p">();</span> <span class="p">}</span>

    <span class="c1">// client</span>
    <span class="n">boost</span><span class="o">::</span><span class="n">io_service</span> <span class="n">client_io</span><span class="p">;</span>
    <span class="n">msgpack</span><span class="o">::</span><span class="n">asiorpc</span><span class="o">::</span><span class="n">session</span> <span class="n">c</span><span class="p">(</span><span class="n">server_io</span><span class="p">);</span> 
    <span class="n">c</span><span class="p">.</span><span class="n">connect</span><span class="p">(</span><span class="n">boost</span><span class="o">::</span><span class="n">asio</span><span class="o">::</span><span class="n">ip</span><span class="o">::</span><span class="n">tcp</span><span class="o">::</span><span class="n">endpoint</span><span class="p">(</span><span class="n">boost</span><span class="o">::</span><span class="n">asio</span><span class="o">::</span><span class="n">ip</span><span class="o">::</span><span class="n">address</span><span class="o">::</span><span class="n">from_string</span><span class="p">(</span><span class="s">"127.0.0.1"</span><span class="p">),</span> <span class="n">port</span><span class="p">);</span>
    <span class="n">boost</span><span class="o">::</span><span class="kr">thread</span> <span class="n">client_thread</span><span class="p">([</span><span class="o">&amp;</span><span class="n">client_io</span><span class="p">](){</span> <span class="n">client_io</span><span class="p">.</span><span class="n">run</span><span class="p">();</span> <span class="p">}</span>

    <span class="c1">// request</span>
    <span class="k">auto</span> <span class="n">request</span><span class="o">=</span><span class="n">c</span><span class="p">.</span><span class="n">call</span><span class="p">(</span><span class="s">"add"</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>

    <span class="c1">// blocking</span>
    <span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
    <span class="n">request</span><span class="p">.</span><span class="n">convert</span><span class="p">(</span><span class="o">&amp;</span><span class="n">result</span><span class="p">);</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">resut</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>

    <span class="c1">// finalize</span>
    <span class="n">client_io</span><span class="p">.</span><span class="n">stop</span><span class="p">();</span>
    <span class="n">client_thread</span><span class="p">.</span><span class="n">join</span><span class="p">();</span>

    <span class="n">server_io</span><span class="p">.</span><span class="n">stop</span><span class="p">();</span>
    <span class="n">server_thread</span><span class="p">.</span><span class="n">join</span><span class="p">();</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre>

<p>原型はだいたいできて <code>Windows</code> でも動いたので続きを作りこんで行きたい。
今のうちに <code>msgpack::asiorpc</code> のネームスペースを変えたいような気もするがどうしようかね。
<code>msgpack::rpc::asio</code> とかか？うぅむ。
あと、クラスを <code>UpperCamelCase</code> で、関数を <code>lowerCamelCase</code> に変えよう思っていたが
<code>boost</code> 、 <code>msgpack</code> と一緒に使うときの見栄えを考慮するとスケークケースも一理あるな。
クラス名と同じ変数名(<code>request</code>とか)を使いたいときに変数名をreq等に変えることを強いられることがあるのが
気に入らないところではあるのだが。
プロジェクト名を <code>msgpack-rpc-asio</code>
に変えてネームスペースも <code>msgpack::rpc::asio</code> に変えることに今決めた。</p>
</div>
    </main><footer id="footer"><p>
            Powered by
            <a href="https://getnikola.com" rel="nofollow">Nikola</a>
        </p>
    </footer>
</body>
</html>
