<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="generator" content="Nikola (getnikola.com)">
<meta name="viewport" content="width=device-width">
<script src="../../../../../assets/js/all-nocdn.js"></script><title>wafでdebugとreleaseの設定を記述する(variant) | 三次元日誌</title>
<link href="../../../../../assets/css/code.css" rel="stylesheet" type="text/css">
<link href="../../../../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
</head>
<body>
    <h1 id="brand">
        <a href="../../../../../" title="三次元日誌" rel="home">
            <span id="blog-title">三次元日誌</span>
        </a>
    </h1>

    <nav id="menu"><ul>
<li><a href="../../../../../archive.html">Archives</a></li>
<li><a href="../../../../../categories/index.html">Tags</a></li>
<li><a href="../../../../../rss.xml">RSS feed</a></li>
<li><a href="../../../../../about">About</a></li>
<li><a href="../../../../../books">MemoBooks</a></li>

            
            
            
        </ul></nav><hr>
<main id="content"><h1 class="p-name entry-title" itemprop="headline name">
    <h1 class="p-name entry-title" itemprop="headline name">
    <a href="." class="u-url">wafでdebugとreleaseの設定を記述する(variant)
    </a>
</h1>
<ul itemprop="keywords" class="tags">
<li>
        <time datetime="2013-10-29T00:00:00+09:00" title="2013-10-29">2013-10-29</time>
</li>
</ul>
</h1>

<p>wafでdebugとreleaseの設定を記述する(variant)
wafでdebug版とrelease版の出力を分けるにはvariantなる機能を使う。
+hello
  +hello.cpp
  +waf
  +wscript</p>
<p>と前回と同様のプロジェクト。 wscriptを以下のように記述する。</p>
<h2>coding: utf-8</h2>
<p>APPNAME='hello'
VERSION='1.0.0'</p>
<p>def configure(conf):
    # config 'debug'を作る
    conf.setenv('debug')
    # debugの設定
    conf.env['MSVC_TARGETS'] = ['x86']
    conf.load('msvc')
    conf.env.CXXFLAGS = ['/nologo', '/EHsc']
    # PDBやNDEBUG等の設定をきっちり書く必要がある</p>
<div class="code"><pre class="code literal-block"><span class="c1"># config 'release'を作る。debugの設定は引き継がない</span><span class="w"></span>
<span class="n">conf</span><span class="o">.</span><span class="n">setenv</span><span class="p">(</span><span class="s1">'release'</span><span class="p">)</span><span class="w"></span>
<span class="c1"># releaseの設定</span><span class="w"></span>
<span class="n">conf</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">'MSVC_TARGETS'</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s1">'x86'</span><span class="p">]</span><span class="w"></span>
<span class="n">conf</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">'msvc'</span><span class="p">)</span><span class="w"></span>
<span class="n">conf</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">CXXFLAGS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s1">'/nologo'</span><span class="p">,</span><span class="w"> </span><span class="s1">'/EHsc'</span><span class="p">]</span><span class="w"></span>
</pre></div>

<h2>BuildContextの設定</h2>
<p>def build(bld):
    bld.program(
            source='hello.cpp',
            target=APPNAME
            )</p>
<p>from waflib.Build import BuildContext</p>
<h2>BuildContextを使うコマンド</h2>
<p>class BuildDebug(BuildContext):
    # config 'debug' を使うvariant
    # 出力ディレクトリがbuild/debugに変わる
    variant = "debug"
    # 呼び出しコマンドはbuild_debug
    cmd = "build_debug"</p>
<h2>BuildContextを使うコマンド</h2>
<p>class BuildRelease(BuildContext):
    # config 'release' を使うvariant
    # 出力ディレクトリがbuild/releaseに変わる
    variant = "release"
    # 呼び出しコマンドはbuild_release
    cmd = "build_release"</p>
<p>variantという概念を使う。
http://docs.waf.googlecode.com/git/book_17/single.html の 6.2.2.
Changing the output directory Configuration sets for variants
に記述がある。
使う</p>
<blockquote>
<p>python waf --help
waf [commands] [options]</p>
</blockquote>
<p>Main commands (example: ./waf build -j4)
  build        : executes the build
  build_debug  :
  build_release:
:
:
省略</p>
<p>という感じでbuild_debug, build_releaseが増える。</p>
<blockquote>
<p>python waf build_debug
Waf: Entering directory <code>C:\work\_waf\debug_release\build\debug'
[1/2] cxx: hello.cpp -&gt; build\debug\hello.cpp.1.o
hello.cpp
[2/2] cxxprogram: build\debug\hello.cpp.1.o -&gt; build\debug\hello.exe build\debug\hello.exe.manifest
Waf: Leaving directory</code>C:\work_waf\debug_release\build\debug'
'build_debug' finished successfully (0.487s)</p>
</blockquote>
<p>素のビルドはエラーになった。たぶん対象になる名無しのconfigが存在しないため。</p>
<blockquote>
<p>python waf build
Waf: Entering directory <code>C:\work\_waf\debug_release\build'
[1/2] cxx: hello.cpp -&gt; build\hello.cpp.1.o
Waf: Leaving directory</code>C:\work_waf\debug_release\build'
Build failed
:
:
省略</p>
</blockquote>
<p>ということで素のビルドの時にメッセージを表示して止めるようにする。
buildメソッドの先頭にwaf book通りの記述を入れる。</p>
<h2>BuildContextの設定</h2>
<p>def build(bld):
    if not bld.variant:
         bld.fatal('call "waf build_debug" or "waf build_release", and try "waf --help"')
    bld.program(
            source='hello.cpp',
            target=APPNAME
            )</p>
<blockquote>
<p>python waf build
Waf: Entering directory `C:\work_waf\debug_release\build'
call "waf build_debug" or "waf build_release", and try "waf --help"
python waf clean
call "waf build_debug" or "waf build_release", and try "waf --help"</p>
</blockquote>
<p>build以外にもbuildメソッド(BuildContext)を使うコマンドがあって、
http://docs.waf.googlecode.com/git/book_17/single.html の 12.1.2.
Context classes のクラス図によると ListContext, CleanContext,
StepContext, InstallContext, UninstallContext
がBuildContextを継承しているのでこれに対応するコマンド
それぞれにdebug版、release版を定義してやる必要がある。
waf bookに書いてあるようにコマンドclassの記述を変える。
from waflib.Build import BuildContext, ListContext, CleanContext, StepContext, InstallContext, UninstallContext</p>
<p>CONTEXTS=[BuildContext, ListContext, CleanContext, StepContext, InstallContext, UninstallContext]
VARIANTS=['debug', 'release']</p>
<p>for context in CONTEXTS:
    for variant_name in VARIANTS:
        name = context.<strong>name</strong>.replace('Context','').lower()
        class tmp(context):
            cmd = name + '_' + variant_name
            variant = variant_name</p>
<p>helpを見ると大量に定義したコマンドが増える。</p>
<blockquote>
<p>python waf --help
waf [commands] [options]</p>
</blockquote>
<p>Main commands (example: ./waf build -j4)
  build            : executes the build
  build_debug      :
  build_release    :
  clean            : cleans the project
  clean_debug      :
  clean_release    :
  configure        : configures the project
  dist             : makes a tarball for redistributing the sources
  distcheck        : checks if the project compiles (tarball from 'dist')
  distclean        : removes the build directory
  install          : installs the targets on the system
  install_debug    :
  install_release  :
  list             : lists the targets to execute
  list_debug       :
  list_release     :
  step             : executes tasks in a step-by-step fashion, for debugging
  step_debug       :
  step_release     :
  uninstall        : removes the targets installed
  uninstall_debug  :
  uninstall_release:
  update           : updates the plugins from the <em>waflib/extras</em> directory
:
:
省略</p>
<blockquote>
<p>python waf clean_debug build_debug
'clean_debug' finished successfully (0.087s)
Waf: Entering directory <code>C:\work\_waf\debug_release\build\debug'
[1/2] cxx: hello.cpp -&gt; build\debug\hello.cpp.1.o
hello.cpp
[2/2] cxxprogram: build\debug\hello.cpp.1.o -&gt; build\debug\hello.exe build\debug\hello.exe.manifest
Waf: Leaving directory</code>C:\work_waf\debug_release\build\debug'
'build_debug' finished successfully (0.451s)</p>
</blockquote>
<p>これでdebug, releaseの使い分けはできるようになった。
variantを追加する
64bitビルドや、gccのvariantを追加してみた。</p>
<h2>coding: utf-8</h2>
<p>APPNAME='hello'
VERSION='1.0.0'</p>
<p>VARIANTS=[
'vc_debug', 'vc_release', 'vc64_debug', 'vc64_release',
'gcc_debug', 'gcc_release',
]</p>
<p>def configure(conf):
    # config 'debug'を作る
    conf.setenv('debug')
    # debugの設定
    conf.env['MSVC_VERSIONS'] = ['msvc 10.0']
    conf.env['MSVC_TARGETS'] = ['x86']
    conf.load('msvc')
    conf.env.CXXFLAGS = ['/nologo', '/EHsc']
    # PDBやNDEBUG等の設定をきっちり書く必要がある</p>
<div class="code"><pre class="code literal-block"><span class="c1"># config 'release'を作る。debugの設定は引き継がない</span><span class="w"></span>
<span class="n">conf</span><span class="o">.</span><span class="n">setenv</span><span class="p">(</span><span class="s1">'release'</span><span class="p">)</span><span class="w"></span>
<span class="c1"># releaseの設定</span><span class="w"></span>
<span class="n">conf</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">'MSVC_VERSIONS'</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s1">'msvc 10.0'</span><span class="p">]</span><span class="w"></span>
<span class="n">conf</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">'MSVC_TARGETS'</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s1">'x86'</span><span class="p">]</span><span class="w"></span>
<span class="n">conf</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">'msvc'</span><span class="p">)</span><span class="w"></span>
<span class="n">conf</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">CXXFLAGS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s1">'/nologo'</span><span class="p">,</span><span class="w"> </span><span class="s1">'/EHsc'</span><span class="p">]</span><span class="w"></span>

<span class="c1"># config 'debug'を作る</span><span class="w"></span>
<span class="n">conf</span><span class="o">.</span><span class="n">setenv</span><span class="p">(</span><span class="s1">'vc64_debug'</span><span class="p">)</span><span class="w"></span>
<span class="c1"># debugの設定</span><span class="w"></span>
<span class="n">conf</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">'MSVC_VERSIONS'</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s1">'msvc 10.0'</span><span class="p">]</span><span class="w"></span>
<span class="n">conf</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">'MSVC_TARGETS'</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s1">'x64'</span><span class="p">]</span><span class="w"></span>
<span class="n">conf</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">'msvc'</span><span class="p">)</span><span class="w"></span>
<span class="n">conf</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">CXXFLAGS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s1">'/nologo'</span><span class="p">,</span><span class="w"> </span><span class="s1">'/EHsc'</span><span class="p">]</span><span class="w"></span>
<span class="c1"># PDBやNDEBUG等の設定をきっちり書く必要がある</span><span class="w"></span>

<span class="c1"># config 'release'を作る。debugの設定は引き継がない</span><span class="w"></span>
<span class="n">conf</span><span class="o">.</span><span class="n">setenv</span><span class="p">(</span><span class="s1">'vc64_release'</span><span class="p">)</span><span class="w"></span>
<span class="c1"># releaseの設定</span><span class="w"></span>
<span class="n">conf</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">'MSVC_VERSIONS'</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s1">'msvc 10.0'</span><span class="p">]</span><span class="w"></span>
<span class="n">conf</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">'MSVC_TARGETS'</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s1">'x64'</span><span class="p">]</span><span class="w"></span>
<span class="n">conf</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">'msvc'</span><span class="p">)</span><span class="w"></span>
<span class="n">conf</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">CXXFLAGS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s1">'/nologo'</span><span class="p">,</span><span class="w"> </span><span class="s1">'/EHsc'</span><span class="p">]</span><span class="w"></span>

<span class="c1"># config 'debug'を作る</span><span class="w"></span>
<span class="n">conf</span><span class="o">.</span><span class="n">setenv</span><span class="p">(</span><span class="s1">'gcc_debug'</span><span class="p">)</span><span class="w"></span>
<span class="c1"># debugの設定</span><span class="w"></span>
<span class="n">conf</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">'gxx'</span><span class="p">)</span><span class="w"></span>
<span class="n">conf</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">CXXFLAGS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s1">'-g'</span><span class="p">]</span><span class="w"></span>
<span class="n">conf</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">LINKFLAGS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s1">'-g'</span><span class="p">]</span><span class="w"></span>

<span class="c1"># config 'release'を作る。debugの設定は引き継がない</span><span class="w"></span>
<span class="n">conf</span><span class="o">.</span><span class="n">setenv</span><span class="p">(</span><span class="s1">'gcc_release'</span><span class="p">)</span><span class="w"></span>
<span class="c1"># releaseの設定</span><span class="w"></span>
<span class="n">conf</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">'gxx'</span><span class="p">)</span><span class="w"></span>
<span class="n">conf</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">CXXFLAGS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s1">'-O2'</span><span class="p">]</span><span class="w"></span>
</pre></div>

<h2>BuildContextの設定</h2>
<p>def build(bld):
    if not bld.variant:
         bld.fatal('call "waf build_debug" or "waf build_release", and try "waf --help"')
    bld.program(
            source='hello.cpp',
            target=APPNAME
            )</p>
<p>from waflib.Build import BuildContext, ListContext, CleanContext, StepContext, InstallContext, UninstallContext</p>
<p>CONTEXTS=[BuildContext, ListContext, CleanContext, StepContext, InstallContext, UninstallContext]</p>
<p>for context in CONTEXTS:
    for variant_name in VARIANTS:
        name = context.<strong>name</strong>.replace('Context','').lower()
        class tmp(context):
            cmd = name + '_' + variant_name
            variant = variant_name</p>

<hr>
<ul class="pager hidden-print">
<li class="previous">
        <a href="../waf/" rel="prev" title="pythonによるビルドスクリプトwafを使い始めた">
            pythonによるビルドスクリプトwafを使い始めた 👈
        </a>
    </li>
    <li style="flex-grow: 1">
    <li class="next">
        <a href="../../../11/25/win8/" rel="next" title="Windows8導入">
            👉 Windows8導入
        </a>
    </li>
</ul></main><footer id="footer"><p>
            Powered by
            <a href="https://getnikola.com" rel="nofollow">Nikola</a>
        </p>
    </footer>
</body>
</html>
