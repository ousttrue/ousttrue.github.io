<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="generator" content="Nikola (getnikola.com)">
<meta name="viewport" content="width=device-width">
<script src="../../../../../assets/js/all-nocdn.js"></script><title>Irrlichtã«MsgPackRPCã‚’ä»•è¾¼ã‚€ | ä¸‰æ¬¡å…ƒæ—¥èªŒ</title>
<link href="../../../../../assets/css/code.css" rel="stylesheet" type="text/css">
<link href="../../../../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
</head>
<body>
    <h1 id="brand">
        <a href="../../../../../" title="ä¸‰æ¬¡å…ƒæ—¥èªŒ" rel="home">
            <span id="blog-title">ä¸‰æ¬¡å…ƒæ—¥èªŒ</span>
        </a>
    </h1>

    <nav id="menu"><ul>
<li><a href="../../../../../archive.html">Archives</a></li>
<li><a href="../../../../../categories/index.html">Tags</a></li>
<li><a href="../../../../../rss.xml">RSS feed</a></li>
<li><a href="../../../../../about">About</a></li>
<li><a href="../../../../../books">MemoBooks</a></li>

            
            
            
        </ul></nav><hr>
<main id="content"><h1 class="p-name entry-title" itemprop="headline name">
    <h1 class="p-name entry-title" itemprop="headline name">
    <a href="." class="u-url">Irrlichtã«MsgPackRPCã‚’ä»•è¾¼ã‚€
    </a>
</h1>
<ul itemprop="keywords" class="tags">
<li>
        <time datetime="2013-06-17T00:00:00+09:00" title="2013-06-17">2013-06-17</time>
</li>
</ul>
</h1>

<p>Irrlichtã«MsgPackRPCã‚’ä»•è¾¼ã‚€
Oculusã®é€šè²©ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒæ—©ãã‚‚Processingã«å¤‰ã‚ã£ã¦å±Šãã®ãŒæ¥½ã—ã¿ãªä»Šæ—¥ã“ã®é ƒã€‚
ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã‚¨ãƒ³ã‚¸ãƒ³ã«ã¯Irrlichtã‚’é¸æŠã—ãŸã®ã§ã‚ã‚‹ãŒã€
ãã®ã¾ã¾ã ã¨ã‚·ãƒ¼ãƒ³ã‚’æ§‹ç¯‰ã™ã‚‹ã¨ã‹è«¸ã€…ã®ä½œæ¥­ãŒC++ç›´å©ãã«ãªã‚‹ã€‚
ã“ã‚Œã ã¨ã•ã™ãŒã«å¤§å¤‰ãªã®ã§MsgPackRPCã§ãƒ©ãƒƒãƒ—ã—ã¦å¤–éƒ¨ã®ãƒ„ãƒ¼ãƒ«ã‹ã‚‰
æ“ä½œã—ã‚ˆã†ã¨æ§‹æƒ³ã—ã¦ãŠã£ãŸã®ã ãŒå§‹ã‚ã¦ã¿ã‚‹ã¨æ—©é€Ÿå•é¡Œã«çªãå½“ãŸã£ãŸã€‚
ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ç”Ÿæˆã—ã¦ãã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ã‚³ãƒ¼ãƒ«ã™ã‚‹ã®ã«ã©ã†ã™ã‚Œã°ã„ã„ã®ã‹ã€‚
ã“ã†ã„ã†å ´åˆã ã€‚
IMesh *mesh=CreateMesh("miku.pmd");
mesh-&gt;SetPosition(0, 0, 5);</p>
<p>MsgPackRPCçµŒç”±ã ã¨ä»¥ä¸‹ã®ã‚ˆã†ãªæ„Ÿã˜ã‹ã€‚</p>
<h2>pythonã¨ã‹ãã†ã„ã†ã®</h2>
<p>client=msgpac.rpc.client()
mesh=client.call("CreateMesh", "miku.pmd")
client.call("Mesh_SetPosition", mesh, 0, 0, 5)</p>
<p>1ã¤ã‚ã®CreateMeshã¯ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã‹ã‚·ãƒ³ã‚°ãƒ«ãƒˆãƒ³çš„ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ¡ã‚½ãƒƒãƒ‰å‘¼ã³å‡ºã—ã«ãªã‚‹ã®ã§ç‰¹ã«å•é¡Œã¯ç„¡ã„ã€‚
2ã¤ã‚ã¯SetPositionã®thisã¨ã—ã¦meshã‚’é€ã£ã¦ã‚„ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚
ã“ã“ã§msgpackçš„ã«ã¯IMesh<em>ã‚’ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚º/ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã™ã‚‹ã“ã¨ãŒå¿…è¦ã«ãªã‚‹ã€‚
æ¡ˆï¼‘ ãƒã‚¤ãƒ³ã‚¿ã‚’æ•´æ•°å€¤ã¨ã—ã¦ã‚­ãƒ£ã‚¹ãƒˆã™ã‚Œã°ã„ã„ã˜ã‚ƒãªã„
template <typename stream>
inline packer<stream>&amp; operator&lt;&lt; (packer<stream>&amp; o, IMesh </stream></stream></typename></em>v)
{
    // ãƒã‚¤ãƒ³ã‚¿ã‚’intã«ã‚­ãƒ£ã‚¹ãƒˆ
    o.pack((int)v);
    return o;
}</p>
<p>inline IMesh <em>v operator&gt;&gt; (object o, IMesh</em> v)
{
    unsigned int p;
    o.convert(&amp;p):</p>
<div class="code"><pre class="code literal-block"><span class="o">//</span><span class="w"> </span><span class="nv">int</span>ã‚’ãƒã‚¤ãƒ³ã‚¿ã«ã‚­ãƒ£ã‚¹ãƒˆ<span class="w"></span>
<span class="nv">v</span><span class="o">=</span><span class="ss">(</span><span class="nv">IMesh</span><span class="o">*</span><span class="ss">)</span><span class="nv">p</span><span class="c1">;</span><span class="w"></span>

<span class="k">return</span><span class="w"> </span><span class="nv">v</span><span class="c1">;</span><span class="w"></span>
</pre></div>

<p>}</p>
<p>ã•ã™ãŒã«ãƒ¯ã‚¤ãƒ«ãƒ‰ã™ãã‚‹ã€‚ã¨ã„ã†ã‹ãƒã‚¤ãƒ³ã‚¿ãŒæ—¢ã«é–‹æ”¾ã•ã‚Œã¦ã„ã‚‹å ´åˆã«ãªã™ã™ã¹ãŒç„¡ã„ã®ã§æ²¡
æ¡ˆï¼’ é©å½“ã«ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªIDã‚’æŒ¯ã‚‹
template <typename stream>
inline packer<stream>&amp; operator&lt;&lt; (packer<stream>&amp; o, IMesh *v)
{
    // ãƒã‚¤ãƒ³ã‚¿ã®uidå€¤
    o.pack(v-&gt;uid());
    return o;
}</stream></stream></typename></p>
<p>inline IMesh <em>v operator&gt;&gt; (object o, IMesh</em> v)
{
    unsigned int uid;
    o.convert(&amp;uid):</p>
<div class="code"><pre class="code literal-block"><span class="o">//</span><span class="w"> </span><span class="nt">uidå€¤ã‹ã‚‰ãƒã‚¤ãƒ³ã‚¿ã‚’å¾—ã‚‹</span><span class="w"></span>
<span class="nt">v</span><span class="o">=</span><span class="nt">IMesh</span><span class="p">::</span><span class="nd">get_from_uid</span><span class="o">(</span><span class="nt">uid</span><span class="o">);</span><span class="w"></span>

<span class="nt">return</span><span class="w"> </span><span class="nt">v</span><span class="o">;</span><span class="w"></span>
</pre></div>

<p>}</p>
<p>Irrlichtã ã¨æœ¬ä½“å´ã«æ”¹é€ ãŒè¦ã‚‹ã‘ã©ã“ã‚Œã§ã„ã£ã¦ã¿ã‚‹ã‹ã€‚
template<typename t>
class IDGenerator
{
    unsigned int m_uid;</typename></p>
<p>public:
    IDGenerator():m_uid(generate_uid())
    {
        m_uid_map.insert(std::make_pair(m_uid, this));
    }</p>
<div class="code"><pre class="code literal-block"><span class="n">unsigned</span><span class="w"> </span><span class="nb nb-Type">int</span><span class="w"> </span><span class="n">uid</span><span class="p">()</span><span class="k">const</span><span class="w"> </span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">m_uid</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>

<p>////////////////////
// static
////////////////////
private:
    static unsigned int m_next_uid=1;
    static std::hash_map<unsigned int t> m_uid_map;
public:
    static unsigned int generate_uid(){ 
        return m_next_uid++; 
    }</unsigned></p>
<div class="code"><pre class="code literal-block"><span class="n">statc</span><span class="w"> </span><span class="n">T</span><span class="o">*</span><span class="w"> </span><span class="n">get_from_uid</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="n">int</span><span class="w"> </span><span class="n">uid</span><span class="p">){</span><span class="w"></span>
<span class="w">    </span><span class="n">auto</span><span class="w"> </span><span class="n">found</span><span class="o">=</span><span class="n">m_uid_map</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">uid</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="nf">if</span><span class="p">(</span><span class="n">found</span><span class="o">==</span><span class="n">m_uid_map</span><span class="p">.</span><span class="kd">end(</span><span class="p">)){</span><span class="w"></span>
<span class="w">        </span><span class="kr">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="kr">return</span><span class="w"> </span><span class="n">found</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>

<p>};</p>
<p>// ç¶™æ‰¿éšå±¤ã®IReferenceCountedã®ä¸‹ã‚ãŸã‚Šã«ã“ã‚“ãªæ„Ÿã˜ã§ä»‹å…¥ã™ã‚‹äºˆå®š
class IMesh : public virtual IReferenceCounted, public IDGenerator<imesh>
{
};</imesh></p>
<p>ã†ã¾ãã„ãã‹ã‚„ã£ã¦ã¿ã‚‹ã¨ã—ã‚ˆã†ã€‚
æ›¸ã„ã¦ã¿ãŸ
è‡ªç”±ã«æ›¸ã„ã¦ã¿ãŸã‚‰ã“ã†ãªã£ãŸã€‚templateã‚¯ãƒ©ã‚¹ã®ã‚¹ã‚¿ãƒ†ã‚£ãƒƒã‚¯ãƒ¡ãƒ³ãƒå¤‰æ•°ã®æ›¸ãæ–¹ã‚’å­¦ã‚“ã ã€‚
http://d.hatena.ne.jp/higepon/20100803/1280834422
template<typename t>
class IDGenerator
{
    struct Deleter{
        unsigned int m_uid;</typename></p>
<div class="code"><pre class="code literal-block">    Deleter(unsigned int uid): m_uid(uid){}
    ~Deleter(){ remove_from_map(m_uid); }
};
Deleter m_deleter;
unsigned int m_uid;
</pre></div>

<p>public:
    IDGenerator():m_uid(generate_uid()), m_deleter(m_uid)
    {
        s_uid_map[m_uid]=this;
    }</p>
<div class="code"><pre class="code literal-block"><span class="n">unsigned</span><span class="w"> </span><span class="nb nb-Type">int</span><span class="w"> </span><span class="n">uid</span><span class="p">()</span><span class="k">const</span><span class="w"> </span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">m_uid</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="o">////////////////////</span><span class="w"></span>
<span class="o">//</span><span class="w"> </span><span class="k">static</span><span class="w"></span>
<span class="o">////////////////////</span><span class="w"></span>
</pre></div>

<p>private:
    static core::map<unsigned int idgenerator> s_uid_map;
public:
    static unsigned int generate_uid(){ 
        static unsigned int next_uid=1;
        return next_uid++; 
    }</unsigned></p>
<div class="code"><pre class="code literal-block"><span class="nv">static</span><span class="w"> </span><span class="nv">T</span><span class="o">*</span><span class="w"> </span><span class="nv">get_from_uid</span><span class="ss">(</span><span class="nv">unsigned</span><span class="w"> </span><span class="nv">int</span><span class="w"> </span><span class="nv">uid</span><span class="ss">)</span>{<span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nv">s_uid_map</span>.<span class="nv">find</span><span class="ss">(</span><span class="nv">uid</span><span class="ss">)</span><span class="c1">;</span><span class="w"></span>
}<span class="w"></span>

<span class="nv">static</span><span class="w"> </span><span class="nv">void</span><span class="w"> </span><span class="nv">remove_from_map</span><span class="ss">(</span><span class="nv">unsigned</span><span class="w"> </span><span class="nv">int</span><span class="w"> </span><span class="nv">uid</span><span class="ss">)</span>{<span class="w"></span>
<span class="w">    </span><span class="nv">s_uid_map</span>.<span class="nv">remove</span><span class="ss">(</span><span class="nv">uid</span><span class="ss">)</span><span class="c1">;</span><span class="w"></span>
}<span class="w"></span>
</pre></div>

<p>};
template <typename t> core::map<unsigned int idgenerator>*&gt; IDGenerator<t>::s_uid_map;</t></unsigned></typename></p>
<p>ã—ã‹ã—ã€ã“ã®è¨­è¨ˆã ã¨staticãƒ¡ãƒ³ãƒãŒdllå¢ƒç•Œã‚’è¶Šãˆã¦ï¼’ã¤å­˜åœ¨ã—ã¦ã†ã¾ãã„ã‹ãªã„ç½ ãŒã‚ã£ãŸã€‚æ²¡
æ¡ˆ3 é©å½“ã«ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªIDã‚’æŒ¯ã‚‹(éãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ)
irr::IReferenceCountedã‚’æ”¹é€ ã™ã‚‹ã€‚
å°è³¢ã—ã„templateã‚’ã‚„ã‚ã¦ã¹ãŸã«ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‚’éš è”½ã™ã‚‹æ–¹å¼ã‚’å°å…¥ã—ãŸã€‚
class IReferenceCounted
{
public:</p>
<div class="code"><pre class="code literal-block"><span class="c1">//! Constructor.</span>
<span class="n">IReferenceCounted</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="o">:</span><span class="w"> </span><span class="n">DebugName</span><span class="p">(</span><span class="mh">0</span><span class="p">),</span><span class="w"> </span><span class="n">ReferenceCounter</span><span class="p">(</span><span class="mh">1</span><span class="p">),</span><span class="w"> </span><span class="n">UID</span><span class="p">(</span><span class="n">get_uid</span><span class="p">())</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">register_uid</span><span class="p">(</span><span class="n">UID</span><span class="p">,</span><span class="w"> </span><span class="n">this</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="n">u32</span><span class="w"> </span><span class="n">uid</span><span class="p">(){</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">UID</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w"></span>

<span class="c1">//! Destructor.</span>
<span class="n">virtual</span><span class="w"> </span><span class="o">~</span><span class="n">IReferenceCounted</span><span class="p">()</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">unregister_uid</span><span class="p">(</span><span class="n">UID</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>

<p>// çœç•¥</p>
<p>};</p>
<h2>include "IDGenerator.h"</h2>
<h2>include "IReferenceCounted.h"</h2>
<h2>include "irrMap.h"</h2>
<p>namespace irr {</p>
<div class="code"><pre class="code literal-block"><span class="n">extern</span><span class="w"> </span><span class="s">"C"</span><span class="w"> </span><span class="n">IRRLICHT_API</span><span class="w"> </span><span class="n">u32</span><span class="w"> </span><span class="n">get_uid</span><span class="p">()</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">static</span><span class="w"> </span><span class="n">u32</span><span class="w"> </span><span class="n">uid</span><span class="o">=</span><span class="mh">1</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">uid</span><span class="o">++</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="n">static</span><span class="w"> </span><span class="n">core</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">u32</span><span class="p">,</span><span class="w"> </span><span class="n">IReferenceCounted</span><span class="o">*&gt;</span><span class="w"> </span><span class="n">g_map</span><span class="p">;</span><span class="w"></span>

<span class="n">extern</span><span class="w"> </span><span class="s">"C"</span><span class="w"> </span><span class="n">IRRLICHT_API</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="n">register_uid</span><span class="p">(</span><span class="n">u32</span><span class="w"> </span><span class="n">uid</span><span class="p">,</span><span class="w"> </span><span class="n">IReferenceCounted</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">g_map</span><span class="p">.</span><span class="n">set</span><span class="p">(</span><span class="n">uid</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="n">extern</span><span class="w"> </span><span class="s">"C"</span><span class="w"> </span><span class="n">IRRLICHT_API</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="n">unregister_uid</span><span class="p">(</span><span class="n">u32</span><span class="w"> </span><span class="n">uid</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">auto</span><span class="w"> </span><span class="n">found</span><span class="o">=</span><span class="n">g_map</span><span class="p">.</span><span class="n">remove</span><span class="p">(</span><span class="n">uid</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="n">extern</span><span class="w"> </span><span class="s">"C"</span><span class="w"> </span><span class="n">IRRLICHT_API</span><span class="w"> </span><span class="n">IReferenceCounted</span><span class="o">*</span><span class="w"> </span><span class="n">get_from_uid</span><span class="p">(</span><span class="n">u32</span><span class="w"> </span><span class="n">uid</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">auto</span><span class="w"> </span><span class="n">found</span><span class="o">=</span><span class="n">g_map</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">uid</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">found</span><span class="p">){</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mh">0</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">found</span><span class="o">-&gt;</span><span class="n">getValue</span><span class="p">();</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>

<p>}</p>
<p>å‹•ä½œç¢ºèªã§ããŸã€‚
ã“ã“ã¾ã§ã®ä½œæ¥­ã§MsgPackRPCã‚’ä½¿ã£ãŸIrrlichtã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã«ã¤ã„ã¦è¦‹é€šã—ã‚’å¾—ã‚‹ã“ã¨ãŒã§ããŸã€‚
Pythonã‚„Luaã‹ã‚‰ä½¿ãˆã‚‹ã‚ˆã†ã«ã™ã‚‹ã®ã¨åŒã˜ã‚ˆã†ãªä½œæ¥­ã§ãƒªãƒ¢ãƒ¼ãƒˆã‹ã‚‰é–¢æ•°ã‚’ã‚³ãƒ¼ãƒ«ã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã®ã§ã„ã„æ„Ÿã˜ã ã€‚
å‘¼ã³å‡ºã—å´ã«Pythonã®MsgPackRPCã‚’ä½¿ãˆã°é•ã†è¨€èªã‹ã‚‰ã§ã‚‚å‘¼ã³å‡ºã›ã‚‹ã®ã§ä¸€çŸ³äºŒé³¥ã¨ã„ã†ã‚‚ã®ã€‚
ã¨ã„ã†ã“ã¨ã§å¼•ãç¶šãä½œæ¥­ã‚’é€²ã‚ã‚‹ã€‚
MsgPackRPCã®ãƒªãƒ¢ãƒ¼ãƒˆå‘¼ã³å‡ºã—ã‚’åˆ©ç”¨ã—ãŸã‚·ãƒ¼ãƒ³ã‚¨ãƒ‡ã‚£ã‚¿ã‚’ä½œã‚ŠãªãŒã‚‰è¡¨ç¤ºã§ãã‚‹ã‚‚ã®ã‚’å¢—ã‚„ã—ã¦ã„ãã€‚</p>

<hr>
<ul class="pager hidden-print">
<li class="previous">
        <a href="../../02/gstreamer/" rel="prev" title="Gstreamerã‚’å§‹ã‚ã¦ã¿ãŸ">
            Gstreamerã‚’å§‹ã‚ã¦ã¿ãŸ ğŸ‘ˆ
        </a>
    </li>
    <li style="flex-grow: 1">
    <li class="next">
        <a href="../../22/irrlicht-vrpn/" rel="next" title="Irrlichtã«VRPNã‚’åˆä½“ã™ã‚‹">
            ğŸ‘‰ Irrlichtã«VRPNã‚’åˆä½“ã™ã‚‹
        </a>
    </li>
</ul></main><footer id="footer"><p>
            Powered by
            <a href="https://getnikola.com" rel="nofollow">Nikola</a>
        </p>
    </footer>
</body>
</html>
