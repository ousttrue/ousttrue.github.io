<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="generator" content="Nikola (getnikola.com)">
<meta name="viewport" content="width=device-width">
<script src="../../../../../assets/js/all-nocdn.js"></script><title>IrrlichtにMsgPackRPCを仕込む | 三次元日誌</title>
<link href="../../../../../assets/css/code.css" rel="stylesheet" type="text/css">
<link href="../../../../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
</head>
<body>
    <h1 id="brand">
        <a href="../../../../../" title="三次元日誌" rel="home">
            <span id="blog-title">三次元日誌</span>
        </a>
    </h1>

    <nav id="menu"><ul>
<li><a href="../../../../../archive.html">Archives</a></li>
<li><a href="../../../../../categories/index.html">Tags</a></li>
<li><a href="../../../../../rss.xml">RSS feed</a></li>
<li><a href="../../../../../about">About</a></li>
<li><a href="../../../../../books">MemoBooks</a></li>

            
            
            
        </ul></nav><hr>
<main id="content"><h1 class="p-name entry-title" itemprop="headline name">
    <h1 class="p-name entry-title" itemprop="headline name">
    <a href="." class="u-url">IrrlichtにMsgPackRPCを仕込む
    </a>
</h1>
<ul itemprop="keywords" class="tags">
<li>
        <time datetime="2013-06-17T00:00:00+09:00" title="2013-06-17">2013-06-17</time>
</li>
</ul>
</h1>

<p>IrrlichtにMsgPackRPCを仕込む
Oculusの通販ステータスが早くもProcessingに変わって届くのが楽しみな今日この頃。
レンダリングエンジンにはIrrlichtを選択したのであるが、
そのままだとシーンを構築するとか諸々の作業がC++直叩きになる。
これだとさすがに大変なのでMsgPackRPCでラップして外部のツールから
操作しようと構想しておったのだが始めてみると早速問題に突き当たった。
オブジェクトを生成してそのメソッドをコールするのにどうすればいいのか。
こういう場合だ。
IMesh *mesh=CreateMesh("miku.pmd");
mesh-&gt;SetPosition(0, 0, 5);</p>
<p>MsgPackRPC経由だと以下のような感じか。</p>
<h2>pythonとかそういうの</h2>
<p>client=msgpac.rpc.client()
mesh=client.call("CreateMesh", "miku.pmd")
client.call("Mesh_SetPosition", mesh, 0, 0, 5)</p>
<p>1つめのCreateMeshはグローバル関数かシングルトン的オブジェクトのメソッド呼び出しになるので特に問題は無い。
2つめはSetPositionのthisとしてmeshを送ってやる必要がある。
ここでmsgpack的にはIMesh<em>をシリアライズ/デシリアライズすることが必要になる。
案１ ポインタを整数値としてキャストすればいいじゃない
template <typename stream>
inline packer<stream>&amp; operator&lt;&lt; (packer<stream>&amp; o, IMesh </stream></stream></typename></em>v)
{
    // ポインタをintにキャスト
    o.pack((int)v);
    return o;
}</p>
<p>inline IMesh <em>v operator&gt;&gt; (object o, IMesh</em> v)
{
    unsigned int p;
    o.convert(&amp;p):</p>
<div class="code"><pre class="code literal-block"><span class="o">//</span><span class="w"> </span><span class="nv">int</span>をポインタにキャスト<span class="w"></span>
<span class="nv">v</span><span class="o">=</span><span class="ss">(</span><span class="nv">IMesh</span><span class="o">*</span><span class="ss">)</span><span class="nv">p</span><span class="c1">;</span><span class="w"></span>

<span class="k">return</span><span class="w"> </span><span class="nv">v</span><span class="c1">;</span><span class="w"></span>
</pre></div>

<p>}</p>
<p>さすがにワイルドすぎる。というかポインタが既に開放されている場合になすすべが無いので没
案２ 適当にユニークなIDを振る
template <typename stream>
inline packer<stream>&amp; operator&lt;&lt; (packer<stream>&amp; o, IMesh *v)
{
    // ポインタのuid値
    o.pack(v-&gt;uid());
    return o;
}</stream></stream></typename></p>
<p>inline IMesh <em>v operator&gt;&gt; (object o, IMesh</em> v)
{
    unsigned int uid;
    o.convert(&amp;uid):</p>
<div class="code"><pre class="code literal-block"><span class="o">//</span><span class="w"> </span><span class="nt">uid値からポインタを得る</span><span class="w"></span>
<span class="nt">v</span><span class="o">=</span><span class="nt">IMesh</span><span class="p">::</span><span class="nd">get_from_uid</span><span class="o">(</span><span class="nt">uid</span><span class="o">);</span><span class="w"></span>

<span class="nt">return</span><span class="w"> </span><span class="nt">v</span><span class="o">;</span><span class="w"></span>
</pre></div>

<p>}</p>
<p>Irrlichtだと本体側に改造が要るけどこれでいってみるか。
template<typename t>
class IDGenerator
{
    unsigned int m_uid;</typename></p>
<p>public:
    IDGenerator():m_uid(generate_uid())
    {
        m_uid_map.insert(std::make_pair(m_uid, this));
    }</p>
<div class="code"><pre class="code literal-block"><span class="n">unsigned</span><span class="w"> </span><span class="nb nb-Type">int</span><span class="w"> </span><span class="n">uid</span><span class="p">()</span><span class="k">const</span><span class="w"> </span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">m_uid</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>

<p>////////////////////
// static
////////////////////
private:
    static unsigned int m_next_uid=1;
    static std::hash_map<unsigned int t> m_uid_map;
public:
    static unsigned int generate_uid(){ 
        return m_next_uid++; 
    }</unsigned></p>
<div class="code"><pre class="code literal-block"><span class="n">statc</span><span class="w"> </span><span class="n">T</span><span class="o">*</span><span class="w"> </span><span class="n">get_from_uid</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="n">int</span><span class="w"> </span><span class="n">uid</span><span class="p">){</span><span class="w"></span>
<span class="w">    </span><span class="n">auto</span><span class="w"> </span><span class="n">found</span><span class="o">=</span><span class="n">m_uid_map</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">uid</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="nf">if</span><span class="p">(</span><span class="n">found</span><span class="o">==</span><span class="n">m_uid_map</span><span class="p">.</span><span class="kd">end(</span><span class="p">)){</span><span class="w"></span>
<span class="w">        </span><span class="kr">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="kr">return</span><span class="w"> </span><span class="n">found</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>

<p>};</p>
<p>// 継承階層のIReferenceCountedの下あたりにこんな感じで介入する予定
class IMesh : public virtual IReferenceCounted, public IDGenerator<imesh>
{
};</imesh></p>
<p>うまくいくかやってみるとしよう。
書いてみた
自由に書いてみたらこうなった。templateクラスのスタティックメンバ変数の書き方を学んだ。
http://d.hatena.ne.jp/higepon/20100803/1280834422
template<typename t>
class IDGenerator
{
    struct Deleter{
        unsigned int m_uid;</typename></p>
<div class="code"><pre class="code literal-block">    Deleter(unsigned int uid): m_uid(uid){}
    ~Deleter(){ remove_from_map(m_uid); }
};
Deleter m_deleter;
unsigned int m_uid;
</pre></div>

<p>public:
    IDGenerator():m_uid(generate_uid()), m_deleter(m_uid)
    {
        s_uid_map[m_uid]=this;
    }</p>
<div class="code"><pre class="code literal-block"><span class="n">unsigned</span><span class="w"> </span><span class="nb nb-Type">int</span><span class="w"> </span><span class="n">uid</span><span class="p">()</span><span class="k">const</span><span class="w"> </span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">m_uid</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="o">////////////////////</span><span class="w"></span>
<span class="o">//</span><span class="w"> </span><span class="k">static</span><span class="w"></span>
<span class="o">////////////////////</span><span class="w"></span>
</pre></div>

<p>private:
    static core::map<unsigned int idgenerator> s_uid_map;
public:
    static unsigned int generate_uid(){ 
        static unsigned int next_uid=1;
        return next_uid++; 
    }</unsigned></p>
<div class="code"><pre class="code literal-block"><span class="nv">static</span><span class="w"> </span><span class="nv">T</span><span class="o">*</span><span class="w"> </span><span class="nv">get_from_uid</span><span class="ss">(</span><span class="nv">unsigned</span><span class="w"> </span><span class="nv">int</span><span class="w"> </span><span class="nv">uid</span><span class="ss">)</span>{<span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nv">s_uid_map</span>.<span class="nv">find</span><span class="ss">(</span><span class="nv">uid</span><span class="ss">)</span><span class="c1">;</span><span class="w"></span>
}<span class="w"></span>

<span class="nv">static</span><span class="w"> </span><span class="nv">void</span><span class="w"> </span><span class="nv">remove_from_map</span><span class="ss">(</span><span class="nv">unsigned</span><span class="w"> </span><span class="nv">int</span><span class="w"> </span><span class="nv">uid</span><span class="ss">)</span>{<span class="w"></span>
<span class="w">    </span><span class="nv">s_uid_map</span>.<span class="nv">remove</span><span class="ss">(</span><span class="nv">uid</span><span class="ss">)</span><span class="c1">;</span><span class="w"></span>
}<span class="w"></span>
</pre></div>

<p>};
template <typename t> core::map<unsigned int idgenerator>*&gt; IDGenerator<t>::s_uid_map;</t></unsigned></typename></p>
<p>しかし、この設計だとstaticメンバがdll境界を越えて２つ存在してうまくいかない罠があった。没
案3 適当にユニークなIDを振る(非テンプレート)
irr::IReferenceCountedを改造する。
小賢しいtemplateをやめてべたにグローバル変数を隠蔽する方式を導入した。
class IReferenceCounted
{
public:</p>
<div class="code"><pre class="code literal-block"><span class="c1">//! Constructor.</span>
<span class="n">IReferenceCounted</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="o">:</span><span class="w"> </span><span class="n">DebugName</span><span class="p">(</span><span class="mh">0</span><span class="p">),</span><span class="w"> </span><span class="n">ReferenceCounter</span><span class="p">(</span><span class="mh">1</span><span class="p">),</span><span class="w"> </span><span class="n">UID</span><span class="p">(</span><span class="n">get_uid</span><span class="p">())</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">register_uid</span><span class="p">(</span><span class="n">UID</span><span class="p">,</span><span class="w"> </span><span class="n">this</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="n">u32</span><span class="w"> </span><span class="n">uid</span><span class="p">(){</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">UID</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w"></span>

<span class="c1">//! Destructor.</span>
<span class="n">virtual</span><span class="w"> </span><span class="o">~</span><span class="n">IReferenceCounted</span><span class="p">()</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">unregister_uid</span><span class="p">(</span><span class="n">UID</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>

<p>// 省略</p>
<p>};</p>
<h2>include "IDGenerator.h"</h2>
<h2>include "IReferenceCounted.h"</h2>
<h2>include "irrMap.h"</h2>
<p>namespace irr {</p>
<div class="code"><pre class="code literal-block"><span class="n">extern</span><span class="w"> </span><span class="s">"C"</span><span class="w"> </span><span class="n">IRRLICHT_API</span><span class="w"> </span><span class="n">u32</span><span class="w"> </span><span class="n">get_uid</span><span class="p">()</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">static</span><span class="w"> </span><span class="n">u32</span><span class="w"> </span><span class="n">uid</span><span class="o">=</span><span class="mh">1</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">uid</span><span class="o">++</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="n">static</span><span class="w"> </span><span class="n">core</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">u32</span><span class="p">,</span><span class="w"> </span><span class="n">IReferenceCounted</span><span class="o">*&gt;</span><span class="w"> </span><span class="n">g_map</span><span class="p">;</span><span class="w"></span>

<span class="n">extern</span><span class="w"> </span><span class="s">"C"</span><span class="w"> </span><span class="n">IRRLICHT_API</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="n">register_uid</span><span class="p">(</span><span class="n">u32</span><span class="w"> </span><span class="n">uid</span><span class="p">,</span><span class="w"> </span><span class="n">IReferenceCounted</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">g_map</span><span class="p">.</span><span class="n">set</span><span class="p">(</span><span class="n">uid</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="n">extern</span><span class="w"> </span><span class="s">"C"</span><span class="w"> </span><span class="n">IRRLICHT_API</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="n">unregister_uid</span><span class="p">(</span><span class="n">u32</span><span class="w"> </span><span class="n">uid</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">auto</span><span class="w"> </span><span class="n">found</span><span class="o">=</span><span class="n">g_map</span><span class="p">.</span><span class="n">remove</span><span class="p">(</span><span class="n">uid</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="n">extern</span><span class="w"> </span><span class="s">"C"</span><span class="w"> </span><span class="n">IRRLICHT_API</span><span class="w"> </span><span class="n">IReferenceCounted</span><span class="o">*</span><span class="w"> </span><span class="n">get_from_uid</span><span class="p">(</span><span class="n">u32</span><span class="w"> </span><span class="n">uid</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">auto</span><span class="w"> </span><span class="n">found</span><span class="o">=</span><span class="n">g_map</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">uid</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">found</span><span class="p">){</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mh">0</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">found</span><span class="o">-&gt;</span><span class="n">getValue</span><span class="p">();</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>

<p>}</p>
<p>動作確認できた。
ここまでの作業でMsgPackRPCを使ったIrrlichtエクスポートについて見通しを得ることができた。
PythonやLuaから使えるようにするのと同じような作業でリモートから関数をコールできるようになるのでいい感じだ。
呼び出し側にPythonのMsgPackRPCを使えば違う言語からでも呼び出せるので一石二鳥というもの。
ということで引き続き作業を進める。
MsgPackRPCのリモート呼び出しを利用したシーンエディタを作りながら表示できるものを増やしていく。</p>

<hr>
<ul class="pager hidden-print">
<li class="previous">
        <a href="../../02/gstreamer/" rel="prev" title="Gstreamerを始めてみた">
            Gstreamerを始めてみた 👈
        </a>
    </li>
    <li style="flex-grow: 1">
    <li class="next">
        <a href="../../22/irrlicht-vrpn/" rel="next" title="IrrlichtにVRPNを合体する">
            👉 IrrlichtにVRPNを合体する
        </a>
    </li>
</ul></main><footer id="footer"><p>
            Powered by
            <a href="https://getnikola.com" rel="nofollow">Nikola</a>
        </p>
    </footer>
</body>
</html>
