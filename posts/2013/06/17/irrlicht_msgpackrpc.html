
<!DOCTYPE html>

<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>title: &#34;IrrlichtにMsgPackRPCを仕込む&#34; date: 2013-06-17 taxonomies: {tags: []} &#8212; 三次元日誌  ドキュメント</title>
    <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/alabaster.css" />
    <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js"></script>
    <script src="../../../../_static/jquery.js"></script>
    <script src="../../../../_static/underscore.js"></script>
    <script src="../../../../_static/doctools.js"></script>
    <script src="../../../../_static/translations.js"></script>
    <link rel="index" title="索引" href="../../../../genindex.html" />
    <link rel="search" title="検索" href="../../../../search.html" /> 
   
  <link rel="stylesheet" href="../../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />
 
<link
  rel="alternate"
  type="application/atom+xml"
  href="../../../../blog/atom.xml"
  title="三次元日誌(ablog)"
/>
 
<style type="text/css">
  ul.ablog-archive {
    list-style: none;
    overflow: auto;
    margin-left: 0px;
  }
  ul.ablog-archive li {
    float: left;
    margin-right: 5px;
    font-size: 80%;
  }
  ul.postlist a {
    font-style: italic;
  }
  ul.postlist-style-disc {
    list-style-type: disc;
  }
  ul.postlist-style-none {
    list-style-type: none;
  }
  ul.postlist-style-circle {
    list-style-type: circle;
  }
</style>

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
             <hr class="docutils" />
<section id="title-irrlichtmsgpackrpc-date-2013-06-17-taxonomies-tags">
<h1>title: &quot;IrrlichtにMsgPackRPCを仕込む&quot;
date: 2013-06-17
taxonomies: {tags: []}<a class="headerlink" href="#title-irrlichtmsgpackrpc-date-2013-06-17-taxonomies-tags" title="このヘッドラインへのパーマリンク">¶</a></h1>
<p>IrrlichtにMsgPackRPCを仕込む
Oculusの通販ステータスが早くもProcessingに変わって届くのが楽しみな今日この頃。
レンダリングエンジンにはIrrlichtを選択したのであるが、
そのままだとシーンを構築するとか諸々の作業がC++直叩きになる。
これだとさすがに大変なのでMsgPackRPCでラップして外部のツールから
操作しようと構想しておったのだが始めてみると早速問題に突き当たった。
オブジェクトを生成してそのメソッドをコールするのにどうすればいいのか。
こういう場合だ。
IMesh *mesh=CreateMesh(&quot;miku.pmd&quot;);
mesh-&gt;SetPosition(0, 0, 5);</p>
<p>MsgPackRPC経由だと以下のような感じか。</p>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="python">
<h1>pythonとかそういうの<a class="headerlink" href="#python" title="このヘッドラインへのパーマリンク">¶</a></h1>
<p>client=msgpac.rpc.client()
mesh=client.call(&quot;CreateMesh&quot;, &quot;miku.pmd&quot;)
client.call(&quot;Mesh_SetPosition&quot;, mesh, 0, 0, 5)</p>
<p>1つめのCreateMeshはグローバル関数かシングルトン的オブジェクトのメソッド呼び出しになるので特に問題は無い。
2つめはSetPositionのthisとしてmeshを送ってやる必要がある。
ここでmsgpack的にはIMesh*をシリアライズ/デシリアライズすることが必要になる。
案１ ポインタを整数値としてキャストすればいいじゃない
template <typename Stream>
inline packer<Stream>&amp; operator&lt;&lt; (packer<Stream>&amp; o, IMesh *v)
{
// ポインタをintにキャスト
o.pack((int)v);
return o;
}</p>
<p>inline IMesh <em>v operator&gt;&gt; (object o, IMesh</em> v)
{
unsigned int p;
o.convert(&amp;p):</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>// intをポインタにキャスト
v=(IMesh*)p;

return v;
</pre></div>
</div>
<p>}</p>
<p>さすがにワイルドすぎる。というかポインタが既に開放されている場合になすすべが無いので没
案２ 適当にユニークなIDを振る
template <typename Stream>
inline packer<Stream>&amp; operator&lt;&lt; (packer<Stream>&amp; o, IMesh *v)
{
// ポインタのuid値
o.pack(v-&gt;uid());
return o;
}</p>
<p>inline IMesh <em>v operator&gt;&gt; (object o, IMesh</em> v)
{
unsigned int uid;
o.convert(&amp;uid):</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>// uid値からポインタを得る
v=IMesh::get_from_uid(uid);

return v;
</pre></div>
</div>
<p>}</p>
<p>Irrlichtだと本体側に改造が要るけどこれでいってみるか。
template<typename T>
class IDGenerator
{
unsigned int m_uid;</p>
<p>public:
IDGenerator():m_uid(generate_uid())
{
m_uid_map.insert(std::make_pair(m_uid, this));
}</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>unsigned int uid()const 
{
    return m_uid;
}
</pre></div>
</div>
<p>////////////////////
// static
////////////////////
private:
static unsigned int m_next_uid=1;
static std::hash_map&lt;unsigned int, T*&gt; m_uid_map;
public:
static unsigned int generate_uid(){
return m_next_uid++;
}</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>statc T* get_from_uid(unsigned int uid){
    auto found=m_uid_map.find(uid);
    if(found==m_uid_map.end()){
        return 0;
    }
    return found-&gt;second;
}
</pre></div>
</div>
<p>};</p>
<p>// 継承階層のIReferenceCountedの下あたりにこんな感じで介入する予定
class IMesh : public virtual IReferenceCounted, public IDGenerator<IMesh>
{
};</p>
<p>うまくいくかやってみるとしよう。
書いてみた
自由に書いてみたらこうなった。templateクラスのスタティックメンバ変数の書き方を学んだ。
http://d.hatena.ne.jp/higepon/20100803/1280834422
template<typename T>
class IDGenerator
{
struct Deleter{
unsigned int m_uid;</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>    Deleter(unsigned int uid): m_uid(uid){}
    ~Deleter(){ remove_from_map(m_uid); }
};
Deleter m_deleter;
unsigned int m_uid;
</pre></div>
</div>
<p>public:
IDGenerator():m_uid(generate_uid()), m_deleter(m_uid)
{
s_uid_map[m_uid]=this;
}</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>unsigned int uid()const 
{
    return m_uid;
}

////////////////////
// static
////////////////////
</pre></div>
</div>
<p>private:
static core::map&lt;unsigned int, IDGenerator*&gt; s_uid_map;
public:
static unsigned int generate_uid(){
static unsigned int next_uid=1;
return next_uid++;
}</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>static T* get_from_uid(unsigned int uid){
    return s_uid_map.find(uid);
}

static void remove_from_map(unsigned int uid){
    s_uid_map.remove(uid);
}
</pre></div>
</div>
<p>};
template <typename T> core::map&lt;unsigned int, IDGenerator<T>*&gt; IDGenerator<T>::s_uid_map;</p>
<p>しかし、この設計だとstaticメンバがdll境界を越えて２つ存在してうまくいかない罠があった。没
案3 適当にユニークなIDを振る(非テンプレート)
irr::IReferenceCountedを改造する。
小賢しいtemplateをやめてべたにグローバル変数を隠蔽する方式を導入した。
class IReferenceCounted
{
public:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>//! Constructor.
IReferenceCounted()
    : DebugName(0), ReferenceCounter(1), UID(get_uid())
{
    register_uid(UID, this);
}

u32 uid(){ return UID; }

//! Destructor.
virtual ~IReferenceCounted()
{
    unregister_uid(UID);
}
</pre></div>
</div>
<p>// 省略</p>
<p>};</p>
<p>#include &quot;IDGenerator.h&quot;
#include &quot;IReferenceCounted.h&quot;
#include &quot;irrMap.h&quot;</p>
<p>namespace irr {</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>extern &quot;C&quot; IRRLICHT_API u32 get_uid()
{
    static u32 uid=1;
    return uid++;
}

static core::map&lt;u32, IReferenceCounted*&gt; g_map;

extern &quot;C&quot; IRRLICHT_API void register_uid(u32 uid, IReferenceCounted *p)
{
    g_map.set(uid, p);
}

extern &quot;C&quot; IRRLICHT_API void unregister_uid(u32 uid)
{
    auto found=g_map.remove(uid);
}

extern &quot;C&quot; IRRLICHT_API IReferenceCounted* get_from_uid(u32 uid)
{
    auto found=g_map.find(uid);
    if(!found){
        return 0;
    }
    return found-&gt;getValue();
}
</pre></div>
</div>
<p>}</p>
<p>動作確認できた。
ここまでの作業でMsgPackRPCを使ったIrrlichtエクスポートについて見通しを得ることができた。
PythonやLuaから使えるようにするのと同じような作業でリモートから関数をコールできるようになるのでいい感じだ。
呼び出し側にPythonのMsgPackRPCを使えば違う言語からでも呼び出せるので一石二鳥というもの。
ということで引き続き作業を進める。
MsgPackRPCのリモート呼び出しを利用したシーンエディタを作りながら表示できるものを増やしていく。</p>
</section>

<div class="section">
   
</div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../../index.html">三次元日誌</a></h1>








<h3>ナビゲーション</h3>


<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">クイック検索</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="検索" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2021, ousttrue.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 4.3.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../../../../_sources/posts/2013/06/17/irrlicht_msgpackrpc.md.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>