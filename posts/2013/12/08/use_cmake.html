
<!DOCTYPE html>

<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>title: &#34;cmakeを使ってみる(Windowsかつコマンドラインで)&#34; date: 2013-12-08 taxonomies: {tags: [&#39;cmake&#39;]} &#8212; 三次元日誌  ドキュメント</title>
    <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/alabaster.css" />
    <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js"></script>
    <script src="../../../../_static/jquery.js"></script>
    <script src="../../../../_static/underscore.js"></script>
    <script src="../../../../_static/doctools.js"></script>
    <script src="../../../../_static/translations.js"></script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <link rel="index" title="索引" href="../../../../genindex.html" />
    <link rel="search" title="検索" href="../../../../search.html" /> 
   
  <link rel="stylesheet" href="../../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />
 
<link
  rel="alternate"
  type="application/atom+xml"
  href="../../../../blog/atom.xml"
  title="三次元日誌(ablog)"
/>
 
<style type="text/css">
  ul.ablog-archive {
    list-style: none;
    overflow: auto;
    margin-left: 0px;
  }
  ul.ablog-archive li {
    float: left;
    margin-right: 5px;
    font-size: 80%;
  }
  ul.postlist a {
    font-style: italic;
  }
  ul.postlist-style-disc {
    list-style-type: disc;
  }
  ul.postlist-style-none {
    list-style-type: none;
  }
  ul.postlist-style-circle {
    list-style-type: circle;
  }
</style>

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
             <hr class="docutils" />
<section id="title-cmake-windows-date-2013-12-08-taxonomies-tags-cmake">
<h1>title: &quot;cmakeを使ってみる(Windowsかつコマンドラインで)&quot;
date: 2013-12-08
taxonomies: {tags: ['cmake']}<a class="headerlink" href="#title-cmake-windows-date-2013-12-08-taxonomies-tags-cmake" title="このヘッドラインへのパーマリンク">¶</a></h1>
<p>ArUcoを使おうとしたら、msvcpdのvc10版を要求されてvc12でデバッグビルドが動かなかった。</p>
<p>最新版のOpenCV-2.4.7をゲットしてきたところvc10とvc11は含まれて居るのだが、vc12ビルドは含まれていなかった(vc2013は早すぎたかw)。
仕方ないので自前ビルドすることにした。
ということでcmakeの使い方を調べてみる。
ついでに、cmakeでビルドしたライブラリを特定のディレクトリを基準にインストールする方法を調べてみる。
練習にzlibをビルドしてインストールしてみる
以下のようなディレクトリ構成で運用してみることを目標に作業開始。
local_vc12</p>
<ul class="simple">
<li><p>bin # dll置き場</p></li>
<li><p>include # dllを使うのに必要なheader置き場</p></li>
<li><p>lib # dllのimportライブラリ置き場</p></li>
</ul>
<p>外部依存の無い適当なライブラリで練習してみようということでzlibを選定。
さっそくcmakeを使ってみようと思ったら、zlib-1.2.8にはCmakeLists.txtが含まれとるで。
C:\src&gt; cd zlib-1.2.8
C:\src\zlib-1.2.8&gt; cmake -D CMAKE_INSTALL_PREFIX=C:/local_vc12 .
C:\src\zlib-1.2.8&gt; msbuild INSTALL.vcxproj
C:\src\zlib-1.2.8&gt; msbuild INSTALL.vcxproj /p:Configuration=Release</p>
<p>以上で下記のようになった。
C:/local_vc12
C:/local_vc12/bin
C:/local_vc12/bin/zlib.dll
C:/local_vc12/bin/zlibd.dll
C:/local_vc12/include
C:/local_vc12/include/zconf.h
C:/local_vc12/include/zlib.h
C:/local_vc12/lib
C:/local_vc12/lib/zlib.lib
C:/local_vc12/lib/zlibd.lib
C:/local_vc12/lib/zlibstatic.lib
C:/local_vc12/lib/zlibstaticd.lib
C:/local_vc12/share
C:/local_vc12/share/man
C:/local_vc12/share/man/man3
C:/local_vc12/share/man/man3/zlib.3
C:/local_vc12/share/pkgconfig
C:/local_vc12/share/pkgconfig/zlib.pc</p>
<p>素晴らしい。
OpenCV-2.4.7でやってみる
C:\src&gt; cd opencv-2.4.7
C:\src\opencv-2.4.7&gt; cmake -D CMAKE_INSTALL_PREFIX=C:/local_vc12 .
C:\src\opencv-2.4.7&gt; msbuild ALL_BUILD.vcxproj</p>
<p>失敗する。</p>
<p>https://github.com/SpecLad/opencv/commit/7973594a01228107dcb9d2d1f10eb64498b91aac
http://stackoverflow.com/questions/17409956/cannot-compile-opencv-2-4-5-with-vs-2013-rtm</p>
<p>あとIlmxxxでmin, maxのエラーが出るので”#include
<algorithm>“する。std::min,
maxはalgorithmに入っとる。ALL_BUILDが成功したらINSTALLする。
C:\src\opencv-2.4.7&gt; msbuild INSTALL.vcxproj</p>
<p>これで”local_vc12”にopencvも入った。
cmakeはいままで敬遠していたのだがライブラリのinstallまで面倒見てくれるのはいいですな。
同じく敬遠していた自前dllを使う開発が捗りそうな感じだ。
ArUcoをビルド
cmakeを使ったアプリ(ライブラリを使う方)のビルド。
C:\src&gt; cd aruco-1.2.4
C:\src\aruco-1.2.4&gt; cmake -D CMAKE_INSTALL_PREFIX=C:/local_vc12 .</p>
<p>ここでエラーが出る。
OpenCVが正式ビルドと違うディレクトリにインストールされたために検知に失敗する。
“C:/local_vc12/OpenCVConfig.cmake”を直接修正した。
get_filename_component(OpenCV_CONFIG_PATH &quot;${CMAKE_CURRENT_LIST_FILE}&quot; PATH CACHE)
#if(OpenCV_RUNTIME AND OpenCV_ARCH)</p>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="if-opencv-static-and-exists-opencv-config-path-opencv-arch-opencv-runtime-staticlib-opencvconfig-cmake">
<h1>if(OpenCV_STATIC AND EXISTS &quot;<span class="math notranslate nohighlight">\({OpenCV_CONFIG_PATH}/\)</span>{OpenCV_ARCH}/${OpenCV_RUNTIME}/staticlib/OpenCVConfig.cmake&quot;)<a class="headerlink" href="#if-opencv-static-and-exists-opencv-config-path-opencv-arch-opencv-runtime-staticlib-opencvconfig-cmake" title="このヘッドラインへのパーマリンク">¶</a></h1>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="if-opencv-cuda-and-exists-opencv-config-path-gpu-opencv-arch-opencv-runtime-staticlib-opencvconfig-cmake">
<h1>if(OpenCV_CUDA AND EXISTS &quot;<span class="math notranslate nohighlight">\({OpenCV_CONFIG_PATH}/gpu/\)</span>{OpenCV_ARCH}/${OpenCV_RUNTIME}/staticlib/OpenCVConfig.cmake&quot;)<a class="headerlink" href="#if-opencv-cuda-and-exists-opencv-config-path-gpu-opencv-arch-opencv-runtime-staticlib-opencvconfig-cmake" title="このヘッドラインへのパーマリンク">¶</a></h1>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="set-opencv-lib-path-opencv-config-path-gpu-opencv-arch-opencv-runtime-staticlib">
<h1>set(OpenCV_LIB_PATH &quot;<span class="math notranslate nohighlight">\({OpenCV_CONFIG_PATH}/gpu/\)</span>{OpenCV_ARCH}/${OpenCV_RUNTIME}/staticlib&quot;)<a class="headerlink" href="#set-opencv-lib-path-opencv-config-path-gpu-opencv-arch-opencv-runtime-staticlib" title="このヘッドラインへのパーマリンク">¶</a></h1>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="else">
<h1>else()<a class="headerlink" href="#else" title="このヘッドラインへのパーマリンク">¶</a></h1>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="set-opencv-lib-path-opencv-config-path-opencv-arch-opencv-runtime-staticlib">
<h1>set(OpenCV_LIB_PATH &quot;<span class="math notranslate nohighlight">\({OpenCV_CONFIG_PATH}/\)</span>{OpenCV_ARCH}/${OpenCV_RUNTIME}/staticlib&quot;)<a class="headerlink" href="#set-opencv-lib-path-opencv-config-path-opencv-arch-opencv-runtime-staticlib" title="このヘッドラインへのパーマリンク">¶</a></h1>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="endif">
<h1>endif()<a class="headerlink" href="#endif" title="このヘッドラインへのパーマリンク">¶</a></h1>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="elseif-exists-opencv-config-path-opencv-arch-opencv-runtime-lib-opencvconfig-cmake">
<h1>elseif(EXISTS &quot;<span class="math notranslate nohighlight">\({OpenCV_CONFIG_PATH}/\)</span>{OpenCV_ARCH}/${OpenCV_RUNTIME}/lib/OpenCVConfig.cmake&quot;)<a class="headerlink" href="#elseif-exists-opencv-config-path-opencv-arch-opencv-runtime-lib-opencvconfig-cmake" title="このヘッドラインへのパーマリンク">¶</a></h1>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="if-opencv-cuda-and-exists-opencv-config-path-gpu-opencv-arch-opencv-runtime-lib-opencvconfig-cmake">
<h1>if(OpenCV_CUDA AND EXISTS &quot;<span class="math notranslate nohighlight">\({OpenCV_CONFIG_PATH}/gpu/\)</span>{OpenCV_ARCH}/${OpenCV_RUNTIME}/lib/OpenCVConfig.cmake&quot;)<a class="headerlink" href="#if-opencv-cuda-and-exists-opencv-config-path-gpu-opencv-arch-opencv-runtime-lib-opencvconfig-cmake" title="このヘッドラインへのパーマリンク">¶</a></h1>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="set-opencv-lib-path-opencv-config-path-gpu-opencv-arch-opencv-runtime-lib">
<h1>set(OpenCV_LIB_PATH &quot;<span class="math notranslate nohighlight">\({OpenCV_CONFIG_PATH}/gpu/\)</span>{OpenCV_ARCH}/${OpenCV_RUNTIME}/lib&quot;)<a class="headerlink" href="#set-opencv-lib-path-opencv-config-path-gpu-opencv-arch-opencv-runtime-lib" title="このヘッドラインへのパーマリンク">¶</a></h1>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="id1">
<h1>else()<a class="headerlink" href="#id1" title="このヘッドラインへのパーマリンク">¶</a></h1>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="set-opencv-lib-path-opencv-config-path-opencv-arch-opencv-runtime-lib">
<h1>set(OpenCV_LIB_PATH &quot;<span class="math notranslate nohighlight">\({OpenCV_CONFIG_PATH}/\)</span>{OpenCV_ARCH}/${OpenCV_RUNTIME}/lib&quot;)<a class="headerlink" href="#set-opencv-lib-path-opencv-config-path-opencv-arch-opencv-runtime-lib" title="このヘッドラインへのパーマリンク">¶</a></h1>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="id2">
<h1>endif()<a class="headerlink" href="#id2" title="このヘッドラインへのパーマリンク">¶</a></h1>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="id3">
<h1>endif()<a class="headerlink" href="#id3" title="このヘッドラインへのパーマリンク">¶</a></h1>
<p>#endif()
set(OpenCV_LIB_PATH &quot;${OpenCV_CONFIG_PATH}/lib&quot;)</p>
<p>これでビルドできた。
C:\src\aruco-1.2.4&gt; cmake -D CMAKE_INSTALL_PREFIX=C:/local_vc12 .
C:\src\opencv-2.4.7&gt; msbuild ALL_BUILD.vcxproj</p>
<p>しかし、OpenGLを使ったサンプルがビルドされぬ。
どうやらglutが見つからないらいしい。せっかくなのでFreeGlutを入れてみますか。
FreeGlut
http://freeglut.sourceforge.net/
C:\src\freeglut-2.8.1&gt; cmake -D CMAKE_INSTALL_PREFIX=C:/local_vc12 .
CMake Error: The source directory &quot;C:/src/freeglut-2.8.1&quot; does not appear to contain CMakeLists.txt.
Specify --help for usage, or press the help button on the CMake GUI.</p>
<p>CMakeLists.txtが無い。作ってみる。
project (freeglut)</p>
<p>file(GLOB SOURCES &quot;src/*.c&quot;)
ADD_LIBRARY(freeglut SHARED ${SOURCES})</p>
<p>include_directories(include)</p>
<p>ADD_DEFINITIONS(-DFREEGLUT_EXPORTS)
ADD_DEFINITIONS(-D_USRDLL)
ADD_DEFINITIONS(-D_WINDOWS)
ADD_DEFINITIONS(-DWIN32)</p>
<p>C:\src\freeglut-2.8.1&gt; cmake -D CMAKE_INSTALL_PREFIX=C:/local_vc12 .
C:\src\opencv-2.4.7&gt; msbuild ALL_BUILD.vcxproj</p>
<p>ビルドできた。INSTALL.vcxprojが見当たらないのでCMakeLists.txtに追記する必要がありそう。
インストールに関する追記。</p>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="dll">
<h1>dll<a class="headerlink" href="#dll" title="このヘッドラインへのパーマリンク">¶</a></h1>
<p>INSTALL(TARGETS freeglut RUNTIME
DESTINATION bin)</p>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="lib">
<h1>lib<a class="headerlink" href="#lib" title="このヘッドラインへのパーマリンク">¶</a></h1>
<p>INSTALL(TARGETS freeglut ARCHIVE
DESTINATION lib)</p>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="headers">
<h1>headers<a class="headerlink" href="#headers" title="このヘッドラインへのパーマリンク">¶</a></h1>
<p>INSTALL(DIRECTORY include/
DESTINATION include
PATTERN &quot;Makefile.*&quot; EXCLUDE
)</p>
<p>インストールしてみる。
C:\src\freeglut-2.8.1&gt; cmake -D CMAKE_INSTALL_PREFIX=C:/local_vc12 .
C:\src\opencv-2.4.7&gt; msbuild INSTALL.vcxproj</p>
<p>-- Install configuration: &quot;Debug&quot;
-- Installing: C:/local_vc12/bin/freeglut.dll
-- Installing: C:/local_vc12/lib/freeglut.lib
-- Installing: C:/local_vc12/include
-- Installing: C:/local_vc12/include/GL
-- Up-to-date: C:/local_vc12/include/GL/freeglut.h
-- Up-to-date: C:/local_vc12/include/GL/freeglut_ext.h
-- Up-to-date: C:/local_vc12/include/GL/freeglut_std.h
-- Up-to-date: C:/local_vc12/include/GL/glut.h</p>
<p>インストール成功。
再度ArUco
C:\src\freeglut-2.8.1&gt; cmake -D CMAKE_INSTALL_PREFIX=C:/local_vc12 .
-- FOUND OPENGL=YES    LIBS=opengl32;glu32;C:/local_vc12/lib/freeglut.lib</p>
<p>glutが発見されたようだ。
どうやらcmakeはCMAKE_INSTALL_PREFIXにライブラリを探しに行くようですな。
C:\src\opencv-2.4.7&gt; msbuild ALL_BUILD.vcxproj</p>
<p>gl.hの前に”#include &lt;windows.h&gt;“してやってビルドできた。
Debug版の後ろに”d”をつける
FreeGlutのCmakeLists.txtにzlibの”CmakeLists.txt”から頂いてきた。
set(CMAKE_DEBUG_POSTFIX &quot;d&quot;)</p>
<p>記述順の影響があるようで前の方(ADD_LIBRARYより前？)に書く必要があるっぽい。
Debug版の後ろに”d”がついたライブラリを使う</p>
<p>http://stackoverflow.com/questions/2209929/linking-different-libraries-for-debug-and-release-builds-in-cmake-on-windows
http://stackoverflow.com/questions/5497348/debug-and-release-library-linking-with-cmake-visual-studio</p>
<p>こういう書き方でできた。
set (OPENGL_LIBS  general <span class="math notranslate nohighlight">\({OPENGL_gl_LIBRARY} \)</span>{OPENGL_glu_LIBRARY} optimized <span class="math notranslate nohighlight">\({GLUT_glut_LIBRARY} debug \)</span>{GLUT_glut_DEBUG_LIBRARY})</p>
<p>CMAKE_DEBUG_POSTFIXに関連は使われる方と使う方の双方で合わせる必要があるので変更する場合は自分で両方の面倒を見なければならない。
一応、cmakeのひととおりの使い方が分かってきた。
vcがmsbuildを使うようになってビルドが制御可能になっている感じ。
makeの各ターゲットに対するmsbuildの実行方法は以下の通り。
&quot;target&quot;, &quot;make&quot;, &quot;msbuild&quot;
&quot;build&quot;, &quot;make all&quot;, &quot;msbuild ALL_BUILD.vcxproj /t:Build&quot;
&quot;release build&quot;, &quot;?&quot;, &quot;msbuild ALL_BUILD.vcxproj /t:Build /p:Configuration=Release&quot;
&quot;debug build&quot;, &quot;?&quot;, &quot;msbuild ALL_BUILD.vcxproj /t:Build /p:Configuration=Debug&quot;
&quot;clean&quot;, &quot;make clean&quot;, &quot;msbuild ALL_BUILD.vcxproj /t:Clean&quot;
&quot;install&quot;, &quot;make install&quot;, &quot;msbuild INSTALL.vcxproj&quot;</p>
<p>ちょっといろいろビルドしてみる。</p>
</section>

<div class="section">
   
</div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../../index.html">三次元日誌</a></h1>








<h3>ナビゲーション</h3>


<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">クイック検索</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="検索" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2021, ousttrue.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 4.3.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../../../../_sources/posts/2013/12/08/use_cmake.md.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>