<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="generator" content="Nikola (getnikola.com)">
<meta name="viewport" content="width=device-width">
<script src="../../../assets/js/all-nocdn.js"></script><title>VS2019 向けに hererocks を修正(vswhere を使う) | 三次元日誌</title>
<link href="../../../assets/css/code.css" rel="stylesheet" type="text/css">
<link href="../../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
</head>
<body>
    <h1 id="brand">
        <a href="../../../" title="三次元日誌" rel="home">
            <span id="blog-title">三次元日誌</span>
        </a>
    </h1>

    <nav id="menu"><ul>
<li><a href="../../../archive.html">Archives</a></li>
<li><a href="../../../categories/index.html">Tags</a></li>
<li><a href="../../../rss.xml">RSS feed</a></li>
<li><a href="../../../about">About</a></li>
<li><a href="../../../books">MemoBooks</a></li>

            
            
            
        </ul></nav><hr>
<main id="content"><h1 class="p-name entry-title" itemprop="headline name">
    <h1 class="p-name entry-title" itemprop="headline name">
    <a href="." class="u-url">VS2019 向けに hererocks を修正(vswhere を使う)
    </a>
</h1>
<ul itemprop="keywords" class="tags">
<li>
        <time datetime="2021-07-15T00:00:00+09:00" title="2021-07-15">2021-07-15</time>
</li>
    <li><a class="tag p-category" href="../../../categories/lua/" rel="tag">lua</a></li>
    <li><a class="tag p-category" href="../../../categories/nvim/" rel="tag">nvim</a></li>
    <li><a class="tag p-category" href="../../../categories/python/" rel="tag">python</a></li>
</ul>
</h1>

<p>hererocks が VS2019BuildTools を検知して動作するように改造してみた。</p>
<p><a href="https://github.com/luarocks/hererocks/pull/15">https://github.com/luarocks/hererocks/pull/15</a></p>
<p>通るかどうかは微妙。
内容的に、通りづらそう。
古い vc を使っていたり MinGW 使っていたりすると実験できないしね。
とりあえず、既存の動いている部分が壊れないようには配慮した。</p>
<p>採用されれば、</p>
<p><a href="https://github.com/wbthomason/packer.nvim/issues/302">https://github.com/wbthomason/packer.nvim/issues/302</a></p>
<p>も進展する。
Windows 版の luarocks 呼び出しに改造が必要なのだが、
先に hererocks が動いている必要があるという順番。</p>
<p>とりあえず単体で試すことができて</p>
<pre class="code literal-block"># C:/Python38/Scripts/pip.exe
$ pip install https://github.com/ousttrue/hererocks/archive/add_vswhere.zip
</pre>
<p>とする。</p>
<pre class="code literal-block"># C:/Python38/Scripts/hererocks.exe
$ hererocks.exe --target vs -j 2.1.0-beta3 -r latest build_dir
Using cl.exe found in PATH.
Fetching LuaJIT 2.1.0-beta3 (target: vs) (cached)
Verifying SHA256 checksum
Building LuaJIT 2.1.0-beta3 (target: vs)
Installing LuaJIT 2.1.0-beta3 (target: vs)
Fetching LuaRocks 3.7.0 (cached)
Verifying SHA256 checksum
Building and installing LuaRocks 3.7.0
</pre>
<p>lua はシステムにインストールして全体でライブラリを共有するというよりは、
プロジェクト単位でインストールしてローカルに必要なライブラリだけを追加するという運用になりそう。
なので、 hererocks でプロジェクトローカルに lua をサクッとビルドできるのはなかなかよい。
python の venv 的な運用。
展開先は、 <code>.gitignore</code> する。</p>
<p>ただ、外部ライブラリのラッパーがさくっと動くかというと Windows だと厳しいものがありますな・・・。
vcpkg と連携させるとか、更なる頑張りが必要かもしれない。
なので、 luajit の ffi が面白いかもしれない。
standalone の lua インタプリタを使う場合は <code>hererocks</code> がいいのではないか。</p>
<h3>vswhere メモ</h3>
<p><a href="https://github.com/Microsoft/vswhere">https://github.com/Microsoft/vswhere</a></p>
<p><code>cl.exe</code>, <code>msbuild.exe</code> などの探索に使う。
<code>vs2017 version 15.2</code> 以降に入っているらしい。</p>
<p>こんな感じに使う。</p>
<pre class="code literal-block"><span class="err">#</span><span class="w"> </span><span class="o">%</span><span class="n">ProgramFiles</span><span class="p">(</span><span class="n">x86</span><span class="p">)</span><span class="o">%</span><span class="err">\</span><span class="n">Microsoft</span><span class="w"> </span><span class="n">Visual</span><span class="w"> </span><span class="n">Studio</span><span class="err">\</span><span class="n">Installer</span><span class="err">\</span><span class="n">vswhere</span><span class="p">.</span><span class="n">exe</span><span class="w"></span>
<span class="o">&gt;</span><span class="w"> </span><span class="n">vswhere</span><span class="w"> </span><span class="o">-</span><span class="n">nologo</span><span class="w"> </span><span class="o">-</span><span class="n">products</span><span class="w"> </span><span class="o">*</span><span class="w"></span>
<span class="nl">instanceId</span><span class="p">:</span><span class="w"> </span><span class="mi">6762</span><span class="n">dfe1</span><span class="w"></span>
<span class="nl">installDate</span><span class="p">:</span><span class="w"> </span><span class="mi">2020</span><span class="o">/</span><span class="mi">07</span><span class="o">/</span><span class="mi">21</span><span class="w"> </span><span class="mi">9</span><span class="err">:</span><span class="mi">26</span><span class="err">:</span><span class="mi">34</span><span class="w"></span>
<span class="nl">installationName</span><span class="p">:</span><span class="w"> </span><span class="n">VisualStudio</span><span class="o">/</span><span class="mf">16.7.3</span><span class="o">+</span><span class="mf">30503.244</span><span class="w"></span>
<span class="nl">installationPath</span><span class="p">:</span><span class="w"> </span><span class="nl">C</span><span class="p">:</span><span class="err">\</span><span class="n">Program</span><span class="w"> </span><span class="n">Files</span><span class="w"> </span><span class="p">(</span><span class="n">x86</span><span class="p">)</span><span class="err">\</span><span class="n">Microsoft</span><span class="w"> </span><span class="n">Visual</span><span class="w"> </span><span class="n">Studio</span><span class="err">\</span><span class="mi">2019</span><span class="err">\</span><span class="n">BuildTools</span><span class="w"></span>
<span class="nl">installationVersion</span><span class="p">:</span><span class="w"> </span><span class="mf">16.7.30503.244</span><span class="w"></span>
<span class="nl">productId</span><span class="p">:</span><span class="w"> </span><span class="n">Microsoft</span><span class="p">.</span><span class="n">VisualStudio</span><span class="p">.</span><span class="n">Product</span><span class="p">.</span><span class="n">BuildTools</span><span class="w"></span>
<span class="nl">productPath</span><span class="p">:</span><span class="w"> </span><span class="nl">C</span><span class="p">:</span><span class="err">\</span><span class="n">Program</span><span class="w"> </span><span class="n">Files</span><span class="w"> </span><span class="p">(</span><span class="n">x86</span><span class="p">)</span><span class="err">\</span><span class="n">Microsoft</span><span class="w"> </span><span class="n">Visual</span><span class="w"> </span><span class="n">Studio</span><span class="err">\</span><span class="mi">2019</span><span class="err">\</span><span class="n">BuildTools</span><span class="err">\</span><span class="n">Common7</span><span class="err">\</span><span class="n">Tools</span><span class="err">\</span><span class="n">LaunchDevCmd</span><span class="p">.</span><span class="n">bat</span><span class="w"></span>
<span class="k">state</span><span class="err">:</span><span class="w"> </span><span class="mi">4294967295</span><span class="w"></span>
<span class="nl">isComplete</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="nl">isLaunchable</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="nl">isPrerelease</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="nl">isRebootRequired</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="nl">displayName</span><span class="p">:</span><span class="w"> </span><span class="n">Visual</span><span class="w"> </span><span class="n">Studio</span><span class="w"> </span><span class="n">Build</span><span class="w"> </span><span class="n">Tools</span><span class="w"> </span><span class="mi">2019</span><span class="w"></span>
<span class="nl">description</span><span class="p">:</span><span class="w"> </span><span class="n">Visual</span><span class="w"> </span><span class="n">Studio</span><span class="w"> </span><span class="n">Build</span><span class="w"> </span><span class="n">Tools</span><span class="w"> </span><span class="n">では</span><span class="err">、</span><span class="n">Visual</span><span class="w"> </span><span class="n">Studio</span><span class="w"> </span><span class="n">IDE</span><span class="w"> </span><span class="n">を必要とせずに</span><span class="err">、</span><span class="n">MSBuild</span><span class="w"> </span><span class="n">ベースのネイティブ</span><span class="w"> </span><span class="n">マネージド</span><span class="w"> </span><span class="n">アプリケーションをビルドできます</span><span class="err">。</span><span class="n">また</span><span class="err">、</span><span class="n">Visual</span><span class="w"> </span><span class="n">C</span><span class="o">++</span><span class="w"> </span><span class="n">のコンパイラやライブラリ</span><span class="err">、</span><span class="n">MFC</span><span class="err">、</span><span class="n">ATL</span><span class="err">、</span><span class="n">および</span><span class="w"> </span><span class="n">C</span><span class="o">++/</span><span class="n">CLI</span><span class="w"> </span><span class="n">サポートをインストールするオプションも用意されています</span><span class="err">。</span><span class="w"></span>
<span class="nl">channelId</span><span class="p">:</span><span class="w"> </span><span class="n">VisualStudio</span><span class="mf">.16</span><span class="p">.</span><span class="k">Release</span><span class="w"></span>
<span class="nl">channelUri</span><span class="p">:</span><span class="w"> </span><span class="nl">https</span><span class="p">:</span><span class="o">//</span><span class="n">aka</span><span class="p">.</span><span class="n">ms</span><span class="o">/</span><span class="n">vs</span><span class="o">/</span><span class="mi">16</span><span class="o">/</span><span class="k">release</span><span class="o">/</span><span class="n">channel</span><span class="w"></span>
<span class="nl">enginePath</span><span class="p">:</span><span class="w"> </span><span class="nl">C</span><span class="p">:</span><span class="err">\</span><span class="n">Program</span><span class="w"> </span><span class="n">Files</span><span class="w"> </span><span class="p">(</span><span class="n">x86</span><span class="p">)</span><span class="err">\</span><span class="n">Microsoft</span><span class="w"> </span><span class="n">Visual</span><span class="w"> </span><span class="n">Studio</span><span class="err">\</span><span class="n">Installer</span><span class="err">\</span><span class="n">resources</span><span class="err">\</span><span class="n">app</span><span class="err">\</span><span class="n">ServiceHub</span><span class="err">\</span><span class="n">Services</span><span class="err">\</span><span class="n">Microsoft</span><span class="p">.</span><span class="n">VisualStudio</span><span class="p">.</span><span class="n">Setup</span><span class="p">.</span><span class="n">Service</span><span class="w"></span>
<span class="nl">releaseNotes</span><span class="p">:</span><span class="w"> </span><span class="nl">https</span><span class="p">:</span><span class="o">//</span><span class="k">go</span><span class="p">.</span><span class="n">microsoft</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="n">fwlink</span><span class="o">/</span><span class="vm">?</span><span class="n">LinkId</span><span class="o">=</span><span class="mi">660893</span><span class="n">#16</span><span class="mf">.7.3</span><span class="w"></span>
<span class="nl">thirdPartyNotices</span><span class="p">:</span><span class="w"> </span><span class="nl">https</span><span class="p">:</span><span class="o">//</span><span class="k">go</span><span class="p">.</span><span class="n">microsoft</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="n">fwlink</span><span class="o">/</span><span class="vm">?</span><span class="n">LinkId</span><span class="o">=</span><span class="mi">660909</span><span class="w"></span>
<span class="nl">updateDate</span><span class="p">:</span><span class="w"> </span><span class="mi">2020</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">13</span><span class="nl">T06</span><span class="p">:</span><span class="mi">19</span><span class="err">:</span><span class="mf">26.0508205</span><span class="n">Z</span><span class="w"></span>
<span class="nl">catalog_buildBranch</span><span class="p">:</span><span class="w"> </span><span class="n">d16</span><span class="mf">.7</span><span class="w"></span>
<span class="nl">catalog_buildVersion</span><span class="p">:</span><span class="w"> </span><span class="mf">16.7.30503.244</span><span class="w"></span>
<span class="nl">catalog_id</span><span class="p">:</span><span class="w"> </span><span class="n">VisualStudio</span><span class="o">/</span><span class="mf">16.7.3</span><span class="o">+</span><span class="mf">30503.244</span><span class="w"></span>
<span class="nl">catalog_localBuild</span><span class="p">:</span><span class="w"> </span><span class="n">build</span><span class="o">-</span><span class="n">lab</span><span class="w"></span>
<span class="nl">catalog_manifestName</span><span class="p">:</span><span class="w"> </span><span class="n">VisualStudio</span><span class="w"></span>
<span class="nl">catalog_manifestType</span><span class="p">:</span><span class="w"> </span><span class="n">installer</span><span class="w"></span>
<span class="nl">catalog_productDisplayVersion</span><span class="p">:</span><span class="w"> </span><span class="mf">16.7.3</span><span class="w"></span>
<span class="nl">catalog_productLine</span><span class="p">:</span><span class="w"> </span><span class="n">Dev16</span><span class="w"></span>
<span class="nl">catalog_productLineVersion</span><span class="p">:</span><span class="w"> </span><span class="mi">2019</span><span class="w"></span>
<span class="nl">catalog_productMilestone</span><span class="p">:</span><span class="w"> </span><span class="n">RTW</span><span class="w"></span>
<span class="nl">catalog_productMilestoneIsPreRelease</span><span class="p">:</span><span class="w"> </span><span class="k">False</span><span class="w"></span>
<span class="nl">catalog_productName</span><span class="p">:</span><span class="w"> </span><span class="n">Visual</span><span class="w"> </span><span class="n">Studio</span><span class="w"></span>
<span class="nl">catalog_productPatchVersion</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="w"></span>
<span class="nl">catalog_productPreReleaseMilestoneSuffix</span><span class="p">:</span><span class="w"> </span><span class="mf">1.0</span><span class="w"></span>
<span class="nl">catalog_productSemanticVersion</span><span class="p">:</span><span class="w"> </span><span class="mf">16.7.3</span><span class="o">+</span><span class="mf">30503.244</span><span class="w"></span>
<span class="nl">catalog_requiredEngineVersion</span><span class="p">:</span><span class="w"> </span><span class="mf">2.7.3132.26759</span><span class="w"></span>
<span class="nl">properties_campaignId</span><span class="p">:</span><span class="w"></span>
<span class="nl">properties_channelManifestId</span><span class="p">:</span><span class="w"> </span><span class="n">VisualStudio</span><span class="mf">.16</span><span class="p">.</span><span class="k">Release</span><span class="o">/</span><span class="mf">16.7.3</span><span class="o">+</span><span class="mf">30503.244</span><span class="w"></span>
<span class="nl">properties_nickname</span><span class="p">:</span><span class="w"></span>
<span class="nl">properties_setupEngineFilePath</span><span class="p">:</span><span class="w"> </span><span class="nl">C</span><span class="p">:</span><span class="err">\</span><span class="n">Program</span><span class="w"> </span><span class="n">Files</span><span class="w"> </span><span class="p">(</span><span class="n">x86</span><span class="p">)</span><span class="err">\</span><span class="n">Microsoft</span><span class="w"> </span><span class="n">Visual</span><span class="w"> </span><span class="n">Studio</span><span class="err">\</span><span class="n">Installer</span><span class="err">\</span><span class="n">vs_installershell</span><span class="p">.</span><span class="n">exe</span><span class="w"></span>
</pre>
<p><a href="https://github.com/microsoft/vswhere/wiki/Find-VC">https://github.com/microsoft/vswhere/wiki/Find-VC</a></p>
<p>フィルタをかけられる。</p>
<pre class="code literal-block">&gt; vswhere -latest -products * -requires Microsoft.VisualStudio.Component.VC.Tools.x86.x64 -property installationPath
C:\Program Files (x86)\Microsoft Visual Studio\2019\BuildTools
</pre>
<p>見つかったパスから先は固定であるとみなして、 <code>vcvars64.bat</code> などを見つける。</p>

<hr>
<ul class="pager hidden-print">
<li class="previous">
        <a href="../lua_debug_adapter/" rel="prev" title="lua の DebugAdapter を書いてみた">
            lua の DebugAdapter を書いてみた 👈
        </a>
    </li>
    <li style="flex-grow: 1">
    <li class="next">
        <a href="../../../github/limgui/" rel="next" title="limgui">
            👉 limgui
        </a>
    </li>
</ul></main><footer id="footer"><p>
            Powered by
            <a href="https://getnikola.com" rel="nofollow">Nikola</a>
        </p>
    </footer>
</body>
</html>
