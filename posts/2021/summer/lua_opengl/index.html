<!DOCTYPE html>
<html><body>
    <h1 id="brand">
        <a href="../../../../" title="三次元日誌" rel="home">
            <span id="blog-title">三次元日誌</span>
        </a>
    </h1>
    <hr>
<main id="content"><h1 class="p-name entry-title" itemprop="headline name">
    <a href="." class="u-url">Lua で OpenGL</a>
</h1>
<div>
<p>imgui bind がだいたいできて軌道に乗ったので、glTF viewer の作成にとりかかる。</p>
<p><a href="https://www.glfw.org/docs/latest/quick.html">https://www.glfw.org/docs/latest/quick.html</a></p>
<p>の回転アニメーション以外できた。</p>
<h2>luajit の cdef で頂点配列の定義が捗る</h2>
<pre class="code literal-block"><span></span><span class="k">static</span> <span class="k">const</span> <span class="k">struct</span>
<span class="p">{</span>
    <span class="kt">float</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">r</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">b</span><span class="p">;</span>
<span class="p">}</span> <span class="n">vertices</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span>
<span class="p">{</span>
    <span class="p">{</span> <span class="o">-</span><span class="mf">0.6f</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.4f</span><span class="p">,</span> <span class="mf">1.f</span><span class="p">,</span> <span class="mf">0.f</span><span class="p">,</span> <span class="mf">0.f</span> <span class="p">},</span>
    <span class="p">{</span>  <span class="mf">0.6f</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.4f</span><span class="p">,</span> <span class="mf">0.f</span><span class="p">,</span> <span class="mf">1.f</span><span class="p">,</span> <span class="mf">0.f</span> <span class="p">},</span>
    <span class="p">{</span>   <span class="mf">0.f</span><span class="p">,</span>  <span class="mf">0.6f</span><span class="p">,</span> <span class="mf">0.f</span><span class="p">,</span> <span class="mf">0.f</span><span class="p">,</span> <span class="mf">1.f</span> <span class="p">}</span>
<span class="p">};</span>
</pre>

<p>が、</p>
<pre class="code literal-block"><span></span><span class="n">ffi</span><span class="p">.</span><span class="n">cdef</span><span class="p">(</span><span class="s">[[</span>
<span class="s">struct Vertex2DRGB</span>
<span class="s">{</span>
<span class="s">    float x, y;</span>
<span class="s">    float r, g, b;</span>
<span class="s">};</span>
<span class="s">]]</span><span class="p">)</span>

<span class="kd">local</span> <span class="n">vertices</span> <span class="o">=</span> <span class="n">ffi</span><span class="p">.</span><span class="n">new</span><span class="p">(</span>
    <span class="s2">"struct Vertex2DRGB[3]"</span><span class="p">,</span>
    <span class="p">{</span> <span class="o">-</span><span class="mf">0.6</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.4</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span> <span class="p">},</span>
    <span class="p">{</span> <span class="mf">0.6</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">0.</span> <span class="p">},</span>
    <span class="p">{</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span> <span class="p">}</span>
<span class="p">)</span>
</pre>

<p>などという書き方ができてしまう。luajit ffi 強い。</p>
<h2>ffi.metatype</h2>
<p>luajit を活かした線形代数ライブラリを探索していて、</p>
<p><a href="https://github.com/bjornbytes/maf">https://github.com/bjornbytes/maf</a></p>
<p>を見つけた。</p>
<p>luajit ffi には便利関数</p>
<pre class="code literal-block"><span></span>ffi.metatype(ct, metatable)
</pre>

<p>があって、これを使うと ffi.cdef した C の struct に lua の metatable を合体できる。</p>
<p>線形代数ライブラリは、 <code>ffi.metatype</code> を使って自作してみよう(mafにはvec3 と quaternion しかないのもあり)。
ついでに、lua の unittest を取り入れましょう。</p>
<h2>20210830</h2>
<p><code>mat4</code> を実装してみた。</p>
<p><a href="https://github.com/ousttrue/limgui/blob/master/lua/mafex.lua">https://github.com/ousttrue/limgui/blob/master/lua/mafex.lua</a></p>
<pre class="code literal-block"><span></span>    <span class="k">typedef</span> <span class="k">union</span> <span class="p">{</span>
        <span class="k">struct</span> <span class="p">{</span>
            <span class="kt">float</span> <span class="n">_11</span><span class="p">,</span> <span class="n">_12</span><span class="p">,</span> <span class="n">_13</span><span class="p">,</span> <span class="n">_14</span><span class="p">;</span>
            <span class="kt">float</span> <span class="n">_21</span><span class="p">,</span> <span class="n">_22</span><span class="p">,</span> <span class="n">_23</span><span class="p">,</span> <span class="n">_24</span><span class="p">;</span>
            <span class="kt">float</span> <span class="n">_31</span><span class="p">,</span> <span class="n">_32</span><span class="p">,</span> <span class="n">_33</span><span class="p">,</span> <span class="n">_34</span><span class="p">;</span>
            <span class="kt">float</span> <span class="n">_41</span><span class="p">,</span> <span class="n">_42</span><span class="p">,</span> <span class="n">_43</span><span class="p">,</span> <span class="n">_44</span><span class="p">;</span>
        <span class="p">};</span>
        <span class="kt">float</span> <span class="n">array</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
    <span class="p">}</span> <span class="n">mat4</span><span class="p">;</span>
</pre>

<p>という定義で OpenGL の uniform 変数に直接渡せるので使いやすい。</p>
</div>
    </main>
</body></html>
