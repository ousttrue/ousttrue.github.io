<!DOCTYPE html>
<html><body>
    <h1 id="brand">
        <a href="../../../../" title="三次元日誌" rel="home">
            <span id="blog-title">三次元日誌</span>
        </a>
    </h1>
    <hr>
<main id="content"><h1 class="p-name entry-title" itemprop="headline name">
    <a href="." class="u-url">nvim frontend nvy</a>
</h1>
<div>
<p>よさげなレポジトリを発見した。</p>
<p><a href="https://github.com/RMichelsen/Nvy">https://github.com/RMichelsen/Nvy</a></p>
<p>だいぶ前に作ろうとして頓挫した</p>
<p><a href="https://github.com/ousttrue/nvim-dx">https://github.com/ousttrue/nvim-dx</a></p>
<p>の完成形。
どこがうまくいかなかったのか忘れてしまったが。</p>
<h3>改造</h3>
<p><a href="https://github.com/ousttrue/Nvy">https://github.com/ousttrue/Nvy</a></p>
<ul>
<li>[ ] RenderTarget に対して Nvim をレンダリングする</li>
<li>[x] nvim の IO を <a href="https://think-async.com/Asio/#">https://think-async.com/Asio/#</a> にのせる</li>
<li>[ ] imgui と合体する</li>
</ul>
<h2>20210815</h2>
<p>MsgPack-RPC のバックエンドに昔作った</p>
<p><a href="https://github.com/ousttrue/msgpack-rpc-asio">https://github.com/ousttrue/msgpack-rpc-asio</a></p>
<p>におきかえる。</p>
<p>さらに、これのシリアライザーを自前の <a href="https://github.com/ousttrue/msgpackpp">https://github.com/ousttrue/msgpackpp</a> におきかえる。</p>
<ul>
<li>CMake 化</li>
<li>RPC を <code>c++20</code> 化 (co_await)</li>
</ul>
<p>で、最初の nvim 初期化を</p>
<pre class="code literal-block"><span></span><span class="k">auto</span> <span class="n">api_info</span> <span class="o">=</span> <span class="n">co_await</span> <span class="n">rpc</span><span class="p">.</span><span class="n">request</span><span class="p">(</span><span class="s">"nvim_get_api_info"</span><span class="p">);</span>
<span class="n">rpc</span><span class="p">.</span><span class="n">notity</span><span class="p">(</span><span class="s">"nvim_set_var"</span><span class="p">,</span> <span class="s">"nvy"</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="k">auto</span> <span class="n">path</span> <span class="o">=</span> <span class="n">co_await</span> <span class="n">rpc</span><span class="p">.</span><span class="n">request</span><span class="p">(</span><span class="s">"nvim_eval"</span><span class="p">,</span><span class="s">"stdpath('config')"</span><span class="p">);</span>

<span class="c1">// initialize</span>

<span class="n">rpc</span><span class="p">.</span><span class="n">notify</span><span class="p">(</span><span class="s">"nvim_ui_attach"</span><span class="p">);</span>

<span class="n">rpc</span><span class="p">.</span><span class="n">on_message</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dispatcher</span><span class="p">);</span>
</pre>

<p>のように書けるようにして整理する。</p>
<h2>20210829</h2>
<ul>
<li>[x] MsgPack-RPC のバックエンドを置きかえた</li>
<li>[x] logger に RPC の内容を JSON 化して表示</li>
</ul>
<p>だいたいリファクタリングが終わって改造しやすい状態になった。</p>
<ul>
<li>[x] <code>&lt;C-/&gt;</code> できるようにする。</li>
</ul>
<p>を実装できた。
特定の VK が来たときに nvim のキーに変換するテーブルがあるので追加した。</p>
<pre class="code literal-block"><span></span>  <span class="k">case</span> <span class="nl">VK_OEM_2</span><span class="p">:</span>
    <span class="k">return</span> <span class="s">""</span><span class="p">;</span>
</pre>

<p><code>[2,"nvim_input",["&lt;C-/&gt;"]]</code> が送信される。</p>
<h3>修正が必要</h3>
<p>非control時に</p>
<p><code>[2,"nvim_input",[""]]</code> が送信される。</p>
<pre class="code literal-block"><span></span>  <span class="k">case</span> <span class="nl">VK_OEM_2</span><span class="p">:</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">GetKeyState</span><span class="p">(</span><span class="n">VK_CONTROL</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// C-/</span>
      <span class="k">return</span> <span class="s">"/"</span><span class="p">;</span>
    <span class="p">}</span>
</pre>

<p>なるほど。</p>
<p><a href="@/posts/2021/summer/nvimtexture.md">NvimTexture</a> へ続く</p>
<h2>20210829  太字がずれる？</h2>
</div>
    </main>
</body></html>
