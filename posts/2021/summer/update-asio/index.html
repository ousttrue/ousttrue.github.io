<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <title>三次元日誌</title>

    

  <script src="https://ousttrue.github.io/plugins/elasticlunr.min.js" defer></script>
  <script src="https://ousttrue.github.io/search_index.en.js" defer></script>
  <script src="https://ousttrue.github.io/js/search.js" defer></script>

    

     
    <link rel="stylesheet" href="https://ousttrue.github.io/main.css">
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css"
      />
    
  </head>

  <body class="container">
    <a class="site_title" href="https:&#x2F;&#x2F;ousttrue.github.io&#x2F;">
      <div>三次元日誌</div>
    </a>

    <nav class="nav">
      <a class="item" href="/tags/">tags</a>
      <a class="item" href="https://github.com/ousttrue" aria-label="github">
        <i class="fab fa-github fa-lg"></i>
      </a>
      

        
            <form class="navbar-form">
                <input id="userinput" class="form-control is-search" type="search" placeholder="Search docs..."
                    aria-label="Search docs..." autocomplete="off">
                <div id="suggestions" class="shadow bg-white rounded"></div>
            </form>
        
    </nav>

    <main class="main">
<div class="page">
<div class="content">
  <div class="headline">
  
  

  
  <a class="headline_title" href="https:&#x2F;&#x2F;ousttrue.github.io&#x2F;posts&#x2F;2021&#x2F;summer&#x2F;update-asio&#x2F;"> Asio と Coroutine (c++20) 
  

  
  </a>

  

  <div>
    <ul class="tags">
      <li class="headline_date">
        <div class="year">2021</div>
        <div class="md">0815</div>
      </li>
      
      <li class="headline_date updated">
        <div class="year">2021</div>
        <div class="md">0818</div>
      </li>
      
      


    <li class="tag"><a href="https:&#x2F;&#x2F;ousttrue.github.io&#x2F;tags&#x2F;cpp&#x2F;">cpp</a></li>

    <li class="tag"><a href="https:&#x2F;&#x2F;ousttrue.github.io&#x2F;tags&#x2F;asio&#x2F;">asio</a></li>




    </ul>
  </div>
</div>
 <p>非同期ライブラリ ASIO </p>
<p><a href="http://think-async.com/Asio/index.html">http://think-async.com/Asio/index.html</a></p>
<p>の知識を <code>c++20</code> 時代にアップデート。</p>
<ul>
<li><a href="https://github.com/chriskohlhoff/talking-async">https://github.com/chriskohlhoff/talking-async</a></li>
</ul>
<p>に動画と動画のサンプルコードが有る。</p>
<h1 id="compiler-wozui-xin-nisuru">compiler を最新にする</h1>
<p><code>ASIO_HAS_CO_AWAIT</code> が必要でこれが有効になるには新しいコンパイラが必要。</p>
<pre style="background-color:#2b303b;">
<code class="language-c++" data-lang="c++"><span style="color:#65737e;">// asio/detail/config.hpp`</span><span style="color:#65737e;">
</span><span style="color:#c0c5ce;">
</span><span style="color:#65737e;">// Support the co_await keyword on compilers known to allow it.</span><span style="color:#65737e;">
</span><span style="color:#b48ead;">#if</span><span style="color:#c0c5ce;"> !</span><span style="color:#b48ead;">defined</span><span style="color:#c0c5ce;">(ASIO_HAS_CO_AWAIT)</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;"># if</span><span style="color:#c0c5ce;"> !</span><span style="color:#b48ead;">defined</span><span style="color:#c0c5ce;">(ASIO_DISABLE_CO_AWAIT)</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">#  if defined</span><span style="color:#c0c5ce;">(ASIO_MSVC)</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">#   if</span><span style="color:#c0c5ce;"> (_MSC_VER &gt;= 1928) &amp;&amp; (_MSVC_LANG &gt;= 201705) &amp;&amp; !</span><span style="color:#b48ead;">defined</span><span style="color:#c0c5ce;">(__clang__)</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">#    define </span><span style="color:#c0c5ce;">ASIO_HAS_CO_AWAIT </span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">#   elif</span><span style="color:#c0c5ce;"> (_MSC_FULL_VER &gt;= 190023506)</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">#    if defined</span><span style="color:#c0c5ce;">(_RESUMABLE_FUNCTIONS_SUPPORTED)</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">#     define </span><span style="color:#c0c5ce;">ASIO_HAS_CO_AWAIT </span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">#    endif </span><span style="color:#65737e;">// defined(_RESUMABLE_FUNCTIONS_SUPPORTED)</span><span style="color:#65737e;">
</span><span style="color:#b48ead;">#   endif </span><span style="color:#65737e;">// (_MSC_FULL_VER &gt;= 190023506)</span><span style="color:#65737e;">
</span><span style="color:#b48ead;">#  elif defined</span><span style="color:#c0c5ce;">(__clang__)</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">#   if</span><span style="color:#c0c5ce;"> (__cplusplus &gt;= 201703) &amp;&amp; (__cpp_coroutines &gt;= 201703)</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">#    if</span><span style="color:#c0c5ce;"> __has_include(&lt;experimental/coroutine&gt;)</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">#     define </span><span style="color:#c0c5ce;">ASIO_HAS_CO_AWAIT </span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">#    endif </span><span style="color:#65737e;">// __has_include(&lt;experimental/coroutine&gt;)</span><span style="color:#65737e;">
</span><span style="color:#b48ead;">#   endif </span><span style="color:#65737e;">// (__cplusplus &gt;= 201703) &amp;&amp; (__cpp_coroutines &gt;= 201703)</span><span style="color:#65737e;">
</span><span style="color:#b48ead;">#  elif defined</span><span style="color:#c0c5ce;">(__GNUC__)</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">#   if</span><span style="color:#c0c5ce;"> (__cplusplus &gt;= 201709) &amp;&amp; (__cpp_impl_coroutine &gt;= 201902)</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">#    if</span><span style="color:#c0c5ce;"> __has_include(&lt;coroutine&gt;)</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">#     define </span><span style="color:#c0c5ce;">ASIO_HAS_CO_AWAIT </span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">#    endif </span><span style="color:#65737e;">// __has_include(&lt;coroutine&gt;)</span><span style="color:#65737e;">
</span><span style="color:#b48ead;">#   endif </span><span style="color:#65737e;">// (__cplusplus &gt;= 201709) &amp;&amp; (__cpp_impl_coroutine &gt;= 201902)</span><span style="color:#65737e;">
</span><span style="color:#b48ead;">#  endif </span><span style="color:#65737e;">// defined(__GNUC__)</span><span style="color:#65737e;">
</span><span style="color:#b48ead;"># endif </span><span style="color:#65737e;">// !defined(ASIO_DISABLE_CO_AWAIT)</span><span style="color:#65737e;">
</span><span style="color:#b48ead;">#endif </span><span style="color:#65737e;">// !defined(ASIO_HAS_CO_AWAIT)</span><span style="color:#65737e;">
</span></code></pre><h2 id="vc2019-20210818zui-xin-ban-ikeru">VC2019(20210818最新版いける)</h2>
<p><a href="https://devblogs.microsoft.com/cppblog/c-coroutines-in-visual-studio-2019-version-16-8/">https://devblogs.microsoft.com/cppblog/c-coroutines-in-visual-studio-2019-version-16-8/</a></p>
<blockquote>
<p>C++20 coroutines in Visual Studio 2019 version 16.8.</p>
</blockquote>
<ul>
<li><code>16.7.3</code> だめ</li>
<li><code>16.11.1</code> 動いた。</li>
</ul>
<pre style="background-color:#2b303b;">
<code><span style="color:#c0c5ce;"># CMakeListx.txt</span><span style="color:#c0c5ce;">
set(TARGET_NAME pingpong)</span><span style="color:#c0c5ce;">
add_executable(${TARGET_NAME} main.cpp)</span><span style="color:#c0c5ce;">
target_link_libraries(${TARGET_NAME} PRIVATE asio)</span><span style="color:#c0c5ce;">
set_property(TARGET ${TARGET_NAME} PROPERTY CXX_STANDARD 20) # 必要</span><span style="color:#c0c5ce;">
target_compile_options(${TARGET_NAME} PUBLIC $&lt;$&lt;C_COMPILER_ID:MSVC&gt;:/await&gt;) # 必要</span><span style="color:#c0c5ce;">
target_compile_definitions(asio INTERFACE ASIO_DISABLE_STD_COROUTINE) # 必要</span><span style="color:#c0c5ce;">
</span></code></pre><pre style="background-color:#2b303b;">
<code class="language-cpp" data-lang="cpp"><span style="color:#b48ead;">#if defined</span><span style="color:#c0c5ce;">(ASIO_HAS_STD_COROUTINE)</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;"># include </span><span style="color:#c0c5ce;">&lt;</span><span style="color:#a3be8c;">coroutine</span><span style="color:#c0c5ce;">&gt;</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">#else </span><span style="color:#65737e;">// defined(ASIO_HAS_STD_COROUTINE)</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;"># include </span><span style="color:#c0c5ce;">&lt;</span><span style="color:#a3be8c;">experimental/coroutine</span><span style="color:#c0c5ce;">&gt;</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">#endif </span><span style="color:#65737e;">// defined(ASIO_HAS_STD_COROUTINE)</span><span style="color:#65737e;">
</span></code></pre><h2 id="llvm-12-umakuikazu-zhui-jia-nokomandorainyin-shu-ka">LLVM-12(うまくいかず。追加のコマンドライン引数か)</h2>
<p><a href="https://clang.llvm.org/cxx_status.html">https://clang.llvm.org/cxx_status.html</a></p>
<p>LLVM-12 だと、</p>
<pre style="background-color:#2b303b;">
<code><span style="color:#c0c5ce;"> &#39;C:\Program Files\LLVM\bin\clang.exe&#39; -v</span><span style="color:#c0c5ce;">
clang version 12.0.1</span><span style="color:#c0c5ce;">
Target: x86_64-pc-windows-msvc</span><span style="color:#c0c5ce;">
Thread model: posix</span><span style="color:#c0c5ce;">
InstalledDir: C:\Program Files\LLVM\bin</span><span style="color:#c0c5ce;">
</span></code></pre>
<p>わからん。</p>
<h1 id="kodo">コード</h1>
<pre style="background-color:#2b303b;">
<code class="language-cpp" data-lang="cpp"><span style="color:#b48ead;">#include </span><span style="color:#c0c5ce;">&lt;</span><span style="color:#a3be8c;">asio/awaitable.hpp</span><span style="color:#c0c5ce;">&gt;</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">#include </span><span style="color:#c0c5ce;">&lt;</span><span style="color:#a3be8c;">asio/co_spawn.hpp</span><span style="color:#c0c5ce;">&gt;</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">#include </span><span style="color:#c0c5ce;">&lt;</span><span style="color:#a3be8c;">asio/detached.hpp</span><span style="color:#c0c5ce;">&gt;</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">#include </span><span style="color:#c0c5ce;">&lt;</span><span style="color:#a3be8c;">asio/experimental/as_tuple.hpp</span><span style="color:#c0c5ce;">&gt;</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">#include </span><span style="color:#c0c5ce;">&lt;</span><span style="color:#a3be8c;">asio/io_context.hpp</span><span style="color:#c0c5ce;">&gt;</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">#include </span><span style="color:#c0c5ce;">&lt;</span><span style="color:#a3be8c;">asio/ip/tcp.hpp</span><span style="color:#c0c5ce;">&gt;</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">#include </span><span style="color:#c0c5ce;">&lt;</span><span style="color:#a3be8c;">asio/read.hpp</span><span style="color:#c0c5ce;">&gt;</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">#include </span><span style="color:#c0c5ce;">&lt;</span><span style="color:#a3be8c;">asio/streambuf.hpp</span><span style="color:#c0c5ce;">&gt;</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">#include </span><span style="color:#c0c5ce;">&lt;</span><span style="color:#a3be8c;">asio/system_timer.hpp</span><span style="color:#c0c5ce;">&gt;</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">#include </span><span style="color:#c0c5ce;">&lt;</span><span style="color:#a3be8c;">asio/use_awaitable.hpp</span><span style="color:#c0c5ce;">&gt;</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">#include </span><span style="color:#c0c5ce;">&lt;</span><span style="color:#a3be8c;">asio/use_future.hpp</span><span style="color:#c0c5ce;">&gt;</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">#include </span><span style="color:#c0c5ce;">&lt;</span><span style="color:#a3be8c;">asio/write.hpp</span><span style="color:#c0c5ce;">&gt;</span><span style="color:#c0c5ce;">
</span></code></pre><h2 id="co-spawn-de-awaitable-woqi-dong-suru">co_spawn で awaitable を起動する</h2>
<p>coroutine は 戻り値の型が <code>asio::awaitable&lt;T&gt;</code> である必要がある。この関数の中で <code>co_await</code>, <code>co_yield</code>, <code>co_return</code> が使える。
coroutine は lambda でもよいので、下記のようにできる。</p>
<pre style="background-color:#2b303b;">
<code class="language-cpp" data-lang="cpp"><span style="color:#c0c5ce;">  </span><span style="color:#b48ead;">auto</span><span style="color:#c0c5ce;"> co = []() -&gt; </span><span style="color:#bf616a;">asio</span><span style="color:#c0c5ce;">::</span><span style="color:#bf616a;">awaitable</span><span style="color:#c0c5ce;">&lt;std::string&gt; {</span><span style="color:#c0c5ce;">
    co_return &quot;</span><span style="color:#a3be8c;">result</span><span style="color:#c0c5ce;">&quot;;</span><span style="color:#c0c5ce;">
  };</span><span style="color:#c0c5ce;">
  </span><span style="color:#b48ead;">auto</span><span style="color:#c0c5ce;"> result =</span><span style="color:#c0c5ce;">
      asio::</span><span style="color:#8fa1b3;">co_spawn</span><span style="color:#c0c5ce;">(client_context.</span><span style="color:#bf616a;">get_executor</span><span style="color:#c0c5ce;">(), </span><span style="color:#bf616a;">co</span><span style="color:#c0c5ce;">, asio::</span><span style="color:#bf616a;">use_future</span><span style="color:#c0c5ce;">); </span><span style="color:#65737e;">// coroutine 登録</span><span style="color:#65737e;">
</span><span style="color:#c0c5ce;">  client_context.</span><span style="color:#bf616a;">run</span><span style="color:#c0c5ce;">(); </span><span style="color:#65737e;">// ループを回す</span><span style="color:#65737e;">
  </span><span style="color:#b48ead;">auto</span><span style="color:#c0c5ce;"> pong = result.</span><span style="color:#bf616a;">get</span><span style="color:#c0c5ce;">(); </span><span style="color:#65737e;">// future から結果を得る</span><span style="color:#65737e;">
</span><span style="color:#c0c5ce;">  std::cout &lt;&lt; &quot;</span><span style="color:#a3be8c;">pong: </span><span style="color:#c0c5ce;">&quot; &lt;&lt; pong &lt;&lt; std::endl;</span><span style="color:#c0c5ce;">
</span></code></pre>
<p>asio::use_future を使うことで返り値 <code>std::future</code> になるので <code>co_return</code> の値を得ることも可能。
結果に興味がないときは、<code>asio::detached</code> でよい。
Completion Handler というコールバックなので、 promise に set_value する関数を自前で書いたりしてもよい様子。
<code>asio::use_awaitable</code> で <code>co_await</code> するのも可能。</p>
<p>返り値が <code>std::tuple&lt;asio::error_code, RESULT&gt;</code> になるハンドラ。</p>
<pre style="background-color:#2b303b;">
<code class="language-cpp" data-lang="cpp"><span style="color:#b48ead;">constexpr auto</span><span style="color:#c0c5ce;"> use_nothrow_awaitable =</span><span style="color:#c0c5ce;">
    asio::experimental::</span><span style="color:#8fa1b3;">as_tuple</span><span style="color:#c0c5ce;">(asio::</span><span style="color:#bf616a;">use_awaitable</span><span style="color:#c0c5ce;">);</span><span style="color:#c0c5ce;">
</span></code></pre><h2 id="client-side">client side</h2>
<ul>
<li>timer</li>
<li>connect</li>
<li>send(ping)</li>
<li>receive(pong)</li>
</ul>
<pre style="background-color:#2b303b;">
<code class="language-cpp" data-lang="cpp"><span style="color:#c0c5ce;">  </span><span style="color:#b48ead;">auto</span><span style="color:#c0c5ce;"> co = [&amp;context = client_context, ep]() -&gt; </span><span style="color:#bf616a;">asio</span><span style="color:#c0c5ce;">::</span><span style="color:#bf616a;">awaitable</span><span style="color:#c0c5ce;">&lt;std::string&gt; {</span><span style="color:#c0c5ce;">
    std::cout &lt;&lt; &quot;</span><span style="color:#a3be8c;">[client]wait 1000ms...</span><span style="color:#c0c5ce;">&quot; &lt;&lt; std::endl;</span><span style="color:#c0c5ce;">
    asio::system_timer </span><span style="color:#bf616a;">timer</span><span style="color:#c0c5ce;">(context);</span><span style="color:#c0c5ce;">
    timer.</span><span style="color:#bf616a;">expires_from_now</span><span style="color:#c0c5ce;">(</span><span style="color:#d08770;">1000</span><span style="color:#b48ead;">ms</span><span style="color:#c0c5ce;">);</span><span style="color:#c0c5ce;">
    co_await timer.</span><span style="color:#bf616a;">async_wait</span><span style="color:#c0c5ce;">(asio::use_awaitable);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
    std::cout &lt;&lt; &quot;</span><span style="color:#a3be8c;">[client]connect: </span><span style="color:#c0c5ce;">&quot; &lt;&lt; ep &lt;&lt; &quot;</span><span style="color:#a3be8c;">...</span><span style="color:#c0c5ce;">&quot; &lt;&lt; std::endl;</span><span style="color:#c0c5ce;">
    asio::ip::tcp::socket </span><span style="color:#bf616a;">socket</span><span style="color:#c0c5ce;">(context);</span><span style="color:#c0c5ce;">
    co_await socket.</span><span style="color:#bf616a;">async_connect</span><span style="color:#c0c5ce;">(ep, asio::use_awaitable);</span><span style="color:#c0c5ce;">
    std::cout &lt;&lt; &quot;</span><span style="color:#a3be8c;">[client]connected</span><span style="color:#c0c5ce;">&quot; &lt;&lt; std::endl;</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
    std::cout &lt;&lt; &quot;</span><span style="color:#a3be8c;">[client]ping...</span><span style="color:#c0c5ce;">&quot; &lt;&lt; std::endl;</span><span style="color:#c0c5ce;">
    std::string </span><span style="color:#bf616a;">ping</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">ping</span><span style="color:#c0c5ce;">&quot;);</span><span style="color:#c0c5ce;">
    </span><span style="color:#b48ead;">auto</span><span style="color:#c0c5ce;"> write_size = co_await asio::</span><span style="color:#bf616a;">async_write</span><span style="color:#c0c5ce;">(socket, asio::</span><span style="color:#bf616a;">buffer</span><span style="color:#c0c5ce;">(ping),</span><span style="color:#c0c5ce;">
                                                 asio::use_awaitable);</span><span style="color:#c0c5ce;">
    </span><span style="color:#96b5b4;">assert</span><span style="color:#c0c5ce;">(write_size == </span><span style="color:#d08770;">4</span><span style="color:#c0c5ce;">);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
    std::cout &lt;&lt; &quot;</span><span style="color:#a3be8c;">[client]read...</span><span style="color:#c0c5ce;">&quot; &lt;&lt; std::endl;</span><span style="color:#c0c5ce;">
    asio::streambuf buf;</span><span style="color:#c0c5ce;">
    </span><span style="color:#b48ead;">auto</span><span style="color:#c0c5ce;"> read_size = co_await asio::</span><span style="color:#bf616a;">async_read</span><span style="color:#c0c5ce;">(</span><span style="color:#c0c5ce;">
        socket, buf, asio::</span><span style="color:#bf616a;">transfer_at_least</span><span style="color:#c0c5ce;">(</span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">), asio::use_awaitable);</span><span style="color:#c0c5ce;">
    co_return </span><span style="color:#bf616a;">to_string</span><span style="color:#c0c5ce;">(buf);</span><span style="color:#c0c5ce;">
  };</span><span style="color:#c0c5ce;">
</span></code></pre><h2 id="server-side">server side</h2>
<pre style="background-color:#2b303b;">
<code class="language-cpp" data-lang="cpp"><span style="color:#b48ead;">class </span><span style="color:#ebcb8b;">server </span><span style="color:#eff1f5;">{</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">
  asio::io_context </span><span style="color:#c0c5ce;">&amp;</span><span style="color:#eff1f5;">_context;</span><span style="color:#eff1f5;">
  asio::ip::tcp::acceptor _acceptor;</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">
</span><span style="color:#b48ead;">public</span><span style="color:#eff1f5;">:</span><span style="color:#eff1f5;">
  </span><span style="color:#8fa1b3;">server</span><span style="color:#eff1f5;">(asio::io_context </span><span style="color:#c0c5ce;">&amp;</span><span style="color:#bf616a;">context</span><span style="color:#eff1f5;">) : </span><span style="color:#bf616a;">_context</span><span style="color:#eff1f5;">(context), </span><span style="color:#bf616a;">_acceptor</span><span style="color:#eff1f5;">(context) {}</span><span style="color:#eff1f5;">
  </span><span style="color:#8fa1b3;">~server</span><span style="color:#eff1f5;">() {}</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">
  </span><span style="color:#b48ead;">void </span><span style="color:#8fa1b3;">listen</span><span style="color:#eff1f5;">(</span><span style="color:#b48ead;">const</span><span style="color:#eff1f5;"> asio::ip::tcp::endpoint </span><span style="color:#c0c5ce;">&amp;</span><span style="color:#bf616a;">ep</span><span style="color:#eff1f5;">) {</span><span style="color:#eff1f5;">
    std::cout </span><span style="color:#c0c5ce;">&lt;&lt; &quot;</span><span style="color:#a3be8c;">[server]listen: </span><span style="color:#c0c5ce;">&quot; &lt;&lt;</span><span style="color:#eff1f5;"> ep </span><span style="color:#c0c5ce;">&lt;&lt; &quot;</span><span style="color:#a3be8c;">...</span><span style="color:#c0c5ce;">&quot; &lt;&lt;</span><span style="color:#eff1f5;"> std::endl;</span><span style="color:#eff1f5;">
    _acceptor.</span><span style="color:#bf616a;">open</span><span style="color:#eff1f5;">(ep.</span><span style="color:#bf616a;">protocol</span><span style="color:#eff1f5;">());</span><span style="color:#eff1f5;">
    _acceptor.</span><span style="color:#bf616a;">bind</span><span style="color:#eff1f5;">(ep);</span><span style="color:#eff1f5;">
    _acceptor.</span><span style="color:#bf616a;">listen</span><span style="color:#eff1f5;">();</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">
    </span><span style="color:#65737e;">// coroutineを起動する</span><span style="color:#65737e;">
    </span><span style="color:#b48ead;">auto</span><span style="color:#eff1f5;"> ex </span><span style="color:#c0c5ce;">=</span><span style="color:#eff1f5;"> _context.</span><span style="color:#bf616a;">get_executor</span><span style="color:#eff1f5;">();</span><span style="color:#eff1f5;">
    asio::</span><span style="color:#bf616a;">co_spawn</span><span style="color:#eff1f5;">(ex, </span><span style="color:#bf616a;">accept_loop</span><span style="color:#eff1f5;">(), asio::detached);</span><span style="color:#eff1f5;">
  }</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">
  asio::awaitable&lt;</span><span style="color:#b48ead;">void</span><span style="color:#eff1f5;">&gt; </span><span style="color:#8fa1b3;">accept_loop</span><span style="color:#eff1f5;">() {</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">
    </span><span style="color:#65737e;">// 単なるループになって再起が不要に</span><span style="color:#65737e;">
    </span><span style="color:#b48ead;">while </span><span style="color:#eff1f5;">(</span><span style="color:#d08770;">true</span><span style="color:#eff1f5;">) {</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">
      </span><span style="color:#b48ead;">auto </span><span style="color:#eff1f5;">[e, socket] </span><span style="color:#c0c5ce;">=</span><span style="color:#eff1f5;"> co_await _acceptor.</span><span style="color:#bf616a;">async_accept</span><span style="color:#eff1f5;">(use_nothrow_awaitable);</span><span style="color:#eff1f5;">
      </span><span style="color:#b48ead;">if </span><span style="color:#eff1f5;">(e) {</span><span style="color:#eff1f5;">
        std::cout </span><span style="color:#c0c5ce;">&lt;&lt; &quot;</span><span style="color:#a3be8c;">[server]accept error: </span><span style="color:#c0c5ce;">&quot; &lt;&lt;</span><span style="color:#eff1f5;"> e </span><span style="color:#c0c5ce;">&lt;&lt;</span><span style="color:#eff1f5;"> std::endl;</span><span style="color:#eff1f5;">
        </span><span style="color:#b48ead;">break</span><span style="color:#eff1f5;">;</span><span style="color:#eff1f5;">
      }</span><span style="color:#eff1f5;">
      std::cout </span><span style="color:#c0c5ce;">&lt;&lt; &quot;</span><span style="color:#a3be8c;">[server]accepted</span><span style="color:#c0c5ce;">&quot; &lt;&lt;</span><span style="color:#eff1f5;"> std::endl;</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">
      </span><span style="color:#65737e;">// coroutineを起動する</span><span style="color:#65737e;">
      </span><span style="color:#b48ead;">auto</span><span style="color:#eff1f5;"> ex </span><span style="color:#c0c5ce;">=</span><span style="color:#eff1f5;"> _context.</span><span style="color:#bf616a;">get_executor</span><span style="color:#eff1f5;">();</span><span style="color:#eff1f5;">
      asio::</span><span style="color:#bf616a;">co_spawn</span><span style="color:#eff1f5;">(ex, </span><span style="color:#bf616a;">session</span><span style="color:#eff1f5;">(std::</span><span style="color:#bf616a;">move</span><span style="color:#eff1f5;">(socket)), asio::detached);</span><span style="color:#eff1f5;">
    }</span><span style="color:#eff1f5;">
  }</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">
  asio::awaitable&lt;</span><span style="color:#b48ead;">void</span><span style="color:#eff1f5;">&gt; </span><span style="color:#8fa1b3;">session</span><span style="color:#eff1f5;">(asio::ip::tcp::socket </span><span style="color:#bf616a;">socket</span><span style="color:#eff1f5;">) {</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">
    </span><span style="color:#65737e;">// echo server ぽい ping pong</span><span style="color:#65737e;">
</span><span style="color:#eff1f5;">    asio::streambuf buf;</span><span style="color:#eff1f5;">
    </span><span style="color:#b48ead;">auto </span><span style="color:#eff1f5;">[e1, read_size] </span><span style="color:#c0c5ce;">=</span><span style="color:#eff1f5;"> co_await asio::</span><span style="color:#bf616a;">async_read</span><span style="color:#eff1f5;">(</span><span style="color:#eff1f5;">
        socket, buf, asio::</span><span style="color:#bf616a;">transfer_at_least</span><span style="color:#eff1f5;">(</span><span style="color:#d08770;">1</span><span style="color:#eff1f5;">), use_nothrow_awaitable);</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">
    </span><span style="color:#b48ead;">auto</span><span style="color:#eff1f5;"> pong </span><span style="color:#c0c5ce;">= </span><span style="color:#bf616a;">to_string</span><span style="color:#eff1f5;">(buf);</span><span style="color:#eff1f5;">
    std::cout </span><span style="color:#c0c5ce;">&lt;&lt; &quot;</span><span style="color:#a3be8c;">[server]ping: </span><span style="color:#c0c5ce;">&quot; &lt;&lt;</span><span style="color:#eff1f5;"> pong </span><span style="color:#c0c5ce;">&lt;&lt;</span><span style="color:#eff1f5;"> std::endl;</span><span style="color:#eff1f5;">
    pong </span><span style="color:#c0c5ce;">+= &quot;</span><span style="color:#a3be8c;">pong</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#eff1f5;">;</span><span style="color:#eff1f5;">
    </span><span style="color:#b48ead;">auto </span><span style="color:#eff1f5;">[e2, write_size] </span><span style="color:#c0c5ce;">=</span><span style="color:#eff1f5;"> co_await asio::</span><span style="color:#bf616a;">async_write</span><span style="color:#eff1f5;">(</span><span style="color:#eff1f5;">
        socket, asio::</span><span style="color:#bf616a;">buffer</span><span style="color:#eff1f5;">(pong), use_nothrow_awaitable);</span><span style="color:#eff1f5;">
    std::cout </span><span style="color:#c0c5ce;">&lt;&lt; &quot;</span><span style="color:#a3be8c;">[server]pong: </span><span style="color:#c0c5ce;">&quot; &lt;&lt;</span><span style="color:#eff1f5;"> write_size </span><span style="color:#c0c5ce;">&lt;&lt;</span><span style="color:#eff1f5;"> std::endl;</span><span style="color:#eff1f5;">
  }</span><span style="color:#eff1f5;">
}</span><span style="color:#c0c5ce;">;</span><span style="color:#c0c5ce;">
</span></code></pre><pre style="background-color:#2b303b;">
<code class="language-cpp" data-lang="cpp"><span style="color:#c0c5ce;">  </span><span style="color:#b48ead;">auto</span><span style="color:#c0c5ce;"> ep = asio::ip::tcp::</span><span style="color:#bf616a;">endpoint</span><span style="color:#c0c5ce;">(asio::ip::address::</span><span style="color:#bf616a;">from_string</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">127.0.0.1</span><span style="color:#c0c5ce;">&quot;),</span><span style="color:#c0c5ce;">
                                    PORT);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
  </span><span style="color:#65737e;">// server</span><span style="color:#65737e;">
</span><span style="color:#c0c5ce;">  asio::io_context server_context;</span><span style="color:#c0c5ce;">
  server </span><span style="color:#8fa1b3;">server</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">server_context</span><span style="color:#c0c5ce;">);</span><span style="color:#c0c5ce;">
  server.</span><span style="color:#bf616a;">listen</span><span style="color:#c0c5ce;">(ep);</span><span style="color:#c0c5ce;">
  std::thread </span><span style="color:#8fa1b3;">server_thread</span><span style="color:#c0c5ce;">([&amp;server_context]() { server_context.</span><span style="color:#bf616a;">run</span><span style="color:#c0c5ce;">(); }); </span><span style="color:#65737e;">// thread でループを回す。</span><span style="color:#65737e;">
</span></code></pre>
<p>ループ(io_context)が隠蔽されていないのが良いですね。</p>
<h1 id="asio-api">asio api</h1>
<h2 id="io-context">io_context</h2>
<p><code>c++23</code> の <code>Networking TS</code> に向けた変更？</p>
<ul>
<li><a href="https://amedama1x1.hatenablog.com/entry/2016/04/05/205340">Networking TS の Boost.Asio からの変更点 - その 1: Associated allocator</a></li>
<li><a href="https://amedama1x1.hatenablog.com/entry/2016/08/20/222326">Networking TS の Boost.Asio からの変更点 - その 3: Executor</a></li>
</ul>
<blockquote>
<p>io_service は Executor と ExecutionContext という概念に分割されたことで, io_context に名前が変わりました</p>
</blockquote>
<p><code>Boost 1.66</code></p>
<ul>
<li><a href="https://amedama1x1.hatenablog.com/entry/2017/12/09/102405">Networking TS の Boost.Asio からの変更点 - その 4: Associated Executor</a></li>
</ul>
<p>単純に io_service を io_context に追きかえるだけで動いた。</p>
<pre style="background-color:#2b303b;">
<code class="language-cpp" data-lang="cpp"><span style="color:#b48ead;">#include </span><span style="color:#c0c5ce;">&lt;</span><span style="color:#a3be8c;">asio.hpp</span><span style="color:#c0c5ce;">&gt;</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
io_context context;</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
</span><span style="color:#65737e;">// 全てのタスクが消化されるまでブロックする。</span><span style="color:#65737e;">
</span><span style="color:#c0c5ce;">context.</span><span style="color:#bf616a;">run</span><span style="color:#c0c5ce;">();</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
</span><span style="color:#65737e;">// スレッド上で実行する例</span><span style="color:#65737e;">
</span><span style="color:#c0c5ce;">std::thread </span><span style="color:#8fa1b3;">run_thread</span><span style="color:#c0c5ce;">([&amp;context](){ context.</span><span style="color:#bf616a;">run</span><span style="color:#c0c5ce;">(); });</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
</span><span style="color:#65737e;">// 止める</span><span style="color:#65737e;">
</span><span style="color:#c0c5ce;">context.</span><span style="color:#bf616a;">stop</span><span style="color:#c0c5ce;">();</span><span style="color:#c0c5ce;">
run_thread.</span><span style="color:#bf616a;">join</span><span style="color:#c0c5ce;">();</span><span style="color:#c0c5ce;">
</span></code></pre><h2 id="endpoint">endpoint</h2>
<p>ipaddress + port</p>
<pre style="background-color:#2b303b;">
<code class="language-cpp" data-lang="cpp"><span style="color:#c0c5ce;">asip::ip::tcp::endpoint </span><span style="color:#8fa1b3;">ep</span><span style="color:#c0c5ce;">(asio::ip::address::</span><span style="color:#bf616a;">from_string</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">127.0.0.1</span><span style="color:#c0c5ce;">&quot;), </span><span style="color:#d08770;">1234</span><span style="color:#c0c5ce;">);</span><span style="color:#c0c5ce;">
</span></code></pre><h2 id="tcp-connect">tcp connect</h2>
<p>socket</p>
<pre style="background-color:#2b303b;">
<code class="language-cpp" data-lang="cpp"><span style="color:#c0c5ce;">io_context context;</span><span style="color:#c0c5ce;">
asio::ip::tcp::socket </span><span style="color:#8fa1b3;">socket</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">coontext</span><span style="color:#c0c5ce;">);</span><span style="color:#c0c5ce;">
</span></code></pre>
<p>basic</p>
<pre style="background-color:#2b303b;">
<code class="language-cpp" data-lang="cpp"><span style="color:#b48ead;">void </span><span style="color:#8fa1b3;">connect</span><span style="color:#c0c5ce;">(asio::ip::tcp::socket </span><span style="color:#bf616a;">socket</span><span style="color:#c0c5ce;">, </span><span style="color:#b48ead;">const</span><span style="color:#c0c5ce;"> asio::ip::tcp::endpoint &amp;</span><span style="color:#bf616a;">ep</span><span style="color:#c0c5ce;">)</span><span style="color:#c0c5ce;">
{</span><span style="color:#c0c5ce;">
  </span><span style="color:#b48ead;">auto</span><span style="color:#c0c5ce;"> on_connect = [](</span><span style="color:#b48ead;">const</span><span style="color:#c0c5ce;"> asio::error_code &amp;ec)</span><span style="color:#c0c5ce;">
  {</span><span style="color:#c0c5ce;">
    </span><span style="color:#b48ead;">if</span><span style="color:#c0c5ce;">(ec)</span><span style="color:#c0c5ce;">
    {</span><span style="color:#c0c5ce;">
      std::cout &lt;&lt; &quot;</span><span style="color:#a3be8c;">error: </span><span style="color:#c0c5ce;">&quot; &lt;&lt; ec &lt;&lt; std::endl;</span><span style="color:#c0c5ce;">
    }</span><span style="color:#c0c5ce;">
    </span><span style="color:#b48ead;">else</span><span style="color:#c0c5ce;">{</span><span style="color:#c0c5ce;">
      std::cout &lt;&lt; &quot;</span><span style="color:#a3be8c;">connected</span><span style="color:#c0c5ce;">&quot; &lt;&lt; std::endl;</span><span style="color:#c0c5ce;">
    }</span><span style="color:#c0c5ce;">
  };</span><span style="color:#c0c5ce;">
  socket.</span><span style="color:#bf616a;">async_connect</span><span style="color:#c0c5ce;">(ep, on_connect);</span><span style="color:#c0c5ce;">
}</span><span style="color:#c0c5ce;">
</span></code></pre>
<p><code>c++11 future</code></p>
<p>std::future に対して <code>continue_with</code> する手段を用意しないと、これ単体では使いづらい</p>
<pre style="background-color:#2b303b;">
<code class="language-cpp" data-lang="cpp"><span style="color:#c0c5ce;">std::future&lt;</span><span style="color:#b48ead;">void</span><span style="color:#c0c5ce;">&gt; </span><span style="color:#8fa1b3;">connect_future</span><span style="color:#c0c5ce;">(asio::ip::tcp::socket </span><span style="color:#bf616a;">socket</span><span style="color:#c0c5ce;">, </span><span style="color:#b48ead;">const</span><span style="color:#c0c5ce;"> asio::ip::tcp::endpoint &amp;</span><span style="color:#bf616a;">ep</span><span style="color:#c0c5ce;">)</span><span style="color:#c0c5ce;">
{</span><span style="color:#c0c5ce;">
  </span><span style="color:#65737e;">// move するのが大変な場合があるので手抜き</span><span style="color:#65737e;">
  </span><span style="color:#b48ead;">auto</span><span style="color:#c0c5ce;"> p = std::</span><span style="color:#bf616a;">make_shared</span><span style="color:#c0c5ce;">&lt;std::promise&lt;</span><span style="color:#b48ead;">void</span><span style="color:#c0c5ce;">&gt;&gt;();</span><span style="color:#c0c5ce;">
  </span><span style="color:#b48ead;">auto</span><span style="color:#c0c5ce;"> f = p-&gt;</span><span style="color:#bf616a;">get_future</span><span style="color:#c0c5ce;">();</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
  socket.</span><span style="color:#bf616a;">async_connect</span><span style="color:#c0c5ce;">(ep, [p](asio::error_code ec){</span><span style="color:#c0c5ce;">
    </span><span style="color:#b48ead;">if</span><span style="color:#c0c5ce;">(ec)</span><span style="color:#c0c5ce;">
    {</span><span style="color:#c0c5ce;">
    }</span><span style="color:#c0c5ce;">
    </span><span style="color:#b48ead;">else</span><span style="color:#c0c5ce;">{</span><span style="color:#c0c5ce;">
      </span><span style="color:#65737e;">// future value</span><span style="color:#65737e;">
</span><span style="color:#c0c5ce;">      p-&gt;</span><span style="color:#bf616a;">set_value</span><span style="color:#c0c5ce;">();</span><span style="color:#c0c5ce;">
    }</span><span style="color:#c0c5ce;">
  });</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
  </span><span style="color:#b48ead;">return</span><span style="color:#c0c5ce;"> f;</span><span style="color:#c0c5ce;">
}</span><span style="color:#c0c5ce;">
</span></code></pre>
<p><code>c++20 coroutine</code></p>
<p>有望</p>
<pre style="background-color:#2b303b;">
<code class="language-cpp" data-lang="cpp"><span style="color:#c0c5ce;">asio::awaitable&lt;</span><span style="color:#b48ead;">void</span><span style="color:#c0c5ce;">&gt; </span><span style="color:#8fa1b3;">co</span><span style="color:#c0c5ce;">(asio::io_context &amp;</span><span style="color:#bf616a;">context</span><span style="color:#c0c5ce;">, </span><span style="color:#b48ead;">const</span><span style="color:#c0c5ce;"> asio::ip::tcp::endpoint &amp;</span><span style="color:#bf616a;">ep</span><span style="color:#c0c5ce;">)</span><span style="color:#c0c5ce;">
{</span><span style="color:#c0c5ce;">
  asio::ip::tcp::socket </span><span style="color:#bf616a;">socket</span><span style="color:#c0c5ce;">(coontext);</span><span style="color:#c0c5ce;">
  co_await socket.</span><span style="color:#bf616a;">async_connect</span><span style="color:#c0c5ce;">(ep, asio::use_awaitable);</span><span style="color:#c0c5ce;">
}</span><span style="color:#c0c5ce;">
</span></code></pre><h2 id="tcp-listen">tcp listen</h2>
<h2 id="raed-async">raed_async</h2>
<h2 id="write-async">write_async</h2>
<h1 id="coroutine-xiang-xi">coroutine 詳細</h1>
<p>asio の coroutine を学んでいたらできないことが出てきた。</p>
<pre style="background-color:#2b303b;">
<code class="language-cpp" data-lang="cpp"><span style="color:#b48ead;">auto</span><span style="color:#c0c5ce;"> result = co_await </span><span style="color:#bf616a;">rpc_call</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">add</span><span style="color:#c0c5ce;">&quot;, </span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">2</span><span style="color:#c0c5ce;">);</span><span style="color:#c0c5ce;">
</span></code></pre><h1 id="zi-qian-no-awaiter-gabi-yao">自前の Awaiter が必要？</h1>
<pre style="background-color:#2b303b;">
<code class="language-cpp" data-lang="cpp"><span style="color:#b48ead;">template</span><span style="color:#c0c5ce;">&lt;</span><span style="color:#b48ead;">typename</span><span style="color:#c0c5ce;"> R, </span><span style="color:#b48ead;">typename </span><span style="color:#c0c5ce;">...AS&gt;</span><span style="color:#c0c5ce;">
asio::awaitable&lt;R&gt; </span><span style="color:#8fa1b3;">rpc_call</span><span style="color:#c0c5ce;">(</span><span style="color:#b48ead;">const</span><span style="color:#c0c5ce;"> std::string &amp;</span><span style="color:#bf616a;">method</span><span style="color:#c0c5ce;">, AS... </span><span style="color:#bf616a;">as</span><span style="color:#c0c5ce;">)</span><span style="color:#c0c5ce;">
{</span><span style="color:#c0c5ce;">
  asio::io_context context;</span><span style="color:#c0c5ce;">
  asio::ip::tcp::socket </span><span style="color:#bf616a;">socket</span><span style="color:#c0c5ce;">(context);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
  asio::ip::tcp::endpoint ep;</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
  co_await socket.</span><span style="color:#bf616a;">connect_async</span><span style="color:#c0c5ce;">(ep, asio::use_awaitable);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
  </span><span style="color:#65737e;">// msgpack-rpc</span><span style="color:#65737e;">
</span><span style="color:#c0c5ce;">  std::vector&lt;uint8_t&gt; request = </span><span style="color:#bf616a;">make_request</span><span style="color:#c0c5ce;">(method, as...);</span><span style="color:#c0c5ce;">
  co_await asio::</span><span style="color:#bf616a;">write_async</span><span style="color:#c0c5ce;">(socket, request, asio::use_awaitable); </span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
  </span><span style="color:#65737e;">// ここで実行の流れが切れる</span><span style="color:#65737e;">
</span><span style="color:#c0c5ce;">
  </span><span style="color:#65737e;">// ?</span><span style="color:#65737e;">
</span><span style="color:#c0c5ce;">  std::promise&lt;R&gt; p;</span><span style="color:#c0c5ce;">
  </span><span style="color:#b48ead;">return</span><span style="color:#c0c5ce;"> p.</span><span style="color:#bf616a;">get_future</span><span style="color:#c0c5ce;">();</span><span style="color:#c0c5ce;">
}</span><span style="color:#c0c5ce;">
</span></code></pre>
<p><code>co_await std::future</code> できるぽいが, <code>asio</code> と混ぜてうまくいくのだろうか。</p>
<h1 id="c-20-coroutine">c++20 coroutine</h1>
<ul>
<li><a href="https://cpprefjp.github.io/lang/cpp20/coroutines.html">https://cpprefjp.github.io/lang/cpp20/coroutines.html</a></li>
<li><a href="https://www.scs.stanford.edu/%7Edm/blog/c++-coroutines.html">https://www.scs.stanford.edu/~dm/blog/c++-coroutines.html</a></li>
<li><a href="https://qiita.com/tan-y/items/ae54153ec3eb42f80638">C++ でコルーチン (async/await 準備編)</a></li>
<li><a href="https://qiita.com/tan-y/items/6033ab9e7298999bf214#await_ready">C++ で async/await をする</a></li>
</ul>
<p>内部で <code>co_await</code>, <code>co_yield</code>, <code>co_return</code> の何れかを使う関数は coroutine になる。
返り値の型から promise_type を得られるようにする必要がある。</p>
<p>初期化は <code>promise_type::get_return_object</code> から始まるぽい。</p>
<h2 id="generator-noli">generator の例</h2>
<pre style="background-color:#2b303b;">
<code class="language-cpp" data-lang="cpp"><span style="color:#b48ead;">struct </span><span style="color:#c0c5ce;">generator {</span><span style="color:#c0c5ce;">
  </span><span style="color:#b48ead;">struct </span><span style="color:#c0c5ce;">promise_type;</span><span style="color:#c0c5ce;">
  </span><span style="color:#b48ead;">using </span><span style="color:#c0c5ce;">handle = std::coroutine_handle&lt;promise_type&gt;;  </span><span style="color:#c0c5ce;">
  </span><span style="color:#b48ead;">struct </span><span style="color:#c0c5ce;">promise_type {</span><span style="color:#c0c5ce;">
    </span><span style="color:#b48ead;">auto </span><span style="color:#8fa1b3;">get_return_object</span><span style="color:#c0c5ce;">() { </span><span style="color:#b48ead;">return </span><span style="color:#bf616a;">generator</span><span style="color:#c0c5ce;">{handle::</span><span style="color:#bf616a;">from_promise</span><span style="color:#c0c5ce;">(*</span><span style="color:#bf616a;">this</span><span style="color:#c0c5ce;">)}; }</span><span style="color:#c0c5ce;">
  };</span><span style="color:#c0c5ce;">
  </span><span style="color:#b48ead;">using </span><span style="color:#c0c5ce;">handle = std::coroutine_handle&lt;promise_type&gt;;</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">private</span><span style="color:#c0c5ce;">:</span><span style="color:#c0c5ce;">
  handle coro;</span><span style="color:#c0c5ce;">
  </span><span style="color:#8fa1b3;">generator</span><span style="color:#c0c5ce;">(handle </span><span style="color:#bf616a;">h</span><span style="color:#c0c5ce;">) : </span><span style="color:#bf616a;">coro</span><span style="color:#c0c5ce;">(h) {}</span><span style="color:#c0c5ce;">
};</span><span style="color:#c0c5ce;">
</span></code></pre><pre style="background-color:#2b303b;">
<code class="language-cpp" data-lang="cpp"><span style="color:#c0c5ce;">promise_type promise;</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
</span><span style="color:#65737e;">// 戻り値型オブジェクトの初期化</span><span style="color:#65737e;">
</span><span style="color:#b48ead;">auto</span><span style="color:#c0c5ce;"> result = promise.</span><span style="color:#bf616a;">get_return_object</span><span style="color:#c0c5ce;">();</span><span style="color:#c0c5ce;">
</span></code></pre><h1 id="asio-noshi-zhuang">Asio の実装</h1>
<h2 id="asio-awaitable">asio::awaitable</h2>
<p><code>asio::awaitable&lt;T&gt;</code> が CoroutineTrait の実装。</p>
<p><code>include/asio/awaitable.hpp</code></p>
<pre style="background-color:#2b303b;">
<code class="language-cpp" data-lang="cpp"><span style="color:#b48ead;">template </span><span style="color:#c0c5ce;">&lt;</span><span style="color:#b48ead;">typename</span><span style="color:#c0c5ce;"> T, </span><span style="color:#b48ead;">typename</span><span style="color:#c0c5ce;"> Executor = any_io_executor&gt;</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">class </span><span style="color:#eff1f5;">ASIO_NODISCARD </span><span style="color:#ebcb8b;">awaitable</span><span style="color:#eff1f5;">
{</span><span style="color:#eff1f5;">
</span><span style="color:#b48ead;">public</span><span style="color:#eff1f5;">:</span><span style="color:#eff1f5;">
  </span><span style="color:#65737e;">/// The type of the awaited value.</span><span style="color:#65737e;">
  </span><span style="color:#b48ead;">typedef</span><span style="color:#eff1f5;"> T value_type;</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">
  </span><span style="color:#65737e;">/// The executor type that will be used for the coroutine.</span><span style="color:#65737e;">
  </span><span style="color:#b48ead;">typedef</span><span style="color:#eff1f5;"> Executor executor_type;</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">
  </span><span style="color:#65737e;">/// Default constructor.</span><span style="color:#65737e;">
  </span><span style="color:#b48ead;">constexpr </span><span style="color:#8fa1b3;">awaitable</span><span style="color:#eff1f5;">() </span><span style="color:#b48ead;">noexcept</span><span style="color:#eff1f5;">
    : </span><span style="color:#bf616a;">frame_</span><span style="color:#eff1f5;">(</span><span style="color:#d08770;">nullptr</span><span style="color:#eff1f5;">)</span><span style="color:#eff1f5;">
  {</span><span style="color:#eff1f5;">
  }</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">
  </span><span style="color:#65737e;">/// Move constructor.</span><span style="color:#65737e;">
  </span><span style="color:#8fa1b3;">awaitable</span><span style="color:#eff1f5;">(awaitable</span><span style="color:#c0c5ce;">&amp;&amp; </span><span style="color:#bf616a;">other</span><span style="color:#eff1f5;">) </span><span style="color:#b48ead;">noexcept</span><span style="color:#eff1f5;">
    : </span><span style="color:#bf616a;">frame_</span><span style="color:#eff1f5;">(std::</span><span style="color:#bf616a;">exchange</span><span style="color:#eff1f5;">(other.</span><span style="color:#bf616a;">frame_</span><span style="color:#eff1f5;">, </span><span style="color:#d08770;">nullptr</span><span style="color:#eff1f5;">))</span><span style="color:#eff1f5;">
  {</span><span style="color:#eff1f5;">
  }</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">
  </span><span style="color:#65737e;">/// Destructor</span><span style="color:#65737e;">
  </span><span style="color:#8fa1b3;">~awaitable</span><span style="color:#eff1f5;">()</span><span style="color:#eff1f5;">
  {</span><span style="color:#eff1f5;">
    </span><span style="color:#b48ead;">if </span><span style="color:#eff1f5;">(frame_)</span><span style="color:#eff1f5;">
      frame_-&gt;</span><span style="color:#bf616a;">destroy</span><span style="color:#eff1f5;">();</span><span style="color:#eff1f5;">
  }</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">
  </span><span style="color:#65737e;">/// Checks if the awaitable refers to a future result.</span><span style="color:#65737e;">
  </span><span style="color:#b48ead;">bool </span><span style="color:#8fa1b3;">valid</span><span style="color:#eff1f5;">() </span><span style="color:#b48ead;">const noexcept</span><span style="color:#eff1f5;">
  {</span><span style="color:#eff1f5;">
    </span><span style="color:#b48ead;">return </span><span style="color:#c0c5ce;">!!</span><span style="color:#eff1f5;">frame_;</span><span style="color:#eff1f5;">
  }</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">
</span><span style="color:#b48ead;">#if</span><span style="color:#eff1f5;"> !</span><span style="color:#b48ead;">defined</span><span style="color:#eff1f5;">(GENERATING_DOCUMENTATION)</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">
  </span><span style="color:#65737e;">// Support for co_await keyword.</span><span style="color:#65737e;">
  </span><span style="color:#b48ead;">bool </span><span style="color:#8fa1b3;">await_ready</span><span style="color:#eff1f5;">() </span><span style="color:#b48ead;">const noexcept</span><span style="color:#eff1f5;">
  {</span><span style="color:#eff1f5;">
    </span><span style="color:#b48ead;">return </span><span style="color:#d08770;">false</span><span style="color:#eff1f5;">;</span><span style="color:#eff1f5;">
  }</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">
  </span><span style="color:#65737e;">// Support for co_await keyword.</span><span style="color:#65737e;">
  </span><span style="color:#b48ead;">template </span><span style="color:#eff1f5;">&lt;</span><span style="color:#b48ead;">class</span><span style="color:#eff1f5;"> U&gt;</span><span style="color:#eff1f5;">
  </span><span style="color:#b48ead;">void </span><span style="color:#8fa1b3;">await_suspend</span><span style="color:#eff1f5;">(</span><span style="color:#eff1f5;">
      detail::coroutine_handle&lt;detail::awaitable_frame&lt;U, Executor&gt;&gt; </span><span style="color:#bf616a;">h</span><span style="color:#eff1f5;">)</span><span style="color:#eff1f5;">
  {</span><span style="color:#eff1f5;">
    frame_-&gt;</span><span style="color:#bf616a;">push_frame</span><span style="color:#eff1f5;">(</span><span style="color:#c0c5ce;">&amp;</span><span style="color:#eff1f5;">h.</span><span style="color:#bf616a;">promise</span><span style="color:#eff1f5;">());</span><span style="color:#eff1f5;">
  }</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">
  </span><span style="color:#65737e;">// Support for co_await keyword.</span><span style="color:#65737e;">
</span><span style="color:#eff1f5;">  T </span><span style="color:#8fa1b3;">await_resume</span><span style="color:#eff1f5;">()</span><span style="color:#eff1f5;">
  {</span><span style="color:#eff1f5;">
    </span><span style="color:#b48ead;">return </span><span style="color:#bf616a;">awaitable</span><span style="color:#eff1f5;">(</span><span style="color:#c0c5ce;">static_cast</span><span style="color:#eff1f5;">&lt;awaitable</span><span style="color:#c0c5ce;">&amp;&amp;</span><span style="color:#eff1f5;">&gt;(</span><span style="color:#c0c5ce;">*</span><span style="color:#bf616a;">this</span><span style="color:#eff1f5;">)).</span><span style="color:#bf616a;">frame_</span><span style="color:#eff1f5;">-&gt;</span><span style="color:#bf616a;">get</span><span style="color:#eff1f5;">();</span><span style="color:#eff1f5;">
  }</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">
</span><span style="color:#b48ead;">#endif </span><span style="color:#65737e;">// !defined(GENERATING_DOCUMENTATION)</span><span style="color:#65737e;">
</span><span style="color:#eff1f5;">
</span><span style="color:#b48ead;">private</span><span style="color:#eff1f5;">:</span><span style="color:#eff1f5;">
  </span><span style="color:#b48ead;">template </span><span style="color:#eff1f5;">&lt;</span><span style="color:#b48ead;">typename</span><span style="color:#eff1f5;">&gt; </span><span style="color:#b48ead;">friend class</span><span style="color:#eff1f5;"> detail::awaitable_thread;</span><span style="color:#eff1f5;">
  </span><span style="color:#b48ead;">template </span><span style="color:#eff1f5;">&lt;</span><span style="color:#b48ead;">typename</span><span style="color:#eff1f5;">, </span><span style="color:#b48ead;">typename</span><span style="color:#eff1f5;">&gt; </span><span style="color:#b48ead;">friend class</span><span style="color:#eff1f5;"> detail::awaitable_frame;</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">
  </span><span style="color:#65737e;">// Not copy constructible or copy assignable.</span><span style="color:#65737e;">
  </span><span style="color:#8fa1b3;">awaitable</span><span style="color:#eff1f5;">(</span><span style="color:#b48ead;">const</span><span style="color:#eff1f5;"> awaitable</span><span style="color:#c0c5ce;">&amp;</span><span style="color:#eff1f5;">) </span><span style="color:#c0c5ce;">= </span><span style="color:#b48ead;">delete</span><span style="color:#eff1f5;">;</span><span style="color:#eff1f5;">
  awaitable</span><span style="color:#c0c5ce;">&amp; </span><span style="color:#8fa1b3;">operator=</span><span style="color:#eff1f5;">(</span><span style="color:#b48ead;">const</span><span style="color:#eff1f5;"> awaitable</span><span style="color:#c0c5ce;">&amp;</span><span style="color:#eff1f5;">) </span><span style="color:#c0c5ce;">= </span><span style="color:#b48ead;">delete</span><span style="color:#eff1f5;">;</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">
  </span><span style="color:#65737e;">// Construct the awaitable from a coroutine&#39;s frame object.</span><span style="color:#65737e;">
  </span><span style="color:#b48ead;">explicit </span><span style="color:#8fa1b3;">awaitable</span><span style="color:#eff1f5;">(detail::awaitable_frame&lt;T, Executor&gt;</span><span style="color:#c0c5ce;">* </span><span style="color:#bf616a;">a</span><span style="color:#eff1f5;">)</span><span style="color:#eff1f5;">
    : </span><span style="color:#bf616a;">frame_</span><span style="color:#eff1f5;">(a)</span><span style="color:#eff1f5;">
  {</span><span style="color:#eff1f5;">
  }</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">
  detail::awaitable_frame&lt;T, Executor&gt;</span><span style="color:#c0c5ce;">*</span><span style="color:#eff1f5;"> frame_;</span><span style="color:#eff1f5;">
}</span><span style="color:#c0c5ce;">;</span><span style="color:#c0c5ce;">
</span></code></pre><h2 id="promise-type">promise_type</h2>
<p><code>include/asio/impl/awaitable.hpp</code></p>
<p>// promise_type</p>
<pre style="background-color:#2b303b;">
<code class="language-cpp" data-lang="cpp"><span style="color:#b48ead;"># if defined</span><span style="color:#c0c5ce;">(ASIO_HAS_STD_COROUTINE)</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">namespace </span><span style="color:#c0c5ce;">std {</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">template </span><span style="color:#c0c5ce;">&lt;</span><span style="color:#b48ead;">typename</span><span style="color:#c0c5ce;"> T, </span><span style="color:#b48ead;">typename</span><span style="color:#c0c5ce;"> Executor, </span><span style="color:#b48ead;">typename</span><span style="color:#c0c5ce;">... Args&gt;</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">struct </span><span style="color:#c0c5ce;">coroutine_traits&lt;asio::awaitable&lt;T, Executor&gt;, Args...&gt;</span><span style="color:#c0c5ce;">
{</span><span style="color:#c0c5ce;">
  </span><span style="color:#b48ead;">typedef</span><span style="color:#c0c5ce;"> asio::detail::awaitable_frame&lt;T, Executor&gt; promise_type;</span><span style="color:#c0c5ce;">
};</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
} </span><span style="color:#65737e;">// namespace std</span><span style="color:#65737e;">
</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;"># else </span><span style="color:#65737e;">// defined(ASIO_HAS_STD_COROUTINE)</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">namespace </span><span style="color:#c0c5ce;">std { </span><span style="color:#b48ead;">namespace </span><span style="color:#c0c5ce;">experimental {</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">template </span><span style="color:#c0c5ce;">&lt;</span><span style="color:#b48ead;">typename</span><span style="color:#c0c5ce;"> T, </span><span style="color:#b48ead;">typename</span><span style="color:#c0c5ce;"> Executor, </span><span style="color:#b48ead;">typename</span><span style="color:#c0c5ce;">... Args&gt;</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">struct </span><span style="color:#c0c5ce;">coroutine_traits&lt;asio::awaitable&lt;T, Executor&gt;, Args...&gt;</span><span style="color:#c0c5ce;">
{</span><span style="color:#c0c5ce;">
  </span><span style="color:#b48ead;">typedef</span><span style="color:#c0c5ce;"> asio::detail::awaitable_frame&lt;T, Executor&gt; promise_type;</span><span style="color:#c0c5ce;">
};</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
}} </span><span style="color:#65737e;">// namespace std::experimental</span><span style="color:#65737e;">
</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;"># endif </span><span style="color:#65737e;">// defined(ASIO_HAS_STD_COROUTINE)</span><span style="color:#65737e;">
</span></code></pre><h2 id="asio-detail-awaitable-frame">asio::detail::awaitable_frame</h2>
<pre style="background-color:#2b303b;">
<code class="language-cpp" data-lang="cpp"><span style="color:#b48ead;">template </span><span style="color:#c0c5ce;">&lt;</span><span style="color:#b48ead;">typename</span><span style="color:#c0c5ce;"> Executor&gt;</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">class </span><span style="color:#ebcb8b;">awaitable_frame</span><span style="color:#eff1f5;">&lt;</span><span style="color:#b48ead;">void</span><span style="color:#eff1f5;">, Executor&gt;</span><span style="color:#eff1f5;">
  : </span><span style="color:#b48ead;">public </span><span style="color:#a3be8c;">awaitable_frame_base</span><span style="color:#eff1f5;">&lt;Executor&gt;</span><span style="color:#eff1f5;">
{</span><span style="color:#eff1f5;">
</span><span style="color:#b48ead;">public</span><span style="color:#eff1f5;">:</span><span style="color:#eff1f5;">
  awaitable&lt;</span><span style="color:#b48ead;">void</span><span style="color:#eff1f5;">, Executor&gt; </span><span style="color:#8fa1b3;">get_return_object</span><span style="color:#eff1f5;">()</span><span style="color:#eff1f5;">
  {</span><span style="color:#eff1f5;">
    </span><span style="color:#bf616a;">this</span><span style="color:#eff1f5;">-&gt;</span><span style="color:#bf616a;">coro_ </span><span style="color:#c0c5ce;">=</span><span style="color:#eff1f5;"> coroutine_handle&lt;awaitable_frame&gt;::</span><span style="color:#bf616a;">from_promise</span><span style="color:#eff1f5;">(</span><span style="color:#c0c5ce;">*</span><span style="color:#bf616a;">this</span><span style="color:#eff1f5;">);</span><span style="color:#eff1f5;">
    </span><span style="color:#b48ead;">return </span><span style="color:#bf616a;">awaitable</span><span style="color:#eff1f5;">&lt;</span><span style="color:#b48ead;">void</span><span style="color:#eff1f5;">, Executor&gt;(</span><span style="color:#bf616a;">this</span><span style="color:#eff1f5;">);</span><span style="color:#eff1f5;">
  };</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">
  </span><span style="color:#b48ead;">void </span><span style="color:#8fa1b3;">return_void</span><span style="color:#eff1f5;">()</span><span style="color:#eff1f5;">
  {</span><span style="color:#eff1f5;">
  }</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">
  </span><span style="color:#b48ead;">void </span><span style="color:#8fa1b3;">get</span><span style="color:#eff1f5;">()</span><span style="color:#eff1f5;">
  {</span><span style="color:#eff1f5;">
    </span><span style="color:#bf616a;">this</span><span style="color:#eff1f5;">-&gt;</span><span style="color:#bf616a;">caller_ </span><span style="color:#c0c5ce;">= </span><span style="color:#d08770;">nullptr</span><span style="color:#eff1f5;">;</span><span style="color:#eff1f5;">
    </span><span style="color:#bf616a;">this</span><span style="color:#eff1f5;">-&gt;</span><span style="color:#bf616a;">rethrow_exception</span><span style="color:#eff1f5;">();</span><span style="color:#eff1f5;">
  }</span><span style="color:#eff1f5;">
}</span><span style="color:#c0c5ce;">;</span><span style="color:#c0c5ce;">
</span></code></pre>
</div>

<nav class="toc">

<div class="toc_fix">
<ul>
    
        <li>
            <a href="https://ousttrue.github.io/posts/2021/summer/update-asio/#compiler-wozui-xin-nisuru">compiler を最新にする</a>
            
                <ul>
                    
                        <li>
                            <a href="https://ousttrue.github.io/posts/2021/summer/update-asio/#vc2019-20210818zui-xin-ban-ikeru">VC2019(20210818最新版いける)</a>
                        </li>
                    
                        <li>
                            <a href="https://ousttrue.github.io/posts/2021/summer/update-asio/#llvm-12-umakuikazu-zhui-jia-nokomandorainyin-shu-ka">LLVM-12(うまくいかず。追加のコマンドライン引数か)</a>
                        </li>
                    
                </ul>
            
        </li>
    
        <li>
            <a href="https://ousttrue.github.io/posts/2021/summer/update-asio/#kodo">コード</a>
            
                <ul>
                    
                        <li>
                            <a href="https://ousttrue.github.io/posts/2021/summer/update-asio/#co-spawn-de-awaitable-woqi-dong-suru">co_spawn で awaitable を起動する</a>
                        </li>
                    
                        <li>
                            <a href="https://ousttrue.github.io/posts/2021/summer/update-asio/#client-side">client side</a>
                        </li>
                    
                        <li>
                            <a href="https://ousttrue.github.io/posts/2021/summer/update-asio/#server-side">server side</a>
                        </li>
                    
                </ul>
            
        </li>
    
        <li>
            <a href="https://ousttrue.github.io/posts/2021/summer/update-asio/#asio-api">asio api</a>
            
                <ul>
                    
                        <li>
                            <a href="https://ousttrue.github.io/posts/2021/summer/update-asio/#io-context">io_context</a>
                        </li>
                    
                        <li>
                            <a href="https://ousttrue.github.io/posts/2021/summer/update-asio/#endpoint">endpoint</a>
                        </li>
                    
                        <li>
                            <a href="https://ousttrue.github.io/posts/2021/summer/update-asio/#tcp-connect">tcp connect</a>
                        </li>
                    
                        <li>
                            <a href="https://ousttrue.github.io/posts/2021/summer/update-asio/#tcp-listen">tcp listen</a>
                        </li>
                    
                        <li>
                            <a href="https://ousttrue.github.io/posts/2021/summer/update-asio/#raed-async">raed_async</a>
                        </li>
                    
                        <li>
                            <a href="https://ousttrue.github.io/posts/2021/summer/update-asio/#write-async">write_async</a>
                        </li>
                    
                </ul>
            
        </li>
    
        <li>
            <a href="https://ousttrue.github.io/posts/2021/summer/update-asio/#coroutine-xiang-xi">coroutine 詳細</a>
            
        </li>
    
        <li>
            <a href="https://ousttrue.github.io/posts/2021/summer/update-asio/#zi-qian-no-awaiter-gabi-yao">自前の Awaiter が必要？</a>
            
        </li>
    
        <li>
            <a href="https://ousttrue.github.io/posts/2021/summer/update-asio/#c-20-coroutine">c++20 coroutine</a>
            
                <ul>
                    
                        <li>
                            <a href="https://ousttrue.github.io/posts/2021/summer/update-asio/#generator-noli">generator の例</a>
                        </li>
                    
                </ul>
            
        </li>
    
        <li>
            <a href="https://ousttrue.github.io/posts/2021/summer/update-asio/#asio-noshi-zhuang">Asio の実装</a>
            
                <ul>
                    
                        <li>
                            <a href="https://ousttrue.github.io/posts/2021/summer/update-asio/#asio-awaitable">asio::awaitable</a>
                        </li>
                    
                        <li>
                            <a href="https://ousttrue.github.io/posts/2021/summer/update-asio/#promise-type">promise_type</a>
                        </li>
                    
                        <li>
                            <a href="https://ousttrue.github.io/posts/2021/summer/update-asio/#asio-detail-awaitable-frame">asio::detail::awaitable_frame</a>
                        </li>
                    
                </ul>
            
        </li>
    
</ul>
</div>


</nav>
</div>
</main>

    <footer class="footer">Powered by <a href="https://www.getzola.org/">Zola</a> <a href="https://github.com/ousttrue/zola/tree/custom">custom</a></footer>

  </body>
</html>
