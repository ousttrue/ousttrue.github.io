<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="generator" content="Nikola (getnikola.com)">
<meta name="viewport" content="width=device-width">
<script src="../../../../assets/js/all-nocdn.js"></script><title>SSGをABlogに変更 | 三次元日誌</title>
<link href="../../../../assets/css/code.css" rel="stylesheet" type="text/css">
<link href="../../../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
</head>
<body>
    <h1 id="brand">
        <a href="../../../../" title="三次元日誌" rel="home">
            <span id="blog-title">三次元日誌</span>
        </a>
    </h1>

    <nav id="menu"><ul>
<li><a href="../../../../archive.html">Archives</a></li>
<li><a href="../../../../categories/index.html">Tags</a></li>
<li><a href="../../../../rss.xml">RSS feed</a></li>
<li><a href="../../../../about">About</a></li>
<li><a href="../../../../books">MemoBooks</a></li>

            
            
            
        </ul></nav><hr>
<main id="content"><h1 class="p-name entry-title" itemprop="headline name">
    <h1 class="p-name entry-title" itemprop="headline name">
    <a href="." class="u-url">SSGをABlogに変更
    </a>
</h1>
<ul itemprop="keywords" class="tags">
<li>
        <time datetime="2021-12-20T00:00:00+09:00" title="2021-12-20">2021-12-20</time>
</li>
    <li><a class="tag p-category" href="../../../../categories/python/" rel="tag">python</a></li>
    <li><a class="tag p-category" href="../../../../categories/sphinx/" rel="tag">sphinx</a></li>
    <li><a class="tag p-category" href="../../../../categories/ssg/" rel="tag">ssg</a></li>
</ul>
</h1>

<h2>ABlog にシステムを変更</h2>
<p><a href="https://getnikola.com/">nikola</a> は使いこなせなくて短命に終わってしまった。
<a href="https://pydoit.org/">doit</a> は面白いと思うのだが。</p>
<p>ということで、 <code>sphinx</code> プラグインの <a href="https://ablog.readthedocs.io/en/latest/">ABlog</a> です。</p>
<h3>はまり1: Sphinx のキャッシュ</h3>
<p><code>python -m sphinx content build</code> にデバッガをアタッチして試行錯誤するのだけど、
キャッシュされて処理されなかった。</p>
<p><code>python -m sphinx content build -E -v</code> とする。</p>
<ul>
<li>-E: 全処理(キャッシュを使わない)</li>
<li>-v: 詳細メッセージ</li>
</ul>
<h3>はまり2: ablog が timezone の有無で日付の比較に失敗する</h3>
<div class="code"><pre class="code literal-block">can't compare offset-naive and offset-aware datetimes
</pre></div>

<p>これは、既存記事の <code>frontmatter</code> の日付に <code>timezone</code> が付いていると
日付の比較に失敗する。</p>
<div class="code"><pre class="code literal-block"><span class="c1"># site-packages/ablog/blog.py:382</span>
<span class="bp">self</span><span class="o">.</span><span class="n">date</span> <span class="o">=</span> <span class="n">date</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s2">"date"</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</pre></div>

<p>と対処した。</p>
<h3>はまり3: myst-parser の toml frontmatter 対応</h3>
<p><code>myst-parser</code> が <code>---</code> による <code>yaml</code> 形式の <code>frontmatter</code> にしか対応していない様子。
<a href="https://gohugo.io/content-management/front-matter/">hugo の frontmatter</a> にある <code>toml</code> 様式に対応するべく改造したい。</p>
<h4>切り出し</h4>
<p>どこで処理しているのか探索が難航した。</p>
<p><code>site-packages/mdit_py_plugins/front_matter/index.py</code>
で処理している。</p>
<h4>Parse</h4>
<p><code>site-packages/myst_parser/docutils_renderer.py</code></p>
<p><code>render_front_matter</code> で切り出した文字列を <code>yaml</code> でパースしている。
<code>except</code> 節で <code>toml</code> にリトライさせたら動いた。</p>
<h3>モンキーパッチ</h3>
<p>とりあえず <code>conf.py</code> にて直接修正する。</p>
<p><a href="https://github.com/ousttrue/ousttrue.github.io/blob/ablog/content/patch.py">https://github.com/ousttrue/ousttrue.github.io/blob/ablog/content/patch.py</a></p>
<p>後で PR 送ったりできるかな。</p>
<h3>ABlog は何をしているのか</h3>
<h4>toctree無しのpost記事</h4>
<p>特定の条件で、記事をブログ記事と見做して <code>toctree</code> 無しで辿れるようにする。
記事は、日付やタグでグループ化してくれる。</p>
<p><a href="https://ablog.readthedocs.io/en/latest/manual/posting-and-listing/#posting-with-page-front-matter">https://ablog.readthedocs.io/en/latest/manual/posting-and-listing/#posting-with-page-front-matter</a></p>
<p>パス指定。</p>
<div class="code"><pre class="code literal-block"><span class="n">blog_post_pattern</span> <span class="o">=</span> <span class="s2">"posts/**/*.md"</span>
</pre></div>

<p>条件。</p>
<div class="code"><pre class="code literal-block"><span class="c1"># .venv/lib/python3.9/site-packages/ablog/post.py</span>
        <span class="k">if</span> <span class="s2">"blogpost"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">metadata</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">docname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">matched_blog_posts</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
</pre></div>

<p><code>frontmatter</code> 等から最低限、日付の情報がとれないとトップページから辿る方法が無い状態になる。</p>
<p>あと <code>sphinx</code> なのでトップレベルの表題が本文側に必要かも。
<code>frontmatter</code> の <code>title</code> を反映できると便利そう。</p>
<h4>event: 'doctree-read'</h4>
<p>doctree から <code>PostNode</code> を集める。</p>
<p><code>alog/post#process_posts(app, doctree)</code></p>
<div class="code"><pre class="code literal-block"><span class="k">def</span> <span class="nf">process_posts</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">doctree</span><span class="p">):</span>
    <span class="n">post_nodes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">doctree</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">PostNode</span><span class="p">))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">post_nodes</span><span class="p">:</span>
        <span class="c1"># PostNode が必要</span>
        <span class="k">return</span>

    <span class="c1"># 省略</span>

    <span class="n">postinfo</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">"docname"</span><span class="p">:</span> <span class="n">docname</span><span class="p">,</span>
        <span class="s2">"section"</span><span class="p">:</span> <span class="n">section_name</span><span class="p">,</span>
        <span class="s2">"order"</span><span class="p">:</span> <span class="n">order</span><span class="p">,</span>
        <span class="s2">"date"</span><span class="p">:</span> <span class="n">date</span><span class="p">,</span>
        <span class="s2">"update"</span><span class="p">:</span> <span class="nb">max</span><span class="p">(</span><span class="n">update_dates</span> <span class="o">+</span> <span class="p">[</span><span class="n">date</span><span class="p">]),</span>
        <span class="s2">"title"</span><span class="p">:</span> <span class="n">title</span><span class="p">,</span>
        <span class="s2">"excerpt"</span><span class="p">:</span> <span class="n">excerpt</span><span class="p">,</span>
        <span class="s2">"tags"</span><span class="p">:</span> <span class="n">node</span><span class="p">[</span><span class="s2">"tags"</span><span class="p">],</span>
        <span class="s2">"author"</span><span class="p">:</span> <span class="n">node</span><span class="p">[</span><span class="s2">"author"</span><span class="p">],</span>
        <span class="s2">"category"</span><span class="p">:</span> <span class="n">node</span><span class="p">[</span><span class="s2">"category"</span><span class="p">],</span>
        <span class="s2">"location"</span><span class="p">:</span> <span class="n">node</span><span class="p">[</span><span class="s2">"location"</span><span class="p">],</span>
        <span class="s2">"language"</span><span class="p">:</span> <span class="n">node</span><span class="p">[</span><span class="s2">"language"</span><span class="p">],</span>
        <span class="s2">"redirect"</span><span class="p">:</span> <span class="n">node</span><span class="p">[</span><span class="s2">"redirect"</span><span class="p">],</span>
        <span class="s2">"nocomments"</span><span class="p">:</span> <span class="n">node</span><span class="p">[</span><span class="s2">"nocomments"</span><span class="p">],</span>
        <span class="s2">"image"</span><span class="p">:</span> <span class="n">node</span><span class="p">[</span><span class="s2">"image"</span><span class="p">],</span>
        <span class="s2">"exclude"</span><span class="p">:</span> <span class="n">node</span><span class="p">[</span><span class="s2">"exclude"</span><span class="p">],</span>
        <span class="s2">"doctree"</span><span class="p">:</span> <span class="n">section_copy</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="n">docname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">env</span><span class="o">.</span><span class="n">ablog_posts</span><span class="p">:</span>
        <span class="n">env</span><span class="o">.</span><span class="n">ablog_posts</span><span class="p">[</span><span class="n">docname</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">env</span><span class="o">.</span><span class="n">ablog_posts</span><span class="p">[</span><span class="n">docname</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">postinfo</span><span class="p">)</span>
</pre></div>

<div class="code"><pre class="code literal-block"><span class="k">class</span> <span class="nc">CheckFrontMatter</span><span class="p">(</span><span class="n">SphinxTransform</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">apply</span><span class="p">():</span>
        <span class="k">pass</span>

<span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="n">app</span><span class="p">):</span>
    <span class="n">app</span><span class="o">.</span><span class="n">add_transform</span><span class="p">(</span><span class="n">CheckFrontMatter</span><span class="p">)</span>    
</pre></div>

<h4>追加のページ生成</h4>
<p><code>ablog/templates</code> に格納されている。</p>
<div class="code"><pre class="code literal-block"><span class="c1"># -- ABlog Sidebars -------------------------------------------------------</span>

<span class="c1"># There are seven sidebars you can include in your HTML output.</span>
<span class="c1"># postcard.html provides information regarding the current post.</span>
<span class="c1"># recentposts.html lists most recent five posts. Others provide</span>
<span class="c1"># a link to a archive pages generated for each tag, category, and year.</span>
<span class="c1"># In addition, there are authors.html, languages.html, and locations.html</span>
<span class="c1"># sidebars that link to author and location archive pages.</span>
<span class="n">html_sidebars</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">'**'</span><span class="p">:</span> <span class="p">[</span>
        <span class="s1">'about.html'</span><span class="p">,</span>
        <span class="s1">'postcard.html'</span><span class="p">,</span>
        <span class="s1">'navigation.html'</span><span class="p">,</span>
        <span class="s1">'recentposts.html'</span><span class="p">,</span>
        <span class="s1">'tagcloud.html'</span><span class="p">,</span>
        <span class="s1">'categories.html'</span><span class="p">,</span>
        <span class="s1">'archives.html'</span><span class="p">,</span>
        <span class="s1">'searchbox.html'</span><span class="p">,</span>
    <span class="p">],</span>
<span class="p">}</span>
</pre></div>

<p>これらに対して追加のページ生成を行っている。
<code>genindex.html</code> などのように。</p>
<h3>ToDo</h3>
<h4>✅ タグが変</h4>
<p>toml 由来の tag の処理に失敗している。</p>
<p><code>["python", "ssg", "sphinx"]</code></p>
<p>が、</p>
<ul>
<li><code>["python"</code></li>
<li><code>"ssg"</code></li>
<li><code>"sphinx"]</code></li>
</ul>
<p>になっちゃってる。</p>
<p>https://github.com/sunpy/ablog/pull/119</p>
<p>送ってみた。</p>
<p><code>v0.10.22</code> で修正。👍</p>
<h4>✅ 日付のフォーマット</h4>
<p><code>conf.py</code></p>
<div class="code"><pre class="code literal-block"><span class="n">post_date_format</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">'%Y/%m/</span><span class="si">%d</span><span class="s1">'</span>
<span class="n">post_date_format_short</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">'%Y/%m'</span>
</pre></div>

<h4>✅ 記事のURL</h4>
<ul>
<li><a href="https://zenn.dev/attakei/articles/sphinx-make-dirhtml">https://zenn.dev/attakei/articles/sphinx-make-dirhtml</a></li>
</ul>
<h4>✅ 記事タイトルは最初の見出しではなく、frontmatter の title にしたい</h4>
<p><code>MystParser</code> を改造した。
わりと Sphinx わかってきた。
<code>python</code> でデバッガがアタッチできるとなんでもできる(慣れ)。</p>
<h4>[ ] tagの表記振れ</h4>
<p><code>c++</code> と <code>C++</code>、<code>c#</code> と <code>csharp</code> などをたばねる。</p>
<h3>参考</h3>
<ul>
<li><a href="https://water2litter.net/pisco/doc/ablog.html">Sphinxでブログをしてみよう</a></li>
</ul>
<hr>
<ul class="pager hidden-print">
<li class="previous">
        <a href="../python_imgui/" rel="prev" title="imgui の python バインディングをまた作る">
            imgui の python バインディングをまた作る 👈
        </a>
    </li>
    <li style="flex-grow: 1">
    <li class="next">
        <a href="../python_geo/" rel="next" title="python で地理情報を扱う">
            👉 python で地理情報を扱う
        </a>
    </li>
</ul></main><footer id="footer"><p>
            Powered by
            <a href="https://getnikola.com" rel="nofollow">Nikola</a>
        </p>
    </footer>
</body>
</html>
