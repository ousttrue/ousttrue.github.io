<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <title>三次元日誌</title>

    

  <script src="https://ousttrue.github.io/plugins/elasticlunr.min.js" defer></script>
  <script src="https://ousttrue.github.io/search_index.en.js" defer></script>
  <script src="https://ousttrue.github.io/js/search.js" defer></script>

    

     
    <link rel="stylesheet" href="https://ousttrue.github.io/main.css">
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css"
      />
    
  </head>

  <body class="container">
    <a class="site_title" href="https:&#x2F;&#x2F;ousttrue.github.io&#x2F;">
      <div>三次元日誌</div>
    </a>

    <nav class="nav">
      <a class="item" href="/tags/">tags</a>
      <a class="item" href="https://github.com/ousttrue" aria-label="github">
        <i class="fab fa-github fa-lg"></i>
      </a>
      

        
            <form class="navbar-form">
                <input id="userinput" class="form-control is-search" type="search" placeholder="Search docs..."
                    aria-label="Search docs..." autocomplete="off">
                <div id="suggestions" class="shadow bg-white rounded"></div>
            </form>
        
    </nav>

    <main class="main">
<div class="page">
<div class="content">
  <div class="headline">
  
  

  
  <a class="headline_title" href="https:&#x2F;&#x2F;ousttrue.github.io&#x2F;posts&#x2F;2021&#x2F;example-glfw-openg&#x2F;"> imgui の FFI が luajit で動くところまで作った 
  

  
  
  
  
  
    
  <div class="image_box"><img src="https:&#x2F;&#x2F;ousttrue.github.io&#x2F;processed_images&#x2F;38fdf210b6ba701d00.jpg"></div>
  
  </a>

  

  <div>
    <ul class="tags">
      <li class="headline_date">
        <div class="year">2021</div>
        <div class="md">0725</div>
      </li>
      
      


    <li class="tag"><a href="https:&#x2F;&#x2F;ousttrue.github.io&#x2F;tags&#x2F;luajit&#x2F;">luajit</a></li>

    <li class="tag"><a href="https:&#x2F;&#x2F;ousttrue.github.io&#x2F;tags&#x2F;ffi&#x2F;">ffi</a></li>

    <li class="tag"><a href="https:&#x2F;&#x2F;ousttrue.github.io&#x2F;tags&#x2F;imgui&#x2F;">imgui</a></li>

    <li class="tag"><a href="https:&#x2F;&#x2F;ousttrue.github.io&#x2F;tags&#x2F;libclang&#x2F;">libclang</a></li>




    </ul>
  </div>
</div>
 <p><a href="https://github.com/ousttrue/limgui/blob/master/imgui_ffi/cdef/imgui.lua">https://github.com/ousttrue/limgui/blob/master/imgui_ffi/cdef/imgui.lua</a></p>
<p>Window System は <code>GLFW</code>、3D API は <code>OpenGL3</code> を選択。</p>
<ul>
<li>SDL2 は、 <code>HWND</code> を取得周りが FFI では面倒なことが分かっていたのと、<code>SDL-Image</code> などの関連ライブラリ無しで行くつもりだった</li>
<li>D3D11 のバインディングを作っているとまた時間がかかる。<code>COM</code> は C の範囲で実装できるので後でやりたい</li>
</ul>
<p>ということから、楽そうなものを選択したらそうなった。</p>
<h1 id="menbaguan-shu-hu-bichu-si">メンバー関数呼び出し</h1>
<p><code>ImFont</code>, <code>ImFontAtlas</code> のみ何故か <code>c++</code> 色が強く、メンバ関数呼び出しがあったりするのでなんとかしたい。
cdecl で FFI 記述できるんだっけ？</p>
<pre style="background-color:#2b303b;">
<code class="language-c++" data-lang="c++"><span style="color:#65737e;">//io.Fonts-&gt;AddFontDefault();</span><span style="color:#65737e;">
//io.Fonts-&gt;AddFontFromFileTTF(&quot;../../misc/fonts/Roboto-Medium.ttf&quot;, 16.0f);</span><span style="color:#65737e;">
//io.Fonts-&gt;AddFontFromFileTTF(&quot;../../misc/fonts/Cousine-Regular.ttf&quot;, 15.0f);</span><span style="color:#65737e;">
//io.Fonts-&gt;AddFontFromFileTTF(&quot;../../misc/fonts/DroidSans.ttf&quot;, 16.0f);</span><span style="color:#65737e;">
//io.Fonts-&gt;AddFontFromFileTTF(&quot;../../misc/fonts/ProggyTiny.ttf&quot;, 10.0f);</span><span style="color:#65737e;">
//ImFont* font = io.Fonts-&gt;AddFontFromFileTTF(&quot;c:\\Windows\\Fonts\\ArialUni.ttf&quot;, 18.0f, NULL, io.Fonts-&gt;GetGlyphRangesJapanese());</span><span style="color:#65737e;">
</span></code></pre>
<p>第1引数に this に相当する引数を追加してやればいけた。</p>
<pre style="background-color:#2b303b;">
<code class="language-lua" data-lang="lua"><span style="color:#bf616a;">ffi</span><span style="color:#c0c5ce;">.</span><span style="color:#bf616a;">cdef</span><span style="color:#c0c5ce;">[[</span><span style="color:#a3be8c;">
// 適当に名前を付け替える</span><span style="color:#a3be8c;">
struct ImFont* ImFontAtlas_AddFontFromFileTTF(</span><span style="color:#a3be8c;">
    struct ImFontAtlas* this,</span><span style="color:#a3be8c;">
    const char* filename,</span><span style="color:#a3be8c;">
    float size_pixels,</span><span style="color:#a3be8c;">
    const struct ImFontConfig* font_cfg,</span><span style="color:#a3be8c;">
    ImWchar* glyph_ranges</span><span style="color:#a3be8c;">
) asm(&quot;?AddFontFromFileTTF@ImFontAtlas@@QEAAPEAUImFont@@PEBDMPEBUImFontConfig@@PEBG@Z&quot;);</span><span style="color:#a3be8c;">
</span><span style="color:#c0c5ce;">]]</span><span style="color:#c0c5ce;">
</span></code></pre><h1 id="c-dehuorutoyin-shu">C++ デフォルト引数</h1>
<p><code>ImGui</code> の <code>API</code> は基本的にほぼ C になるように配慮されていて、C++ の機能は限定的にしか使っていない。</p>
<ul>
<li>関数オーバーロード</li>
<li>デフォルト引数</li>
</ul>
<p>である。
で、このデフォルト引数がないと <code>imgui</code> の使い勝手が著しく下がる。
リファレンスを確認して、デフォルト値を当ててやる必要が出るので。</p>
<pre style="background-color:#2b303b;">
<code class="language-c++" data-lang="c++"><span style="color:#65737e;">// 例</span><span style="color:#65737e;">
</span><span style="color:#c0c5ce;">IMGUI_API </span><span style="color:#b48ead;">bool </span><span style="color:#8fa1b3;">Begin</span><span style="color:#c0c5ce;">(</span><span style="color:#b48ead;">const char</span><span style="color:#c0c5ce;">* </span><span style="color:#bf616a;">name</span><span style="color:#c0c5ce;">, </span><span style="color:#b48ead;">bool</span><span style="color:#c0c5ce;">* </span><span style="color:#bf616a;">p_open </span><span style="color:#c0c5ce;">= </span><span style="color:#d08770;">NULL</span><span style="color:#c0c5ce;">, ImGuiWindowFlags </span><span style="color:#bf616a;">flags </span><span style="color:#c0c5ce;">= </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">);</span><span style="color:#c0c5ce;">
</span></code></pre>
<p><code>NULL</code> は <code>nil</code> だし、 <code>0</code> はそのまま <code>0</code> なので、簡単なところだけでも対応する。
最悪、インテリセンスに出るようにすることで調べる手間は回避できるのだけど
<code>const &amp;ImVec2 v = ImVec2(0, 0)</code> とかはめんどくさいです。
FFI 境界の <code>struct の value 渡し</code>, <code>デフォルト引数</code> は解決できない場合が多いが、コード生成側で努力する価値はある。</p>
<p><code>rust</code> はここができなくて、故にラッパー側で API を builder パターンに変更していたりするのだけど、
<code>rust</code> の <code>imgui</code> ラッパーの API を使いたいのではなくて、生の <code>imgui</code> が使いたいのだ。
<code>luajit</code> の FFI はちょっとラップすることで簡単に解決できる(遅くなるかもしれないが)。</p>
<p>ラッパーを自動で生成するようにできた。</p>
<pre style="background-color:#2b303b;">
<code class="language-lua" data-lang="lua"><span style="color:#c0c5ce;">    </span><span style="color:#65737e;">-- lua では nil と false のみが 偽 である</span><span style="color:#65737e;">
</span><span style="color:#c0c5ce;">
    </span><span style="color:#65737e;">-- wrapper</span><span style="color:#65737e;">
    </span><span style="color:#8fa1b3;">Begin </span><span style="color:#c0c5ce;">= </span><span style="color:#b48ead;">function</span><span style="color:#c0c5ce;">(name, p_open, flags)</span><span style="color:#c0c5ce;">
        </span><span style="color:#65737e;">-- p_open が供給されない場合、デフォルト nil になり、NULL として解釈される</span><span style="color:#65737e;">
        </span><span style="color:#bf616a;">flags </span><span style="color:#c0c5ce;">= </span><span style="color:#bf616a;">flags </span><span style="color:#c0c5ce;">or </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">
        </span><span style="color:#65737e;">-- ffi 呼び出し</span><span style="color:#65737e;">
        </span><span style="color:#b48ead;">return </span><span style="color:#bf616a;">imgui</span><span style="color:#c0c5ce;">.</span><span style="color:#bf616a;">Begin</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">name</span><span style="color:#c0c5ce;">, </span><span style="color:#bf616a;">p_open</span><span style="color:#c0c5ce;">, </span><span style="color:#bf616a;">flags</span><span style="color:#c0c5ce;">)</span><span style="color:#c0c5ce;">
    </span><span style="color:#b48ead;">end</span><span style="color:#c0c5ce;">,</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
    </span><span style="color:#65737e;">-- wrapper</span><span style="color:#65737e;">
    </span><span style="color:#8fa1b3;">Button </span><span style="color:#c0c5ce;">= </span><span style="color:#b48ead;">function</span><span style="color:#c0c5ce;">(label, size)</span><span style="color:#c0c5ce;">
        </span><span style="color:#65737e;">-- 引数なしの `ffi.new` は zero 詰めする。 `ImVec2(0, 0)` になる。</span><span style="color:#65737e;">
        </span><span style="color:#bf616a;">size </span><span style="color:#c0c5ce;">= </span><span style="color:#bf616a;">size </span><span style="color:#c0c5ce;">or </span><span style="color:#bf616a;">ffi</span><span style="color:#c0c5ce;">.</span><span style="color:#bf616a;">new</span><span style="color:#c0c5ce;">(&#39;</span><span style="color:#a3be8c;">struct ImVec2</span><span style="color:#c0c5ce;">&#39;)</span><span style="color:#c0c5ce;">
        </span><span style="color:#65737e;">-- ffi 呼び出し</span><span style="color:#65737e;">
        </span><span style="color:#b48ead;">return </span><span style="color:#bf616a;">imgui</span><span style="color:#c0c5ce;">.</span><span style="color:#bf616a;">Button</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">label</span><span style="color:#c0c5ce;">, </span><span style="color:#bf616a;">size</span><span style="color:#c0c5ce;">)</span><span style="color:#c0c5ce;">
    </span><span style="color:#b48ead;">end</span><span style="color:#c0c5ce;">,</span><span style="color:#c0c5ce;">
</span></code></pre><h1 id="ke-bian-chang-yin-shu">可変長引数</h1>
<pre style="background-color:#2b303b;">
<code class="language-c++" data-lang="c++"><span style="color:#c0c5ce;">IMGUI_API </span><span style="color:#b48ead;">void </span><span style="color:#8fa1b3;">Text</span><span style="color:#c0c5ce;">(</span><span style="color:#b48ead;">const char</span><span style="color:#c0c5ce;">* </span><span style="color:#bf616a;">fmt</span><span style="color:#c0c5ce;">, ...)</span><span style="color:#c0c5ce;">
</span></code></pre>
<p>luajit ffi ではそのまま <code>...</code> を扱うことができた。</p>
<p>ただし、<code>%d</code> のときは、
<code>LL</code> をつけて <code>integer</code> を渡す。
<code>number</code> だとうまくいかない。</p>
<pre style="background-color:#2b303b;">
<code class="language-lua" data-lang="lua"><span style="color:#b48ead;">local </span><span style="color:#bf616a;">count </span><span style="color:#c0c5ce;">= </span><span style="color:#d08770;">1</span><span style="color:#bf616a;">LL </span><span style="color:#65737e;">-- 64bit int. UL もある</span><span style="color:#65737e;">
</span><span style="color:#bf616a;">imgui</span><span style="color:#c0c5ce;">.</span><span style="color:#bf616a;">Text</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">counter = %d</span><span style="color:#c0c5ce;">&quot;, </span><span style="color:#bf616a;">counter</span><span style="color:#c0c5ce;">)</span><span style="color:#c0c5ce;">
</span></code></pre>
<p><code>LL</code> と <code>UL</code> は luajit の拡張らしい。
<a href="https://luajit.org/ext_ffi_api.html">https://luajit.org/ext_ffi_api.html</a></p>
<blockquote>
<p>Extensions to the Lua Parser</p>
<p>numeric literals with the suffixes LL or ULL as signed or unsigned 64 bit integers</p>
</blockquote>
<p>だがしかし、この記法使うと <code>stylua</code> がエラーになる。そりゃ、そうだ。</p>
<pre style="background-color:#2b303b;">
<code class="language-lua" data-lang="lua"><span style="color:#b48ead;">local </span><span style="color:#bf616a;">count </span><span style="color:#c0c5ce;">= </span><span style="color:#bf616a;">ffi</span><span style="color:#c0c5ce;">.</span><span style="color:#bf616a;">new</span><span style="color:#c0c5ce;">(&#39;</span><span style="color:#a3be8c;">long long[1]</span><span style="color:#c0c5ce;">&#39;) </span><span style="color:#65737e;">-- 32bit だとうまくいかない</span><span style="color:#65737e;">
</span><span style="color:#bf616a;">imgui</span><span style="color:#c0c5ce;">.</span><span style="color:#bf616a;">Text</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">counter = %d</span><span style="color:#c0c5ce;">&quot;, </span><span style="color:#bf616a;">counter</span><span style="color:#c0c5ce;">[</span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">])</span><span style="color:#c0c5ce;">
</span></code></pre>
<p>を使うのがよさそう。</p>
<h1 id="template-class-nogomakasi">template class のごまかし</h1>
<p>T を pointer としてしか使わない場合は、
<code>T*</code> を除去して <code>void*</code> にすれば動く。</p>
<pre style="background-color:#2b303b;">
<code class="language-c++" data-lang="c++"><span style="color:#b48ead;">template</span><span style="color:#c0c5ce;">&lt;</span><span style="color:#b48ead;">typename</span><span style="color:#c0c5ce;"> T&gt;</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">struct </span><span style="color:#c0c5ce;">ImVector{</span><span style="color:#c0c5ce;">
    </span><span style="color:#b48ead;">int </span><span style="color:#c0c5ce;">Size;</span><span style="color:#c0c5ce;">
    </span><span style="color:#b48ead;">int</span><span style="color:#c0c5ce;"> Capacity;</span><span style="color:#c0c5ce;">
    T* Data;</span><span style="color:#c0c5ce;">
};    </span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
</span></code></pre><pre style="background-color:#2b303b;">
<code class="language-lua" data-lang="lua"><span style="color:#bf616a;">ffi</span><span style="color:#c0c5ce;">.</span><span style="color:#bf616a;">cdef</span><span style="color:#c0c5ce;">[[</span><span style="color:#a3be8c;">
struct ImVector{</span><span style="color:#a3be8c;">
    int Size;</span><span style="color:#a3be8c;">
    int Capacity;</span><span style="color:#a3be8c;">
    void* Data;</span><span style="color:#a3be8c;">
};    </span><span style="color:#a3be8c;">
</span><span style="color:#c0c5ce;">]]</span><span style="color:#c0c5ce;">
</span></code></pre>
</div>

<nav class="toc">

<div class="toc_fix">
<ul>
    
        <li>
            <a href="https://ousttrue.github.io/posts/2021/example-glfw-openg/#menbaguan-shu-hu-bichu-si">メンバー関数呼び出し</a>
            
        </li>
    
        <li>
            <a href="https://ousttrue.github.io/posts/2021/example-glfw-openg/#c-dehuorutoyin-shu">C++ デフォルト引数</a>
            
        </li>
    
        <li>
            <a href="https://ousttrue.github.io/posts/2021/example-glfw-openg/#ke-bian-chang-yin-shu">可変長引数</a>
            
        </li>
    
        <li>
            <a href="https://ousttrue.github.io/posts/2021/example-glfw-openg/#template-class-nogomakasi">template class のごまかし</a>
            
        </li>
    
</ul>
</div>


</nav>
</div>
</main>

    <footer class="footer">Powered by <a href="https://www.getzola.org/">Zola</a> <a href="https://github.com/ousttrue/zola/tree/custom">custom</a></footer>

  </body>
</html>
