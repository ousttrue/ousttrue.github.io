<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="generator" content="Nikola (getnikola.com)">
<meta name="viewport" content="width=device-width">
<script src="../../../assets/js/all-nocdn.js"></script><title>imgui ã® FFI ãŒ luajit ã§å‹•ãã¨ã“ã‚ã¾ã§ä½œã£ãŸ | ä¸‰æ¬¡å…ƒæ—¥èªŒ</title>
<link href="../../../assets/css/code.css" rel="stylesheet" type="text/css">
<link href="../../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
</head>
<body>
    <h1 id="brand">
        <a href="../../../" title="ä¸‰æ¬¡å…ƒæ—¥èªŒ" rel="home">
            <span id="blog-title">ä¸‰æ¬¡å…ƒæ—¥èªŒ</span>
        </a>
    </h1>

    <nav id="menu"><ul>
<li><a href="../../../archive.html">Archives</a></li>
<li><a href="../../../categories/index.html">Tags</a></li>
<li><a href="../../../rss.xml">RSS feed</a></li>
<li><a href="../../../about">About</a></li>
<li><a href="../../../books">MemoBooks</a></li>

            
            
            
        </ul></nav><hr>
<main id="content"><h1 class="p-name entry-title" itemprop="headline name">
    <h1 class="p-name entry-title" itemprop="headline name">
    <a href="." class="u-url">imgui ã® FFI ãŒ luajit ã§å‹•ãã¨ã“ã‚ã¾ã§ä½œã£ãŸ
    <img src="../../../images/posts/2021/imgui_from_luajit.jpg" alt="" loading="lazy" style="max-width:200px; max-height:200px;"></a>
</h1>
<ul itemprop="keywords" class="tags">
<li>
        <time datetime="2021-07-25T00:00:00+09:00" title="2021-07-25">2021-07-25</time>
</li>
    <li><a class="tag p-category" href="../../../categories/ffi/" rel="tag">ffi</a></li>
    <li><a class="tag p-category" href="../../../categories/imgui/" rel="tag">imgui</a></li>
    <li><a class="tag p-category" href="../../../categories/libclang/" rel="tag">libclang</a></li>
    <li><a class="tag p-category" href="../../../categories/luajit/" rel="tag">luajit</a></li>
</ul>
</h1>

<div>
<p><a href="https://github.com/ousttrue/limgui/blob/master/imgui_ffi/cdef/imgui.lua">https://github.com/ousttrue/limgui/blob/master/imgui_ffi/cdef/imgui.lua</a></p>
<p>Window System ã¯ <code>GLFW</code>ã€3D API ã¯ <code>OpenGL3</code> ã‚’é¸æŠã€‚</p>
<ul>
<li>SDL2 ã¯ã€ <code>HWND</code> ã‚’å–å¾—å‘¨ã‚ŠãŒ FFI ã§ã¯é¢å€’ãªã“ã¨ãŒåˆ†ã‹ã£ã¦ã„ãŸã®ã¨ã€<code>SDL-Image</code> ãªã©ã®é–¢é€£ãƒ©ã‚¤ãƒ–ãƒ©ãƒªç„¡ã—ã§è¡Œãã¤ã‚‚ã‚Šã ã£ãŸ</li>
<li>D3D11 ã®ãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ã‚’ä½œã£ã¦ã„ã‚‹ã¨ã¾ãŸæ™‚é–“ãŒã‹ã‹ã‚‹ã€‚<code>COM</code> ã¯ C ã®ç¯„å›²ã§å®Ÿè£…ã§ãã‚‹ã®ã§å¾Œã§ã‚„ã‚ŠãŸã„</li>
</ul>
<p>ã¨ã„ã†ã“ã¨ã‹ã‚‰ã€æ¥½ãã†ãªã‚‚ã®ã‚’é¸æŠã—ãŸã‚‰ãã†ãªã£ãŸã€‚</p>
<h2>ãƒ¡ãƒ³ãƒãƒ¼é–¢æ•°å‘¼ã³å‡ºã—</h2>
<p><code>ImFont</code>, <code>ImFontAtlas</code> ã®ã¿ä½•æ•…ã‹ <code>c++</code> è‰²ãŒå¼·ãã€ãƒ¡ãƒ³ãƒé–¢æ•°å‘¼ã³å‡ºã—ãŒã‚ã£ãŸã‚Šã™ã‚‹ã®ã§ãªã‚“ã¨ã‹ã—ãŸã„ã€‚
cdecl ã§ FFI è¨˜è¿°ã§ãã‚‹ã‚“ã ã£ã‘ï¼Ÿ</p>
<pre class="code literal-block"><span></span><span class="c1">//io.Fonts-&gt;AddFontDefault();</span>
<span class="c1">//io.Fonts-&gt;AddFontFromFileTTF("../../misc/fonts/Roboto-Medium.ttf", 16.0f);</span>
<span class="c1">//io.Fonts-&gt;AddFontFromFileTTF("../../misc/fonts/Cousine-Regular.ttf", 15.0f);</span>
<span class="c1">//io.Fonts-&gt;AddFontFromFileTTF("../../misc/fonts/DroidSans.ttf", 16.0f);</span>
<span class="c1">//io.Fonts-&gt;AddFontFromFileTTF("../../misc/fonts/ProggyTiny.ttf", 10.0f);</span>
<span class="c1">//ImFont* font = io.Fonts-&gt;AddFontFromFileTTF("c:\\Windows\\Fonts\\ArialUni.ttf", 18.0f, NULL, io.Fonts-&gt;GetGlyphRangesJapanese());</span>
</pre>

<p>ç¬¬1å¼•æ•°ã« this ã«ç›¸å½“ã™ã‚‹å¼•æ•°ã‚’è¿½åŠ ã—ã¦ã‚„ã‚Œã°ã„ã‘ãŸã€‚</p>
<pre class="code literal-block"><span></span><span class="n">ffi</span><span class="p">.</span><span class="n">cdef</span><span class="s">[[</span>
<span class="s">// é©å½“ã«åå‰ã‚’ä»˜ã‘æ›¿ãˆã‚‹</span>
<span class="s">struct ImFont* ImFontAtlas_AddFontFromFileTTF(</span>
<span class="s">    struct ImFontAtlas* this,</span>
<span class="s">    const char* filename,</span>
<span class="s">    float size_pixels,</span>
<span class="s">    const struct ImFontConfig* font_cfg,</span>
<span class="s">    ImWchar* glyph_ranges</span>
<span class="s">) asm("?AddFontFromFileTTF@ImFontAtlas@@QEAAPEAUImFont@@PEBDMPEBUImFontConfig@@PEBG@Z");</span>
<span class="s">]]</span>
</pre>

<h2>C++ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå¼•æ•°</h2>
<p><code>ImGui</code> ã® <code>API</code> ã¯åŸºæœ¬çš„ã«ã»ã¼ C ã«ãªã‚‹ã‚ˆã†ã«é…æ…®ã•ã‚Œã¦ã„ã¦ã€C++ ã®æ©Ÿèƒ½ã¯é™å®šçš„ã«ã—ã‹ä½¿ã£ã¦ã„ãªã„ã€‚</p>
<ul>
<li>é–¢æ•°ã‚ªãƒ¼ãƒãƒ¼ãƒ­ãƒ¼ãƒ‰</li>
<li>ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå¼•æ•°</li>
</ul>
<p>ã§ã‚ã‚‹ã€‚
ã§ã€ã“ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå¼•æ•°ãŒãªã„ã¨ <code>imgui</code> ã®ä½¿ã„å‹æ‰‹ãŒè‘—ã—ãä¸‹ãŒã‚‹ã€‚
ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹ã‚’ç¢ºèªã—ã¦ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’å½“ã¦ã¦ã‚„ã‚‹å¿…è¦ãŒå‡ºã‚‹ã®ã§ã€‚</p>
<pre class="code literal-block"><span></span><span class="c1">// ä¾‹</span>
<span class="n">IMGUI_API</span> <span class="kt">bool</span> <span class="nf">Begin</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">name</span><span class="p">,</span> <span class="kt">bool</span><span class="o">*</span> <span class="n">p_open</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">ImGuiWindowFlags</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">);</span>
</pre>

<p><code>NULL</code> ã¯ <code>nil</code> ã ã—ã€ <code>0</code> ã¯ãã®ã¾ã¾ <code>0</code> ãªã®ã§ã€ç°¡å˜ãªã¨ã“ã‚ã ã‘ã§ã‚‚å¯¾å¿œã™ã‚‹ã€‚
æœ€æ‚ªã€ã‚¤ãƒ³ãƒ†ãƒªã‚»ãƒ³ã‚¹ã«å‡ºã‚‹ã‚ˆã†ã«ã™ã‚‹ã“ã¨ã§èª¿ã¹ã‚‹æ‰‹é–“ã¯å›é¿ã§ãã‚‹ã®ã ã‘ã©
<code>const &amp;ImVec2 v = ImVec2(0, 0)</code> ã¨ã‹ã¯ã‚ã‚“ã©ãã•ã„ã§ã™ã€‚
FFI å¢ƒç•Œã® <code>struct ã® value æ¸¡ã—</code>, <code>ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå¼•æ•°</code> ã¯è§£æ±ºã§ããªã„å ´åˆãŒå¤šã„ãŒã€ã‚³ãƒ¼ãƒ‰ç”Ÿæˆå´ã§åŠªåŠ›ã™ã‚‹ä¾¡å€¤ã¯ã‚ã‚‹ã€‚</p>
<p><code>rust</code> ã¯ã“ã“ãŒã§ããªãã¦ã€æ•…ã«ãƒ©ãƒƒãƒ‘ãƒ¼å´ã§ API ã‚’ builder ãƒ‘ã‚¿ãƒ¼ãƒ³ã«å¤‰æ›´ã—ã¦ã„ãŸã‚Šã™ã‚‹ã®ã ã‘ã©ã€
<code>rust</code> ã® <code>imgui</code> ãƒ©ãƒƒãƒ‘ãƒ¼ã® API ã‚’ä½¿ã„ãŸã„ã®ã§ã¯ãªãã¦ã€ç”Ÿã® <code>imgui</code> ãŒä½¿ã„ãŸã„ã®ã ã€‚
<code>luajit</code> ã® FFI ã¯ã¡ã‚‡ã£ã¨ãƒ©ãƒƒãƒ—ã™ã‚‹ã“ã¨ã§ç°¡å˜ã«è§£æ±ºã§ãã‚‹(é…ããªã‚‹ã‹ã‚‚ã—ã‚Œãªã„ãŒ)ã€‚</p>
<p>ãƒ©ãƒƒãƒ‘ãƒ¼ã‚’è‡ªå‹•ã§ç”Ÿæˆã™ã‚‹ã‚ˆã†ã«ã§ããŸã€‚</p>
<pre class="code literal-block"><span></span>    <span class="c1">-- lua ã§ã¯ nil ã¨ false ã®ã¿ãŒ å½ ã§ã‚ã‚‹</span>

    <span class="c1">-- wrapper</span>
    <span class="n">Begin</span> <span class="o">=</span> <span class="kr">function</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">p_open</span><span class="p">,</span> <span class="n">flags</span><span class="p">)</span>
        <span class="c1">-- p_open ãŒä¾›çµ¦ã•ã‚Œãªã„å ´åˆã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ nil ã«ãªã‚Šã€NULL ã¨ã—ã¦è§£é‡ˆã•ã‚Œã‚‹</span>
        <span class="n">flags</span> <span class="o">=</span> <span class="n">flags</span> <span class="ow">or</span> <span class="mi">0</span>
        <span class="c1">-- ffi å‘¼ã³å‡ºã—</span>
        <span class="kr">return</span> <span class="n">imgui</span><span class="p">.</span><span class="n">Begin</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">p_open</span><span class="p">,</span> <span class="n">flags</span><span class="p">)</span>
    <span class="kr">end</span><span class="p">,</span>

    <span class="c1">-- wrapper</span>
    <span class="n">Button</span> <span class="o">=</span> <span class="kr">function</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>
        <span class="c1">-- å¼•æ•°ãªã—ã® `ffi.new` ã¯ zero è©°ã‚ã™ã‚‹ã€‚ `ImVec2(0, 0)` ã«ãªã‚‹ã€‚</span>
        <span class="n">size</span> <span class="o">=</span> <span class="n">size</span> <span class="ow">or</span> <span class="n">ffi</span><span class="p">.</span><span class="n">new</span><span class="p">(</span><span class="s1">'struct ImVec2'</span><span class="p">)</span>
        <span class="c1">-- ffi å‘¼ã³å‡ºã—</span>
        <span class="kr">return</span> <span class="n">imgui</span><span class="p">.</span><span class="n">Button</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>
    <span class="kr">end</span><span class="p">,</span>
</pre>

<h2>å¯å¤‰é•·å¼•æ•°</h2>
<pre class="code literal-block"><span></span><span class="n">IMGUI_API</span> <span class="kt">void</span> <span class="n">Text</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">fmt</span><span class="p">,</span> <span class="p">...)</span>
</pre>

<p>luajit ffi ã§ã¯ãã®ã¾ã¾ <code>...</code> ã‚’æ‰±ã†ã“ã¨ãŒã§ããŸã€‚</p>
<p>ãŸã ã—ã€<code>%d</code> ã®ã¨ãã¯ã€
<code>LL</code> ã‚’ã¤ã‘ã¦ <code>integer</code> ã‚’æ¸¡ã™ã€‚
<code>number</code> ã ã¨ã†ã¾ãã„ã‹ãªã„ã€‚</p>
<pre class="code literal-block"><span></span><span class="kd">local</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="n">LL</span> <span class="c1">-- 64bit int. UL ã‚‚ã‚ã‚‹</span>
<span class="n">imgui</span><span class="p">.</span><span class="n">Text</span><span class="p">(</span><span class="s2">"counter = %d"</span><span class="p">,</span> <span class="n">counter</span><span class="p">)</span>
</pre>

<p><code>LL</code> ã¨ <code>UL</code> ã¯ luajit ã®æ‹¡å¼µã‚‰ã—ã„ã€‚
<a href="https://luajit.org/ext_ffi_api.html">https://luajit.org/ext_ffi_api.html</a></p>
<blockquote>
<p>Extensions to the Lua Parser</p>
<p>numeric literals with the suffixes LL or ULL as signed or unsigned 64 bit integers</p>
</blockquote>
<p>ã ãŒã—ã‹ã—ã€ã“ã®è¨˜æ³•ä½¿ã†ã¨ <code>stylua</code> ãŒã‚¨ãƒ©ãƒ¼ã«ãªã‚‹ã€‚ãã‚Šã‚ƒã€ãã†ã ã€‚</p>
<pre class="code literal-block"><span></span><span class="kd">local</span> <span class="n">count</span> <span class="o">=</span> <span class="n">ffi</span><span class="p">.</span><span class="n">new</span><span class="p">(</span><span class="s1">'long long[1]'</span><span class="p">)</span> <span class="c1">-- 32bit ã ã¨ã†ã¾ãã„ã‹ãªã„</span>
<span class="n">imgui</span><span class="p">.</span><span class="n">Text</span><span class="p">(</span><span class="s2">"counter = %d"</span><span class="p">,</span> <span class="n">counter</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre>

<p>ã‚’ä½¿ã†ã®ãŒã‚ˆã•ãã†ã€‚</p>
<h2>template class ã®ã”ã¾ã‹ã—</h2>
<p>T ã‚’ pointer ã¨ã—ã¦ã—ã‹ä½¿ã‚ãªã„å ´åˆã¯ã€
<code>T*</code> ã‚’é™¤å»ã—ã¦ <code>void*</code> ã«ã™ã‚Œã°å‹•ãã€‚</p>
<pre class="code literal-block"><span></span><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
<span class="k">struct</span> <span class="n">ImVector</span><span class="p">{</span>
    <span class="kt">int</span> <span class="n">Size</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">Capacity</span><span class="p">;</span>
    <span class="n">T</span><span class="o">*</span> <span class="n">Data</span><span class="p">;</span>
<span class="p">};</span>    
</pre>

<pre class="code literal-block"><span></span><span class="n">ffi</span><span class="p">.</span><span class="n">cdef</span><span class="s">[[</span>
<span class="s">struct ImVector{</span>
<span class="s">    int Size;</span>
<span class="s">    int Capacity;</span>
<span class="s">    void* Data;</span>
<span class="s">};    </span>
<span class="s">]]</span>
</pre>
</div>

<hr>
<ul class="pager hidden-print">
<li class="previous">
        <a href="../invoke/" rel="prev" title="python ã® task runner invoke">
            python ã® task runner invoke ğŸ‘ˆ
        </a>
    </li>
    <li style="flex-grow: 1">
    <li class="next">
        <a href="../lua_info/" rel="next" title="luaãƒ¡ãƒ¢">
            ğŸ‘‰ luaãƒ¡ãƒ¢
        </a>
    </li>
</ul></main><footer id="footer"><p>
            Powered by
            <a href="https://getnikola.com" rel="nofollow">Nikola</a>
        </p>
    </footer>
</body>
</html>
