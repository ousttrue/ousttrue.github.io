<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="generator" content="Nikola (getnikola.com)">
<meta name="viewport" content="width=device-width">
<script src="../../../assets/js/all-nocdn.js"></script><title>rust の ffi | 三次元日誌</title>
<link href="../../../assets/css/code.css" rel="stylesheet" type="text/css">
<link href="../../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
</head>
<body>
    <h1 id="brand">
        <a href="../../../" title="三次元日誌" rel="home">
            <span id="blog-title">三次元日誌</span>
        </a>
    </h1>

    <nav id="menu"><ul>
<li><a href="../../../archive.html">Archives</a></li>
<li><a href="../../../categories/index.html">Tags</a></li>
<li><a href="../../../rss.xml">RSS feed</a></li>
<li><a href="../../../about">About</a></li>
<li><a href="../../../books">MemoBooks</a></li>

            
            
            
        </ul></nav><hr>
<main id="content"><h1 class="p-name entry-title" itemprop="headline name">
    <h1 class="p-name entry-title" itemprop="headline name">
    <a href="." class="u-url">rust の ffi
    </a>
</h1>
<ul itemprop="keywords" class="tags">
<li>
        <time datetime="2021-06-20T00:00:00+09:00" title="2021-06-20">2021-06-20</time>
</li>
    <li><a class="tag p-category" href="../../../categories/ffi/" rel="tag">ffi</a></li>
    <li><a class="tag p-category" href="../../../categories/libclang/" rel="tag">libclang</a></li>
    <li><a class="tag p-category" href="../../../categories/rust/" rel="tag">rust</a></li>
</ul>
</h1>

<div>
<p>rust の FFI に取り組んでいた。
結局、 sdl binding と imgui binding を自作した。</p>
<p>両方とも、既存の crate があるのに何故わざわざ自作するのかと言えば、
ラップされて使い方が変わったところを学ぶのが面倒くさかったからじゃ。
<a href="https://crates.io/crates/sdl2">SDL</a> は　<code>HWND</code> を取得する方法がわかりにくくて <code>SDL_Event</code> を <code>imgui</code> に渡す方法はわからなかった。
<a href="https://crates.io/crates/imgui">imgui</a> は最新版の <code>docking</code> ブランチが使いたかった。</p>
<p><a href="https://crates.io/crates/clang-sys">clang-sys</a> を使って rust の FFI コードを生成し、
<a href="https://crates.io/crates/cc">cc</a> を使って <code>build.rs</code> でライブラリをビルドした。
これで、 <code>c</code> <code>c++</code> のライブラリをソースビルドしてスタティックリンクし、 <code>FFI</code> で関数を呼び出し放題。</p>
<p><code>imgui</code> の FFI 生成の方が簡単で、 <code>SDL</code> の方は C のマクロに苦しんだ(雑に対応)。
とはいえ、わりと素直に記述できるので快適であった。</p>
<p>おかげで、 rust の FFI 周りに対する習熟度がだいぶ上がった。</p>
<h3>できないこと</h3>
<p>POD の struct を return する関数を呼び出すとクラッシュした。</p>
<pre class="code literal-block"><span></span><span class="n">ImVec2</span> <span class="n">ImGui</span><span class="o">::</span><span class="n">GetContentRegionAvail</span><span class="p">();</span>
</pre>

<p>D言語だけど</p>
<p>https://forum.dlang.org/thread/dkamxcamwttszxwwxttv@forum.dlang.org</p>
<p>の件らしく、C++ 側でラップした。</p>
<pre class="code literal-block"><span></span><span class="kt">void</span> <span class="nf">pGetContentRegionAvail</span><span class="p">(</span><span class="n">ImVec2</span> <span class="o">*</span><span class="n">pOut</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">pOut</span><span class="p">)</span> <span class="p">{</span>
    <span class="o">*</span><span class="n">pOut</span> <span class="o">=</span> <span class="n">GetContentRegionAvail</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre>

<h3>自由に static link できる</h3>
<p>build.rs を駆使して自由にリンクできるので、スタティックリンクとダイナミックリンクを制御できるので便利。
特に Windows の場合、システムに共通のライブラリがインストールされていることが期待できないので、
DLLを作ってコピーした入りパスを通すよりは、スタティックリンクする方が気楽。
今回は <code>cc</code> でコンパイルしたけど、<code>c++/c</code> は CMake でビルドする方が管理しやすいかもしれない。</p>
</div>

<ul class="pager hidden-print">
<li class="previous">
        <a href="../../../github/cmake_book/" rel="prev" title="cmake_book">
            cmake_book 👈
        </a>
    </li>
    <li style="flex-grow: 1">
    <li class="next">
        <a href="../../../github/rust_exercise_book/" rel="next" title="rust_exercise_book">
            👉 rust_exercise_book
        </a>
    </li>
</ul></main><footer id="footer"><p>
            Powered by
            <a href="https://getnikola.com" rel="nofollow">Nikola</a>
        </p>
    </footer>
</body>
</html>
