<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <title>三次元日誌</title>

    

  <script src="https://ousttrue.github.io/plugins/elasticlunr.min.js" defer></script>
  <script src="https://ousttrue.github.io/search_index.en.js" defer></script>
  <script src="https://ousttrue.github.io/js/search.js" defer></script>

    

     
    <link rel="stylesheet" href="https://ousttrue.github.io/main.css">
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css"
      />
    
  </head>

  <body class="container">
    <a class="site_title" href="https:&#x2F;&#x2F;ousttrue.github.io&#x2F;">
      <div>三次元日誌</div>
    </a>

    <nav class="nav">
      <a class="item" href="/tags/">tags</a>
      <a class="item" href="https://github.com/ousttrue" aria-label="github">
        <i class="fab fa-github fa-lg"></i>
      </a>
      

        
            <form class="navbar-form">
                <input id="userinput" class="form-control is-search" type="search" placeholder="Search docs..."
                    aria-label="Search docs..." autocomplete="off">
                <div id="suggestions" class="shadow bg-white rounded"></div>
            </form>
        
    </nav>

    <main class="main">
<div class="page">
<div class="content">
  <div class="headline">
  
  

  
  <a class="headline_title" href="https:&#x2F;&#x2F;ousttrue.github.io&#x2F;posts&#x2F;2021&#x2F;fix-hererocks&#x2F;"> VS2019 向けに hererocks を修正(vswhere を使う) 
  

  
  </a>

  

  <div>
    <ul class="tags">
      <li class="headline_date">
        <div class="year">2021</div>
        <div class="md">0715</div>
      </li>
      
      


    <li class="tag"><a href="https:&#x2F;&#x2F;ousttrue.github.io&#x2F;tags&#x2F;python&#x2F;">python</a></li>

    <li class="tag"><a href="https:&#x2F;&#x2F;ousttrue.github.io&#x2F;tags&#x2F;lua&#x2F;">lua</a></li>

    <li class="tag"><a href="https:&#x2F;&#x2F;ousttrue.github.io&#x2F;tags&#x2F;nvim&#x2F;">nvim</a></li>




    </ul>
  </div>
</div>
 <p>hererocks が VS2019BuildTools を検知して動作するように改造してみた。</p>
<p><a href="https://github.com/luarocks/hererocks/pull/15">https://github.com/luarocks/hererocks/pull/15</a></p>
<p>通るかどうかは微妙。
内容的に、通りづらそう。
古い vc を使っていたり MinGW 使っていたりすると実験できないしね。
とりあえず、既存の動いている部分が壊れないようには配慮した。</p>
<p>採用されれば、</p>
<p><a href="https://github.com/wbthomason/packer.nvim/issues/302">https://github.com/wbthomason/packer.nvim/issues/302</a></p>
<p>も進展する。
Windows 版の luarocks 呼び出しに改造が必要なのだが、
先に hererocks が動いている必要があるという順番。</p>
<p>とりあえず単体で試すことができて</p>
<pre style="background-color:#2b303b;">
<code><span style="color:#c0c5ce;"># C:/Python38/Scripts/pip.exe</span><span style="color:#c0c5ce;">
$ pip install https://github.com/ousttrue/hererocks/archive/add_vswhere.zip</span><span style="color:#c0c5ce;">
</span></code></pre>
<p>とする。</p>
<pre style="background-color:#2b303b;">
<code><span style="color:#c0c5ce;"># C:/Python38/Scripts/hererocks.exe</span><span style="color:#c0c5ce;">
$ hererocks.exe --target vs -j 2.1.0-beta3 -r latest build_dir</span><span style="color:#c0c5ce;">
Using cl.exe found in PATH.</span><span style="color:#c0c5ce;">
Fetching LuaJIT 2.1.0-beta3 (target: vs) (cached)</span><span style="color:#c0c5ce;">
Verifying SHA256 checksum</span><span style="color:#c0c5ce;">
Building LuaJIT 2.1.0-beta3 (target: vs)</span><span style="color:#c0c5ce;">
Installing LuaJIT 2.1.0-beta3 (target: vs)</span><span style="color:#c0c5ce;">
Fetching LuaRocks 3.7.0 (cached)</span><span style="color:#c0c5ce;">
Verifying SHA256 checksum</span><span style="color:#c0c5ce;">
Building and installing LuaRocks 3.7.0</span><span style="color:#c0c5ce;">
</span></code></pre>
<p>lua はシステムにインストールして全体でライブラリを共有するというよりは、
プロジェクト単位でインストールしてローカルに必要なライブラリだけを追加するという運用になりそう。
なので、 hererocks でプロジェクトローカルに lua をサクッとビルドできるのはなかなかよい。
python の venv 的な運用。
展開先は、 <code>.gitignore</code> する。</p>
<p>ただ、外部ライブラリのラッパーがさくっと動くかというと Windows だと厳しいものがありますな・・・。
vcpkg と連携させるとか、更なる頑張りが必要かもしれない。
なので、 luajit の ffi が面白いかもしれない。
standalone の lua インタプリタを使う場合は <code>hererocks</code> がいいのではないか。</p>
<h2 id="vswhere-memo">vswhere メモ</h2>
<p><a href="https://github.com/Microsoft/vswhere">https://github.com/Microsoft/vswhere</a></p>
<p><code>cl.exe</code>, <code>msbuild.exe</code> などの探索に使う。
<code>vs2017 version 15.2</code> 以降に入っているらしい。</p>
<p>こんな感じに使う。</p>
<pre style="background-color:#2b303b;">
<code><span style="color:#c0c5ce;"># %ProgramFiles(x86)%\Microsoft Visual Studio\Installer\vswhere.exe</span><span style="color:#c0c5ce;">
&gt; vswhere -nologo -products *</span><span style="color:#c0c5ce;">
instanceId: 6762dfe1</span><span style="color:#c0c5ce;">
installDate: 2020/07/21 9:26:34</span><span style="color:#c0c5ce;">
installationName: VisualStudio/16.7.3+30503.244</span><span style="color:#c0c5ce;">
installationPath: C:\Program Files (x86)\Microsoft Visual Studio\2019\BuildTools</span><span style="color:#c0c5ce;">
installationVersion: 16.7.30503.244</span><span style="color:#c0c5ce;">
productId: Microsoft.VisualStudio.Product.BuildTools</span><span style="color:#c0c5ce;">
productPath: C:\Program Files (x86)\Microsoft Visual Studio\2019\BuildTools\Common7\Tools\LaunchDevCmd.bat</span><span style="color:#c0c5ce;">
state: 4294967295</span><span style="color:#c0c5ce;">
isComplete: 1</span><span style="color:#c0c5ce;">
isLaunchable: 1</span><span style="color:#c0c5ce;">
isPrerelease: 0</span><span style="color:#c0c5ce;">
isRebootRequired: 0</span><span style="color:#c0c5ce;">
displayName: Visual Studio Build Tools 2019</span><span style="color:#c0c5ce;">
description: Visual Studio Build Tools では、Visual Studio IDE を必要とせずに、MSBuild ベースのネイティブ マネージド アプリケーションをビルドできます。また、Visual C++ のコンパイラやライブラリ、MFC、ATL、および C++/CLI サポートをインストールするオプションも用意されています。</span><span style="color:#c0c5ce;">
channelId: VisualStudio.16.Release</span><span style="color:#c0c5ce;">
channelUri: https://aka.ms/vs/16/release/channel</span><span style="color:#c0c5ce;">
enginePath: C:\Program Files (x86)\Microsoft Visual Studio\Installer\resources\app\ServiceHub\Services\Microsoft.VisualStudio.Setup.Service</span><span style="color:#c0c5ce;">
releaseNotes: https://go.microsoft.com/fwlink/?LinkId=660893#16.7.3</span><span style="color:#c0c5ce;">
thirdPartyNotices: https://go.microsoft.com/fwlink/?LinkId=660909</span><span style="color:#c0c5ce;">
updateDate: 2020-09-13T06:19:26.0508205Z</span><span style="color:#c0c5ce;">
catalog_buildBranch: d16.7</span><span style="color:#c0c5ce;">
catalog_buildVersion: 16.7.30503.244</span><span style="color:#c0c5ce;">
catalog_id: VisualStudio/16.7.3+30503.244</span><span style="color:#c0c5ce;">
catalog_localBuild: build-lab</span><span style="color:#c0c5ce;">
catalog_manifestName: VisualStudio</span><span style="color:#c0c5ce;">
catalog_manifestType: installer</span><span style="color:#c0c5ce;">
catalog_productDisplayVersion: 16.7.3</span><span style="color:#c0c5ce;">
catalog_productLine: Dev16</span><span style="color:#c0c5ce;">
catalog_productLineVersion: 2019</span><span style="color:#c0c5ce;">
catalog_productMilestone: RTW</span><span style="color:#c0c5ce;">
catalog_productMilestoneIsPreRelease: False</span><span style="color:#c0c5ce;">
catalog_productName: Visual Studio</span><span style="color:#c0c5ce;">
catalog_productPatchVersion: 3</span><span style="color:#c0c5ce;">
catalog_productPreReleaseMilestoneSuffix: 1.0</span><span style="color:#c0c5ce;">
catalog_productSemanticVersion: 16.7.3+30503.244</span><span style="color:#c0c5ce;">
catalog_requiredEngineVersion: 2.7.3132.26759</span><span style="color:#c0c5ce;">
properties_campaignId:</span><span style="color:#c0c5ce;">
properties_channelManifestId: VisualStudio.16.Release/16.7.3+30503.244</span><span style="color:#c0c5ce;">
properties_nickname:</span><span style="color:#c0c5ce;">
properties_setupEngineFilePath: C:\Program Files (x86)\Microsoft Visual Studio\Installer\vs_installershell.exe</span><span style="color:#c0c5ce;">
</span></code></pre>
<p><a href="https://github.com/microsoft/vswhere/wiki/Find-VC">https://github.com/microsoft/vswhere/wiki/Find-VC</a></p>
<p>フィルタをかけられる。</p>
<pre style="background-color:#2b303b;">
<code><span style="color:#c0c5ce;">&gt; vswhere -latest -products * -requires Microsoft.VisualStudio.Component.VC.Tools.x86.x64 -property installationPath</span><span style="color:#c0c5ce;">
C:\Program Files (x86)\Microsoft Visual Studio\2019\BuildTools</span><span style="color:#c0c5ce;">
</span></code></pre>
<p>見つかったパスから先は固定であるとみなして、 <code>vcvars64.bat</code> などを見つける。</p>

</div>

<nav class="toc">

<div class="toc_fix">
<ul>
    
        <li>
            <a href="https://ousttrue.github.io/posts/2021/fix-hererocks/#vswhere-memo">vswhere メモ</a>
            
        </li>
    
</ul>
</div>


</nav>
</div>
</main>

    <footer class="footer">Powered by <a href="https://www.getzola.org/">Zola</a> <a href="https://github.com/ousttrue/zola/tree/custom">custom</a></footer>

  </body>
</html>
