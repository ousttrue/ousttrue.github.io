<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <title>三次元日誌</title>

    

  <script src="https://ousttrue.github.io/plugins/elasticlunr.min.js" defer></script>
  <script src="https://ousttrue.github.io/search_index.en.js" defer></script>
  <script src="https://ousttrue.github.io/js/search.js" defer></script>

    

     
    <link rel="stylesheet" href="https://ousttrue.github.io/main.css">
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css"
      />
    
  </head>

  <body class="container">
    <a class="site_title" href="https:&#x2F;&#x2F;ousttrue.github.io&#x2F;">
      <div>三次元日誌</div>
    </a>

    <nav class="nav">
      <a class="item" href="/tags/">tags</a>
      <a class="item" href="https://github.com/ousttrue" aria-label="github">
        <i class="fab fa-github fa-lg"></i>
      </a>
      

        
            <form class="navbar-form">
                <input id="userinput" class="form-control is-search" type="search" placeholder="Search docs..."
                    aria-label="Search docs..." autocomplete="off">
                <div id="suggestions" class="shadow bg-white rounded"></div>
            </form>
        
    </nav>

    <main class="main">
<div class="page">
<div class="content">
  <div class="headline">
  
  

  
  <a class="headline_title" href="https:&#x2F;&#x2F;ousttrue.github.io&#x2F;posts&#x2F;2015&#x2F;11&#x2F;14&#x2F;gulp-static-site&#x2F;"> gulpで静的サイト生成その２ 
  

  
  </a>

  

  <div>
    <ul class="tags">
      <li class="headline_date">
        <div class="year">2015</div>
        <div class="md">1114</div>
      </li>
      
      

    </ul>
  </div>
</div>
 <p>gulpで静的サイト生成その２
引き続き、サイト生成作業を続行中。見た目は置いておいて(bootstrap入れたけど)機能を優先して作ろう。
「次へ」と「前へ」のリンクを作れば内部リンクは揃う。
gulpは自由度が高いのでなんとでもなるな。
強まったmakeのようで非常にポテンシャルを感じる。
中期的なも目標としてはローカルもしくはLAN内のnode.jsがホストとなるGUIをさくっと作れるようになるというものがあるのだが、
関連項目が多すぎてひたすら拡がっていくのが危険だ。
特に、インターネットで調べながらだと収束せずにひたすら拡散する傾向がある。
anglar, backboneは避けようと思ったのだがmithrilは気になっているし、electronも気になっている。
あと、typescriptもはやめに使いこなしたい。
だいぶgulpがわかってきた
「前へ」と「次へ」は全部のファイルをリストに投入してソートして隣通しのパスを得る必要がある。
一度リストに投入してから前へと次へを処理した後で、再度リストの中身を一個ずつ後ろに渡せばいいじゃない。
ということでやってみたらあっさりできた。
野良プラグインの作り方が分かるとgulp面白いな。
make-toc.js
var through = require('through2');
var gutil = require('gulp-util');
var path = require('path');</p>
<p>module.exports = function (outputFileName, options) {</p>
<pre style="background-color:#2b303b;">
<code>options = options || {};
var dest = options.dest;
var filelist = [];

function transform(file, encoding, callback) {

    // ファイルを集める
    filelist.push(file);

    // callback()は必ず実行
    callback();
}

function flush(callback) {

    if (filelist.length &gt; 0) {

        // sortすることで日付順に並ぶ
        filelist.sort(function compareNumbers(a, b) {
            if (a.path &lt; b.path) {
                return 1;
            } else {
                return -1;
            }
        });
        var file = filelist[0];

        // 目次
        var output_map = {
            cwd: file.cwd,
            base: file.base,
            path: file.base + outputFileName,
        };
       // console.log(output_map);
        var output = new gutil.File(output_map);

        var html = '&lt;ul&gt;\n';
        //console.log(filelist.length);
        for (var i = 0; i &lt; filelist.length; ++i) {
            var f = filelist[i];
            var rel = dest + &quot;/&quot; + f.path.substr(f.base.length).replace(/\\/g, '/');
            //console.log(rel);              
            html += '&lt;li&gt;&lt;a href=&quot;' + rel + '&quot;&gt;' + f.frontMatter.title + '&lt;/a&gt;&lt;/li&gt;\n';
            
            // 各アイテムのfrontMatterにnextとprevを付ける
            // 降順に並んでいる
            if (i === 0) {
                // 先頭
                f.frontMatter.next = &quot;&quot;;
                f.frontMatter.prev = path.relative(path.dirname(f.path), filelist[i + 1].path).replace(/\\/g, '/');
            }
            else if (i === filelist.length-1) {
                // 終端
                f.frontMatter.next = path.relative(path.dirname(f.path), filelist[i - 1].path).replace(/\\/g, '/');
                f.frontMatter.prev = &quot;&quot;;
            }
            else {
                f.frontMatter.next = path.relative(path.dirname(f.path), filelist[i - 1].path).replace(/\\/g, '/');
                f.frontMatter.prev = path.relative(path.dirname(f.path), filelist[i + 1].path).replace(/\\/g, '/');
            }
        }
        html += '&lt;/ul&gt;\n';
        output.contents = new Buffer(html);

        // filelistをoutputにくっつける
        output.filelist = filelist;

        this.push(output);
    }

    // callback()は必ず実行
    callback();
}

return through.obj(transform, flush);
</code></pre>
<p>};</p>
<p>resplit.js
var through = require('through2');
var gutil = require('gulp-util');
var path = require('path');</p>
<p>module.exports = function () {</p>
<pre style="background-color:#2b303b;">
<code>function transform(file, encoding, callback) {

    // ファイルがnullの場合
    if (file.isNull()) {
        // 次のプラグインに処理を渡すためにthis.push(file)しておく
        this.push(file);
        // callback()は必ず実行
        return callback();
    }

    // ファイルがstreamの場合（このサンプルプラグインはstreamに対応しない）
    if (file.isStream()) {
        // emit('error')を使って、プラグイン呼び出し側に'error'イベントを発生させる
        this.emit('error', new gutil.PluginError('gulp-diff', 'Streaming not supported'));
        // callback()は必ず実行
        return callback();
    }

    // do something
    for(var key in file.filelist){
        var output=file.filelist[key];
        this.push(output);           
    }

    // callback()は必ず実行
    callback();
}

return through.obj(transform);
</code></pre>
<p>};</p>
<p>gulfile.js
gulp.task('posts', function () {
gulp.src(config.posts)
// frontMatter処理してhtml化する
.pipe($.frontMatter({ remove: true }))
.pipe(myFrontmatter())
.pipe($.markdown())
// まとめてsortしてメタ情報を付与して目次を出力する
.pipe(makeToc('index.html', { dest: 'posts' }))
.pipe(gulp.dest('build'))
// 再び分解する
.pipe(resplit())
// 以降通常
.pipe($.debug({ title: 'files:' }))
// テンプレートを適用して
.pipe(ejsApplyer({ filename: 'templates/page.ejs' }, { root_path: '../../../../' }))
// 出力
.pipe(gulp.dest('build/posts'))
;
});</p>

</div>

<nav class="toc">


</nav>
</div>
</main>

    <footer class="footer">Powered by <a href="https://www.getzola.org/">Zola</a> <a href="https://github.com/ousttrue/zola/tree/custom">custom</a></footer>

  </body>
</html>
