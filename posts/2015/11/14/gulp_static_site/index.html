<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="generator" content="Nikola (getnikola.com)">
<meta name="viewport" content="width=device-width">
<script src="../../../../../assets/js/all-nocdn.js"></script><title>gulpで静的サイト生成その２ | 三次元日誌</title>
<link href="../../../../../assets/css/code.css" rel="stylesheet" type="text/css">
<link href="../../../../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
</head>
<body>
    <h1 id="brand">
        <a href="../../../../../" title="三次元日誌" rel="home">
            <span id="blog-title">三次元日誌</span>
        </a>
    </h1>
    <hr>
<main id="content"><h1 class="p-name entry-title" itemprop="headline name">
    <a href="." class="u-url">gulpで静的サイト生成その２</a>
</h1>
<div>
<p>gulpで静的サイト生成その２
引き続き、サイト生成作業を続行中。見た目は置いておいて(bootstrap入れたけど)機能を優先して作ろう。
「次へ」と「前へ」のリンクを作れば内部リンクは揃う。
gulpは自由度が高いのでなんとでもなるな。
強まったmakeのようで非常にポテンシャルを感じる。
中期的なも目標としてはローカルもしくはLAN内のnode.jsがホストとなるGUIをさくっと作れるようになるというものがあるのだが、
関連項目が多すぎてひたすら拡がっていくのが危険だ。
特に、インターネットで調べながらだと収束せずにひたすら拡散する傾向がある。
anglar, backboneは避けようと思ったのだがmithrilは気になっているし、electronも気になっている。
あと、typescriptもはやめに使いこなしたい。
だいぶgulpがわかってきた
「前へ」と「次へ」は全部のファイルをリストに投入してソートして隣通しのパスを得る必要がある。
一度リストに投入してから前へと次へを処理した後で、再度リストの中身を一個ずつ後ろに渡せばいいじゃない。
ということでやってみたらあっさりできた。
野良プラグインの作り方が分かるとgulp面白いな。
make-toc.js
var through = require('through2');
var gutil = require('gulp-util');
var path = require('path');</p>
<p>module.exports = function (outputFileName, options) {</p>
<pre class="code literal-block"><span></span><span class="nx">options</span> <span class="o">=</span> <span class="nx">options</span> <span class="o">||</span> <span class="p">{};</span>
<span class="kd">var</span> <span class="nx">dest</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">dest</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">filelist</span> <span class="o">=</span> <span class="p">[];</span>

<span class="kd">function</span> <span class="nx">transform</span><span class="p">(</span><span class="nx">file</span><span class="p">,</span> <span class="nx">encoding</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>

    <span class="c1">// ファイルを集める</span>
    <span class="nx">filelist</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">file</span><span class="p">);</span>

    <span class="c1">// callback()は必ず実行</span>
    <span class="nx">callback</span><span class="p">();</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">flush</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">filelist</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

        <span class="c1">// sortすることで日付順に並ぶ</span>
        <span class="nx">filelist</span><span class="p">.</span><span class="nx">sort</span><span class="p">(</span><span class="kd">function</span> <span class="nx">compareNumbers</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">path</span> <span class="o">&lt;</span> <span class="nx">b</span><span class="p">.</span><span class="nx">path</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">});</span>
        <span class="kd">var</span> <span class="nx">file</span> <span class="o">=</span> <span class="nx">filelist</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

        <span class="c1">// 目次</span>
        <span class="kd">var</span> <span class="nx">output_map</span> <span class="o">=</span> <span class="p">{</span>
            <span class="nx">cwd</span>: <span class="kt">file.cwd</span><span class="p">,</span>
            <span class="nx">base</span>: <span class="kt">file.base</span><span class="p">,</span>
            <span class="nx">path</span>: <span class="kt">file.base</span> <span class="o">+</span> <span class="nx">outputFileName</span><span class="p">,</span>
        <span class="p">};</span>
       <span class="c1">// console.log(output_map);</span>
        <span class="kd">var</span> <span class="nx">output</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">gutil</span><span class="p">.</span><span class="nx">File</span><span class="p">(</span><span class="nx">output_map</span><span class="p">);</span>

        <span class="kd">var</span> <span class="nx">html</span> <span class="o">=</span> <span class="s1">'&lt;ul&gt;\n'</span><span class="p">;</span>
        <span class="c1">//console.log(filelist.length);</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">filelist</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">f</span> <span class="o">=</span> <span class="nx">filelist</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
            <span class="kd">var</span> <span class="nx">rel</span> <span class="o">=</span> <span class="nx">dest</span> <span class="o">+</span> <span class="s2">"/"</span> <span class="o">+</span> <span class="nx">f</span><span class="p">.</span><span class="nx">path</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="nx">f</span><span class="p">.</span><span class="nx">base</span><span class="p">.</span><span class="nx">length</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\\/g</span><span class="p">,</span> <span class="s1">'/'</span><span class="p">);</span>
            <span class="c1">//console.log(rel);              </span>
            <span class="nx">html</span> <span class="o">+=</span> <span class="s1">'&lt;li&gt;&lt;a href="'</span> <span class="o">+</span> <span class="nx">rel</span> <span class="o">+</span> <span class="s1">'"&gt;'</span> <span class="o">+</span> <span class="nx">f</span><span class="p">.</span><span class="nx">frontMatter</span><span class="p">.</span><span class="nx">title</span> <span class="o">+</span> <span class="s1">'&lt;/a&gt;&lt;/li&gt;\n'</span><span class="p">;</span>

            <span class="c1">// 各アイテムのfrontMatterにnextとprevを付ける</span>
            <span class="c1">// 降順に並んでいる</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">i</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="c1">// 先頭</span>
                <span class="nx">f</span><span class="p">.</span><span class="nx">frontMatter</span><span class="p">.</span><span class="nx">next</span> <span class="o">=</span> <span class="s2">""</span><span class="p">;</span>
                <span class="nx">f</span><span class="p">.</span><span class="nx">frontMatter</span><span class="p">.</span><span class="nx">prev</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">relative</span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">dirname</span><span class="p">(</span><span class="nx">f</span><span class="p">.</span><span class="nx">path</span><span class="p">),</span> <span class="nx">filelist</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">].</span><span class="nx">path</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\\/g</span><span class="p">,</span> <span class="s1">'/'</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">i</span> <span class="o">===</span> <span class="nx">filelist</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
                <span class="c1">// 終端</span>
                <span class="nx">f</span><span class="p">.</span><span class="nx">frontMatter</span><span class="p">.</span><span class="nx">next</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">relative</span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">dirname</span><span class="p">(</span><span class="nx">f</span><span class="p">.</span><span class="nx">path</span><span class="p">),</span> <span class="nx">filelist</span><span class="p">[</span><span class="nx">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="nx">path</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\\/g</span><span class="p">,</span> <span class="s1">'/'</span><span class="p">);</span>
                <span class="nx">f</span><span class="p">.</span><span class="nx">frontMatter</span><span class="p">.</span><span class="nx">prev</span> <span class="o">=</span> <span class="s2">""</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="p">{</span>
                <span class="nx">f</span><span class="p">.</span><span class="nx">frontMatter</span><span class="p">.</span><span class="nx">next</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">relative</span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">dirname</span><span class="p">(</span><span class="nx">f</span><span class="p">.</span><span class="nx">path</span><span class="p">),</span> <span class="nx">filelist</span><span class="p">[</span><span class="nx">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="nx">path</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\\/g</span><span class="p">,</span> <span class="s1">'/'</span><span class="p">);</span>
                <span class="nx">f</span><span class="p">.</span><span class="nx">frontMatter</span><span class="p">.</span><span class="nx">prev</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">relative</span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">dirname</span><span class="p">(</span><span class="nx">f</span><span class="p">.</span><span class="nx">path</span><span class="p">),</span> <span class="nx">filelist</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">].</span><span class="nx">path</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\\/g</span><span class="p">,</span> <span class="s1">'/'</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="nx">html</span> <span class="o">+=</span> <span class="s1">'&lt;/ul&gt;\n'</span><span class="p">;</span>
        <span class="nx">output</span><span class="p">.</span><span class="nx">contents</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Buffer</span><span class="p">(</span><span class="nx">html</span><span class="p">);</span>

        <span class="c1">// filelistをoutputにくっつける</span>
        <span class="nx">output</span><span class="p">.</span><span class="nx">filelist</span> <span class="o">=</span> <span class="nx">filelist</span><span class="p">;</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">output</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// callback()は必ず実行</span>
    <span class="nx">callback</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">return</span> <span class="nx">through</span><span class="p">.</span><span class="nx">obj</span><span class="p">(</span><span class="nx">transform</span><span class="p">,</span> <span class="nx">flush</span><span class="p">);</span>
</pre>

<p>};</p>
<p>resplit.js
var through = require('through2');
var gutil = require('gulp-util');
var path = require('path');</p>
<p>module.exports = function () {</p>
<pre class="code literal-block"><span></span><span class="kd">function</span> <span class="nx">transform</span><span class="p">(</span><span class="nx">file</span><span class="p">,</span> <span class="nx">encoding</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>

    <span class="c1">// ファイルがnullの場合</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">file</span><span class="p">.</span><span class="nx">isNull</span><span class="p">())</span> <span class="p">{</span>
        <span class="c1">// 次のプラグインに処理を渡すためにthis.push(file)しておく</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">file</span><span class="p">);</span>
        <span class="c1">// callback()は必ず実行</span>
        <span class="k">return</span> <span class="nx">callback</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="c1">// ファイルがstreamの場合（このサンプルプラグインはstreamに対応しない）</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">file</span><span class="p">.</span><span class="nx">isStream</span><span class="p">())</span> <span class="p">{</span>
        <span class="c1">// emit('error')を使って、プラグイン呼び出し側に'error'イベントを発生させる</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">'error'</span><span class="p">,</span> <span class="k">new</span> <span class="nx">gutil</span><span class="p">.</span><span class="nx">PluginError</span><span class="p">(</span><span class="s1">'gulp-diff'</span><span class="p">,</span> <span class="s1">'Streaming not supported'</span><span class="p">));</span>
        <span class="c1">// callback()は必ず実行</span>
        <span class="k">return</span> <span class="nx">callback</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="c1">// do something</span>
    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">file</span><span class="p">.</span><span class="nx">filelist</span><span class="p">){</span>
        <span class="kd">var</span> <span class="nx">output</span><span class="o">=</span><span class="nx">file</span><span class="p">.</span><span class="nx">filelist</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">output</span><span class="p">);</span>           
    <span class="p">}</span>

    <span class="c1">// callback()は必ず実行</span>
    <span class="nx">callback</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">return</span> <span class="nx">through</span><span class="p">.</span><span class="nx">obj</span><span class="p">(</span><span class="nx">transform</span><span class="p">);</span>
</pre>

<p>};</p>
<p>gulfile.js
gulp.task('posts', function () {
    gulp.src(config.posts)
    // frontMatter処理してhtml化する
        .pipe($.frontMatter({ remove: true }))
        .pipe(myFrontmatter())
        .pipe($.markdown())
    // まとめてsortしてメタ情報を付与して目次を出力する
        .pipe(makeToc('index.html', { dest: 'posts' }))
        .pipe(gulp.dest('build'))
    // 再び分解する
        .pipe(resplit())
    // 以降通常
        .pipe($.debug({ title: 'files:' }))
    // テンプレートを適用して
        .pipe(ejsApplyer({ filename: 'templates/page.ejs' }, { root_path: '../../../../' }))
    // 出力
        .pipe(gulp.dest('build/posts'))
    ;
});</p>
</div>
    </main><footer id="footer"><p>
            Powered by
            <a href="https://getnikola.com" rel="nofollow">Nikola</a>
        </p>
    </footer>
</body>
</html>
