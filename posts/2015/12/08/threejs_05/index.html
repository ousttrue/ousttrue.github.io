<!DOCTYPE html>
<html><body>
    <h1 id="brand">
        <a href="../../../../../" title="三次元日誌" rel="home">
            <span id="blog-title">三次元日誌</span>
        </a>
    </h1>
    <hr>
<main id="content"><h1 class="p-name entry-title" itemprop="headline name">
    <a href="." class="u-url">Three.jsのBuild</a>
</h1>
<div>
<p>骨入りモデルとかやってみようかと思ったのだけど、その前にThree.jsのソースを見やすい状態で作業したい。
結合前のThree.jsを自前ビルドしながら運用する方法を調べてみる。
build.py, or how to generate a compressed three.js file
と本家に書いてある。python使うんか。gulpでやりてぇな。
全部concatしてuglifyしたらいいんじゃないか。
やってみよう。
とりあえずbowerで導入したthree.js関連を削除。
threejs.srcフォルダを作ってthree.jsソースのsrcディレクトリの中身を展開した。
gulp.task('bowerjs', function () {</p>
<pre class="code literal-block"><span></span><span class="x">var files = [</span>
<span class="x">    './bower_components/jquery/dist/jquery.js',</span>
<span class="x">    './bower_components/highlightjs/highlight.pack.js',</span>
<span class="x">    './bower_components/stats.js/build/stats.min.js',</span>
<span class="x">    './lib/**/*.js', // &lt;-- 中にthree.jsのsrcをコピーした</span>
<span class="x">];</span>
<span class="x">gulp.src(files)</span>
<span class="x">    .pipe($.plumber({ errorHandler: $.notify.onError('</span><span class="cp">&lt;%=</span> <span class="n">error</span><span class="o">.</span><span class="n">message</span> <span class="cp">%&gt;</span><span class="x">') }))</span>
<span class="x">    .pipe($.debug({ title: 'bowerjs files:' }))</span>
<span class="x">    .pipe($.sourcemaps.init())</span>
<span class="x">    //.pipe($.uglify())</span>
<span class="x">    .pipe($.concat('all.min.js'))</span>
<span class="x">    .pipe($.sourcemaps.write('./', {</span>
<span class="x">        sourceMappingURL: function (file) {</span>
<span class="x">            return file.relative + '.map';</span>
<span class="x">        }</span>
<span class="x">    }))</span>
<span class="x">    .pipe(gulp.dest('build/js'))</span>
<span class="x">    .pipe(browser.reload({ stream: true }))</span>
<span class="x">;</span>
</pre>

<p>});</p>
<p>これで作ったall.min.jsではエラーが出てだめですね。
単にsrcをconcatするだけではだめだ。本家のドキュメントを読み始める。
/three.js/utils/build/</p>
<p>でビルドできるよって書いてあります。python関係ないみたいだ。</p>
<blockquote>
<p>npm install
node build.js --include common --include extras</p>
</blockquote>
<p>なるほどbuild.jsを見てみよう。
includeってなんだろうと調べてみると
/three.js/utils/build/includes</p>
<p>にjsonファイルがあり中にjsファイルがリストされている。
なるほど。src下を全部concatするのではなくここに書いてあるものを、書いてある順でconcatすればいいんでないか。
// 
gulp.task('threejs:build', function(){
    var common=JSON.parse(fs.readFileSync('three.js/includes/common.json')).map(function(v, i){ return 'three.js/'+v; });
    gulp.src(common)
        .pipe($.concat('three.js'))
        .pipe(gulp.dest('./lib'))
        ;
});</p>
<p>gulp.task('bowerjs', ['threejs:build'], function () {
    // 前と同じ
}
````</p>
<p>これで実行するとそれっぽいthree.jsが出てくるが、まだエラーが出る。
でエラー行に飛ぶとifdefがある。なんだこれは。</p>
<p>```glsl</p>
<h2>ifdef USE_ALPHAMAP</h2>
<pre class="code literal-block"><span></span>diffuseColor.a *= texture2D( alphaMap, vUv ).g;
</pre>

<h2>endif</h2>
<p>glslだ・・・。
確かに、build.js内で拡張子がglslのファイルだけ別処理になっている。
if( file.indexOf( '.glsl') &gt;= 0 ) {</p>
<pre class="code literal-block"><span></span>contents = 'THREE.ShaderChunk[ \'' +
    path.basename( file, '.glsl' ) + '\' ] =' +
    JSON.stringify( contents ) + ';\n';
</pre>

<p>}</p>
<p>ちょっとgulpのフィルタを作りますか。
three.shaderchunk.js
var through = require('through2');
var gutil = require('gulp-util');
var fs = require('fs');
var path = require('path');</p>
<p>module.exports = function () {</p>
<pre class="code literal-block"><span></span>return through.obj(function (file, enc, cb) {

    if (file.isStream()) {
        cb(new gutil.PluginError('three.shadechunk', 'Streaming not supported'));
        return;
    }

    if (path.extname(file.path).toLowerCase() == '.glsl') {
        var contents = 'THREE.ShaderChunk[ \'' +
            path.basename(file.path, '.glsl') + '\' ] =' +
            JSON.stringify(file.contents.toString()) + ';\n';
        file.contents = new Buffer(contents);
        file.path = file.path + ".js";
    }

    this.push(file);

    cb();
});
</pre>

<p>}</p>
<p>gulpファイルの呼び出しの方。これでthree.js/srcからthree.jsを作成できた。
あとは、sourcemapが付くようにした。
gulpfile.js
gulp.task('threejs:build', function(){
    var common=JSON.parse(fs.readFileSync('three.js/includes/common.json'))
    .map(function(v, i){ return 'three.js/'+v; });
    var extras=JSON.parse(fs.readFileSync('three.js/includes/extras.json'))
    .map(function(v, i){ return 'three.js/'+v; });
    gulp.src(common.concat(extras))
        .pipe(threeShaderchunk())
        .pipe($.concat('three.js'))
        .pipe(gulp.dest('./lib'))
        ;
});</p>
<p>FireFoxでブレイクポイントを仕掛けてステップ実行できた。
これで、Loaderの自作とかが捗るぞ。</p>
</div>
    </main>
</body></html>
