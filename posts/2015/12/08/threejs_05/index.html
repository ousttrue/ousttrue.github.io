<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="generator" content="Nikola (getnikola.com)">
<meta name="viewport" content="width=device-width">
<script src="../../../../../assets/js/all-nocdn.js"></script><title>Three.jsのBuild | 三次元日誌</title>
<link href="../../../../../assets/css/code.css" rel="stylesheet" type="text/css">
<link href="../../../../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
</head>
<body>
    <h1 id="brand">
        <a href="../../../../../" title="三次元日誌" rel="home">
            <span id="blog-title">三次元日誌</span>
        </a>
    </h1>

    <nav id="menu"><ul>
<li><a href="../../../../../archive.html">Archives</a></li>
<li><a href="../../../../../categories/index.html">Tags</a></li>
<li><a href="../../../../../rss.xml">RSS feed</a></li>
<li><a href="../../../../../about">About</a></li>
<li><a href="../../../../../books">MemoBooks</a></li>

            
            
            
        </ul></nav><hr>
<main id="content"><h1 class="p-name entry-title" itemprop="headline name">
    <h1 class="p-name entry-title" itemprop="headline name">
    <a href="." class="u-url">Three.jsのBuild
    </a>
</h1>
<ul itemprop="keywords" class="tags">
<li>
        <time datetime="2015-12-08T00:00:00+09:00" title="2015-12-08">2015-12-08</time>
</li>
</ul>
</h1>

<p>骨入りモデルとかやってみようかと思ったのだけど、その前にThree.jsのソースを見やすい状態で作業したい。
結合前のThree.jsを自前ビルドしながら運用する方法を調べてみる。
build.py, or how to generate a compressed three.js file
と本家に書いてある。python使うんか。gulpでやりてぇな。
全部concatしてuglifyしたらいいんじゃないか。
やってみよう。
とりあえずbowerで導入したthree.js関連を削除。
threejs.srcフォルダを作ってthree.jsソースのsrcディレクトリの中身を展開した。
gulp.task('bowerjs', function () {</p>
<pre class="code literal-block"><span class="k">var</span> <span class="n">files</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'./bower_components/jquery/dist/jquery.js'</span><span class="p">,</span>
    <span class="s1">'./bower_components/highlightjs/highlight.pack.js'</span><span class="p">,</span>
    <span class="s1">'./bower_components/stats.js/build/stats.min.js'</span><span class="p">,</span>
    <span class="s1">'./lib/**/*.js'</span><span class="p">,</span> <span class="o">//</span> <span class="o">&lt;--</span> <span class="err">中に</span><span class="n">three</span><span class="o">.</span><span class="n">jsのsrcをコピーした</span>
<span class="p">];</span>
<span class="n">gulp</span><span class="o">.</span><span class="n">src</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>
    <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="o">$.</span><span class="n">plumber</span><span class="p">({</span> <span class="n">errorHandler</span><span class="p">:</span> <span class="o">$.</span><span class="n">notify</span><span class="o">.</span><span class="n">onError</span><span class="p">(</span><span class="s1">'&lt;%= error.message %&gt;'</span><span class="p">)</span> <span class="p">}))</span>
    <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="o">$.</span><span class="n">debug</span><span class="p">({</span> <span class="n">title</span><span class="p">:</span> <span class="s1">'bowerjs files:'</span> <span class="p">}))</span>
    <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="o">$.</span><span class="n">sourcemaps</span><span class="o">.</span><span class="n">init</span><span class="p">())</span>
    <span class="o">//.</span><span class="n">pipe</span><span class="p">(</span><span class="o">$.</span><span class="n">uglify</span><span class="p">())</span>
    <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="o">$.</span><span class="n">concat</span><span class="p">(</span><span class="s1">'all.min.js'</span><span class="p">))</span>
    <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="o">$.</span><span class="n">sourcemaps</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">'./'</span><span class="p">,</span> <span class="p">{</span>
        <span class="n">sourceMappingURL</span><span class="p">:</span> <span class="n">function</span> <span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">file</span><span class="o">.</span><span class="n">relative</span> <span class="o">+</span> <span class="s1">'.map'</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}))</span>
    <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">gulp</span><span class="o">.</span><span class="n">dest</span><span class="p">(</span><span class="s1">'build/js'</span><span class="p">))</span>
    <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">browser</span><span class="o">.</span><span class="n">reload</span><span class="p">({</span> <span class="n">stream</span><span class="p">:</span> <span class="bp">true</span> <span class="p">}))</span>
<span class="p">;</span>
</pre>
<p>});</p>
<p>これで作ったall.min.jsではエラーが出てだめですね。
単にsrcをconcatするだけではだめだ。本家のドキュメントを読み始める。
/three.js/utils/build/</p>
<p>でビルドできるよって書いてあります。python関係ないみたいだ。</p>
<blockquote>
<p>npm install
node build.js --include common --include extras</p>
</blockquote>
<p>なるほどbuild.jsを見てみよう。
includeってなんだろうと調べてみると
/three.js/utils/build/includes</p>
<p>にjsonファイルがあり中にjsファイルがリストされている。
なるほど。src下を全部concatするのではなくここに書いてあるものを、書いてある順でconcatすればいいんでないか。
// 
gulp.task('threejs:build', function(){
    var common=JSON.parse(fs.readFileSync('three.js/includes/common.json')).map(function(v, i){ return 'three.js/'+v; });
    gulp.src(common)
        .pipe($.concat('three.js'))
        .pipe(gulp.dest('./lib'))
        ;
});</p>
<p>gulp.task('bowerjs', ['threejs:build'], function () {
    // 前と同じ
}
````</p>
<p>これで実行するとそれっぽいthree.jsが出てくるが、まだエラーが出る。
でエラー行に飛ぶとifdefがある。なんだこれは。</p>
<p>```glsl</p>
<h2>ifdef USE_ALPHAMAP</h2>
<pre class="code literal-block">diffuseColor.a *= texture2D( alphaMap, vUv ).g;
</pre>
<h2>endif</h2>
<p>glslだ・・・。
確かに、build.js内で拡張子がglslのファイルだけ別処理になっている。
if( file.indexOf( '.glsl') &gt;= 0 ) {</p>
<pre class="code literal-block"><span class="nv">contents</span> <span class="o">=</span> <span class="s1">'</span><span class="s">THREE.ShaderChunk[ \</span><span class="s1">''</span><span class="s"> +</span>
    <span class="nv">path</span>.<span class="k">basename</span><span class="ss">(</span> <span class="nv">file</span>, <span class="s1">'</span><span class="s">.glsl</span><span class="s1">'</span> <span class="ss">)</span> <span class="o">+</span> <span class="s1">'</span><span class="s">\</span><span class="s1">'</span> ] <span class="o">=</span><span class="s1">'</span><span class="s"> +</span>
    <span class="nv">JSON</span>.<span class="nv">stringify</span><span class="ss">(</span> <span class="nv">contents</span> <span class="ss">)</span> <span class="o">+</span> <span class="s1">'</span><span class="s">;</span><span class="se">\n</span><span class="s1">'</span><span class="c1">;</span>
</pre>
<p>}</p>
<p>ちょっとgulpのフィルタを作りますか。
three.shaderchunk.js
var through = require('through2');
var gutil = require('gulp-util');
var fs = require('fs');
var path = require('path');</p>
<p>module.exports = function () {</p>
<pre class="code literal-block"><span class="k">return</span> <span class="n">through</span><span class="o">.</span><span class="n">obj</span><span class="p">(</span><span class="n">function</span> <span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">enc</span><span class="p">,</span> <span class="n">cb</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">isStream</span><span class="p">())</span> <span class="p">{</span>
        <span class="n">cb</span><span class="p">(</span><span class="n">new</span> <span class="n">gutil</span><span class="o">.</span><span class="n">PluginError</span><span class="p">(</span><span class="s1">'three.shadechunk'</span><span class="p">,</span> <span class="s1">'Streaming not supported'</span><span class="p">));</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">extname</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">toLowerCase</span><span class="p">()</span> <span class="o">==</span> <span class="s1">'.glsl'</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">var</span> <span class="n">contents</span> <span class="o">=</span> <span class="s1">'THREE.ShaderChunk[ </span><span class="se">\'</span><span class="s1">'</span> <span class="o">+</span>
            <span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s1">'.glsl'</span><span class="p">)</span> <span class="o">+</span> <span class="s1">'</span><span class="se">\'</span><span class="s1"> ] ='</span> <span class="o">+</span>
            <span class="n">JSON</span><span class="o">.</span><span class="n">stringify</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">contents</span><span class="o">.</span><span class="n">toString</span><span class="p">())</span> <span class="o">+</span> <span class="s1">';</span><span class="se">\n</span><span class="s1">'</span><span class="p">;</span>
        <span class="n">file</span><span class="o">.</span><span class="n">contents</span> <span class="o">=</span> <span class="n">new</span> <span class="n">Buffer</span><span class="p">(</span><span class="n">contents</span><span class="p">);</span>
        <span class="n">file</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">path</span> <span class="o">+</span> <span class="s2">".js"</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">this</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>

    <span class="n">cb</span><span class="p">();</span>
<span class="p">});</span>
</pre>
<p>}</p>
<p>gulpファイルの呼び出しの方。これでthree.js/srcからthree.jsを作成できた。
あとは、sourcemapが付くようにした。
gulpfile.js
gulp.task('threejs:build', function(){
    var common=JSON.parse(fs.readFileSync('three.js/includes/common.json'))
    .map(function(v, i){ return 'three.js/'+v; });
    var extras=JSON.parse(fs.readFileSync('three.js/includes/extras.json'))
    .map(function(v, i){ return 'three.js/'+v; });
    gulp.src(common.concat(extras))
        .pipe(threeShaderchunk())
        .pipe($.concat('three.js'))
        .pipe(gulp.dest('./lib'))
        ;
});</p>
<p>FireFoxでブレイクポイントを仕掛けてステップ実行できた。
これで、Loaderの自作とかが捗るぞ。</p>

<hr>
<ul class="pager hidden-print">
<li class="previous">
        <a href="../../07/threejs_04/" rel="prev" title="Three.jsのJSONモデルフォーマット">
            Three.jsのJSONモデルフォーマット 👈
        </a>
    </li>
    <li style="flex-grow: 1">
    <li class="next">
        <a href="../../09/threejs_editor/" rel="next" title="Three.jsのEditor">
            👉 Three.jsのEditor
        </a>
    </li>
</ul></main><footer id="footer"><p>
            Powered by
            <a href="https://getnikola.com" rel="nofollow">Nikola</a>
        </p>
    </footer>
</body>
</html>
