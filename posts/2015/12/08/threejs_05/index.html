<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="generator" content="Nikola (getnikola.com)">
<meta name="viewport" content="width=device-width">
<script src="../../../../../assets/js/all-nocdn.js"></script><title>Three.jsã®Build | ä¸‰æ¬¡å…ƒæ—¥èªŒ</title>
<link href="../../../../../assets/css/code.css" rel="stylesheet" type="text/css">
<link href="../../../../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
</head>
<body>
    <h1 id="brand">
        <a href="../../../../../" title="ä¸‰æ¬¡å…ƒæ—¥èªŒ" rel="home">
            <span id="blog-title">ä¸‰æ¬¡å…ƒæ—¥èªŒ</span>
        </a>
    </h1>

    <nav id="menu"><ul>
<li><a href="../../../../../archive.html">Archives</a></li>
<li><a href="../../../../../categories/index.html">Tags</a></li>
<li><a href="../../../../../rss.xml">RSS feed</a></li>
<li><a href="../../../../../about">About</a></li>
<li><a href="../../../../../books">MemoBooks</a></li>

            
            
            
        </ul></nav><hr>
<main id="content"><h1 class="p-name entry-title" itemprop="headline name">
    <h1 class="p-name entry-title" itemprop="headline name">
    <a href="." class="u-url">Three.jsã®Build
    </a>
</h1>
<ul itemprop="keywords" class="tags">
<li>
        <time datetime="2015-12-08T00:00:00+09:00" title="2015-12-08">2015-12-08</time>
</li>
</ul>
</h1>

<p>éª¨å…¥ã‚Šãƒ¢ãƒ‡ãƒ«ã¨ã‹ã‚„ã£ã¦ã¿ã‚ˆã†ã‹ã¨æ€ã£ãŸã®ã ã‘ã©ã€ãã®å‰ã«Three.jsã®ã‚½ãƒ¼ã‚¹ã‚’è¦‹ã‚„ã™ã„çŠ¶æ…‹ã§ä½œæ¥­ã—ãŸã„ã€‚
çµåˆå‰ã®Three.jsã‚’è‡ªå‰ãƒ“ãƒ«ãƒ‰ã—ãªãŒã‚‰é‹ç”¨ã™ã‚‹æ–¹æ³•ã‚’èª¿ã¹ã¦ã¿ã‚‹ã€‚
build.py, or how to generate a compressed three.js file
ã¨æœ¬å®¶ã«æ›¸ã„ã¦ã‚ã‚‹ã€‚pythonä½¿ã†ã‚“ã‹ã€‚gulpã§ã‚„ã‚Šã¦ã‡ãªã€‚
å…¨éƒ¨concatã—ã¦uglifyã—ãŸã‚‰ã„ã„ã‚“ã˜ã‚ƒãªã„ã‹ã€‚
ã‚„ã£ã¦ã¿ã‚ˆã†ã€‚
ã¨ã‚Šã‚ãˆãšbowerã§å°å…¥ã—ãŸthree.jsé–¢é€£ã‚’å‰Šé™¤ã€‚
threejs.srcãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œã£ã¦three.jsã‚½ãƒ¼ã‚¹ã®srcãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ä¸­èº«ã‚’å±•é–‹ã—ãŸã€‚
gulp.task('bowerjs', function () {</p>
<pre class="code literal-block"><span class="k">var</span> <span class="n">files</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'./bower_components/jquery/dist/jquery.js'</span><span class="p">,</span>
    <span class="s1">'./bower_components/highlightjs/highlight.pack.js'</span><span class="p">,</span>
    <span class="s1">'./bower_components/stats.js/build/stats.min.js'</span><span class="p">,</span>
    <span class="s1">'./lib/**/*.js'</span><span class="p">,</span> <span class="o">//</span> <span class="o">&lt;--</span> <span class="err">ä¸­ã«</span><span class="n">three</span><span class="o">.</span><span class="n">jsã®srcã‚’ã‚³ãƒ”ãƒ¼ã—ãŸ</span>
<span class="p">];</span>
<span class="n">gulp</span><span class="o">.</span><span class="n">src</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>
    <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="o">$.</span><span class="n">plumber</span><span class="p">({</span> <span class="n">errorHandler</span><span class="p">:</span> <span class="o">$.</span><span class="n">notify</span><span class="o">.</span><span class="n">onError</span><span class="p">(</span><span class="s1">'&lt;%= error.message %&gt;'</span><span class="p">)</span> <span class="p">}))</span>
    <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="o">$.</span><span class="n">debug</span><span class="p">({</span> <span class="n">title</span><span class="p">:</span> <span class="s1">'bowerjs files:'</span> <span class="p">}))</span>
    <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="o">$.</span><span class="n">sourcemaps</span><span class="o">.</span><span class="n">init</span><span class="p">())</span>
    <span class="o">//.</span><span class="n">pipe</span><span class="p">(</span><span class="o">$.</span><span class="n">uglify</span><span class="p">())</span>
    <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="o">$.</span><span class="n">concat</span><span class="p">(</span><span class="s1">'all.min.js'</span><span class="p">))</span>
    <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="o">$.</span><span class="n">sourcemaps</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">'./'</span><span class="p">,</span> <span class="p">{</span>
        <span class="n">sourceMappingURL</span><span class="p">:</span> <span class="n">function</span> <span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">file</span><span class="o">.</span><span class="n">relative</span> <span class="o">+</span> <span class="s1">'.map'</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}))</span>
    <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">gulp</span><span class="o">.</span><span class="n">dest</span><span class="p">(</span><span class="s1">'build/js'</span><span class="p">))</span>
    <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">browser</span><span class="o">.</span><span class="n">reload</span><span class="p">({</span> <span class="n">stream</span><span class="p">:</span> <span class="bp">true</span> <span class="p">}))</span>
<span class="p">;</span>
</pre>
<p>});</p>
<p>ã“ã‚Œã§ä½œã£ãŸall.min.jsã§ã¯ã‚¨ãƒ©ãƒ¼ãŒå‡ºã¦ã ã‚ã§ã™ã­ã€‚
å˜ã«srcã‚’concatã™ã‚‹ã ã‘ã§ã¯ã ã‚ã ã€‚æœ¬å®¶ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’èª­ã¿å§‹ã‚ã‚‹ã€‚
/three.js/utils/build/</p>
<p>ã§ãƒ“ãƒ«ãƒ‰ã§ãã‚‹ã‚ˆã£ã¦æ›¸ã„ã¦ã‚ã‚Šã¾ã™ã€‚pythoné–¢ä¿‚ãªã„ã¿ãŸã„ã ã€‚</p>
<blockquote>
<p>npm install
node build.js --include common --include extras</p>
</blockquote>
<p>ãªã‚‹ã»ã©build.jsã‚’è¦‹ã¦ã¿ã‚ˆã†ã€‚
includeã£ã¦ãªã‚“ã ã‚ã†ã¨èª¿ã¹ã¦ã¿ã‚‹ã¨
/three.js/utils/build/includes</p>
<p>ã«jsonãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Šä¸­ã«jsãƒ•ã‚¡ã‚¤ãƒ«ãŒãƒªã‚¹ãƒˆã•ã‚Œã¦ã„ã‚‹ã€‚
ãªã‚‹ã»ã©ã€‚srcä¸‹ã‚’å…¨éƒ¨concatã™ã‚‹ã®ã§ã¯ãªãã“ã“ã«æ›¸ã„ã¦ã‚ã‚‹ã‚‚ã®ã‚’ã€æ›¸ã„ã¦ã‚ã‚‹é †ã§concatã™ã‚Œã°ã„ã„ã‚“ã§ãªã„ã‹ã€‚
// 
gulp.task('threejs:build', function(){
    var common=JSON.parse(fs.readFileSync('three.js/includes/common.json')).map(function(v, i){ return 'three.js/'+v; });
    gulp.src(common)
        .pipe($.concat('three.js'))
        .pipe(gulp.dest('./lib'))
        ;
});</p>
<p>gulp.task('bowerjs', ['threejs:build'], function () {
    // å‰ã¨åŒã˜
}
````</p>
<p>ã“ã‚Œã§å®Ÿè¡Œã™ã‚‹ã¨ãã‚Œã£ã½ã„three.jsãŒå‡ºã¦ãã‚‹ãŒã€ã¾ã ã‚¨ãƒ©ãƒ¼ãŒå‡ºã‚‹ã€‚
ã§ã‚¨ãƒ©ãƒ¼è¡Œã«é£›ã¶ã¨ifdefãŒã‚ã‚‹ã€‚ãªã‚“ã ã“ã‚Œã¯ã€‚</p>
<p>```glsl</p>
<h2>ifdef USE_ALPHAMAP</h2>
<pre class="code literal-block">diffuseColor.a *= texture2D( alphaMap, vUv ).g;
</pre>
<h2>endif</h2>
<p>glslã ãƒ»ãƒ»ãƒ»ã€‚
ç¢ºã‹ã«ã€build.jså†…ã§æ‹¡å¼µå­ãŒglslã®ãƒ•ã‚¡ã‚¤ãƒ«ã ã‘åˆ¥å‡¦ç†ã«ãªã£ã¦ã„ã‚‹ã€‚
if( file.indexOf( '.glsl') &gt;= 0 ) {</p>
<pre class="code literal-block"><span class="nv">contents</span> <span class="o">=</span> <span class="s1">'</span><span class="s">THREE.ShaderChunk[ \</span><span class="s1">''</span><span class="s"> +</span>
    <span class="nv">path</span>.<span class="k">basename</span><span class="ss">(</span> <span class="nv">file</span>, <span class="s1">'</span><span class="s">.glsl</span><span class="s1">'</span> <span class="ss">)</span> <span class="o">+</span> <span class="s1">'</span><span class="s">\</span><span class="s1">'</span> ] <span class="o">=</span><span class="s1">'</span><span class="s"> +</span>
    <span class="nv">JSON</span>.<span class="nv">stringify</span><span class="ss">(</span> <span class="nv">contents</span> <span class="ss">)</span> <span class="o">+</span> <span class="s1">'</span><span class="s">;</span><span class="se">\n</span><span class="s1">'</span><span class="c1">;</span>
</pre>
<p>}</p>
<p>ã¡ã‚‡ã£ã¨gulpã®ãƒ•ã‚£ãƒ«ã‚¿ã‚’ä½œã‚Šã¾ã™ã‹ã€‚
three.shaderchunk.js
var through = require('through2');
var gutil = require('gulp-util');
var fs = require('fs');
var path = require('path');</p>
<p>module.exports = function () {</p>
<pre class="code literal-block"><span class="k">return</span> <span class="n">through</span><span class="o">.</span><span class="n">obj</span><span class="p">(</span><span class="n">function</span> <span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">enc</span><span class="p">,</span> <span class="n">cb</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">isStream</span><span class="p">())</span> <span class="p">{</span>
        <span class="n">cb</span><span class="p">(</span><span class="n">new</span> <span class="n">gutil</span><span class="o">.</span><span class="n">PluginError</span><span class="p">(</span><span class="s1">'three.shadechunk'</span><span class="p">,</span> <span class="s1">'Streaming not supported'</span><span class="p">));</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">extname</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">toLowerCase</span><span class="p">()</span> <span class="o">==</span> <span class="s1">'.glsl'</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">var</span> <span class="n">contents</span> <span class="o">=</span> <span class="s1">'THREE.ShaderChunk[ </span><span class="se">\'</span><span class="s1">'</span> <span class="o">+</span>
            <span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s1">'.glsl'</span><span class="p">)</span> <span class="o">+</span> <span class="s1">'</span><span class="se">\'</span><span class="s1"> ] ='</span> <span class="o">+</span>
            <span class="n">JSON</span><span class="o">.</span><span class="n">stringify</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">contents</span><span class="o">.</span><span class="n">toString</span><span class="p">())</span> <span class="o">+</span> <span class="s1">';</span><span class="se">\n</span><span class="s1">'</span><span class="p">;</span>
        <span class="n">file</span><span class="o">.</span><span class="n">contents</span> <span class="o">=</span> <span class="n">new</span> <span class="n">Buffer</span><span class="p">(</span><span class="n">contents</span><span class="p">);</span>
        <span class="n">file</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">path</span> <span class="o">+</span> <span class="s2">".js"</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">this</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>

    <span class="n">cb</span><span class="p">();</span>
<span class="p">});</span>
</pre>
<p>}</p>
<p>gulpãƒ•ã‚¡ã‚¤ãƒ«ã®å‘¼ã³å‡ºã—ã®æ–¹ã€‚ã“ã‚Œã§three.js/srcã‹ã‚‰three.jsã‚’ä½œæˆã§ããŸã€‚
ã‚ã¨ã¯ã€sourcemapãŒä»˜ãã‚ˆã†ã«ã—ãŸã€‚
gulpfile.js
gulp.task('threejs:build', function(){
    var common=JSON.parse(fs.readFileSync('three.js/includes/common.json'))
    .map(function(v, i){ return 'three.js/'+v; });
    var extras=JSON.parse(fs.readFileSync('three.js/includes/extras.json'))
    .map(function(v, i){ return 'three.js/'+v; });
    gulp.src(common.concat(extras))
        .pipe(threeShaderchunk())
        .pipe($.concat('three.js'))
        .pipe(gulp.dest('./lib'))
        ;
});</p>
<p>FireFoxã§ãƒ–ãƒ¬ã‚¤ã‚¯ãƒã‚¤ãƒ³ãƒˆã‚’ä»•æ›ã‘ã¦ã‚¹ãƒ†ãƒƒãƒ—å®Ÿè¡Œã§ããŸã€‚
ã“ã‚Œã§ã€Loaderã®è‡ªä½œã¨ã‹ãŒæ—ã‚‹ãã€‚</p>

<hr>
<ul class="pager hidden-print">
<li class="previous">
        <a href="../../07/threejs_04/" rel="prev" title="Three.jsã®JSONãƒ¢ãƒ‡ãƒ«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ">
            Three.jsã®JSONãƒ¢ãƒ‡ãƒ«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ ğŸ‘ˆ
        </a>
    </li>
    <li style="flex-grow: 1">
    <li class="next">
        <a href="../../09/threejs_editor/" rel="next" title="Three.jsã®Editor">
            ğŸ‘‰ Three.jsã®Editor
        </a>
    </li>
</ul></main><footer id="footer"><p>
            Powered by
            <a href="https://getnikola.com" rel="nofollow">Nikola</a>
        </p>
    </footer>
</body>
</html>
