<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article# " lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Three.jsのBuild | 三次元日誌</title>
<link href="../../../../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<link href="https://fonts.googleapis.com/css?family=Playfair+Display:700,900" rel="stylesheet">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" hreflang="ja" href="../../../../../rss.xml">
<link rel="canonical" href="https://ousttrue.github.io/posts/2015/12/08/threejs_05/">
<!--[if lt IE 9]><script src="../../../../../assets/js/html5.js"></script><![endif]--><meta name="author" content="ousttrue">
<link rel="prev" href="../../07/threejs_04/" title="Three.jsのJSONモデルフォーマット" type="text/html">
<link rel="next" href="../../09/threejs_editor/" title="Three.jsのEditor" type="text/html">
<meta property="og:site_name" content="三次元日誌">
<meta property="og:title" content="Three.jsのBuild">
<meta property="og:url" content="https://ousttrue.github.io/posts/2015/12/08/threejs_05/">
<meta property="og:description" content="骨入りモデルとかやってみようかと思ったのだけど、その前にThree.jsのソースを見やすい状態で作業したい。
結合前のThree.jsを自前ビルドしながら運用する方法を調べてみる。
build.py, or how to generate a compressed three.js file
と本家に書いてある。python使うんか。gulpでやりてぇな。
全部concatしてuglifyしたらい">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2015-12-08T00:00:00+09:00">
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">本文を読み飛ばす</a>

<!-- Header and menu bar -->
<div class="container">
      <header class="blog-header py-3"><div class="row nbb-header align-items-center">
          <div class="col-md-3 col-xs-2 col-sm-2" style="width: auto;">
            <button class="navbar-toggler navbar-light bg-light nbb-navbar-toggler" type="button" data-toggle="collapse" data-target=".bs-nav-collapsible" aria-controls="bs-navbar" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse bs-nav-collapsible bootblog4-search-form-holder">
                
            </div>
        </div>
          <div class="col-md-6 col-xs-10 col-sm-10 bootblog4-brand" style="width: auto;">
            <a class="navbar-brand blog-header-logo text-dark" href="../../../../../">

            <span id="blog-title">三次元日誌</span>
        </a>
          </div>
            <div class="col-md-3 justify-content-end align-items-center bs-nav-collapsible collapse flex-collapse bootblog4-right-nav">
            <nav class="navbar navbar-light bg-white"><ul class="navbar-nav bootblog4-right-nav">
<li class="nav-item">
    <a href="index.md" id="sourcelink" class="nav-link">ソース</a>
    </li>


                    
            </ul></nav>
</div>
    </div>
</header><nav class="navbar navbar-expand-md navbar-light bg-white static-top"><div class="collapse navbar-collapse bs-nav-collapsible" id="bs-navbar">
            <ul class="navbar-nav nav-fill d-flex w-100">
<li class="nav-item">
<a href="../../../../../books" class="nav-link">MemoBooks</a>
                </li>
<li class="nav-item">
<a href="../../../../../archive.html" class="nav-link">Archives</a>
                </li>
<li class="nav-item">
<a href="../../../../../categories/index.html" class="nav-link">Tags</a>
                </li>
<li class="nav-item">
<a href="../../../../../rss.xml" class="nav-link">RSS feed</a>
                </li>
<li class="nav-item">
<a href="../../../../../about" class="nav-link">About</a>

                
            </li>
</ul>
</div>
<!-- /.navbar-collapse -->
</nav>
</div>

<div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        
        
        
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title" itemprop="headline name"><a href="." class="u-url">Three.jsのBuild</a></h1>

        <div class="metadata">
            <p class="byline author vcard p-author h-card"><span class="byline-name fn p-name" itemprop="author">
                    ousttrue
            </span></p>
            <p class="dateline">
            <a href="." rel="bookmark">
            <time class="published dt-published" datetime="2015-12-08T00:00:00+09:00" itemprop="datePublished" title="2015-12-08 00:00">2015-12-08 00:00</time></a>
            </p>
            
        <p class="sourceline"><a href="index.md" class="sourcelink">ソース</a></p>

        </div>
        

    </header><div class="e-content entry-content" itemprop="articleBody text">
    <div>
<p>骨入りモデルとかやってみようかと思ったのだけど、その前にThree.jsのソースを見やすい状態で作業したい。
結合前のThree.jsを自前ビルドしながら運用する方法を調べてみる。
build.py, or how to generate a compressed three.js file
と本家に書いてある。python使うんか。gulpでやりてぇな。
全部concatしてuglifyしたらいいんじゃないか。
やってみよう。
とりあえずbowerで導入したthree.js関連を削除。
threejs.srcフォルダを作ってthree.jsソースのsrcディレクトリの中身を展開した。
gulp.task('bowerjs', function () {</p>
<pre class="code literal-block"><span></span><span class="x">var files = [</span>
<span class="x">    './bower_components/jquery/dist/jquery.js',</span>
<span class="x">    './bower_components/highlightjs/highlight.pack.js',</span>
<span class="x">    './bower_components/stats.js/build/stats.min.js',</span>
<span class="x">    './lib/**/*.js', // &lt;-- 中にthree.jsのsrcをコピーした</span>
<span class="x">];</span>
<span class="x">gulp.src(files)</span>
<span class="x">    .pipe($.plumber({ errorHandler: $.notify.onError('</span><span class="cp">&lt;%=</span> <span class="n">error</span><span class="o">.</span><span class="n">message</span> <span class="cp">%&gt;</span><span class="x">') }))</span>
<span class="x">    .pipe($.debug({ title: 'bowerjs files:' }))</span>
<span class="x">    .pipe($.sourcemaps.init())</span>
<span class="x">    //.pipe($.uglify())</span>
<span class="x">    .pipe($.concat('all.min.js'))</span>
<span class="x">    .pipe($.sourcemaps.write('./', {</span>
<span class="x">        sourceMappingURL: function (file) {</span>
<span class="x">            return file.relative + '.map';</span>
<span class="x">        }</span>
<span class="x">    }))</span>
<span class="x">    .pipe(gulp.dest('build/js'))</span>
<span class="x">    .pipe(browser.reload({ stream: true }))</span>
<span class="x">;</span>
</pre>

<p>});</p>
<p>これで作ったall.min.jsではエラーが出てだめですね。
単にsrcをconcatするだけではだめだ。本家のドキュメントを読み始める。
/three.js/utils/build/</p>
<p>でビルドできるよって書いてあります。python関係ないみたいだ。</p>
<blockquote>
<p>npm install
node build.js --include common --include extras</p>
</blockquote>
<p>なるほどbuild.jsを見てみよう。
includeってなんだろうと調べてみると
/three.js/utils/build/includes</p>
<p>にjsonファイルがあり中にjsファイルがリストされている。
なるほど。src下を全部concatするのではなくここに書いてあるものを、書いてある順でconcatすればいいんでないか。
// 
gulp.task('threejs:build', function(){
    var common=JSON.parse(fs.readFileSync('three.js/includes/common.json')).map(function(v, i){ return 'three.js/'+v; });
    gulp.src(common)
        .pipe($.concat('three.js'))
        .pipe(gulp.dest('./lib'))
        ;
});</p>
<p>gulp.task('bowerjs', ['threejs:build'], function () {
    // 前と同じ
}
````</p>
<p>これで実行するとそれっぽいthree.jsが出てくるが、まだエラーが出る。
でエラー行に飛ぶとifdefがある。なんだこれは。</p>
<p>```glsl</p>
<h2>ifdef USE_ALPHAMAP</h2>
<pre class="code literal-block"><span></span>diffuseColor.a *= texture2D( alphaMap, vUv ).g;
</pre>

<h2>endif</h2>
<p>glslだ・・・。
確かに、build.js内で拡張子がglslのファイルだけ別処理になっている。
if( file.indexOf( '.glsl') &gt;= 0 ) {</p>
<pre class="code literal-block"><span></span>contents = 'THREE.ShaderChunk[ \'' +
    path.basename( file, '.glsl' ) + '\' ] =' +
    JSON.stringify( contents ) + ';\n';
</pre>

<p>}</p>
<p>ちょっとgulpのフィルタを作りますか。
three.shaderchunk.js
var through = require('through2');
var gutil = require('gulp-util');
var fs = require('fs');
var path = require('path');</p>
<p>module.exports = function () {</p>
<pre class="code literal-block"><span></span>return through.obj(function (file, enc, cb) {

    if (file.isStream()) {
        cb(new gutil.PluginError('three.shadechunk', 'Streaming not supported'));
        return;
    }

    if (path.extname(file.path).toLowerCase() == '.glsl') {
        var contents = 'THREE.ShaderChunk[ \'' +
            path.basename(file.path, '.glsl') + '\' ] =' +
            JSON.stringify(file.contents.toString()) + ';\n';
        file.contents = new Buffer(contents);
        file.path = file.path + ".js";
    }

    this.push(file);

    cb();
});
</pre>

<p>}</p>
<p>gulpファイルの呼び出しの方。これでthree.js/srcからthree.jsを作成できた。
あとは、sourcemapが付くようにした。
gulpfile.js
gulp.task('threejs:build', function(){
    var common=JSON.parse(fs.readFileSync('three.js/includes/common.json'))
    .map(function(v, i){ return 'three.js/'+v; });
    var extras=JSON.parse(fs.readFileSync('three.js/includes/extras.json'))
    .map(function(v, i){ return 'three.js/'+v; });
    gulp.src(common.concat(extras))
        .pipe(threeShaderchunk())
        .pipe($.concat('three.js'))
        .pipe(gulp.dest('./lib'))
        ;
});</p>
<p>FireFoxでブレイクポイントを仕掛けてステップ実行できた。
これで、Loaderの自作とかが捗るぞ。</p>
</div>
    </div>
    <aside class="postpromonav"><nav><ul class="pager hidden-print">
<li class="previous">
                <a href="../../07/threejs_04/" rel="prev" title="Three.jsのJSONモデルフォーマット">一つ前の記事</a>
            </li>
            <li class="next">
                <a href="../../09/threejs_editor/" rel="next" title="Three.jsのEditor">次の記事</a>
            </li>
        </ul></nav></aside></article><!--End of body content--><footer id="footer">
            Contents © 2021         <a href="mailto:ousttrue@gmail.com">ousttrue</a> - Powered by         <a href="https://getnikola.com" rel="nofollow">Nikola</a>         
            
            
        </footer>
</div>
</div>


        <script src="../../../../../assets/js/all-nocdn.js"></script><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element){var i=element.getElementsByTagName('img')[0];return i===undefined?'':i.alt;}});
    </script>
</body>
</html>
