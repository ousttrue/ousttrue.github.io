<!DOCTYPE html>
<html><body>
    <h1 id="brand">
        <a href="../../../../../" title="三次元日誌" rel="home">
            <span id="blog-title">三次元日誌</span>
        </a>
    </h1>
    <hr>
<main id="content"><h1 class="p-name entry-title" itemprop="headline name">
    <a href="." class="u-url">Three.jsにマウスによる視点操作を入れる</a>
</h1>
<div>
<p>source
今回は、TrackballControlsを導入します。
TrackballControlsはThree.jsのライブラリ内に含まれるのではなくexamples扱いなので、
直接コードを入手。
使い方は、TrackballControlsのソースを見ると
以下のようにするらしい。
controls = new THREE.TrackballControls( camera );</p>
<p>controls.rotateSpeed = 1.0;
controls.zoomSpeed = 1.2;
controls.panSpeed = 0.8;</p>
<p>controls.noZoom = false;
controls.noPan = false;</p>
<p>controls.staticMoving = true;
controls.dynamicDampingFactor = 0.3;</p>
<p>controls.keys = [ 65, 83, 68 ];</p>
<p>controls.addEventListener( 'change', render );</p>
<p>もうひとつ更新用に以下のコードも必要。
function animate() {
    requestAnimationFrame( animate );
    controls.update();
}</p>
<p>やってみよう。
ベースのレンダリングシーン
シーンに適当にキューブを描画するコード。
前回の記事をほぼ流用だけどいくつか変更点がある。</p>
<p>namespaceでかこって名前衝突から防衛
CreateCameraを独立
キューブがアニメーションする部分をオミット</p>
<p>threejs_02.ts
/// <reference path="../../../../typings/tsd.d.ts"></reference></p>
<p>namespace Renderer02 {</p>
<pre class="code literal-block"><span></span><span class="kr">class</span> <span class="nx">Renderer</span> <span class="p">{</span>
    <span class="nx">$container</span>: <span class="kt">JQuery</span><span class="p">;</span>
    <span class="nx">renderer</span>: <span class="kt">THREE.Renderer</span><span class="p">;</span>

    <span class="nx">scene</span>: <span class="kt">THREE.Scene</span><span class="p">;</span>
    <span class="nx">camera</span>: <span class="kt">THREE.Camera</span><span class="p">;</span>
    <span class="nx">mesh</span>: <span class="kt">THREE.Mesh</span><span class="p">;</span>

    <span class="nx">CreateRenderer</span><span class="p">(</span><span class="nx">$container</span>: <span class="kt">JQuery</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">$container</span> <span class="o">=</span> <span class="nx">$container</span><span class="p">;</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">renderer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">WebGLRenderer</span><span class="p">();</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">renderer</span><span class="p">.</span><span class="nx">setSize</span><span class="p">(</span><span class="nx">$container</span><span class="p">.</span><span class="nx">width</span><span class="p">(),</span> <span class="nx">$container</span><span class="p">.</span><span class="nx">height</span><span class="p">());</span>
        <span class="nx">$container</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">renderer</span><span class="p">.</span><span class="nx">domElement</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nx">CreateCamera() {</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">camera</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">PerspectiveCamera</span><span class="p">(</span><span class="mi">75</span>
            <span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">$container</span><span class="p">.</span><span class="nx">width</span><span class="p">()</span> <span class="o">/</span> <span class="k">this</span><span class="p">.</span><span class="nx">$container</span><span class="p">.</span><span class="nx">height</span><span class="p">()</span>
            <span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mi">1000</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">camera</span><span class="p">.</span><span class="nx">position</span><span class="p">.</span><span class="nx">z</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nx">CreateScene() {</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">scene</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Scene</span><span class="p">();</span>

        <span class="kd">var</span> <span class="nx">geometry</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">BoxGeometry</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">material</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">MeshBasicMaterial</span><span class="p">({</span> <span class="nx">color</span>: <span class="kt">0x00ff00</span> <span class="p">});</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">mesh</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Mesh</span><span class="p">(</span><span class="nx">geometry</span><span class="p">,</span> <span class="nx">material</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">scene</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">mesh</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nx">Render() {</span>
        <span class="c1">// render</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">renderer</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">scene</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">camera</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">renderer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Renderer</span><span class="p">();</span>
<span class="kr">export</span> <span class="kd">function</span> <span class="nx">initialize</span><span class="p">(</span><span class="nx">$container</span>: <span class="kt">JQuery</span><span class="p">)</span> <span class="p">{</span>

    <span class="nx">renderer</span><span class="p">.</span><span class="nx">CreateRenderer</span><span class="p">(</span><span class="nx">$container</span><span class="p">);</span>
    <span class="nx">renderer</span><span class="p">.</span><span class="nx">CreateCamera</span><span class="p">();</span>
    <span class="nx">renderer</span><span class="p">.</span><span class="nx">CreateScene</span><span class="p">();</span>

    <span class="nx">renderer</span><span class="p">.</span><span class="nx">Render</span><span class="p">();</span>
<span class="p">}</span>
</pre>

<p>}</p>
<p>$(() =&gt; {
    var $container = $('div#renderer');
    Renderer02.initialize($container);
});</p>
<p>TypeScript定義を追加する
まず、TrackballControlsの型定義を追加する。
declare module THREE {
    export class TrackballControls
    {
        constructor(camera: THREE.Camera);
        rotateSpeed: number;
        zoomSpeed: number;
        panSpeed: number;
        noZoom: boolean;
        noPan: boolean;
        staticMoving: boolean;
        dynamicDampingFactor: number;
        keys: number[];
        addEventListener(event: string, callback: Function):void;
        update():void;
    }
}</p>
<p>TrackballControlsを初期化
// Rendererのメソッドを修正
    CreateCamera() {
        this.camera = new THREE.PerspectiveCamera(75
            , this.$container.width() / this.$container.height()
            , 0.1, 1000);
        this.camera.position.z = 5;</p>
<pre class="code literal-block"><span></span>    // 以下を追加
    this.controls = new THREE.TrackballControls(this.camera);

    this.controls.rotateSpeed = 1.0;
    this.controls.zoomSpeed = 1.2;
    this.controls.panSpeed = 0.8;

    this.controls.noZoom = false;
    this.controls.noPan = false;

    this.controls.staticMoving = true;
    this.controls.dynamicDampingFactor = 0.3;

    this.controls.keys = [65, 83, 68];

    // trackballに変化があった時だけ描画を呼ぶ
    this.controls.addEventListener('change', this.Render.bind(this));
}
</pre>

<p>// Rendererのメソッドを追加
    Animate() {
        requestAnimationFrame(this.Animate.bind(this));
        this.controls.update();
    }</p>
<p>// Animate呼び出しを追加
    export function initialize($container: JQuery) {</p>
<pre class="code literal-block"><span></span>    renderer.CreateRenderer($container);
    renderer.CreateCamera();
    renderer.CreateScene();

    renderer.Render();
    renderer.Animate(); // 追加
}
</pre>

<p>動いたがWindow全体のマウスイベントが取られていてこれじゃない。
canvasの親になったdivをマウスイベントの対象にしたい。
div#rendererを操作対象にする
TrackballControls.jsを見てたら
THREE.TrackballControls = function ( object, domElement ) {
}</p>
<p>という記述を発見。第２引数にhtmlエレメントを渡せるらしい。
定義を修正。
// 定義
    constructor(camera: THREE.Camera, element?: Element);</p>
<p>// 呼び出し
   this.controls = new THREE.TrackballControls(this.camera, this.$container[0]);</p>
<p>想定した動きになった。
マウスカーソルを変えてみる
cssの話だけれど。</p>
<div id="renderer" style="width:300px;height:200px;cursor:pointer;"></div>

<pre class="code literal-block"><span></span><span class="o">$</span><span class="nt">container</span>
    <span class="p">.</span><span class="nc">mousedown</span><span class="o">(</span><span class="nt">function</span><span class="o">(</span><span class="nt">event</span><span class="o">)</span> <span class="p">{</span>
        <span class="err">switch</span> <span class="err">(event.button)</span> <span class="err">{</span>
            <span class="err">case</span> <span class="err">0:</span>
                <span class="err">$(this).css({</span> <span class="k">cursor</span><span class="p">:</span> <span class="s1">'pointer'</span> <span class="p">}</span><span class="o">);</span>
                <span class="nt">break</span><span class="o">;</span>

            <span class="nt">case</span> <span class="nt">1</span><span class="o">:</span>
                <span class="o">$(</span><span class="nt">this</span><span class="o">)</span><span class="p">.</span><span class="nc">css</span><span class="o">(</span><span class="p">{</span> <span class="k">cursor</span><span class="p">:</span> <span class="s1">'n-resize'</span> <span class="p">}</span><span class="o">);</span>
                <span class="nt">break</span><span class="o">;</span>

            <span class="nt">case</span> <span class="nt">2</span><span class="o">:</span>
                <span class="o">$(</span><span class="nt">this</span><span class="o">)</span><span class="p">.</span><span class="nc">css</span><span class="o">(</span><span class="p">{</span> <span class="k">cursor</span><span class="p">:</span> <span class="s1">'move'</span> <span class="p">}</span><span class="o">);</span>
                <span class="nt">break</span><span class="o">;</span>
        <span class="err">}</span>
    <span class="err">}</span><span class="o">)</span>
    <span class="p">.</span><span class="nc">mouseup</span><span class="o">(</span><span class="nt">function</span><span class="o">(</span><span class="nt">event</span><span class="o">)</span><span class="p">{</span>
        <span class="err">$(this).css({</span><span class="k">cursor</span><span class="p">:</span> <span class="s1">'pointer'</span><span class="p">}</span><span class="o">);</span>
    <span class="err">}</span><span class="o">)</span>
<span class="o">;</span>
</pre>
</div>
    </main>
</body></html>
