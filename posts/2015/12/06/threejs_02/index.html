<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="generator" content="Nikola (getnikola.com)">
<meta name="viewport" content="width=device-width">
<script src="../../../../../assets/js/all-nocdn.js"></script><title>Three.jsにマウスによる視点操作を入れる | 三次元日誌</title>
<link href="../../../../../assets/css/code.css" rel="stylesheet" type="text/css">
<link href="../../../../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
</head>
<body>
    <h1 id="brand">
        <a href="../../../../../" title="三次元日誌" rel="home">
            <span id="blog-title">三次元日誌</span>
        </a>
    </h1>

    <nav id="menu"><ul>
<li><a href="../../../../../archive.html">Archives</a></li>
<li><a href="../../../../../categories/index.html">Tags</a></li>
<li><a href="../../../../../rss.xml">RSS feed</a></li>
<li><a href="../../../../../about">About</a></li>
<li><a href="../../../../../books">MemoBooks</a></li>

            
            
            
        </ul></nav><hr>
<main id="content"><h1 class="p-name entry-title" itemprop="headline name">
    <h1 class="p-name entry-title" itemprop="headline name">
    <a href="." class="u-url">Three.jsにマウスによる視点操作を入れる
    </a>
</h1>
<ul itemprop="keywords" class="tags">
<li>
        <time datetime="2015-12-06T00:00:00+09:00" title="2015-12-06">2015-12-06</time>
</li>
</ul>
</h1>

<p>source
今回は、TrackballControlsを導入します。
TrackballControlsはThree.jsのライブラリ内に含まれるのではなくexamples扱いなので、
直接コードを入手。
使い方は、TrackballControlsのソースを見ると
以下のようにするらしい。
controls = new THREE.TrackballControls( camera );</p>
<p>controls.rotateSpeed = 1.0;
controls.zoomSpeed = 1.2;
controls.panSpeed = 0.8;</p>
<p>controls.noZoom = false;
controls.noPan = false;</p>
<p>controls.staticMoving = true;
controls.dynamicDampingFactor = 0.3;</p>
<p>controls.keys = [ 65, 83, 68 ];</p>
<p>controls.addEventListener( 'change', render );</p>
<p>もうひとつ更新用に以下のコードも必要。
function animate() {
    requestAnimationFrame( animate );
    controls.update();
}</p>
<p>やってみよう。
ベースのレンダリングシーン
シーンに適当にキューブを描画するコード。
前回の記事をほぼ流用だけどいくつか変更点がある。</p>
<p>namespaceでかこって名前衝突から防衛
CreateCameraを独立
キューブがアニメーションする部分をオミット</p>
<p>threejs_02.ts
/// <reference path="../../../../typings/tsd.d.ts"></reference></p>
<p>namespace Renderer02 {</p>
<pre class="code literal-block"><span class="k">class</span> <span class="n">Renderer</span> <span class="p">{</span>
    <span class="o">$</span><span class="n">container</span><span class="p">:</span> <span class="n">JQuery</span><span class="p">;</span>
    <span class="n">renderer</span><span class="p">:</span> <span class="n">THREE</span><span class="o">.</span><span class="n">Renderer</span><span class="p">;</span>

    <span class="n">scene</span><span class="p">:</span> <span class="n">THREE</span><span class="o">.</span><span class="n">Scene</span><span class="p">;</span>
    <span class="n">camera</span><span class="p">:</span> <span class="n">THREE</span><span class="o">.</span><span class="n">Camera</span><span class="p">;</span>
    <span class="n">mesh</span><span class="p">:</span> <span class="n">THREE</span><span class="o">.</span><span class="n">Mesh</span><span class="p">;</span>

    <span class="n">CreateRenderer</span><span class="p">(</span><span class="o">$</span><span class="n">container</span><span class="p">:</span> <span class="n">JQuery</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">this</span><span class="o">.$</span><span class="n">container</span> <span class="o">=</span> <span class="o">$</span><span class="n">container</span><span class="p">;</span>

        <span class="n">this</span><span class="o">.</span><span class="n">renderer</span> <span class="o">=</span> <span class="n">new</span> <span class="n">THREE</span><span class="o">.</span><span class="n">WebGLRenderer</span><span class="p">();</span>
        <span class="n">this</span><span class="o">.</span><span class="n">renderer</span><span class="o">.</span><span class="n">setSize</span><span class="p">(</span><span class="o">$</span><span class="n">container</span><span class="o">.</span><span class="n">width</span><span class="p">(),</span> <span class="o">$</span><span class="n">container</span><span class="o">.</span><span class="n">height</span><span class="p">());</span>
        <span class="o">$</span><span class="n">container</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">this</span><span class="o">.</span><span class="n">renderer</span><span class="o">.</span><span class="n">domElement</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">CreateCamera</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">this</span><span class="o">.</span><span class="n">camera</span> <span class="o">=</span> <span class="n">new</span> <span class="n">THREE</span><span class="o">.</span><span class="n">PerspectiveCamera</span><span class="p">(</span><span class="mi">75</span>
            <span class="p">,</span> <span class="n">this</span><span class="o">.$</span><span class="n">container</span><span class="o">.</span><span class="n">width</span><span class="p">()</span> <span class="o">/</span> <span class="n">this</span><span class="o">.$</span><span class="n">container</span><span class="o">.</span><span class="n">height</span><span class="p">()</span>
            <span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mi">1000</span><span class="p">);</span>
        <span class="n">this</span><span class="o">.</span><span class="n">camera</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">CreateScene</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">this</span><span class="o">.</span><span class="n">scene</span> <span class="o">=</span> <span class="n">new</span> <span class="n">THREE</span><span class="o">.</span><span class="n">Scene</span><span class="p">();</span>

        <span class="k">var</span> <span class="n">geometry</span> <span class="o">=</span> <span class="n">new</span> <span class="n">THREE</span><span class="o">.</span><span class="n">BoxGeometry</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
        <span class="k">var</span> <span class="n">material</span> <span class="o">=</span> <span class="n">new</span> <span class="n">THREE</span><span class="o">.</span><span class="n">MeshBasicMaterial</span><span class="p">({</span> <span class="n">color</span><span class="p">:</span> <span class="mh">0x00ff00</span> <span class="p">});</span>
        <span class="n">this</span><span class="o">.</span><span class="n">mesh</span> <span class="o">=</span> <span class="n">new</span> <span class="n">THREE</span><span class="o">.</span><span class="n">Mesh</span><span class="p">(</span><span class="n">geometry</span><span class="p">,</span> <span class="n">material</span><span class="p">);</span>
        <span class="n">this</span><span class="o">.</span><span class="n">scene</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">this</span><span class="o">.</span><span class="n">mesh</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">Render</span><span class="p">()</span> <span class="p">{</span>
        <span class="o">//</span> <span class="n">render</span>
        <span class="n">this</span><span class="o">.</span><span class="n">renderer</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">this</span><span class="o">.</span><span class="n">scene</span><span class="p">,</span> <span class="n">this</span><span class="o">.</span><span class="n">camera</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">var</span> <span class="n">renderer</span> <span class="o">=</span> <span class="n">new</span> <span class="n">Renderer</span><span class="p">();</span>
<span class="k">export</span> <span class="n">function</span> <span class="n">initialize</span><span class="p">(</span><span class="o">$</span><span class="n">container</span><span class="p">:</span> <span class="n">JQuery</span><span class="p">)</span> <span class="p">{</span>

    <span class="n">renderer</span><span class="o">.</span><span class="n">CreateRenderer</span><span class="p">(</span><span class="o">$</span><span class="n">container</span><span class="p">);</span>
    <span class="n">renderer</span><span class="o">.</span><span class="n">CreateCamera</span><span class="p">();</span>
    <span class="n">renderer</span><span class="o">.</span><span class="n">CreateScene</span><span class="p">();</span>

    <span class="n">renderer</span><span class="o">.</span><span class="n">Render</span><span class="p">();</span>
<span class="p">}</span>
</pre>
<p>}</p>
<p>$(() =&gt; {
    var $container = $('div#renderer');
    Renderer02.initialize($container);
});</p>
<p>TypeScript定義を追加する
まず、TrackballControlsの型定義を追加する。
declare module THREE {
    export class TrackballControls
    {
        constructor(camera: THREE.Camera);
        rotateSpeed: number;
        zoomSpeed: number;
        panSpeed: number;
        noZoom: boolean;
        noPan: boolean;
        staticMoving: boolean;
        dynamicDampingFactor: number;
        keys: number[];
        addEventListener(event: string, callback: Function):void;
        update():void;
    }
}</p>
<p>TrackballControlsを初期化
// Rendererのメソッドを修正
    CreateCamera() {
        this.camera = new THREE.PerspectiveCamera(75
            , this.$container.width() / this.$container.height()
            , 0.1, 1000);
        this.camera.position.z = 5;</p>
<pre class="code literal-block">    <span class="c1">// 以下を追加</span>
    <span class="n">this</span><span class="err">.</span><span class="n">controls</span> <span class="o">=</span> <span class="n">new</span> <span class="n">THREE</span><span class="err">.</span><span class="n">TrackballControls</span><span class="p">(</span><span class="n">this</span><span class="err">.</span><span class="nb">camera</span><span class="p">);</span>

    <span class="n">this</span><span class="err">.</span><span class="n">controls</span><span class="err">.</span><span class="n">rotateSpeed</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">;</span>
    <span class="n">this</span><span class="err">.</span><span class="n">controls</span><span class="err">.</span><span class="n">zoomSpeed</span> <span class="o">=</span> <span class="mf">1.2</span><span class="p">;</span>
    <span class="n">this</span><span class="err">.</span><span class="n">controls</span><span class="err">.</span><span class="n">panSpeed</span> <span class="o">=</span> <span class="mf">0.8</span><span class="p">;</span>

    <span class="n">this</span><span class="err">.</span><span class="n">controls</span><span class="err">.</span><span class="n">noZoom</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span>
    <span class="n">this</span><span class="err">.</span><span class="n">controls</span><span class="err">.</span><span class="n">noPan</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span>

    <span class="n">this</span><span class="err">.</span><span class="n">controls</span><span class="err">.</span><span class="n">staticMoving</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>
    <span class="n">this</span><span class="err">.</span><span class="n">controls</span><span class="err">.</span><span class="n">dynamicDampingFactor</span> <span class="o">=</span> <span class="mf">0.3</span><span class="p">;</span>

    <span class="n">this</span><span class="err">.</span><span class="n">controls</span><span class="err">.</span><span class="n">keys</span> <span class="o">=</span> <span class="p">[</span><span class="mi">65</span><span class="p">,</span> <span class="mi">83</span><span class="p">,</span> <span class="mi">68</span><span class="p">];</span>

    <span class="c1">// trackballに変化があった時だけ描画を呼ぶ</span>
    <span class="n">this</span><span class="err">.</span><span class="n">controls</span><span class="err">.</span><span class="n">addEventListener</span><span class="p">(</span><span class="err">'</span><span class="n">change</span><span class="err">'</span><span class="p">,</span> <span class="n">this</span><span class="err">.</span><span class="n">Render</span><span class="err">.</span><span class="n">bind</span><span class="p">(</span><span class="n">this</span><span class="p">));</span>
<span class="p">}</span>
</pre>
<p>// Rendererのメソッドを追加
    Animate() {
        requestAnimationFrame(this.Animate.bind(this));
        this.controls.update();
    }</p>
<p>// Animate呼び出しを追加
    export function initialize($container: JQuery) {</p>
<pre class="code literal-block">    renderer.CreateRenderer($container);
    renderer.CreateCamera();
    renderer.CreateScene();

    renderer.Render();
    renderer.Animate(); // 追加
}
</pre>
<p>動いたがWindow全体のマウスイベントが取られていてこれじゃない。
canvasの親になったdivをマウスイベントの対象にしたい。
div#rendererを操作対象にする
TrackballControls.jsを見てたら
THREE.TrackballControls = function ( object, domElement ) {
}</p>
<p>という記述を発見。第２引数にhtmlエレメントを渡せるらしい。
定義を修正。
// 定義
    constructor(camera: THREE.Camera, element?: Element);</p>
<p>// 呼び出し
   this.controls = new THREE.TrackballControls(this.camera, this.$container[0]);</p>
<p>想定した動きになった。
マウスカーソルを変えてみる
cssの話だけれど。</p>
<div id="renderer" style="width:300px;height:200px;cursor:pointer;"></div>

<pre class="code literal-block"><span class="o">$</span><span class="nt">container</span>
    <span class="p">.</span><span class="nc">mousedown</span><span class="o">(</span><span class="nt">function</span><span class="o">(</span><span class="nt">event</span><span class="o">)</span> <span class="p">{</span>
        <span class="err">switch</span> <span class="err">(event.button)</span> <span class="err">{</span>
            <span class="err">case</span> <span class="err">0:</span>
                <span class="err">$(this).css({</span> <span class="k">cursor</span><span class="p">:</span> <span class="s1">'pointer'</span> <span class="p">}</span><span class="o">);</span>
                <span class="nt">break</span><span class="o">;</span>

            <span class="nt">case</span> <span class="nt">1</span><span class="o">:</span>
                <span class="o">$(</span><span class="nt">this</span><span class="o">)</span><span class="p">.</span><span class="nc">css</span><span class="o">(</span><span class="p">{</span> <span class="k">cursor</span><span class="p">:</span> <span class="s1">'n-resize'</span> <span class="p">}</span><span class="o">);</span>
                <span class="nt">break</span><span class="o">;</span>

            <span class="nt">case</span> <span class="nt">2</span><span class="o">:</span>
                <span class="o">$(</span><span class="nt">this</span><span class="o">)</span><span class="p">.</span><span class="nc">css</span><span class="o">(</span><span class="p">{</span> <span class="k">cursor</span><span class="p">:</span> <span class="s1">'move'</span> <span class="p">}</span><span class="o">);</span>
                <span class="nt">break</span><span class="o">;</span>
        <span class="err">}</span>
    <span class="err">}</span><span class="o">)</span>
    <span class="p">.</span><span class="nc">mouseup</span><span class="o">(</span><span class="nt">function</span><span class="o">(</span><span class="nt">event</span><span class="o">)</span><span class="p">{</span>
        <span class="err">$(this).css({</span><span class="k">cursor</span><span class="p">:</span> <span class="s1">'pointer'</span><span class="p">}</span><span class="o">);</span>
    <span class="err">}</span><span class="o">)</span>
<span class="o">;</span>
</pre>

<hr>
<ul class="pager hidden-print">
<li class="previous">
        <a href="../threejs_03/" rel="prev" title="グリッドと軸と光源とFPS表示を入れる">
            グリッドと軸と光源とFPS表示を入れる 👈
        </a>
    </li>
    <li style="flex-grow: 1">
    <li class="next">
        <a href="../threejs_01/" rel="next" title="TypeScriptでThree.jsことはじめ">
            👉 TypeScriptでThree.jsことはじめ
        </a>
    </li>
</ul></main><footer id="footer"><p>
            Powered by
            <a href="https://getnikola.com" rel="nofollow">Nikola</a>
        </p>
    </footer>
</body>
</html>
