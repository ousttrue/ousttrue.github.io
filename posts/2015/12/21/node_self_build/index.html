<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="generator" content="Nikola (getnikola.com)">
<meta name="viewport" content="width=device-width">
<script src="../../../../../assets/js/all-nocdn.js"></script><title>node.js(Windowsç‰ˆ)ã‚’è‡ªå‰ãƒ“ãƒ«ãƒ‰ã™ã‚‹ | ä¸‰æ¬¡å…ƒæ—¥èªŒ</title>
<link href="../../../../../assets/css/code.css" rel="stylesheet" type="text/css">
<link href="../../../../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
</head>
<body>
    <h1 id="brand">
        <a href="../../../../../" title="ä¸‰æ¬¡å…ƒæ—¥èªŒ" rel="home">
            <span id="blog-title">ä¸‰æ¬¡å…ƒæ—¥èªŒ</span>
        </a>
    </h1>

    <nav id="menu"><ul>
<li><a href="../../../../../archive.html">Archives</a></li>
<li><a href="../../../../../categories/index.html">Tags</a></li>
<li><a href="../../../../../rss.xml">RSS feed</a></li>
<li><a href="../../../../../about">About</a></li>
<li><a href="../../../../../books">MemoBooks</a></li>

            
            
            
        </ul></nav><hr>
<main id="content"><h1 class="p-name entry-title" itemprop="headline name">
    <h1 class="p-name entry-title" itemprop="headline name">
    <a href="." class="u-url">node.js(Windowsç‰ˆ)ã‚’è‡ªå‰ãƒ“ãƒ«ãƒ‰ã™ã‚‹
    </a>
</h1>
<ul itemprop="keywords" class="tags">
<li>
        <time datetime="2015-12-21T00:00:00+09:00" title="2015-12-21">2015-12-21</time>
</li>
</ul>
</h1>

<p>è¬ã®ã‚¯ãƒ©ãƒƒã‚·ãƒ¥(FFIã§ãƒã‚¤ãƒ†ã‚£ãƒ–ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ãŒã‚¢ã‚¯ã‚»ã‚¹é•åã§æ­»ã¬)ã‚’è¿½è·¡ã™ã‚‹ãŸã‚ã€
VCã®ãƒ‡ãƒãƒƒã‚¬ã‚’ã‚¢ã‚¿ãƒƒãƒã™ã‚‹ã¹ãè‡ªå‰ãƒ“ãƒ«ãƒ‰ã™ã‚‹ã€‚
node-v5.3.0.tar.xz</p>
<p>7zipã§è§£å‡ã€‚
python2ç³»ã«pathã‚’é€šã—ã¦vcbuild.batã‚’ãŸãŸãã€‚</p>
<blockquote>
<p>vcbuild.bat</p>
</blockquote>
<p>v8ã‚‚libuvã‚‚å…¨éƒ¨å…¥ã‚Šã‚‰ã—ãã‚ã£ã•ã‚Šã¨ã»ã¼ãƒ“ãƒ«ãƒ‰ã§ããŸã€‚
SignTool Error: No certificates were found that met all the given criteria.
Failed to sign exe</p>
<p>document
https://github.com/nodejs/node-v0.x-archive/wiki/Installation#building-on-windows
debugãƒ“ãƒ«ãƒ‰ã®ä½œã‚Šæ–¹ã¯ã“ã†ã€‚</p>
<blockquote>
<p>vcbuild.bat nosign debug</p>
</blockquote>
<p>nodeã‚’ãƒ‡ãƒãƒƒã‚°å®Ÿè¡Œ</p>
<p>node-v5.3.0ã«node.slnãŒã§ãã¦ã„ã‚‹ã®ã§ã“ã‚Œã‚’VisualStudio2015ã§é–‹ãã€‚
nodeã‚’ã‚¹ã‚¿ãƒ¼ãƒˆã‚¢ãƒƒãƒ—ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«æŒ‡å®š
nodeã®è¨­å®šã®debugã‚¿ãƒ–ã§ã€ã‚«ãƒ¬ãƒ³ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¨ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³å¼•æ•°ã‚’æŒ‡å®š
f5</p>
<p>ä¾‹å¤–ãŒå†ç¾ã—ãŸ
void CallbackInfo::DispatchToV8(callback_info <em>info, void </em>retval, void **parameters, bool dispatched) {
  Nan::HandleScope scope;</p>
<p>static const char* errorMessage = "ffi fatal: callback has been garbage collected!";</p>
<p>if (info-&gt;function == NULL) {
    // throw an error instead of segfaulting.
    // see: https://github.com/rbranson/node-ffi/issues/72
    if (dispatched) {
        Local<value> errorFunctionArgv[1];
        errorFunctionArgv[0] = Nan::New<string>(errorMessage).ToLocalChecked();
        info-&gt;errorFunction-&gt;Call(1, errorFunctionArgv);
    }
    else {
      Nan::ThrowError(errorMessage);
    }
  } else {
    // invoke the registered callback function
    Local<value> functionArgv[2];
    functionArgv[0] = WrapPointer((char <em>)retval, info-&gt;resultSize);
    functionArgv[1] = WrapPointer((char </em>)parameters, sizeof(char *) * info-&gt;argc);
    Local<value> e = info-&gt;function-&gt;Call(2, functionArgv); // &lt;-- ã“ã“ã€‚functionãŒnullptrã«ãªã£ã¦ã‚‹ã‚ˆ!
    if (!e-&gt;IsUndefined()) {
      if (dispatched) {
        Local<value> errorFunctionArgv[1];
        errorFunctionArgv[0] = e;
        info-&gt;errorFunction-&gt;Call(1, errorFunctionArgv);
      } else {
        Nan::ThrowError(e);
      }
    }
  }
}</value></value></value></string></value></p>
<p>ã†ã†ã‚€ã€‚ifæ–‡ã§nullãƒã‚§ãƒƒã‚¯ã—ã¦ã‚‹ã®ã«elseå´ã«è½ã¡ã¦ã‚‹ãªã€‚çŸ¢å¼µã‚Šã‚¹ãƒ¬ãƒƒãƒ‰ã¨ã‹GCãŒçµ¡ã‚“ã§ã„ãã†ãªæ°—ãŒã™ã‚‹ãã€‚
ã¡ã‚‡ã†ã©node-ffiã§javascriptã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’å‘¼ã³å‡ºã—ã¦ã„ã‚‹ã¨ã“ã‚ãªã®ã§ã¯ãªã„ã‹ã€‚
ã‚³ãƒ¼ãƒ«ã‚¹ã‚¿ãƒƒã‚¯</p>
<blockquote>
<p>ffi_bindings.node!CallbackInfo::DispatchToV8(_callback_info * info, void * retval, void * * parameters, bool dispatched) è¡Œ 73   C++
    ffi_bindings.node!CallbackInfo::WatcherCallback(uv_async_s * w, int revents) è¡Œ 94   C++
    node.exe!uv_process_async_wakeup_req(uv_loop_s * loop, uv_async_s * handle, uv_req_s * req) è¡Œ 97    C</p>
</blockquote>
<p>ã‚ˆãè¦‹ã‚‹ã¨ã¾ã•ã«ffi_bindings.node(node-ffiã®ãƒã‚¤ãƒ†ã‚£ãƒ–ãƒ—ãƒ©ã‚°ã‚¤ãƒ³)å†…ã§å•é¡ŒãŒç™ºç”Ÿã—ã¦ã„ã‚‹ã€‚
å‘¼ã³å‡ºã—ã‚¹ãƒ¬ãƒƒãƒ‰ã¯ãƒ¡ã‚¤ãƒ³ã‚¹ãƒ¬ãƒƒãƒ‰ã‹ãƒ»ãƒ»ãƒ»ã€‚
ä½•å›ã‚‚è©¦ã—ã¦ã¿ã‚‹ã¨ä¾‹å¤–ãŒã‚€ã—ã‚dllã®ã‚¹ãƒ¬ãƒƒãƒ‰å´ã§èµ·ã“ã‚‹ã“ã¨ã®æ–¹ãŒå¤šã„ã€‚
ä»–ã«WaitSingleObjectãŒstdcallã®é–¢æ•°ã‚’ã‚¹ãƒ¬ãƒƒãƒ‰å®Ÿè¡Œã—ã¦ã„ã‚‹ã‚‚ã®ãŒï¼”æœ¬ã€‚
ã²ã‚‡ã£ã¨ã—ã¦ã€ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã®é »åº¦ãŒé«˜ã™ããªã‚“ã˜ã‚ƒãªã„ã®ã‹ãƒ»ãƒ»ãƒ»ã€‚
callback_infoã¯ffiã®æ§‹é€ ä½“ã€‚ã“ã„ã¤ã®ãƒ‡ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ãŒå‘¼ã°ã‚Œã¦ã„ã‚‹ã®ãŒç¢ºèªã§ãã‚Œã°æ‰‹ãŒã‹ã‚Šã«ãªã‚‹ãªã€‚
ã§ã€callback_info-&gt;functionã‚’è§£æ”¾ã™ã‚‹ä¸‹è¨˜ã®éƒ¨åˆ†ãŒãƒ¡ã‚¤ãƒ³ã‚¹ãƒ¬ãƒƒãƒ‰ã‹ã‚‰å‘¼ã°ã‚Œã¦ã€ãã®å¾Œã«
ã‚¹ãƒ¬ãƒƒãƒ‰ã‹ã‚‰ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯å‘¼ã³å‡ºã—ãŒã‚¯ãƒ©ãƒƒã‚·ãƒ¥ã—ã¦ã„ã‚‹ã‚‰ã—ã„ã“ã¨ã‚’ç™ºè¦‹ã€‚
node_modules/ffi/src/callback_info.cc
/<em>
 * Called when the <code>ffi_closure *</code> pointer (actually the "code" pointer) get's
 * GC'd on the JavaScript side. In this case we have to unwrap the
 * <code>callback_info *</code> struct, dispose of the JS function Persistent reference,
 * then finally free the struct.
 </em>/</p>
<p>void closure_pointer_cb(char <em>data, void </em>hint) {
  callback_info *info = reinterpret_cast<callback_info>(hint);
  // dispose of the Persistent function reference
  delete info-&gt;function;
  info-&gt;function = NULL;
  // now we can free the closure data
  ffi_closure_free(info);
}</callback_info></p>
<p>ã‚³ãƒ¼ãƒ«ã‚¹ã‚¿ãƒƒã‚¯</p>
<blockquote>
<p>ffi_bindings.node!closure_pointer_cb(char * data, void * hint) è¡Œ 42 C++
    node.exe!node::Buffer::CallbackInfo::WeakCallback(v8::Isolate * isolate, v8::Local<:object> object) è¡Œ 159    C++</:object></p>
</blockquote>
<pre class="code literal-block"> <span class="err">çœç•¥</span>

<span class="n">node</span><span class="o">.</span><span class="n">exe</span><span class="o">!</span><span class="n">v8</span><span class="p">::</span><span class="n">internal</span><span class="p">::</span><span class="n">Heap</span><span class="p">::</span><span class="n">CollectGarbage</span><span class="p">(</span><span class="n">v8</span><span class="p">::</span><span class="n">internal</span><span class="p">::</span><span class="n">AllocationSpace</span> <span class="n">space</span><span class="p">,</span> <span class="k">const</span> <span class="nb">char</span> <span class="o">*</span> <span class="n">gc_reason</span><span class="p">,</span> <span class="k">const</span> <span class="n">v8</span><span class="p">::</span><span class="n">GCCallbackFlags</span> <span class="n">callbackFlags</span><span class="p">)</span> <span class="err">è¡Œ</span> <span class="mi">556</span> <span class="n">C</span><span class="o">++</span>

 <span class="err">çœç•¥</span>

<span class="n">node</span><span class="o">.</span><span class="n">exe</span><span class="o">!</span><span class="n">node</span><span class="p">::</span><span class="n">Buffer</span><span class="p">::</span><span class="n">New</span><span class="p">(</span><span class="n">v8</span><span class="p">::</span><span class="n">Isolate</span> <span class="o">*</span> <span class="n">isolate</span><span class="p">,</span> <span class="nb">char</span> <span class="o">*</span> <span class="n">data</span><span class="p">,</span> <span class="n">unsigned</span> <span class="nb nb-Type">int</span> <span class="n">length</span><span class="p">,</span> <span class="n">void</span> <span class="p">(</span><span class="nb">char</span> <span class="o">*</span><span class="p">,</span> <span class="n">void</span> <span class="o">*</span><span class="p">)</span> <span class="o">*</span> <span class="n">callback</span><span class="p">,</span> <span class="n">void</span> <span class="o">*</span> <span class="n">hint</span><span class="p">)</span> <span class="err">è¡Œ</span> <span class="mi">347</span>    <span class="n">C</span><span class="o">++</span>
<span class="n">binding</span><span class="o">.</span><span class="n">node</span><span class="o">!</span><span class="err">`</span><span class="n">anonymous</span> <span class="n">namespace</span><span class="s1">'::WrapPointer(char * ptr, unsigned int length) è¡Œ 147  C++</span>
<span class="n">binding</span><span class="o">.</span><span class="n">node</span><span class="o">!</span><span class="err">`</span><span class="n">anonymous</span> <span class="n">namespace</span><span class="s1">'::ReadPointer(const Nan::FunctionCallbackInfo&lt;v8::Value&gt; &amp; info) è¡Œ 261    C++</span>
<span class="n">binding</span><span class="o">.</span><span class="n">node</span><span class="o">!</span><span class="n">Nan</span><span class="p">::</span><span class="n">imp</span><span class="p">::</span><span class="n">FunctionCallbackWrapper</span><span class="p">(</span><span class="k">const</span> <span class="n">v8</span><span class="p">::</span><span class="n">FunctionCallbackInfo</span><span class="o">&lt;</span><span class="n">v8</span><span class="p">::</span><span class="n">Value</span><span class="o">&gt;</span> <span class="o">&amp;</span> <span class="n">info</span><span class="p">)</span> <span class="err">è¡Œ</span> <span class="mi">174</span>  <span class="n">C</span><span class="o">++</span>
</pre>
<p>ãªã‚“ã‹ã€GCãŒç™ºå‹•ã—ã¦å›åã•ã‚Œã¡ã‚ƒã£ã¦ã„ã‚‹ã½ã„ï¼Ÿ
2015/09/20
* Nodejs GC is crashing when a C function is returning NULL
ã‚€ã—ã‚ã“ã£ã¡ã‹
2015/11/05
* Node.js v5.0.0ã§node-ffiã‚„NodObjCãŒå‹•ã‹ãªã„
ã—ã‹ã—ã€ã†ã¡ã®node.jsã¯</p>
<blockquote>
<p>node --version
v5.3.0</p>
</blockquote>
<p>ã†ã‚€ã€‚
ã‚€ã—ã‚ã“ã£ã¡ã‹
2015/09/15
* ffi.Function underlying Callback is garbage collected
æ­»ãªãªããªã£ãŸã€‚ã“ã‚Œã£ã½ã„ãªã€‚
64bitç‰ˆã§è©¦ã—ã¦ã¿ã‚‹
ã“ã‚Œã¯ã“ã‚Œã§æ­»ã¬ã€‚
ã¾ã¨ã‚</p>
<p>node-ffiã®Functionã§GCã«å›åã•ã‚Œã¦ã—ã¾ã†æ›¸ãæ–¹ã®ã¨ã“ã‚ãŒã‚ã‚‹(FFI.Functionå†…)
32bitç‰ˆã®node-ffiã§ã¯STDCALLã‚’æŒ‡å®šã§ãã‚‹(ABI=2)
64bitç‰ˆã®node-ffiã§ã¯IA64ã«ã•ã‚Œã‚‹ã®ã§STDCALLã¯å‹•ã‹ã¬</p>
<p>gypã§ã®IA64ã¨X64ã®æ‰±ã„ã®é•ã„ãŒã‚ã‹ã£ãŸã‚‰ä¿®æ­£ã§ãã‚‹ã‹ãªã€‚
X86_WIN32ã®æ™‚ã«FFI_STDCALLã‚’å®šç¾©ã™ã‚‹ä¿®æ­£ã‚’ãƒ—ãƒ«ãƒªã‚¯ã—ã¦ã¿ã‚ˆã†ã€‚</p>

<hr>
<ul class="pager hidden-print">
<li class="previous">
        <a href="../../19/node_ffi/" rel="prev" title="node-ffiã§stdcallãŒä½¿ã„ãŸã„(é “æŒ«)">
            node-ffiã§stdcallãŒä½¿ã„ãŸã„(é “æŒ«) ğŸ‘ˆ
        </a>
    </li>
    <li style="flex-grow: 1">
    <li class="next">
        <a href="../../22/threejs_pmd_loader/" rel="next" title="Three.jsã§pmdèª­ã¿è¾¼ã¿">
            ğŸ‘‰ Three.jsã§pmdèª­ã¿è¾¼ã¿
        </a>
    </li>
</ul></main><footer id="footer"><p>
            Powered by
            <a href="https://getnikola.com" rel="nofollow">Nikola</a>
        </p>
    </footer>
</body>
</html>
