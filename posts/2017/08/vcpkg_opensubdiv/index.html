<!DOCTYPE html>
<html><body>
    <h1 id="brand">
        <a href="../../../../" title="三次元日誌" rel="home">
            <span id="blog-title">三次元日誌</span>
        </a>
    </h1>
    <hr>
<main id="content"><h1 class="p-name entry-title" itemprop="headline name">
    <a href="." class="u-url">vcpkgのOpenSubdivパッケージを作ってみる</a>
</h1>
<div>
<p>CEDEC2017のセッションを聞いてUSDビルドする気が戻ってきた。部品のひとつ、OpenSubdivのvcpkg版ビルドに取り組んでみる。</p>
<p>packageを作る
POWERSHELLを開いてvcpkgディレクトリに移動。</p>
<pre class="code literal-block"><span></span>PS&gt; .<span class="se">\v</span>cpkg.exe create opensubdiv https://github.com/PixarAnimationStudios/OpenSubdiv/archive/v3_3_0.tar.gz
-- Generated portfile: vcpkg<span class="se">\p</span>orts<span class="se">\o</span>pensubdiv<span class="se">\p</span>ortfile.cmake
-- Generated CONTROL: vcpkg<span class="se">\p</span>orts<span class="se">\o</span>pensubdiv<span class="se">\C</span>ONTROL
-- To launch an editor <span class="k">for</span> these new files, run
--     .<span class="se">\v</span>cpkg edit opensubdiv

ports/opensubdiv/CONTROL
Source: opensubdiv
Version: <span class="m">3</span>.3.0
Description: An Open-Source subdivision surface library.
Build-Depends: tbb, glew, ptex
</pre>

<p><code>ports/opensubdiv/portfile.cmake</code></p>
<p>最低限、展開するアーカイブのパスを指定。</p>
<p><code>set(SOURCE_PATH ${CURRENT_BUILDTREES_DIR}/src/OpenSubdiv-3_3_0)</code></p>
<p>ビルドしてみる
さすがにエラーになる。vcpkg の <code>buildtree/opensubdiv</code> に潜ってビルド手順を調べてみる。
手動ビルド
OpenSubdivのビルドシステムはCMakeだった。
早速、CmakeGUIでやってみる。
<code>CMAKE_INSTALL_PREFIX=VCPKG_DIR/installed/x64-windows</code> だけ設定して様子を見る。</p>
<p>CUDAとかOpenCLとかそっち方面の依存がある様子。
NO_CUDAとNO_OPENCLにチェックを入れてみる。
あとNO_DOCも。
SolutionをGenerateしてビルドしてみる。
Debug版だけtbb_debug.libが見つからないエラーが出た。
DEBUG版のFIND_PACKAGEの修正</p>
<pre class="code literal-block"><span></span><span class="err">OpenSubdiv-3_3_0/cmake/FindTBB.cmake</span>
    <span class="nb">find_library</span><span class="p">(</span><span class="s">TBB_</span><span class="o">${</span><span class="nv">TBB_LIB</span><span class="o">}</span><span class="s">_LIBRARY</span>
        <span class="s">NAMES</span>
            <span class="o">${</span><span class="nv">TBB_LIB</span><span class="o">}</span>
        <span class="s">HINTS</span>
            <span class="s2">"${TBB_LOCATION}/lib"</span>
            <span class="s2">"${TBB_LOCATION}/bin"</span>
            <span class="s2">"$ENV{TBB_LOCATION}/lib"</span>
            <span class="s2">"$ENV{TBB_LOCATION}/bin"</span>
            <span class="s2">"$ENV{PROGRAMFILES}/TBB/lib"</span>
            <span class="s">/usr/lib</span>
            <span class="s">/usr/lib/w32api</span>
            <span class="s">/usr/local/lib</span>
            <span class="s">/usr/X11R6/lib</span>
        <span class="s">PATH_SUFFIXES</span>
            <span class="s2">"${TBB_LIB_ARCH}"</span>
            <span class="s2">"${TBB_LIB_ARCH}/${TBB_COMPILER}"</span>
            <span class="s2">"${TBB_LIB_ARCH}/gcc4.4"</span>
            <span class="s2">"${TBB_LIB_ARCH}/gcc4.1"</span>
        <span class="s">DOC</span> <span class="s2">"Intel's Threading Building Blocks library"</span><span class="p">)</span>
</pre>

<p>vcpkgでは、<code>VCPKG_DIR/installed/x64-windows/debug/lib/tbb_debug.lib</code> にあるので見つかりませんね。
<code>TBB_LOCATION=VCPKG_DIR/installed/x64-windows/debug</code> を指定したらうまくいった。</p>
<p>portfile.cmakeに反映
ports/opensubdiv/portfile.cmake
こうなった。</p>
<pre class="code literal-block"><span></span><span class="nb">vcpkg_configure_cmake</span><span class="p">(</span>
    <span class="s">SOURCE_PATH</span> <span class="o">${</span><span class="nv">SOURCE_PATH</span><span class="o">}</span>
    <span class="c">#PREFER_NINJA # Disable this option if project cannot be built with Ninja</span>
    <span class="s">OPTIONS</span>
        <span class="c">#-DNO_LIB=1</span>
        <span class="s">-DNO_CUDA=1</span>
        <span class="s">-DNO_DOC=1</span>
        <span class="s">-DNO_OPENCL=1</span>
        <span class="s">-DNO_OPENGL=1</span>
        <span class="s">-DNO_METAL=1</span>
        <span class="s">-DNO_DX=1</span>
        <span class="c">#-DNO_OMP=1</span>
        <span class="s">-DNO_TESTS=1</span>
        <span class="s">-DNO_EXAMPLES=1</span>
        <span class="s">-DNO_TUTORIALS=1</span>
        <span class="s">-DNO_REGRESSION=1</span>
        <span class="s">-DNO_GLTESTS=1</span>
        <span class="c"># for tbb_debug.lib</span>
        <span class="s">-DTBB_LOCATION=</span><span class="o">${</span><span class="nv">CURRENT_INSTALLED_DIR</span><span class="o">}</span><span class="s">/debug</span>
    <span class="c"># OPTIONS_RELEASE -DOPTIMIZE=1</span>
    <span class="c"># OPTIONS_DEBUG -DDEBUGGABLE=1</span>
<span class="p">)</span>
</pre>

<p>package
VCPKG_DIR/packages/opensubdiv_x86-windows
packageの調整
エラーメッセージの指示に従って。</p>
<p>```ports/opensubdiv/portfile.cmake
vcpkg_install_cmake()
vcpkg_copy_pdbs()</p>
<p>file(REMOVE_RECURSE ${CURRENT_PACKAGES_DIR}/debug/include)</p>
<h2>Handle copyright</h2>
<p>file(COPY ${CURRENT_BUILDTREES_DIR}/src/OpenSubdiv-3_3_0/LICENSE.txt DESTINATION ${CURRENT_PACKAGES_DIR}/share/opensubdiv)
file(RENAME ${CURRENT_PACKAGES_DIR}/share/opensubdiv/LICENSE.txt ${CURRENT_PACKAGES_DIR}/share/opensubdiv/copyright)</p>
<pre class="code literal-block"><span></span>以下のようになった。

```shell
+---debug
|   \---lib
|           osdCPU.lib
|
+---include
|   \---opensubdiv
|       |   version.h
|       |
|       +---far
|       |       error.h
|       |       patchDescriptor.h
|       |       patchMap.h
|       |       patchParam.h
|       |       patchTable.h
|       |       patchTableFactory.h
|       |       primvarRefiner.h
|       |       ptexIndices.h
|       |       stencilTable.h
|       |       stencilTableFactory.h
|       |       topologyDescriptor.h
|       |       topologyLevel.h
|       |       topologyRefiner.h
|       |       topologyRefinerFactory.h
|       |       types.h
|       |
|       +---hbr
|       |       allocator.h
|       |       bilinear.h
|       |       catmark.h
|       |       cornerEdit.h
|       |       creaseEdit.h
|       |       face.h
|       |       faceEdit.h
|       |       fvarData.h
|       |       fvarEdit.h
|       |       halfedge.h
|       |       hierarchicalEdit.h
|       |       holeEdit.h
|       |       loop.h
|       |       mesh.h
|       |       subdivision.h
|       |       vertex.h
|       |       vertexEdit.h
|       |
|       +---osd
|       |       bufferDescriptor.h
|       |       cpuEvaluator.h
|       |       cpuPatchTable.h
|       |       cpuVertexBuffer.h
|       |       mesh.h
|       |       nonCopyable.h
|       |       ompEvaluator.h
|       |       ompKernel.h
|       |       opengl.h
|       |       tbbEvaluator.h
|       |       tbbKernel.h
|       |       types.h
|       |
|       +---sdc
|       |       bilinearScheme.h
|       |       catmarkScheme.h
|       |       crease.h
|       |       loopScheme.h
|       |       options.h
|       |       scheme.h
|       |       types.h
|       |
|       \---vtr
|               array.h
|               componentInterfaces.h
|               fvarLevel.h
|               fvarRefinement.h
|               level.h
|               refinement.h
|               sparseSelector.h
|               stackBuffer.h
|               types.h
|
+---lib
|       osdCPU.lib
|
\---share
    \---opensubdiv
            copyright
</pre>

<p>OpenSubdivにはdllのビルドは無いみたい。ライブラリ構成もtemplate classを主体とするもののようだ。</p>
</div>
    </main>
</body></html>
