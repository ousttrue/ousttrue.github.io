<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <title>三次元日誌</title>

    

  <script src="https://ousttrue.github.io/plugins/elasticlunr.min.js" defer></script>
  <script src="https://ousttrue.github.io/search_index.en.js" defer></script>
  <script src="https://ousttrue.github.io/js/search.js" defer></script>

    

     
    <link rel="stylesheet" href="https://ousttrue.github.io/main.css">
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css"
      />
    
  </head>

  <body class="container">
    <a class="site_title" href="https:&#x2F;&#x2F;ousttrue.github.io&#x2F;">
      <div>三次元日誌</div>
    </a>

    <nav class="nav">
      <a class="item" href="/tags/">tags</a>
      <a class="item" href="https://github.com/ousttrue" aria-label="github">
        <i class="fab fa-github fa-lg"></i>
      </a>
      

        
            <form class="navbar-form">
                <input id="userinput" class="form-control is-search" type="search" placeholder="Search docs..."
                    aria-label="Search docs..." autocomplete="off">
                <div id="suggestions" class="shadow bg-white rounded"></div>
            </form>
        
    </nav>

    <main class="main">
<div class="page">
<div class="content">
  <div class="headline">
  
  

  
  <a class="headline_title" href="https:&#x2F;&#x2F;ousttrue.github.io&#x2F;posts&#x2F;2017&#x2F;08&#x2F;vcpkg-opensubdiv&#x2F;"> vcpkgのOpenSubdivパッケージを作ってみる 
  

  
  </a>

  

  <div>
    <ul class="tags">
      <li class="headline_date">
        <div class="year">2017</div>
        <div class="md">0831</div>
      </li>
      
      


    <li class="tag"><a href="https:&#x2F;&#x2F;ousttrue.github.io&#x2F;tags&#x2F;vcpkg&#x2F;">vcpkg</a></li>

    <li class="tag"><a href="https:&#x2F;&#x2F;ousttrue.github.io&#x2F;tags&#x2F;usd&#x2F;">usd</a></li>




    </ul>
  </div>
</div>
 <p>CEDEC2017のセッションを聞いてUSDビルドする気が戻ってきた。部品のひとつ、OpenSubdivのvcpkg版ビルドに取り組んでみる。</p>
<p>packageを作る
POWERSHELLを開いてvcpkgディレクトリに移動。</p>
<pre style="background-color:#2b303b;">
<code class="language-shell" data-lang="shell"><span style="color:#c0c5ce;">PS&gt; .\vcpkg.exe create opensubdiv https://github.com/PixarAnimationStudios/OpenSubdiv/archive/v3_3_0.tar.gz
-- Generated portfile: vcpkg\ports\opensubdiv\portfile.cmake
-- Generated CONTROL: vcpkg\ports\opensubdiv\CONTROL
-- To launch an editor for these new files, run
--     .\vcpkg edit opensubdiv

ports/opensubdiv/CONTROL
Source: opensubdiv
Version: 3.3.0
Description: An Open-Source subdivision surface library.
Build-Depends: tbb, glew, ptex
</span></code></pre>
<p><code>ports/opensubdiv/portfile.cmake</code></p>
<p>最低限、展開するアーカイブのパスを指定。</p>
<p><code>set(SOURCE_PATH ${CURRENT_BUILDTREES_DIR}/src/OpenSubdiv-3_3_0)</code></p>
<p>ビルドしてみる
さすがにエラーになる。vcpkg の <code>buildtree/opensubdiv</code> に潜ってビルド手順を調べてみる。
手動ビルド
OpenSubdivのビルドシステムはCMakeだった。
早速、CmakeGUIでやってみる。
<code>CMAKE_INSTALL_PREFIX=VCPKG_DIR/installed/x64-windows</code> だけ設定して様子を見る。</p>
<p>CUDAとかOpenCLとかそっち方面の依存がある様子。
NO_CUDAとNO_OPENCLにチェックを入れてみる。
あとNO_DOCも。
SolutionをGenerateしてビルドしてみる。
Debug版だけtbb_debug.libが見つからないエラーが出た。
DEBUG版のFIND_PACKAGEの修正</p>
<pre style="background-color:#2b303b;">
<code class="language-cmake" data-lang="cmake"><span style="color:#bf616a;">OpenSubdiv</span><span style="color:#c0c5ce;">-3_3_0/cmake/FindTBB.cmake
    find_library(TBB_${</span><span style="color:#bf616a;">TBB_LIB</span><span style="color:#c0c5ce;">}_LIBRARY
        NAMES
            ${</span><span style="color:#bf616a;">TBB_LIB</span><span style="color:#c0c5ce;">}
        HINTS
            &quot;${</span><span style="color:#bf616a;">TBB_LOCATION</span><span style="color:#c0c5ce;">}/lib&quot;
            &quot;${</span><span style="color:#bf616a;">TBB_LOCATION</span><span style="color:#c0c5ce;">}/bin&quot;
            &quot;$ENV{</span><span style="color:#bf616a;">TBB_LOCATION</span><span style="color:#c0c5ce;">}/lib&quot;
            &quot;$ENV{</span><span style="color:#bf616a;">TBB_LOCATION</span><span style="color:#c0c5ce;">}/bin&quot;
            &quot;$ENV{</span><span style="color:#bf616a;">PROGRAMFILES</span><span style="color:#c0c5ce;">}/TBB/lib&quot;
            /usr/lib
            /usr/lib/w32api
            /usr/local/lib
            /usr/X11R6/lib
        PATH_SUFFIXES
            &quot;${</span><span style="color:#bf616a;">TBB_LIB_ARCH</span><span style="color:#c0c5ce;">}&quot;
            &quot;${</span><span style="color:#bf616a;">TBB_LIB_ARCH</span><span style="color:#c0c5ce;">}/${</span><span style="color:#bf616a;">TBB_COMPILER</span><span style="color:#c0c5ce;">}&quot;
            &quot;${</span><span style="color:#bf616a;">TBB_LIB_ARCH</span><span style="color:#c0c5ce;">}/gcc4.4&quot;
            &quot;${</span><span style="color:#bf616a;">TBB_LIB_ARCH</span><span style="color:#c0c5ce;">}/gcc4.1&quot;
        DOC &quot;Intel&#39;s Threading Building Blocks library&quot;)
</span></code></pre>
<p>vcpkgでは、<code>VCPKG_DIR/installed/x64-windows/debug/lib/tbb_debug.lib</code> にあるので見つかりませんね。
<code>TBB_LOCATION=VCPKG_DIR/installed/x64-windows/debug</code> を指定したらうまくいった。</p>
<p>portfile.cmakeに反映
ports/opensubdiv/portfile.cmake
こうなった。</p>
<pre style="background-color:#2b303b;">
<code class="language-cmake" data-lang="cmake"><span style="color:#bf616a;">vcpkg_configure_cmake</span><span style="color:#c0c5ce;">(
    SOURCE_PATH ${</span><span style="color:#bf616a;">SOURCE_PATH</span><span style="color:#c0c5ce;">}
    </span><span style="color:#65737e;">#PREFER_NINJA # Disable this option if project cannot be built with Ninja
</span><span style="color:#c0c5ce;">    OPTIONS
        </span><span style="color:#65737e;">#-DNO_LIB=1
</span><span style="color:#c0c5ce;">        -DNO_CUDA=1
        -DNO_DOC=1
        -DNO_OPENCL=1
        -DNO_OPENGL=1
        -DNO_METAL=1
        -DNO_DX=1
        </span><span style="color:#65737e;">#-DNO_OMP=1
</span><span style="color:#c0c5ce;">        -DNO_TESTS=1
        -DNO_EXAMPLES=1
        -DNO_TUTORIALS=1
        -DNO_REGRESSION=1
        -DNO_GLTESTS=1
        </span><span style="color:#65737e;"># for tbb_debug.lib
</span><span style="color:#c0c5ce;">        -DTBB_LOCATION=${</span><span style="color:#bf616a;">CURRENT_INSTALLED_DIR</span><span style="color:#c0c5ce;">}/debug
    </span><span style="color:#65737e;"># OPTIONS_RELEASE -DOPTIMIZE=1
    # OPTIONS_DEBUG -DDEBUGGABLE=1
</span><span style="color:#c0c5ce;">)
</span></code></pre>
<p>package
VCPKG_DIR/packages/opensubdiv_x86-windows
packageの調整
エラーメッセージの指示に従って。</p>
<pre style="background-color:#2b303b;">
<code class="language-ports/opensubdiv/portfile.cmake" data-lang="ports/opensubdiv/portfile.cmake"><span style="color:#c0c5ce;">vcpkg_install_cmake()
vcpkg_copy_pdbs()

file(REMOVE_RECURSE ${CURRENT_PACKAGES_DIR}/debug/include)

# Handle copyright
file(COPY ${CURRENT_BUILDTREES_DIR}/src/OpenSubdiv-3_3_0/LICENSE.txt DESTINATION ${CURRENT_PACKAGES_DIR}/share/opensubdiv)
file(RENAME ${CURRENT_PACKAGES_DIR}/share/opensubdiv/LICENSE.txt ${CURRENT_PACKAGES_DIR}/share/opensubdiv/copyright)
</span></code></pre>
<p>以下のようになった。</p>
<pre style="background-color:#2b303b;">
<code class="language-shell" data-lang="shell"><span style="color:#c0c5ce;">+---debug
|   \---lib
|           osdCPU.lib
|
+---include
|   \---opensubdiv
|       |   version.h
|       |
|       +---far
|       |       error.h
|       |       patchDescriptor.h
|       |       patchMap.h
|       |       patchParam.h
|       |       patchTable.h
|       |       patchTableFactory.h
|       |       primvarRefiner.h
|       |       ptexIndices.h
|       |       stencilTable.h
|       |       stencilTableFactory.h
|       |       topologyDescriptor.h
|       |       topologyLevel.h
|       |       topologyRefiner.h
|       |       topologyRefinerFactory.h
|       |       types.h
|       |
|       +---hbr
|       |       allocator.h
|       |       bilinear.h
|       |       catmark.h
|       |       cornerEdit.h
|       |       creaseEdit.h
|       |       face.h
|       |       faceEdit.h
|       |       fvarData.h
|       |       fvarEdit.h
|       |       halfedge.h
|       |       hierarchicalEdit.h
|       |       holeEdit.h
|       |       loop.h
|       |       mesh.h
|       |       subdivision.h
|       |       vertex.h
|       |       vertexEdit.h
|       |
|       +---osd
|       |       bufferDescriptor.h
|       |       cpuEvaluator.h
|       |       cpuPatchTable.h
|       |       cpuVertexBuffer.h
|       |       mesh.h
|       |       nonCopyable.h
|       |       ompEvaluator.h
|       |       ompKernel.h
|       |       opengl.h
|       |       tbbEvaluator.h
|       |       tbbKernel.h
|       |       types.h
|       |
|       +---sdc
|       |       bilinearScheme.h
|       |       catmarkScheme.h
|       |       crease.h
|       |       loopScheme.h
|       |       options.h
|       |       scheme.h
|       |       types.h
|       |
|       \---vtr
|               array.h
|               componentInterfaces.h
|               fvarLevel.h
|               fvarRefinement.h
|               level.h
|               refinement.h
|               sparseSelector.h
|               stackBuffer.h
|               types.h
|
+---lib
|       osdCPU.lib
|
\---share
    \---opensubdiv
            copyright
</span></code></pre>
<p>OpenSubdivにはdllのビルドは無いみたい。ライブラリ構成もtemplate classを主体とするもののようだ。</p>

</div>

<nav class="toc">


</nav>
</div>
</main>

    <footer class="footer">Powered by <a href="https://www.getzola.org/">Zola</a> <a href="https://github.com/ousttrue/zola/tree/custom">custom</a></footer>

  </body>
</html>
