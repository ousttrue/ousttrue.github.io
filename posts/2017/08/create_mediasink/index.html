<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="generator" content="Nikola (getnikola.com)">
<meta name="viewport" content="width=device-width">
<script src="../../../../assets/js/all-nocdn.js"></script><title>MediaSinkã‚’å®Ÿè£…ã™ã‚‹ | ä¸‰æ¬¡å…ƒæ—¥èªŒ</title>
<link href="../../../../assets/css/code.css" rel="stylesheet" type="text/css">
<link href="../../../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
</head>
<body>
    <h1 id="brand">
        <a href="../../../../" title="ä¸‰æ¬¡å…ƒæ—¥èªŒ" rel="home">
            <span id="blog-title">ä¸‰æ¬¡å…ƒæ—¥èªŒ</span>
        </a>
    </h1>

    <nav id="menu"><ul>
<li><a href="../../../../archive.html">Archives</a></li>
<li><a href="../../../../categories/index.html">Tags</a></li>
<li><a href="../../../../rss.xml">RSS feed</a></li>
<li><a href="../../../../about">About</a></li>
<li><a href="../../../../books">MemoBooks</a></li>

            
            
            
        </ul></nav><hr>
<main id="content"><h1 class="p-name entry-title" itemprop="headline name">
    <h1 class="p-name entry-title" itemprop="headline name">
    <a href="." class="u-url">MediaSinkã‚’å®Ÿè£…ã™ã‚‹
    </a>
</h1>
<ul itemprop="keywords" class="tags">
<li>
        <time datetime="2017-08-27T00:00:00+09:00" title="2017-08-27">2017-08-27</time>
</li>
    <li><a class="tag p-category" href="../../../../categories/d3d/" rel="tag">d3d</a></li>
    <li><a class="tag p-category" href="../../../../categories/mediafoundation/" rel="tag">mediafoundation</a></li>
</ul>
</h1>

<p>DX11VideoRendererã‚’è§£èª­ã—ã¦ã€VideoRendererè¦ä»¶ã‚’æ¢ã‚‹ã€‚</p>
<p>Microsoftã®ã‚µãƒ³ãƒ—ãƒ«ãŒã‚ã‚Šå‚è€ƒã«ãªã‚‹ã€‚</p>
<p>https://github.com/Microsoft/Windows-classic-samples/tree/master/Samples/DX11VideoRenderer</p>
<p>ã“ã‚Œã¯çµæ§‹ãŒã£ã¤ã‚Šä½œã£ã¦ã‚ã‚‹ã®ã§ã€å‰Šã£ã¦æœ€ä½é™å¿…è¦ãªè¦ç´ ã‚’æ¢ã‚‹ã€‚
IMFMediaSinkã‚’ä½œã‚‹
æ‰‹æŠœãã—ã¦IMFActivateæŠœãã§ã€‚
https://github.com/Microsoft/Windows-classic-samples/blob/master/Samples/DX11VideoRenderer/c++/DX11VideoRenderer.h
ã‚’å‚è€ƒã«æœ€ä½é™ã‚’å®Ÿè£…ã—ã¦ã¿ã‚‹ã€‚
guidgen.exeã§guidã‚’æ±ºã‚ãŸã€‚
CustomVideoRenderer.h</p>
<h2>pragma once</h2>
<h2>include <windows.h></windows.h>
</h2>
<p>// {8C5C51AD-F400-4B2A-BD36-4990D07420B4}
DEFINE_GUID(CLSID_CustomVideoRenderer, 
0x8c5c51ad, 0xf400, 0x4b2a, 0xbd, 0x36, 0x49, 0x90, 0xd0, 0x74, 0x20, 0xb4);</p>
<p>STDAPI CreateCustomVideoRenderer(REFIID riid, void **ppvObject);</p>
<p>DX11VideoRendererã‹ã‚‰å¿…è¦ãªéƒ¨åˆ†ã‚’ã‚³ãƒ”ãƒšã—ã¦ãã‚‹ã ã‘ã§ã‚ã‚‹ã€‚
CustomVideoRenderer.c++</p>
<h2>include "CustomVideoRenderer.h"</h2>
<h2>include <mfidl.h></mfidl.h>
</h2>
<p>class CustomVideoRenderer: public IMFMediaSink
{
    ULONG m_nRefCount = 1;</p>
<p>public:
    // IUnknown
    STDMETHODIMP_(ULONG) AddRef(void)override
    {
        return InterlockedIncrement(&amp;m_nRefCount);
    }</p>
<pre class="code literal-block"><span class="n">STDMETHODIMP</span> <span class="n">QueryInterface</span><span class="p">(</span><span class="n">REFIID</span> <span class="n">iid</span><span class="p">,</span> <span class="n">__RPC__deref_out</span> <span class="n">_Result_nullonfailure_</span> <span class="n">void</span><span class="o">**</span> <span class="n">ppv</span><span class="p">)</span><span class="n">override</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ppv</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="n">E_POINTER</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">iid</span> <span class="o">==</span> <span class="n">IID_IUnknown</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="o">*</span><span class="n">ppv</span> <span class="o">=</span> <span class="n">static_cast</span><span class="o">&lt;</span><span class="n">IUnknown</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">static_cast</span><span class="o">&lt;</span><span class="n">IMFMediaSink</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">this</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">iid</span> <span class="o">==</span> <span class="n">__uuidof</span><span class="p">(</span><span class="n">IMFMediaSink</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="o">*</span><span class="n">ppv</span> <span class="o">=</span> <span class="n">static_cast</span><span class="o">&lt;</span><span class="n">IMFMediaSink</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">this</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="o">*</span><span class="n">ppv</span> <span class="o">=</span> <span class="n">NULL</span><span class="p">;</span>
        <span class="k">return</span> <span class="n">E_NOINTERFACE</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">AddRef</span><span class="p">();</span>
    <span class="k">return</span> <span class="n">S_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">STDMETHODIMP_</span><span class="p">(</span><span class="n">ULONG</span><span class="p">)</span> <span class="n">Release</span><span class="p">(</span><span class="n">void</span><span class="p">)</span><span class="n">override</span>
<span class="p">{</span>
    <span class="n">ULONG</span> <span class="n">uCount</span> <span class="o">=</span> <span class="n">InterlockedDecrement</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m_nRefCount</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">uCount</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">delete</span> <span class="n">this</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="o">//</span> <span class="n">For</span> <span class="n">thread</span> <span class="n">safety</span><span class="p">,</span> <span class="k">return</span> <span class="n">a</span> <span class="n">temporary</span> <span class="n">variable</span><span class="o">.</span>
    <span class="k">return</span> <span class="n">uCount</span><span class="p">;</span>
<span class="p">}</span>

<span class="o">//</span> <span class="n">IMFMediaSink</span> <span class="n">methods</span>
<span class="n">STDMETHODIMP</span> <span class="n">AddStreamSink</span><span class="p">(</span><span class="n">DWORD</span> <span class="n">dwStreamSinkIdentifier</span><span class="p">,</span> <span class="n">__RPC__in_opt</span> <span class="n">IMFMediaType</span><span class="o">*</span> <span class="n">pMediaType</span><span class="p">,</span> <span class="n">__RPC__deref_out_opt</span> <span class="n">IMFStreamSink</span><span class="o">**</span> <span class="n">ppStreamSink</span><span class="p">)</span><span class="n">override</span><span class="p">;</span>
<span class="n">STDMETHODIMP</span> <span class="n">GetCharacteristics</span><span class="p">(</span><span class="n">__RPC__out</span> <span class="n">DWORD</span><span class="o">*</span> <span class="n">pdwCharacteristics</span><span class="p">)</span><span class="n">override</span><span class="p">;</span>
<span class="n">STDMETHODIMP</span> <span class="n">GetPresentationClock</span><span class="p">(</span><span class="n">__RPC__deref_out_opt</span> <span class="n">IMFPresentationClock</span><span class="o">**</span> <span class="n">ppPresentationClock</span><span class="p">)</span><span class="n">override</span><span class="p">;</span>
<span class="n">STDMETHODIMP</span> <span class="n">GetStreamSinkById</span><span class="p">(</span><span class="n">DWORD</span> <span class="n">dwIdentifier</span><span class="p">,</span> <span class="n">__RPC__deref_out_opt</span> <span class="n">IMFStreamSink</span><span class="o">**</span> <span class="n">ppStreamSink</span><span class="p">)</span><span class="n">override</span><span class="p">;</span>
<span class="n">STDMETHODIMP</span> <span class="n">GetStreamSinkByIndex</span><span class="p">(</span><span class="n">DWORD</span> <span class="n">dwIndex</span><span class="p">,</span> <span class="n">__RPC__deref_out_opt</span> <span class="n">IMFStreamSink</span><span class="o">**</span> <span class="n">ppStreamSink</span><span class="p">)</span><span class="n">override</span><span class="p">;</span>
<span class="n">STDMETHODIMP</span> <span class="n">GetStreamSinkCount</span><span class="p">(</span><span class="n">__RPC__out</span> <span class="n">DWORD</span><span class="o">*</span> <span class="n">pcStreamSinkCount</span><span class="p">)</span><span class="n">override</span><span class="p">;</span>
<span class="n">STDMETHODIMP</span> <span class="n">RemoveStreamSink</span><span class="p">(</span><span class="n">DWORD</span> <span class="n">dwStreamSinkIdentifier</span><span class="p">)</span><span class="n">override</span><span class="p">;</span>
<span class="n">STDMETHODIMP</span> <span class="n">SetPresentationClock</span><span class="p">(</span><span class="n">__RPC__in_opt</span> <span class="n">IMFPresentationClock</span><span class="o">*</span> <span class="n">pPresentationClock</span><span class="p">)</span><span class="n">override</span><span class="p">;</span>
<span class="n">STDMETHODIMP</span> <span class="n">Shutdown</span><span class="p">(</span><span class="n">void</span><span class="p">)</span><span class="n">override</span><span class="p">;</span>
</pre>
<p>};</p>
<p>STDAPI CreateCustomVideoRenderer(REFIID riid, void **ppvObject)
{
    if(!ppvObject){
        return E_FAIL;
    }</p>
<pre class="code literal-block"><span class="nv">auto</span> <span class="nv">sink</span><span class="o">=</span><span class="nv">new</span> <span class="nv">CustomVideoRenderer</span><span class="ss">()</span><span class="c1">;</span>
<span class="o">*</span><span class="nv">ppvObject</span><span class="o">=</span><span class="nv">sink</span><span class="c1">;</span>
<span class="k">return</span> <span class="nv">S_OK</span><span class="c1">;</span>
</pre>
<p>}</p>
<p>ä½¿ã†
IMFStreamSinkã‹ã‚‰IMFTopologyNodeã‚’ä½œã‚‹ã€‚</p>
<p>Creating Output Nodes</p>
<pre class="code literal-block"><span class="nt">Microsoft</span><span class="p">::</span><span class="nd">WRL</span><span class="p">::</span><span class="nd">ComPtr</span><span class="o">&lt;</span><span class="nt">IMFTopologyNode</span><span class="o">&gt;</span> <span class="nt">pOutputNode</span><span class="o">;</span>
<span class="nt">if</span><span class="o">(</span><span class="nt">FAILED</span><span class="o">(</span><span class="nt">hr</span> <span class="o">=</span> <span class="nt">MFCreateTopologyNode</span><span class="o">(</span><span class="nt">MF_TOPOLOGY_OUTPUT_NODE</span><span class="o">,</span> <span class="o">&amp;</span><span class="nt">pOutputNode</span><span class="o">)))</span>
<span class="p">{</span>
    <span class="err">return</span> <span class="err">hr</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">Microsoft</span><span class="p">::</span><span class="nd">WRL</span><span class="p">::</span><span class="nd">ComPtr</span><span class="o">&lt;</span><span class="nt">IMFMediaSink</span><span class="o">&gt;</span> <span class="nt">pSink</span><span class="o">;</span>
<span class="o">//</span> <span class="nt">è‡ªå‰ã®IMFMediaSinkã‚’ä½œã‚‹</span>
<span class="nt">if</span><span class="o">(</span><span class="nt">FAILED</span><span class="o">(</span><span class="nt">hr</span><span class="o">=</span><span class="nt">CreateCustomVideoRenderer</span><span class="o">(</span><span class="nt">IID_PPV_ARGS</span><span class="o">(&amp;</span><span class="nt">pSink</span><span class="o">))))</span><span class="p">{</span>
    <span class="err">return</span> <span class="err">hr</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">Microsoft</span><span class="p">::</span><span class="nd">WRL</span><span class="p">::</span><span class="nd">ComPtr</span><span class="o">&lt;</span><span class="nt">IMFStreamSink</span><span class="o">&gt;</span> <span class="nt">pSSink</span><span class="o">;</span>
<span class="nt">if</span><span class="o">(</span><span class="nt">FAILED</span><span class="o">(</span><span class="nt">hr</span><span class="o">=</span><span class="nt">pSink-</span><span class="o">&gt;</span><span class="nt">GetStreamSinkByIndex</span><span class="o">(</span><span class="nt">0</span><span class="o">,</span> <span class="o">&amp;</span><span class="nt">pSSink</span><span class="o">)))</span><span class="p">{</span>
    <span class="err">//</span> <span class="err">ã¾ã ä½œã£ã¦ã„ãªã„ã®ã§ã“ã“ã§ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹</span>
    <span class="err">return</span> <span class="err">hr</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">if</span> <span class="o">(</span><span class="nt">FAILED</span><span class="o">(</span><span class="nt">hr</span> <span class="o">=</span> <span class="nt">pOutputNode-</span><span class="o">&gt;</span><span class="nt">SetObject</span><span class="o">(</span><span class="nt">pSSink</span><span class="p">.</span><span class="nc">Get</span><span class="o">())))</span>
<span class="p">{</span>
    <span class="err">return</span> <span class="err">hr</span><span class="p">;</span>
<span class="p">}</span>
</pre>
<p>IMFStreamSinkãŒã²ã¨ã¤ã¯å¿…è¦
ä½œã‚‹ã€‚
class CustomVideoStreamSink: public IMFStreamSink
{
    ULONG m_nRefCount = 1;</p>
<pre class="code literal-block"><span class="k">const</span> <span class="n">DWORD</span>                 <span class="n">STREAM_ID</span><span class="p">;</span>
<span class="n">CCritSec</span><span class="o">&amp;</span>                   <span class="n">m_critSec</span><span class="p">;</span>                      <span class="o">//</span> <span class="n">critical</span> <span class="n">section</span> <span class="k">for</span> <span class="n">thread</span> <span class="n">safety</span>
<span class="n">Microsoft</span><span class="p">::</span><span class="n">WRL</span><span class="p">::</span><span class="n">ComPtr</span><span class="o">&lt;</span><span class="n">IMFMediaSink</span><span class="o">&gt;</span>               <span class="n">m_pSink</span><span class="p">;</span>
</pre>
<p>public:
    CustomVideoStreamSink(DWORD dwStreamId, CCritSec&amp; critSec
            , IMFMediaSink *parent)
        : STREAM_ID(dwStreamId)
          , m_critSec(critSec)
          , m_pSink(parent)
    {
    }</p>
<pre class="code literal-block"><span class="o">//</span> <span class="n">IUnknown</span>
<span class="n">STDMETHODIMP_</span><span class="p">(</span><span class="n">ULONG</span><span class="p">)</span> <span class="n">AddRef</span><span class="p">(</span><span class="n">void</span><span class="p">)</span><span class="n">override</span><span class="p">;</span>
<span class="n">STDMETHODIMP</span> <span class="n">QueryInterface</span><span class="p">(</span><span class="n">REFIID</span> <span class="n">iid</span><span class="p">,</span> <span class="n">__RPC__deref_out</span> <span class="n">_Result_nullonfailure_</span> <span class="n">void</span><span class="o">**</span> <span class="n">ppv</span><span class="p">)</span><span class="n">override</span><span class="p">;</span>
<span class="n">STDMETHODIMP_</span><span class="p">(</span><span class="n">ULONG</span><span class="p">)</span> <span class="n">Release</span><span class="p">(</span><span class="n">void</span><span class="p">)</span><span class="n">override</span><span class="p">;</span>

<span class="o">//</span> <span class="n">IMFStreamSink</span>
<span class="n">STDMETHODIMP</span> <span class="n">Flush</span><span class="p">(</span><span class="n">void</span><span class="p">)</span><span class="n">override</span><span class="p">;</span>
<span class="n">STDMETHODIMP</span> <span class="n">GetIdentifier</span><span class="p">(</span><span class="n">__RPC__out</span> <span class="n">DWORD</span><span class="o">*</span> <span class="n">pdwIdentifier</span><span class="p">)</span><span class="n">override</span><span class="p">;</span>
<span class="n">STDMETHODIMP</span> <span class="n">GetMediaSink</span><span class="p">(</span><span class="n">__RPC__deref_out_opt</span> <span class="n">IMFMediaSink</span><span class="o">**</span> <span class="n">ppMediaSink</span><span class="p">)</span><span class="n">override</span><span class="p">;</span>
<span class="n">STDMETHODIMP</span> <span class="n">GetMediaTypeHandler</span><span class="p">(</span><span class="n">__RPC__deref_out_opt</span> <span class="n">IMFMediaTypeHandler</span><span class="o">**</span> <span class="n">ppHandler</span><span class="p">)</span><span class="n">override</span><span class="p">;</span>
<span class="n">STDMETHODIMP</span> <span class="n">PlaceMarker</span><span class="p">(</span><span class="n">MFSTREAMSINK_MARKER_TYPE</span> <span class="n">eMarkerType</span><span class="p">,</span> <span class="n">__RPC__in</span> <span class="k">const</span> <span class="n">PROPVARIANT</span><span class="o">*</span> <span class="n">pvarMarkerValue</span><span class="p">,</span> <span class="n">__RPC__in</span> <span class="k">const</span> <span class="n">PROPVARIANT</span><span class="o">*</span> <span class="n">pvarContextValue</span><span class="p">)</span><span class="n">override</span><span class="p">;</span>
<span class="n">STDMETHODIMP</span> <span class="n">ProcessSample</span><span class="p">(</span><span class="n">__RPC__in_opt</span> <span class="n">IMFSample</span><span class="o">*</span> <span class="n">pSample</span><span class="p">)</span><span class="n">override</span><span class="p">;</span>

<span class="o">//</span> <span class="n">IMFMediaEventGenerator</span> <span class="p">(</span><span class="n">from</span> <span class="n">IMFStreamSink</span><span class="p">)</span>
<span class="n">STDMETHODIMP</span> <span class="n">BeginGetEvent</span><span class="p">(</span><span class="n">IMFAsyncCallback</span><span class="o">*</span> <span class="n">pCallback</span><span class="p">,</span><span class="n">IUnknown</span><span class="o">*</span> <span class="n">punkState</span><span class="p">)</span><span class="n">override</span><span class="p">;</span>
<span class="n">STDMETHODIMP</span> <span class="n">EndGetEvent</span><span class="p">(</span><span class="n">IMFAsyncResult</span><span class="o">*</span> <span class="n">pResult</span><span class="p">,</span> <span class="n">_Out_</span> <span class="n">IMFMediaEvent</span><span class="o">**</span> <span class="n">ppEvent</span><span class="p">)</span><span class="n">override</span><span class="p">;</span>
<span class="n">STDMETHODIMP</span> <span class="n">GetEvent</span><span class="p">(</span><span class="n">DWORD</span> <span class="n">dwFlags</span><span class="p">,</span> <span class="n">__RPC__deref_out_opt</span> <span class="n">IMFMediaEvent</span><span class="o">**</span> <span class="n">ppEvent</span><span class="p">)</span><span class="n">override</span><span class="p">;</span>
<span class="n">STDMETHODIMP</span> <span class="n">QueueEvent</span><span class="p">(</span><span class="n">MediaEventType</span> <span class="n">met</span><span class="p">,</span> <span class="n">__RPC__in</span> <span class="n">REFGUID</span> <span class="n">guidExtendedType</span><span class="p">,</span> <span class="n">HRESULT</span> <span class="n">hrStatus</span><span class="p">,</span> <span class="n">__RPC__in_opt</span> <span class="k">const</span> <span class="n">PROPVARIANT</span><span class="o">*</span> <span class="n">pvValue</span><span class="p">)</span><span class="n">override</span><span class="p">;</span>
</pre>
<p>};</p>
<p>ãƒ¡ã‚½ãƒƒãƒ‰ã®ä¸­èº«ã¯
return E_FAIL;</p>
<p>ã§ãŠèŒ¶ã‚’æ¿ã—ãŸã€‚
IMFMediaSink::AddStreamSinkå®Ÿè£…
IMFMediaSink::GetStreamSinkByIdå®Ÿè£…
IMFMediaSink::GetStreamSinkByIndexå®Ÿè£…
IMFMediaSink::GetStreamSinkCountå®Ÿè£…
IMFMediaSink::RemoveStreamSinkå®Ÿè£…
å®Ÿè¡Œã—ã¦ã¿ã‚‹ã€‚
// Handler for Media Session events.
void OnPlayerEvent(HWND hwnd, WPARAM pUnkPtr)
{
    HRESULT hr = g_pPlayer-&gt;HandleEvent(pUnkPtr);
    if (FAILED(hr))
    {
        // ã“ã“ã«æ¥ã‚‹
        NotifyError(hwnd, L"An error occurred.", hr);
    }
    UpdateUI(hwnd, g_pPlayer-&gt;GetState());
}</p>
<pre class="code literal-block"><span class="c1">// Get the event status. If the operation that triggered the event </span>
<span class="c1">// did not succeed, the status is a failure code.</span>
<span class="n">HRESULT</span> <span class="n">hrStatus</span> <span class="o">=</span> <span class="n">S_OK</span><span class="p">;</span>
<span class="n">hr</span> <span class="o">=</span> <span class="n">pEvent</span><span class="o">-&gt;</span><span class="n">GetStatus</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hrStatus</span><span class="p">);</span>

<span class="c1">// Check if the async operation succeeded.</span>
<span class="nf">if</span> <span class="p">(</span><span class="n">SUCCEEDED</span><span class="p">(</span><span class="n">hr</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">FAILED</span><span class="p">(</span><span class="n">hrStatus</span><span class="p">))</span> 
<span class="p">{</span>
    <span class="c1">// ã“ã“ã«æ¥ã‚‹</span>
    <span class="n">hr</span><span class="o">=</span><span class="n">hrStatus</span><span class="p">;</span>
<span class="p">}</span>
</pre>
<p>ãƒ‡ãƒãƒƒã‚¬ã§èª¿ã¹ãŸã‚‰IMFStreamSink::GetMediaSinkã®ç›´å¾Œã«ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹ã“ã¨ãŒã‚ã‹ã£ãŸã€‚
IMFStreamSink::GetMediaSinkå®Ÿè£…
ãŸã‚“ãŸã‚“ã¨ã‚¨ãƒ©ãƒ¼ã‚’ç›´ã—ã¦ã„ãã€‚
IMFStreamSink::GetMediaTypeHandlerå®Ÿè£…
HRESULT DX11VideoRenderer::CStreamSink::GetMediaTypeHandler(__RPC__deref_out_opt IMFMediaTypeHandler** ppHandler)
{
    CAutoLock lock(&amp;m_critSec);</p>
<pre class="code literal-block"><span class="nf">if</span> <span class="p">(</span><span class="n">ppHandler</span> <span class="o">==</span> <span class="n">NULL</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kr">return</span> <span class="n">E_POINTER</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">HRESULT</span> <span class="n">hr</span> <span class="o">=</span> <span class="n">CheckShutdown</span><span class="p">();</span>

<span class="c1">// This stream object acts as its own type handler, so we QI ourselves.</span>
<span class="nf">if</span> <span class="p">(</span><span class="n">SUCCEEDED</span><span class="p">(</span><span class="n">hr</span><span class="p">))</span>
<span class="p">{</span>
    <span class="n">hr</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">QueryInterface</span><span class="p">(</span><span class="n">IID_IMFMediaTypeHandler</span><span class="p">,</span> <span class="p">(</span><span class="n">void</span><span class="o">**</span><span class="p">)</span><span class="n">ppHandler</span><span class="p">);</span>
<span class="p">}</span>

<span class="kr">return</span> <span class="n">hr</span><span class="p">;</span>
</pre>
<p>}</p>
<p>IMFMediaTypeHandlerãŒå¿…è¦ã€‚
StreamSinkã«IMFMediaTypeHandlerã‚’å®Ÿè£…
ã“ã®ã‚¤ãƒ³ã‚¿ãƒ•ã‚§ãƒ¼ã‚¹ã¯StreamSinkãŒå‡¦ç†ã§ãã‚‹MediaTypeã‚’ç¤ºã™ã®ã§å¿…è¦ã€‚
ã‚µãƒãƒ¼ãƒˆã™ã‚‹ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’æ±ºã‚ã‚‹ã€‚
// IMFMediaTypeHandler
STDMETHODIMP GetCurrentMediaType(<em>Outptr</em> IMFMediaType<strong> ppMediaType);
STDMETHODIMP GetMajorType(__RPC__out GUID* pguidMajorType);
STDMETHODIMP GetMediaTypeByIndex(DWORD dwIndex, <em>Outptr</em> IMFMediaType</strong> ppType);
STDMETHODIMP GetMediaTypeCount(__RPC__out DWORD<em> pdwTypeCount);
STDMETHODIMP IsMediaTypeSupported(IMFMediaType</em> pMediaType, <em>Outptr_opt_result_maybenull</em> IMFMediaType*<em> ppMediaType);
STDMETHODIMP SetCurrentMediaType(IMFMediaType</em> pMediaType);</p>
<p>PresentationClockãŒå¿…è¦</p>
<p>Presentation Clock</p>
<p>IMFMediaSink::GetPresentationClockå®Ÿè£…
IMFMediaSink::SetPresentationClockå®Ÿè£…
MediaSinkã«IMFClockStateSinkã‚’å®Ÿè£…
// IMFClockStateSink methods
STDMETHODIMP OnClockPause(MFTIME hnsSystemTime);
STDMETHODIMP OnClockRestart(MFTIME hnsSystemTime);
STDMETHODIMP OnClockSetRate(MFTIME hnsSystemTime, float flRate);
STDMETHODIMP OnClockStart(MFTIME hnsSystemTime, LONGLONG llClockStartOffset);
STDMETHODIMP OnClockStop(MFTIME hnsSystemTime);</p>
<p>Data Flow
ã“ã“ã¾ã§ã®å®Ÿè£…ã§IMFSession::Startã®å‘¼ã³å‡ºã—ã«å¿œã˜ã¦IMFClockStateSink::OnClockStartãŒå‘¼ã°ã‚Œã‚‹ã‚ˆã†ã«ãªã£ãŸã€‚
Data Flow</p>
<p>Media sinks use a pull model</p>
<p>MesiaSinkå´ã‹ã‚‰ã‚µãƒ³ãƒ—ãƒ«ã‚’å–ã‚Šã«è¡Œã‹ãªã„ã¨ã„ã‘ãªã„ã€‚</p>
<p>[1] The client sets the media types and the presentation clock. The media sink registers itself with the presentation clock to receive notifications about clock state changes.
[2][3][4] ã¯Prerollã€‚ãƒŸãƒ‹ãƒãƒ ã‚’ç›®æŒ‡ã™ä»Šå›ã¯çœç•¥ã€‚
[5] The client calls IMFPresentationClock::Start to start the presentation clock.
[6] The presentation clock notifies the media sink that the clock is starting, by calling IMFClockStateSink::OnClockStart.
[7] To get more data, each stream sink sends MEStreamSinkRequestSample events. In response to each of these events, the client gets the next sample and calls ProcessSample. This step is repeated until the presentation ends.</p>
<p>State Changes
IMFClockStateSinkã®å®Ÿè£…ã«ã¤ã„ã¦ã€‚</p>
<p>In addition, stream sinks must send the following events when they have completed the state transitions:</p>
<p>OnClockStart, OnClockRestart: MEStreamSinkStarted event
OnClockPause: MEStreamSinkPaused event
OnClockStop: MEStreamSinkStopped event</p>
<p>ãªã‚‹ã»ã©ã€‚
STDMETHODIMP OnClockStart(MFTIME hnsSystemTime, LONGLONG llClockStartOffset)override
{
    CAutoLock lock(&amp;m_csMediaSink);</p>
<pre class="code literal-block"><span class="n">HRESULT</span> <span class="n">hr</span> <span class="o">=</span> <span class="n">CheckShutdown</span><span class="p">();</span>
<span class="nf">if</span> <span class="p">(</span><span class="n">SUCCEEDED</span><span class="p">(</span><span class="n">hr</span><span class="p">))</span>
<span class="p">{</span>
    <span class="c1">//</span>
    <span class="c1">// ã“ã‚ŒãŒå¿…è¦ã€‚ã“ã®ã‚ã¨MEStreamSinkRequestSampleã‚’å—ã‘ä»˜ã‘ã‚‹</span>
    <span class="c1">//</span>
    <span class="n">hr</span> <span class="o">=</span> <span class="n">m_pStream</span><span class="o">-&gt;</span><span class="n">QueueEvent</span><span class="p">(</span><span class="n">MEStreamSinkStarted</span><span class="p">,</span> <span class="n">GUID_NULL</span><span class="p">,</span> <span class="n">hr</span><span class="p">,</span> <span class="n">NULL</span><span class="p">);</span>
<span class="p">}</span>
<span class="nf">if</span> <span class="p">(</span><span class="n">SUCCEEDED</span><span class="p">(</span><span class="n">hr</span><span class="p">))</span>
<span class="p">{</span>
    <span class="n">hr</span> <span class="o">=</span> <span class="n">m_pStream</span><span class="o">-&gt;</span><span class="n">QueueEvent</span><span class="p">(</span><span class="n">MEStreamSinkRequestSample</span><span class="p">,</span> <span class="n">GUID_NULL</span><span class="p">,</span> <span class="n">hr</span><span class="p">,</span> <span class="n">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="kr">return</span> <span class="n">hr</span><span class="p">;</span>
</pre>
<p>}</p>
<p>ã¤ã„ã«IMFStreamSink::ProcessSampleãŒã‚³ãƒ¼ãƒ«ã•ã‚ŒãŸã€‚
è©¦ã—ã«ä¸‹è¨˜ã®ã‚ˆã†ãªå®Ÿè£…ã«ã—ã¦ã¿ãŸãŒã“ã‚Œã§ã¯Clockç„¡è¦–ã§æœ€é€Ÿã§ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’æ¶ˆåŒ–ã—ã¦ã—ã¾ã†ã®ã§ã ã‚ã€‚
int m_count = 0;
STDMETHODIMP ProcessSample(__RPC__in_opt IMFSample* pSample)override
{
    ++m_count;</p>
<pre class="code literal-block"><span class="nv">auto</span> <span class="nv">hr</span> <span class="o">=</span> <span class="nv">S_OK</span><span class="c1">;</span>
<span class="nv">hr</span> <span class="o">=</span> <span class="nv">QueueEvent</span><span class="ss">(</span><span class="nv">MEStreamSinkRequestSample</span>, <span class="nv">GUID_NULL</span>, <span class="nv">hr</span>, <span class="nv">NULL</span><span class="ss">)</span><span class="c1">;</span>

<span class="k">return</span> <span class="nv">hr</span><span class="c1">;</span>
</pre>
<p>}</p>
<p>MEStreamSinkRequestSampleã‚’ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°ã™ã‚‹</p>
<p>Scheduled Work Items</p>
<p>ã“ã‚Œã‚’ä½¿ã£ã¦ã¿ã‚‹ã€‚
BOOL NeedMoreSamples(void)
{
    const DWORD cSamplesInFlight = /<em>m_SamplesToProcess.GetCount() +</em>/ m_cOutstandingSampleRequests;</p>
<pre class="code literal-block"><span class="k">return</span> <span class="nv">cSamplesInFlight</span> <span class="o">&lt;</span> <span class="nv">SAMPLE_QUEUE_HIWATER_THRESHOLD</span><span class="c1">;</span>
</pre>
<p>}</p>
<p>HRESULT RequestSamples(IMFAsyncResult* pAsyncResult)
{
    HRESULT hr = S_OK;</p>
<pre class="code literal-block"><span class="k">while</span> <span class="ss">(</span><span class="nv">NeedMoreSamples</span><span class="ss">())</span>
{
    <span class="nv">hr</span> <span class="o">=</span> <span class="nv">CheckShutdown</span><span class="ss">()</span><span class="c1">;</span>
    <span class="k">if</span> <span class="ss">(</span><span class="nv">FAILED</span><span class="ss">(</span><span class="nv">hr</span><span class="ss">))</span>
    {
        <span class="k">break</span><span class="c1">;</span>
    }

    <span class="nv">m_cOutstandingSampleRequests</span><span class="o">++</span><span class="c1">;</span>

    <span class="nv">hr</span> <span class="o">=</span> <span class="nv">QueueEvent</span><span class="ss">(</span><span class="nv">MEStreamSinkRequestSample</span>, <span class="nv">GUID_NULL</span>, <span class="nv">S_OK</span>, <span class="nv">NULL</span><span class="ss">)</span><span class="c1">;</span>
}

<span class="o">//</span> å†çªå…¥
<span class="nv">hr</span><span class="o">=</span><span class="nv">QueueRequest</span><span class="ss">()</span><span class="c1">;</span>

<span class="k">return</span> <span class="nv">hr</span><span class="c1">;</span>
</pre>
<p>}</p>
<p>// æ­£ã—ã„Rateã«ã™ã‚‹å¿…è¦ãŒã‚ã‚‹
const INT64 interval = 1000 / 30;</p>
<p>HRESULT QueueRequest()
{
    HRESULT hr = S_OK;</p>
<pre class="code literal-block"><span class="k">if</span> <span class="ss">(</span><span class="nv">SUCCEEDED</span><span class="ss">(</span><span class="nv">hr</span><span class="ss">))</span>
{
    <span class="o">//</span> <span class="nv">Enqueue</span>
    <span class="nv">MFWORKITEM_KEY</span> <span class="nv">cancelKey</span><span class="c1">;</span>
    <span class="nv">hr</span> <span class="o">=</span> <span class="nv">MFScheduleWorkItem</span><span class="ss">(</span><span class="o">&amp;</span><span class="nv">m_WorkQueueCB</span>, <span class="nv">nullptr</span>, <span class="o">-</span><span class="nv">interval</span>, <span class="o">&amp;</span><span class="nv">cancelKey</span><span class="ss">)</span><span class="c1">;</span>
}

<span class="k">return</span> <span class="nv">hr</span><span class="c1">;</span>
</pre>
<p>}</p>
<p>int m_count = 0;
STDMETHODIMP ProcessSample(__RPC__in_opt IMFSample* pSample)override
{
    ++m_count;</p>
<pre class="code literal-block"><span class="nv">m_cOutstandingSampleRequests</span><span class="o">--</span><span class="c1">;</span>

<span class="o">//</span> <span class="k">do</span> <span class="nv">something</span>

<span class="k">return</span>  <span class="nv">S_OK</span><span class="c1">;</span>
</pre>
<p>}</p>
<p>DX11VideoRenderer::CSchedulerã‚’ä½¿ãˆã°ã‚ˆã„ã¨æ€ã†ã€‚
ã ã„ãŸã„ä»•çµ„ã¿ãŒã‚ã‹ã£ãŸã€‚
DX11VideoRendererã‹ã‚‰å¼•ãç®—ã—ã¦æœ€å°é™ã®æ§‹æˆã«ã™ã‚‹(ProcessSampleãŒä½•ã‚‚ã—ãªã„)å ´åˆã€
ä»¥ä¸‹ã®éƒ¨å“ã‚’æ®‹ã™å¿…è¦ãŒã‚ã‚Šãã†ã€‚</p>
<p>Scheduler
StreamSink: IMFStreamSink, IMFMediaTypeHandler
MesiaSink: IMFMediaSink, IMFClockStateSink</p>

<hr>
<ul class="pager hidden-print">
<li class="previous">
        <a href="../../../../github/mediafoundationsample/" rel="prev" title="MediaFoundationSample">
            MediaFoundationSample ğŸ‘ˆ
        </a>
    </li>
    <li style="flex-grow: 1">
    <li class="next">
        <a href="../mediasink_use_dxva/" rel="next" title="MediaSinkã§DXVA">
            ğŸ‘‰ MediaSinkã§DXVA
        </a>
    </li>
</ul></main><footer id="footer"><p>
            Powered by
            <a href="https://getnikola.com" rel="nofollow">Nikola</a>
        </p>
    </footer>
</body>
</html>
