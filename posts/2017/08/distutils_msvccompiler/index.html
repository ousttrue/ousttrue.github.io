<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="generator" content="Nikola (getnikola.com)">
<meta name="viewport" content="width=device-width">
<script src="../../../../assets/js/all-nocdn.js"></script><title>distutilsでcl.exeが見つからない | 三次元日誌</title>
<link href="../../../../assets/css/code.css" rel="stylesheet" type="text/css">
<link href="../../../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
</head>
<body>
    <h1 id="brand">
        <a href="../../../../" title="三次元日誌" rel="home">
            <span id="blog-title">三次元日誌</span>
        </a>
    </h1>

    <nav id="menu"><ul>
<li><a href="../../../../archive.html">Archives</a></li>
<li><a href="../../../../categories/index.html">Tags</a></li>
<li><a href="../../../../rss.xml">RSS feed</a></li>
<li><a href="../../../../about">About</a></li>
<li><a href="../../../../books">MemoBooks</a></li>

            
            
            
        </ul></nav><hr>
<main id="content"><h1 class="p-name entry-title" itemprop="headline name">
    <h1 class="p-name entry-title" itemprop="headline name">
    <a href="." class="u-url">distutilsでcl.exeが見つからない
    </a>
</h1>
<ul itemprop="keywords" class="tags">
<li>
        <time datetime="2017-08-06T00:00:00+09:00" title="2017-08-06">2017-08-06</time>
</li>
    <li><a class="tag p-category" href="../../../../categories/python/" rel="tag">python</a></li>
</ul>
</h1>

<p>PythonじゃなくてVisualStudio側の問題のようなのだけど、setup.pyでネイティブモジュールをビルドするときに顕在化したので。</p>
<p>こういう感じのネイティブモジュールを作った。
from distutils.core import setup, Extension</p>
<p>imgui_module = Extension('_swig_imgui',
        sources=[
            #'imgui_wrap.cxx',
            'imgui.i',
            'imgui/imgui.cpp',
            'imgui/imgui_draw.cpp',
            'imgui/imgui_demo.cpp',
            ],
        swig_opts=[
            #'-modern',
            '-c++',
            '-py3',
            ]
        )</p>
<p>setup (name = 'swig_imgui',
        version = '0.1',
        author      = "ousttrue",
        description = """imgui wrapper using swig""",
        ext_modules = [imgui_module],
        py_modules = ["swig_imgui"],
        )</p>
<blockquote>
<p>python setup.py build</p>
</blockquote>
<p>とするとエラーになる。
Windows10(64bit)上のvs2017 + vcbuildtoolsの組み合わせの環境である。
cl.exe /c /nologo /Ox /W3 /GL /DNDEBUG /MD -ID:\Anaconda3\include -ID:\Anaconda3\include /EHsc /Tpimgui_wrap.cpp /Fobuild\temp.win-amd64-3.6\Release\imgui_wrap.obj
error: command 'cl.exe' failed: No such file or directory</p>
<p>distutilsがcl.exeを探すのに失敗しているようなのである。
lib/distutils下を調べてみた。
どうやらlib/distutils/_msvccompiler.pyでvcvarsall.batから環境変数を得ることに失敗しているらしい。
実際、C:\Program Files (x86)\Microsoft Visual Studio\Shared\14.0\VC\vcvarsall.batの呼び出しが失敗していることを突き止めた。
Error in script usage. The correct usage is:
    "C:\Program Files (x86)\Microsoft Visual Studio\Shared\14.0\VC\vcvarsall.bat" [option]
  or
    "C:\Program Files (x86)\Microsoft Visual Studio\Shared\14.0\VC\vcvarsall.bat" [option] store
  or
    "C:\Program Files (x86)\Microsoft Visual Studio\Shared\14.0\VC\vcvarsall.bat" [option] [version number]
  or
    "C:\Program Files (x86)\Microsoft Visual Studio\Shared\14.0\VC\vcvarsall.bat" [option] store [version number]
where [option] is: x86 | amd64 | arm | x86_amd64 | x86_arm | amd64_x86 | amd64_arm
where [version number] is either the full Windows 10 SDK version number or "8.1" to use the windows 8.1 SDK
:
The store parameter sets environment variables to support
  store (rather than desktop) development.
:
For example:
    "C:\Program Files (x86)\Microsoft Visual Studio\Shared\14.0\VC\vcvarsall.bat" x86_amd64
    "C:\Program Files (x86)\Microsoft Visual Studio\Shared\14.0\VC\vcvarsall.bat" x86_arm store
    "C:\Program Files (x86)\Microsoft Visual Studio\Shared\14.0\VC\vcvarsall.bat" x86_amd64 10.0.10240.0
    "C:\Program Files (x86)\Microsoft Visual Studio\Shared\14.0\VC\vcvarsall.bat" x86_arm store 10.0.10240.0
    "C:\Program Files (x86)\Microsoft Visual Studio\Shared\14.0\VC\vcvarsall.bat" x64 8.1
    "C:\Program Files (x86)\Microsoft Visual Studio\Shared\14.0\VC\vcvarsall.bat" x64 store 8.1</p>
<p>コマンドラインから実行しても失敗していて、vcvarsall.batに以下のコードがあるのだが、
:setup_buildsku
if not exist "%~dp0......\Microsoft Visual C++ Build Tools\vcbuildtools.bat" goto usage
set CurrentDir=%CD%
call "%~dp0......\Microsoft Visual C++ Build Tools\vcbuildtools.bat" %1 %2
cd /d %CurrentDir%
goto :eof</p>
<p>C:\Program Files (x86)\Microsoft Visual Studio\Shared\14.0\VC\vcvarsall.bat
から
C:\Program Files (x86)\Microsoft Visual C++ Build Tools\vcbuildtools.bat"
への相対パスだと一致しないよなーと。
これが原因でcl.exeのパスが取れない。
setup.pyにモンキーパッチを当ててcl.exeを発見できるようにしてみた。
以下をsetup.pyの先頭に追加。</p>
<h2>monkey patch for _msvccompiler</h2>
<p>import distutils._msvccompiler
import os
import subprocess
def _get_vc_env(plat_spec):
    if os.getenv("DISTUTILS_USE_SDK"):
        return {
            key.lower(): value
            for key, value in os.environ.items()
        }</p>
<pre class="code literal-block"><span class="n">vcvarsall</span><span class="p">,</span> <span class="n">vcruntime</span> <span class="o">=</span> <span class="n">distutils</span><span class="o">.</span><span class="n">_msvccompiler</span><span class="o">.</span><span class="n">_find_vcvarsall</span><span class="p">(</span><span class="n">plat_spec</span><span class="p">)</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">vcvarsall</span><span class="p">:</span>
    <span class="n">raise</span> <span class="n">DistutilsPlatformError</span><span class="p">(</span><span class="s2">"Unable to find vcvarsall.bat"</span><span class="p">)</span>

<span class="n">try</span><span class="p">:</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span>
        <span class="s1">'cmd /u /c "{}" {} &amp;&amp; set'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">vcvarsall</span><span class="p">,</span> <span class="n">plat_spec</span><span class="p">),</span>
        <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">STDOUT</span><span class="p">,</span>
    <span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">'utf-16le'</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">'replace'</span><span class="p">)</span>
    <span class="c1">#######################################################################</span>
    <span class="k">if</span> <span class="n">out</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">"Error in script usage"</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span>
            <span class="s1">'cmd /u /c "{}" {} &amp;&amp; set'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">"C:</span><span class="se">\\</span><span class="s2">Program Files (x86)</span><span class="se">\\</span><span class="s2">Microsoft Visual C++ Build Tools</span><span class="se">\\</span><span class="s2">vcbuildtools.bat"</span><span class="p">,</span> <span class="n">plat_spec</span><span class="p">),</span>
            <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">STDOUT</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">'utf-16le'</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">'replace'</span><span class="p">)</span>
    <span class="c1">#######################################################################</span>
<span class="n">except</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">CalledProcessError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
    <span class="nb">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">exc</span><span class="o">.</span><span class="n">output</span><span class="p">)</span>
    <span class="n">raise</span> <span class="n">DistutilsPlatformError</span><span class="p">(</span><span class="s2">"Error executing {}"</span>
            <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">exc</span><span class="o">.</span><span class="n">cmd</span><span class="p">))</span>

<span class="n">env</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span> <span class="n">value</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span>
    <span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s1">'='</span><span class="p">)</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">out</span><span class="o">.</span><span class="n">splitlines</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">key</span> <span class="ow">and</span> <span class="n">value</span>
<span class="p">}</span>

<span class="k">if</span> <span class="n">vcruntime</span><span class="p">:</span>
    <span class="n">env</span><span class="p">[</span><span class="s1">'py_vcruntime_redist'</span><span class="p">]</span> <span class="o">=</span> <span class="n">vcruntime</span>
<span class="k">return</span> <span class="n">env</span>
</pre>
<p>distutils._msvccompiler._get_vc_env=_get_vc_env</p>
<p>以前にもこんなことやったことあるような気がする・・・。</p>

<hr>
<ul class="pager hidden-print">
<li class="previous">
        <a href="../../glbufferdata/" rel="prev" title="PyOpenGLのglBufferDataにはどんなデータが渡せるのか">
            PyOpenGLのglBufferDataにはどんなデータが渡せるのか 👈
        </a>
    </li>
    <li style="flex-grow: 1">
    <li class="next">
        <a href="../pyalembic/" rel="next" title="WindowsでPyAlembicできるのか">
            👉 WindowsでPyAlembicできるのか
        </a>
    </li>
</ul></main><footer id="footer"><p>
            Powered by
            <a href="https://getnikola.com" rel="nofollow">Nikola</a>
        </p>
    </footer>
</body>
</html>
