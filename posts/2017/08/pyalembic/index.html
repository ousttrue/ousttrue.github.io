<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <title>三次元日誌</title>

    

  <script src="https://ousttrue.github.io/plugins/elasticlunr.min.js" defer></script>
  <script src="https://ousttrue.github.io/search_index.en.js" defer></script>
  <script src="https://ousttrue.github.io/js/search.js" defer></script>

    

     
    <link rel="stylesheet" href="https://ousttrue.github.io/main.css">
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css"
      />
    
  </head>

  <body class="container">
    <a class="site_title" href="https:&#x2F;&#x2F;ousttrue.github.io&#x2F;">
      <div>三次元日誌</div>
    </a>

    <nav class="nav">
      <a class="item" href="/tags/">tags</a>
      <a class="item" href="https://github.com/ousttrue" aria-label="github">
        <i class="fab fa-github fa-lg"></i>
      </a>
      

        
            <form class="navbar-form">
                <input id="userinput" class="form-control is-search" type="search" placeholder="Search docs..."
                    aria-label="Search docs..." autocomplete="off">
                <div id="suggestions" class="shadow bg-white rounded"></div>
            </form>
        
    </nav>

    <main class="main">
<div class="page">
<div class="content">
  <div class="headline">
  
  

  
  <a class="headline_title" href="https:&#x2F;&#x2F;ousttrue.github.io&#x2F;posts&#x2F;2017&#x2F;08&#x2F;pyalembic&#x2F;"> WindowsでPyAlembicできるのか 
  

  
  </a>

  

  <div>
    <ul class="tags">
      <li class="headline_date">
        <div class="year">2017</div>
        <div class="md">0807</div>
      </li>
      
      


    <li class="tag"><a href="https:&#x2F;&#x2F;ousttrue.github.io&#x2F;tags&#x2F;python&#x2F;">python</a></li>

    <li class="tag"><a href="https:&#x2F;&#x2F;ousttrue.github.io&#x2F;tags&#x2F;cg&#x2F;">cg</a></li>

    <li class="tag"><a href="https:&#x2F;&#x2F;ousttrue.github.io&#x2F;tags&#x2F;cmake&#x2F;">cmake</a></li>




    </ul>
  </div>
</div>
 <p>Windows上でPyAlembicを使いたいのだができるのか。
素直にLinuxでやるべきでは・・・
Windows10(64bit) + Python-3.6(64bit)</p>
<p>作業場。</p>
<p>https://github.com/ousttrue/openexr</p>
<p>Anaconda3(Windows10 64bit)でモジュール探す</p>
<blockquote>
<p>conda install -c conda-forge alembic</p>
</blockquote>
<p>しかし、これは違うAlembicだった。
Pythonのalembicは、database migrations toolと名前が被っております。
なるほど・・・。
Python2.7なら</p>
<p>http://www.lfd.uci.edu/~gohlke/pythonlibs/#pyalembic</p>
<p>あとから発見。わいは、Python3.6にしたいので。
自前でビルドを試みる
alembic-1.7.1/python/PyAlembicがそれですな。
問題が２つある。</p>
<p>Python2(Python3にしたい)
Boost.Python(PyBind11にしてリンク問題とおさらばしたい)</p>
<p>さすがにPyBind11差し替えはやるにしても後にするべきなので、 Python3化だけやる。
Boost.Pythonのビルド
Boost.Pythonで使うPythonを明示するには、user-config.jamに記述する。
BOOST_DIR/user-conifg.jam
using python 
: 3.6                   # Version
: D:\Anaconda3\python.exe      # Python Path
: D:\Anaconda3\include         # include path
: D:\Anaconda3\libs            # lib path(s)
: <define>BOOST_ALL_NO_LIB=1
;</p>
<p>ビルド
boost&gt; b2.exe -j3 --stagedir=stage\x86_64 link=shared runtime-link=shared threading=multi toolset=msvc-14.0 address-model=64 --with-python</p>
<p>link=sharedにしてdllを生成することが必要。
これは、iex.pydとimath.pyd間でBoost.Pythonのstatic変数を共有するために必須である(pyexの型登録周りか)。
IlmBaseを修正
ilmbase-2.2.0/IexMath/IexMathFloatExc.h
の以下の部分を修正する。多分、記述ミスなのだけど誰もWindowsビルドしないので気付かれていないのであろう。
//#if defined(IEX_EXPORTS)↲
#if defined(IEXMATH_EXPORTS)↲</p>
<p>これでilmbaseをビルドしておく。vcpkgを使った。
alembicを修正
alembic-1.7.1/lib/Alembic/AbcCoreLayer/CMakeLists.txtを修正してヘッダを追加する(PyAlembicが使う)
INSTALL(FILES Read.h Util.h
Foundation.h # 追加
DESTINATION include/Alembic/AbcCoreLayer)</p>
<p>これも、vcpkgを使った。
PyIlmBaseのビルド
OpenEXRのサイトにあるpyilmbase-2.2.0tar.gzを使おうとしたのだけど、githubの方が新しいようなのでこちらを使う。
Python3向けの修正
Python2とPytnon3間での非互換によるコンパイルエラーを直していく。</p>
<p>PySliceObject_XXX -&gt; PyObject_XXX
PyInt_XXX -&gt; PyLong_XXX
PyString_AsString -&gt; PyUnicode_AsUTF8
_PyThreadState_Current -&gt; _PyThreadState_UncheckedGet()</p>
<p>参考</p>
<p>Python3 Advent Calendar - Pythonで2/3両方で動くコードを書く(C/API)
Fix build for Python 3.5
http://py3c.readthedocs.io/en/latest/guide.html</p>
<p>CMake設定</p>
<p>CMAKE_INSTALL_PREFIX
BOOST_ROOT
ILMBASE_PACKAGE_PREFIX
FIND_PACKAGE(numpy)をコメントアウト
DebugでもPython36.libにリンクするように、#include &lt;Python.h&gt;を除去(boost/python.hpp経由でインクルードさせればそうなる)</p>
<p>ビルドが通るようになった。
PyAlembicのビルド
当初、AlembicのプロジェクトでPythonフラグを有効にして一緒にビルドしようとしていたが、PyIlmBase傘下にPyAlembicをコピーする方式に変えた。
alembic-1.7.1/python/PyAlembicをilmbase-2.2.0/PyIlmBaseにコピーして、CMakeLists.txtを調整する。
CMake設定</p>
<p>Alembic_ROOT</p>
<p>参考</p>
<p>uimac実装メモ - PyImath</p>
<p>PyAlembicのビルドが通ったので実行してみよう
PyAlembic/Tests/testPolyMesh.pyを動かしてみようと思う。
こういう感じに準備する。
testPolyMesh.py
iex.pyd
PyIex.dll
imath.pyd
PyImath.dll
alembic.lib
alembic.pyd
boost_python-vc140-mt-1_61.dll # debug buildもこれ</p>
<blockquote>
<p>C:/python36/python.exe testPolyMesh.py</p>
</blockquote>
<p>import alembicでクラッシュする。デバッガで追ってみると、モジュールの初期化でエラーが発生している。一個ずつ直す。
初期化の修正
Python3化による変更？
AbcView
今回の作業目標。</p>
<p>http://alembic.github.io/abcview/</p>
<p>これを動作させたい。
AbcView has the following requirements:</p>
<p>Python 2.6+ =&gt; Python 3.6 で動くように改造する(print文とか)
PyAlembic。できた
PyAbcOpenGL。できた
PyOpenGL。pip
argparse。pip
PyQt4。http://www.lfd.uci.edu/~gohlke/pythonlibs/#pyalembic
numpy-mkl。http://www.lfd.uci.edu/~gohlke/pythonlibs/#pyalembic</p>
<p>PyQt4をインストール</p>
<p>https://stackoverflow.com/questions/22640640/how-to-install-pyqt4-on-windows-using-pip
http://www.lfd.uci.edu/~gohlke/pythonlibs/#pyqt4</p>
<p>こんな感じで公式のPython3.6(64bit)に対してインストール。
D:\Python36\Scripts\pip.exe install .\PyQt4-4.11.4-cp36-cp36m-win_amd64.whl</p>
<p>https://www.tutorialspoint.com/pyqt/pyqt_hello_world.htm</p>
<p>import sys
from PyQt4 import QtGui</p>
<p>def window():
app = QtGui.QApplication(sys.argv)
w = QtGui.QWidget()
b = QtGui.QLabel(w)
b.setText(&quot;Hello World!&quot;)
w.setGeometry(100,100,200,50)
b.move(50,20)
w.setWindowTitle(&quot;PyQt&quot;)
w.show()
sys.exit(app.exec_())</p>
<p>if <strong>name</strong> == '<strong>main</strong>':
window()</p>
<p>動いた。
alembicgl.pyd, alembic.pyd, imath.pyd, iex.pydと依存dll群をwheel化する
同じdllを参照するpydを同じフォルダに配置したいので、
共通の親モジュールとしてilmを定義してその中にすべてのpydとdllを収めることにした。
そのうえでこれを間接的にエクスポートするモジュール’iex’, ‘imath’, ‘alembic’, ‘alembicgl’
を作る計画。
ilm
+ <strong>init</strong>.py
+ iex.pyd
+ imath.pyd
+ alembic.pyd
+ alembicgl.pyd
+ PyEx.dll
+ PyImath.dll
+ boost_python.dll
+ Alembic.dll # VCPKG BUILD
+ ilmbase.dll # VCPKG BUILD
+ iex.dll # VCPKG BUILD
+ imath.dll # VCPKG BUILD
+ half.dll # VCPKG BUILD
+ hdf5.dll # VCPKG BUILD
+ zip.dll # VCPKG BUILD
+ szip.dll # VCPKG BUILD
iex
+ <strong>init</strong>.py # ilm.iexを公開
imath
+ <strong>init</strong>.py # ilm.imathを公開
alembic
+ <strong>init</strong>.py # ilm.alembicを公開
alembicgl
+ <strong>init</strong>.py # ilm.alembicglを公開
setup.py</p>
<p>iex/init.py
from ilm.iex import *</p>
<p>こういうのをiex, imath, alembic, alembicglそれぞれに作った。
setup.py
#!/usr/bin/env python</p>
<p>from setuptools import setup, Distribution</p>
<p>setup(
name='alembic',
version='0.1',
description='Alembic Library',
packages=['ilm', 'iex', 'imath', 'alembic', 'alembicgl'],
package_data={
'ilm':['<em>.pyd', '</em>.dll'],
},
)</p>
<p>py_package&gt; D:\Python36\python.exe setup.py bidst_wheel
py_package&gt; D:\Python36\Scripts\pip.exe install .\dist\alembic-0.1-cp36-cp36m-win_amd64.whl</p>
<p>AbcViewを実行してみる
こういう感じに配置して、abcview_main.pyを実行してみる。
abcview_main.py # bin/abcviewから改名(名前がフォルダと被らないように変更)
abcview
<strong>init</strong>.py</p>
<p>python2仕様の部分をまとめて修正。</p>
<p>https://docs.python.jp/3/library/2to3.html</p>
<p>AbcView&gt; D:\Python36\python.exe D:\Python36\Tools\scripts\2to3.py -w .</p>
<p>print文、except文などの定型的な文法問題はこれで一網打尽。ディレクトリを指定することでまとめて処理できる。
file.toAscii() =&gt; file
これもPython2との非互換か。
QtCore.QString(str(value)) =&gt; str(value)
QStringは、PythonのStringでよさげ。
動いた</p>
<p>https://github.com/ousttrue/openexr/releases/tag/v0.1</p>
<p>タイムラインを操作したら蛸が動いた。</p>

</div>

<nav class="toc">


</nav>
</div>
</main>

    <footer class="footer">Powered by <a href="https://www.getzola.org/">Zola</a> <a href="https://github.com/ousttrue/zola/tree/custom">custom</a></footer>

  </body>
</html>
