<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <title>三次元日誌</title>

    

  <script src="https://ousttrue.github.io/plugins/elasticlunr.min.js" defer></script>
  <script src="https://ousttrue.github.io/search_index.en.js" defer></script>
  <script src="https://ousttrue.github.io/js/search.js" defer></script>

    

     
    <link rel="stylesheet" href="https://ousttrue.github.io/main.css">
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css"
      />
    
  </head>

  <body class="container">
    <a class="site_title" href="https:&#x2F;&#x2F;ousttrue.github.io&#x2F;">
      <div>三次元日誌</div>
    </a>

    <nav class="nav">
      <a class="item" href="/tags/">tags</a>
      <a class="item" href="https://github.com/ousttrue" aria-label="github">
        <i class="fab fa-github fa-lg"></i>
      </a>
      

        
            <form class="navbar-form">
                <input id="userinput" class="form-control is-search" type="search" placeholder="Search docs..."
                    aria-label="Search docs..." autocomplete="off">
                <div id="suggestions" class="shadow bg-white rounded"></div>
            </form>
        
    </nav>

    <main class="main">
<div class="page">
<div class="content">
  <div class="headline">
  
  

  
  <a class="headline_title" href="https:&#x2F;&#x2F;ousttrue.github.io&#x2F;posts&#x2F;2017&#x2F;05&#x2F;uwp-dll&#x2F;"> UWPでNativeDllを使う 
  

  
  </a>

  

  <div>
    <ul class="tags">
      <li class="headline_date">
        <div class="year">2017</div>
        <div class="md">0503</div>
      </li>
      
      


    <li class="tag"><a href="https:&#x2F;&#x2F;ousttrue.github.io&#x2F;tags&#x2F;cmake&#x2F;">cmake</a></li>

    <li class="tag"><a href="https:&#x2F;&#x2F;ousttrue.github.io&#x2F;tags&#x2F;uwp&#x2F;">uwp</a></li>




    </ul>
  </div>
</div>
 <p>UWPでNativeのDLLを使うとどんな感じなのか試してみた。</p>
<p>https://github.com/ousttrue/UwpNativeDllSample</p>
<p>CMakeのCache機構のせいで挙動を勘違いした部分を書き直し。</p>
<p>自前でビルドしたlibpng.dllでpngを表示するサンプル。
デスクトップアプリとの違い</p>
<p>dllのロードパスがカレントディレクトリと環境変数PATHに記述された場所ではなく、projectのトップレベルのみ
デスクトップと公開されているAPIに差異がある
projectが違う。x86 vxprojとuwp32 vcxprojのdiffの抜粋。</p>
<blockquote>
<pre style="background-color:#2b303b;">
<code>&lt;ApplicationType&gt;Windows Store&lt;/ApplicationType&gt;^M
&lt;DefaultLanguage&gt;en-US&lt;/DefaultLanguage&gt;^M
&lt;ApplicationTypeRevision&gt;10.0&lt;/ApplicationTypeRevision&gt;^M
&lt;MinimumVisualStudioVersion&gt;14.0&lt;/MinimumVisualStudioVersion&gt;^M
&lt;AppContainerApplication&gt;true&lt;/AppContainerApplication&gt;^M
</code></pre></blockquote>
<p>zlib-1.2.11を無修正でビルドできた。
libpng-1.6.29は_ExitProcessにリンクする段階でエラーになった</p>
<p>修正方法が書いてあった。</p>
<p>https://github.com/Microsoft/vcpkg/blob/master/docs/example-3-patch-libpng.md</p>
<p>UWP向けビルドオプション/zw
無くても動いた。UWP固有のAPIにアクセスするときもしくはC++/CXに必要？</p>
<p>https://msdn.microsoft.com/ja-jp/library/hh561383.aspx</p>
<p>cmakeでWindowsStore向けのprojectを生成する
Microsoft版のcmakeなら作れる。
VS2017にも含まれていて以下のパスにあった。
C:\Program Files (x86)\Microsoft Visual Studio\2017\Community\Common7\IDE\CommonExtensions\Microsoft\CMake\CMake\bin\cmake.exe
本家のcmakeでもできるかもしれないが未確認。
プロジェクトを生成するときに以下のオプションを指定する。</p>
<p>-DCMAKE_SYSTEM_NAME=WindowsStore
-DCMAKE_SYSTEM_VERSION=10.0</p>
<p>これだけだとCMAKE_SYSTEM_PROCESSORが空になってlibpngではエラーになる。追加で下記のオプションも指定した。</p>
<p>-DCMAKE_SYSTEM_PROCESSOR=x86</p>
<p>ほかに/zwの指定など。</p>
<p>-DCMAKE_C_FLAGS=/ZW /EHsc /DWIN32=1
-DCMAKE_CXX_FLAGS=/ZW /EHsc /DWIN32=1</p>
<p>例
zlib-1.2.11/build&gt; cmake.exe .. -G Visual Studio 15 2017 -DCMAKE_SYSTEM_PROCESSOR=x86 -DCMAKE_SYSTEM_NAME=WindowsStore -DCMAKE_SYSTEM_VERSION=10.0 -DCMAKE_C_FLAGS=/ZW /EHsc /DWIN32=1 -DCMAKE_CXX_FLAGS=/ZW /EHsc /DWIN32=1 </p>
<p>C#からDllImport
Desktopの時と記述方法は同じ。dllの配置場所は上記の通りprojectに放り込むだけ。
デスクトップ向けにビルドしたdllは動くのか
動いた。
逆にUWP向けにビルドしたdllはデスクトップで動くのか
動かなかった。ソース互換はある程度あるがバイナリ互換は無い。
{&quot;DLL 'libpng16' を読み込めません:この操作はアプリ コンテナーのコンテキストでのみ有効です。 (HRESULT からの例外:0x8007109A)&quot;}</p>
<p>このエラーがデスクトップでuwpのdllを呼び出したとき固有のエラーメッセージぽい。
まとめ
CMakeの場合はプロジェクト生成オプションさえわかれば、 デスクトップとそれほど使い勝手は変わらない。この煩雑な手順を記録しておくべく自動ビルドツール作成中。</p>
<p>https://github.com/ousttrue/bldproc</p>

</div>

<nav class="toc">


</nav>
</div>
</main>

    <footer class="footer">Powered by <a href="https://www.getzola.org/">Zola</a> <a href="https://github.com/ousttrue/zola/tree/custom">custom</a></footer>

  </body>
</html>
