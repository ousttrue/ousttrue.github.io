<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <title>三次元日誌</title>

    

  <script src="https://ousttrue.github.io/plugins/elasticlunr.min.js" defer></script>
  <script src="https://ousttrue.github.io/search_index.en.js" defer></script>
  <script src="https://ousttrue.github.io/js/search.js" defer></script>

    

     
    <link rel="stylesheet" href="https://ousttrue.github.io/main.css">
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css"
      />
    
  </head>

  <body class="container">
    <a class="site_title" href="https:&#x2F;&#x2F;ousttrue.github.io&#x2F;">
      <div>三次元日誌</div>
    </a>

    <nav class="nav">
      <a class="item" href="/tags/">tags</a>
      <a class="item" href="https://github.com/ousttrue" aria-label="github">
        <i class="fab fa-github fa-lg"></i>
      </a>
      

        
            <form class="navbar-form">
                <input id="userinput" class="form-control is-search" type="search" placeholder="Search docs..."
                    aria-label="Search docs..." autocomplete="off">
                <div id="suggestions" class="shadow bg-white rounded"></div>
            </form>
        
    </nav>

    <main class="main">
<div class="page">
<div class="content">
  <div class="headline">
  
  

  
  <a class="headline_title" href="https:&#x2F;&#x2F;ousttrue.github.io&#x2F;posts&#x2F;2017&#x2F;07&#x2F;cmake-2017&#x2F;"> vcpkgでopencvの開発環境を作る 
  

  
  </a>

  

  <div>
    <ul class="tags">
      <li class="headline_date">
        <div class="year">2017</div>
        <div class="md">0701</div>
      </li>
      
      


    <li class="tag"><a href="https:&#x2F;&#x2F;ousttrue.github.io&#x2F;tags&#x2F;vcpkg&#x2F;">vcpkg</a></li>

    <li class="tag"><a href="https:&#x2F;&#x2F;ousttrue.github.io&#x2F;tags&#x2F;opencv&#x2F;">opencv</a></li>




    </ul>
  </div>
</div>
 <p>Windowsでcmakeを使う場合に外部ライブラリの解決がわりと困難。</p>
<p>cmakeのfind_packageがうまくうごかないのである。Unix系であれば <code>CMAKE_INSTALL_PREFIX(/usr/local)</code> にインストールされた依存プロジェクトを発見できるし、足りなければインストールすることもできる。それに、<code>apt-get</code> とか <code>pacman</code> とかあるので、自分で全部ビルドするということはあまり必要なかったりする今日この頃です。Windowsにはそういうのがなかった(CMAKE_INSTALL_PREFIXはどこなのか)のだけど、最近出てきたvcpkgがそれをやってくれる。</p>
<p>ArUcoをvcpkgとcmakeでビルドする
ということでvcpkgで外部ライブラリを構築し、一部をソースごとプロジェクトにコピーする方法でArUco(OpenCV)のビルドをやってみる。ArUcoのデバッグ版にアタッチしたり改造したりするつもりなので、opencvのモジュール版ArUcoではなく単体の方を使う。環境は、Windows10(64bit)にVisualStudio2017(C++)。
vcpkgを準備</p>
<ul>
<li>https://github.com/Microsoft/vcpkg</li>
</ul>
<pre style="background-color:#2b303b;">
<code class="language-shell" data-lang="shell"><span style="color:#c0c5ce;">&gt; git clone https://github.com/Microsoft/vcpkg.git
&gt; cd vcpkg
vcpkg&gt; .\bootstrap-vcpkg.bat

vcpkgで64bit版のopencvをインストール
vcpkg&gt; .\vcpkg.exe install opencv:x64-windows

vcpkg/installed/x64-windowsにinclude, lib, bin等がインストールされる。
vcpkgで64bit版のfreeglutをインストール
vcpkg&gt; .\vcpkg.exe install freeglut:x64-windows
</span></code></pre>
<p>arucoのソースを入手
OpenCVのモジュール</p>
<p>http://docs.opencv.org/trunk/d9/d6d/tutorial_table_of_content_aruco.html</p>
<p>ではなくてこっち。</p>
<p>http://www.uco.es/investiga/grupos/ava/node/26
https://sourceforge.net/projects/aruco/files/</p>
<p>aruco-2.0.19.zipを手に入れた。
とりあえずビルドしてみる
vcpkgはd:/vcpkgにインストールされている。</p>
<pre style="background-color:#2b303b;">
<code class="language-shell" data-lang="shell"><span style="color:#c0c5ce;">aruco-2.0.19&gt; mkdir build
aruco-2.0.19/build&gt; cmake -D CMAKE_INSTALL_PREFIX=d:/vcpkg/installed/x64-windows -D OpenCVDir=d:/vcpkg/installed/x64-windows/share/opencv -D BUILD_GLSAMPLES=1 -G &quot;Visual Studio 15 2017 Win64&quot; ..
</span></code></pre>
<p>aruco_test_glとaruco_test_markermap_glのビルドでエラーが出るのでちょっとコードを修正する。
gl.hより先にWindows.hをincludeしてあげる。</p>
<pre style="background-color:#2b303b;">
<code class="language-c++" data-lang="c++"><span style="color:#b48ead;">#ifdef</span><span style="color:#c0c5ce;"> __APPLE__
</span><span style="color:#b48ead;">#include </span><span style="color:#c0c5ce;">&lt;</span><span style="color:#a3be8c;">GLUT/glut.h</span><span style="color:#c0c5ce;">&gt;

</span><span style="color:#b48ead;">#elif defined</span><span style="color:#c0c5ce;">(_MSC_VER)
</span><span style="color:#b48ead;">#include </span><span style="color:#c0c5ce;">&lt;</span><span style="color:#a3be8c;">Windows.h</span><span style="color:#c0c5ce;">&gt;
</span><span style="color:#b48ead;">#include </span><span style="color:#c0c5ce;">&lt;</span><span style="color:#a3be8c;">GL/glut.h</span><span style="color:#c0c5ce;">&gt;

</span><span style="color:#b48ead;">#else
#include </span><span style="color:#c0c5ce;">&lt;</span><span style="color:#a3be8c;">GL/gl.h</span><span style="color:#c0c5ce;">&gt;
</span><span style="color:#b48ead;">#include </span><span style="color:#c0c5ce;">&lt;</span><span style="color:#a3be8c;">GL/glut.h</span><span style="color:#c0c5ce;">&gt;
</span><span style="color:#b48ead;">#endif
</span></code></pre>
<p>あとfreeglutのリンクををdebug, release振り分けのために、
CMakeLists.txtをちょっと改造。だいたいこういう感じ。</p>
<pre style="background-color:#2b303b;">
<code class="language-cmake" data-lang="cmake"><span style="color:#b48ead;">IF </span><span style="color:#c0c5ce;">(GLUT_FOUND)
	</span><span style="color:#96b5b4;">STRING</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">REPLACE </span><span style="color:#c0c5ce;">lib/freeglut.lib debug/lib/freeglutd.lib GLUT_glut_DEBUG_LIBRARY ${</span><span style="color:#bf616a;">GLUT_glut_LIBRARY</span><span style="color:#c0c5ce;">})
	</span><span style="color:#96b5b4;">MESSAGE</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">STATUS </span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">GLUT_glut_DEBUG_LIBRARY=</span><span style="color:#c0c5ce;">$</span><span style="color:#a3be8c;">{</span><span style="color:#bf616a;">GLUT_glut_DEBUG_LIBRARY</span><span style="color:#a3be8c;">}</span><span style="color:#c0c5ce;">&quot;)
	</span><span style="color:#96b5b4;">set </span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">OPENGL_LIBS  </span><span style="color:#c0c5ce;">general
		${</span><span style="color:#bf616a;">OPENGL_gl_LIBRARY</span><span style="color:#c0c5ce;">}
		${</span><span style="color:#bf616a;">OPENGL_glu_LIBRARY</span><span style="color:#c0c5ce;">}
		optimized ${</span><span style="color:#bf616a;">GLUT_glut_LIBRARY</span><span style="color:#c0c5ce;">}
		debug ${</span><span style="color:#bf616a;">GLUT_glut_DEBUG_LIBRARY</span><span style="color:#c0c5ce;">}
		)
ENDIF()
</span></code></pre>
<p>この部分と連携する。
TARGET_LINK_LIBRARIES(aruco_test_gl ${OPENGL_LIBS})</p>
<p>これで、CMAKE_INSTALL_PREFIX/binにパスを通せばプログラムは動作する。
arucoのテストデータを入手してwebcamで動作確認
テストデータを入手する。</p>
<p>https://sourceforge.net/projects/aruco/files/</p>
<p>aruco-test-data-2.0.zipを手に入れた。
この中のintrinsics.ymlを引数にして実行する(本来は、カメラキャリブレーションをしてintrinsics.ymlを自分のカメラ用に作成する必要がある)。
aruco_test_gl.exe &quot;live&quot; &quot;path_to_intrinsics.yml&quot; 0.05
aruco_test_glとarucoの入った小さいプロジェクト
ArUcoを改造する予定。</p>
<p>intrinsics.ymlを省略したり簡略化したい(fovyとaspectratioだけにするなど)
左手系(DirectXやUnity)に対応</p>
<p>ということで、arucoのソースを含めている。</p>
<pre style="background-color:#2b303b;">
<code class="language-shell" data-lang="shell"><span style="color:#c0c5ce;">aruco_test

  + CMakeLists.txt

  + aruco_test_gl
    + CMakeLists.txt
    + aruco_test_gl.cpp(aruco-2.0.19/utils_gl/aruco_test_gl.cppをコピー)

  + src(aruco-2.0.19/srcをコピー)
</span></code></pre><pre style="background-color:#2b303b;">
<code class="language-CMakeLists.txt" data-lang="CMakeLists.txt"><span style="color:#96b5b4;">CMAKE_MINIMUM_REQUIRED</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">VERSION </span><span style="color:#c0c5ce;">2.8)
</span><span style="color:#96b5b4;">PROJECT</span><span style="color:#c0c5ce;">(aruco)

</span><span style="color:#96b5b4;">FIND_PACKAGE</span><span style="color:#c0c5ce;">(OpenCV </span><span style="color:#bf616a;">REQUIRED </span><span style="color:#c0c5ce;">)
</span><span style="color:#96b5b4;">SET </span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">ARUCO_REQUIRED_LIBRARIES </span><span style="color:#c0c5ce;">${</span><span style="color:#bf616a;">OpenCV_LIBS</span><span style="color:#c0c5ce;">})
</span><span style="color:#96b5b4;">INCLUDE_DIRECTORIES</span><span style="color:#c0c5ce;">(${</span><span style="color:#bf616a;">OpenCV_INCLUDE_DIRS</span><span style="color:#c0c5ce;">})

</span><span style="color:#96b5b4;">FIND_PACKAGE</span><span style="color:#c0c5ce;">(OpenGL </span><span style="color:#bf616a;">REQUIRED</span><span style="color:#c0c5ce;">)

</span><span style="color:#96b5b4;">FIND_PACKAGE</span><span style="color:#c0c5ce;">(GLUT)
</span><span style="color:#96b5b4;">MESSAGE</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">STATUS </span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">GLUT_glut_LIBRARY=</span><span style="color:#c0c5ce;">$</span><span style="color:#a3be8c;">{</span><span style="color:#bf616a;">GLUT_glut_LIBRARY</span><span style="color:#a3be8c;">}</span><span style="color:#c0c5ce;">&quot;)
</span><span style="color:#96b5b4;">STRING</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">REPLACE </span><span style="color:#c0c5ce;">lib/freeglut.lib debug/lib/freeglutd.lib GLUT_glut_DEBUG_LIBRARY ${</span><span style="color:#bf616a;">GLUT_glut_LIBRARY</span><span style="color:#c0c5ce;">})
</span><span style="color:#96b5b4;">MESSAGE</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">STATUS </span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">GLUT_glut_DEBUG_LIBRARY=</span><span style="color:#c0c5ce;">$</span><span style="color:#a3be8c;">{</span><span style="color:#bf616a;">GLUT_glut_DEBUG_LIBRARY</span><span style="color:#a3be8c;">}</span><span style="color:#c0c5ce;">&quot;)
</span><span style="color:#b48ead;">IF </span><span style="color:#c0c5ce;">(GLUT_FOUND)
    </span><span style="color:#96b5b4;">set </span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">OPENGL_LIBS  </span><span style="color:#c0c5ce;">general
        ${</span><span style="color:#bf616a;">OPENGL_gl_LIBRARY</span><span style="color:#c0c5ce;">}
        ${</span><span style="color:#bf616a;">OPENGL_glu_LIBRARY</span><span style="color:#c0c5ce;">}
        optimized ${</span><span style="color:#bf616a;">GLUT_glut_LIBRARY</span><span style="color:#c0c5ce;">}
        debug ${</span><span style="color:#bf616a;">GLUT_glut_DEBUG_LIBRARY</span><span style="color:#c0c5ce;">}
        )
ENDIF()

ADD_DEFINITIONS(-D_SCL_SECURE_NO_WARNINGS)
SET(CMAKE_CXX_FLAGS &quot;/wd4819 /EHsc&quot;)

ADD_SUBDIRECTORY(src)
ADD_SUBDIRECTORY(utils_gl)

aruco_test_gl/CMakeLists.txt
INCLUDE_DIRECTORIES(${</span><span style="color:#bf616a;">PROJECT_SOURCE_DIR</span><span style="color:#c0c5ce;">}/src ${</span><span style="color:#bf616a;">GNULIBS_INCLUDE_DIR</span><span style="color:#c0c5ce;">})
LINK_LIBRARIES(${</span><span style="color:#bf616a;">PROJECT_NAME</span><span style="color:#c0c5ce;">} ${</span><span style="color:#bf616a;">REQUIRED_LIBRARIES</span><span style="color:#c0c5ce;">} )

IF(OPENGL_LIBS)
    ADD_EXECUTABLE(aruco_test_gl
        aruco_test_gl.cpp
        )
    TARGET_LINK_LIBRARIES(aruco_test_gl ${</span><span style="color:#bf616a;">OPENGL_LIBS</span><span style="color:#c0c5ce;">})
</span></code></pre>
<p>以上で、arucoを例にvcpkgでopencvとfreeglutdを外部管理してcmakeでプロジェクトを取り廻す例を作った。
作業例。</p>
<p>https://github.com/ousttrue/aruco_test</p>

</div>

<nav class="toc">


</nav>
</div>
</main>

    <footer class="footer">Powered by <a href="https://www.getzola.org/">Zola</a> <a href="https://github.com/ousttrue/zola/tree/custom">custom</a></footer>

  </body>
</html>
