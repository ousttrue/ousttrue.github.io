<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="generator" content="Nikola (getnikola.com)">
<meta name="viewport" content="width=device-width">
<script src="../../../../assets/js/all-nocdn.js"></script><title>PythonでImGuiする | 三次元日誌</title>
<link href="../../../../assets/css/code.css" rel="stylesheet" type="text/css">
<link href="../../../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
</head>
<body>
    <h1 id="brand">
        <a href="../../../../" title="三次元日誌" rel="home">
            <span id="blog-title">三次元日誌</span>
        </a>
    </h1>

    <nav id="menu"><ul>
<li><a href="../../../../archive.html">Archives</a></li>
<li><a href="../../../../categories/index.html">Tags</a></li>
<li><a href="../../../../rss.xml">RSS feed</a></li>
<li><a href="../../../../about">About</a></li>
<li><a href="../../../../books">MemoBooks</a></li>

            
            
            
        </ul></nav><hr>
<main id="content"><h1 class="p-name entry-title" itemprop="headline name">
    <h1 class="p-name entry-title" itemprop="headline name">
    <a href="." class="u-url">PythonでImGuiする
    </a>
</h1>
<ul itemprop="keywords" class="tags">
<li>
        <time datetime="2017-07-31T00:00:00+09:00" title="2017-07-31">2017-07-31</time>
</li>
</ul>
</h1>

<div>
<p>PythonでImGuiするのがよさげな気がしたのでやってみた。</p>
<p>ImGuiはcではなくc++のライブラリなのでPythonのctypesは使えぬ。
本家のBindingsの項に２つのpython bindingが紹介されている。</p>
<p>https://github.com/chromy/cyimgui
https://github.com/swistakm/pyimgui</p>
<p>なんかうまくいかなった。
ならばswigで自前でラップすればええやんということで、やってみる。</p>
<p>https://github.com/ousttrue/SwigImGui</p>
<p>Swig
%module swig_imgui</p>
<p>%{
/<em> Includes the header in the wrapper code </em>/</p>
<h2>include "imgui/imgui.h"</h2>
<p>%}</p>
<p>/<em> Parse the header file to generate wrappers </em>/
%include "imgui/imgui.h"</p>
<blockquote>
<p>swig -python -c++ imgui.i</p>
</blockquote>
<p>imgui_wrap.cxxと”swig_imgui.py”を生成した。
imgui_wrap.cxxから_swig_imgui.pydをビルドする。
ビルドしてみる
pythonのNativeModuleをビルドするのでsetup.pyを書いてみる。
from distutils.core import setup, Extension</p>
<p>imgui_module = Extension('_swig_imgui',
        sources=[
            'imgui_wrap.cxx',
            'imgui/imgui.cpp',
            'imgui/imgui_draw.cpp',
            'imgui/imgui_demo.cpp',
            ],
        )</p>
<p>setup (name = 'swig_imgeui',
        version = '0.1',
        author      = "ousttrue",
        description = """imgui wrapper using swig""",
        ext_modules = [imgui_module],
        py_modules = ["imgui"],
        )</p>
<p>ビルド。</p>
<blockquote>
<p>C:\python36\python.exe setup.py build</p>
</blockquote>
<p>ビルドしてみるとエラー。
swigimgui\imgui_wrap.cxx(26285): error C2668: 'ImGui::TreePush': オーバーロード関数の呼び出しを解決することができません。(新機能 ; ヘルプを参照)
swigimgui\imgui\imgui.h(338): note: 'void ImGui::TreePush(const void <em>)' の可能性があります
swigimgui\imgui\imgui.h(337): note: または 'void ImGui::TreePush(const char </em>)'
swigimgui\imgui_wrap.cxx(26285): note: 引数リスト '()' を一致させようとしているとき</p>
<p>ImGui::TreePush();がTreePush(const char<em> str_id = NULL)とTreePush(const void</em> ptr_id = NULL)でどちらなのか解決できない。
修正。
%module swig_imgui</p>
<p>%{
/<em> Includes the header in the wrapper code </em>/</p>
<h2>include "imgui/imgui.h"</h2>
<p>%}</p>
<p>%ignore ImGui::TreePush();</p>
<p>/<em> Parse the header file to generate wrappers </em>/
%include "imgui/imgui.h"</p>
<p>%include "imgui/imgui.h"の前に%ignoreを記述することで、
引数無しのTreePushを作らないようにした。
これでコンパイルは通った。
python36_d.libにリンクしない
python36_d.libではなあくpython36.libにリンクする。
imgui.iの上の方に以下の記述を追加する。
%begin %{</p>
<h2>ifdef _MSC_VER</h2>
<h2>define SWIG_PYTHON_INTERPRETER_NO_DEBUG</h2>
<h2>endif</h2>
<p>%}</p>
<p>実行してみよう</p>
<p>https://github.com/ocornut/imgui/tree/master/examples/sdl_opengl3_example</p>
<p>をまるっとpythonに移植してみる。
ここからが長くなるで。</p>
<h2>ImGui - standalone example application for SDL2 + OpenGL</h2>
<h2>If you are new to ImGui, see examples/README.txt and documentation at the top of imgui.cpp.</h2>
<p>import os
import sys</p>
<p>if not 'PYSDL2_DLL_PATH' in os.environ:
    os.environ['PYSDL2_DLL_PATH']=os.environ['VCPKG_DIR'] + '/installed/x64-windows/bin'
from sdl2 import *</p>
<p>python_dir=os.path.dirname(sys.executable)
os.environ['PATH']+=(';'+python_dir)
import swig_imgui as imgui</p>
<p>import ImplSdlGL3</p>
<p>def main():</p>
<pre class="code literal-block"><span></span><span class="err">#</span> <span class="nt">Setup</span> <span class="nt">SDL</span>
<span class="nt">if</span> <span class="o">(</span><span class="nt">SDL_Init</span><span class="o">(</span><span class="nt">SDL_INIT_VIDEO</span><span class="o">|</span><span class="nt">SDL_INIT_TIMER</span><span class="o">)</span> <span class="o">!=</span> <span class="nt">0</span><span class="o">):</span>
    <span class="nt">print</span><span class="o">(</span><span class="s2">"Error: %s\n"</span><span class="o">,</span> <span class="nt">SDL_GetError</span><span class="o">());</span>
    <span class="nt">return</span> <span class="nt">-1</span><span class="o">;</span>

<span class="err">#</span> <span class="nt">Setup</span> <span class="nt">window</span>
<span class="nt">SDL_GL_SetAttribute</span><span class="o">(</span><span class="nt">SDL_GL_CONTEXT_FLAGS</span><span class="o">,</span> <span class="nt">SDL_GL_CONTEXT_FORWARD_COMPATIBLE_FLAG</span><span class="o">);</span>
<span class="nt">SDL_GL_SetAttribute</span><span class="o">(</span><span class="nt">SDL_GL_CONTEXT_PROFILE_MASK</span><span class="o">,</span> <span class="nt">SDL_GL_CONTEXT_PROFILE_CORE</span><span class="o">);</span>
<span class="nt">SDL_GL_SetAttribute</span><span class="o">(</span><span class="nt">SDL_GL_DOUBLEBUFFER</span><span class="o">,</span> <span class="nt">1</span><span class="o">);</span>
<span class="nt">SDL_GL_SetAttribute</span><span class="o">(</span><span class="nt">SDL_GL_DEPTH_SIZE</span><span class="o">,</span> <span class="nt">24</span><span class="o">);</span>
<span class="nt">SDL_GL_SetAttribute</span><span class="o">(</span><span class="nt">SDL_GL_STENCIL_SIZE</span><span class="o">,</span> <span class="nt">8</span><span class="o">);</span>
<span class="nt">SDL_GL_SetAttribute</span><span class="o">(</span><span class="nt">SDL_GL_CONTEXT_MAJOR_VERSION</span><span class="o">,</span> <span class="nt">3</span><span class="o">);</span>
<span class="nt">SDL_GL_SetAttribute</span><span class="o">(</span><span class="nt">SDL_GL_CONTEXT_MINOR_VERSION</span><span class="o">,</span> <span class="nt">2</span><span class="o">);</span>
<span class="nt">current</span><span class="o">=</span><span class="nt">SDL_DisplayMode</span><span class="o">();</span>
<span class="nt">SDL_GetCurrentDisplayMode</span><span class="o">(</span><span class="nt">0</span><span class="o">,</span> <span class="nt">current</span><span class="o">);</span>
<span class="nt">window</span> <span class="o">=</span> <span class="nt">SDL_CreateWindow</span><span class="o">(</span><span class="nt">b</span><span class="s2">"ImGui SDL2+OpenGL3 example"</span><span class="o">,</span> <span class="nt">SDL_WINDOWPOS_CENTERED</span><span class="o">,</span> <span class="nt">SDL_WINDOWPOS_CENTERED</span><span class="o">,</span> <span class="nt">1280</span><span class="o">,</span> <span class="nt">720</span><span class="o">,</span> <span class="nt">SDL_WINDOW_OPENGL</span><span class="o">|</span><span class="nt">SDL_WINDOW_RESIZABLE</span><span class="o">);</span>
<span class="nt">glcontext</span> <span class="o">=</span> <span class="nt">SDL_GL_CreateContext</span><span class="o">(</span><span class="nt">window</span><span class="o">);</span>
<span class="p">#</span><span class="nn">gl3wInit</span><span class="o">();</span>

<span class="err">#</span> <span class="nt">Setup</span> <span class="nt">ImGui</span> <span class="nt">binding</span>
<span class="nt">ImplSdlGL3</span><span class="p">.</span><span class="nc">Init</span><span class="o">(</span><span class="nt">window</span><span class="o">);</span>

<span class="err">#</span> <span class="nt">Load</span> <span class="nt">Fonts</span>
<span class="err">#</span> <span class="o">(</span><span class="nt">there</span> <span class="nt">is</span> <span class="nt">a</span> <span class="nt">default</span> <span class="nt">font</span><span class="o">,</span> <span class="nt">this</span> <span class="nt">is</span> <span class="nt">only</span> <span class="nt">if</span> <span class="nt">you</span> <span class="nt">want</span> <span class="nt">to</span> <span class="nt">change</span> <span class="nt">it</span><span class="o">.</span> <span class="nt">see</span> <span class="nt">extra_fonts</span><span class="o">/</span><span class="nt">README</span><span class="p">.</span><span class="nc">txt</span> <span class="nt">for</span> <span class="nt">more</span> <span class="nt">details</span><span class="o">)</span>
<span class="p">#</span><span class="nn">ImGuiIO</span><span class="o">&amp;</span> <span class="nt">io</span> <span class="o">=</span> <span class="nt">imgui</span><span class="p">.</span><span class="nc">GetIO</span><span class="o">();</span>
<span class="p">#</span><span class="nn">io</span><span class="p">.</span><span class="nc">Fonts-</span><span class="o">&gt;</span><span class="nt">AddFontDefault</span><span class="o">();</span>
<span class="p">#</span><span class="nn">io</span><span class="p">.</span><span class="nc">Fonts-</span><span class="o">&gt;</span><span class="nt">AddFontFromFileTTF</span><span class="o">(</span><span class="s2">"../../extra_fonts/Cousine-Regular.ttf"</span><span class="o">,</span> <span class="nt">15</span><span class="p">.</span><span class="nc">0f</span><span class="o">);</span>
<span class="p">#</span><span class="nn">io</span><span class="p">.</span><span class="nc">Fonts-</span><span class="o">&gt;</span><span class="nt">AddFontFromFileTTF</span><span class="o">(</span><span class="s2">"../../extra_fonts/DroidSans.ttf"</span><span class="o">,</span> <span class="nt">16</span><span class="p">.</span><span class="nc">0f</span><span class="o">);</span>
<span class="p">#</span><span class="nn">io</span><span class="p">.</span><span class="nc">Fonts-</span><span class="o">&gt;</span><span class="nt">AddFontFromFileTTF</span><span class="o">(</span><span class="s2">"../../extra_fonts/ProggyClean.ttf"</span><span class="o">,</span> <span class="nt">13</span><span class="p">.</span><span class="nc">0f</span><span class="o">);</span>
<span class="p">#</span><span class="nn">io</span><span class="p">.</span><span class="nc">Fonts-</span><span class="o">&gt;</span><span class="nt">AddFontFromFileTTF</span><span class="o">(</span><span class="s2">"../../extra_fonts/ProggyTiny.ttf"</span><span class="o">,</span> <span class="nt">10</span><span class="p">.</span><span class="nc">0f</span><span class="o">);</span>
<span class="p">#</span><span class="nn">io</span><span class="p">.</span><span class="nc">Fonts-</span><span class="o">&gt;</span><span class="nt">AddFontFromFileTTF</span><span class="o">(</span><span class="s2">"c:\\Windows\\Fonts\\ArialUni.ttf"</span><span class="o">,</span> <span class="nt">18</span><span class="p">.</span><span class="nc">0f</span><span class="o">,</span> <span class="nt">NULL</span><span class="o">,</span> <span class="nt">io</span><span class="p">.</span><span class="nc">Fonts-</span><span class="o">&gt;</span><span class="nt">GetGlyphRangesJapanese</span><span class="o">());</span>

<span class="nt">show_test_window</span> <span class="o">=</span> <span class="nt">True</span><span class="o">;</span>
<span class="nt">show_another_window</span> <span class="o">=</span> <span class="nt">False</span><span class="o">;</span>
<span class="nt">clear_color</span> <span class="o">=</span> <span class="cp">[</span><span class="mi">114</span><span class="p">/</span><span class="nx">255.0</span><span class="p">,</span> <span class="mi">144</span><span class="p">/</span><span class="nx">255.0</span><span class="p">,</span> <span class="mi">154</span><span class="p">/</span><span class="nx">255.0</span><span class="cp">]</span><span class="o">;</span>

<span class="err">#</span> <span class="nt">Main</span> <span class="nt">loop</span>
<span class="nt">done</span> <span class="o">=</span> <span class="nt">False</span><span class="o">;</span>
<span class="nt">while</span> <span class="nt">not</span> <span class="nt">done</span><span class="o">:</span>

    <span class="nt">event</span><span class="o">=</span><span class="nt">SDL_Event</span><span class="o">();</span>
    <span class="nt">while</span> <span class="nt">SDL_PollEvent</span><span class="o">(</span><span class="nt">event</span><span class="o">)!=</span><span class="nt">0</span><span class="o">:</span>

        <span class="nt">ImplSdlGL3</span><span class="p">.</span><span class="nc">ProcessEvent</span><span class="o">(</span><span class="nt">event</span><span class="o">);</span>
        <span class="nt">if</span> <span class="nt">event</span><span class="p">.</span><span class="nc">type</span> <span class="o">==</span> <span class="nt">SDL_QUIT</span><span class="o">:</span>
            <span class="nt">done</span> <span class="o">=</span> <span class="nt">true</span><span class="o">;</span>

    <span class="nt">ImplSdlGL3</span><span class="p">.</span><span class="nc">NewFrame</span><span class="o">(</span><span class="nt">window</span><span class="o">);</span>

    <span class="err">#</span> <span class="nt">1</span><span class="o">.</span> <span class="nt">Show</span> <span class="nt">a</span> <span class="nt">simple</span> <span class="nt">window</span>
    <span class="err">#</span> <span class="nt">Tip</span><span class="o">:</span> <span class="nt">if</span> <span class="nt">we</span> <span class="nt">don</span><span class="err">'</span><span class="nt">t</span> <span class="nt">call</span> <span class="nt">imgui</span><span class="p">.</span><span class="nc">Begin</span><span class="o">()/</span><span class="nt">imgui</span><span class="p">.</span><span class="nc">End</span><span class="o">()</span> <span class="nt">the</span> <span class="nt">widgets</span> <span class="nt">appears</span> <span class="nt">in</span> <span class="nt">a</span> <span class="nt">window</span> <span class="nt">automatically</span> <span class="nt">called</span> <span class="s2">"Debug"</span>

    <span class="nt">f</span> <span class="o">=</span> <span class="nt">0</span><span class="p">.</span><span class="nc">0</span><span class="o">;</span>
    <span class="nt">imgui</span><span class="p">.</span><span class="nc">Text</span><span class="o">(</span><span class="s2">"Hello, world!"</span><span class="o">);</span>
    <span class="nt">imgui</span><span class="p">.</span><span class="nc">SliderFloat</span><span class="o">(</span><span class="s2">"float"</span><span class="o">,</span> <span class="nt">f</span><span class="o">,</span> <span class="nt">0</span><span class="p">.</span><span class="nc">0</span><span class="o">,</span> <span class="nt">1</span><span class="p">.</span><span class="nc">0</span><span class="o">);</span>
    <span class="nt">imgui</span><span class="p">.</span><span class="nc">ColorEdit3</span><span class="o">(</span><span class="s2">"clear color"</span><span class="o">,</span> <span class="nt">clear_color</span><span class="o">);</span>
    <span class="nt">if</span> <span class="nt">imgui</span><span class="p">.</span><span class="nc">Button</span><span class="o">(</span><span class="s2">"Test Window"</span><span class="o">):</span> <span class="nt">show_test_window</span> <span class="o">^=</span> <span class="nt">1</span><span class="o">;</span>
    <span class="nt">if</span> <span class="nt">imgui</span><span class="p">.</span><span class="nc">Button</span><span class="o">(</span><span class="s2">"Another Window"</span><span class="o">):</span> <span class="nt">show_another_window</span> <span class="o">^=</span> <span class="nt">1</span><span class="o">;</span>
    <span class="nt">imgui</span><span class="p">.</span><span class="nc">Text</span><span class="o">(</span><span class="s2">"Application average %.3f ms/frame (%.1f FPS)"</span><span class="o">,</span> <span class="nt">1000</span><span class="p">.</span><span class="nc">0</span> <span class="o">/</span> <span class="nt">imgui</span><span class="p">.</span><span class="nc">GetIO</span><span class="o">()</span><span class="p">.</span><span class="nc">Framerate</span><span class="o">,</span> <span class="nt">imgui</span><span class="p">.</span><span class="nc">GetIO</span><span class="o">()</span><span class="p">.</span><span class="nc">Framerate</span><span class="o">);</span>

    <span class="err">#</span> <span class="nt">2</span><span class="o">.</span> <span class="nt">Show</span> <span class="nt">another</span> <span class="nt">simple</span> <span class="nt">window</span><span class="o">,</span> <span class="nt">this</span> <span class="nt">time</span> <span class="nt">using</span> <span class="nt">an</span> <span class="nt">explicit</span> <span class="nt">Begin</span><span class="o">/</span><span class="nt">End</span> <span class="nt">pair</span>
    <span class="nt">if</span> <span class="nt">show_another_window</span><span class="o">:</span>
        <span class="nt">imgui</span><span class="p">.</span><span class="nc">SetNextWindowSize</span><span class="o">(</span><span class="nt">ImVec2</span><span class="o">(</span><span class="nt">200</span><span class="o">,</span><span class="nt">100</span><span class="o">),</span> <span class="nt">ImGuiSetCond_FirstUseEver</span><span class="o">);</span>
        <span class="nt">imgui</span><span class="p">.</span><span class="nc">Begin</span><span class="o">(</span><span class="s2">"Another Window"</span><span class="o">,</span> <span class="nt">show_another_window</span><span class="o">);</span>
        <span class="nt">imgui</span><span class="p">.</span><span class="nc">Text</span><span class="o">(</span><span class="s2">"Hello"</span><span class="o">);</span>
        <span class="nt">imgui</span><span class="p">.</span><span class="nc">End</span><span class="o">();</span>

    <span class="err">#</span> <span class="nt">3</span><span class="o">.</span> <span class="nt">Show</span> <span class="nt">the</span> <span class="nt">ImGui</span> <span class="nt">test</span> <span class="nt">window</span><span class="o">.</span> <span class="nt">Most</span> <span class="nt">of</span> <span class="nt">the</span> <span class="nt">sample</span> <span class="nt">code</span> <span class="nt">is</span> <span class="nt">in</span> <span class="nt">imgui</span><span class="p">.</span><span class="nc">ShowTestWindow</span><span class="o">()</span>
    <span class="nt">if</span> <span class="nt">show_test_window</span><span class="o">:</span>
        <span class="nt">imgui</span><span class="p">.</span><span class="nc">SetNextWindowPos</span><span class="o">(</span><span class="nt">ImVec2</span><span class="o">(</span><span class="nt">650</span><span class="o">,</span> <span class="nt">20</span><span class="o">),</span> <span class="nt">ImGuiSetCond_FirstUseEver</span><span class="o">);</span>
        <span class="nt">imgui</span><span class="p">.</span><span class="nc">ShowTestWindow</span><span class="o">(</span><span class="nt">show_test_window</span><span class="o">);</span>

    <span class="err">#</span> <span class="nt">Rendering</span>
    <span class="nt">glViewport</span><span class="o">(</span><span class="nt">0</span><span class="o">,</span> <span class="nt">0</span><span class="o">,</span> <span class="nt">int</span><span class="o">(</span><span class="nt">imgui</span><span class="p">.</span><span class="nc">GetIO</span><span class="o">()</span><span class="p">.</span><span class="nc">DisplaySize</span><span class="p">.</span><span class="nc">x</span><span class="o">),</span> <span class="nt">int</span><span class="o">(</span><span class="nt">imgui</span><span class="p">.</span><span class="nc">GetIO</span><span class="o">()</span><span class="p">.</span><span class="nc">DisplaySize</span><span class="p">.</span><span class="nc">y</span><span class="o">));</span>
    <span class="nt">glClearColor</span><span class="o">(</span><span class="nt">clear_color</span><span class="p">.</span><span class="nc">x</span><span class="o">,</span> <span class="nt">clear_color</span><span class="p">.</span><span class="nc">y</span><span class="o">,</span> <span class="nt">clear_color</span><span class="p">.</span><span class="nc">z</span><span class="o">,</span> <span class="nt">clear_color</span><span class="p">.</span><span class="nc">w</span><span class="o">);</span>
    <span class="nt">glClear</span><span class="o">(</span><span class="nt">GL_COLOR_BUFFER_BIT</span><span class="o">);</span>
    <span class="nt">imgui</span><span class="p">.</span><span class="nc">Render</span><span class="o">();</span>
    <span class="nt">SDL_GL_SwapWindow</span><span class="o">(</span><span class="nt">window</span><span class="o">);</span>

<span class="err">#</span> <span class="nt">Cleanup</span>
<span class="nt">ImplSdlGL3</span><span class="p">.</span><span class="nc">Shutdown</span><span class="o">();</span>
<span class="nt">SDL_GL_DeleteContext</span><span class="o">(</span><span class="nt">glcontext</span><span class="o">);</span>
<span class="nt">SDL_DestroyWindow</span><span class="o">(</span><span class="nt">window</span><span class="o">);</span>
<span class="nt">SDL_Quit</span><span class="o">();</span>

<span class="nt">return</span> <span class="nt">0</span><span class="o">;</span>
</pre>

<p>if <strong>name</strong>=='<strong>main</strong>':
    main()</p>
<p>ImplSdlGL3.py
def Init(window):
    pass</p>
<p>def ProcessEvent(event):
    pass</p>
<p>def NewFrame(window):
    pass</p>
<p>pydのサーチ
環境変数PATH
環境変数PYSDL2_DLL_PATH
実行
諸々、正しく初期化していないのでクラッシュする。
Initを移植
import swig_imgui as imgui
from sdl2 import *</p>
<p>def Init(window):
    io = imgui.GetIO();
    #io.KeyMap[imgui.ImGuiKey_Tab] = SDLK_TAB;
    io.KeyMap[imgui.ImGuiKey_LeftArrow] = SDL_SCANCODE_LEFT;
    io.KeyMap[imgui.ImGuiKey_RightArrow] = SDL_SCANCODE_RIGHT;
    io.KeyMap[imgui.ImGuiKey_UpArrow] = SDL_SCANCODE_UP;
    io.KeyMap[imgui.ImGuiKey_DownArrow] = SDL_SCANCODE_DOWN;
    io.KeyMap[imgui.ImGuiKey_PageUp] = SDL_SCANCODE_PAGEUP;
    io.KeyMap[imgui.ImGuiKey_PageDown] = SDL_SCANCODE_PAGEDOWN;
    io.KeyMap[imgui.ImGuiKey_Home] = SDL_SCANCODE_HOME;
    io.KeyMap[imgui.ImGuiKey_End] = SDL_SCANCODE_END;
    io.KeyMap[imgui.ImGuiKey_Delete] = SDLK_DELETE;
    io.KeyMap[imgui.ImGuiKey_Backspace] = SDLK_BACKSPACE;
    io.KeyMap[imgui.ImGuiKey_Enter] = SDLK_RETURN;
    io.KeyMap[imgui.ImGuiKey_Escape] = SDLK_ESCAPE;
    io.KeyMap[imgui.ImGuiKey_A] = SDLK_a;
    io.KeyMap[imgui.ImGuiKey_C] = SDLK_c;
    io.KeyMap[imgui.ImGuiKey_V] = SDLK_v;
    io.KeyMap[imgui.ImGuiKey_X] = SDLK_x;
    io.KeyMap[imgui.ImGuiKey_Y] = SDLK_y;
    io.KeyMap[imgui.ImGuiKey_Z] = SDLK_z;</p>
<pre class="code literal-block"><span></span># Alternatively you can set this to NULL and call imgui.GetDrawData() after imgui.Render() to get the same ImDrawData pointer.
io.RenderDrawListsFn = ImGui_ImplSdlGL3_RenderDrawLists;
io.SetClipboardTextFn = ImGui_ImplSdlGL3_SetClipboardText;
io.GetClipboardTextFn = ImGui_ImplSdlGL3_GetClipboardText;
#io.ClipboardUserData = NULL;
</pre>

<h2>ifdef _WIN32</h2>
<pre class="code literal-block"><span></span>wmInfo=SDL_SysWMinfo();
SDL_VERSION(wmInfo.version);
SDL_GetWindowWMInfo(window, wmInfo);
io.ImeWindowHandle = wmInfo.info.win.window;
</pre>

<h2>else</h2>
<pre class="code literal-block"><span></span>#(void)window;
</pre>

<h2>endif</h2>
<pre class="code literal-block"><span></span>return True;
</pre>

<p>実行してエラーをつぶしていく。
int型配列へのindexを使った代入
冒頭のio.KeyMap[imgui.ImGuiKey_LeftArrow] = SDL_SCANCODE_LEFT;がエラーになる。
io.KeyMap[imgui.ImGuiKey_LeftArrow] = SDL_SCANCODE_LEFT;
TypeError: 'SwigPyObject' object does not support item assignment</p>
<p>io.KeyMapのCでの型。
int           KeyMap[ImGuiKey_COUNT];</p>
<p>単なる配列へのアクセス。KeyMapをlist的なオブジェクトとしてpython側に公開するよりも、ioにセッターを実装することにした。
imgui.iに追加。
%extend ImGuiIO {
    void SetKeyMap(int k, int v)
    {
        ImGui::GetIO().KeyMap[k]=v;
    }
}</p>
<p>pythonでは次のように使う。
io.SetKeyMap(imgui.ImGuiKey_LeftArrow, SDL_SCANCODE_LEFT);</p>
<p>関数ポインタ型にpythonの関数を代入。
swig的にはこれがいちばんの難問である。
関数ポインタを変数に代入するのがエラーになる。
def RenderDrawLists():
    pass</p>
<p>io.RenderDrawListsFn = RenderDrawLists;</p>
<p>TypeError: in method 'ImGuiIO_RenderDrawListsFn_set', argument 2 of type 'void (<em>)(ImDrawData </em>)'
Press any key to continue . . .</p>
<p>そりゃ、pythonの関数をこれに代入するのは無理だ。
解決方法は、以下のようにする。
imgui.iに追記。場所に注意が必要。
%{
static void PythonRenderDrawListsFn(ImDrawData<em> data)
{
    auto func=(PyObject</em>)ImGui::GetIO().UserData; // Get Python function
    auto obj = SWIG_NewPointerObj(SWIG_as_voidptr(data)
    , SWIGTYPE_p_ImDrawData, 0 |  0 );
    auto arglist = Py_BuildValue("(O)",obj); // Build argument list
    PyEval_CallObject(func, arglist); // Call Python
    Py_DECREF(arglist); // Trash arglist
    Py_DECREF(obj);
}
%}</p>
<p>// before
%include "imgui/imgui.h"
// after</p>
<p>%extend ImGuiIO {
    void SetRenderDrawListsFn(PyObject *pyfunc) {
        ImGui::GetIO().UserData=pyfunc;
        self-&gt;RenderDrawListsFn=PythonRenderDrawListsFn;
        Py_INCREF(pyfunc);
    }
}</p>
<p>残り２つの関数ポインタも同様の対応で行けると思うがコメントアウトして飛ばした。
io.SetClipboardTextFn = ImGui_ImplSdlGL3_SetClipboardText;
io.GetClipboardTextFn = ImGui_ImplSdlGL3_GetClipboardText;</p>
<p>void*の代入
io.ImeWindowHandle = wmInfo.info.win.window;</p>
<p>TypeError: in method 'ImGuiIO_ImeWindowHandle_set', argument 2 of type 'void *'</p>
<p>セッターを作った。
%extend ImGuiIO {
    void SetImeWindowHandle(long long v)
    {
        ImGui::GetIO().ImeWindowHandle = (void*)v;
    }
}</p>
<p>NewFrameの移植
def CreateDeviceObjects():
    pass</p>
<p>g_MousePressed=[False, False, False]
g_MouseWheel=None
def NewFrame(window):
    if not g_FontTexture:
        CreateDeviceObjects();</p>
<pre class="code literal-block"><span></span>io = imgui.GetIO();

# Setup display size (every frame to accommodate for window resizing)
w, h=SDL_GetWindowSize(window);
display_w, display_h=SDL_GL_GetDrawableSize(window);
io.DisplaySize = imgui.ImVec2(w, h);
io.DisplayFramebufferScale = ImVec2(
    (display_w / float(w)) if w &gt; 0 else 0, 
    (display_h / float(h)) if h &gt; 0 else 0);

# Setup time step
time = SDL_GetTicks();
current_time = time / 1000.0;
io.DeltaTime = (current_time - g_Time) if g_Time &gt; 0.0 else (1.0 / 60.0);
g_Time = current_time;

# Setup inputs
# (we already got mouse wheel, keyboard keys &amp; characters from SDL_PollEvent())
mouseMask, mx, my = SDL_GetMouseState();
if (SDL_GetWindowFlags(window) &amp; SDL_WINDOW_MOUSE_FOCUS):
    # Mouse position, in pixels (set to -1,-1 if no mouse / on another screen, etc.)
    io.MousePos = ImVec2(mx, my);   
else:
    io.MousePos = ImVec2(-1, -1);

# If a mouse press event came, always pass it as "mouse held this frame", so we don't miss click-release events that are shorter than 1 frame.
io.MouseDown[0] = g_MousePressed[0] or (mouseMask &amp; SDL_BUTTON(SDL_BUTTON_LEFT)) != 0;      
io.MouseDown[1] = g_MousePressed[1] or (mouseMask &amp; SDL_BUTTON(SDL_BUTTON_RIGHT)) != 0;
io.MouseDown[2] = g_MousePressed[2] or (mouseMask &amp; SDL_BUTTON(SDL_BUTTON_MIDDLE)) != 0;
g_MousePressed[0] = g_MousePressed[1] = g_MousePressed[2] = False;

io.MouseWheel = g_MouseWheel;
g_MouseWheel = 0.0;

# Hide OS mouse cursor if ImGui is drawing it
SDL_ShowCursor(0 if io.MouseDrawCursor else 1);

# Start the frame
imgui.NewFrame();
</pre>

<p>io.MouseDown
セッター。
%extend ImGuiIO {
    void SetMouseDown(int k, int v)
    {
        ImGui::GetIO().MouseDown[k]=v;
    }
}</p>
<p>CreateDeviceObjectsの移植
    # Backup GL state
    last_texture=glGetIntegerv(GL_TEXTURE_BINDING_2D);
    last_array_buffer=glGetIntegerv(GL_ARRAY_BUFFER_BINDING);
    last_vertex_array=glGetIntegerv(GL_VERTEX_ARRAY_BINDING);</p>
<pre class="code literal-block"><span></span>vertex_shader =b'''#version 330
</pre>

<p>uniform mat4 ProjMtx;
in vec2 Position;
in vec2 UV;
in vec4 Color;
out vec2 Frag_UV;
out vec4 Frag_Color;
void main()
{
    Frag_UV = UV;
    Frag_Color = Color;
    gl_Position = ProjMtx * vec4(Position.xy,0,1);
};
'''</p>
<pre class="code literal-block"><span></span>fragment_shader =b'''#version 330
</pre>

<p>uniform sampler2D Texture;
in vec2 Frag_UV;
in vec4 Frag_Color;
out vec4 Out_Color;
void main()
{
    Out_Color = Frag_Color * texture( Texture, Frag_UV.st);
};
'''</p>
<pre class="code literal-block"><span></span>g_ShaderHandle = glCreateProgram();
g_VertHandle = glCreateShader(GL_VERTEX_SHADER);
g_FragHandle = glCreateShader(GL_FRAGMENT_SHADER);
glShaderSource(g_VertHandle, vertex_shader);
glShaderSource(g_FragHandle, fragment_shader);
glCompileShader(g_VertHandle);
glCompileShader(g_FragHandle);
glAttachShader(g_ShaderHandle, g_VertHandle);
glAttachShader(g_ShaderHandle, g_FragHandle);
glLinkProgram(g_ShaderHandle);

g_AttribLocationTex = glGetUniformLocation(g_ShaderHandle, "Texture");
g_AttribLocationProjMtx = glGetUniformLocation(g_ShaderHandle, "ProjMtx");
g_AttribLocationPosition = glGetAttribLocation(g_ShaderHandle, "Position");
g_AttribLocationUV = glGetAttribLocation(g_ShaderHandle, "UV");
g_AttribLocationColor = glGetAttribLocation(g_ShaderHandle, "Color");

g_VboHandle=glGenBuffers(1);
g_ElementsHandle=glGenBuffers(1);

g_VaoHandle=glGenVertexArrays(1);
glBindVertexArray(g_VaoHandle);
glBindBuffer(GL_ARRAY_BUFFER, g_VboHandle);
glEnableVertexAttribArray(g_AttribLocationPosition);
glEnableVertexAttribArray(g_AttribLocationUV);
glEnableVertexAttribArray(g_AttribLocationColor);
</pre>

<h2>define OFFSETOF(TYPE, ELEMENT) ((size_t)&amp;(((TYPE *)0)-&gt;ELEMENT))</h2>
<pre class="code literal-block"><span></span>SIZEOF_ImDrawVert=20
glVertexAttribPointer(g_AttribLocationPosition, 2, GL_FLOAT, GL_FALSE, SIZEOF_ImDrawVert, ctypes.c_void_p(0));
glVertexAttribPointer(g_AttribLocationUV, 2, GL_FLOAT, GL_FALSE, SIZEOF_ImDrawVert, ctypes.c_void_p(8));
glVertexAttribPointer(g_AttribLocationColor, 4, GL_UNSIGNED_BYTE, GL_TRUE, SIZEOF_ImDrawVert, ctypes.c_void_p(16));
</pre>

<h2>undef OFFSETOF</h2>
<pre class="code literal-block"><span></span>CreateFontsTexture();

# Restore modified GL state
glBindTexture(GL_TEXTURE_2D, last_texture);
glBindBuffer(GL_ARRAY_BUFFER, last_array_buffer);
glBindVertexArray(last_vertex_array);

return True;
</pre>

<p>sizeof
%constant int SIZEOF_ImDrawVert = sizeof(ImDrawVert);
%constant int SIZEOF_ImDrawIdx = sizeof(ImDrawIdx);</p>
<p>offset
%{</p>
<h2>define OFFSETOF(TYPE, ELEMENT) ((size_t)&amp;(((TYPE *)0)-&gt;ELEMENT))</h2>
<p>const int OFFSETOF_ImDrawVert_pos = OFFSETOF(ImDrawVert, pos);
const int OFFSETOF_ImDrawVert_uv = OFFSETOF(ImDrawVert, uv);
const int OFFSETOF_ImDrawVert_col = OFFSETOF(ImDrawVert, col);</p>
<h2>undef OFFSETOF</h2>
<p>%}
const int OFFSETOF_ImDrawVert_pos = OFFSETOF_ImDrawVert_pos;
const int OFFSETOF_ImDrawVert_uv = OFFSETOF_ImDrawVert_uv;
const int OFFSETOF_ImDrawVert_col = OFFSETOF_ImDrawVert_col;</p>
<p>CreateFontsTextureの移植
def CreateFontsTexture():
    # Build texture atlas
    io = imgui.GetIO();
    # Load as RGBA 32-bits for OpenGL3 demo because it is more likely to be compatible with user's existing shader.
    pixels, width, height=io.Fonts.GetTexDataAsRGBA32();</p>
<pre class="code literal-block"><span></span># Upload texture to graphics system
last_texture=glGetIntegerv(GL_TEXTURE_BINDING_2D);
g_FontTexture=glGenTextures(1);
glBindTexture(GL_TEXTURE_2D, g_FontTexture);
glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_MIN_FILTER, GL_LINEAR);
glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_MAG_FILTER, GL_LINEAR);
glPixelStorei(GL_UNPACK_ROW_LENGTH, 0);
glTexImage2D(GL_TEXTURE_2D, 0, GL_RGBA, width, height, 0, GL_RGBA, GL_UNSIGNED_BYTE, pixels);

# Store our identifier
io.Fonts.TexID = g_FontTexture;

# Restore state
glBindTexture(GL_TEXTURE_2D, last_texture);
</pre>

<p>値を返すためにポインタ引数を出力に使い(in + argout)、長さの分かっているバイト列へのポインタをbytesとして返す
対象はこれ。
IMGUI_API void GetTexDataAsRGBA32(unsigned char<em><em> out_pixels, int</em> out_width, int</em> out_height, int* out_bytes_per_pixel = NULL);</p>
<p>typemapでやってみる。
imgui.iの%include "imgui/imgui.h"より前に記述。
%typemap(in, numinputs=0) (unsigned char<strong> out_pixels, int<em> out_width, int</em> out_height, int<em> out_bytes_per_pixel) (unsigned char </em>tempP, int tempW, int tempH, int tempB) {
    $1 = &amp;tempP;
    $2 = &amp;tempW;
    $3 = &amp;tempH;
    $4 = &amp;tempB;
}
%typemap(argout)(unsigned char</strong> out_pixels, int<em> out_width, int</em> out_height, int<em> out_bytes_per_pixel){
    auto b = PyBytes_FromStringAndSize((const char </em>)<em>$1, (</em>$2) * (<em>$3) * (</em>$4));
    auto w = PyLong_FromLong(<em>$2);
    auto h = PyLong_FromLong(</em>$3);</p>
<pre class="code literal-block"><span></span>if ((!$result) || ($result == Py_None)) {
    // new tuple3
    $result = PyTuple_New(3);
    PyTuple_SetItem($result, 0, b);
    PyTuple_SetItem($result, 1, w);
    PyTuple_SetItem($result, 2, h);
}
else{
    if (!PyTuple_Check($result)) {
        // new tuple4
        auto t= PyTuple_New(4);
        PyTuple_SetItem(t, 0, $result);
        PyTuple_SetItem(t, 1, b);
        PyTuple_SetItem(t, 2, w);
        PyTuple_SetItem(t, 3, h);
        $result=t;
    }
    else {
        // concat
        auto head = $result;
        auto tail = PyTuple_New(3);
        PyTuple_SetItem($result, 0, b);
        PyTuple_SetItem($result, 1, w);
        PyTuple_SetItem($result, 2, h);
        $result = PySequence_Concat(head, tail);
        Py_DECREF(head);
        Py_DECREF(tail);
    }
}
</pre>

<p>}</p>
<p>typemap(in)で呼び出し時に出力変数を与える必要を無くして、typemap(argout)で呼び出し後の返り値をtuple化して値を詰める。その際に、バイト列のサイズが計算できるのでPyBytes_FromStringAndSizeでbytesを作る。
TexIDのセッター
intからvoid*への変換。
%extend ImFontAtlas {
    void SetTexID(long long id) {
        self-&gt;TexID=reinterpret_cast<void>(id);
    }
}</void></p>
<p>ここまで実装するとTextureのnullptrでプログラムがクラッシュしなくなる。
imguiのwidgetに対するinoutな引数
float<em>
IMGUI_API bool SliderFloat(const char</em> label, float<em> v, float v_min, float v_max, const char</em> display_format = "%.3f", float power = 1.0f);</p>
<p>argoutにすると返り値が(bool, float)になっていまいちな気がする。
swigでfloat*型のヘルパークラスを作る。
%include "cpointer.i"
%pointer_functions(float, floatp);</p>
<p>f=imgui.new_floatp()
imgui.floatp_assign(f, 0.0)
imgui.SliderFloat("float", f, 0.0, 1.0);</p>
<p>bool<em>
floatと同様に。
IMGUI_API void ShowTestWindow(bool</em> p_open = NULL);</p>
<p>%include "cpointer.i"
%pointer_functions(bool, boolp);</p>
<pre class="code literal-block"><span></span>show_test_window = imgui.new_boolp();
imgui.boolp_assign(show_test_window, True)

if imgui.Button("Test Window"): imgui.boolp_assign(show_test_window, not boolp_assign.value))

if imgui.boolp_value(show_test_window):
    imgui.SetNextWindowPos(imgui.ImVec2(650, 20), imgui.ImGuiSetCond_FirstUseEver);
    imgui.ShowTestWindow(show_test_window);
</pre>

<p>動くとはいえこれはいかんな。ポインタクラスをもう少し便利にするか、別の方法を調べよう。
float[3]
IMGUI_API bool ColorEdit3(const char* label, float col[3]);</p>
<p>typemapでlistリストを受け取って、listに結果を格納するように記述する。
%typemap(in) float col[3] (float temp[3]) {
    if (!PySequence_Check($input)) {
        PyErr_SetString(PyExc_ValueError,"Expected a sequence");
        return NULL;
    }
    if (PySequence_Length($input) &lt; $1_dim0) {
        PyErr_SetString(PyExc_ValueError,"Size mismatch. Expected more than $1_dim0 elements");
        return NULL;
    }
    for (int i = 0; i &lt; $1_dim0; i++) {
        PyObject <em>o = PySequence_GetItem($input,i);
        if (PyNumber_Check(o)) {
            temp[i] = (float) PyFloat_AsDouble(o);
        }
        else {
            PyErr_SetString(PyExc_ValueError,"Sequence elements must be numbers");
            return NULL;
        }
    }
    $1 = temp;
}
%typemap(argout) float col[3] {
    for (int i = 0; i &lt; $1_dim0; i++) {
        PyObject </em>o = PyFloat_FromDouble((double) $1[i]);
        PyList_SetItem($input, i, o);
    }
}</p>
<p>clear_color = [114/255.0, 144/255.0, 154/255.0, 0];
imgui.ColorEdit3("clear color", clear_color);</p>
<p>RenderDrawListsの移植
def RenderDrawLists(draw_data):
    global g_ShaderHandle</p>
<pre class="code literal-block"><span></span># Avoid rendering when minimized, scale coordinates for retina displays (screen coordinates != framebuffer coordinates)
io = imgui.GetIO();
fb_width = int(io.DisplaySize.x * io.DisplayFramebufferScale.x);
fb_height = int(io.DisplaySize.y * io.DisplayFramebufferScale.y);
if fb_width == 0 or fb_height == 0:
    return;
draw_data.ScaleClipRects(io.DisplayFramebufferScale);

# Backup GL state
last_active_texture=glGetIntegerv(GL_ACTIVE_TEXTURE);
glActiveTexture(GL_TEXTURE0);
last_program=glGetIntegerv(GL_CURRENT_PROGRAM);
last_texture=glGetIntegerv(GL_TEXTURE_BINDING_2D);
last_array_buffer=glGetIntegerv(GL_ARRAY_BUFFER_BINDING);
last_element_array_buffer=glGetIntegerv(GL_ELEMENT_ARRAY_BUFFER_BINDING);
last_vertex_array=glGetIntegerv(GL_VERTEX_ARRAY_BINDING);
last_blend_src_rgb=glGetIntegerv(GL_BLEND_SRC_RGB);
last_blend_dst_rgb=glGetIntegerv(GL_BLEND_DST_RGB);
last_blend_src_alpha=glGetIntegerv(GL_BLEND_SRC_ALPHA);
last_blend_dst_alpha=glGetIntegerv(GL_BLEND_DST_ALPHA);
last_blend_equation_rgb=glGetIntegerv(GL_BLEND_EQUATION_RGB);
last_blend_equation_alpha=glGetIntegerv(GL_BLEND_EQUATION_ALPHA);
last_viewport=glGetIntegerv(GL_VIEWPORT);
last_scissor_box=glGetIntegerv(GL_SCISSOR_BOX);
last_enable_blend = glIsEnabled(GL_BLEND);
last_enable_cull_face = glIsEnabled(GL_CULL_FACE);
last_enable_depth_test = glIsEnabled(GL_DEPTH_TEST);
last_enable_scissor_test = glIsEnabled(GL_SCISSOR_TEST);

# Setup render state: alpha-blending enabled, no face culling, no depth testing, scissor enabled
glEnable(GL_BLEND);
glBlendEquation(GL_FUNC_ADD);
glBlendFunc(GL_SRC_ALPHA, GL_ONE_MINUS_SRC_ALPHA);
glDisable(GL_CULL_FACE);
glDisable(GL_DEPTH_TEST);
glEnable(GL_SCISSOR_TEST);

# Setup viewport, orthographic projection matrix
glViewport(0, 0, fb_width, fb_height);
ortho_projection = (ctypes.c_float * 16)(
     2.0/io.DisplaySize.x, 0.0,                   0.0, 0.0,
     0.0,                  2.0/-io.DisplaySize.y, 0.0, 0.0,
     0.0,                  0.0,                  -1.0, 0.0,
    -1.0,                  1.0,                   0.0, 1.0,
);
glUseProgram(g_ShaderHandle);
glUniform1i(g_AttribLocationTex, 0);
glUniformMatrix4fv(g_AttribLocationProjMtx, 1, GL_FALSE, ortho_projection);
glBindVertexArray(g_VaoHandle);

for n in range(draw_data.CmdListsCount):

    cmd_list = draw_data.CmdLists[n];
    idx_buffer_offset = 0;

    glBindBuffer(GL_ARRAY_BUFFER, g_VboHandle);
    glBufferData(GL_ARRAY_BUFFER, cmd_list.VtxBuffer.Size * SIZEOF_ImDrawVert, cmd_list.VtxBuffer.Data, GL_STREAM_DRAW);

    glBindBuffer(GL_ELEMENT_ARRAY_BUFFER, g_ElementsHandle);
    glBufferData(GL_ELEMENT_ARRAY_BUFFER, cmd_list.IdxBuffer.Size * SIZEOF_ImDrawVert, cmd_list.IdxBuffer.Data, GL_STREAM_DRAW);

    for cmd_i in range(cmd_list.CmdBuffer.Size):

        pcmd = cmd_list.CmdBuffer[cmd_i];
        if pcmd.UserCallback:
            pcmd.UserCallback(cmd_list, pcmd);
        else:
            glBindTexture(GL_TEXTURE_2D, pcmd.TextureId);
            glScissor(pcmd.ClipRect.x, (fb_height - pcmd.ClipRect.w), (pcmd.ClipRect.z - pcmd.ClipRect.x), (pcmd.ClipRect.w - pcmd.ClipRect.y));
            glDrawElements(GL_TRIANGLES, pcmd.ElemCount, GL_UNSIGNED_SHORT, idx_buffer_offset);

        idx_buffer_offset += pcmd.ElemCount;

# Restore modified GL state
glUseProgram(last_program);
glBindTexture(GL_TEXTURE_2D, last_texture);
glActiveTexture(last_active_texture);
glBindVertexArray(last_vertex_array);
glBindBuffer(GL_ARRAY_BUFFER, last_array_buffer);
glBindBuffer(GL_ELEMENT_ARRAY_BUFFER, last_element_array_buffer);
glBlendEquationSeparate(last_blend_equation_rgb, last_blend_equation_alpha);
glBlendFuncSeparate(last_blend_src_rgb, last_blend_dst_rgb, last_blend_src_alpha, last_blend_dst_alpha);
if (last_enable_blend): 
    glEnable(GL_BLEND); 
else: 
    glDisable(GL_BLEND);
if (last_enable_cull_face): 
    glEnable(GL_CULL_FACE); 
else: 
    glDisable(GL_CULL_FACE);
if (last_enable_depth_test): 
    glEnable(GL_DEPTH_TEST);
else: 
    glDisable(GL_DEPTH_TEST);
if (last_enable_scissor_test): 
    glEnable(GL_SCISSOR_TEST); 
else: 
    glDisable(GL_SCISSOR_TEST);
glViewport(last_viewport[0], last_viewport[1], last_viewport[2], last_viewport[3]);
glScissor(last_scissor_box[0], last_scissor_box[1], last_scissor_box[2], last_scissor_box[3]);
</pre>

<p>getter
配列アクセスできない。
cmd_list = draw_data.CmdLists[n]</p>
<p>ゲッターを実装する
%extend ImDrawData {
    ImDrawList* GetCmdList(int n){
        return self-&gt;CmdLists[n];
    }
}</p>
<p>templateの型定義が無い
実装する型を明示する。
%template(ImVectorDrawVert) ImVector<imdrawvert>;
%template(ImVectorDrawIdx) ImVector<imdrawidx>;
%template(ImVectorDrawCmd) ImVector<imdrawcmd>;</imdrawcmd></imdrawidx></imdrawvert></p>
<p>Byte列を得る
cmd_list.VtxBuffer.Data</p>
<p>%typemap(in, numinputs=0) (unsigned char<strong> out_bytes, int<em> out_size) (unsigned char </em>tempP, int tempSize) {
    $1 = &amp;tempP;
    $2 = &amp;tempSize;
}
%typemap(argout)(unsigned char</strong> out_bytes, int<em> out_size){
    auto b = PyBytes_FromStringAndSize((const char </em>)<em>$1, </em>$2);</p>
<pre class="code literal-block"><span></span>if ((!$result) || ($result == Py_None)) {
    $result = b;
}
else{
    if (!PyTuple_Check($result)) {
        // new tuple4
        auto t= PyTuple_New(2);
        PyTuple_SetItem(t, 0, $result);
        PyTuple_SetItem(t, 1, b);
        $result=t;
    }
    else {
        // concat
        auto head = $result;
        auto tail = PyTuple_New(1);
        PyTuple_SetItem($result, 0, b);
        $result = PySequence_Concat(head, tail);
        Py_DECREF(head);
        Py_DECREF(tail);
    }
}
</pre>

<p>}</p>
<p>// before
%include "imgui/imgui.h"
// after</p>
<p>%extend ImDrawList {
    void GetVtxBufferData(unsigned char <strong>out_bytes, int <em>out_size){
        </em>out_bytes=(unsigned char <em>)self-&gt;VtxBuffer.Data;
        </em>out_size=self-&gt;VtxBuffer.Size * sizeof(self-&gt;VtxBuffer.Data[0]);
    }
    void GetIdxBufferData(unsigned char </strong>out_bytes, int <em>out_size){
        </em>out_bytes=(unsigned char <em>)self-&gt;IdxBuffer.Data;
        </em>out_size=self-&gt;IdxBuffer.Size * sizeof(self-&gt;IdxBuffer.Data[0]);
    }
}</p>
<p>glBindBuffer(GL_ARRAY_BUFFER, g_VboHandle);
glBufferData(GL_ARRAY_BUFFER, cmd_list.VtxBuffer.Size * SIZEOF_ImDrawVert, cmd_list.GetVtxBufferData(), GL_STREAM_DRAW);</p>
<p>glBindBuffer(GL_ELEMENT_ARRAY_BUFFER, g_ElementsHandle);
glBufferData(GL_ELEMENT_ARRAY_BUFFER, cmd_list.IdxBuffer.Size * SIZEOF_Idx, cmd_list.GetIdxBufferData(), GL_STREAM_DRAW);</p>
<p>Shutdownの移植
def Shutdown():
    InvalidateDeviceObjects();
    imgui.Shutdown();</p>
<p>def InvalidateDeviceObjects():
    global g_VaoHandle
    global g_VboHandle
    global g_ElementsHandle
    global g_ShaderHandle
    global g_VertHandle
    global g_FragHandle
    global g_FontTexture</p>
<pre class="code literal-block"><span></span>if (g_VaoHandle): glDeleteVertexArrays(1, g_VaoHandle);
if (g_VboHandle): glDeleteBuffers(1, g_VboHandle);
if (g_ElementsHandle): glDeleteBuffers(1, g_ElementsHandle);
g_VaoHandle = g_VboHandle = g_ElementsHandle = 0;

if (g_ShaderHandle and g_VertHandle): glDetachShader(g_ShaderHandle, g_VertHandle);
if (g_VertHandle): glDeleteShader(g_VertHandle);
g_VertHandle = 0;

if (g_ShaderHandle and g_FragHandle): glDetachShader(g_ShaderHandle, g_FragHandle);
if (g_FragHandle): glDeleteShader(g_FragHandle);
g_FragHandle = 0;

if (g_ShaderHandle): glDeleteProgram(g_ShaderHandle);
g_ShaderHandle = 0;

if (g_FontTexture):
    glDeleteTextures(1, g_FontTexture);
    imgui.GetIO().Fonts.SetTexID(0);
    g_FontTexture = 0;
</pre>

<p>ProcessEventの移植
def ProcessEvent(event):
    global g_MouseWheel
    global g_MousePressed</p>
<pre class="code literal-block"><span></span>io = imgui.GetIO();
if event.type==SDL_MOUSEWHEEL:
    if (event.wheel.y &gt; 0):
        g_MouseWheel = 1;
    if (event.wheel.y &lt; 0):
        g_MouseWheel = -1;
    return True;
elif event.type==SDL_MOUSEBUTTONDOWN:
    if (event.button.button == SDL_BUTTON_LEFT): g_MousePressed[0] = True;
    if (event.button.button == SDL_BUTTON_RIGHT): g_MousePressed[1] = True;
    if (event.button.button == SDL_BUTTON_MIDDLE): g_MousePressed[2] = True;
    return True;
elif event.type==SDL_TEXTINPUT:
    io.AddInputCharactersUTF8(event.text.text);
    return True;
elif event.type==SDL_KEYDOWN or event.type==SDL_KEYUP:
    key = event.key.keysym.sym &amp; ~SDLK_SCANCODE_MASK;
    io.SetKeysDown(key, event.type == SDL_KEYDOWN);
    io.KeyShift = ((SDL_GetModState() &amp; KMOD_SHIFT) != 0);
    io.KeyCtrl = ((SDL_GetModState() &amp; KMOD_CTRL) != 0);
    io.KeyAlt = ((SDL_GetModState() &amp; KMOD_ALT) != 0);
    io.KeySuper = ((SDL_GetModState() &amp; KMOD_GUI) != 0);
    return True;

return False;
</pre>

<p>io.KeysDown
セッター
%extend ImGuiIO {
    void SetKeysDown(int k, int v)
    {
        ImGui::GetIO().KeysDown[k]=v;
    }
}</p>
<p>かくしてほぼ動くようになった。</p>
<p>実際には新しいWidgetをPythonから使用するたびに値をやりとりする部分を追加しなければならないが、そこはおいおいやっていく。
VisualStudioのセットアップ
こういうネイティブモジュールの開発ではないとクラッシュの原因を探すのが困難になるが、VisualStudioで普通にアタッチできるので便利。
ひとつのsolutionにpythonプロジェクトと、c++のdllプロジェクトを同居させてデバッグできる。</p>
<p>あとで書く</p>
</div>

<hr>
<ul class="pager hidden-print">
<li class="previous">
        <a href="../../../../github/swigimgui/" rel="prev" title="SwigImGui">
            SwigImGui 👈
        </a>
    </li>
    <li style="flex-grow: 1">
    <li class="next">
        <a href="../../glbufferdata/" rel="next" title="PyOpenGLのglBufferDataにはどんなデータが渡せるのか">
            👉 PyOpenGLのglBufferDataにはどんなデータが渡せるのか
        </a>
    </li>
</ul></main><footer id="footer"><p>
            Powered by
            <a href="https://getnikola.com" rel="nofollow">Nikola</a>
        </p>
    </footer>
</body>
</html>
