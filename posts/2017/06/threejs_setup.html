
<!DOCTYPE html>

<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>title: &#34;threejsとwebsocketを使った開発環境&#34; date: 2017-06-07 taxonomies: {tags: []} &#8212; 三次元日誌  ドキュメント</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/alabaster.css" />
    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/translations.js"></script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <link rel="index" title="索引" href="../../../genindex.html" />
    <link rel="search" title="検索" href="../../../search.html" /> 
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />
 
<link
  rel="alternate"
  type="application/atom+xml"
  href="../../../blog/atom.xml"
  title="三次元日誌(ablog)"
/>
 
<style type="text/css">
  ul.ablog-archive {
    list-style: none;
    overflow: auto;
    margin-left: 0px;
  }
  ul.ablog-archive li {
    float: left;
    margin-right: 5px;
    font-size: 80%;
  }
  ul.postlist a {
    font-style: italic;
  }
  ul.postlist-style-disc {
    list-style-type: disc;
  }
  ul.postlist-style-none {
    list-style-type: none;
  }
  ul.postlist-style-circle {
    list-style-type: circle;
  }
</style>

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
             <hr class="docutils" />
<section id="title-threejswebsocket-date-2017-06-07-taxonomies-tags">
<h1>title: &quot;threejsとwebsocketを使った開発環境&quot;
date: 2017-06-07
taxonomies: {tags: []}<a class="headerlink" href="#title-threejswebsocket-date-2017-06-07-taxonomies-tags" title="このヘッドラインへのパーマリンク">¶</a></h1>
<p>threejsのソースを自前で、minimizeする環境を模索する。</p>
<p>なんとなくwebpackをメインに据えてみたい。
npm install -g xxxは適宜やるとして省略。
es2015メモ</p>
<p>const, let
無名関数はアロー形式で()=&gt;{} もしくは()=&gt;expression
文字テンプレート<code class="docutils literal notranslate"><span class="pre">${expression}</span></code>
promise, await</p>
<p>Project作成
<span class="math notranslate nohighlight">\( mkdir app
\)</span> cd app
app$ npm init</p>
<p>とりあえずgitに登録しよう。
.gitignoreは、</p>
<p>https://github.com/github/gitignore/blob/master/Node.gitignore
https://raw.githubusercontent.com/github/gitignore/master/Node.gitignore</p>
<p>をそのまま採用させていただきます。
app<span class="math notranslate nohighlight">\( git init
app\)</span> git add .
app$ git commit -m init</p>
<p>WebSocketServer
app$ npm install websocket --save</p>
<p>server.js
'use strict';</p>
<p>const http = require('http');
const WSServer = require('websocket').server;
const url = require('url');
const fs = require('fs')</p>
<p>const port=8888;</p>
<p>function onHttpRequest(req, res)
{
fs.readFile('client.html', 'utf8', (err, text)=&gt;{
res.writeHead(200, { 'Content-Type': 'text/html'});
res.end(text);
});
}
const plainHttpServer = http.createServer(onHttpRequest).listen(port);
const webSocketServer = new WSServer({httpServer: plainHttpServer});</p>
<p>let clients=[];
function broadcast(message) {
clients.forEach((con, i)=&gt; {
con.send(message);
});
}</p>
<p>function onRequest(req)
{
const websocket = req.accept(null, req.origin || '*');</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>clients.push(websocket);

websocket.send(&quot;welcome to this server&quot;);
broadcast(`clients: [${clients.map((v, i)=&gt;v.remoteAddress[0]).join(&#39;, &#39;)}]`);

websocket.on(&#39;message&#39;, (msg)=&gt;{
    console.log(`&quot;${msg.utf8Data}&quot; is recieved from ${req.origin} !`);
    websocket.send(msg.utf8Data);
});

websocket.on(&#39;close&#39;, (code,desc)=&gt;{
    console.log(`connection released!: ${code} - ${desc}`);

    clients=clients.filter((v, i)=&gt;v!=websocket);
    broadcast(`clients: [${clients.map((v, i)=&gt;v.remoteAddress[0]).join(&#39;, &#39;)}]`);
});
</pre></div>
</div>
<p>}</p>
<p>webSocketServer.on('request', onRequest);</p>
<p>console.log(<code class="docutils literal notranslate"><span class="pre">server</span> <span class="pre">start:</span> <span class="pre">${port}</span></code>);</p>
<p>client.html</p>
<html>
    <head>
    </head>
    <body>
        <input id="message" type="text"><button id="send">send</button>
        <div id="output"></div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>    &lt;script&gt;
</pre></div>
</div>
<p>'use strict';
let attempts = 1;
let ws=null;</p>
<p>const output = document.getElementById('output');
const sendmessage = document.getElementById('message');
sendmessage.addEventListener('keydown', (e)=&gt;{
if(e.keyCode==13){
send(sendmessage.value);
}
});
document.getElementById('send').addEventListener('click', ()=&gt;send(sendmessage.value));</p>
<p>function logger(msg)
{
output.innerHTML += <code class="docutils literal notranslate"><span class="pre">&lt;div&gt;${msg}&lt;/div&gt;</span></code>;
}
function send(msg)
{
ws.send(msg);
logger(<code class="docutils literal notranslate"><span class="pre">send:</span> <span class="pre">${msg}</span></code>);
}</p>
<p>function createWebSocket () {
logger(<code class="docutils literal notranslate"><span class="pre">connecting...</span> <span class="pre">${attempts++}</span></code>);</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>ws = new WebSocket(`ws://${location.host}`);

ws.onopen = (e)=&gt; {
    logger(`${e.type}: ${e.code || &#39;&#39;}`);

    // reset the tries back to 1 since we have a new ws opened.
    attempts = 1; 

    // ...Your app&#39;s logic...
}

ws.onclose = (e)=&gt; {
    logger(`${e.type}: ${e.code || &#39;&#39;}`);
    ws=null;

    const time = generateInterval(attempts);

    setTimeout(()=&gt;{
        // Connection has closed so try to reconnect every 10 seconds.
        createWebSocket(); 
    }, time);
}

ws.onmessage =(e)=&gt;{
    logger(`${e.type}: ${e.data}`);
}
</pre></div>
</div>
<p>}</p>
<p>function generateInterval (k) {
let maxInterval = (Math.pow(2, k) - 1) * 1000;</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>if (maxInterval &gt; 30*1000) {
    maxInterval = 30*1000; // If the generated interval is more than 30 seconds, truncate it down to 30 seconds.
}

// generate the interval to a random number between 0 and the maxInterval determined from above
return Math.random() * maxInterval; 
</pre></div>
</div>
<p>}</p>
<p>window.addEventListener('DOMContentLoaded', ()=&gt; createWebSocket());
</script>
</body></p>
</html>
<p>WebSocketを再接続するアルゴリズムの工夫</p>
<p>webpack</p>
<p>http://webpack.github.io/docs/tutorials/getting-started/</p>
<p>threejs</p>
</section>

<div class="section">
   
</div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../index.html">三次元日誌</a></h1>








<h3>ナビゲーション</h3>


<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">クイック検索</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="検索" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2021, ousttrue.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 4.3.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../../../_sources/posts/2017/06/threejs_setup.md.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>