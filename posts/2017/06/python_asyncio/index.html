<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="generator" content="Nikola (getnikola.com)">
<meta name="viewport" content="width=device-width">
<script src="../../../../assets/js/all-nocdn.js"></script><title>Python3ã®asyncioã«ã¤ã„ã¦ã®ãƒ¡ãƒ¢ | ä¸‰æ¬¡å…ƒæ—¥èªŒ</title>
<link href="../../../../assets/css/code.css" rel="stylesheet" type="text/css">
<link href="../../../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
</head>
<body>
    <h1 id="brand">
        <a href="../../../../" title="ä¸‰æ¬¡å…ƒæ—¥èªŒ" rel="home">
            <span id="blog-title">ä¸‰æ¬¡å…ƒæ—¥èªŒ</span>
        </a>
    </h1>

    <nav id="menu"><ul>
<li><a href="../../../../archive.html">Archives</a></li>
<li><a href="../../../../categories/index.html">Tags</a></li>
<li><a href="../../../../rss.xml">RSS feed</a></li>
<li><a href="../../../../about">About</a></li>
<li><a href="../../../../books">MemoBooks</a></li>

            
            
            
        </ul></nav><hr>
<main id="content"><h1 class="p-name entry-title" itemprop="headline name">
    <h1 class="p-name entry-title" itemprop="headline name">
    <a href="." class="u-url">Python3ã®asyncioã«ã¤ã„ã¦ã®ãƒ¡ãƒ¢</a>
</h1>
<ul itemprop="keywords" class="tags">
<li>
        <time datetime="2017-06-10T00:00:00+09:00" title="2017-06-10">2017-06-10</time>
</li>
</ul>
</h1>

<div>
<p>Pythonã®Version3.4ã‹ã‚‰å§‹ã¾ã£ãŸasyncioå‘¨ã‚Šã«ã¤ã„ã¦ã®ãƒ¡ãƒ¢ã€‚
ç’°å¢ƒã¯ã€Windows10ä¸Šã®python3.6(64bit)ã€‚</p>
<p>Version
Python3.4</p>
<p>asyncio
yield from</p>
<p>Python3.5</p>
<p>async def
await</p>
<p>EventLoop</p>
<p>https://docs.python.org/3/library/asyncio-eventloop.html</p>
<p>import asyncio
loop=asyncio.get_event_loop()
print(loop)</p>
<h2>&lt;_WindowsSelectorEventLoop running=False closed=False debug=False&gt;</h2>
<p>loop.run_forever()
print('done')</p>
<p>ãŸã ã—æ°¸é (forever)èµ°ã‚Šç¶šã‘ã‚‹ã®ã§ãƒ—ãƒ­ã‚»ã‚¹ã‚’killã—ãªã„ã¨æ­¢ã¾ã‚‰ãšã€‚
Windowså‘ã‘ã®loop</p>
<p>https://docs.python.org/3/library/asyncio-eventloops.html#asyncio.ProactorEventLoop</p>
<p>import asyncio
import sys</p>
<p>if sys.platform == 'win32':
    loop = asyncio.ProactorEventLoop()
    # <proactoreventloop running="False" closed="False" debug="False">
    asyncio.set_event_loop(loop)
else:
    loop = asyncio.get_event_loop()</proactoreventloop></p>
<p>ä»¥é™ã€loopã‚’å¾—ã‚‹ã‚³ãƒ¼ãƒ‰ã‚’çœç•¥ã€‚
EventLoopã«é–¢æ•°ã‚’æŠ•å…¥ã™ã‚‹
def func(loop):
    loop.stop() # åœæ­¢</p>
<p>loop.call_soon(func, loop)
loop.run_forever()
print('done')</p>
<p>asyncio.get_event_loopã§loopã‚’å–å¾—ã€‚loop.call_soonã§loopã«é–¢æ•°ã‚’æŠ•å…¥ã§ãã‚‹ã€‚
æŠ•å…¥ã•ã‚ŒãŸé–¢æ•°ã¯ã€loop.run_foreverã§æ¶ˆåŒ–ã•ã‚Œã‚‹ã€‚
ã¤ã„ã§ã«ã€loop.stopã§run_foreverã‹ã‚‰æŠœã‘ã‚‹ã“ã¨ãŒã§ãã‚‹ã€‚
EventLoopã«generatorã‚’æŠ•å…¥ã™ã‚‹
def gen(loop, name, count):
    print(name, loop.time())
    for i in range(count):
        print(name, i, loop.time())
        yield
    print(name, 'done')
    loop.stop()</p>
<p>asyncio.ensure_future(gen(loop, 'a', 3))
asyncio.ensure_future(gen(loop, 'b', 3))
loop.run_forever()</p>
<p>a 534341.609
a 0 534341.609
b 534341.609
b 0 534341.609
a 1 534341.609
b 1 534341.609
a 2 534341.609
b 2 534341.609
a done
b done</p>
<p>loop.stopã§æ­¢ã¾ã£ãŸã€‚
ã™ã¹ã¦ã®taskãŒçµ‚ã‚ã‚‹ã®ã‚’å¾…ã¤
def gen(loop, name, count):
    print(name, loop.time())
    for i in range(count):
        print(name, i, loop.time())
        yield
    print(name, 'done')</p>
<p>taskA=asyncio.ensure_future(gen(loop, 'a', 3), loop=loop)
taskB=asyncio.ensure_future(gen(loop, 'b', 5), loop=loop)
future=asyncio.gather(taskA, taskB)
future.add_done_callback(lambda future: loop.stop())
task=asyncio.ensure_future(future, loop=loop)</p>
<p>loop.run_forever()</p>
<p>a 571911.359
a 0 571911.359
b 571911.359
b 0 571911.359
a 1 571911.359
b 1 571911.359
a 2 571911.359
b 2 571911.359
a done
b 3 571911.359
b 4 571911.359
b done</p>
<p>loop.run_until_completeã§futureãŒçµ‚ã‚ã‚‹ã®ã‚’å¾…ã¤
def gen(loop, name, count):
    print(name, loop.time())
    for i in range(count):
        print(name, i, loop.time())
        yield
    print(name, 'done')
futureA=asyncio.ensure_future(gen(loop, 'a', 3), loop=loop)
futureB=asyncio.ensure_future(gen(loop, 'b', 5), loop=loop)
future=asyncio.gather(futureA, futureB)</p>
<p>loop.run_until_complete(future)</p>
<p>futureã®çµ‚äº†ã‚’å¾…ã£ã¦loop.stopã—ãŸã„ãªã‚‰run_until_completeã™ã‚‹ã®ãŒæ˜ç­ã€‚
PEP492 â€“ Coroutines with async and await syntax(python3.5 09-Apr-2015)</p>
<p>generatorã‚’æµç”¨ã—ãŸcoroutineã¯ç´›ã‚‰ã‚ã—ã„ã®ã§ã€coroutineã«ç‹¬è‡ªã®ã‚·ãƒ³ã‚¿ãƒƒã‚¯ã‚¹ã‚’å°å…¥ã™ã‚‹ã§ã€‚native coroutineã¨å‘¼ç§°ã™ã‚‹ã€‚Cã§å®Ÿè£…ã—ã¦ã„ã‚‹ã‚ã‘ã§ã¯ãªã„ã€‚
é–¢æ•°å†…ã§awaitã‚’ä½¿ã‚ãªãã¦ã‚‚coroutineã¨ã—ã¦æœ‰åŠ¹</p>
<p>async def read_data(db):
    pass</p>
<p>EventLoopã«native coroutineã‚’æŠ•å…¥ã™ã‚‹
async def gen(loop, name, count):
    print(name, loop.time())
    for i in range(count):
        print(name, i, loop.time())
        #yield
        await asyncio.sleep(0)
    print(name, 'done')</p>
<p>taskA=asyncio.ensure_future(gen(loop, 'a', 3), loop=loop)
taskB=asyncio.ensure_future(gen(loop, 'b', 5), loop=loop)
future=asyncio.gather(taskA, taskB)</p>
<p>loop.run_until_complete(future)</p>
<p>yieldã‚’await asyncio.sleep(0)ã§ç½®ãæ›ãˆãŸã€‚
yieldã®ã¾ã¾ã ã¨TypeErrorã«ãªã‚‹ã€‚
Traceback (most recent call last):
  File ".\exp.py", line 18, in <module>
    taskA=asyncio.ensure_future(gen(loop, 'a', 3), loop=loop)
  File "D:\Python36\lib\asyncio\tasks.py", line 519, in ensure_future
    raise TypeError('A Future, a coroutine or an awaitable is required')
TypeError: A Future, a coroutine or an awaitable is required</module></p>
<p>It is a TypeError if <strong>await</strong> returns anything but an iterator.
å®Ÿé¨“ã€‚
def it():
    yield</p>
<p>async def co_y():
    yield</p>
<p>async def co():
    pass</p>
<p><class><class>
.\exp.py:22: RuntimeWarning: coroutine 'co' was never awaited
  print(type(co()))
<class></class></class></class></p>
<p>async_generatorâ€¦ã€‚async defå†…ã§yieldã™ã‚‹ã¨é•ã†ã‚‚ã®ã«ãªã‚‹ã®ã­ã€‚syntax errorã«ã¯ã§ãã‚“ãªã€‚
è‡ªå‰ã®ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ—ã«loopã‚’çµ„ã¿è¾¼ã‚€ã¨ã™ã‚Œã°
loop.onceã®ã‚ˆã†ãªé–¢æ•°ãŒã‚ã‚‹ã¨æ¯ãƒ•ãƒ¬ãƒ¼ãƒ å°å‡ºã—ã«ã‚¿ã‚¹ã‚¯ã‚’æ¶ˆåŒ–ã§ãã‚‹ã®ã ãŒã€‚
ã‚°ã‚°ã£ã¦ã¿ãŸã€‚</p>
<p>https://stackoverflow.com/questions/29868372/python-asyncio-run-event-loop-once</p>
<p>loop.stop(); loop.run_forever()</p>
<p>ãªã‚‹ã»ã©ã€‚
async def gen(loop, name, count):
    print(name, loop.time())
    for i in range(count):
        print(name, i, loop.time())
        await asyncio.sleep(0)
    print(name, 'done')</p>
<p>taskA=asyncio.ensure_future(gen(loop, 'a', 3), loop=loop)
taskB=asyncio.ensure_future(gen(loop, 'b', 5), loop=loop)
future=asyncio.gather(taskA, taskB)</p>
<p>count=1
while not future.done():
    print(count)
    count+=1
    # loop one step
    loop.stop()
    loop.run_forever()</p>
<p>print('done')</p>
<p>1
a 579281.828
a 0 579281.828
b 579281.828
b 0 579281.828
2
a 1 579281.828
b 1 579281.828
3
a 2 579281.828
b 2 579281.828
4
a done
b 3 579281.828
5
b 4 579281.828
6
b done
7
done</p>
<p>ã„ã„ã‹ã‚“ã˜ã«ãªã£ãŸã€‚ã“ã‚Œãªã‚‰ä»˜ãåˆã£ã¦ã„ã‘ãã†ã ã€‚</p>
</div>

<ul class="pager hidden-print">
<li class="previous">
        <a href="../threejs_setup/" rel="prev" title="threejsã¨websocketã‚’ä½¿ã£ãŸé–‹ç™ºç’°å¢ƒ">
            threejsã¨websocketã‚’ä½¿ã£ãŸé–‹ç™ºç’°å¢ƒ ğŸ‘ˆ
        </a>
    </li>
    <li style="flex-grow: 1">
    <li class="next">
        <a href="../ts_module/" rel="next" title="Typescriptã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã§ã¾ãŸã¯ã¾ã‚‹">
            ğŸ‘‰ Typescriptã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã§ã¾ãŸã¯ã¾ã‚‹
        </a>
    </li>
</ul></main><footer id="footer"><p>
            Powered by
            <a href="https://getnikola.com" rel="nofollow">Nikola</a>
        </p>
    </footer>
</body>
</html>
