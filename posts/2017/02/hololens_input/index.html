<!DOCTYPE html>
<html><body>
    <h1 id="brand">
        <a href="../../../../" title="三次元日誌" rel="home">
            <span id="blog-title">三次元日誌</span>
        </a>
    </h1>
    <hr>
<main id="content"><h1 class="p-name entry-title" itemprop="headline name">
    <a href="." class="u-url">HoloToolkitのInputManager</a>
</h1>
<div>
<p>HololensのInputManagerの動きを読んでみた</p>
<p>HoloToolkit.Unity.InputModule.InputManager
Assets/HoloToolkit/Input/Prefabs/InputManagerプレハブから見る。
InputManager
  + (GazeManager)
  + (GazeStablilizer)
  + (InputManager)
  + (StabilizationPlaneModifier)</p>
<p>GesturesInput# BaseInputSource(UnityEngine.VR.WSA.Input.GestureRecognizerを通じてジェスチャーを取得する)
  RawInteractionSourcesInput# BaseInputSource(UnityEngine.VR.WSA.Input.InteractionSourceを通じて手の検出・位置・ロストなどのイベントを検知する)
  EditorHandsInput# BaseInputSource(Editor向けに手イベントを偽装する)</p>
<p>こんな感じに親子関係があって結構たくさんスクリプトがアタッチされている。
主要な部分だけに減らすと以下の3つのスクリプトになる。
InputManager
  + (GazeManager)
  + (InputManager)
  GesturesInput# BaseInputSource(UnityEngine.VR.WSA.Input.GestureRecognizerを通じてジェスチャーを取得する)</p>
<p>この３つのスクリプトは下記のように連携する。
GazeManager -&gt; raycast -&gt; hitObject
                                  |
                                  v
GesturesInput -&gt; event -&gt; InputManager -&gt; hitObjectのeventハンドラを実行する</p>
<p>UnityのEventSystemとの連携
通常のUnityのEventは、EventSystemがアタッチされたInputModule(StandardInputModule)のProcess関数をコールすることで始まる。
HoloToolkitのInputManagerは、GestureRecognizer等からのイベントを即座にUnityのEventに変換して発行していた。
ShouldSendUnityUiEventsでInputManager.csを検索すると以下がヒットする。
HoloToolkit-Unity\Assets\HoloToolkit\Input\Scripts\InputManager.cs(308)
HoloToolkit-Unity\Assets\HoloToolkit\Input\Scripts\InputManager.cs(317)
HoloToolkit-Unity\Assets\HoloToolkit\Input\Scripts\InputManager.cs(340)
HoloToolkit-Unity\Assets\HoloToolkit\Input\Scripts\InputManager.cs(363)
HoloToolkit-Unity\Assets\HoloToolkit\Input\Scripts\InputManager.cs(386)</p>
<p>コードを見てみると
// hololensのevent
ExecuteEvents.ExecuteHierarchy(newObject, null, OnFocusEnterEventHandler);
if (ShouldSendUnityUiEvents)
{
    // unity仕様に変換して実行
    ExecuteEvents.ExecuteHierarchy(newObject
        , GazeManager.Instance.UnityUIPointerEvent, ExecuteEvents.pointerEnterHandler);
}</p>
<p>という風になっていて、以下の5種類のイベント転送を実装していた。</p>
<p>IPointerClickHandler
IPointerDownHandler
IPointerEnterHandler
IPointerExitHandler
IPointerUpHandler</p>
<p>これだとButton等のクリックイベントを処理するタイプのものは動く。
DragとかScrollイベントは別途イベント転送してやる必要がありそう。
なるほど。</p>
</div>
    </main>
</body></html>
