<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="generator" content="Nikola (getnikola.com)">
<meta name="viewport" content="width=device-width">
<script src="../../../assets/js/all-nocdn.js"></script><title>dracoの基本 | 三次元日誌</title>
<link href="../../../assets/css/code.css" rel="stylesheet" type="text/css">
<link href="../../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
</head>
<body>
    <h1 id="brand">
        <a href="../../../" title="三次元日誌" rel="home">
            <span id="blog-title">三次元日誌</span>
        </a>
    </h1>

    <nav id="menu"><ul>
<li><a href="../../../archive.html">Archives</a></li>
<li><a href="../../../categories/index.html">Tags</a></li>
<li><a href="../../../rss.xml">RSS feed</a></li>
<li><a href="../../../about">About</a></li>
<li><a href="../../../books">MemoBooks</a></li>

            
            
            
        </ul></nav><hr>
<main id="content"><h1 class="p-name entry-title" itemprop="headline name">
    <h1 class="p-name entry-title" itemprop="headline name">
    <a href="." class="u-url">dracoの基本
    </a>
</h1>
<ul itemprop="keywords" class="tags">
<li>
        <time datetime="2017-12-12T00:00:00+09:00" title="2017-12-12">2017-12-12</time>
</li>
    <li><a class="tag p-category" href="../../../categories/gltf/" rel="tag">gltf</a></li>
</ul>
</h1>

<div>
<p>Googleのメッシュ圧縮ライブラリDracoの使い方を調査中。</p>
<p><a href="https://github.com/google/draco">https://github.com/google/draco</a></p>
<p>コマンドラインツールから <code>obj</code> と <code>ply</code> 形式の読み書きができるのでそこから解読する。
ポイントクラウドの読み書き
点群を表す <code>draco::PointCloud</code> 型があって、それを継承して面を追加した <code>draco::Mesh</code> 型がある。
まずは、基本となる <code>PointCloud</code> の読み書き。</p>
<pre class="code literal-block"><span></span><span class="cp">#include</span> <span class="cpf">"draco/point_cloud/point_cloud.h"</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">"draco/point_cloud/point_cloud_builder.h"</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">"draco/compression/encode.h"</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">"draco/compression/decode.h"</span><span class="cp"></span>


<span class="k">struct</span> <span class="n">Vector3</span>
<span class="p">{</span>
    <span class="kt">float</span> <span class="n">x</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">y</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">z</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm">static int AddPositionAttribute(draco::PointCloud *pc, int vertexCount)</span>
<span class="cm">{</span>
<span class="cm">    draco::GeometryAttribute va;</span>
<span class="cm">    va.Init(draco::GeometryAttribute::POSITION, nullptr, 3, draco::DT_FLOAT32, false, </span>
<span class="cm">        sizeof(float) * 3, 0);</span>
<span class="cm">    return pc-&gt;AddAttribute(va, false, vertexCount);</span>
<span class="cm">}</span>
<span class="cm">static int AddTexCoordAttribute(draco::PointCloud *pc, int vertexCount)</span>
<span class="cm">{</span>
<span class="cm">    draco::GeometryAttribute va;</span>
<span class="cm">    va.Init(draco::GeometryAttribute::TEX_COORD, nullptr, 2, draco::DT_FLOAT32, false,</span>
<span class="cm">        sizeof(float) * 2, 0);</span>
<span class="cm">    return pc-&gt;AddAttribute(va, false, vertexCount);</span>
<span class="cm">}</span>
<span class="cm">static int AddNormaldAttribute(draco::PointCloud *pc, int vertexCount)</span>
<span class="cm">{</span>
<span class="cm">    draco::GeometryAttribute va;</span>
<span class="cm">    va.Init(draco::GeometryAttribute::NORMAL, nullptr, 3, draco::DT_FLOAT32, false,</span>
<span class="cm">        sizeof(float) * 3, 0);</span>
<span class="cm">    return pc-&gt;AddAttribute(va, false, vertexCount);</span>
<span class="cm">}</span>
<span class="cm">*/</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">Vector3</span> <span class="n">vertices</span><span class="p">[]</span> <span class="o">=</span>
    <span class="p">{</span>
        <span class="p">{</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">},</span>
        <span class="p">{</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="p">},</span>
        <span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="p">},</span>
        <span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="p">},</span>
    <span class="p">};</span>

    <span class="c1">// setup point cloud</span>
    <span class="cm">/*</span>
<span class="cm">    draco::PointCloud pc;</span>
<span class="cm">    pc.set_num_points(_countof(vertices));</span>

<span class="cm">    {</span>
<span class="cm">        auto pos_att_id = AddPositionAttribute(&amp;pc, _countof(vertices));</span>
<span class="cm">        auto attr = pc.attribute(pos_att_id);</span>
<span class="cm">        auto size = attr-&gt;size();</span>
<span class="cm">        attr-&gt;SetAttributeValue(draco::AttributeValueIndex(0), vertices);</span>
<span class="cm">    }</span>
<span class="cm">    */</span>
    <span class="n">draco</span><span class="o">::</span><span class="n">PointCloudBuilder</span> <span class="n">builder</span><span class="p">;</span>
    <span class="n">builder</span><span class="p">.</span><span class="n">Start</span><span class="p">(</span><span class="n">_countof</span><span class="p">(</span><span class="n">vertices</span><span class="p">));</span>
    <span class="k">auto</span> <span class="n">pos_att_id</span> <span class="o">=</span> <span class="n">builder</span><span class="p">.</span><span class="n">AddAttribute</span><span class="p">(</span><span class="n">draco</span><span class="o">::</span><span class="n">GeometryAttribute</span><span class="o">::</span><span class="n">POSITION</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">draco</span><span class="o">::</span><span class="n">DT_FLOAT32</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">_countof</span><span class="p">(</span><span class="n">vertices</span><span class="p">);</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">builder</span><span class="p">.</span><span class="n">SetAttributeValueForPoint</span><span class="p">(</span><span class="n">pos_att_id</span><span class="p">,</span> <span class="n">draco</span><span class="o">::</span><span class="n">PointIndex</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">vertices</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
    <span class="p">}</span>
    <span class="k">auto</span> <span class="n">res</span> <span class="o">=</span> <span class="n">builder</span><span class="p">.</span><span class="n">Finalize</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>

    <span class="n">draco</span><span class="o">::</span><span class="n">EncoderBuffer</span> <span class="n">encodeBuffer</span><span class="p">;</span>
    <span class="p">{</span>
        <span class="c1">// encode</span>
        <span class="n">draco</span><span class="o">::</span><span class="n">Encoder</span> <span class="n">encoder</span><span class="p">;</span>
        <span class="k">auto</span>  <span class="n">status</span> <span class="o">=</span> <span class="n">encoder</span><span class="p">.</span><span class="n">EncodePointCloudToBuffer</span><span class="p">(</span><span class="o">*</span><span class="n">res</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">encodeBuffer</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="p">{</span>
        <span class="c1">// decode</span>
        <span class="n">draco</span><span class="o">::</span><span class="n">DecoderBuffer</span> <span class="n">decodeBuffer</span><span class="p">;</span>
        <span class="n">decodeBuffer</span><span class="p">.</span><span class="n">Init</span><span class="p">(</span><span class="n">encodeBuffer</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span> <span class="n">encodeBuffer</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>

        <span class="n">draco</span><span class="o">::</span><span class="n">Decoder</span> <span class="n">decoder</span><span class="p">;</span>
        <span class="k">auto</span> <span class="n">statusor</span> <span class="o">=</span> <span class="n">decoder</span><span class="p">.</span><span class="n">DecodePointCloudFromBuffer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">decodeBuffer</span><span class="p">);</span>

        <span class="k">auto</span> <span class="n">dpc</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">statusor</span><span class="p">).</span><span class="n">value</span><span class="p">();</span>
        <span class="k">auto</span> <span class="n">num</span> <span class="o">=</span> <span class="n">dpc</span><span class="o">-&gt;</span><span class="n">NumNamedAttributes</span><span class="p">(</span><span class="n">draco</span><span class="o">::</span><span class="n">GeometryAttribute</span><span class="o">::</span><span class="n">POSITION</span><span class="p">);</span>
        <span class="k">auto</span> <span class="n">attr</span> <span class="o">=</span> <span class="n">dpc</span><span class="o">-&gt;</span><span class="n">GetNamedAttribute</span><span class="p">(</span><span class="n">draco</span><span class="o">::</span><span class="n">GeometryAttribute</span><span class="o">::</span><span class="n">POSITION</span><span class="p">);</span>
        <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Vector3</span><span class="o">&gt;</span> <span class="n">positions</span><span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">());</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">positions</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">attr</span><span class="o">-&gt;</span><span class="n">ConvertValue</span><span class="o">&lt;</span><span class="kt">float</span><span class="p">,</span> <span class="mi">3</span><span class="o">&gt;</span><span class="p">(</span><span class="n">draco</span><span class="o">::</span><span class="n">AttributeValueIndex</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">positions</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">x</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre>

<p>参考になるファイルは、</p>
<ul>
<li>point_cloud_builder_test.cc(build point cloud)</li>
<li>draco_encoder.cc(obj to draco)</li>
<li>draco_decoder.cc(draco to obj)</li>
</ul>
<p>PointCloud -&gt; dracoとdraco-&gt;PointCloud-&gt;get points は簡単でAPIを素直に呼び出せばいい。
問題は如何に PointCloud を構築するか。 draco_encoder から解読したローレベルのAPIでやってみたらうまくいかなかったのだが、draco::PointCloudBuilderを発見した。
Meshの読み書き</p>
<p>ToDo…</p>
</div>

<hr>
<ul class="pager hidden-print">
<li class="previous">
        <a href="../../../github/async_websocket/" rel="prev" title="async_websocket">
            async_websocket 👈
        </a>
    </li>
    <li style="flex-grow: 1">
    <li class="next">
        <a href="../unitychan_crs/" rel="next" title="Unityちゃんの-Candy Rock Star-を研究する">
            👉 Unityちゃんの-Candy Rock Star-を研究する
        </a>
    </li>
</ul></main><footer id="footer"><p>
            Powered by
            <a href="https://getnikola.com" rel="nofollow">Nikola</a>
        </p>
    </footer>
</body>
</html>
