<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="generator" content="Nikola (getnikola.com)">
<meta name="viewport" content="width=device-width">
<script src="../../../assets/js/all-nocdn.js"></script><title>WRLã‚’ä½¿ã£ãŸæœ€è¿‘ã®Comãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚° | ä¸‰æ¬¡å…ƒæ—¥èªŒ</title>
<link href="../../../assets/css/code.css" rel="stylesheet" type="text/css">
<link href="../../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
</head>
<body>
    <h1 id="brand">
        <a href="../../../" title="ä¸‰æ¬¡å…ƒæ—¥èªŒ" rel="home">
            <span id="blog-title">ä¸‰æ¬¡å…ƒæ—¥èªŒ</span>
        </a>
    </h1>

    <nav id="menu"><ul>
<li><a href="../../../archive.html">Archives</a></li>
<li><a href="../../../categories/index.html">Tags</a></li>
<li><a href="../../../rss.xml">RSS feed</a></li>
<li><a href="../../../about">About</a></li>
<li><a href="../../../books">MemoBooks</a></li>

            
            
            
        </ul></nav><hr>
<main id="content"><h1 class="p-name entry-title" itemprop="headline name">
    <h1 class="p-name entry-title" itemprop="headline name">
    <a href="." class="u-url">WRLã‚’ä½¿ã£ãŸæœ€è¿‘ã®Comãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°
    </a>
</h1>
<ul itemprop="keywords" class="tags">
<li>
        <time datetime="2017-09-08T00:00:00+09:00" title="2017-09-08">2017-09-08</time>
</li>
    <li><a class="tag p-category" href="../../../categories/com/" rel="tag">com</a></li>
    <li><a class="tag p-category" href="../../../categories/cpp/" rel="tag">cpp</a></li>
</ul>
</h1>

<p>å¤ã®ATLã®Windows8ä»¥é™ï¼Ÿç‰ˆã®WRLã‚’ä½¿ã£ã¦ã¿ã‚‹ã€‚</p>
<h3>IXMLHTTPRequest2ã‚’ä½¿ã†ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã‚’ãƒ™ãƒ¼ã‚¹ã«WRLåŒ–ã—ã¦ã¿ã‚‹ã€‚</h3>
<p>ComPtr
ä½•ã¯ã¨ã‚‚ã‚ã‚ŒComPtrã‚’å–ã‚Šå…¥ã‚Œã‚‹ã€‚
Before</p>
<div class="code"><pre class="code literal-block"><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;Msxml6.h&gt;</span><span class="cp"></span>
<span class="cp">#pragma comment(lib, "msxml6.lib")</span>

<span class="cp">#define SAFERELEASE(p){ if(p){p-&gt;Release(); p=nullptr;}}</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">**</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">CoInitializeEx</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">COINITBASE_MULTITHREADED</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">IXMLHTTPRequest2</span><span class="w"> </span><span class="o">*</span><span class="n">pXHR</span><span class="o">=</span><span class="k">nullptr</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">hr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CoCreateInstance</span><span class="p">(</span><span class="n">CLSID_FreeThreadedXMLHTTP60</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="nb">NULL</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="n">CLSCTX_INPROC_SERVER</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="n">IID_PPV_ARGS</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pXHR</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">FAILED</span><span class="p">(</span><span class="n">hr</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">EXIT</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="nl">EXIT</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="n">SAFERELEASE</span><span class="p">(</span><span class="n">pXHR</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">CoUninitialize</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">FAILED</span><span class="p">(</span><span class="n">hr</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>

<h3>SAFERELEASEã¨goto</h3>
<p>ComPtrã‚’å–ã‚Šå…¥ã‚Œã¦SAFERELEASEã¨gotoã‚’é™¤å»ã—ã‚ˆã†ã€‚
After
RAIIã‚’å–ã‚Šå…¥ã‚Œã¦ç©æ¥µçš„ã«Early Outã§ãã‚‹(å¾Œå§‹æœ«ãŒè‡ªå‹•ã«ãªã£ãŸã®ã§)ã€‚</p>
<div class="code"><pre class="code literal-block"><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;Msxml6.h&gt;</span><span class="cp"></span>
<span class="cp">#pragma comment(lib, "msxml6.lib")</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;wrl/client.h&gt;</span><span class="cp"></span>


<span class="k">class</span><span class="w"> </span><span class="nc">ComInitializer</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="k">public</span><span class="o">:</span><span class="w"></span>
<span class="w">    </span><span class="n">ComInitializer</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">CoInitializeEx</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">COINITBASE_MULTITHREADED</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="o">~</span><span class="n">ComInitializer</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">CoUninitialize</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">**</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">ComInitializer</span><span class="w"> </span><span class="n">co</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="n">Microsoft</span><span class="o">::</span><span class="n">WRL</span><span class="o">::</span><span class="n">ComPtr</span><span class="o">&lt;</span><span class="n">IXMLHTTPRequest2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">pXHR</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">hr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CoCreateInstance</span><span class="p">(</span><span class="n">CLSID_FreeThreadedXMLHTTP60</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="nb">NULL</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="n">CLSCTX_INPROC_SERVER</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="n">IID_PPV_ARGS</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pXHR</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">FAILED</span><span class="p">(</span><span class="n">hr</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>

<h3>IUnknownå®Ÿè£…ã¨ComPtråˆæœŸåŒ–</h3>
<p>Callbackã®å®šç¾©ç­‰ã§è‡ªã‚‰Comã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å®šç¾©ã™ã‚‹å ´åˆãŒã‚ã‚‹ã€‚
IXMLHTTPRequest2Callbackã‚’å®Ÿè£…ã™ã‚‹ä¾‹ã€‚
Before</p>
<div class="code"><pre class="code literal-block"><span class="k">class</span><span class="w"> </span><span class="nc">CCallback</span><span class="w"> </span><span class="o">:</span><span class="k">public</span><span class="w"> </span><span class="n">IXMLHTTPRequest2Callback</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">ULONG</span><span class="w"> </span><span class="n">m_cRef</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span><span class="w"></span>

<span class="k">public</span><span class="o">:</span><span class="w"></span>
<span class="w">    </span><span class="n">CCallback</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="o">~</span><span class="n">CCallback</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="c1">// IUnknown</span>
<span class="w">    </span><span class="n">STDMETHODIMP_</span><span class="p">(</span><span class="n">ULONG</span><span class="p">)</span><span class="w"> </span><span class="n">AddRef</span><span class="p">()</span><span class="k">override</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">InterlockedIncrement</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m_cRef</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">m_cRef</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="n">STDMETHODIMP_</span><span class="p">(</span><span class="n">ULONG</span><span class="p">)</span><span class="w"> </span><span class="n">Release</span><span class="p">()</span><span class="k">override</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">ULONG</span><span class="w"> </span><span class="n">ulRefCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">InterlockedDecrement</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m_cRef</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">m_cRef</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">delete</span><span class="w"> </span><span class="k">this</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">ulRefCount</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="n">STDMETHODIMP</span><span class="w"> </span><span class="n">QueryInterface</span><span class="w"> </span><span class="p">(</span><span class="n">REFIID</span><span class="w"> </span><span class="n">riid</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">**</span><span class="n">ppvObj</span><span class="p">)</span><span class="k">override</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="c1">// Always set out parameter to NULL, validating it first.</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">ppvObj</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">E_INVALIDARG</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="o">*</span><span class="n">ppvObj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">riid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">IID_IUnknown</span><span class="w"> </span>
<span class="w">                </span><span class="o">||</span><span class="w"> </span><span class="n">riid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">IID_IXMLHTTPRequest2Callback</span><span class="w"> </span>
<span class="w">           </span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="c1">// Increment the reference count and return the pointer.</span>
<span class="w">            </span><span class="o">*</span><span class="n">ppvObj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">LPVOID</span><span class="p">)</span><span class="k">this</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="n">AddRef</span><span class="p">();</span><span class="w"></span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">NOERROR</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">E_NOINTERFACE</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="c1">// IXMLHTTPRequest2Callback</span>
<span class="w">    </span><span class="n">STDMETHODIMP</span><span class="w"> </span><span class="n">OnRedirect</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">__RPC__in_opt</span><span class="w"> </span><span class="n">IXMLHTTPRequest2</span><span class="w"> </span><span class="o">*</span><span class="n">pXHR</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">__RPC__in_string</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">WCHAR</span><span class="w"> </span><span class="o">*</span><span class="n">pwszRedirectUrl</span><span class="p">)</span><span class="k">override</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">E_NOTIMPL</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="n">STDMETHODIMP</span><span class="w"></span>
<span class="w">        </span><span class="n">OnHeadersAvailable</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">__RPC__in_opt</span><span class="w"> </span><span class="n">IXMLHTTPRequest2</span><span class="w"> </span><span class="o">*</span><span class="n">pXHR</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="n">DWORD</span><span class="w"> </span><span class="n">dwStatus</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="n">__RPC__in_string</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">WCHAR</span><span class="w"> </span><span class="o">*</span><span class="n">pwszStatus</span><span class="w"></span>
<span class="w">        </span><span class="p">)</span><span class="k">override</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">E_NOTIMPL</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="n">STDMETHODIMP</span><span class="w"></span>
<span class="w">        </span><span class="n">OnDataAvailable</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">__RPC__in_opt</span><span class="w"> </span><span class="n">IXMLHTTPRequest2</span><span class="w"> </span><span class="o">*</span><span class="n">pXHR</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="n">__RPC__in_opt</span><span class="w"> </span><span class="n">ISequentialStream</span><span class="w"> </span><span class="o">*</span><span class="n">pResponseStream</span><span class="w"></span>
<span class="w">        </span><span class="p">)</span><span class="k">override</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">E_NOTIMPL</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="n">STDMETHODIMP</span><span class="w"></span>
<span class="w">        </span><span class="n">OnResponseReceived</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">__RPC__in_opt</span><span class="w"> </span><span class="n">IXMLHTTPRequest2</span><span class="w"> </span><span class="o">*</span><span class="n">pXHR</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="n">__RPC__in_opt</span><span class="w"> </span><span class="n">ISequentialStream</span><span class="w"> </span><span class="o">*</span><span class="n">pResponseStream</span><span class="w"></span>
<span class="w">        </span><span class="p">)</span><span class="k">override</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">E_NOTIMPL</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="n">STDMETHODIMP</span><span class="w"></span>
<span class="w">        </span><span class="n">OnError</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">__RPC__in_opt</span><span class="w"> </span><span class="n">IXMLHTTPRequest2</span><span class="w"> </span><span class="o">*</span><span class="n">pXHR</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="n">HRESULT</span><span class="w"> </span><span class="n">hrError</span><span class="w"></span>
<span class="w">        </span><span class="p">)</span><span class="k">override</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">E_NOTIMPL</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>
</pre></div>

<p>IUnknownã®å®Ÿè£…(AddRef, Release, QueryInterface)ãŒå®šå‹ã‚³ãƒ¼ãƒ‰ã§ã‚ã‚‹</p>
<p>newã—ãŸã¨ãã«ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹ã‚«ã‚¦ãƒ³ãƒˆãŒ1ã§ã‚ã‚‹ã“ã¨ã€AddRef, Releaseã‚’æ­£ã—ãå®Ÿè£…ã™ã‚‹
QueryInterfaceã‚’æ­£ã—ãå®Ÿè£…ã™ã‚‹(ã‚ã¨ã§ã‚¤ãƒ³ã‚¿ãƒ•ã‚§ãƒ¼ã‚¹ã‚’å¢—æ¸›ã•ã›ãŸã¨ãã«æ›´æ–°ã‚’å¿˜ã‚ŒãŸã‚Šã™ã‚‹)</p>
<p>ComPtrã®åˆæœŸåŒ–ãŒä¸ç©</p>
<div class="code"><pre class="code literal-block"><span class="n">Microsoft</span><span class="o">::</span><span class="n">WRL</span><span class="o">::</span><span class="n">ComPtr</span><span class="o">&lt;</span><span class="n">CCallback</span><span class="o">&gt;</span><span class="w"> </span><span class="n">pCallback</span><span class="p">;</span><span class="w"></span>
<span class="c1">// RefCount=1ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’å†…éƒ¨ãƒã‚¤ãƒ³ã‚¿(&amp;æ¼”ç®—å­)ã«æ¸¡ã™</span>
<span class="o">*</span><span class="p">((</span><span class="n">CCallback</span><span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pCallback</span><span class="p">)</span><span class="o">=</span><span class="k">new</span><span class="w"> </span><span class="n">CCallback</span><span class="p">();</span><span class="w"> </span>
</pre></div>

<p>ã¾ãŸã¯ã€</p>
<div class="code"><pre class="code literal-block"><span class="n">Microsoft</span><span class="o">::</span><span class="n">WRL</span><span class="o">::</span><span class="n">ComPtr</span><span class="o">&lt;</span><span class="n">CCallback</span><span class="o">&gt;</span><span class="w"> </span><span class="n">pCallback</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">CCallback</span><span class="p">);</span><span class="w"> </span><span class="c1">// 1+1ã¯RefCount=2</span>
<span class="n">pCallback</span><span class="p">.</span><span class="n">Get</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">Release</span><span class="p">();</span><span class="w"> </span><span class="c1">// 1ã«æ¸›ã‚‰ã™</span>
</pre></div>

<p>ã®ã‚ˆã†ãªã‚ã‹ã‚‰ã•ã¾ã«ä¸ç©ãªã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã‹ãªã‘ã‚Œã°ãªã‚‰ãªã„ã€‚
é–“é•ã„ã®å…ƒã§ã‚ã‚‹ã€‚
After</p>
<div class="code"><pre class="code literal-block"><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;wrl/implements.h&gt;</span><span class="cp"></span>
<span class="k">class</span><span class="w"> </span><span class="nc">CCallback</span><span class="w"> </span><span class="o">:</span><span class="w"></span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="n">Microsoft</span><span class="o">::</span><span class="n">WRL</span><span class="o">::</span><span class="n">RuntimeClass</span><span class="o">&lt;</span><span class="w"></span>
<span class="w">    </span><span class="n">Microsoft</span><span class="o">::</span><span class="n">WRL</span><span class="o">::</span><span class="n">RuntimeClassFlags</span><span class="o">&lt;</span><span class="n">Microsoft</span><span class="o">::</span><span class="n">WRL</span><span class="o">::</span><span class="n">ClassicCom</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">IXMLHTTPRequest2Callback</span><span class="o">&gt;</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="k">public</span><span class="o">:</span><span class="w"> </span>
<span class="w">    </span><span class="n">CCallback</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="o">~</span><span class="n">CCallback</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="c1">// IXMLHTTPRequest2Callback</span>
<span class="w">    </span><span class="c1">// çœç•¥</span>
<span class="p">};</span><span class="w"></span>
</pre></div>

<p>ã¨ã™ã‚‹ã“ã¨ã§IUnknownã®å®Ÿè£…ã‚’WRL::RuntimeClassã«ä»»ã›ã‚‹ã“ã¨ãŒã§ãã‚‹ã€‚
ã¾ãŸã€newã«ã‚ˆã‚‹åˆæœŸåŒ–ã‚’ç¦æ­¢ã•ã‚Œã‚‹ã®ã§ã€newã§ã¯ãªãWRL::Makeã‚’ä½¿ã†ã€‚</p>
<div class="code"><pre class="code literal-block">error C2248: 'Microsoft::WRL::Details::DontUseNewUseMake::operator new': private ãƒ¡ãƒ³ãƒãƒ¼ (ã‚¯ãƒ©ã‚¹ 'Microsoft::WRL::Details::DontUseNewUseMake' ã§å®£è¨€ã•ã‚Œã¦ã„ã‚‹) ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“ã€‚
</pre></div>

<div class="code"><pre class="code literal-block"><span class="n">Microsoft</span><span class="o">::</span><span class="n">WRL</span><span class="o">::</span><span class="n">ComPtr</span><span class="o">&lt;</span><span class="n">CCallback</span><span class="o">&gt;</span><span class="w"> </span><span class="n">pCallback</span><span class="o">=</span><span class="n">Microsoft</span><span class="o">::</span><span class="n">WRL</span><span class="o">::</span><span class="n">Make</span><span class="o">&lt;</span><span class="n">CCallback</span><span class="o">&gt;</span><span class="p">();</span><span class="w"></span>
</pre></div>

<h3>MakeAndInitialize åˆæœŸåŒ–ãƒ¡ã‚½ãƒƒãƒ‰</h3>
<p>Makeã‚ˆã‚Šã“ã£ã¡ã®æ–¹ãŒComé¢¨ã€‚
RuntimeClassInitializeã¨ã„ã†åå‰ã®ãƒ¡ãƒ³ãƒé–¢æ•°ã§åˆæœŸåŒ–ã™ã‚‹ã€‚å¤±æ•—ã—ãŸå ´åˆã¯S_OKä»¥å¤–ã‚’è¿”ã™ã€‚</p>
<div class="code"><pre class="code literal-block"><span class="k">class</span><span class="w"> </span><span class="nc">CCallback</span><span class="w"> </span><span class="o">:</span><span class="w"></span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="n">Microsoft</span><span class="o">::</span><span class="n">WRL</span><span class="o">::</span><span class="n">RuntimeClass</span><span class="o">&lt;</span><span class="w"></span>
<span class="w">    </span><span class="n">Microsoft</span><span class="o">::</span><span class="n">WRL</span><span class="o">::</span><span class="n">RuntimeClassFlags</span><span class="o">&lt;</span><span class="n">Microsoft</span><span class="o">::</span><span class="n">WRL</span><span class="o">::</span><span class="n">ClassicCom</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">IXMLHTTPRequest2Callback</span><span class="o">&gt;</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="k">public</span><span class="o">:</span><span class="w"> </span>

<span class="w">    </span><span class="n">STDMETHODIMP</span><span class="w"> </span><span class="n">RuntimeClassInitialize</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">S_OK</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="p">};</span><span class="w"></span>

<span class="n">Microsoft</span><span class="o">::</span><span class="n">WRL</span><span class="o">::</span><span class="n">ComPtr</span><span class="o">&lt;</span><span class="n">CCallback</span><span class="o">&gt;</span><span class="w"> </span><span class="n">pCallback</span><span class="p">;</span><span class="w"></span>
<span class="n">hr</span><span class="o">=</span><span class="n">Microsoft</span><span class="o">::</span><span class="n">WRL</span><span class="o">::</span><span class="n">MakeAndInitialize</span><span class="o">&lt;</span><span class="n">CCallback</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pCallback</span><span class="p">);</span><span class="w"></span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">FAILED</span><span class="p">(</span><span class="n">hr</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>

<p>MakeAndInitialize åˆæœŸåŒ–ãƒ¡ã‚½ãƒƒãƒ‰(å¼•æ•°)
9ã¤ã¾ã§ã„ã‘ã‚‹ã€‚</p>
<div class="code"><pre class="code literal-block"><span class="w">    </span><span class="n">STDMETHODIMP</span><span class="w"> </span><span class="nf">RuntimeClassInitialize</span><span class="p">(</span><span class="n">DWORD</span><span class="w"> </span><span class="n">value</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">S_OK</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="n">DWORD</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">255</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">Microsoft</span><span class="o">::</span><span class="n">WRL</span><span class="o">::</span><span class="n">ComPtr</span><span class="o">&lt;</span><span class="n">CCallback</span><span class="o">&gt;</span><span class="w"> </span><span class="n">pCallback</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">hr</span><span class="o">=</span><span class="n">Microsoft</span><span class="o">::</span><span class="n">WRL</span><span class="o">::</span><span class="n">MakeAndInitialize</span><span class="o">&lt;</span><span class="n">CCallback</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pCallback</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">FAILED</span><span class="p">(</span><span class="n">hr</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
</pre></div>

<hr>
<ul class="pager hidden-print">
<li class="previous">
        <a href="../gentoo_xorg/" rel="prev" title="Gentooã§X11ã‚’è¨­å®šã™ã‚‹">
            Gentooã§X11ã‚’è¨­å®šã™ã‚‹ ğŸ‘ˆ
        </a>
    </li>
    <li style="flex-grow: 1">
    <li class="next">
        <a href="../cppwinrt_uwp/" rel="next" title="C++WinRTã§ã¯ã˜ã‚ã‚‹UWP">
            ğŸ‘‰ C++WinRTã§ã¯ã˜ã‚ã‚‹UWP
        </a>
    </li>
</ul></main><footer id="footer"><p>
            Powered by
            <a href="https://getnikola.com" rel="nofollow">Nikola</a>
        </p>
    </footer>
</body>
</html>
