<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="generator" content="Nikola (getnikola.com)">
<meta name="viewport" content="width=device-width">
<script src="../../../../assets/js/all-nocdn.js"></script><title>RenderingスレッドでC#関数を呼び出すと次回play時に固まる | 三次元日誌</title>
<link href="../../../../assets/css/code.css" rel="stylesheet" type="text/css">
<link href="../../../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
</head>
<body>
    <h1 id="brand">
        <a href="../../../../" title="三次元日誌" rel="home">
            <span id="blog-title">三次元日誌</span>
        </a>
    </h1>
    <hr>
<main id="content"><h1 class="p-name entry-title" itemprop="headline name">
    <a href="." class="u-url">RenderingスレッドでC#関数を呼び出すと次回play時に固まる</a>
</h1>
<div>
<p>何のことか分かりにくいが以下のコードで再現できる。
public int m_count;</p>
<p>void OnRender(int eventID)
{
    m_count++;
}</p>
<p>void Update()
{
    var p = Marshal.GetFunctionPointerForDelegate(OnRender);
    GL.IssuePluginEvent(p, 0);
}</p>
<p>SharpDXをUnity上で使うべくGL.IssuePluginEventにC#のDelegateを渡す実験をしていた。これをやると、Editor終了時もしくは次回play時にUnityEditorがFreezeする(100%)。Unity5.5.3とUnity2017.1.0beta1で再現した。
調べてみたところ、</p>
<p>https://forum.unity3d.com/threads/problem-with-callbacks.87513/</p>
<p>が該当しそうかと思ったがちょっと違う。新しいスレッドを起こしている訳では無いので。 ただ、条件は下記の通り</p>
<p>C#のdelegateを関数ポインタとしてCに渡す
その関数ポインタが異なるスレッドから呼び出される</p>
<p>次に</p>
<p>https://blog.tedd.no/2016/10/09/investigating-unity-hang-on-second-run-multi-threading/</p>
<p>を当たった。ここで紹介しているvisualstudioのdebug - window - 並列スタックで状況を確認する手法を使ってみたところ以下のようになっていた。</p>
<p>mono_domain_unloadが固まっているような気がするぞ。</p>
<p>http://stackoverflow.com/questions/10138015/unloading-mono-domains-in-multithreaded-context</p>
<p>monoがdelegateから関数ポインタを作るのに使っているらしいinvoke wrappersの周りの回収に失敗しているのではないかというような気がする。</p>
<p>http://d.hatena.ne.jp/saiya_moebius/20090319/1237434037</p>
<p>Unity上で打つ手は見つからなかった・・・</p>
</div>
    </main><footer id="footer"><p>
            Powered by
            <a href="https://getnikola.com" rel="nofollow">Nikola</a>
        </p>
    </footer>
</body>
</html>
