<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="generator" content="Nikola (getnikola.com)">
<meta name="viewport" content="width=device-width">
<script src="../../../assets/js/all-nocdn.js"></script><title>C++WinRTではじめるUWP | 三次元日誌</title>
<link href="../../../assets/css/code.css" rel="stylesheet" type="text/css">
<link href="../../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
</head>
<body>
    <h1 id="brand">
        <a href="../../../" title="三次元日誌" rel="home">
            <span id="blog-title">三次元日誌</span>
        </a>
    </h1>

    <nav id="menu"><ul>
<li><a href="../../../archive.html">Archives</a></li>
<li><a href="../../../categories/index.html">Tags</a></li>
<li><a href="../../../rss.xml">RSS feed</a></li>
<li><a href="../../../about">About</a></li>
<li><a href="../../../books">MemoBooks</a></li>

            
            
            
        </ul></nav><hr>
<main id="content"><h1 class="p-name entry-title" itemprop="headline name">
    <h1 class="p-name entry-title" itemprop="headline name">
    <a href="." class="u-url">C++WinRTではじめるUWP
    </a>
</h1>
<ul itemprop="keywords" class="tags">
<li>
        <time datetime="2017-09-14T00:00:00+09:00" title="2017-09-14">2017-09-14</time>
</li>
    <li><a class="tag p-category" href="../../../categories/cpp/" rel="tag">cpp</a></li>
    <li><a class="tag p-category" href="../../../categories/uwp/" rel="tag">uwp</a></li>
</ul>
</h1>

<p>C++/CXを置き換えるよさげなライブラリC++WinRTを発見した。</p>
<p>C++/CXの機能を純粋なC++(C++17とか新しめの)で実装したものらしく、WinRTのC++バインディングのような位置。
C++/CXで</p>
<div class="code"><pre class="code literal-block"><span class="n">Windows</span><span class="o">::</span><span class="n">UI</span><span class="o">::</span><span class="n">Core</span><span class="o">::</span><span class="n">CoreWindow</span><span class="w"> </span><span class="o">^</span><span class="n">window</span><span class="p">;</span><span class="w"></span>
</pre></div>

<p>のようなものを</p>
<div class="code"><pre class="code literal-block"><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;winrt/Windows.UI.Core.h&gt;</span><span class="cp"></span>
<span class="n">winrt</span><span class="o">::</span><span class="n">Windows</span><span class="o">::</span><span class="n">UI</span><span class="o">::</span><span class="n">Core</span><span class="o">::</span><span class="n">Core</span><span class="w"> </span><span class="n">window</span><span class="p">;</span><span class="w"></span>
</pre></div>

<p>のように置き換える。<code>-&gt;</code>じゃなくて <code>.</code> を使うスマートポインタで実装されている。</p>
<ul>
<li>Migrating C++/CX source code to C++/WinRT</li>
</ul>
<p>C++/CXでasync, awaitな非同期を実装する道具だったPPLもうまく置き換えているようだ。</p>
<ul>
<li>Using C++ co-routines with C++/WinRT asynchronous methods</li>
</ul>
<p>やってみる
clone
https://github.com/Microsoft/cppwinrtをcloneしてincludeできるようにしておく。
C++WinRTはヘッダオンリーライブラリである。
ビルド確認</p>
<p>https://github.com/Microsoft/cppwinrt/tree/master/10.0.15063.0/Samples/CL</p>
<p>をベース。</p>
<div class="code"><pre class="code literal-block"><span class="c1">// main.cpp</span>
<span class="cp">#pragma comment(lib, "windowsapp") </span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;winrt/base.h&gt;</span><span class="cp"></span>

<span class="kt">int</span><span class="w"> </span><span class="kr">__stdcall</span><span class="w"> </span><span class="n">wWinMain</span><span class="p">(</span><span class="n">HINSTANCE</span><span class="p">,</span><span class="w"> </span><span class="n">HINSTANCE</span><span class="p">,</span><span class="w"> </span><span class="n">PWSTR</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">winrt</span><span class="o">::</span><span class="n">init_apartment</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>

<p>あえてCMakeで。
CMakeLists.txt</p>
<div class="code"><pre class="code literal-block"><span class="nb">CMAKE_MINIMUM_REQUIRED</span><span class="p">(</span><span class="s">VERSION</span><span class="w"> </span><span class="s">3.5</span><span class="p">)</span>
<span class="nb">PROJECT</span><span class="p">(</span><span class="s">RendererToolkit</span><span class="p">)</span><span class="w"> </span><span class="c"># .sln</span>

<span class="nb">ADD_DEFINITIONS</span><span class="p">(</span>
<span class="w">    </span><span class="s">-DWIN32=1</span>
<span class="w">    </span><span class="s">-DUNICODE=1</span>
<span class="w">    </span><span class="s">-D_UNICODE=1</span>
<span class="w">    </span><span class="p">)</span>

<span class="nb">SET</span><span class="p">(</span><span class="s">CMAKE_C_FLAGS</span><span class="w"> </span><span class="s2">"/ZW /EHsc /await /std:c++latest"</span><span class="p">)</span>
<span class="nb">SET</span><span class="p">(</span><span class="s">CMAKE_CXX_FLAGS</span><span class="w"> </span><span class="o">${</span><span class="nv">CMAKE_C_FLAGS</span><span class="o">}</span><span class="p">)</span>
<span class="nb">INCLUDE_DIRECTORIES</span><span class="p">(</span>
<span class="w">    </span><span class="c"># 適当にcloneしたパスを参照</span>
<span class="w">    </span><span class="o">${</span><span class="nv">CMAKE_CURRENT_LIST_DIR</span><span class="o">}</span><span class="s">/cppwinrt/10.0.15063.0</span>
<span class="w">    </span><span class="p">)</span>

<span class="c">##############################################################################</span>
<span class="c"># project</span>
<span class="c">##############################################################################</span>
<span class="nb">SET</span><span class="p">(</span><span class="s">PROJECTNAME</span><span class="w"> </span><span class="s">_SampleCoreWindow</span><span class="p">)</span>

<span class="nb">FILE</span><span class="p">(</span><span class="s">GLOB</span><span class="w"> </span><span class="s">SRCS</span><span class="w"> </span><span class="s">*.cpp</span><span class="w"> </span><span class="s">*.h</span><span class="p">)</span>

<span class="nb">ADD_EXECUTABLE</span><span class="p">(</span><span class="o">${</span><span class="nv">PROJECTNAME</span><span class="o">}</span><span class="w"> </span><span class="s">WIN32</span><span class="w"> </span><span class="o">${</span><span class="nv">SRCS</span><span class="o">}</span><span class="p">)</span>

<span class="nb">TARGET_INCLUDE_DIRECTORIES</span><span class="p">(</span><span class="o">${</span><span class="nv">PROJECTNAME</span><span class="o">}</span><span class="w"> </span><span class="s">PUBLIC</span>
<span class="w">    </span><span class="o">${</span><span class="nv">SUBRENDERER_INCLUDE</span><span class="o">}</span>
<span class="w">    </span><span class="p">)</span>
</pre></div>

<p>UWPをターゲットにしたプロジェクトを生成する。</p>
<div class="code"><pre class="code literal-block">&gt; mkdir build
&gt; cd build
build&gt; cmake.exe -DCMAKE_SYSTEM_NAME=WindowsStore -DCMAKE_SYSTEM_VERSION=10.0 -DCMAKE_C_FLAGS=/ZW /EHsc -G "Visual Studio 15 2017 Win64" ..
</pre></div>

<p>ビルドすると警告が出る。
warning C4447: スレッド モデルのない 'main' シグネチャが見つかりました。'int main(Platform::Array&lt;:string&gt;^ args)' の使用を検討してください。</p>
<p>以下のように属性をつければ外せた。
[Platform::MTAThread]
int __stdcall wWinMain(HINSTANCE, HINSTANCE, PWSTR, int)</p>
<p>Debug - X64 - ローカルコンピューター でアプリが起動して、即終了することが確認できればよし。
UWPの作法で空のAppを作ってみる</p>
<div class="code"><pre class="code literal-block"><span class="cp">#pragma comment(lib, "windowsapp") </span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;winrt/Windows.ApplicationModel.Core.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;winrt/Windows.UI.Core.h&gt;</span><span class="cp"></span>

<span class="c1">//</span>
<span class="c1">// IFrameworkViewSourceとIFrameworkViewを一体化させるのは必要(ばらすとエラーになった)</span>
<span class="c1">//</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">App</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">winrt</span><span class="o">::</span><span class="n">implements</span><span class="o">&lt;</span><span class="n">App</span><span class="w"></span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="n">winrt</span><span class="o">::</span><span class="n">Windows</span><span class="o">::</span><span class="n">ApplicationModel</span><span class="o">::</span><span class="n">Core</span><span class="o">::</span><span class="n">IFrameworkViewSource</span><span class="w"></span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="n">winrt</span><span class="o">::</span><span class="n">Windows</span><span class="o">::</span><span class="n">ApplicationModel</span><span class="o">::</span><span class="n">Core</span><span class="o">::</span><span class="n">IFrameworkView</span><span class="o">&gt;</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">winrt</span><span class="o">::</span><span class="n">Windows</span><span class="o">::</span><span class="n">ApplicationModel</span><span class="o">::</span><span class="n">Core</span><span class="o">::</span><span class="n">IFrameworkView</span><span class="w"> </span><span class="nf">CreateView</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">*</span><span class="k">this</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">Initialize</span><span class="p">(</span><span class="n">winrt</span><span class="o">::</span><span class="n">Windows</span><span class="o">::</span><span class="n">ApplicationModel</span><span class="o">::</span><span class="n">Core</span><span class="o">::</span><span class="n">CoreApplicationView</span><span class="w"> </span><span class="k">const</span><span class="o">&amp;</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">Load</span><span class="p">(</span><span class="n">winrt</span><span class="o">::</span><span class="n">hstring</span><span class="w"> </span><span class="k">const</span><span class="o">&amp;</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">Uninitialize</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">Run</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">window</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">winrt</span><span class="o">::</span><span class="n">Windows</span><span class="o">::</span><span class="n">UI</span><span class="o">::</span><span class="n">Core</span><span class="o">::</span><span class="n">CoreWindow</span><span class="o">::</span><span class="n">GetForCurrentThread</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="n">window</span><span class="p">.</span><span class="n">Activate</span><span class="p">();</span><span class="w"></span>

<span class="w">        </span><span class="c1">//</span>

<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">dispatcher</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">window</span><span class="p">.</span><span class="n">Dispatcher</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="n">dispatcher</span><span class="p">.</span><span class="n">ProcessEvents</span><span class="p">(</span><span class="n">winrt</span><span class="o">::</span><span class="n">Windows</span><span class="o">::</span><span class="n">UI</span><span class="o">::</span><span class="n">Core</span><span class="o">::</span><span class="n">CoreProcessEventsOption</span><span class="o">::</span><span class="n">ProcessUntilQuit</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">SetWindow</span><span class="p">(</span><span class="n">winrt</span><span class="o">::</span><span class="n">Windows</span><span class="o">::</span><span class="n">UI</span><span class="o">::</span><span class="n">Core</span><span class="o">::</span><span class="n">CoreWindow</span><span class="w"> </span><span class="k">const</span><span class="o">&amp;</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>

<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>


<span class="kt">int</span><span class="w"> </span><span class="kr">__stdcall</span><span class="w"> </span><span class="n">wWinMain</span><span class="p">(</span><span class="n">HINSTANCE</span><span class="p">,</span><span class="w"> </span><span class="n">HINSTANCE</span><span class="p">,</span><span class="w"> </span><span class="n">PWSTR</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">winrt</span><span class="o">::</span><span class="n">init_apartment</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="n">winrt</span><span class="o">::</span><span class="n">Windows</span><span class="o">::</span><span class="n">ApplicationModel</span><span class="o">::</span><span class="n">Core</span><span class="o">::</span><span class="n">CoreApplication</span><span class="o">::</span><span class="n">Run</span><span class="p">(</span><span class="n">App</span><span class="p">());</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>

<p>警告とは無関係に、実行に
[Platform::MTAThread]かwinrt::init_apartment();のどちらかが必要？
IUnknown*を得る
winrt::get_abi
メモ</p>
<p>https://github.com/Kitware/CMake/blob/master/Tests/VSWinStorePhone/CMakeLists.txt</p>
<p>VisualStudio2017のC++/CX Universal D3D11のテンプレートをC++/WinRTバージョンに改造できた。間違ってもコンパイルが通って実行時エラーになるのに難儀したが、C++/CXよりはだいぶ使い勝手がよさげな感じ。</p>

<hr>
<ul class="pager hidden-print">
<li class="previous">
        <a href="../com_wrl/" rel="prev" title="WRLを使った最近のComプログラミング">
            WRLを使った最近のComプログラミング 👈
        </a>
    </li>
    <li style="flex-grow: 1">
    <li class="next">
        <a href="../sphinx_in_hugo/" rel="next" title="hugoで作ったサイトにSphinxを埋めこむ">
            👉 hugoで作ったサイトにSphinxを埋めこむ
        </a>
    </li>
</ul></main><footer id="footer"><p>
            Powered by
            <a href="https://getnikola.com" rel="nofollow">Nikola</a>
        </p>
    </footer>
</body>
</html>
