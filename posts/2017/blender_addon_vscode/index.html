<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="generator" content="Nikola (getnikola.com)">
<meta name="viewport" content="width=device-width">
<script src="../../../assets/js/all-nocdn.js"></script><title>BlenderのAddOnを、VSCodeでデバッグする | 三次元日誌</title>
<link href="../../../assets/css/code.css" rel="stylesheet" type="text/css">
<link href="../../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
</head>
<body>
    <h1 id="brand">
        <a href="../../../" title="三次元日誌" rel="home">
            <span id="blog-title">三次元日誌</span>
        </a>
    </h1>

    <nav id="menu"><ul>
<li><a href="../../../archive.html">Archives</a></li>
<li><a href="../../../categories/index.html">Tags</a></li>
<li><a href="../../../rss.xml">RSS feed</a></li>
<li><a href="../../../about">About</a></li>
<li><a href="../../../books">MemoBooks</a></li>

            
            
            
        </ul></nav><hr>
<main id="content"><h1 class="p-name entry-title" itemprop="headline name">
    <h1 class="p-name entry-title" itemprop="headline name">
    <a href="." class="u-url">BlenderのAddOnを、VSCodeでデバッグする
    </a>
</h1>
<ul itemprop="keywords" class="tags">
<li>
        <time datetime="2017-11-23T00:00:00+09:00" title="2017-11-23">2017-11-23</time>
</li>
    <li><a class="tag p-category" href="../../../categories/blender/" rel="tag">blender</a></li>
    <li><a class="tag p-category" href="../../../categories/vscode/" rel="tag">vscode</a></li>
</ul>
</h1>

<p>VSCodeのリモートデバッグを利用してBlenderのPythonにデバッガをアタッチする。</p>
<p><a href="https://pypi.python.org/pypi/ptvsd">PTVSD</a></p>
<p>VisualStudioのPTVS向けのリモートデバッグモジュール。VSCodeも対応しているらしい。
リモート側でptvsdをimportして待ち受けて、VisualStudio側からtcp経由でアタッチする。</p>
<div class="code"><pre class="code literal-block"><span class="kn">import</span> <span class="nn">ptvsd</span>
<span class="n">ptvsd</span><span class="o">.</span><span class="n">enable_attach</span><span class="p">(</span><span class="n">secret</span> <span class="o">=</span> <span class="s1">'secret'</span><span class="p">,</span> <span class="p">(</span><span class="s1">'0.0.0.0'</span><span class="p">,</span> <span class="mi">3000</span><span class="p">))</span>

<span class="k">if</span> <span class="n">os</span> <span class="o">!=</span> <span class="s1">'Windows'</span><span class="p">:</span>
    <span class="n">ptvsd</span><span class="o">.</span><span class="n">wait_for_attach</span><span class="p">()</span> <span class="c1"># スクリプトが終わらないようにブロックする</span>
</pre></div>

<div class="code"><pre class="code literal-block">+--------------+
|remoteのpython|
|         ptvsd|tcp:3000 &lt;-- VisualStudio attach
+--------------+
</pre></div>

<p>dos窓</p>
<div class="code"><pre class="code literal-block">&gt; netstat -an | find "3000"
  TCP         0.0.0.0:3000           0.0.0.0:0              LISTENING
</pre></div>

<p>確かに待っている。
TCP経由なのでptvsd側が、LinuxやRasPi、Blenderの組み込みPythonなどなんであってもアタッチできる。
素のPythonでやってみる</p>
<p>Windows10(64bit)
Python-3.6
PTVSD-3.0.0</p>
<p>PTVSDのバージョンが3.0.0でないと
デバッグアダプタープロセスが予期せず終了しました。</p>
<p>等のエラーが出てうまくいかぬ。</p>
<p>https://github.com/DonJayamanne/pythonVSCode/issues/1039</p>
<p>ptvsdのインストール</p>
<div class="code"><pre class="code literal-block">&gt; py -3.6 -m pip install ptvsd==3.0.0
</pre></div>

<p>testプロジェクト</p>
<div class="code"><pre class="code literal-block">&gt; mkdir ptvsd_test
</pre></div>

<p>VSCodeでptvsd_testフォルダを開く。
testスクリプト
ptvsd_test/main.py</p>
<div class="code"><pre class="code literal-block"><span class="kn">import</span> <span class="nn">time</span>

<span class="c1"># PTVSDを準備する</span>
<span class="kn">import</span> <span class="nn">ptvsd</span>
<span class="n">listen</span> <span class="o">=</span> <span class="p">(</span><span class="s1">'0.0.0.0'</span><span class="p">,</span> <span class="mi">3000</span><span class="p">)</span>
<span class="n">ptvsd</span><span class="o">.</span><span class="n">enable_attach</span><span class="p">(</span><span class="s1">'my_secret'</span><span class="p">,</span> <span class="n">listen</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">'wait_for_attach...'</span><span class="p">,</span> <span class="n">listen</span><span class="p">)</span>
<span class="n">ptvsd</span><span class="o">.</span><span class="n">wait_for_attach</span><span class="p">()</span> <span class="c1"># リモートデバッガの接続を待つ</span>

<span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># 接続後少し待つ</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">'connected'</span><span class="p">)</span>

<span class="c1"># デバッグするコード</span>
<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>

<div class="code"><pre class="code literal-block">&gt;py -3.6 main.py
wait_for_attach... ('0.0.0.0', 3000)
</pre></div>

<p>VSCodeから接続
ptvsd_test/main.pyを開いてデバッグ開始。構成の追加でpythonを選択する。</p>
<p>ptvsd_test/.vscode/launch.json</p>
<div class="code"><pre class="code literal-block"><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// IntelliSense を使用して利用可能な属性を学べます。</span><span class="w"></span>
<span class="w">    </span><span class="c1">// 既存の属性の説明をホバーして表示します。</span><span class="w"></span>
<span class="w">    </span><span class="c1">// 詳細情報は次を確認してください: https://go.microsoft.com/fwlink/?linkid=830387</span><span class="w"></span>
<span class="w">    </span><span class="nt">"version"</span><span class="p">:</span><span class="w"> </span><span class="s2">"0.2.0"</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nt">"configurations"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">        </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="nt">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Python"</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="nt">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"python"</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="nt">"request"</span><span class="p">:</span><span class="w"> </span><span class="s2">"launch"</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="nt">"stopOnEntry"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="nt">"pythonPath"</span><span class="p">:</span><span class="w"> </span><span class="s2">"${config:python.pythonPath}"</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="nt">"program"</span><span class="p">:</span><span class="w"> </span><span class="s2">"${file}"</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="nt">"cwd"</span><span class="p">:</span><span class="w"> </span><span class="s2">"${workspaceRoot}"</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="nt">"env"</span><span class="p">:</span><span class="w"> </span><span class="p">{},</span><span class="w"></span>
<span class="w">            </span><span class="nt">"envFile"</span><span class="p">:</span><span class="w"> </span><span class="s2">"${workspaceRoot}/.env"</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="nt">"debugOptions"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">                </span><span class="s2">"WaitOnAbnormalExit"</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="s2">"WaitOnNormalExit"</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="s2">"RedirectOutput"</span><span class="w"></span>
<span class="w">            </span><span class="p">]</span><span class="w"></span>
<span class="w">        </span><span class="p">},</span><span class="w"></span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="c1">// これ</span><span class="w"></span>
<span class="w">            </span><span class="nt">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Python: Attach"</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="nt">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"python"</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="nt">"request"</span><span class="p">:</span><span class="w"> </span><span class="s2">"attach"</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="nt">"localRoot"</span><span class="p">:</span><span class="w"> </span><span class="s2">"${workspaceRoot}"</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="nt">"remoteRoot"</span><span class="p">:</span><span class="w"> </span><span class="s2">"${workspaceRoot}"</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="nt">"port"</span><span class="p">:</span><span class="w"> </span><span class="mi">3000</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="nt">"secret"</span><span class="p">:</span><span class="w"> </span><span class="s2">"my_secret"</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="nt">"host"</span><span class="p">:</span><span class="w"> </span><span class="s2">"localhost"</span><span class="w"></span>
<span class="w">        </span><span class="p">},</span><span class="w"></span>

<span class="w">        </span><span class="c1">// 以降省略</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>

<p>デバッグの選択メニューでPython:Attachを選択。改めて開始。
うまく接続できればデバッグコンソールにprintした内容が表示される。
breakポイントもステップ実行も可能。素晴らしい。
BlenderのAddOnでやってみる</p>
<p>https://github.com/Barbarbarbarian/Blender-VScode-Debugger</p>
<p>これ。
BlenderのPythonにptvsdをインストールする
Blenderを起動して以下のスクリプトを実行する。</p>
<div class="code"><pre class="code literal-block"><span class="kn">import</span> <span class="nn">sys</span>
<span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</pre></div>

<p>適当なパスを選んでそこにptvsd-3.0.0をコピーする。
ptvsd-3.0.0.zipをダウンロード。
解凍してptvsdフォルダをBlenderのsys.pathに含まれていたC:/Program Files/Blender Foundation/Blenderにコピーした。
Blender-VScode-Debuggerをインストールする</p>
<p>File - UserPreferences - Add-ons と潜ってinstall Add-on from FileボタンからBlender_VScode_Debugger.pyを選択する。
Add-onsからDevelopment: Debugger for Visual Codeを選択してチェックボックスをOnにする
三角を押してPreferencesを展開、Path of PTVSD module:にptvsdをインストールしたパスを設定する(うちではC:/Program Files/Blender Foundation/Blender)
Save - User Settings</p>
<p>実行してみる
3DViewでspaceを押してConnect to Visual Studio Code Debuggerを選択。
dos窓</p>
<div class="code"><pre class="code literal-block">&gt; netstat -an | find "3000"
  TCP         0.0.0.0:3000           0.0.0.0:0              LISTENING
</pre></div>

<p>待っている。
試しにAddOnを作ってみる
例えばWindows版のBlenderのAddOnパスは
C:/Users/<strong>USER_NAME</strong>/AppData/Roaming/Blender Foundation/Blender/2.79/scripts/addons
です。
Hello AddOnを作る。
hello.pyとhello/<strong>init</strong>.pyという選択肢があるが、後者で作る。
gitやVSCodeを使うのだからフォルダが独立している方がよろしい。
helloフォルダを作って、VSCodeでフォルダを開いた。
hello/<strong>init</strong>.pyを作成。</p>
<p>https://docs.blender.org/manual/en/dev/advanced/scripting/addon_tutorial.html</p>
<p>を参考に。</p>
<div class="code"><pre class="code literal-block"><span class="n">bl_info</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">"name"</span><span class="p">:</span> <span class="s2">"Move X Axis"</span><span class="p">,</span>
    <span class="s2">"category"</span><span class="p">:</span> <span class="s2">"Object"</span><span class="p">,</span>
<span class="p">}</span>

<span class="kn">import</span> <span class="nn">bpy</span>


<span class="k">class</span> <span class="nc">ObjectMoveX</span><span class="p">(</span><span class="n">bpy</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">Operator</span><span class="p">):</span>
    <span class="sd">"""My Object Moving Script"""</span>      <span class="c1"># Use this as a tool-tip for menu items and buttons.</span>
    <span class="n">bl_idname</span> <span class="o">=</span> <span class="s2">"object.move_x"</span>        <span class="c1"># Unique identifier for buttons and menu items to reference.</span>
    <span class="n">bl_label</span> <span class="o">=</span> <span class="s2">"Move X by One"</span>         <span class="c1"># Display name in the interface.</span>
    <span class="n">bl_options</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'REGISTER'</span><span class="p">,</span> <span class="s1">'UNDO'</span><span class="p">}</span>  <span class="c1"># Enable undo for the operator.</span>

    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>        <span class="c1"># execute() is called when running the operator.</span>

        <span class="c1"># The original script</span>
        <span class="n">scene</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">scene</span>
        <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">scene</span><span class="o">.</span><span class="n">objects</span><span class="p">:</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">location</span><span class="o">.</span><span class="n">x</span> <span class="o">+=</span> <span class="mf">1.0</span>

        <span class="k">return</span> <span class="p">{</span><span class="s1">'FINISHED'</span><span class="p">}</span>            <span class="c1"># Lets Blender know the operator finished successfully.</span>

<span class="k">def</span> <span class="nf">register</span><span class="p">():</span>
    <span class="n">bpy</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">register_class</span><span class="p">(</span><span class="n">ObjectMoveX</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">unregister</span><span class="p">():</span>
    <span class="n">bpy</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">unregister_class</span><span class="p">(</span><span class="n">ObjectMoveX</span><span class="p">)</span>


<span class="c1"># This allows you to run the script directly from Blenders Text editor</span>
<span class="c1"># to test the add-on without having to install it.</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
    <span class="n">register</span><span class="p">()</span>
</pre></div>

<p>Blenderを再起動して、AddOnのチェックボックスを有効にする。
3DViewでスペースを押してMove X by oneを実行してみる。
動けば準備完了。
AddOnをステップ実行してみる</p>
<p>3DViewでConnect to Visual Studio Code Debugger
VSCodeで構成を追加してRemoteDebuggerでアタッチ</p>
<p>hello/.vscode/launch.json</p>
<div class="code"><pre class="code literal-block"><span class="w">        </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="nt">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Python: Attach"</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="nt">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"python"</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="nt">"request"</span><span class="p">:</span><span class="w"> </span><span class="s2">"attach"</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="nt">"localRoot"</span><span class="p">:</span><span class="w"> </span><span class="s2">"${workspaceRoot}"</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="nt">"remoteRoot"</span><span class="p">:</span><span class="w"> </span><span class="s2">"${workspaceRoot}"</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="nt">"port"</span><span class="p">:</span><span class="w"> </span><span class="mi">3000</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="nt">"secret"</span><span class="p">:</span><span class="w"> </span><span class="s2">"my_secret"</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="nt">"host"</span><span class="p">:</span><span class="w"> </span><span class="s2">"localhost"</span><span class="w"></span>
<span class="w">        </span><span class="p">},</span><span class="w"></span>
</pre></div>

<p>VSCodeでexecute関数のscene=context.sceneにbreak pointをセットする
3DViewでMove X by one</p>
<p>うまくいった。</p>
<h3>Memo</h3>
<p>Blenderプロセスが生きていればいいのでptvsd.wait_for_attach()する必要はない
Pythonのターンになるまで接続が処理されないので、VSCodeからアタッチした後AddOnを実行するまでVSCodeは待ち状態になる</p>

<hr>
<ul class="pager hidden-print">
<li class="previous">
        <a href="../../../github/pyvbo/" rel="prev" title="pyVBO">
            pyVBO 👈
        </a>
    </li>
    <li style="flex-grow: 1">
    <li class="next">
        <a href="../../../github/async_websocket/" rel="next" title="async_websocket">
            👉 async_websocket
        </a>
    </li>
</ul></main><footer id="footer"><p>
            Powered by
            <a href="https://getnikola.com" rel="nofollow">Nikola</a>
        </p>
    </footer>
</body>
</html>
