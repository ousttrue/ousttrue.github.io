"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[9371],{2942:function(n,s,a){a.r(s),a.d(s,{default:function(){return r}});var t=a(1151),e=a(7294);function p(n){const s=Object.assign({p:"p",span:"span",h1:"h1"},(0,t.ah)(),n.components);return e.createElement(e.Fragment,null,e.createElement(s.p,null,"Python じゃなくて VisualStudio 側の問題のようなのだけど、setup.py でネイティブモジュールをビルドするときに顕在化したので。"),"\n",e.createElement(s.p,null,"こういう感じのネイティブモジュールを作った。"),"\n",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python"><span class="token keyword">from</span> distutils<span class="token punctuation">.</span>core <span class="token keyword">import</span> setup<span class="token punctuation">,</span> Extension\n\n\nimgui_module <span class="token operator">=</span> Extension<span class="token punctuation">(</span><span class="token string">\'_swig_imgui\'</span><span class="token punctuation">,</span>\n        sources<span class="token operator">=</span><span class="token punctuation">[</span>\n            <span class="token comment">#\'imgui_wrap.cxx\',</span>\n            <span class="token string">\'imgui.i\'</span><span class="token punctuation">,</span>\n            <span class="token string">\'imgui/imgui.cpp\'</span><span class="token punctuation">,</span>\n            <span class="token string">\'imgui/imgui_draw.cpp\'</span><span class="token punctuation">,</span>\n            <span class="token string">\'imgui/imgui_demo.cpp\'</span><span class="token punctuation">,</span>\n            <span class="token punctuation">]</span><span class="token punctuation">,</span>\n        swig_opts<span class="token operator">=</span><span class="token punctuation">[</span>\n            <span class="token comment">#\'-modern\',</span>\n            <span class="token string">\'-c++\'</span><span class="token punctuation">,</span>\n            <span class="token string">\'-py3\'</span><span class="token punctuation">,</span>\n            <span class="token punctuation">]</span>\n        <span class="token punctuation">)</span>\n\nsetup <span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">\'swig_imgui\'</span><span class="token punctuation">,</span>\n        version <span class="token operator">=</span> <span class="token string">\'0.1\'</span><span class="token punctuation">,</span>\n        author      <span class="token operator">=</span> <span class="token string">"ousttrue"</span><span class="token punctuation">,</span>\n        description <span class="token operator">=</span> <span class="token triple-quoted-string string">"""imgui wrapper using swig"""</span><span class="token punctuation">,</span>\n        ext_modules <span class="token operator">=</span> <span class="token punctuation">[</span>imgui_module<span class="token punctuation">]</span><span class="token punctuation">,</span>\n        py_modules <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"swig_imgui"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n        <span class="token punctuation">)</span></code></pre></div>'}}),"\n",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">> python setup.py build</code></pre></div>'}}),"\n",e.createElement(s.p,null,"とするとエラーになる。\nWindows10(64bit)上の vs2017 + vcbuildtools の組み合わせの環境である。"),"\n",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">cl.exe /c /nologo /Ox /W3 /GL /DNDEBUG /MD -ID:\\Anaconda3\\include -ID:\\Anaconda3\\include /EHsc /Tpimgui_wrap.cpp /Fobuild\\temp.win-amd64-3.6\\Release\\imgui_wrap.obj\nerror: command \'cl.exe\' failed: No such file or directory</code></pre></div>'}}),"\n",e.createElement(s.p,null,"distutils が cl.exe を探すのに失敗しているようなのである。\nlib/distutils 下を調べてみた。\nどうやら lib/distutils/_msvccompiler.py で vcvarsall.bat から環境変数を得ることに失敗しているらしい。\n実際、C:\\Program Files (x86)\\Microsoft Visual Studio\\Shared\\14.0\\VC\\vcvarsall.bat の呼び出しが失敗していることを突き止めた。"),"\n",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">Error in script usage. The correct usage is:\n"C:\\Program Files (x86)\\Microsoft Visual Studio\\Shared\\14.0\\VC\\vcvarsall.bat" [option]\nor\n"C:\\Program Files (x86)\\Microsoft Visual Studio\\Shared\\14.0\\VC\\vcvarsall.bat" [option] store\nor\n"C:\\Program Files (x86)\\Microsoft Visual Studio\\Shared\\14.0\\VC\\vcvarsall.bat" [option] [version number]\nor\n"C:\\Program Files (x86)\\Microsoft Visual Studio\\Shared\\14.0\\VC\\vcvarsall.bat" [option] store [version number]\nwhere [option] is: x86 | amd64 | arm | x86_amd64 | x86_arm | amd64_x86 | amd64_arm\nwhere [version number] is either the full Windows 10 SDK version number or "8.1" to use the windows 8.1 SDK\n:\nThe store parameter sets environment variables to support\nstore (rather than desktop) development.\n:\nFor example:\n"C:\\Program Files (x86)\\Microsoft Visual Studio\\Shared\\14.0\\VC\\vcvarsall.bat" x86_amd64\n"C:\\Program Files (x86)\\Microsoft Visual Studio\\Shared\\14.0\\VC\\vcvarsall.bat" x86_arm store\n"C:\\Program Files (x86)\\Microsoft Visual Studio\\Shared\\14.0\\VC\\vcvarsall.bat" x86_amd64 10.0.10240.0\n"C:\\Program Files (x86)\\Microsoft Visual Studio\\Shared\\14.0\\VC\\vcvarsall.bat" x86_arm store 10.0.10240.0\n"C:\\Program Files (x86)\\Microsoft Visual Studio\\Shared\\14.0\\VC\\vcvarsall.bat" x64 8.1\n"C:\\Program Files (x86)\\Microsoft Visual Studio\\Shared\\14.0\\VC\\vcvarsall.bat" x64 store 8.1</code></pre></div>'}}),"\n",e.createElement(s.p,null,"コマンドラインから実行しても失敗していて、vcvarsall.bat に以下のコードがあるのだが、"),"\n",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">:setup_buildsku\nif not exist "%~dp0..\\..\\..\\Microsoft Visual C++ Build Tools\\vcbuildtools.bat" goto usage\nset CurrentDir=%CD%\ncall "%~dp0..\\..\\..\\Microsoft Visual C++ Build Tools\\vcbuildtools.bat" %1 %2\ncd /d %CurrentDir%\ngoto :eof</code></pre></div>'}}),"\n",e.createElement(s.p,null,'C:\\Program Files (x86)\\Microsoft Visual Studio\\Shared\\14.0\\VC\\vcvarsall.bat\nから\nC:\\Program Files (x86)\\Microsoft Visual C++ Build Tools\\vcbuildtools.bat"\nへの相対パスだと一致しないよなーと。\nこれが原因で cl.exe のパスが取れない。\nsetup.py にモンキーパッチを当てて cl.exe を発見できるようにしてみた。\n以下を setup.py の先頭に追加。'),"\n",e.createElement(s.h1,null,"monkey patch for _msvccompiler"),"\n",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python"><span class="token keyword">import</span> distutils<span class="token punctuation">.</span>\\_msvccompiler\n<span class="token keyword">import</span> os\n<span class="token keyword">import</span> subprocess\n<span class="token keyword">def</span> \\_get_vc_env<span class="token punctuation">(</span>plat_spec<span class="token punctuation">)</span><span class="token punctuation">:</span>\n<span class="token keyword">if</span> os<span class="token punctuation">.</span>getenv<span class="token punctuation">(</span><span class="token string">"DISTUTILS_USE_SDK"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n<span class="token keyword">return</span> <span class="token punctuation">{</span>\nkey<span class="token punctuation">.</span>lower<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> value\n<span class="token keyword">for</span> key<span class="token punctuation">,</span> value <span class="token keyword">in</span> os<span class="token punctuation">.</span>environ<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token punctuation">}</span>\n\n    vcvarsall<span class="token punctuation">,</span> vcruntime <span class="token operator">=</span> distutils<span class="token punctuation">.</span>_msvccompiler<span class="token punctuation">.</span>_find_vcvarsall<span class="token punctuation">(</span>plat_spec<span class="token punctuation">)</span>\n    <span class="token keyword">if</span> <span class="token keyword">not</span> vcvarsall<span class="token punctuation">:</span>\n        <span class="token keyword">raise</span> DistutilsPlatformError<span class="token punctuation">(</span><span class="token string">"Unable to find vcvarsall.bat"</span><span class="token punctuation">)</span>\n\n    <span class="token keyword">try</span><span class="token punctuation">:</span>\n        out <span class="token operator">=</span> subprocess<span class="token punctuation">.</span>check_output<span class="token punctuation">(</span>\n            <span class="token string">\'cmd /u /c "{}" {} &amp;&amp; set\'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>vcvarsall<span class="token punctuation">,</span> plat_spec<span class="token punctuation">)</span><span class="token punctuation">,</span>\n            stderr<span class="token operator">=</span>subprocess<span class="token punctuation">.</span>STDOUT<span class="token punctuation">,</span>\n        <span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">\'utf-16le\'</span><span class="token punctuation">,</span> errors<span class="token operator">=</span><span class="token string">\'replace\'</span><span class="token punctuation">)</span>\n        <span class="token comment">#######################################################################</span>\n        <span class="token keyword">if</span> out<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">"Error in script usage"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n            out <span class="token operator">=</span> subprocess<span class="token punctuation">.</span>check_output<span class="token punctuation">(</span>\n                <span class="token string">\'cmd /u /c "{}" {} &amp;&amp; set\'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token string">"C:\\\\Program Files (x86)\\\\Microsoft Visual C++ Build Tools\\\\vcbuildtools.bat"</span><span class="token punctuation">,</span> plat_spec<span class="token punctuation">)</span><span class="token punctuation">,</span>\n                stderr<span class="token operator">=</span>subprocess<span class="token punctuation">.</span>STDOUT<span class="token punctuation">,</span>\n            <span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">\'utf-16le\'</span><span class="token punctuation">,</span> errors<span class="token operator">=</span><span class="token string">\'replace\'</span><span class="token punctuation">)</span>\n        <span class="token comment">#######################################################################</span>\n    <span class="token keyword">except</span> subprocess<span class="token punctuation">.</span>CalledProcessError <span class="token keyword">as</span> exc<span class="token punctuation">:</span>\n        log<span class="token punctuation">.</span>error<span class="token punctuation">(</span>exc<span class="token punctuation">.</span>output<span class="token punctuation">)</span>\n        <span class="token keyword">raise</span> DistutilsPlatformError<span class="token punctuation">(</span><span class="token string">"Error executing {}"</span>\n                <span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>exc<span class="token punctuation">.</span>cmd<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n    env <span class="token operator">=</span> <span class="token punctuation">{</span>\n        key<span class="token punctuation">.</span>lower<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> value\n        <span class="token keyword">for</span> key<span class="token punctuation">,</span> _<span class="token punctuation">,</span> value <span class="token keyword">in</span>\n        <span class="token punctuation">(</span>line<span class="token punctuation">.</span>partition<span class="token punctuation">(</span><span class="token string">\'=\'</span><span class="token punctuation">)</span> <span class="token keyword">for</span> line <span class="token keyword">in</span> out<span class="token punctuation">.</span>splitlines<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n        <span class="token keyword">if</span> key <span class="token keyword">and</span> value\n    <span class="token punctuation">}</span>\n\n    <span class="token keyword">if</span> vcruntime<span class="token punctuation">:</span>\n        env<span class="token punctuation">[</span><span class="token string">\'py_vcruntime_redist\'</span><span class="token punctuation">]</span> <span class="token operator">=</span> vcruntime\n    <span class="token keyword">return</span> env</code></pre></div>'}}),"\n",e.createElement(s.p,null,e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">distutils.\\_msvccompiler.\\_get_vc_env=\\_get_vc_env</code>'}})),"\n",e.createElement(s.p,null,"以前にもこんなことやったことあるような気がする・・・。"))}var o=function(n){void 0===n&&(n={});const{wrapper:s}=Object.assign({},(0,t.ah)(),n.components);return s?e.createElement(s,n,e.createElement(p,n)):p(n)},c=a(8678),l=a(8838);const u={code:n=>{let{children:s,className:a}=n;return a?e.createElement(l.Z,{className:a},s):e.createElement("code",null,s)}};function i(n){let{data:s,children:a}=n;return e.createElement(c.Z,null,e.createElement("h1",null,s.mdx.frontmatter.title),e.createElement(t.Zo,{components:u},a))}function r(n){return e.createElement(i,n,e.createElement(o,n))}}}]);
//# sourceMappingURL=component---src-templates-post-template-js-content-file-path-home-runner-work-ousttrue-github-io-ousttrue-github-io-content-posts-2017-08-distutils-msvccompiler-md-214ec273a89801343959.js.map