"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[2776],{1081:function(n,a,e){e.r(a),e.d(a,{default:function(){return r}});var s=e(1151),t=e(7294);function c(n){const a=Object.assign({p:"p",ul:"ul",li:"li",span:"span"},(0,s.ah)(),n.components);return t.createElement(t.Fragment,null,t.createElement(a.p,null,"mmdbridgeのvcpkgを使ったビルド手順を作ったついでにAlembicのvcpkg向けパッケージを作ってみる。"),"\n",t.createElement(a.p,null,"情報収集"),"\n",t.createElement(a.ul,null,"\n",t.createElement(a.li,null,"https://github.com/Microsoft/vcpkg/blob/master/docs/examples/packaging-zlib.md"),"\n"),"\n",t.createElement(a.p,null,"読んだ。"),"\n",t.createElement(a.p,null,t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">vcpkg create url</code>'}})," で雛形が作れる。"),"\n",t.createElement(a.p,null,"実験"),"\n",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="shell"><pre class="language-shell"><code class="language-shell">.<span class="token punctuation">\\</span>vcpkg.exe create alembic https://github.com/alembic/alembic/archive/1.7.1.tar.gz\nCMake Error at scripts/ports.cmake:101 <span class="token punctuation">(</span>message<span class="token punctuation">)</span>:\n  Portfile already exists: <span class="token string">\'D:\\vcpkg\\ports\\alembic\\portfile.cmake\'</span></code></pre></div>'}}),"\n",t.createElement(a.p,null,"すでにあるだと！？\n最近できたらしい。"),"\n",t.createElement(a.ul,null,"\n",t.createElement(a.li,null,"https://github.com/Microsoft/vcpkg/tree/master/ports/alembic"),"\n"),"\n",t.createElement(a.p,null,"しかし、hdf非対応みたいなので作ってみる。"),"\n",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="shell"><pre class="language-shell"><code class="language-shell">.<span class="token punctuation">\\</span>vcpkg.exe create alembic-hdf https://github.com/alembic/alembic/archive/1.7.1.tar.gz\n\nVCPKG_DIR\n    ports\n        alembic-hdf\n            CONTROL\n            portfile.cmake</code></pre></div>'}}),"\n",t.createElement(a.p,null,"ができた。\n簡単なCONTROLから。\nこっちはパッケージ情報を決めるだけなのでさくっと。"),"\n",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="shell"><pre class="language-shell"><code class="language-shell">Source: alembic-hdf\nVersion: <span class="token number">1.7</span>.1\nDescription: alembic with hdf5\nBuild-Depends: hdf5</code></pre></div>'}}),"\n",t.createElement(a.p,null,"本題のportfile.cmake。\nそのままだとエラーになるの。最低限以下が必要なようだ。\nアーカイブを展開パスの指定。"),"\n",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="cmake"><pre class="language-cmake"><code class="language-cmake"><span class="token keyword">set</span><span class="token punctuation">(</span>SOURCE_PATH <span class="token punctuation">${</span>CURRENT_BUILDTREES_DIR<span class="token punctuation">}</span>/src/<span class="token number">1.7.1</span><span class="token punctuation">)</span>\n\n<span class="token comment"># ↓ 修正する</span>\n\n<span class="token keyword">set</span><span class="token punctuation">(</span>SOURCE_PATH <span class="token punctuation">${</span>CURRENT_BUILDTREES_DIR<span class="token punctuation">}</span>/src/alembic-<span class="token number">1.7.1</span><span class="token punctuation">)</span></code></pre></div>'}}),"\n",t.createElement(a.p,null,"実行してみる。"),"\n",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="shell"><pre class="language-shell"><code class="language-shell"><span class="token operator">></span> ./vcpkg <span class="token function">install</span> alembic-hdf:x64-windows\nThe following packages will be built and installed:\n    alembic-hdf:x64-windows\nBuilding package alembic-hdf:x64-windows<span class="token punctuation">..</span>.\n-- <span class="token assign-left variable">CURRENT_INSTALLED_DIR</span><span class="token operator">=</span>D:/vcpkg/installed/x64-windows\n-- <span class="token assign-left variable">DOWNLOADS</span><span class="token operator">=</span>D:/vcpkg/downloads\n-- <span class="token assign-left variable">CURRENT_PACKAGES_DIR</span><span class="token operator">=</span>D:/vcpkg/packages/alembic-hdf_x64-windows\n-- <span class="token assign-left variable">CURRENT_BUILDTREES_DIR</span><span class="token operator">=</span>D:/vcpkg/buildtrees/alembic-hdf\n-- <span class="token assign-left variable">CURRENT_PORT_DIR</span><span class="token operator">=</span>D:/vcpkg/ports/alembic-hdf/.\n-- Using cached D:/vcpkg/downloads/1.7.1.tar.gz\n-- Testing integrity of cached file<span class="token punctuation">..</span>.\n-- Testing integrity of cached file<span class="token punctuation">..</span>. OK\n-- Extracting <span class="token keyword">done</span>\n-- Configuring x64-windows-rel\n-- Configuring x64-windows-rel <span class="token keyword">done</span>\n-- Configuring x64-windows-dbg\nPS D:<span class="token punctuation">\\</span>vcpkg<span class="token operator">></span> .<span class="token punctuation">\\</span>vcpkg.exe <span class="token function">install</span> alembic-hdf:x64-windows\nThe following packages will be built and installed:\n    alembic-hdf:x64-windows\nBuilding package alembic-hdf:x64-windows<span class="token punctuation">..</span>.\n-- <span class="token assign-left variable">CURRENT_INSTALLED_DIR</span><span class="token operator">=</span>D:/vcpkg/installed/x64-windows\n-- <span class="token assign-left variable">DOWNLOADS</span><span class="token operator">=</span>D:/vcpkg/downloads\n-- <span class="token assign-left variable">CURRENT_PACKAGES_DIR</span><span class="token operator">=</span>D:/vcpkg/packages/alembic-hdf_x64-windows\n-- <span class="token assign-left variable">CURRENT_BUILDTREES_DIR</span><span class="token operator">=</span>D:/vcpkg/buildtrees/alembic-hdf\n-- <span class="token assign-left variable">CURRENT_PORT_DIR</span><span class="token operator">=</span>D:/vcpkg/ports/alembic-hdf/.\n-- Using cached D:/vcpkg/downloads/1.7.1.tar.gz\n-- Testing integrity of cached file<span class="token punctuation">..</span>.\n-- Testing integrity of cached file<span class="token punctuation">..</span>. OK\n-- Extracting <span class="token keyword">done</span>\n-- Configuring x64-windows-rel\n-- Configuring x64-windows-rel <span class="token keyword">done</span>\n-- Configuring x64-windows-dbg\n-- Configuring x64-windows-dbg <span class="token keyword">done</span>\n-- Package x64-windows-rel\n-- Package x64-windows-rel <span class="token keyword">done</span>\n-- Package x64-windows-dbg\n-- Package x64-windows-dbg <span class="token keyword">done</span>\n-- Performing post-build validation\nInclude files should not be duplicated into the /debug/include directory. If this cannot be disabled <span class="token keyword">in</span> the project cmake, use\n    file<span class="token punctuation">(</span>REMOVE_RECURSE <span class="token variable">${CURRENT_PACKAGES_DIR}</span>/debug/include<span class="token punctuation">)</span>\nThe /lib/cmake folder should be merged with /debug/lib/cmake and moved to /share/alembic-hdf/cmake.\nThe following cmake files were found outside /share/alembic-hdf. Please place cmake files <span class="token keyword">in</span> /share/alembic-hdf.\n\n    D:/vcpkg/packages/alembic-hdf_x64-windows/lib/cmake/Alembic/AlembicConfig.cmake\n    D:/vcpkg/packages/alembic-hdf_x64-windows/lib/cmake/Alembic/AlembicConfigVersion.cmake\n    D:/vcpkg/packages/alembic-hdf_x64-windows/lib/cmake/Alembic/AlembicTargets-release.cmake\n    D:/vcpkg/packages/alembic-hdf_x64-windows/lib/cmake/Alembic/AlembicTargets.cmake\n    D:/vcpkg/packages/alembic-hdf_x64-windows/debug/lib/cmake/Alembic/AlembicConfig.cmake\n    D:/vcpkg/packages/alembic-hdf_x64-windows/debug/lib/cmake/Alembic/AlembicConfigVersion.cmake\n    D:/vcpkg/packages/alembic-hdf_x64-windows/debug/lib/cmake/Alembic/AlembicTargets-debug.cmake\n    D:/vcpkg/packages/alembic-hdf_x64-windows/debug/lib/cmake/Alembic/AlembicTargets.cmake\n\nThe /debug/lib/cmake folder should be merged with /lib/cmake into /share/alembic-hdf\n\nThe following dlls were found <span class="token keyword">in</span> /lib or /debug/lib. Please move them to /bin or /debug/bin, respectively.\n\n    D:/vcpkg/packages/alembic-hdf_x64-windows/lib/Alembic.dll\n\n\nThe following dlls were found <span class="token keyword">in</span> /lib or /debug/lib. Please move them to /bin or /debug/bin, respectively.\n\n    D:/vcpkg/packages/alembic-hdf_x64-windows/debug/lib/Alembic.dll\n\nThe software license must be available at <span class="token variable">${CURRENT_PACKAGES_DIR}</span>/share/alembic-hdf/copyright\n\n    file<span class="token punctuation">(</span>COPY <span class="token variable">${CURRENT_BUILDTREES_DIR}</span>/src/alembic-1.7.1/LICENSE.txt DESTINATION <span class="token variable">${CURRENT_PACKAGES_DIR}</span>/share/alembic-hdf<span class="token punctuation">)</span>\n    file<span class="token punctuation">(</span>RENAME <span class="token variable">${CURRENT_PACKAGES_DIR}</span>/share/alembic-hdf/LICENSE.txt <span class="token variable">${CURRENT_PACKAGES_DIR}</span>/share/alembic-hdf/copyright<span class="token punctuation">)</span>\nThe following EXEs were found <span class="token keyword">in</span> /bin or /debug/bin. EXEs are not valid distribution targets.\n\n    D:/vcpkg/packages/alembic-hdf_x64-windows/bin/abcdiff.exe\n    D:/vcpkg/packages/alembic-hdf_x64-windows/bin/abcecho.exe\n    D:/vcpkg/packages/alembic-hdf_x64-windows/bin/abcechobounds.exe\n    D:/vcpkg/packages/alembic-hdf_x64-windows/bin/abcls.exe\n    D:/vcpkg/packages/alembic-hdf_x64-windows/bin/abcstitcher.exe\n    D:/vcpkg/packages/alembic-hdf_x64-windows/bin/abctree.exe\n\nThe following EXEs were found <span class="token keyword">in</span> /bin or /debug/bin. EXEs are not valid distribution targets.\n\n    D:/vcpkg/packages/alembic-hdf_x64-windows/debug/bin/abcdiff.exe\n    D:/vcpkg/packages/alembic-hdf_x64-windows/debug/bin/abcecho.exe\n    D:/vcpkg/packages/alembic-hdf_x64-windows/debug/bin/abcechobounds.exe\n    D:/vcpkg/packages/alembic-hdf_x64-windows/debug/bin/abcls.exe\n    D:/vcpkg/packages/alembic-hdf_x64-windows/debug/bin/abcstitcher.exe\n    D:/vcpkg/packages/alembic-hdf_x64-windows/debug/bin/abctree.exe\n\nFound <span class="token number">9</span> error<span class="token punctuation">(</span>s<span class="token punctuation">)</span>. Please correct the portfile:\n    D:<span class="token punctuation">\\</span>vcpkg<span class="token punctuation">\\</span>ports<span class="token punctuation">\\</span>alembic-hdf<span class="token punctuation">\\</span>portfile.cmake\n-- Performing post-build validation <span class="token keyword">done</span>\nError: Building package alembic-hdf:x64-windows failed with: POST_BUILD_CHECKS_FAILED\nPlease ensure you\'re using the latest portfiles with <span class="token variable"><span class="token variable">`</span>.<span class="token punctuation">\\</span>vcpkg update<span class="token variable">`</span></span>, <span class="token keyword">then</span>\nsubmit an issue at https://github.com/Microsoft/vcpkg/issues including:\n  Package: alembic-hdf:x64-windows\n  Vcpkg version: <span class="token number">0.0</span>.81-144d3718c4197b101c7d61ee6a258200371fb1ab\n\nAdditionally, attach any relevant sections from the log files above.</code></pre></div>'}}),"\n",t.createElement(a.p,null,"という感じになった。\nエラーメッセージがすごく親切。\nあと、NINJAビルド速い。\nエラーにはなるがビルド結果は以下のように出力された。"),"\n",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="shell"><pre class="language-shell"><code class="language-shell">VCPKG_DIR/packages/alembic-hdf_x64-windows\n│  BUILD_INFO\n│\n├─bin\n│      abcdiff.exe\n│      abcecho.exe\n│      abcechobounds.exe\n│      abcls.exe\n│      abcstitcher.exe\n│      abctree.exe\n│\n├─debug\n│  ├─bin\n│  │      abcdiff.exe\n│  │      abcecho.exe\n│  │      abcechobounds.exe\n│  │      abcls.exe\n│  │      abcstitcher.exe\n│  │      abctree.exe\n│  │\n│  ├─include\n│  │  └─Alembic\n│  │      ├─Abc\n│  │      │      *.h\n│  │      │\n│  │      ├─AbcCollection\n│  │      │      *.h\n│  │      │\n│  │      ├─AbcCoreAbstract\n│  │      │      *.h\n│  │      │\n│  │      ├─AbcCoreFactory\n│  │      │      *.h\n│  │      │\n│  │      ├─AbcCoreLayer\n│  │      │      *.h\n│  │      │\n│  │      ├─AbcCoreOgawa\n│  │      │      *.h\n│  │      │\n│  │      ├─AbcGeom\n│  │      │      *.h\n│  │      │\n│  │      ├─AbcMaterial\n│  │      │      *.h\n│  │      │\n│  │      └─Util\n│  │              *.h\n│  │\n│  └─lib\n│      │  Alembic.dll\n│      │  Alembic.lib\n│      │\n│      └─cmake\n│          └─Alembic\n│                  AlembicConfig.cmake\n│                  AlembicConfigVersion.cmake\n│                  AlembicTargets-debug.cmake\n│                  AlembicTargets.cmake\n│\n├─include\n│  └─Alembic\n│      ├─Abc\n│      │      *.h\n│      │\n│      ├─AbcCollection\n│      │      *.h\n│      │\n│      ├─AbcCoreAbstract\n│      │      *.h\n│      │\n│      ├─AbcCoreFactory\n│      │      *.h\n│      │\n│      ├─AbcCoreLayer\n│      │      *.h\n│      │\n│      ├─AbcCoreOgawa\n│      │      *.h\n│      │\n│      ├─AbcGeom\n│      │      *.h\n│      │\n│      ├─AbcMaterial\n│      │      *.h\n│      │\n│      └─Util\n│              *.h\n│\n└─lib\n    │  Alembic.dll\n    │  Alembic.lib\n    │\n    └─cmake\n        └─Alembic\n                AlembicConfig.cmake\n                AlembicConfigVersion.cmake\n                AlembicTargets-release.cmake\n                AlembicTargets.cmake</code></pre></div>'}}),"\n",t.createElement(a.p,null,"ここから不要なものを削除したり、場所の違うものを移動したりすることで完成できそう。\nエラーメッセージに沿って修正してみる"),"\n",t.createElement(a.p,null,t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">debug/include</code>'}})," 不要"),"\n",t.createElement(a.p,null,"エラーメッセージに含まれるとおりに。"),"\n",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="cmake"><pre class="language-cmake"><code class="language-cmake"><span class="token keyword">file</span><span class="token punctuation">(</span>REMOVE_RECURSE <span class="token punctuation">${</span>CURRENT_PACKAGES_DIR<span class="token punctuation">}</span>/debug/include<span class="token punctuation">)</span>\n\nlib/cmake/Alembic/*.cmakeをshare/alembic-hdfに移動するべし\ndebug/lib/cmake/Alembicを統合するべし。\n<span class="token function">vcpkg_fixup_cmake_targets</span><span class="token punctuation">(</span>CONFIG_PATH <span class="token string">"lib/cmake/Alembic"</span><span class="token punctuation">)</span></code></pre></div>'}}),"\n",t.createElement(a.p,null,"ぽい。 ",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">alembic/portfile.cmake</code>'}})," を参考にした"),"\n",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="cmake"><pre class="language-cmake"><code class="language-cmake">lib/Alembic.dllをbin/Alembic.dllに移動せよ\ndebug/lib/Alembic.dllも。\n<span class="token keyword">file</span><span class="token punctuation">(</span>RENAME <span class="token punctuation">${</span>CURRENT_PACKAGES_DIR<span class="token punctuation">}</span>/lib/Alembic.dll <span class="token punctuation">${</span>CURRENT_PACKAGES_DIR<span class="token punctuation">}</span>/bin/Alembic.dll<span class="token punctuation">)</span>\n<span class="token keyword">file</span><span class="token punctuation">(</span>RENAME <span class="token punctuation">${</span>CURRENT_PACKAGES_DIR<span class="token punctuation">}</span>/debug/lib/Alembic.dll <span class="token punctuation">${</span>CURRENT_PACKAGES_DIR<span class="token punctuation">}</span>/debug/bin/Alembic.dll<span class="token punctuation">)</span></code></pre></div>'}}),"\n",t.createElement(a.p,null,t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">alembic/portfile.cmake</code>'}})," を参考にした"),"\n",t.createElement(a.p,null,"ライセンスファイルをコピーせよ\nエラーメッセージに含まれるとおりに。"),"\n",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="cmake"><pre class="language-cmake"><code class="language-cmake"><span class="token keyword">file</span><span class="token punctuation">(</span>COPY <span class="token punctuation">${</span>CURRENT_BUILDTREES_DIR<span class="token punctuation">}</span>/src/alembic-<span class="token number">1.7.1</span>/LICENSE.txt DESTINATION <span class="token punctuation">${</span>CURRENT_PACKAGES_DIR<span class="token punctuation">}</span>/share/alembic-hdf<span class="token punctuation">)</span>\n<span class="token keyword">file</span><span class="token punctuation">(</span>RENAME <span class="token punctuation">${</span>CURRENT_PACKAGES_DIR<span class="token punctuation">}</span>/share/alembic-hdf/LICENSE.txt <span class="token punctuation">${</span>CURRENT_PACKAGES_DIR<span class="token punctuation">}</span>/share/alembic-hdf/copyright<span class="token punctuation">)</span></code></pre></div>'}}),"\n",t.createElement(a.p,null,"exeを削除せよ"),"\n",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="cmake"><pre class="language-cmake"><code class="language-cmake"><span class="token keyword">file</span><span class="token punctuation">(</span>GLOB EXE <span class="token punctuation">${</span>CURRENT_PACKAGES_DIR<span class="token punctuation">}</span>/bin/*.exe<span class="token punctuation">)</span>\n<span class="token keyword">file</span><span class="token punctuation">(</span>GLOB DEBUG_EXE <span class="token punctuation">${</span>CURRENT_PACKAGES_DIR<span class="token punctuation">}</span>/debug/bin/*.exe<span class="token punctuation">)</span>\n<span class="token keyword">file</span><span class="token punctuation">(</span>REMOVE <span class="token punctuation">${</span>EXE<span class="token punctuation">}</span><span class="token punctuation">)</span>\n<span class="token keyword">file</span><span class="token punctuation">(</span>REMOVE <span class="token punctuation">${</span>DEBUG_EXE<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></div>'}}),"\n",t.createElement(a.p,null,"alembic/portfile.cmakeを参考にした\nおまけ: debug用にpdbをコピー\nalembic/portfile.cmakeを参考にした\nvcpkg_copy_pdbs()"),"\n",t.createElement(a.p,null,"vcpkg_install_cmakeより下を抜粋。"),"\n",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="cmake"><pre class="language-cmake"><code class="language-cmake"><span class="token function">vcpkg_install_cmake</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n<span class="token comment"># Remove debug/include</span>\n<span class="token keyword">file</span><span class="token punctuation">(</span>REMOVE_RECURSE <span class="token punctuation">${</span>CURRENT_PACKAGES_DIR<span class="token punctuation">}</span>/debug/include<span class="token punctuation">)</span>\n<span class="token comment"># fix *.cmake</span>\n<span class="token function">vcpkg_fixup_cmake_targets</span><span class="token punctuation">(</span>CONFIG_PATH <span class="token string">"lib/cmake/Alembic"</span><span class="token punctuation">)</span>\n<span class="token comment"># Rename dll</span>\n<span class="token keyword">file</span><span class="token punctuation">(</span>RENAME <span class="token punctuation">${</span>CURRENT_PACKAGES_DIR<span class="token punctuation">}</span>/lib/Alembic.dll <span class="token punctuation">${</span>CURRENT_PACKAGES_DIR<span class="token punctuation">}</span>/bin/Alembic.dll<span class="token punctuation">)</span>\n<span class="token keyword">file</span><span class="token punctuation">(</span>RENAME <span class="token punctuation">${</span>CURRENT_PACKAGES_DIR<span class="token punctuation">}</span>/debug/lib/Alembic.dll <span class="token punctuation">${</span>CURRENT_PACKAGES_DIR<span class="token punctuation">}</span>/debug/bin/Alembic.dll<span class="token punctuation">)</span>\n<span class="token comment"># Handle copyright</span>\n<span class="token keyword">file</span><span class="token punctuation">(</span>COPY <span class="token punctuation">${</span>CURRENT_BUILDTREES_DIR<span class="token punctuation">}</span>/src/alembic-<span class="token number">1.7.1</span>/LICENSE.txt DESTINATION <span class="token punctuation">${</span>CURRENT_PACKAGES_DIR<span class="token punctuation">}</span>/share/alembic-hdf<span class="token punctuation">)</span>\n<span class="token keyword">file</span><span class="token punctuation">(</span>RENAME <span class="token punctuation">${</span>CURRENT_PACKAGES_DIR<span class="token punctuation">}</span>/share/alembic-hdf/LICENSE.txt <span class="token punctuation">${</span>CURRENT_PACKAGES_DIR<span class="token punctuation">}</span>/share/alembic-hdf/copyright<span class="token punctuation">)</span>\n<span class="token comment"># Remove exe files</span>\n<span class="token keyword">file</span><span class="token punctuation">(</span>GLOB EXE <span class="token punctuation">${</span>CURRENT_PACKAGES_DIR<span class="token punctuation">}</span>/bin/*.exe<span class="token punctuation">)</span>\n<span class="token keyword">file</span><span class="token punctuation">(</span>GLOB DEBUG_EXE <span class="token punctuation">${</span>CURRENT_PACKAGES_DIR<span class="token punctuation">}</span>/debug/bin/*.exe<span class="token punctuation">)</span>\n<span class="token keyword">file</span><span class="token punctuation">(</span>REMOVE <span class="token punctuation">${</span>EXE<span class="token punctuation">}</span><span class="token punctuation">)</span>\n<span class="token keyword">file</span><span class="token punctuation">(</span>REMOVE <span class="token punctuation">${</span>DEBUG_EXE<span class="token punctuation">}</span><span class="token punctuation">)</span>\n<span class="token comment"># Copy pdb</span>\n<span class="token function">vcpkg_copy_pdbs</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre></div>'}}),"\n",t.createElement(a.p,null,"再度ビルド。"),"\n",t.createElement(a.p,null,t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">> vcpkg install alembic-hdf:x64-windows</code>'}})),"\n",t.createElement(a.p,null,"うまくいった。\nUSE_HDF5を有効にする\nportfileの修正\nCONTROLに依存追加。\nBuild-Depends: ilmbase, hdf5"),"\n",t.createElement(a.p,null,"USE_HDF5を有効に。"),"\n",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="cmake"><pre class="language-cmake"><code class="language-cmake"><span class="token function">vcpkg_configure_cmake</span><span class="token punctuation">(</span>\n    SOURCE_PATH <span class="token punctuation">${</span>SOURCE_PATH<span class="token punctuation">}</span>\n    PREFER_NINJA <span class="token comment"># Disable this option if project cannot be built with Ninja</span>\n    OPTIONS -DUSE_HDF5=<span class="token boolean">ON</span>\n    <span class="token comment"># OPTIONS_RELEASE -DOPTIMIZE=1</span>\n    <span class="token comment"># OPTIONS_DEBUG -DDEBUGGABLE=1</span>\n<span class="token punctuation">)</span></code></pre></div>'}}),"\n",t.createElement(a.p,null,"ビルドあんどエラー\nビルドしてみるがエラーになる。"),"\n",t.createElement(a.p,null,t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">VCPKG_DIR\\buildtrees\\alembic-hdf\\package-x64-windows-rel-out.log</code>'}})," を見て原因を探る。"),"\n",t.createElement(a.p,null,"hdf5に対するlinkが無くて、hdf5関連のシンボルが見つからん。\nパッチ\nalembic-1.7.1/lib/Alembic/CMakeLists.txtを修正したいのでやり方を調べる。\nパッチの当て方"),"\n",t.createElement(a.p,null,"portfile.cmakeに記述する。"),"\n",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="cmake"><pre class="language-cmake"><code class="language-cmake">vcpkg_extract_source_archiveよりあと、vcpkg_install_cmakeより前。\n<span class="token function">vcpkg_apply_patches</span><span class="token punctuation">(</span>\n    SOURCE_PATH <span class="token punctuation">${</span>SOURCE_PATH<span class="token punctuation">}</span>\n    PATCHES <span class="token punctuation">${</span><span class="token variable">CMAKE_CURRENT_LIST_DIR</span><span class="token punctuation">}</span>/fix-hdf5link.patch\n<span class="token punctuation">)</span></code></pre></div>'}}),"\n",t.createElement(a.p,null,"パッチの作り方"),"\n",t.createElement(a.p,null,"https://github.com/Microsoft/vcpkg/blob/master/docs/examples/patching-libpng.md#patching-the-code-to-improve-compatibility"),"\n",t.createElement(a.p,null,"なるほど。\ngitを準備して・・・"),"\n",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="shell"><pre class="language-shell"><code class="language-shell">vcpkg<span class="token operator">></span> <span class="token builtin class-name">cd</span> ./buildtrees/alembic-hdf/src/alembic-1.7.1/\nvcpkg/buildtrees/alembic-hdf/src/alembic-1.7.<span class="token operator"><span class="token file-descriptor important">1</span>></span> <span class="token function">git</span> init\nvcpkg/buildtrees/alembic-hdf/src/alembic-1.7.<span class="token operator"><span class="token file-descriptor important">1</span>></span> <span class="token function">git</span> <span class="token function">add</span> <span class="token builtin class-name">.</span>\nvcpkg/buildtrees/alembic-hdf/src/alembic-1.7.<span class="token operator"><span class="token file-descriptor important">1</span>></span> <span class="token function">git</span> commit <span class="token parameter variable">-m</span> <span class="token string">"temp"</span></code></pre></div>'}}),"\n",t.createElement(a.p,null,"修正\nalembic-1.7.1/lib/Alembic/CMakeLists.txtを修正。"),"\n",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="diff"><pre class="language-diff"><code class="language-diff"><span class="token inserted-arrow inserted"><span class="token prefix inserted">></span> git diff\n</span><span class="token deleted-sign deleted"><span class="token prefix deleted">-</span>-git a/lib/Alembic/CMakeLists.txt b/lib/Alembic/CMakeLists.txt\n</span>index 5028c91..1f81d50 100644\n<span class="token coord">--- a/lib/Alembic/CMakeLists.txt</span>\n<span class="token coord">+++ b/lib/Alembic/CMakeLists.txt</span>\n@@ -49,6 +49,12 @@ ADD_SUBDIRECTORY(AbcMaterial)\n<span class="token unchanged"><span class="token prefix unchanged"> </span>ADD_SUBDIRECTORY(Ogawa)\n</span>\n<span class="token unchanged"><span class="token prefix unchanged"> </span>ADD_LIBRARY(Alembic ${LIB_TYPE} ${CXX_FILES})\n</span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span>IF (USE_HDF5)\n<span class="token prefix inserted">+</span>    TARGET_LINK_LIBRARIES(Alembic\n<span class="token prefix inserted">+</span>        ${HDF5_LIBRARIES}\n<span class="token prefix inserted">+</span>        )\n<span class="token prefix inserted">+</span>    ADD_DEFINITIONS(-DH5_BUILT_AS_DYNAMIC_LIB)\n<span class="token prefix inserted">+</span>ENDIF()\n</span>\n<span class="token unchanged"><span class="token prefix unchanged"> </span>TARGET_INCLUDE_DIRECTORIES(Alembic\n<span class="token prefix unchanged"> </span>    PUBLIC</span></code></pre></div>'}}),"\n",t.createElement(a.p,null,"gitでpatchを作成"),"\n",t.createElement(a.p,null,t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">> git diff | out-file -enc ascii ..\\..\\..\\..\\ports\\alembic-hdf\\fix-hdf5link.patch</code>'}})),"\n",t.createElement(a.p,null,"ビルド"),"\n",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="shell"><pre class="language-shell"><code class="language-shell"><span class="token operator">></span> .<span class="token punctuation">\\</span>vcpkg.exe <span class="token function">install</span> alembic-hdf:x64-windows\nInstalling package alembic-hdf:x64-windows<span class="token punctuation">..</span>. <span class="token keyword">done</span></code></pre></div>'}}),"\n",t.createElement(a.p,null,"VCPKG_DIR/installed/x64-windows/bin/Alembic.dllをdependencywalkerで見てみるとばっちりhdf5.dllへのリンクが含まれている。作業完了。\nはじめてで調べながらでもわりとさくさく作業が進んだ。エラーメッセージの出し方とか、フォルダの構成とかvcpkgなかなかレベルが高いな。"),"\n",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="shell"><pre class="language-shell"><code class="language-shell">ports\nports/alembic-hdf/CONTROL\nSource: alembic-hdf\nVersion: <span class="token number">1.7</span>.1\nDescription: alembic with hdf5\nBuild-Depends: ilmbase, hdf5</code></pre></div>'}}),"\n",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="ports/alembic-hdf/portfile.cmake"><pre class="language-ports/alembic-hdf/portfile.cmake"><code class="language-ports/alembic-hdf/portfile.cmake"># Common Ambient Variables:\n#   CURRENT_BUILDTREES_DIR    = ${VCPKG_ROOT_DIR}\\buildtrees\\${PORT}\n#   CURRENT_PACKAGES_DIR      = ${VCPKG_ROOT_DIR}\\packages\\${PORT}_${TARGET_TRIPLET}\n#   CURRENT_PORT_DIR          = ${VCPKG_ROOT_DIR}\\ports\\${PORT}\n#   PORT                      = current port name (zlib, etc)\n#   TARGET_TRIPLET            = current triplet (x86-windows, x64-windows-static, etc)\n#   VCPKG_CRT_LINKAGE         = C runtime linkage type (static, dynamic)\n#   VCPKG_LIBRARY_LINKAGE     = target library linkage type (static, dynamic)\n#   VCPKG_ROOT_DIR            = &lt;C:\\path\\to\\current\\vcpkg&gt;\n#   VCPKG_TARGET_ARCHITECTURE = target architecture (x64, x86, arm)\n#\n\ninclude(vcpkg_common_functions)\nset(SOURCE_PATH ${CURRENT_BUILDTREES_DIR}/src/alembic-1.7.1)\nvcpkg_download_distfile(ARCHIVE\n    URLS &quot;https://github.com/alembic/alembic/archive/1.7.1.tar.gz&quot;\n    FILENAME &quot;1.7.1.tar.gz&quot;\n    SHA512 89e30b681a76eaf79b20ebeff62c495971b0eb64b28f249a14bbcf3bdb40df7eda93b0ede299dd5511bd4587a2cc2d4ebd851fb89bf999fdccc31fee3cffbba2\n)\nvcpkg_extract_source_archive(${ARCHIVE})\n\nvcpkg_apply_patches(\n    SOURCE_PATH ${SOURCE_PATH}\n    PATCHES ${CMAKE_CURRENT_LIST_DIR}/fix-hdf5link.patch\n)\n\nvcpkg_configure_cmake(\n    SOURCE_PATH ${SOURCE_PATH}\n    PREFER_NINJA # Disable this option if project cannot be built with Ninja\n    OPTIONS -DUSE_HDF5=ON\n    # OPTIONS_RELEASE -DOPTIMIZE=1\n    # OPTIONS_DEBUG -DDEBUGGABLE=1\n)\n\nvcpkg_install_cmake()\n\n# Remove debug/include\nfile(REMOVE_RECURSE ${CURRENT_PACKAGES_DIR}/debug/include)\n# fix *.cmake\nvcpkg_fixup_cmake_targets(CONFIG_PATH &quot;lib/cmake/Alembic&quot;)\n# Rename dll\nfile(RENAME ${CURRENT_PACKAGES_DIR}/lib/Alembic.dll ${CURRENT_PACKAGES_DIR}/bin/Alembic.dll)\nfile(RENAME ${CURRENT_PACKAGES_DIR}/debug/lib/Alembic.dll ${CURRENT_PACKAGES_DIR}/debug/bin/Alembic.dll)\n# Handle copyright\nfile(COPY ${CURRENT_BUILDTREES_DIR}/src/alembic-1.7.1/LICENSE.txt DESTINATION ${CURRENT_PACKAGES_DIR}/share/alembic-hdf)\nfile(RENAME ${CURRENT_PACKAGES_DIR}/share/alembic-hdf/LICENSE.txt ${CURRENT_PACKAGES_DIR}/share/alembic-hdf/copyright)\n# Remove exe files\nfile(GLOB EXE ${CURRENT_PACKAGES_DIR}/bin/*.exe)\nfile(GLOB DEBUG_EXE ${CURRENT_PACKAGES_DIR}/debug/bin/*.exe)\nfile(REMOVE ${EXE})\nfile(REMOVE ${DEBUG_EXE})\n# Copy pdb\nvcpkg_copy_pdbs()</code></pre></div>'}}),"\n",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="ports/alembic-hdf/fix-hdf5link.patch"><pre class="language-ports/alembic-hdf/fix-hdf5link.patch"><code class="language-ports/alembic-hdf/fix-hdf5link.patch">diff --git a/lib/Alembic/CMakeLists.txt b/lib/Alembic/CMakeLists.txt\nindex 5028c91..1f81d50 100644\n--- a/lib/Alembic/CMakeLists.txt\n+++ b/lib/Alembic/CMakeLists.txt\n@@ -49,6 +49,12 @@ ADD_SUBDIRECTORY(AbcMaterial)\n ADD_SUBDIRECTORY(Ogawa)\n \n ADD_LIBRARY(Alembic ${LIB_TYPE} ${CXX_FILES})\n+IF (USE_HDF5)\n+    TARGET_LINK_LIBRARIES(Alembic \n+        ${HDF5_LIBRARIES}\n+        )\n+    ADD_DEFINITIONS(-DH5_BUILT_AS_DYNAMIC_LIB)\n+ENDIF()\n \n TARGET_INCLUDE_DIRECTORIES(Alembic\n     PUBLIC</code></pre></div>'}}),"\n",t.createElement(a.p,null,"vcpkgにPR送った\n採用されたので上記の作業は必要なくなったのが、cmake-3.9.0の更新でFindHDF5が壊れるという事態が発生したので対応中…。"))}var l=function(n){void 0===n&&(n={});const{wrapper:a}=Object.assign({},(0,s.ah)(),n.components);return a?t.createElement(a,n,t.createElement(c,n)):c(n)},p=e(8678),i=e(8838);const o={code:n=>{let{children:a,className:e}=n;return e?t.createElement(i.Z,{className:e},a):t.createElement("code",null,a)}};function u(n){let{data:a,children:e}=n;return t.createElement(p.Z,null,t.createElement("h1",null,a.mdx.frontmatter.title),t.createElement(s.Zo,{components:o},e))}function r(n){return t.createElement(u,n,t.createElement(l,n))}}}]);
//# sourceMappingURL=component---src-templates-post-template-js-content-file-path-home-runner-work-ousttrue-github-io-ousttrue-github-io-content-posts-2017-07-vcpkg-alembic-md-e15f01a2aa00bdd3d50e.js.map