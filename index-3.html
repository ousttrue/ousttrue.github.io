<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article# " lang="ja">
<head>
<meta charset="utf-8">
<meta name="description" content="作業記録">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>三次元日誌 (過去の記事 3ページ目) | 三次元日誌</title>
<link href="assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<link href="https://fonts.googleapis.com/css?family=Playfair+Display:700,900" rel="stylesheet">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" hreflang="ja" href="rss.xml">
<link rel="canonical" href="https://ousttrue.github.io/index-3.html">
<link rel="prev" href="index-4.html" type="text/html">
<link rel="next" href="index-2.html" type="text/html">
<!--[if lt IE 9]><script src="assets/js/html5.js"></script><![endif]-->
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">本文を読み飛ばす</a>

<!-- Header and menu bar -->
<div class="container">
      <header class="blog-header py-3"><div class="row nbb-header align-items-center">
          <div class="col-md-3 col-xs-2 col-sm-2" style="width: auto;">
            <button class="navbar-toggler navbar-light bg-light nbb-navbar-toggler" type="button" data-toggle="collapse" data-target=".bs-nav-collapsible" aria-controls="bs-navbar" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse bs-nav-collapsible bootblog4-search-form-holder">
                
            </div>
        </div>
          <div class="col-md-6 col-xs-10 col-sm-10 bootblog4-brand" style="width: auto;">
            <a class="navbar-brand blog-header-logo text-dark" href=".">

            <span id="blog-title">三次元日誌</span>
        </a>
          </div>
            <div class="col-md-3 justify-content-end align-items-center bs-nav-collapsible collapse flex-collapse bootblog4-right-nav">
            <nav class="navbar navbar-light bg-white"><ul class="navbar-nav bootblog4-right-nav"></ul></nav>
</div>
    </div>
</header><nav class="navbar navbar-expand-md navbar-light bg-white static-top"><div class="collapse navbar-collapse bs-nav-collapsible" id="bs-navbar">
            <ul class="navbar-nav nav-fill d-flex w-100">
<li class="nav-item">
<a href="archive.html" class="nav-link">Archives</a>
                </li>
<li class="nav-item">
<a href="categories/index.html" class="nav-link">Tags</a>
                </li>
<li class="nav-item">
<a href="rss.xml" class="nav-link">RSS feed</a>

                
            </li>
</ul>
</div>
<!-- /.navbar-collapse -->
</nav>
</div>

<div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        
        
        
    
        

    
        
    <div class="postindex">
            <article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/2013/06/24/oculus-kita/" class="u-url">Oculus来たー</a></h1>
                <div class="metadata">
                    <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                        ousttrue
                    </span></p>
            <p class="dateline">
            <a href="posts/2013/06/24/oculus-kita/" rel="bookmark">
            <time class="published dt-published" datetime="2013-06-24T00:00:00Z" itemprop="datePublished" title="2013-06-24 00:00">2013-06-24 00:00</time></a>
            </p>
                        <p class="commentline">
        
    <a href="posts/2013/06/24/oculus-kita/#disqus_thread" data-disqus-identifier="cache/content/posts/2013/06/24/oculus-kita.html">コメント</a>


                </p>
</div>
            </header><div class="e-content entry-content">
                    <p>Oculus来たー
6月10くらいにぽちってから２週間くらいで到着。いいタイミングに発注したらしい
Oculusことはじめ
oculus sdk downloadあたりで検索すると見つかるのでいただいてくる。
特にログインとかアカウントとかは必要ない。
SDKにはlibSDKとそれを使ったサンプルがvcプロジェクトで入っている。
oculusの組み込みには２段階あって、ひとつは両目向けに違うレンダリングをする作業、
２つめはOculusのジャイロセンサの値を受け取ってカメラの方向を対応させる作業となっている。
ひとつめのステレオレンダリングに関しては、左目用と右目用にオフスクリーンレンダリングして
それを表示するときにシェーダーで歪ませるというものになる。 歪ませ方は、
RenderTiny_D3D1X_Device.cpp や Oculus_SDK_Overview.pdfに書いてある。
OpenCVとかのカメラ係数に似ているような気もするが同じものかは確認していない。
ふたつめの方は、LibOVRに任せると簡単でusbのHIDデバイスから値を随時取得して
カメラ姿勢に適用するだけ。
LibOVRはこのジャイロの値取得とDXUT的な3Dフレームワークが混合しているので
ジャイロの方だけを抽出して最小限にしたい。
あと自分のコードに混ぜて公開していいのかライセンス的によくわからん。
とりあえずglut化してみよう
はじめに軽くTinyRoomをglutに移植しようと思ったらdxutみたいのがくっついていて途中で投げ出したｗ。
手持ちで、OpenGLシェーダーとかオフスクリーンレンダリングを扱うシステムが無いので
そこから作るのが少し時間がかかるので後回しに。
IrrlichtのカメラをOculus化
方向転換して、ベースにlibOVRを合体した。
githubのものはoculusのステレオレンダリングは実装済みなのでgyroを合成する件のみ。
Irrlichtのカメラ行列の制御がよくわからぬが一応表示。
あとでICameraSceneNodeを継承して作り直そう。
mikuさんprprな感じになるにはもう少しかかるな・・・</p>
                </div>
            </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/2013/06/22/irrlicht-vrpn/" class="u-url">IrrlichtにVRPNを合体する</a></h1>
                <div class="metadata">
                    <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                        ousttrue
                    </span></p>
            <p class="dateline">
            <a href="posts/2013/06/22/irrlicht-vrpn/" rel="bookmark">
            <time class="published dt-published" datetime="2013-06-22T00:00:00Z" itemprop="datePublished" title="2013-06-22 00:00">2013-06-22 00:00</time></a>
            </p>
                        <p class="commentline">
        
    <a href="posts/2013/06/22/irrlicht-vrpn/#disqus_thread" data-disqus-identifier="cache/content/posts/2013/06/22/irrlicht-vrpn.html">コメント</a>


                </p>
</div>
            </header><div class="e-content entry-content">
                    <div>
<p>IrrlichtにVRPNを合体する
遂にOculusが発送されたらしくHongKong
Postから国内に入ったらしい。今日明日には来るで。
vrpnを仕込む
Oculusが来たら遊ぶべくIrrlichにさらにvrpnを仕込むことにした。
外部入力はこれで一括して捌こうと構想している。
さしあたってはOculusの傾き情報(Quaternion)、マウス、コントローラの入力をvrpn経由にしようかと。
さらには、
Oculusは位置情報が無いのでKinectからスケルトン情報を受けて移動できるようにしたりWiiコン入力をとったりしたい。
WiiMote
plusの内臓ジャイロの値を取れるソースも発見したのでキネクトで手の位置を取ってWiiコンの傾きと合体すればいい感じになるのではないかと妄想(hydraみたいに手が出てくるとこまでいけるのではないか)。
ゆくゆくはARToolKitやOpenCVのマーカー式やつもvrpn経由で合体しやすくなる。</p>
<pre>
         oculus  kinect wiimote 
          A |        |     |
rendering | | sensor |     |
          | V        |     |
      irrlicht 

<p>ということでvrpn作業開始。</p></pre>
</div>
                </div>
            </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/2013/06/17/irrlicht_msgpackrpc/" class="u-url">IrrlichtにMsgPackRPCを仕込む</a></h1>
                <div class="metadata">
                    <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                        ousttrue
                    </span></p>
            <p class="dateline">
            <a href="posts/2013/06/17/irrlicht_msgpackrpc/" rel="bookmark">
            <time class="published dt-published" datetime="2013-06-17T00:00:00Z" itemprop="datePublished" title="2013-06-17 00:00">2013-06-17 00:00</time></a>
            </p>
                        <p class="commentline">
        
    <a href="posts/2013/06/17/irrlicht_msgpackrpc/#disqus_thread" data-disqus-identifier="cache/content/posts/2013/06/17/irrlicht_msgpackrpc.html">コメント</a>


                </p>
</div>
            </header><div class="e-content entry-content">
                    <div>
<p>IrrlichtにMsgPackRPCを仕込む
Oculusの通販ステータスが早くもProcessingに変わって届くのが楽しみな今日この頃。
レンダリングエンジンにはIrrlichtを選択したのであるが、
そのままだとシーンを構築するとか諸々の作業がC++直叩きになる。
これだとさすがに大変なのでMsgPackRPCでラップして外部のツールから
操作しようと構想しておったのだが始めてみると早速問題に突き当たった。
オブジェクトを生成してそのメソッドをコールするのにどうすればいいのか。
こういう場合だ。
IMesh *mesh=CreateMesh("miku.pmd");
mesh-&gt;SetPosition(0, 0, 5);</p>
<p>MsgPackRPC経由だと以下のような感じか。</p>
<h2>pythonとかそういうの</h2>
<p>client=msgpac.rpc.client()
mesh=client.call("CreateMesh", "miku.pmd")
client.call("Mesh_SetPosition", mesh, 0, 0, 5)</p>
<p>1つめのCreateMeshはグローバル関数かシングルトン的オブジェクトのメソッド呼び出しになるので特に問題は無い。
2つめはSetPositionのthisとしてmeshを送ってやる必要がある。
ここでmsgpack的にはIMesh<em>をシリアライズ/デシリアライズすることが必要になる。
案１ ポインタを整数値としてキャストすればいいじゃない
template <typename stream>
inline packer<stream>&amp; operator&lt;&lt; (packer<stream>&amp; o, IMesh </stream></stream></typename></em>v)
{
    // ポインタをintにキャスト
    o.pack((int)v);
    return o;
}</p>
<p>inline IMesh <em>v operator&gt;&gt; (object o, IMesh</em> v)
{
    unsigned int p;
    o.convert(&amp;p):</p>
<pre class="code literal-block"><span></span>// intをポインタにキャスト
v=(IMesh*)p;

return v;
</pre>

<p>}</p>
<p>さすがにワイルドすぎる。というかポインタが既に開放されている場合になすすべが無いので没
案２ 適当にユニークなIDを振る
template <typename stream>
inline packer<stream>&amp; operator&lt;&lt; (packer<stream>&amp; o, IMesh *v)
{
    // ポインタのuid値
    o.pack(v-&gt;uid());
    return o;
}</stream></stream></typename></p>
<p>inline IMesh <em>v operator&gt;&gt; (object o, IMesh</em> v)
{
    unsigned int uid;
    o.convert(&amp;uid):</p>
<pre class="code literal-block"><span></span><span class="o">//</span> <span class="nt">uid値からポインタを得る</span>
<span class="nt">v</span><span class="o">=</span><span class="nt">IMesh</span><span class="p">::</span><span class="nd">get_from_uid</span><span class="o">(</span><span class="nt">uid</span><span class="o">);</span>

<span class="nt">return</span> <span class="nt">v</span><span class="o">;</span>
</pre>

<p>}</p>
<p>Irrlichtだと本体側に改造が要るけどこれでいってみるか。
template<typename t>
class IDGenerator
{
    unsigned int m_uid;</typename></p>
<p>public:
    IDGenerator():m_uid(generate_uid())
    {
        m_uid_map.insert(std::make_pair(m_uid, this));
    }</p>
<pre class="code literal-block"><span></span>unsigned int uid()const 
{
    return m_uid;
}
</pre>

<p>////////////////////
// static
////////////////////
private:
    static unsigned int m_next_uid=1;
    static std::hash_map<unsigned int t> m_uid_map;
public:
    static unsigned int generate_uid(){ 
        return m_next_uid++; 
    }</unsigned></p>
<pre class="code literal-block"><span></span>statc T* get_from_uid(unsigned int uid){
    auto found=m_uid_map.find(uid);
    if(found==m_uid_map.end()){
        return 0;
    }
    return found-&gt;second;
}
</pre>

<p>};</p>
<p>// 継承階層のIReferenceCountedの下あたりにこんな感じで介入する予定
class IMesh : public virtual IReferenceCounted, public IDGenerator<imesh>
{
};</imesh></p>
<p>うまくいくかやってみるとしよう。
書いてみた
自由に書いてみたらこうなった。templateクラスのスタティックメンバ変数の書き方を学んだ。
http://d.hatena.ne.jp/higepon/20100803/1280834422
template<typename t>
class IDGenerator
{
    struct Deleter{
        unsigned int m_uid;</typename></p>
<pre class="code literal-block"><span></span>    Deleter(unsigned int uid): m_uid(uid){}
    ~Deleter(){ remove_from_map(m_uid); }
};
Deleter m_deleter;
unsigned int m_uid;
</pre>

<p>public:
    IDGenerator():m_uid(generate_uid()), m_deleter(m_uid)
    {
        s_uid_map[m_uid]=this;
    }</p>
<pre class="code literal-block"><span></span>unsigned int uid()const 
{
    return m_uid;
}

////////////////////
// static
////////////////////
</pre>

<p>private:
    static core::map<unsigned int idgenerator> s_uid_map;
public:
    static unsigned int generate_uid(){ 
        static unsigned int next_uid=1;
        return next_uid++; 
    }</unsigned></p>
<pre class="code literal-block"><span></span>static T* get_from_uid(unsigned int uid){
    return s_uid_map.find(uid);
}

static void remove_from_map(unsigned int uid){
    s_uid_map.remove(uid);
}
</pre>

<p>};
template <typename t> core::map<unsigned int idgenerator>*&gt; IDGenerator<t>::s_uid_map;</t></unsigned></typename></p>
<p>しかし、この設計だとstaticメンバがdll境界を越えて２つ存在してうまくいかない罠があった。没
案3 適当にユニークなIDを振る(非テンプレート)
irr::IReferenceCountedを改造する。
小賢しいtemplateをやめてべたにグローバル変数を隠蔽する方式を導入した。
class IReferenceCounted
{
public:</p>
<pre class="code literal-block"><span></span>//! Constructor.
IReferenceCounted()
    : DebugName(0), ReferenceCounter(1), UID(get_uid())
{
    register_uid(UID, this);
}

u32 uid(){ return UID; }

//! Destructor.
virtual ~IReferenceCounted()
{
    unregister_uid(UID);
}
</pre>

<p>// 省略</p>
<p>};</p>
<h2>include "IDGenerator.h"</h2>
<h2>include "IReferenceCounted.h"</h2>
<h2>include "irrMap.h"</h2>
<p>namespace irr {</p>
<pre class="code literal-block"><span></span><span class="nt">extern</span> <span class="s2">"C"</span> <span class="nt">IRRLICHT_API</span> <span class="nt">u32</span> <span class="nt">get_uid</span><span class="o">()</span>
<span class="p">{</span>
    <span class="err">static</span> <span class="err">u32</span> <span class="err">uid=1</span><span class="p">;</span>
    <span class="err">return</span> <span class="err">uid++</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">static</span> <span class="nt">core</span><span class="p">::</span><span class="nd">map</span><span class="o">&lt;</span><span class="nt">u32</span><span class="o">,</span> <span class="nt">IReferenceCounted</span><span class="o">*&gt;</span> <span class="nt">g_map</span><span class="o">;</span>

<span class="nt">extern</span> <span class="s2">"C"</span> <span class="nt">IRRLICHT_API</span> <span class="nt">void</span> <span class="nt">register_uid</span><span class="o">(</span><span class="nt">u32</span> <span class="nt">uid</span><span class="o">,</span> <span class="nt">IReferenceCounted</span> <span class="o">*</span><span class="nt">p</span><span class="o">)</span>
<span class="p">{</span>
    <span class="err">g_map.set(uid,</span> <span class="err">p)</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">extern</span> <span class="s2">"C"</span> <span class="nt">IRRLICHT_API</span> <span class="nt">void</span> <span class="nt">unregister_uid</span><span class="o">(</span><span class="nt">u32</span> <span class="nt">uid</span><span class="o">)</span>
<span class="p">{</span>
    <span class="err">auto</span> <span class="err">found=g_map.remove(uid)</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">extern</span> <span class="s2">"C"</span> <span class="nt">IRRLICHT_API</span> <span class="nt">IReferenceCounted</span><span class="o">*</span> <span class="nt">get_from_uid</span><span class="o">(</span><span class="nt">u32</span> <span class="nt">uid</span><span class="o">)</span>
<span class="p">{</span>
    <span class="err">auto</span> <span class="err">found=g_map.find(uid)</span><span class="p">;</span>
    <span class="err">if(!found){</span>
        <span class="err">return</span> <span class="err">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nt">return</span> <span class="nt">found-</span><span class="o">&gt;</span><span class="nt">getValue</span><span class="o">();</span>
<span class="err">}</span>
</pre>

<p>}</p>
<p>動作確認できた。
ここまでの作業でMsgPackRPCを使ったIrrlichtエクスポートについて見通しを得ることができた。
PythonやLuaから使えるようにするのと同じような作業でリモートから関数をコールできるようになるのでいい感じだ。
呼び出し側にPythonのMsgPackRPCを使えば違う言語からでも呼び出せるので一石二鳥というもの。
ということで引き続き作業を進める。
MsgPackRPCのリモート呼び出しを利用したシーンエディタを作りながら表示できるものを増やしていく。</p>
</div>
                </div>
            </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/2013/06/02/gstreamer/" class="u-url">Gstreamerを始めてみた</a></h1>
                <div class="metadata">
                    <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                        ousttrue
                    </span></p>
            <p class="dateline">
            <a href="posts/2013/06/02/gstreamer/" rel="bookmark">
            <time class="published dt-published" datetime="2013-06-11T00:00:00Z" itemprop="datePublished" title="2013-06-11 00:00">2013-06-11 00:00</time></a>
            </p>
                        <p class="commentline">
        
    <a href="posts/2013/06/02/gstreamer/#disqus_thread" data-disqus-identifier="cache/content/posts/2013/06/02/gstreamer.html">コメント</a>


                </p>
</div>
            </header><div class="e-content entry-content">
                    <div>
<p>動画プログラムでもしてみようということでGstreamerをはじめた。</p>
<h2>Hello world</h2>
<p>まず注意しないといけないのがgstreamerのバージョンに0.10系と1.0系があって、ほとんどの情報が0.10系のものらしいということだ。python2とpython3、ruby18とruby19のような違いがありそうなのでひとまず0.10系を使うことにする。</p>
<p>Basic
tutorials http://docs.gstreamer.com/display/GstSDK/Basic+tutorials をやってみる</p>
<p>最初のコードをc++に改造しやすいようにちょっと変更。</p>
<p>::</p>
<h2>include <gst></gst>
</h2>
<p>int main(int argc, char *argv[]) 
{
    gst_init (&amp;argc, &amp;argv);</p>
<pre class="code literal-block"><span></span>{
    GstElement *pipeline = gst_parse_launch (
            "playbin2 uri=http://docs.gstreamer.com/media/sintel_trailer-480p.webm", 
            NULL);

    gst_element_set_state (pipeline, GST_STATE_PLAYING);
    {
        GstBus *bus = gst_element_get_bus (pipeline);
        {
            GstMessage *msg = gst_bus_timed_pop_filtered (bus, GST_CLOCK_TIME_NONE, 
                    static_cast&lt;GstMessageType&gt;(GST_MESSAGE_ERROR | GST_MESSAGE_EOS));
            if (msg != NULL){
                gst_message_unref (msg);
            }
        }
        gst_object_unref (bus);
    }

    gst_element_set_state (pipeline, GST_STATE_NULL);
    gst_object_unref (pipeline);
}

return 0;
</pre>

<p>}</p>
<p>build $ gcc 'pkg-config gstreamer-0.10 --cflags --libs' main.c
動いた。
gstreamermmでやってみる</p>
<p>https://developer.gnome.org/gstreamermm/0.10/</p>
<p>::</p>
<h2>include <gstreamermm.h></gstreamermm.h>
</h2>
<p>int main(int argc, char *argv[]) 
{
    Gst::init();</p>
<pre class="code literal-block"><span></span><span class="p">{</span>
    <span class="err">auto</span> <span class="err">pipeline</span> <span class="err">=</span> <span class="n">Gst</span><span class="p">:</span><span class="o">:</span><span class="n">Parse</span><span class="o">::</span><span class="n">launch</span> <span class="p">(</span>
            <span class="s2">"playbin2 uri=http://docs.gstreamer.com/media/sintel_trailer-480p.webm"</span><span class="p">);</span>

    <span class="err">pipeline-&gt;set_state(</span><span class="n">Gst</span><span class="p">:</span><span class="o">:</span><span class="n">STATE_PLAYING</span><span class="p">);</span>
    <span class="err">{</span>
        <span class="err">auto</span> <span class="err">bus</span> <span class="err">=</span> <span class="err">pipeline-&gt;get_bus()</span><span class="p">;</span>
        <span class="err">auto</span> <span class="err">msg</span> <span class="err">=</span> <span class="err">bus-&gt;pop(</span><span class="n">Gst</span><span class="p">:</span><span class="o">:</span><span class="n">CLOCK_TIME_NONE</span><span class="p">,</span> 
                <span class="n">static_cast</span><span class="o">&lt;</span><span class="n">Gst</span><span class="o">::</span><span class="n">MessageType</span><span class="o">&gt;</span><span class="p">(</span>
                    <span class="n">Gst</span><span class="o">::</span><span class="n">MESSAGE_ERROR</span> 
                    <span class="o">|</span> <span class="n">Gst</span><span class="o">::</span><span class="n">MESSAGE_EOS</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="nt">pipeline-</span><span class="o">&gt;</span><span class="nt">set_state</span><span class="o">(</span><span class="nt">Gst</span><span class="p">::</span><span class="nd">STATE_NULL</span><span class="o">);</span>
<span class="err">}</span>

<span class="nt">return</span> <span class="nt">0</span><span class="o">;</span>
</pre>

<p>}</p>
<p>build
$ g++ -std=c++0x 'pkg-config gstreamermm-0.10 --cflags --libs' main.cpp
unrefが省略できるのと、method呼び出しの記述方法がかわるのでコードがシンプルになる。
C版から翻訳するのに少し手間がかかるが、ほぼ機械的に変更するだけなのでこちらでいってみる。
2
::</p>
<h2>include <gstreamermm.h></gstreamermm.h>
</h2>
<p>int main(int argc, char *argv[]) 
{
    Gst::init();</p>
<pre class="code literal-block"><span></span><span class="nt">auto</span> <span class="nt">source</span> <span class="o">=</span> <span class="nt">Gst</span><span class="p">::</span><span class="nd">ElementFactory</span><span class="p">::</span><span class="nd">create_element</span><span class="o">(</span><span class="s2">"videotestsrc"</span><span class="o">,</span> <span class="s2">"source"</span><span class="o">);</span>
<span class="nt">auto</span> <span class="nt">sink</span> <span class="o">=</span> <span class="nt">Gst</span><span class="p">::</span><span class="nd">ElementFactory</span><span class="p">::</span><span class="nd">create_element</span><span class="o">(</span><span class="s2">"autovideosink"</span><span class="o">,</span> <span class="s2">"sink"</span><span class="o">);</span>
<span class="nt">auto</span> <span class="nt">pipeline</span> <span class="o">=</span> <span class="nt">Gst</span><span class="p">::</span><span class="nd">Pipeline</span><span class="p">::</span><span class="nd">create</span><span class="o">(</span><span class="s2">"test-pipeline"</span><span class="o">);</span>
<span class="nt">if</span> <span class="o">(!</span><span class="nt">pipeline</span> <span class="o">||</span> <span class="o">!</span><span class="nt">source</span> <span class="o">||</span> <span class="o">!</span><span class="nt">sink</span><span class="o">)</span> <span class="p">{</span>
    <span class="err">g_printerr</span> <span class="err">("Not</span> <span class="err">all</span> <span class="err">elements</span> <span class="err">could</span> <span class="err">be</span> <span class="err">created.\n")</span><span class="p">;</span>
    <span class="err">return</span> <span class="err">-1</span><span class="p">;</span>
<span class="p">}</span>
<span class="nt">auto</span> <span class="nt">filter</span><span class="o">=</span><span class="nt">Gst</span><span class="p">::</span><span class="nd">ElementFactory</span><span class="p">::</span><span class="nd">create_element</span><span class="o">(</span><span class="s2">"vertigotv"</span><span class="o">,</span> <span class="s2">"vertigotv_filter"</span><span class="o">);</span>
<span class="nt">if</span><span class="o">(!</span><span class="nt">filter</span><span class="o">)</span><span class="p">{</span>
    <span class="err">return</span> <span class="err">-1</span><span class="p">;</span>
<span class="p">}</span>
<span class="nt">auto</span> <span class="nt">filter2</span><span class="o">=</span><span class="nt">Gst</span><span class="p">::</span><span class="nd">ElementFactory</span><span class="p">::</span><span class="nd">create_element</span><span class="o">(</span><span class="s2">"ffmpegcolorspace"</span><span class="o">,</span> <span class="s2">"color_filter"</span><span class="o">);</span>
<span class="nt">if</span><span class="o">(!</span><span class="nt">filter2</span><span class="o">)</span><span class="p">{</span>
    <span class="err">return</span> <span class="err">-1</span><span class="p">;</span>
<span class="p">}</span>

<span class="c">/* Build the pipeline */</span>
<span class="nt">pipeline-</span><span class="o">&gt;</span><span class="nt">add</span><span class="o">(</span><span class="nt">source</span><span class="o">);</span>
<span class="nt">pipeline-</span><span class="o">&gt;</span><span class="nt">add</span><span class="o">(</span><span class="nt">sink</span><span class="o">);</span>
<span class="nt">pipeline-</span><span class="o">&gt;</span><span class="nt">add</span><span class="o">(</span><span class="nt">filter</span><span class="o">);</span>
<span class="nt">pipeline-</span><span class="o">&gt;</span><span class="nt">add</span><span class="o">(</span><span class="nt">filter2</span><span class="o">);</span>
<span class="nt">if</span><span class="o">(!</span><span class="nt">source-</span><span class="o">&gt;</span><span class="nt">link</span><span class="o">(</span><span class="nt">filter</span><span class="o">))</span><span class="p">{</span>
    <span class="err">g_printerr</span> <span class="err">("Elements</span> <span class="err">could</span> <span class="err">not</span> <span class="err">be</span> <span class="err">linked.\n")</span><span class="p">;</span>
    <span class="err">return</span> <span class="err">-1</span><span class="p">;</span>
<span class="p">}</span>
<span class="nt">if</span><span class="o">(!</span><span class="nt">filter-</span><span class="o">&gt;</span><span class="nt">link</span><span class="o">(</span><span class="nt">filter2</span><span class="o">))</span><span class="p">{</span>
    <span class="err">g_printerr</span> <span class="err">("Elements</span> <span class="err">could</span> <span class="err">not</span> <span class="err">be</span> <span class="err">linked.\n")</span><span class="p">;</span>
    <span class="err">return</span> <span class="err">-1</span><span class="p">;</span>
<span class="p">}</span>
<span class="nt">if</span><span class="o">(!</span><span class="nt">filter2-</span><span class="o">&gt;</span><span class="nt">link</span><span class="o">(</span><span class="nt">sink</span><span class="o">))</span><span class="p">{</span>
    <span class="err">g_printerr</span> <span class="err">("Elements</span> <span class="err">could</span> <span class="err">not</span> <span class="err">be</span> <span class="err">linked.\n")</span><span class="p">;</span>
    <span class="err">return</span> <span class="err">-1</span><span class="p">;</span>
<span class="p">}</span>

<span class="c">/* Modify the source's properties */</span>
<span class="nt">source-</span><span class="o">&gt;</span><span class="nt">set_property</span><span class="o">(</span><span class="s2">"pattern"</span><span class="o">,</span> <span class="nt">0</span><span class="o">);</span>

<span class="c">/* Start playing */</span>
<span class="nt">if</span> <span class="o">(!</span><span class="nt">pipeline-</span><span class="o">&gt;</span><span class="nt">set_state</span><span class="o">(</span><span class="nt">Gst</span><span class="p">::</span><span class="nd">STATE_PLAYING</span><span class="o">))</span> <span class="p">{</span>
    <span class="err">g_printerr</span> <span class="err">("Unable</span> <span class="err">to</span> <span class="err">set</span> <span class="err">the</span> <span class="err">pipeline</span> <span class="err">to</span> <span class="err">the</span> <span class="err">playing</span> <span class="err">state.\n")</span><span class="p">;</span>
    <span class="err">return</span> <span class="err">-1</span><span class="p">;</span>
<span class="p">}</span>

<span class="c">/* Wait until error or EOS */</span>
<span class="nt">auto</span> <span class="nt">bus</span> <span class="o">=</span> <span class="nt">pipeline-</span><span class="o">&gt;</span><span class="nt">get_bus</span> <span class="o">();</span>
<span class="nt">auto</span> <span class="nt">msg</span> <span class="o">=</span> <span class="nt">bus-</span><span class="o">&gt;</span><span class="nt">pop</span><span class="o">(</span><span class="nt">Gst</span><span class="p">::</span><span class="nd">CLOCK_TIME_NONE</span><span class="o">,</span> 
        <span class="nt">Gst</span><span class="p">::</span><span class="nd">MESSAGE_ERROR</span> <span class="o">|</span> <span class="nt">Gst</span><span class="p">::</span><span class="nd">MESSAGE_EOS</span><span class="o">);</span>

<span class="c">/* Parse message */</span>
<span class="nt">if</span> <span class="o">(</span><span class="nt">msg</span><span class="o">)</span> <span class="p">{</span>

    <span class="err">switch</span> <span class="err">(msg-&gt;get_message_type())</span> <span class="err">{</span>
        <span class="err">case</span> <span class="n">Gst</span><span class="p">:</span><span class="o">:</span><span class="n">MESSAGE_ERROR</span><span class="o">:</span>
            <span class="err">{</span>
                <span class="n">Glib</span><span class="o">::</span><span class="n">Error</span> <span class="n">err</span><span class="p">;</span>
                <span class="n">std</span><span class="p">:</span><span class="o">:</span><span class="n">string</span> <span class="n">debug_info</span><span class="p">;</span>
                <span class="n">Gst</span><span class="p">:</span><span class="o">:</span><span class="nf">MessageError</span><span class="p">(</span><span class="n">msg</span><span class="o">-</span><span class="err">&gt;</span><span class="nf">gobj_copy</span><span class="p">())</span><span class="o">.</span><span class="nf">parse</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="n">debug_info</span><span class="p">);</span>
                <span class="err">g_printerr</span> <span class="err">("Error</span> <span class="err">received</span> <span class="err">from</span> <span class="err">element</span> <span class="err">%</span><span class="n">s</span><span class="p">:</span> <span class="o">%</span><span class="n">s</span><span class="err">\</span><span class="n">n</span><span class="s2">", </span>
<span class="s2">                        msg-&gt;get_source()-&gt;get_name().c_str(), </span>
<span class="s2">                        err.what().c_str());</span>
<span class="s2">                g_printerr ("</span><span class="n">Debugging</span> <span class="n">information</span><span class="o">:</span> <span class="o">%</span><span class="n">s</span><span class="err">\</span><span class="n">n</span><span class="s2">", debug_info.c_str());</span>
<span class="s2">            }</span>
<span class="s2">            break;</span>

<span class="s2">        case Gst::MESSAGE_EOS:</span>
<span class="s2">            g_print ("</span><span class="n">End-Of-Stream</span> <span class="n">reached</span><span class="o">.</span><span class="err">\</span><span class="n">n</span><span class="s2">");</span>
<span class="s2">            break;</span>

<span class="s2">        default:</span>
<span class="s2">            /* We should not reach here because we only asked for ERRORs and EOS */</span>
<span class="s2">            g_printerr ("</span><span class="n">Unexpected</span> <span class="n">message</span> <span class="n">received</span><span class="o">.</span><span class="err">\</span><span class="n">n</span><span class="err">"</span><span class="p">);</span>
            <span class="err">break</span><span class="p">;</span>
    <span class="p">}</span>
<span class="err">}</span>

<span class="nt">pipeline-</span><span class="o">&gt;</span><span class="nt">set_state</span><span class="o">(</span><span class="nt">Gst</span><span class="p">::</span><span class="nd">STATE_NULL</span><span class="o">);</span>

<span class="nt">return</span> <span class="nt">0</span><span class="o">;</span>
</pre>

<p>}</p>
<p>3
::</p>
<h2>include <gstreamermm.h></gstreamermm.h>
</h2>
<p>struct CustomData 
{
    Glib::RefPtr&lt; Gst::Pipeline &gt; pipeline;
    Glib::RefPtr&lt; Gst::Element &gt; source;
    Glib::RefPtr&lt; Gst::Element &gt; convert;
    Glib::RefPtr&lt; Gst::Element &gt; sink;
};</p>
<p>// Handler for the pad-added signal
static void pad_added_handler (
        const Glib::RefPtr<:pad> &amp;new_pad, 
        CustomData *data)
{
    auto sink_pad = data-&gt;convert-&gt;get_static_pad("sink");</:pad></p>
<pre class="code literal-block"><span></span><span class="nt">g_print</span> <span class="o">(</span><span class="s2">"Received new pad '%s'\n"</span><span class="o">,</span> 
        <span class="nt">new_pad-</span><span class="o">&gt;</span><span class="nt">get_name</span><span class="o">()</span><span class="p">.</span><span class="nc">c_str</span><span class="o">());</span>

<span class="c">/* If our converter is already linked, we have nothing to do here */</span>
<span class="nt">if</span> <span class="o">(</span><span class="nt">sink_pad-</span><span class="o">&gt;</span><span class="nt">is_linked</span> <span class="o">())</span> <span class="p">{</span>
    <span class="err">g_print</span> <span class="err">("</span>  <span class="err">We</span> <span class="err">are</span> <span class="err">already</span> <span class="err">linked.</span> <span class="err">Ignoring.\n")</span><span class="p">;</span>
    <span class="err">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="c">/* Check the new pad's type */</span>
<span class="nt">auto</span> <span class="nt">new_pad_caps</span> <span class="o">=</span> <span class="nt">new_pad-</span><span class="o">&gt;</span><span class="nt">get_caps</span> <span class="o">();</span>
<span class="nt">auto</span> <span class="nt">new_pad_struct</span> <span class="o">=</span> <span class="nt">new_pad_caps-</span><span class="o">&gt;</span><span class="nt">get_structure</span> <span class="o">(</span><span class="nt">0</span><span class="o">);</span>
<span class="nt">std</span><span class="p">::</span><span class="nd">string</span> <span class="nt">new_pad_type</span> <span class="o">=</span> <span class="nt">new_pad_struct</span><span class="p">.</span><span class="nc">get_name</span><span class="o">();</span>
<span class="nt">if</span> <span class="o">(</span><span class="nt">new_pad_type</span><span class="p">.</span><span class="nc">find</span><span class="o">(</span><span class="s2">"audio/x-raw"</span><span class="o">)==</span><span class="nt">std</span><span class="p">::</span><span class="nd">string</span><span class="p">::</span><span class="nd">npos</span><span class="o">)</span> <span class="p">{</span>
    <span class="err">g_print</span> <span class="err">("</span>  <span class="err">It</span> <span class="err">has</span> <span class="err">type</span> <span class="err">'%s'</span> <span class="err">which</span> <span class="err">is</span> <span class="err">not</span> <span class="err">raw</span> <span class="err">audio.</span> <span class="err">Ignoring.\n",</span> 
            <span class="err">new_pad_type.c_str())</span><span class="p">;</span>
    <span class="err">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="c">/* Attempt the link */</span>
<span class="nt">if</span> <span class="o">(!</span><span class="nt">new_pad-</span><span class="o">&gt;</span><span class="nt">link</span><span class="o">(</span><span class="nt">sink_pad</span><span class="o">))</span> <span class="p">{</span>
    <span class="err">g_print</span> <span class="err">("</span>  <span class="err">Type</span> <span class="err">is</span> <span class="err">'%s'</span> <span class="err">but</span> <span class="err">link</span> <span class="err">failed.\n",</span> <span class="err">new_pad_type.c_str())</span><span class="p">;</span>
<span class="p">}</span> 
<span class="nt">else</span> <span class="p">{</span>
    <span class="err">g_print</span> <span class="err">("</span>  <span class="err">Link</span> <span class="err">succeeded</span> <span class="err">(type</span> <span class="err">'%s').\n",</span> <span class="err">new_pad_type.c_str())</span><span class="p">;</span>
<span class="p">}</span>
</pre>

<p>}</p>
<p>int main(int argc, char *argv[]) 
{
    Gst::init();</p>
<pre class="code literal-block"><span></span><span class="nt">CustomData</span> <span class="nt">data</span><span class="o">;</span>
<span class="nt">data</span><span class="p">.</span><span class="nc">source</span> <span class="o">=</span> <span class="nt">Gst</span><span class="p">::</span><span class="nd">ElementFactory</span><span class="p">::</span><span class="nd">create_element</span> <span class="o">(</span><span class="s2">"uridecodebin"</span><span class="o">,</span> <span class="s2">"source"</span><span class="o">);</span>
<span class="nt">data</span><span class="p">.</span><span class="nc">convert</span> <span class="o">=</span> <span class="nt">Gst</span><span class="p">::</span><span class="nd">ElementFactory</span><span class="p">::</span><span class="nd">create_element</span> <span class="o">(</span><span class="s2">"audioconvert"</span><span class="o">,</span> <span class="s2">"convert"</span><span class="o">);</span>
<span class="nt">data</span><span class="p">.</span><span class="nc">sink</span> <span class="o">=</span> <span class="nt">Gst</span><span class="p">::</span><span class="nd">ElementFactory</span><span class="p">::</span><span class="nd">create_element</span> <span class="o">(</span><span class="s2">"autoaudiosink"</span><span class="o">,</span> <span class="s2">"sink"</span><span class="o">);</span>
<span class="nt">data</span><span class="p">.</span><span class="nc">pipeline</span> <span class="o">=</span> <span class="nt">Gst</span><span class="p">::</span><span class="nd">Pipeline</span><span class="p">::</span><span class="nd">create</span> <span class="o">(</span><span class="s2">"test-pipeline"</span><span class="o">);</span>

<span class="nt">if</span> <span class="o">(!</span><span class="nt">data</span><span class="p">.</span><span class="nc">pipeline</span> <span class="o">||</span> <span class="o">!</span><span class="nt">data</span><span class="p">.</span><span class="nc">source</span> <span class="o">||</span> <span class="o">!</span><span class="nt">data</span><span class="p">.</span><span class="nc">convert</span> <span class="o">||</span> <span class="o">!</span><span class="nt">data</span><span class="p">.</span><span class="nc">sink</span><span class="o">)</span> <span class="p">{</span>
    <span class="err">g_printerr</span> <span class="err">("Not</span> <span class="err">all</span> <span class="err">elements</span> <span class="err">could</span> <span class="err">be</span> <span class="err">created.\n")</span><span class="p">;</span>
    <span class="err">return</span> <span class="err">-1</span><span class="p">;</span>
<span class="p">}</span>

<span class="c">/* Build the pipeline. Note that we are NOT linking the source at this</span>
<span class="c"> *    * point. We will do it later. */</span>
<span class="nt">data</span><span class="p">.</span><span class="nc">pipeline-</span><span class="o">&gt;</span><span class="nt">add</span><span class="o">(</span><span class="nt">data</span><span class="p">.</span><span class="nc">source</span><span class="o">);</span>
<span class="nt">data</span><span class="p">.</span><span class="nc">pipeline-</span><span class="o">&gt;</span><span class="nt">add</span><span class="o">(</span><span class="nt">data</span><span class="p">.</span><span class="nc">convert</span><span class="o">);</span>
<span class="nt">data</span><span class="p">.</span><span class="nc">pipeline-</span><span class="o">&gt;</span><span class="nt">add</span><span class="o">(</span><span class="nt">data</span><span class="p">.</span><span class="nc">sink</span><span class="o">);</span>
<span class="nt">if</span> <span class="o">(!</span><span class="nt">data</span><span class="p">.</span><span class="nc">convert-</span><span class="o">&gt;</span><span class="nt">link</span><span class="o">(</span><span class="nt">data</span><span class="p">.</span><span class="nc">sink</span><span class="o">))</span> <span class="p">{</span>
    <span class="err">g_printerr</span> <span class="err">("Elements</span> <span class="err">could</span> <span class="err">not</span> <span class="err">be</span> <span class="err">linked.\n")</span><span class="p">;</span>
    <span class="err">return</span> <span class="err">-1</span><span class="p">;</span>
<span class="p">}</span>

<span class="c">/* Set the URI to play */</span>
<span class="nt">data</span><span class="p">.</span><span class="nc">source-</span><span class="o">&gt;</span><span class="nt">set_property</span><span class="o">(</span>
        <span class="s2">"uri"</span><span class="o">,</span> 
        <span class="nt">Glib</span><span class="p">::</span><span class="nd">ustring</span><span class="o">(</span><span class="s2">"http://docs.gstreamer.com/media/sintel_trailer-480p.webm"</span><span class="o">)</span>
        <span class="o">);</span>

<span class="c">/* Connect to the pad-added signal */</span>
<span class="nt">data</span><span class="p">.</span><span class="nc">source-</span><span class="o">&gt;</span><span class="nt">signal_pad_added</span><span class="o">()</span><span class="p">.</span><span class="nc">connect</span><span class="o">(</span><span class="cp">[</span><span class="o">&amp;</span><span class="nb">data</span><span class="cp">]</span><span class="o">(</span>
            <span class="nt">const</span> <span class="nt">Glib</span><span class="p">::</span><span class="nd">RefPtr</span><span class="o">&lt;</span><span class="nt">Gst</span><span class="p">::</span><span class="nd">Pad</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="nt">pad</span><span class="o">)</span>
        <span class="p">{</span>
        <span class="err">pad_added_handler(pad,</span> <span class="err">&amp;data)</span><span class="p">;</span>
        <span class="p">}</span><span class="o">);</span>

<span class="c">/* Start playing */</span>
<span class="nt">if</span> <span class="o">(!</span><span class="nt">data</span><span class="p">.</span><span class="nc">pipeline-</span><span class="o">&gt;</span><span class="nt">set_state</span><span class="o">(</span><span class="nt">Gst</span><span class="p">::</span><span class="nd">STATE_PLAYING</span><span class="o">))</span> <span class="p">{</span>
    <span class="err">g_printerr</span> <span class="err">("Unable</span> <span class="err">to</span> <span class="err">set</span> <span class="err">the</span> <span class="err">pipeline</span> <span class="err">to</span> <span class="err">the</span> <span class="err">playing</span> <span class="err">state.\n")</span><span class="p">;</span>
    <span class="err">return</span> <span class="err">-1</span><span class="p">;</span>
<span class="p">}</span>

<span class="c">/* Listen to the bus */</span>
<span class="nt">auto</span> <span class="nt">bus</span> <span class="o">=</span> <span class="nt">data</span><span class="p">.</span><span class="nc">pipeline-</span><span class="o">&gt;</span><span class="nt">get_bus</span><span class="o">();</span>
<span class="nt">gboolean</span> <span class="nt">terminate</span> <span class="o">=</span> <span class="nt">FALSE</span><span class="o">;</span>
<span class="nt">do</span> <span class="p">{</span>
    <span class="err">auto</span> <span class="err">msg</span> <span class="err">=</span> <span class="err">bus-&gt;pop(</span><span class="n">Gst</span><span class="p">:</span><span class="o">:</span><span class="n">CLOCK_TIME_NONE</span><span class="p">,</span>
            <span class="n">Gst</span><span class="o">::</span><span class="n">MESSAGE_STATE_CHANGED</span> <span class="o">|</span> <span class="n">Gst</span><span class="o">::</span><span class="n">MESSAGE_ERROR</span> <span class="o">|</span> <span class="n">Gst</span><span class="o">::</span><span class="n">MESSAGE_EOS</span><span class="p">);</span>

    <span class="c">/* Parse message */</span>
    <span class="err">if</span> <span class="err">(msg)</span> <span class="err">{</span>

        <span class="err">switch</span> <span class="err">(msg-&gt;get_message_type())</span> <span class="err">{</span>
            <span class="err">case</span> <span class="n">Gst</span><span class="p">:</span><span class="o">:</span><span class="n">MESSAGE_ERROR</span><span class="o">:</span>
                <span class="err">{</span>
                    <span class="n">Glib</span><span class="o">::</span><span class="n">Error</span> <span class="n">err</span><span class="p">;</span>
                    <span class="n">std</span><span class="p">:</span><span class="o">:</span><span class="n">string</span> <span class="n">debug_info</span><span class="p">;</span>
                    <span class="n">Gst</span><span class="p">:</span><span class="o">:</span><span class="nf">MessageError</span><span class="p">(</span><span class="n">msg</span><span class="o">-</span><span class="err">&gt;</span><span class="nf">gobj_copy</span><span class="p">())</span><span class="o">.</span><span class="nf">parse</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="n">debug_info</span><span class="p">);</span>
                    <span class="err">g_printerr</span> <span class="err">("Error</span> <span class="err">received</span> <span class="err">from</span> <span class="err">element</span> <span class="err">%</span><span class="n">s</span><span class="p">:</span> <span class="o">%</span><span class="n">s</span><span class="err">\</span><span class="n">n</span><span class="s2">", </span>
<span class="s2">                            msg-&gt;get_source()-&gt;get_name().c_str(),</span>
<span class="s2">                            err.what().c_str());</span>
<span class="s2">                    g_printerr ("</span><span class="n">Debugging</span> <span class="n">information</span><span class="o">:</span> <span class="o">%</span><span class="n">s</span><span class="err">\</span><span class="n">n</span><span class="s2">", debug_info.c_str());</span>
<span class="s2">                    terminate = TRUE;</span>
<span class="s2">                }</span>
<span class="s2">                break;</span>

<span class="s2">            case Gst::MESSAGE_EOS:</span>
<span class="s2">                g_print ("</span><span class="n">End-Of-Stream</span> <span class="n">reached</span><span class="o">.</span><span class="err">\</span><span class="n">n</span><span class="s2">");</span>
<span class="s2">                terminate = TRUE;</span>
<span class="s2">                break;</span>

<span class="s2">            case Gst::MESSAGE_STATE_CHANGED:</span>
<span class="s2">                /* We are only interested in state-changed messages from the pipeline */</span>
<span class="s2">                if (msg-&gt;get_source() == data.pipeline) {</span>
<span class="s2">                    Gst::State old_state;</span>
<span class="s2">                    Gst::State new_state;</span>
<span class="s2">                    Gst::State pending_state;</span>
<span class="s2">                    Gst::MessageStateChanged(msg-&gt;gobj_copy()).parse(</span>
<span class="s2">                            old_state, new_state, pending_state);</span>
<span class="s2">                    g_print ("</span><span class="n">Pipeline</span> <span class="n">state</span> <span class="n">changed</span> <span class="n">from</span> <span class="o">%</span><span class="n">s</span> <span class="kc">to</span> <span class="o">%</span><span class="n">s</span><span class="o">:</span><span class="err">\</span><span class="n">n</span><span class="s2">",</span>
<span class="s2">                            typeid(old_state).name(),</span>
<span class="s2">                            typeid(new_state).name());</span>
<span class="s2">                }</span>
<span class="s2">                break;</span>
<span class="s2">            default:</span>
<span class="s2">                /* We should not reach here */</span>
<span class="s2">                g_printerr ("</span><span class="n">Unexpected</span> <span class="n">message</span> <span class="n">received</span><span class="o">.</span><span class="err">\</span><span class="n">n</span><span class="err">"</span><span class="p">);</span>
                <span class="err">break</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="err">}</span>
<span class="err">}</span> <span class="nt">while</span> <span class="o">(!</span><span class="nt">terminate</span><span class="o">);</span>

<span class="c">/* Free resources */</span>
<span class="nt">data</span><span class="p">.</span><span class="nc">pipeline-</span><span class="o">&gt;</span><span class="nt">set_state</span><span class="o">(</span><span class="nt">Gst</span><span class="p">::</span><span class="nd">STATE_NULL</span><span class="o">);</span>
<span class="nt">return</span> <span class="nt">0</span><span class="o">;</span>
</pre>

<p>}</p>
<p>.. categories:: programming
.. taxonomies: {tags: : cpp, gstreamer}</p>
</div>
                </div>
            </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/2013/06/11/irrlicht/" class="u-url">Oculusぽちった</a></h1>
                <div class="metadata">
                    <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                        ousttrue
                    </span></p>
            <p class="dateline">
            <a href="posts/2013/06/11/irrlicht/" rel="bookmark">
            <time class="published dt-published" datetime="2013-06-11T00:00:00Z" itemprop="datePublished" title="2013-06-11 00:00">2013-06-11 00:00</time></a>
            </p>
                        <p class="commentline">
        
    <a href="posts/2013/06/11/irrlicht/#disqus_thread" data-disqus-identifier="cache/content/posts/2013/06/11/irrlicht.html">コメント</a>


                </p>
</div>
            </header><div class="e-content entry-content">
                    <div>
<p>Oculusぽちった
会社で見せてもらったOculusに感銘を受けて本家サイトでぽちった。
8月発送の見通しとのことなのでそれまでに開発環境を用意しておかねば。
ということで、Irrlicht +
Oculusという方向性で環境を整備することにしようかと思う。
Irrlichtに関しては数年前からちょくちょく触ってはいてgithubに残骸が残っている。</p>
<p>irrmmd(IrrlichtMMDメッシュ)
onibi(Irrlichtと一緒に使いそうなライブラリの詰め合わせ)</p>
<p>どっちが新しいのかよくわからないが、両方ともなんか中途半端な状態である。
しかし、mmdを表示できるようにしてbulletを仕込むという路線にするのでonibiの続きからやるのがよさそうだ。
まずはmmdがちゃんと動くところまで修復するとしようか。
あと別プロセスのGUI向けのバックドアとしてmsgpack-rpcを仕込む。
そんな感じにしよう。
onibiの方をvc2010でビルドしてみたところ少し手直ししたらビルドできた。そういえばirrlichtとbulletのpythonラッパーを作ろうとしておったことを思い出してきた。
まぁしかしそれはおいておくとする。
で、pmdモデルの読み込みサンプルがあるので実行してみたら完全に作業が途中らしくモーションがまったくおかしい。
さらにbulletのものと思われる開放漏れが報告される。前は、MinGWでやっていたので開放漏れに気付いていなかったか。
いろいろ手直しが必要そうだ。</p>
<p>mikuさん
ついでなのでirrmmdの方もビルドしてみる。
こっちはちゃんと物理付でモーション再生に成功した。
irrmmdの方がちゃんとしているらしい。終了時にbulletを正しく開放しない問題はこちらも同じようだが。
onibiに合体して整理すれば使えそうだ。</p>
</div>
                </div>
            </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/2013/05/31/msgpack-rpc-python/" class="u-url">おれおれmsgpack-rpc-pythonを作る</a></h1>
                <div class="metadata">
                    <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                        ousttrue
                    </span></p>
            <p class="dateline">
            <a href="posts/2013/05/31/msgpack-rpc-python/" rel="bookmark">
            <time class="published dt-published" datetime="2013-05-31T00:00:00Z" itemprop="datePublished" title="2013-05-31 00:00">2013-05-31 00:00</time></a>
            </p>
                        <p class="commentline">
        
    <a href="posts/2013/05/31/msgpack-rpc-python/#disqus_thread" data-disqus-identifier="cache/content/posts/2013/05/31/msgpack-rpc-python.html">コメント</a>


                </p>
</div>
            </header><div class="e-content entry-content">
                    <div>
<p>おれおれmsgpack-rpc-pythonを作る
MsgPackRPCのpythonバインディング(クライアント側)が必要になったのでmsgpack-rpc-pythonを使ってみたのだが、
GUI(pyqt)に載せて接続制御とエラーハンドリングを細やかに制御したいので俺俺で類似品を作ることにした。
tonado-msgpackと名付けて取り合えず作業開始。
https://github.com/ousttrue/tornado-msgpack
msgpack-rpc-pythonのおかげでtornadoの存在を知ったのだがtornado.ioloopが見れば見るほどboost::asioっぽい。
ということで、c++で作成中のmsgpack-rpc-asioのpython版のような感じのAPIにしてみた。
以下の点を考慮している。</p>
<p>tornado.ioloopを隠さない
tornado.ioloopをスレッドに乗せて回しっぱなしにする
tornado.ioloopひとつで複数の接続を扱う
dispatcherを乗せ換え易くする。
接続ステータスの変化をコールバックで受け取る
非同期リクエストのコールバックを早期にセットする
TCP以外は考慮しない</p>
<p>プロジェクト作成
tonado_msgpack/
    setup.py
    sample/
        sample.py
    tonado_msgpack</p>
<p>setup.py
from distutils.core import setup</p>
<p>setup(
    name='tonado_msgpack',
    version='0.1',
    py_modules=['tonado_msgpack'],
    )</p>
<p>作業開始
$ python setup.py develop --user</p>
<p>sample/sample.py</p>
<h2>!/usr/bin/env python</h2>
<p>import tornado_msgpack
import tornado</p>
<p>if <strong>name</strong>=="<strong>main</strong>":
    port=18080</p>
<pre class="code literal-block"><span></span># dispatcher
dispatcher=tornado_msgpack.Dispatcher()
def add(a, b):
    return a+b
dispatcher.add_handler("add", add)

# server
server_loop=tornado.ioloop.IOLoop()
def on_receive(msg, session):
    result=dispatcher.dispatch(msg)
    session.send_async(result)
server=tornado_msgpack.Server(server_loop)
server.listen("localhost", port)
server_thread=threading.Thread(target=lambda : server_loop.start() )

# clinet
client_loop=tornado.ioloop.IOLoop()
client=tornado_msgpack.Client(client_loop)
def on_status_changed(status):
    print(status)
clinet.attach_status_callback(on_status_changed)
client.connect("localhost", port)
clinet_thread=threading.Thread(target=lambda : client_loop.start() )

# request
def on_receive(result):
    print(result)

future=clinet.call_async_with_callback(on_receive, "add", 1)
future.join()

future=clinet.call_async_with_callback(on_receive, "add", 1, 2)
future.join()

future=clinet.call_async_with_callback(on_receive, "add", 1, 2, 3)
future.join()

print("stop client...")
client_loop.stop()
clinet_thread.join()

print("stop server...")
server_loop.stop()
server_thread.join()

print("done")
</pre>

<p>とりあえずこんな感じを予定。
./sample/sample.pyでシンタックスエラーが出なくなるところまで確認。
tornado_msgpackを順次実装していく。
Tornado Reference - http://www.tornadoweb.org/en/stable/
だいたい動くようになった。
$ ./sample/sample
connected
&lt;_MainThread(MainThread, started 140102020679424)&gt;:send 9 bytes
<thread started>:on_read
<thread started>:send 48 bytes
<thread started>:on_read
on_receive:[1, 1, True, 'add() takes exactly 2 arguments (1 given)']
&lt;_MainThread(MainThread, started 140102020679424)&gt;:send 10 bytes
<thread started>:on_read
<thread started>:send 5 bytes
<thread started>:on_read
on_receive:[1, 2, False, 3]
&lt;_MainThread(MainThread, started 140102020679424)&gt;:send 11 bytes
<thread started>:on_read
<thread started>:send 59 bytes
<thread started>:on_read
on_receive:[1, 3, True, 'add() takes exactly 2 positional arguments (3 given)']
stop client...
stop server...
done</thread></thread></thread></thread></thread></thread></thread></thread></thread></p>
<p>サーバースレッドのioloopと、クライアントスレッドのioloopが相互にやり取りしている感じでちゃんと動いている。</p>
</div>
                </div>
            </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/2013/05/30/python-path/" class="u-url">Pythonモジュールをユーザーローカルにインストールする</a></h1>
                <div class="metadata">
                    <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                        ousttrue
                    </span></p>
            <p class="dateline">
            <a href="posts/2013/05/30/python-path/" rel="bookmark">
            <time class="published dt-published" datetime="2013-05-30T00:00:00Z" itemprop="datePublished" title="2013-05-30 00:00">2013-05-30 00:00</time></a>
            </p>
                        <p class="commentline">
        
    <a href="posts/2013/05/30/python-path/#disqus_thread" data-disqus-identifier="cache/content/posts/2013/05/30/python-path.html">コメント</a>


                </p>
</div>
            </header><div class="e-content entry-content">
                    <div>
<p>Pythonモジュールをユーザーローカルにインストールする
$ python setup.py installをユーザローカルにインストールする方法
$ PYTHONPATH=$HOME/local/lib64/python3.2/site-packages python setup.py install --prefix=$HOME/local</p>
<p>ではなく下がよい</p>
<p>$ python setup.py install --user</p>
<p>--prefixの値と環境変数PYTHONPATHの値が対応している必要がある。
PYTHONPATHにはsite-packagesまでを指定する。
devlopの場合は、
$ python setup.py develop --user</p>
<p>http://docs.python.org/2/install/#alternate-installation-the-user-scheme</p>
</div>
                </div>
            </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/2013/05/27/gentoo-bluetooth/" class="u-url">GentooでBluetooth</a></h1>
                <div class="metadata">
                    <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                        ousttrue
                    </span></p>
            <p class="dateline">
            <a href="posts/2013/05/27/gentoo-bluetooth/" rel="bookmark">
            <time class="published dt-published" datetime="2013-05-27T00:00:00Z" itemprop="datePublished" title="2013-05-27 00:00">2013-05-27 00:00</time></a>
            </p>
                        <p class="commentline">
        
    <a href="posts/2013/05/27/gentoo-bluetooth/#disqus_thread" data-disqus-identifier="cache/content/posts/2013/05/27/gentoo-bluetooth.html">コメント</a>


                </p>
</div>
            </header><div class="e-content entry-content">
                    <div>
<p>GentooでBluetooth
Gentooでbluetoothを使う。</p>
<p>http://wiki.gentoo.org/wiki/Bluetooth</p>
<p>dmesg
[22782.149236] Bluetooth: Core ver 2.16
[22782.149244] NET: Registered protocol family 31
[22782.149245] Bluetooth: HCI device and connection manager initialized
[22782.149252] Bluetooth: HCI socket layer initialized
[22782.149254] Bluetooth: L2CAP socket layer initialized
[22782.149255] Bluetooth: SCO socket layer initialized
[22782.151467] Bluetooth: BNEP (Ethernet Emulation) ver 1.3
[22782.151469] Bluetooth: BNEP filters: protocol multicast
[22782.151475] Bluetooth: BNEP socket layer initialized</p>
<p>kernel
HCI USB driver (btusb) を有効にする。
USE設定とツール
/etc/portage/make.conf
USEにbluetoothを追加</p>
<p>/etc/portage/package.use
net-wireless/bluez test-programs # simple-agentに必要</p>
<p>インストール</p>
<h2>emerge --ask --changed-use --deep @world</h2>
<h2>/etc/init.d/bluetooth start</h2>
<h2>rc-update add bluetooth default</h2>
<p>Pairing
$ hcitools scan
        XX:XX:XX:XX:XX:XX       M-NV1BR Series</p>
<p>$ simple-agent XX:XX:XX:XX:XX:XX
Traceback (most recent call last):
  File "/usr/bin/simple-agent", line 115, in <module>
    path = manager.FindAdapter(args[0])
  File "/usr/lib64/python2.7/site-packages/dbus/proxies.py", line 70, in <strong>call</strong>
    return self._proxy_method(<em>args, </em><em>keywords)
  File "/usr/lib64/python2.7/site-packages/dbus/proxies.py", line 145, in <strong>call</strong>
    </em>*keywords)
  File "/usr/lib64/python2.7/site-packages/dbus/connection.py", line 651, in call_blocking
    message, timeout)
dbus.exceptions.DBusException: org.bluez.Error.NoSuchAdapter: No such adapter</module></p>
<p>ここで頓挫。どうも埒が明かぬ。
と思ったらsimple-agentの引数が足りなかった。
bluetooth deviceのコネクトボタンを押す</p>
<p>$ simple-agent hci0 XX:XX:XX:XX:XX:XX
$ bluez-test-device trusted XX:XX:XX:XX:XX:XX yes
$ bluez-test-input connect XX:XX:XX:XX:XX:XX</p>
<p>とりあえず接続はできた。
複数接続登録タイプのキーボードとマウスを買ってきたのでそれを有効にしたいのだが、
今のところ切り替え時に毎回コネクトボタンを押さされている。
一瞬だけコネクトボタンなしでの切り替えができた時期があったのでなんか方法があるはずなのだが。
utility</p>
<h2>emerge -av blueman</h2>
</div>
                </div>
            </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/2013/05/26/gentoo-eth0/" class="u-url">Gentooでネットワークインターフェースがeth0にならない件</a></h1>
                <div class="metadata">
                    <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                        ousttrue
                    </span></p>
            <p class="dateline">
            <a href="posts/2013/05/26/gentoo-eth0/" rel="bookmark">
            <time class="published dt-published" datetime="2013-05-26T00:00:00Z" itemprop="datePublished" title="2013-05-26 00:00">2013-05-26 00:00</time></a>
            </p>
                        <p class="commentline">
        
    <a href="posts/2013/05/26/gentoo-eth0/#disqus_thread" data-disqus-identifier="cache/content/posts/2013/05/26/gentoo-eth0.html">コメント</a>


                </p>
</div>
            </header><div class="e-content entry-content">
                    <div>
<p>Gentooでネットワークインターフェースがeth0にならない件
最近インストールしたAMDのオンボードEtherと、MacBookAirのUsb
Etherが共にeth0にならなかった。
AMD機では、/etc/init.d/net.eth0 startが失敗するのでなんでかと思ったら違う名前になっていた。</p>
<h2>ifconfig -a</h2>
<p>enp3s0: flags=4163<up>  mtu 1500</up></p>
<p>eth0ではないので/etc/init.d/net.eth0ではなく/etc/init.d/net.enp3s0とする必要があった。
/etc/conf.d/netも書き換え。
MacBookAirでも違う名前になっていた。</p>
<h2>ifconfig -a</h2>
<p>enp0s29f7u1u1: flags=4163<up>  mtu 1500</up></p>
<p>とりあえずシンボリックリンク/etc/init.d/net.enp0s29f7u1u1を作って接続することはできたがちょっと調べてみることにした。
udevinfo
なんかudevinfoが見つからぬ。
http://www.gossamer-threads.com/lists/gentoo/user/174113
によるとudevadmになったらしい。</p>
<h2>udevadm info -a /sys/class/net/enp3s0</h2>
<p>で情報をとれた。
参考:http://www.ice.is.kit.ac.jp/~umehara/misc/comp/20060408.html
gentooのudev設定
http://www.gentoo.gr.jp/transdocs/udevrules/udevrules.html#example-iface
/etc/udev/rules.d/myether
SUBSYTEM="net", ATTR{address}=="XX:XX:XX:XX:XX:XX", NAME="eth0"</p>
<p>書いてみた。最近のudevではSYSFSはATTRになったぽい。
test</p>
<h2>udevadm test /sys/class/net/enp3s0</h2>
<p>うまくいかぬ・・・</p>
<h2>cd /etc/udev/rules.d</h2>
<h2>mv myether 50-ether.rules</h2>
<p>有効なファイル名が決まっていた。
test</p>
<h2>udevadm test /sys/class/net/enp3s0</h2>
<p>unknown key 'SUBSYTEM' in /etc/udev/rules.d/50-ether.rules:1
invalid rule '/etc/udev/rules.d/50-ether.rules:1'</p>
<p>書き方がよろしくないらしい
SUBSYSTEM=="net", ATTR{address}=="XX:XX:XX:XX:XX:XX", NAME="eth0"</p>
<p>タイポを修正
changing net interface name from 'enp3s0' to 'eth0'</p>
<p>うまくいった。
反映</p>
<h2>cd /etc/int.d</h2>
<h2>rc-update delete net.enp3s0</h2>
<h2>mv net.enp3s0 net.eth0</h2>
<h2>rc-update add net.eth0 defalt</h2>
<h2>vim /etc/conf.d/net</h2>
<h2>reboot</h2>
</div>
                </div>
            </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/2013/05/25/gentoo-realtimeclock/" class="u-url">hwclockの設定</a></h1>
                <div class="metadata">
                    <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                        ousttrue
                    </span></p>
            <p class="dateline">
            <a href="posts/2013/05/25/gentoo-realtimeclock/" rel="bookmark">
            <time class="published dt-published" datetime="2013-05-25T00:00:00Z" itemprop="datePublished" title="2013-05-25 00:00">2013-05-25 00:00</time></a>
            </p>
                        <p class="commentline">
        
    <a href="posts/2013/05/25/gentoo-realtimeclock/#disqus_thread" data-disqus-identifier="cache/content/posts/2013/05/25/gentoo-realtimeclock.html">コメント</a>


                </p>
</div>
            </header><div class="e-content entry-content">
                    <div>
<p>hwclockの設定
起動時のエラーメッセージ
Failed to sync clocks</p>
<p>に対処する。
ずっと以前からいつも出ていたような気がするが気が向いたので調べる。
発生源はhwclock。</p>
<h2>hwclock</h2>
<p>Cannot access the Hardware Clock via any known method.
Use the --debug option to see the details of our search for an access method.</p>
<p>参考:http://www.yamasita.jp/linkstation/2010/06/100620_post_276.html
/dev/rtcが無いことがわかった。
カーネルを再ビルドだ。
によると下記のように設定せよと書いてあるがそれらしきオプションが見つからない。
Character devices ---&gt;
  [ ] Enhanced RTC
General setup ---&gt;
  [*] Support for /dev/rtc</p>
<p>設定の位置が変わっている。大雑把に以下のような感じ。
DeviceDrivers
  Character Device
    [ ] Enhanced RTC
  RealTimeClock
    [*] Support for /dev/rtc</p>
<p>カーネルをビルドして再起動したらエラーメッセージが出なくなった。</p>
</div>
                </div>
            </article>
</div>
    
        <ul class="pager postindexpager clearfix">
<li class="previous"><a href="index-4.html" rel="prev">新しい記事</a></li>
            <li class="next"><a href="index-2.html" rel="next">過去の記事</a></li>
        </ul>
<script>var disqus_shortname="nikolademo";(function(){var a=document.createElement("script");a.async=true;a.src="https://"+disqus_shortname+".disqus.com/count.js";(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(a)}());</script><!--End of body content--><footer id="footer">
            Contents © 2021         <a href="mailto:ousttrue@gmail.com">ousttrue</a> - Powered by         <a href="https://getnikola.com" rel="nofollow">Nikola</a>         
            
            
        </footer>
</div>
</div>


        <script src="assets/js/all-nocdn.js"></script><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element){var i=element.getElementsByTagName('img')[0];return i===undefined?'':i.alt;}});
    </script>
</body>
</html>
