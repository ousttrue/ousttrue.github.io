<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <title>三次元日誌</title>

    

  <script src="https://ousttrue.github.io/plugins/elasticlunr.min.js" defer></script>
  <script src="https://ousttrue.github.io/search_index.en.js" defer></script>
  <script src="https://ousttrue.github.io/js/search.js" defer></script>

    

     
    <link rel="stylesheet" href="https://ousttrue.github.io/main.css">
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css"
      />
    
  </head>

  <body class="container">
    <a class="site_title" href="https:&#x2F;&#x2F;ousttrue.github.io&#x2F;">
      <div>三次元日誌</div>
    </a>

    <nav class="nav">
      <a class="item" href="/tags/">tags</a>
      <a class="item" href="https://github.com/ousttrue" aria-label="github">
        <i class="fab fa-github fa-lg"></i>
      </a>
      

        
            <form class="navbar-form">
                <input id="userinput" class="form-control is-search" type="search" placeholder="Search docs..."
                    aria-label="Search docs..." autocomplete="off">
                <div id="suggestions" class="shadow bg-white rounded"></div>
            </form>
        
    </nav>

    <main class="main">
<div class="page">
<div class="content">
  <div class="headline">
  
  

  
  <a class="headline_title" href="https:&#x2F;&#x2F;ousttrue.github.io&#x2F;blender&#x2F;blender-addon-vscode&#x2F;"> BlenderのAddOnを、VSCodeでデバッグする 
  

  
  </a>

  

  <div>
    <ul class="tags">
      <li class="headline_date">
        <div class="year">2017</div>
        <div class="md">1123</div>
      </li>
      
      


    <li class="tag"><a href="https:&#x2F;&#x2F;ousttrue.github.io&#x2F;tags&#x2F;blender&#x2F;">blender</a></li>

    <li class="tag"><a href="https:&#x2F;&#x2F;ousttrue.github.io&#x2F;tags&#x2F;vscode&#x2F;">vscode</a></li>




    </ul>
  </div>
</div>
 <p>VSCodeのリモートデバッグを利用してBlenderのPythonにデバッガをアタッチする。</p>
<p><a href="https://pypi.python.org/pypi/ptvsd">PTVSD</a></p>
<p>VisualStudioのPTVS向けのリモートデバッグモジュール。VSCodeも対応しているらしい。
リモート側でptvsdをimportして待ち受けて、VisualStudio側からtcp経由でアタッチする。</p>
<pre style="background-color:#2b303b;">
<code class="language-python" data-lang="python"><span style="color:#b48ead;">import </span><span style="color:#c0c5ce;">ptvsd
ptvsd.</span><span style="color:#bf616a;">enable_attach</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">secret </span><span style="color:#c0c5ce;">= &#39;</span><span style="color:#a3be8c;">secret</span><span style="color:#c0c5ce;">&#39;, (&#39;</span><span style="color:#a3be8c;">0.0.0.0</span><span style="color:#c0c5ce;">&#39;, </span><span style="color:#d08770;">3000</span><span style="color:#c0c5ce;">))

</span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">os != &#39;</span><span style="color:#a3be8c;">Windows</span><span style="color:#c0c5ce;">&#39;:
    ptvsd.</span><span style="color:#bf616a;">wait_for_attach</span><span style="color:#c0c5ce;">() </span><span style="color:#65737e;"># スクリプトが終わらないようにブロックする
</span></code></pre><pre style="background-color:#2b303b;">
<code><span style="color:#c0c5ce;">+--------------+
|remoteのpython|
|         ptvsd|tcp:3000 &lt;-- VisualStudio attach
+--------------+
</span></code></pre>
<p>dos窓</p>
<pre style="background-color:#2b303b;">
<code><span style="color:#c0c5ce;">&gt; netstat -an | find &quot;3000&quot;
  TCP         0.0.0.0:3000           0.0.0.0:0              LISTENING
</span></code></pre>
<p>確かに待っている。
TCP経由なのでptvsd側が、LinuxやRasPi、Blenderの組み込みPythonなどなんであってもアタッチできる。
素のPythonでやってみる</p>
<p>Windows10(64bit)
Python-3.6
PTVSD-3.0.0</p>
<p>PTVSDのバージョンが3.0.0でないと
デバッグアダプタープロセスが予期せず終了しました。</p>
<p>等のエラーが出てうまくいかぬ。</p>
<p>https://github.com/DonJayamanne/pythonVSCode/issues/1039</p>
<p>ptvsdのインストール</p>
<pre style="background-color:#2b303b;">
<code><span style="color:#c0c5ce;">&gt; py -3.6 -m pip install ptvsd==3.0.0
</span></code></pre>
<p>testプロジェクト</p>
<pre style="background-color:#2b303b;">
<code><span style="color:#c0c5ce;">&gt; mkdir ptvsd_test
</span></code></pre>
<p>VSCodeでptvsd_testフォルダを開く。
testスクリプト
ptvsd_test/main.py</p>
<pre style="background-color:#2b303b;">
<code class="language-python" data-lang="python"><span style="color:#b48ead;">import </span><span style="color:#c0c5ce;">time

</span><span style="color:#65737e;"># PTVSDを準備する
</span><span style="color:#b48ead;">import </span><span style="color:#c0c5ce;">ptvsd
listen = (&#39;</span><span style="color:#a3be8c;">0.0.0.0</span><span style="color:#c0c5ce;">&#39;, </span><span style="color:#d08770;">3000</span><span style="color:#c0c5ce;">)
ptvsd.</span><span style="color:#bf616a;">enable_attach</span><span style="color:#c0c5ce;">(&#39;</span><span style="color:#a3be8c;">my_secret</span><span style="color:#c0c5ce;">&#39;, listen)

</span><span style="color:#96b5b4;">print</span><span style="color:#c0c5ce;">(&#39;</span><span style="color:#a3be8c;">wait_for_attach...</span><span style="color:#c0c5ce;">&#39;, listen)
ptvsd.</span><span style="color:#bf616a;">wait_for_attach</span><span style="color:#c0c5ce;">() </span><span style="color:#65737e;"># リモートデバッガの接続を待つ

</span><span style="color:#c0c5ce;">time.</span><span style="color:#bf616a;">sleep</span><span style="color:#c0c5ce;">(</span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">) </span><span style="color:#65737e;"># 接続後少し待つ
</span><span style="color:#96b5b4;">print</span><span style="color:#c0c5ce;">(&#39;</span><span style="color:#a3be8c;">connected</span><span style="color:#c0c5ce;">&#39;)

</span><span style="color:#65737e;"># デバッグするコード
</span><span style="color:#c0c5ce;">i = </span><span style="color:#d08770;">0
</span><span style="color:#b48ead;">while </span><span style="color:#d08770;">True</span><span style="color:#c0c5ce;">:
    </span><span style="color:#96b5b4;">print</span><span style="color:#c0c5ce;">(i)
    i += </span><span style="color:#d08770;">1
    </span><span style="color:#c0c5ce;">time.</span><span style="color:#bf616a;">sleep</span><span style="color:#c0c5ce;">(</span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">)
</span></code></pre><pre style="background-color:#2b303b;">
<code><span style="color:#c0c5ce;">&gt;py -3.6 main.py
wait_for_attach... (&#39;0.0.0.0&#39;, 3000)
</span></code></pre>
<p>VSCodeから接続
ptvsd_test/main.pyを開いてデバッグ開始。構成の追加でpythonを選択する。</p>
<p>ptvsd_test/.vscode/launch.json</p>
<pre style="background-color:#2b303b;">
<code class="language-json" data-lang="json"><span style="color:#c0c5ce;">{
    </span><span style="color:#65737e;">// IntelliSense を使用して利用可能な属性を学べます。
    // 既存の属性の説明をホバーして表示します。
    // 詳細情報は次を確認してください: https://go.microsoft.com/fwlink/?linkid=830387
    </span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">version</span><span style="color:#c0c5ce;">&quot;: &quot;</span><span style="color:#a3be8c;">0.2.0</span><span style="color:#c0c5ce;">&quot;,
    &quot;</span><span style="color:#a3be8c;">configurations</span><span style="color:#c0c5ce;">&quot;: [
        {
            &quot;</span><span style="color:#a3be8c;">name</span><span style="color:#c0c5ce;">&quot;: &quot;</span><span style="color:#a3be8c;">Python</span><span style="color:#c0c5ce;">&quot;,
            &quot;</span><span style="color:#a3be8c;">type</span><span style="color:#c0c5ce;">&quot;: &quot;</span><span style="color:#a3be8c;">python</span><span style="color:#c0c5ce;">&quot;,
            &quot;</span><span style="color:#a3be8c;">request</span><span style="color:#c0c5ce;">&quot;: &quot;</span><span style="color:#a3be8c;">launch</span><span style="color:#c0c5ce;">&quot;,
            &quot;</span><span style="color:#a3be8c;">stopOnEntry</span><span style="color:#c0c5ce;">&quot;: </span><span style="color:#d08770;">true</span><span style="color:#c0c5ce;">,
            &quot;</span><span style="color:#a3be8c;">pythonPath</span><span style="color:#c0c5ce;">&quot;: &quot;</span><span style="color:#a3be8c;">${config:python.pythonPath}</span><span style="color:#c0c5ce;">&quot;,
            &quot;</span><span style="color:#a3be8c;">program</span><span style="color:#c0c5ce;">&quot;: &quot;</span><span style="color:#a3be8c;">${file}</span><span style="color:#c0c5ce;">&quot;,
            &quot;</span><span style="color:#a3be8c;">cwd</span><span style="color:#c0c5ce;">&quot;: &quot;</span><span style="color:#a3be8c;">${workspaceRoot}</span><span style="color:#c0c5ce;">&quot;,
            &quot;</span><span style="color:#a3be8c;">env</span><span style="color:#c0c5ce;">&quot;: {},
            &quot;</span><span style="color:#a3be8c;">envFile</span><span style="color:#c0c5ce;">&quot;: &quot;</span><span style="color:#a3be8c;">${workspaceRoot}/.env</span><span style="color:#c0c5ce;">&quot;,
            &quot;</span><span style="color:#a3be8c;">debugOptions</span><span style="color:#c0c5ce;">&quot;: [
                &quot;</span><span style="color:#a3be8c;">WaitOnAbnormalExit</span><span style="color:#c0c5ce;">&quot;,
                &quot;</span><span style="color:#a3be8c;">WaitOnNormalExit</span><span style="color:#c0c5ce;">&quot;,
                &quot;</span><span style="color:#a3be8c;">RedirectOutput</span><span style="color:#c0c5ce;">&quot;
            ]
        },
        { </span><span style="color:#65737e;">// これ
            </span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">name</span><span style="color:#c0c5ce;">&quot;: &quot;</span><span style="color:#a3be8c;">Python: Attach</span><span style="color:#c0c5ce;">&quot;,
            &quot;</span><span style="color:#a3be8c;">type</span><span style="color:#c0c5ce;">&quot;: &quot;</span><span style="color:#a3be8c;">python</span><span style="color:#c0c5ce;">&quot;,
            &quot;</span><span style="color:#a3be8c;">request</span><span style="color:#c0c5ce;">&quot;: &quot;</span><span style="color:#a3be8c;">attach</span><span style="color:#c0c5ce;">&quot;,
            &quot;</span><span style="color:#a3be8c;">localRoot</span><span style="color:#c0c5ce;">&quot;: &quot;</span><span style="color:#a3be8c;">${workspaceRoot}</span><span style="color:#c0c5ce;">&quot;,
            &quot;</span><span style="color:#a3be8c;">remoteRoot</span><span style="color:#c0c5ce;">&quot;: &quot;</span><span style="color:#a3be8c;">${workspaceRoot}</span><span style="color:#c0c5ce;">&quot;,
            &quot;</span><span style="color:#a3be8c;">port</span><span style="color:#c0c5ce;">&quot;: </span><span style="color:#d08770;">3000</span><span style="color:#c0c5ce;">,
            &quot;</span><span style="color:#a3be8c;">secret</span><span style="color:#c0c5ce;">&quot;: &quot;</span><span style="color:#a3be8c;">my_secret</span><span style="color:#c0c5ce;">&quot;,
            &quot;</span><span style="color:#a3be8c;">host</span><span style="color:#c0c5ce;">&quot;: &quot;</span><span style="color:#a3be8c;">localhost</span><span style="color:#c0c5ce;">&quot;
        },

        </span><span style="color:#65737e;">// 以降省略
</span><span style="background-color:#bf616a;color:#2b303b;">}</span><span style="color:#c0c5ce;">
</span></code></pre>
<p>デバッグの選択メニューでPython:Attachを選択。改めて開始。
うまく接続できればデバッグコンソールにprintした内容が表示される。
breakポイントもステップ実行も可能。素晴らしい。
BlenderのAddOnでやってみる</p>
<p>https://github.com/Barbarbarbarian/Blender-VScode-Debugger</p>
<p>これ。
BlenderのPythonにptvsdをインストールする
Blenderを起動して以下のスクリプトを実行する。</p>
<pre style="background-color:#2b303b;">
<code class="language-python" data-lang="python"><span style="color:#b48ead;">import </span><span style="color:#c0c5ce;">sys
</span><span style="color:#b48ead;">for </span><span style="color:#c0c5ce;">x </span><span style="color:#b48ead;">in </span><span style="color:#c0c5ce;">sys.path:
    </span><span style="color:#96b5b4;">print</span><span style="color:#c0c5ce;">(x)
</span></code></pre>
<p>適当なパスを選んでそこにptvsd-3.0.0をコピーする。
ptvsd-3.0.0.zipをダウンロード。
解凍してptvsdフォルダをBlenderのsys.pathに含まれていたC:/Program Files/Blender Foundation/Blenderにコピーした。
Blender-VScode-Debuggerをインストールする</p>
<p>File - UserPreferences - Add-ons と潜ってinstall Add-on from FileボタンからBlender_VScode_Debugger.pyを選択する。
Add-onsからDevelopment: Debugger for Visual Codeを選択してチェックボックスをOnにする
三角を押してPreferencesを展開、Path of PTVSD module:にptvsdをインストールしたパスを設定する(うちではC:/Program Files/Blender Foundation/Blender)
Save - User Settings</p>
<p>実行してみる
3DViewでspaceを押してConnect to Visual Studio Code Debuggerを選択。
dos窓</p>
<pre style="background-color:#2b303b;">
<code><span style="color:#c0c5ce;">&gt; netstat -an | find &quot;3000&quot;
  TCP         0.0.0.0:3000           0.0.0.0:0              LISTENING
</span></code></pre>
<p>待っている。
試しにAddOnを作ってみる
例えばWindows版のBlenderのAddOnパスは
C:/Users/<strong>USER_NAME</strong>/AppData/Roaming/Blender Foundation/Blender/2.79/scripts/addons
です。
Hello AddOnを作る。
hello.pyとhello/<strong>init</strong>.pyという選択肢があるが、後者で作る。
gitやVSCodeを使うのだからフォルダが独立している方がよろしい。
helloフォルダを作って、VSCodeでフォルダを開いた。
hello/<strong>init</strong>.pyを作成。</p>
<p>https://docs.blender.org/manual/en/dev/advanced/scripting/addon_tutorial.html</p>
<p>を参考に。</p>
<pre style="background-color:#2b303b;">
<code class="language-python" data-lang="python"><span style="color:#c0c5ce;">bl_info = {
    &quot;</span><span style="color:#a3be8c;">name</span><span style="color:#c0c5ce;">&quot;: &quot;</span><span style="color:#a3be8c;">Move X Axis</span><span style="color:#c0c5ce;">&quot;,
    &quot;</span><span style="color:#a3be8c;">category</span><span style="color:#c0c5ce;">&quot;: &quot;</span><span style="color:#a3be8c;">Object</span><span style="color:#c0c5ce;">&quot;,
}

</span><span style="color:#b48ead;">import </span><span style="color:#c0c5ce;">bpy


</span><span style="color:#b48ead;">class </span><span style="color:#ebcb8b;">ObjectMoveX</span><span style="color:#eff1f5;">(</span><span style="color:#a3be8c;">bpy.types.Operator</span><span style="color:#eff1f5;">):
    </span><span style="color:#65737e;">&quot;&quot;&quot;My Object Moving Script&quot;&quot;&quot;      # Use this as a tool-tip for menu items and buttons.
    </span><span style="color:#c0c5ce;">bl_idname = &quot;</span><span style="color:#a3be8c;">object.move_x</span><span style="color:#c0c5ce;">&quot;        </span><span style="color:#65737e;"># Unique identifier for buttons and menu items to reference.
    </span><span style="color:#c0c5ce;">bl_label = &quot;</span><span style="color:#a3be8c;">Move X by One</span><span style="color:#c0c5ce;">&quot;         </span><span style="color:#65737e;"># Display name in the interface.
    </span><span style="color:#c0c5ce;">bl_options = {&#39;</span><span style="color:#a3be8c;">REGISTER</span><span style="color:#c0c5ce;">&#39;, &#39;</span><span style="color:#a3be8c;">UNDO</span><span style="color:#c0c5ce;">&#39;}  </span><span style="color:#65737e;"># Enable undo for the operator.

    </span><span style="color:#b48ead;">def </span><span style="color:#8fa1b3;">execute</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">self</span><span style="color:#c0c5ce;">, </span><span style="color:#bf616a;">context</span><span style="color:#c0c5ce;">):        </span><span style="color:#65737e;"># execute() is called when running the operator.

        # The original script
        </span><span style="color:#c0c5ce;">scene = context.scene
        </span><span style="color:#b48ead;">for </span><span style="color:#c0c5ce;">obj </span><span style="color:#b48ead;">in </span><span style="color:#c0c5ce;">scene.objects:
            obj.location.x += </span><span style="color:#d08770;">1.0

        </span><span style="color:#b48ead;">return </span><span style="color:#c0c5ce;">{&#39;</span><span style="color:#a3be8c;">FINISHED</span><span style="color:#c0c5ce;">&#39;}            </span><span style="color:#65737e;"># Lets Blender know the operator finished successfully.

</span><span style="color:#b48ead;">def </span><span style="color:#8fa1b3;">register</span><span style="color:#c0c5ce;">():
    bpy.utils.</span><span style="color:#bf616a;">register_class</span><span style="color:#c0c5ce;">(ObjectMoveX)


</span><span style="color:#b48ead;">def </span><span style="color:#8fa1b3;">unregister</span><span style="color:#c0c5ce;">():
    bpy.utils.</span><span style="color:#bf616a;">unregister_class</span><span style="color:#c0c5ce;">(ObjectMoveX)


</span><span style="color:#65737e;"># This allows you to run the script directly from Blenders Text editor
# to test the add-on without having to install it.
</span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">__name__ == &quot;</span><span style="color:#a3be8c;">__main__</span><span style="color:#c0c5ce;">&quot;:
    </span><span style="color:#bf616a;">register</span><span style="color:#c0c5ce;">()
</span></code></pre>
<p>Blenderを再起動して、AddOnのチェックボックスを有効にする。
3DViewでスペースを押してMove X by oneを実行してみる。
動けば準備完了。
AddOnをステップ実行してみる</p>
<p>3DViewでConnect to Visual Studio Code Debugger
VSCodeで構成を追加してRemoteDebuggerでアタッチ</p>
<p>hello/.vscode/launch.json</p>
<pre style="background-color:#2b303b;">
<code class="language-json" data-lang="json"><span style="color:#c0c5ce;">        {
            &quot;</span><span style="color:#a3be8c;">name</span><span style="color:#c0c5ce;">&quot;: &quot;</span><span style="color:#a3be8c;">Python: Attach</span><span style="color:#c0c5ce;">&quot;,
            &quot;</span><span style="color:#a3be8c;">type</span><span style="color:#c0c5ce;">&quot;: &quot;</span><span style="color:#a3be8c;">python</span><span style="color:#c0c5ce;">&quot;,
            &quot;</span><span style="color:#a3be8c;">request</span><span style="color:#c0c5ce;">&quot;: &quot;</span><span style="color:#a3be8c;">attach</span><span style="color:#c0c5ce;">&quot;,
            &quot;</span><span style="color:#a3be8c;">localRoot</span><span style="color:#c0c5ce;">&quot;: &quot;</span><span style="color:#a3be8c;">${workspaceRoot}</span><span style="color:#c0c5ce;">&quot;,
            &quot;</span><span style="color:#a3be8c;">remoteRoot</span><span style="color:#c0c5ce;">&quot;: &quot;</span><span style="color:#a3be8c;">${workspaceRoot}</span><span style="color:#c0c5ce;">&quot;,
            &quot;</span><span style="color:#a3be8c;">port</span><span style="color:#c0c5ce;">&quot;: </span><span style="color:#d08770;">3000</span><span style="color:#c0c5ce;">,
            &quot;</span><span style="color:#a3be8c;">secret</span><span style="color:#c0c5ce;">&quot;: &quot;</span><span style="color:#a3be8c;">my_secret</span><span style="color:#c0c5ce;">&quot;,
            &quot;</span><span style="color:#a3be8c;">host</span><span style="color:#c0c5ce;">&quot;: &quot;</span><span style="color:#a3be8c;">localhost</span><span style="color:#c0c5ce;">&quot;
        },
</span></code></pre>
<p>VSCodeでexecute関数のscene=context.sceneにbreak pointをセットする
3DViewでMove X by one</p>
<p>うまくいった。</p>
<h2 id="memo">Memo</h2>
<p>Blenderプロセスが生きていればいいのでptvsd.wait_for_attach()する必要はない
Pythonのターンになるまで接続が処理されないので、VSCodeからアタッチした後AddOnを実行するまでVSCodeは待ち状態になる</p>

</div>

<nav class="toc">

<div class="toc_fix">
<ul>
    
        <li>
            <a href="https://ousttrue.github.io/blender/blender-addon-vscode/#memo">Memo</a>
            
        </li>
    
</ul>
</div>


</nav>
</div>
</main>

    <footer class="footer">Powered by <a href="https://www.getzola.org/">Zola</a> <a href="https://github.com/ousttrue/zola/tree/custom">custom</a></footer>

  </body>
</html>
