<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <title>三次元日誌</title>

    

  <script src="https://ousttrue.github.io/plugins/elasticlunr.min.js" defer></script>
  <script src="https://ousttrue.github.io/search_index.en.js" defer></script>
  <script src="https://ousttrue.github.io/js/search.js" defer></script>

    

     
    <link rel="stylesheet" href="https://ousttrue.github.io/main.css">
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css"
      />
    
  </head>

  <body class="container">
    <a class="site_title" href="https:&#x2F;&#x2F;ousttrue.github.io&#x2F;">
      <div>三次元日誌</div>
    </a>

    <nav class="nav">
      <a class="item" href="/tags/">tags</a>
      <a class="item" href="https://github.com/ousttrue" aria-label="github">
        <i class="fab fa-github fa-lg"></i>
      </a>
      

        
            <form class="navbar-form">
                <input id="userinput" class="form-control is-search" type="search" placeholder="Search docs..."
                    aria-label="Search docs..." autocomplete="off">
                <div id="suggestions" class="shadow bg-white rounded"></div>
            </form>
        
    </nav>

    <main class="main">
<div class="page">
<div class="content">
  <div class="headline">
  
  

  
  <a class="headline_title" href="https:&#x2F;&#x2F;ousttrue.github.io&#x2F;uwp&#x2F;cppwinrt-uwp&#x2F;"> C++WinRTではじめるUWP 
  

  
  </a>

  

  <div>
    <ul class="tags">
      <li class="headline_date">
        <div class="year">2017</div>
        <div class="md">0914</div>
      </li>
      
      


    <li class="tag"><a href="https:&#x2F;&#x2F;ousttrue.github.io&#x2F;tags&#x2F;cpp&#x2F;">cpp</a></li>

    <li class="tag"><a href="https:&#x2F;&#x2F;ousttrue.github.io&#x2F;tags&#x2F;uwp&#x2F;">uwp</a></li>




    </ul>
  </div>
</div>
 <p>C++/CXを置き換えるよさげなライブラリC++WinRTを発見した。</p>
<p>C++/CXの機能を純粋なC++(C++17とか新しめの)で実装したものらしく、WinRTのC++バインディングのような位置。
C++/CXで</p>
<pre style="background-color:#2b303b;">
<code class="language-c++" data-lang="c++"><span style="color:#c0c5ce;">Windows::UI::Core::CoreWindow ^window;
</span></code></pre>
<p>のようなものを</p>
<pre style="background-color:#2b303b;">
<code class="language-c++" data-lang="c++"><span style="color:#b48ead;">#include </span><span style="color:#c0c5ce;">&lt;</span><span style="color:#a3be8c;">winrt/Windows.UI.Core.h</span><span style="color:#c0c5ce;">&gt;
winrt::Windows::UI::Core::Core window;
</span></code></pre>
<p>のように置き換える。<code>-&gt; </code>じゃなくて <code>.</code> を使うスマートポインタで実装されている。</p>
<ul>
<li>Migrating C++/CX source code to C++/WinRT</li>
</ul>
<p>C++/CXでasync, awaitな非同期を実装する道具だったPPLもうまく置き換えているようだ。</p>
<ul>
<li>Using C++ co-routines with C++/WinRT asynchronous methods</li>
</ul>
<p>やってみる
clone
https://github.com/Microsoft/cppwinrtをcloneしてincludeできるようにしておく。
C++WinRTはヘッダオンリーライブラリである。
ビルド確認</p>
<p>https://github.com/Microsoft/cppwinrt/tree/master/10.0.15063.0/Samples/CL</p>
<p>をベース。</p>
<pre style="background-color:#2b303b;">
<code class="language-c++" data-lang="c++"><span style="color:#65737e;">// main.cpp
</span><span style="color:#b48ead;">#pragma</span><span style="color:#c0c5ce;"> comment(lib, &quot;windowsapp&quot;) 

</span><span style="color:#b48ead;">#include </span><span style="color:#c0c5ce;">&lt;</span><span style="color:#a3be8c;">winrt/base.h</span><span style="color:#c0c5ce;">&gt;

</span><span style="color:#b48ead;">int</span><span style="color:#c0c5ce;"> __stdcall </span><span style="color:#8fa1b3;">wWinMain</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">HINSTANCE</span><span style="color:#c0c5ce;">, </span><span style="color:#bf616a;">HINSTANCE</span><span style="color:#c0c5ce;">, </span><span style="color:#bf616a;">PWSTR</span><span style="color:#c0c5ce;">, </span><span style="color:#bf616a;">int</span><span style="color:#c0c5ce;">)
{
    winrt::</span><span style="color:#bf616a;">init_apartment</span><span style="color:#c0c5ce;">();

    </span><span style="color:#b48ead;">return </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">;
}
</span></code></pre>
<p>あえてCMakeで。
CMakeLists.txt</p>
<pre style="background-color:#2b303b;">
<code class="language-cmake" data-lang="cmake"><span style="color:#96b5b4;">CMAKE_MINIMUM_REQUIRED</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">VERSION </span><span style="color:#c0c5ce;">3.5)
</span><span style="color:#96b5b4;">PROJECT</span><span style="color:#c0c5ce;">(RendererToolkit) </span><span style="color:#65737e;"># .sln

</span><span style="color:#96b5b4;">ADD_DEFINITIONS</span><span style="color:#c0c5ce;">(
    -DWIN32=1
    -DUNICODE=1
    -D_UNICODE=1
    )

SET(CMAKE_C_FLAGS &quot;/ZW /EHsc /await /std:c++latest&quot;)
SET(CMAKE_CXX_FLAGS ${</span><span style="color:#bf616a;">CMAKE_C_FLAGS</span><span style="color:#c0c5ce;">})
INCLUDE_DIRECTORIES(
    </span><span style="color:#65737e;"># 適当にcloneしたパスを参照
    </span><span style="color:#c0c5ce;">${</span><span style="color:#bf616a;">CMAKE_CURRENT_LIST_DIR</span><span style="color:#c0c5ce;">}/cppwinrt/10.0.15063.0
    )

</span><span style="color:#65737e;">##############################################################################
# project
##############################################################################
</span><span style="color:#c0c5ce;">SET(PROJECTNAME _SampleCoreWindow)

FILE(GLOB SRCS *.cpp *.h)

ADD_EXECUTABLE(${</span><span style="color:#bf616a;">PROJECTNAME</span><span style="color:#c0c5ce;">} WIN32 ${</span><span style="color:#bf616a;">SRCS</span><span style="color:#c0c5ce;">})

TARGET_INCLUDE_DIRECTORIES(${</span><span style="color:#bf616a;">PROJECTNAME</span><span style="color:#c0c5ce;">} PUBLIC
    ${</span><span style="color:#bf616a;">SUBRENDERER_INCLUDE</span><span style="color:#c0c5ce;">}
    )
</span></code></pre>
<p>UWPをターゲットにしたプロジェクトを生成する。</p>
<pre style="background-color:#2b303b;">
<code><span style="color:#c0c5ce;">&gt; mkdir build
&gt; cd build
build&gt; cmake.exe -DCMAKE_SYSTEM_NAME=WindowsStore -DCMAKE_SYSTEM_VERSION=10.0 -DCMAKE_C_FLAGS=/ZW /EHsc -G &quot;Visual Studio 15 2017 Win64&quot; ..
</span></code></pre>
<p>ビルドすると警告が出る。
warning C4447: スレッド モデルのない 'main' シグネチャが見つかりました。'int main(Platform::Array<a href="Platform::String%5E">Platform::String^</a>^ args)' の使用を検討してください。</p>
<p>以下のように属性をつければ外せた。
[Platform::MTAThread]
int __stdcall wWinMain(HINSTANCE, HINSTANCE, PWSTR, int)</p>
<p>Debug - X64 - ローカルコンピューター でアプリが起動して、即終了することが確認できればよし。
UWPの作法で空のAppを作ってみる</p>
<pre style="background-color:#2b303b;">
<code class="language-c++" data-lang="c++"><span style="color:#b48ead;">#pragma</span><span style="color:#c0c5ce;"> comment(lib, &quot;windowsapp&quot;) 

</span><span style="color:#b48ead;">#include </span><span style="color:#c0c5ce;">&lt;</span><span style="color:#a3be8c;">winrt/Windows.ApplicationModel.Core.h</span><span style="color:#c0c5ce;">&gt;
</span><span style="color:#b48ead;">#include </span><span style="color:#c0c5ce;">&lt;</span><span style="color:#a3be8c;">winrt/Windows.UI.Core.h</span><span style="color:#c0c5ce;">&gt;

</span><span style="color:#65737e;">//
// IFrameworkViewSourceとIFrameworkViewを一体化させるのは必要(ばらすとエラーになった)
//
</span><span style="color:#b48ead;">struct </span><span style="color:#c0c5ce;">App : </span><span style="color:#a3be8c;">winrt::implements</span><span style="color:#c0c5ce;">&lt;App
    , winrt::Windows::ApplicationModel::Core::IFrameworkViewSource
    , winrt::Windows::ApplicationModel::Core::IFrameworkView&gt;
{
    winrt::Windows::ApplicationModel::Core::IFrameworkView </span><span style="color:#8fa1b3;">CreateView</span><span style="color:#c0c5ce;">()
    {
        </span><span style="color:#b48ead;">return </span><span style="color:#c0c5ce;">*</span><span style="color:#bf616a;">this</span><span style="color:#c0c5ce;">;
    }

    </span><span style="color:#b48ead;">void </span><span style="color:#8fa1b3;">Initialize</span><span style="color:#c0c5ce;">(winrt::Windows::ApplicationModel::Core::CoreApplicationView </span><span style="color:#b48ead;">const</span><span style="color:#c0c5ce;">&amp;)
    {
    }

    </span><span style="color:#b48ead;">void </span><span style="color:#8fa1b3;">Load</span><span style="color:#c0c5ce;">(winrt::hstring </span><span style="color:#b48ead;">const</span><span style="color:#c0c5ce;">&amp;)
    {
    }

    </span><span style="color:#b48ead;">void </span><span style="color:#8fa1b3;">Uninitialize</span><span style="color:#c0c5ce;">()
    {
    }

    </span><span style="color:#b48ead;">void </span><span style="color:#8fa1b3;">Run</span><span style="color:#c0c5ce;">()
    {
        </span><span style="color:#b48ead;">auto</span><span style="color:#c0c5ce;"> window = winrt::Windows::UI::Core::CoreWindow::</span><span style="color:#bf616a;">GetForCurrentThread</span><span style="color:#c0c5ce;">();
        window.</span><span style="color:#bf616a;">Activate</span><span style="color:#c0c5ce;">();

        </span><span style="color:#65737e;">//

        </span><span style="color:#b48ead;">auto</span><span style="color:#c0c5ce;"> dispatcher = window.</span><span style="color:#bf616a;">Dispatcher</span><span style="color:#c0c5ce;">();
        dispatcher.</span><span style="color:#bf616a;">ProcessEvents</span><span style="color:#c0c5ce;">(winrt::Windows::UI::Core::CoreProcessEventsOption::ProcessUntilQuit);
    }

    </span><span style="color:#b48ead;">void </span><span style="color:#8fa1b3;">SetWindow</span><span style="color:#c0c5ce;">(winrt::Windows::UI::Core::CoreWindow </span><span style="color:#b48ead;">const</span><span style="color:#c0c5ce;">&amp;)
    {

    }
};


</span><span style="color:#b48ead;">int</span><span style="color:#c0c5ce;"> __stdcall </span><span style="color:#8fa1b3;">wWinMain</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">HINSTANCE</span><span style="color:#c0c5ce;">, </span><span style="color:#bf616a;">HINSTANCE</span><span style="color:#c0c5ce;">, </span><span style="color:#bf616a;">PWSTR</span><span style="color:#c0c5ce;">, </span><span style="color:#bf616a;">int</span><span style="color:#c0c5ce;">)
{
    winrt::</span><span style="color:#bf616a;">init_apartment</span><span style="color:#c0c5ce;">();

    winrt::Windows::ApplicationModel::Core::CoreApplication::</span><span style="color:#bf616a;">Run</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">App</span><span style="color:#c0c5ce;">());
}
</span></code></pre>
<p>警告とは無関係に、実行に
[Platform::MTAThread]かwinrt::init_apartment();のどちらかが必要？
IUnknown*を得る
winrt::get_abi
メモ</p>
<p>https://github.com/Kitware/CMake/blob/master/Tests/VSWinStorePhone/CMakeLists.txt</p>
<p>VisualStudio2017のC++/CX Universal D3D11のテンプレートをC++/WinRTバージョンに改造できた。間違ってもコンパイルが通って実行時エラーになるのに難儀したが、C++/CXよりはだいぶ使い勝手がよさげな感じ。</p>

</div>

<nav class="toc">


</nav>
</div>
</main>

    <footer class="footer">Powered by <a href="https://www.getzola.org/">Zola</a> <a href="https://github.com/ousttrue/zola/tree/custom">custom</a></footer>

  </body>
</html>
