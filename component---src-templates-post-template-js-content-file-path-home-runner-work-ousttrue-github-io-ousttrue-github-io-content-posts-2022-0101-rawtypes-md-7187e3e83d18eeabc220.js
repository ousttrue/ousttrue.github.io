"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[8199],{9773:function(e,n,t){t.r(n),t.d(n,{default:function(){return d}});var a=t(1151),l=t(7294);function c(e){const n=Object.assign({h1:"h1",p:"p",span:"span",ul:"ul",li:"li",h2:"h2"},(0,a.ah)(),e.components);return l.createElement(l.Fragment,null,l.createElement(n.h1,null,"rawtypes 作ってみる"),"\n",l.createElement(n.p,null,l.createElement(n.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">cython</code>'}})," から ",l.createElement(n.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">pybind11</code>'}})," に乗り換えを試みたのだが、\n一歩目で躓いた。"),"\n",l.createElement(n.p,null,"不完全型のポインタをそのまま返す方法がわからん。"),"\n",l.createElement(n.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="c++"><pre class="language-c++"><code class="language-c++">ImGuiContext* CreateContext(ImFontAtlas* shared_font_atlas = NULL);</code></pre></div>'}}),"\n",l.createElement(n.p,null,l.createElement(n.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">ImGuiContext</code>'}})," は前方宣言なのです。"),"\n",l.createElement(n.p,null,"自分でやろうと思った。\n",l.createElement(n.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">ctypes</code>'}})," と併用することを前提にした省機能のバインダー、名付けて ",l.createElement(n.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">rawtypes</code>'}})," を作ってみよう。\n",l.createElement(n.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">c++</code>'}})," の関数呼び出しのちょっとしたコード生成をする。\n基本的に ",l.createElement(n.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">ctypes.c_void_p</code>'}})," で済ます。\n型の宣言が必要なところは、 ",l.createElement(n.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">ctypes.Structure</code>'}})," により ",l.createElement(n.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">python</code>'}})," 側で宣言。\n",l.createElement(n.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">c++</code>'}})," から返す時には、キャストする。"),"\n",l.createElement(n.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python"><span class="token keyword">return</span> ctypes<span class="token punctuation">.</span>cast<span class="token punctuation">(</span>p<span class="token punctuation">,</span> ctypes<span class="token punctuation">.</span>POINTER<span class="token punctuation">(</span>CTYPES_TYPE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span></code></pre></div>'}}),"\n",l.createElement(n.p,null,"object の所有権 はまじめに探求しない。"),"\n",l.createElement(n.ul,null,"\n",l.createElement(n.li,null,"python で作って、python で開放する(cypte.Struct object)"),"\n",l.createElement(n.li,null,"c++ で作ったのを cast して python に渡すが参照のみ(cast された ctypes.Struct)。無効なものにアクセスしないようにプログラマがー注意する"),"\n",l.createElement(n.li,null,"それ以外は値渡し"),"\n"),"\n",l.createElement(n.p,null,"これで十分。\n主要な狙いは、"),"\n",l.createElement(n.ul,null,"\n",l.createElement(n.li,null,"static library のリンク"),"\n",l.createElement(n.li,null,l.createElement(n.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">c++</code>'}})," 関数の呼び出し"),"\n",l.createElement(n.li,null,"構造体の値渡しを ",l.createElement(n.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">c++</code>'}})," でラップする"),"\n"),"\n",l.createElement(n.p,null,"で、 ",l.createElement(n.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">ctypes</code>'}})," の苦手なところだけをやる。\n",l.createElement(n.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">luajit ffi</code>'}})," に倣ったスタイルでまいる。"),"\n",l.createElement(n.h2,null,"動いた"),"\n",l.createElement(n.p,null,"https://github.com/ousttrue/pydear"),"\n",l.createElement(n.p,null,"ImGui ひととおりできた。\nもうちっとパッケージング(sdist, wheel)を整理したら形が整う。\n",l.createElement(n.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">github action</code>'}})," で ",l.createElement(n.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">wheel</code>'}})," をビルドする技もできた(",l.createElement(n.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">windows-64bit + python-3.10</code>'}})," のみ実験)。"),"\n",l.createElement(n.p,null,l.createElement(n.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">str</code>'}})," と ",l.createElement(n.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">bytes</code>'}})," の切りわけも ",l.createElement(n.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">C-API</code>'}})," で書けたし、慣れれば直接 ",l.createElement(n.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">C-API</code>'}})," を使った方が便利そう。\n",l.createElement(n.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">Py_INCREF</code>'}})," ",l.createElement(n.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">Py_DECREF</code>'}})," による参照管理と、",l.createElement(n.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">PyErr_Clear</code>'}})," 等のエラーハンドリングなど\nを抑えればよさそう。"),"\n",l.createElement(n.h2,null,"pypi"),"\n",l.createElement(n.p,null,"https://pypi.org/project/pydear/"),"\n",l.createElement(n.p,null,"github actions で wheel をビルドして、 pypi にアップロードするところまでできた。\nあと、 ",l.createElement(n.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">sdist</code>'}})," も作る。"),"\n",l.createElement(n.p,null,l.createElement(n.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">pip install pydear</code>'}})," して使えるようになった。\n使いながら整備していこう。"),"\n",l.createElement(n.p,null,l.createElement(n.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">pyi</code>'}})," が含まれているので、ある程度のインテリセンスが効くところがよい。"),"\n",l.createElement(n.ul,null,"\n",l.createElement(n.li,null,"[ ] rawtypes をライブラリとして分離する"),"\n",l.createElement(n.li,null,"[ ] clang.cindex でコード生成した結果を ",l.createElement(n.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">sdist</code>'}})," に含める"),"\n"))}var s=function(e){void 0===e&&(e={});const{wrapper:n}=Object.assign({},(0,a.ah)(),e.components);return n?l.createElement(n,e,l.createElement(c,e)):c(e)},r=t(8678),o=t(8838);const u={code:e=>{let{children:n,className:t}=e;return t?l.createElement(o.Z,{className:t},n):l.createElement("code",null,n)}};function p(e){let{data:n,children:t}=e;return l.createElement(r.Z,null,l.createElement("h1",null,n.mdx.frontmatter.title),l.createElement(a.Zo,{components:u},t))}function d(e){return l.createElement(p,e,l.createElement(s,e))}}}]);
//# sourceMappingURL=component---src-templates-post-template-js-content-file-path-home-runner-work-ousttrue-github-io-ousttrue-github-io-content-posts-2022-0101-rawtypes-md-7187e3e83d18eeabc220.js.map